{% extends 'base.html' %}
{% load static %}

{% block title %}åˆ†æãƒ¬ãƒãƒ¼ãƒˆä¸€è¦§ - ã‚«ãƒ–ãƒ­ã‚°{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/2-layouts/analysis-template.css' %}?v={{ STATIC_VERSION }}">
{% endblock %}

{% block content %}
<div class="at-container">
    <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="page-header page-header-with-actions mb-4">
        <div class="page-header-content">
            <h1 class="page-title">
                <i class="bi bi-clipboard-data"></i>
                <span>åˆ†æãƒ¬ãƒãƒ¼ãƒˆä¸€è¦§</span>
            </h1>
            <p class="page-subtitle">ä¼æ¥­ã®è²¡å‹™æŒ‡æ¨™ã‚’æ¯”è¼ƒåˆ†æã™ã‚‹ãƒ¬ãƒãƒ¼ãƒˆã‚’ç®¡ç†ã§ãã¾ã™</p>
        </div>
        <a href="{% url 'analysis_template:create' %}" class="btn btn-primary d-flex align-items-center gap-2">
            <i class="bi bi-plus-circle"></i>
            <span class="d-none d-sm-inline">æ–°è¦ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ</span>
            <span class="d-sm-none">æ–°è¦ä½œæˆ</span>
        </a>
    </div>

    {% if templates %}
    <!-- ä¸€æ‹¬æ“ä½œãƒãƒ¼ -->
    <div class="at-bulk-bar" id="bulkActionBar">
        <div class="at-bulk-bar-content">
            <div class="at-selection-count">
                é¸æŠä¸­: <strong id="selectedCount">0</strong> ä»¶
            </div>
            <div class="at-action-group">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="bulkDelete()">
                    <i class="bi bi-trash me-1"></i>ã¾ã¨ã‚ã¦å‰Šé™¤
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                    <i class="bi bi-x-circle me-1"></i>é¸æŠè§£é™¤
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ¬ãƒãƒ¼ãƒˆä¸€è¦§ -->
    <div class="at-company-grid">
        {% for template in templates %}
        <div class="at-template-card" data-template-id="{{ template.pk }}">
            <!-- ã‚«ãƒ¼ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="at-template-card-header">
                <label class="d-flex align-items-center gap-2 mb-0" style="cursor: pointer;">
                    <input type="checkbox" 
                           class="at-checkbox template-checkbox" 
                           value="{{ template.pk }}"
                           onchange="updateSelection()">
                </label>
                <span class="at-company-badge">{{ template.company_count }}ç¤¾</span>
            </div>
            
            <!-- ã‚«ãƒ¼ãƒ‰ãƒœãƒ‡ã‚£ -->
            <div class="at-template-card-body">
                <h5 class="at-template-title">{{ template.name }}</h5>
                {% if template.description %}
                <p class="at-template-desc">{{ template.description|truncatewords:15 }}</p>
                {% else %}
                <p class="at-template-desc at-text-muted" style="font-style: italic;">èª¬æ˜ãªã—</p>
                {% endif %}
                <div class="at-template-meta mt-3">
                    <i class="bi bi-clock"></i>
                    <span>{{ template.updated_at|date:"Y/m/d H:i" }}</span>
                </div>
            </div>
            
            <!-- ã‚«ãƒ¼ãƒ‰ãƒ•ãƒƒã‚¿ãƒ¼ -->
            <div class="at-template-card-footer">
                <a href="{% url 'analysis_template:detail' template.pk %}" 
                   class="btn btn-primary btn-sm w-100 mb-2">
                    <i class="bi bi-eye me-1"></i>ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
                </a>
                <div class="d-flex gap-2">
                    <a href="{% url 'analysis_template:update' template.pk %}" 
                       class="at-btn-icon flex-fill" title="ç·¨é›†">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <button type="button" 
                            class="at-btn-icon flex-fill"
                            onclick="duplicateTemplate({{ template.pk }})"
                            title="è¤‡è£½">
                        <i class="bi bi-files"></i>
                    </button>
                    <a href="{% url 'analysis_template:export' template.pk %}" 
                       class="at-btn-icon flex-fill" title="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">
                        <i class="bi bi-download"></i>
                    </a>
                    <button type="button" 
                            class="at-btn-icon danger flex-fill"
                            onclick="confirmDelete({{ template.pk }}, '{{ template.name|escapejs }}')"
                            title="å‰Šé™¤">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- ç©ºã®çŠ¶æ…‹ -->
    <div class="at-empty-state">
        <div class="at-empty-icon">ğŸ“Š</div>
        <h3 class="at-empty-title">ãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</h3>
        <p class="at-empty-desc">ä¼æ¥­ã®è²¡å‹™æŒ‡æ¨™ã‚’æ¯”è¼ƒåˆ†æã™ã‚‹ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†</p>
        <a href="{% url 'analysis_template:create' %}" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-circle me-2"></i>æœ€åˆã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ
        </a>
    </div>
    {% endif %}
</div>

<!-- å‰Šé™¤ç¢ºèªç”¨ãƒ•ã‚©ãƒ¼ãƒ  -->
<form id="deleteForm" method="post" style="display: none;">
    {% csrf_token %}
</form>

{% include 'speed_dial.html' with actions=form_actions %}
<script>
const csrfToken = '{{ csrf_token }}';
let selectedTemplates = new Set();

function updateSelection() {
    selectedTemplates.clear();
    document.querySelectorAll('.template-checkbox:checked').forEach(cb => {
        selectedTemplates.add(parseInt(cb.value));
    });
    
    const count = selectedTemplates.size;
    document.getElementById('selectedCount').textContent = count;
    
    const bar = document.getElementById('bulkActionBar');
    if (count > 0) {
        bar.classList.add('show');
    } else {
        bar.classList.remove('show');
    }
    
    // é¸æŠä¸­ã®ã‚«ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    document.querySelectorAll('.at-template-card').forEach(card => {
        const checkbox = card.querySelector('.template-checkbox');
        if (checkbox?.checked) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
    });
}

function clearSelection() {
    document.querySelectorAll('.template-checkbox').forEach(cb => cb.checked = false);
    updateSelection();
}

function bulkDelete() {
    const count = selectedTemplates.size;
    if (!count) {
        alert('å‰Šé™¤ã™ã‚‹ãƒ¬ãƒãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    if (!confirm(`é¸æŠã—ãŸ${count}ä»¶ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        return;
    }
    
    fetch('{% url "analysis_template:bulk_delete" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ template_ids: Array.from(selectedTemplates) })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + data.error);
        }
    })
    .catch(e => alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message));
}

function confirmDelete(id, name) {
    if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) return;
    
    const form = document.getElementById('deleteForm');
    form.action = `/analysis_template/${id}/delete/`;
    form.submit();
}

function duplicateTemplate(id) {
    if (!confirm('ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’è¤‡è£½ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/analysis_template/${id}/duplicate/`;
    form.innerHTML = `<input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">`;
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}