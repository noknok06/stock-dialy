{% extends 'base.html' %}
{% load static %}

{% block title %}分析レポート一覧 - カブログ{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/2-layouts/analysis-template.css' %}">
{% endblock %}

{% block content %}
<div class="at-container">
    <!-- ページヘッダー -->
    <div class="at-page-header-mobile">
        <div class="at-page-header-top">
            <h1 class="at-page-title-mobile">
                <i class="bi bi-clipboard-data"></i>
                分析レポート
            </h1>
            <a href="{% url 'analysis_template:create' %}" class="at-fab-btn" aria-label="新規レポート作成">
                <i class="bi bi-plus-lg"></i>
            </a>
        </div>
        <p class="at-page-subtitle-mobile">企業の財務指標を比較分析</p>
    </div>

    {% if templates %}
    <!-- 一括操作バー -->
    <div class="at-bulk-bar" id="bulkActionBar">
        <div class="at-bulk-bar-content">
            <div class="at-selection-count">
                選択中: <strong id="selectedCount">0</strong> 件
            </div>
            <div class="at-bulk-actions">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="bulkDelete()">
                    <i class="bi bi-trash me-1"></i>削除
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                    <i class="bi bi-x-circle me-1"></i>解除
                </button>
            </div>
        </div>
    </div>

    <!-- レポート一覧 -->
    <div class="at-list-mobile">
        {% for template in templates %}
        <div class="at-list-item" data-template-id="{{ template.pk }}">
            <!-- チェックボックス + メインコンテンツ -->
            <div class="at-list-item-main">
                <label class="at-list-checkbox-area" aria-label="選択">
                    <input type="checkbox" 
                           class="at-checkbox template-checkbox" 
                           value="{{ template.pk }}"
                           onchange="updateSelection()">
                </label>
                <a href="{% url 'analysis_template:detail' template.pk %}" class="at-list-item-content">
                    <div class="at-list-item-header">
                        <h3 class="at-list-item-title">{{ template.name }}</h3>
                        <span class="at-list-item-badge">{{ template.company_count }}社</span>
                    </div>
                    {% if template.description %}
                    <p class="at-list-item-desc">{{ template.description|truncatewords:12 }}</p>
                    {% endif %}
                    <div class="at-list-item-meta">
                        <i class="bi bi-clock"></i>
                        <span>{{ template.updated_at|date:"Y/m/d H:i" }}</span>
                    </div>
                </a>
            </div>
            <!-- アクションボタン行 -->
            <div class="at-list-item-actions">
                <a href="{% url 'analysis_template:update' template.pk %}" 
                   class="at-action-chip" title="編集">
                    <i class="bi bi-pencil"></i>
                    <span>編集</span>
                </a>
                <button type="button" 
                        class="at-action-chip"
                        onclick="duplicateTemplate({{ template.pk }})"
                        title="複製">
                    <i class="bi bi-files"></i>
                    <span>複製</span>
                </button>
                <a href="{% url 'analysis_template:export' template.pk %}" 
                   class="at-action-chip" title="エクスポート">
                    <i class="bi bi-download"></i>
                    <span>出力</span>
                </a>
                <button type="button" 
                        class="at-action-chip at-action-chip--danger"
                        onclick="confirmDelete({{ template.pk }}, '{{ template.name|escapejs }}')"
                        title="削除">
                    <i class="bi bi-trash"></i>
                    <span>削除</span>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- 空の状態 -->
    <div class="at-empty-state">
        <div class="at-empty-icon-wrap">
            <i class="bi bi-clipboard-data"></i>
        </div>
        <h3 class="at-empty-title">レポートがありません</h3>
        <p class="at-empty-desc">企業の財務指標を比較分析するレポートを作成してみましょう</p>
        <a href="{% url 'analysis_template:create' %}" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-circle me-2"></i>最初のレポートを作成
        </a>
    </div>
    {% endif %}
</div>

<!-- 削除確認用フォーム -->
<form id="deleteForm" method="post" style="display: none;">
    {% csrf_token %}
</form>

{% include 'speed_dial.html' with actions=form_actions %}
<script>
const csrfToken = '{{ csrf_token }}';
let selectedTemplates = new Set();

function updateSelection() {
    selectedTemplates.clear();
    document.querySelectorAll('.template-checkbox:checked').forEach(cb => {
        selectedTemplates.add(parseInt(cb.value));
    });
    
    const count = selectedTemplates.size;
    document.getElementById('selectedCount').textContent = count;
    
    const bar = document.getElementById('bulkActionBar');
    if (count > 0) {
        bar.classList.add('show');
    } else {
        bar.classList.remove('show');
    }
    
    // 選択中のカードをハイライト
    document.querySelectorAll('.at-template-card').forEach(card => {
        const checkbox = card.querySelector('.template-checkbox');
        if (checkbox?.checked) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
    });
}

function clearSelection() {
    document.querySelectorAll('.template-checkbox').forEach(cb => cb.checked = false);
    updateSelection();
}

function bulkDelete() {
    const count = selectedTemplates.size;
    if (!count) {
        alert('削除するレポートを選択してください');
        return;
    }
    
    if (!confirm(`選択した${count}件のレポートを削除しますか？\n\nこの操作は取り消せません。`)) {
        return;
    }
    
    fetch('{% url "analysis_template:bulk_delete" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ template_ids: Array.from(selectedTemplates) })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('エラー: ' + data.error);
        }
    })
    .catch(e => alert('削除に失敗しました: ' + e.message));
}

function confirmDelete(id, name) {
    if (!confirm(`「${name}」を削除しますか？\n\nこの操作は取り消せません。`)) return;
    
    const form = document.getElementById('deleteForm');
    form.action = `/analysis_template/${id}/delete/`;
    form.submit();
}

function duplicateTemplate(id) {
    if (!confirm('このレポートを複製しますか？')) return;
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/analysis_template/${id}/duplicate/`;
    form.innerHTML = `<input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">`;
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}
