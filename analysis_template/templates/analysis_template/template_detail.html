{% extends 'base.html' %}
{% load static %}

{% block title %}{{ template.name }} - åˆ†æãƒ¬ãƒãƒ¼ãƒˆ{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="{% static 'css/2-layouts/analysis-template.css' %}">
{% endblock %}

{% block content %}
<div class="at-container">
  <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="at-page-header-mobile">
      <div class="at-page-header-top">
          <h1 class="at-page-title-mobile">
              <i class="bi bi-clipboard-data"></i>
              {{ template.name }}
          </h1>
      </div>
      <p class="at-page-subtitle-mobile">{{ template.description|default:"æ¥­ç¨®åˆ¥ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æ¯”è¼ƒåˆ†æ" }}</p>
      <div class="at-detail-actions">
          <a href="{% url 'analysis_template:company_select' template.pk %}" class="at-action-chip">
              <i class="bi bi-building-add"></i>
              <span>ä¼æ¥­è¿½åŠ </span>
          </a>
          <a href="{% url 'analysis_template:metrics_edit' template.pk %}" class="at-action-chip">
              <i class="bi bi-bar-chart"></i>
              <span>æŒ‡æ¨™ç·¨é›†</span>
          </a>
      </div>
  </div>

  <!-- ä¼æ¥­ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <section class="at-section-mobile">
    <h2 class="at-section-title">
      <i class="bi bi-building"></i>
      ä¼æ¥­ä¸€è¦§
      <span class="badge bg-primary ms-2" id="companyCount">0</span>
    </h2>
    
    <div class="at-company-grid" id="companyGrid">
      <!-- JavaScript ã§ç”Ÿæˆ -->
    </div>
  </section>

  <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="at-tabs" role="tablist">
    <button class="at-tab active" data-bs-toggle="tab" data-bs-target="#tab-chart" role="tab">
      <i class="bi bi-pie-chart"></i>
      <span>ãƒãƒ£ãƒ¼ãƒˆ</span>
    </button>
    <button class="at-tab" data-bs-toggle="tab" data-bs-target="#tab-details" role="tab">
      <i class="bi bi-list-ul"></i>
      <span>è©³ç´°</span>
    </button>
    <button class="at-tab" data-bs-toggle="tab" data-bs-target="#tab-benchmark" role="tab">
      <i class="bi bi-graph-up"></i>
      <span>æ¥­ç¨®å¹³å‡</span>
    </button>
  </div>

  <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="tab-content">
    <!-- ãƒãƒ£ãƒ¼ãƒˆã‚¿ãƒ– -->
    <div class="tab-pane fade show active" id="tab-chart" role="tabpanel">
      <div class="at-card">
        <h6 class="at-chart-title">
          <i class="bi bi-radar me-2"></i>8æŒ‡æ¨™ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆæ¯”è¼ƒ
        </h6>
        <div class="at-chart-container">
          <canvas id="radar-chart"></canvas>
        </div>
      </div>
      
      <!-- æ¯”è¼ƒè¡¨ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ -->
      <div class="at-accordion-item">
        <button class="at-accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTable" aria-expanded="false">
          <span><i class="bi bi-table me-2"></i>è©³ç´°æ¯”è¼ƒè¡¨</span>
        </button>
        <div id="collapseTable" class="collapse">
          <div class="at-accordion-body">
            <div class="at-table-wrapper">
              <table class="at-table" id="comparison-table">
                <!-- JavaScript ã§ç”Ÿæˆ -->
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- è©³ç´°ã‚¿ãƒ– -->
    <div class="tab-pane fade" id="tab-details" role="tabpanel">
      <div id="detailsAccordion">
        <!-- JavaScript ã§ç”Ÿæˆ -->
      </div>
    </div>

    <!-- æ¥­ç¨®å¹³å‡ã‚¿ãƒ– -->
    <div class="tab-pane fade" id="tab-benchmark" role="tabpanel">
      <div id="benchmarkList">
        <!-- JavaScript ã§ç”Ÿæˆ -->
      </div>
    </div>
  </div>
</div>

{% include 'speed_dial.html' with actions=form_actions %}
<script>
const companiesData = {{ companies_data|safe }};
const benchmarksData = {{ benchmarks_data|safe }};
const templateId = {{ template.pk }};

// ========================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ========================================
function formatNumber(num, decimals = 2) {
  if (num === null || num === undefined || isNaN(num)) return '-';
  return Number(num).toFixed(decimals);
}

function getScoreColor(score) {
  if (score >= 70) return 'success';
  if (score >= 50) return 'primary';
  return 'warning';
}

// ========================================
// ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆæ”¹å–„ç‰ˆï¼‰
// normalizeValueé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ç·åˆã‚¹ã‚³ã‚¢ã‚’ç®—å‡º
// ========================================
function calculateScore(company) {
  const benchmark = benchmarksData[company.industry_code_33];
  
  // ã‚¹ã‚³ã‚¢è¨ˆç®—ã«ä½¿ç”¨ã™ã‚‹ä¸»è¦æŒ‡æ¨™ï¼ˆé‡ã¿ä»˜ã‘å¯èƒ½ï¼‰
  const scoreMetrics = [
    { key: 'roe', weight: 1.5 },           // åç›Šæ€§ï¼ˆé‡è¦ï¼‰
    { key: 'roa', weight: 1.0 },           // åç›Šæ€§
    { key: 'operating_margin', weight: 1.2 }, // åç›Šæ€§
    { key: 'per', weight: 1.0 },           // ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
    { key: 'pbr', weight: 0.8 },           // ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
    { key: 'dividend_yield', weight: 0.8 }, // é…å½“
    { key: 'equity_ratio', weight: 0.8 },  // è²¡å‹™å¥å…¨æ€§
    { key: 'revenue_growth', weight: 0.7 }, // æˆé•·æ€§
    { key: 'profit_growth', weight: 0.7 }, // æˆé•·æ€§
  ];
  
  let totalWeightedScore = 0;
  let totalWeight = 0;
  
  scoreMetrics.forEach(({ key, weight }) => {
    const value = company.metrics[key];
    if (value == null) return;
    
    const b = benchmark ? benchmark[key] : null;
    const score = normalizeValue(value, key, b);
    
    if (score != null) {
      totalWeightedScore += score * weight;
      totalWeight += weight;
    }
  });
  
  return totalWeight > 0 ? totalWeightedScore / totalWeight : 50;
}

// ========================================
// æŒ‡æ¨™åˆ¥ã®æ­£è¦åŒ–è¨­å®š
// æ¥­ç¨®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨
// 
// æ§‹é€ : poor â†’ avg â†’ excellent ã®æ–¹å‘ã§ã‚¹ã‚³ã‚¢ãŒä¸ŠãŒã‚‹
// é€šå¸¸æŒ‡æ¨™: poor < avg < excellentï¼ˆå€¤ãŒå¤§ãã„ã»ã©è‰¯ã„ï¼‰
// é€†æŒ‡æ¨™:   poor > avg > excellentï¼ˆå€¤ãŒå°ã•ã„ã»ã©è‰¯ã„ï¼‰
// ========================================
const METRIC_DEFAULTS = {
  // åç›Šæ€§ï¼ˆé«˜ã„ã»ã©è‰¯ã„ï¼‰
  roe:              { poor: 4,   avg: 8,   excellent: 15 },
  roa:              { poor: 2,   avg: 4,   excellent: 8 },
  operating_margin: { poor: 3,   avg: 7,   excellent: 13 },
  net_margin:       { poor: 2,   avg: 4,   excellent: 10 },
  
  // æˆé•·æ€§ï¼ˆé«˜ã„ã»ã©è‰¯ã„ï¼‰
  revenue_growth:   { poor: -3,  avg: 5,   excellent: 15 },
  profit_growth:    { poor: -5,  avg: 8,   excellent: 18 },
  eps_growth:       { poor: -5,  avg: 8,   excellent: 20 },
  
  // ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä½ã„ã»ã©è‰¯ã„ï¼‰: poor > avg > excellent
  per:              { poor: 30,  avg: 15,  excellent: 10 },
  pbr:              { poor: 2.5, avg: 1.2, excellent: 0.7 },
  psr:              { poor: 3.0, avg: 1.5, excellent: 0.8 },
  pcfr:             { poor: 20,  avg: 12,  excellent: 7 },
  ev_ebitda:        { poor: 15,  avg: 10,  excellent: 6 },
  
  // é…å½“ï¼ˆé«˜ã„ã»ã©è‰¯ã„ï¼‰
  dividend_yield:   { poor: 0.8, avg: 2.0, excellent: 3.5 },
  dividend_payout:  { poor: 15,  avg: 35,  excellent: 50 },
  payout_ratio:     { poor: 15,  avg: 35,  excellent: 50 },
  
  // è²¡å‹™å¥å…¨æ€§
  equity_ratio:     { poor: 25,  avg: 42,  excellent: 60 },       // é«˜ã„ã»ã©è‰¯ã„
  current_ratio:    { poor: 100, avg: 150, excellent: 200 },      // é«˜ã„ã»ã©è‰¯ã„
  debt_equity_ratio:{ poor: 180, avg: 100, excellent: 50 },       // ä½ã„ã»ã©è‰¯ã„
  
  // åŠ¹ç‡æ€§ï¼ˆé«˜ã„ã»ã©è‰¯ã„ï¼‰
  asset_turnover:   { poor: 0.5, avg: 1.0, excellent: 1.8 },
  inventory_turnover:{ poor: 4,  avg: 8,   excellent: 15 },
};

/**
 * å€¤ã‚’0-100ã®ã‚¹ã‚³ã‚¢ã«æ­£è¦åŒ–
 * 
 * æ–¹å¼: 3ç‚¹ç·šå½¢è£œé–“
 * - poorï¼ˆè¦æ³¨æ„ï¼‰= 0ç‚¹
 * - avgï¼ˆå¹³å‡ï¼‰= 50ç‚¹  
 * - excellentï¼ˆå„ªè‰¯ï¼‰= 100ç‚¹
 * 
 * é€†æŒ‡æ¨™ï¼ˆPER, PBRç­‰ï¼‰ã¯ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã®æ§‹é€ ã‹ã‚‰è‡ªå‹•åˆ¤å®š:
 * - excellent < avg ã®å ´åˆã€å€¤ãŒå°ã•ã„ã»ã©è‰¯ã„
 * 
 * @param {number} value - å®Ÿéš›ã®å€¤
 * @param {string} key - æŒ‡æ¨™ã‚­ãƒ¼ï¼ˆroe, perç­‰ï¼‰
 * @param {object} benchmark - æ¥­ç¨®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ {avg, excellent, poor}
 * @returns {number|null} 0-100ã®ã‚¹ã‚³ã‚¢
 */
function normalizeValue(value, key, benchmark) {
  if (value == null || isNaN(value)) return null;
  const v = Number(value);
  
  // ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‹ã‚‰åŸºæº–å€¤ã‚’å–å¾—
  let poor, avg, excellent;
  
  if (benchmark && benchmark.avg != null) {
    // æ¥­ç¨®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãŒã‚ã‚‹å ´åˆ
    avg = Number(benchmark.avg);
    excellent = Number(benchmark.excellent ?? (avg > 0 ? avg * 1.5 : avg * 0.5));
    poor = Number(benchmark.poor ?? (avg > 0 ? avg * 0.4 : avg * 1.6));
  } else if (METRIC_DEFAULTS[key]) {
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨
    const def = METRIC_DEFAULTS[key];
    poor = def.poor;
    avg = def.avg;
    excellent = def.excellent;
  } else {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…å¹³å‡ã‚’ä½¿ç”¨
    const vals = companiesData.map(c => c.metrics[key]).filter(x => x != null).map(Number);
    if (!vals.length) return null;
    avg = vals.reduce((a, b) => a + b, 0) / vals.length;
    if (avg === 0) return 50;
    poor = avg * 0.4;
    excellent = avg * 1.5;
  }
  
  // é€†æŒ‡æ¨™åˆ¤å®š: excellent < avg ã®å ´åˆï¼ˆPER, PBRç­‰ï¼‰
  const isReverse = excellent < avg;
  
  // 3ç‚¹ç·šå½¢è£œé–“ã§ã‚¹ã‚³ã‚¢è¨ˆç®—
  let score;
  
  if (isReverse) {
    // é€†æŒ‡æ¨™: å€¤ãŒå°ã•ã„ã»ã©è‰¯ã„ (poor > avg > excellent)
    if (v >= poor) {
      // poorä»¥ä¸Š â†’ 0ç‚¹ï¼ˆæ‚ªã„ï¼‰
      score = 0;
    } else if (v <= excellent) {
      // excellentä»¥ä¸‹ â†’ 100ç‚¹ï¼ˆå„ªè‰¯ï¼‰
      score = 100;
    } else if (v >= avg) {
      // avgã€œpoor â†’ 50ã€œ0ç‚¹ã®ç·šå½¢è£œé–“
      score = 50 * (1 - (v - avg) / (poor - avg));
    } else {
      // excellentã€œavg â†’ 100ã€œ50ç‚¹ã®ç·šå½¢è£œé–“
      score = 50 + 50 * (1 - (v - excellent) / (avg - excellent));
    }
  } else {
    // é€šå¸¸æŒ‡æ¨™: å€¤ãŒå¤§ãã„ã»ã©è‰¯ã„ (poor < avg < excellent)
    if (v <= poor) {
      // poorä»¥ä¸‹ â†’ 0ç‚¹
      score = 0;
    } else if (v >= excellent) {
      // excellentä»¥ä¸Š â†’ 100ç‚¹
      score = 100;
    } else if (v <= avg) {
      // poorã€œavg â†’ 0ã€œ50ç‚¹ã®ç·šå½¢è£œé–“
      score = ((v - poor) / (avg - poor)) * 50;
    } else {
      // avgã€œexcellent â†’ 50ã€œ100ç‚¹ã®ç·šå½¢è£œé–“
      score = 50 + ((v - avg) / (excellent - avg)) * 50;
    }
  }
  
  return Math.max(0, Math.min(100, Math.round(score * 10) / 10));
}

// ========================================
// ä¼æ¥­ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
// ========================================
function generateCompanyCards() {
  const grid = document.getElementById('companyGrid');
  const countEl = document.getElementById('companyCount');
  
  if (!companiesData.length) {
    grid.innerHTML = `
      <div class="at-empty-state" style="grid-column: 1/-1;">
        <div class="at-empty-icon">ğŸ“Š</div>
        <h3 class="at-empty-title">ä¼æ¥­ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</h3>
        <p class="at-empty-desc">åˆ†æå¯¾è±¡ã®ä¼æ¥­ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
        <a href="{% url 'analysis_template:company_select' template.pk %}" class="btn btn-primary">
          <i class="bi bi-plus-circle me-2"></i>ä¼æ¥­ã‚’è¿½åŠ 
        </a>
      </div>`;
    return;
  }
  
  countEl.textContent = companiesData.length;
  grid.innerHTML = '';
  
  companiesData.forEach(company => {
    const score = calculateScore(company);
    const color = getScoreColor(score);
    
    const card = document.createElement('div');
    card.className = `at-company-card score-${score >= 70 ? 'high' : score >= 50 ? 'mid' : 'low'}`;
    card.innerHTML = `
      <div class="at-company-header">
        <div class="at-company-info">
          <div class="at-company-name">${company.name}</div>
          <div class="at-company-code">${company.code} Â· ${company.industry_name_33 || '-'}</div>
        </div>
        <div class="at-score-display">
          <span class="at-score-badge text-${color}">${score.toFixed(0)}</span>
          <div class="at-score-label">ã‚¹ã‚³ã‚¢</div>
        </div>
      </div>
      <div class="at-metrics-grid">
        <div class="at-metric-item">
          <span class="at-metric-label">ROE</span>
          <span class="at-metric-value">${company.metrics.roe}%</span>
        </div>
        <div class="at-metric-item">
          <span class="at-metric-label">ROA</span>
          <span class="at-metric-value">${company.metrics.roa}%</span>
        </div>
        <div class="at-metric-item">
          <span class="at-metric-label">å–¶æ¥­åˆ©ç›Šç‡</span>
          <span class="at-metric-value">${company.metrics.operating_margin}%</span>
        </div>
        <div class="at-metric-item">
          <span class="at-metric-label">é…å½“åˆ©å›ã‚Š</span>
          <span class="at-metric-value">${company.metrics.dividend_yield}%</span>
        </div>
      </div>
    `;
    grid.appendChild(card);
  });
}

// ========================================
// è©³ç´°ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ç”Ÿæˆ
// ========================================
function generateDetailsAccordion() {
  const container = document.getElementById('detailsAccordion');
  if (!companiesData.length) {
    container.innerHTML = '<div class="at-card"><p class="text-center at-text-muted py-4">ä¼æ¥­ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
    return;
  }
  
  container.innerHTML = '';
  
  companiesData.forEach((company, i) => {
    const benchmark = benchmarksData[company.industry_code_33];
    
    const item = document.createElement('div');
    item.className = 'at-accordion-item';
    item.innerHTML = `
      <button class="at-accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#detail${i}" aria-expanded="false">
        <span>${company.name} <small class="at-text-muted ms-2">${company.code}</small></span>
      </button>
      <div id="detail${i}" class="collapse">
        <div class="at-accordion-body">
          <div class="at-form-section">
            <div class="at-form-section-title"><i class="bi bi-graph-up-arrow me-2"></i>åç›Šæ€§</div>
            ${generateMetricRows([
              ['ROE', company.metrics.roe, '%', benchmark?.roe, 'roe'],
              ['ROA', company.metrics.roa, '%', benchmark?.roa, 'roa'],
              ['å–¶æ¥­åˆ©ç›Šç‡', company.metrics.operating_margin, '%', benchmark?.operating_margin, 'operating_margin']
            ])}
          </div>
          <div class="at-form-section">
            <div class="at-form-section-title"><i class="bi bi-currency-yen me-2"></i>ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³</div>
            ${generateMetricRows([
              ['PER', company.metrics.per, 'å€', benchmark?.per, 'per'],
              ['PBR', company.metrics.pbr, 'å€', benchmark?.pbr, 'pbr'],
              ['é…å½“åˆ©å›ã‚Š', company.metrics.dividend_yield, '%', benchmark?.dividend_yield, 'dividend_yield']
            ])}
          </div>
          <div class="at-form-section">
            <div class="at-form-section-title"><i class="bi bi-shield-check me-2"></i>è²¡å‹™å¥å…¨æ€§</div>
            ${generateMetricRows([
              ['è‡ªå·±è³‡æœ¬æ¯”ç‡', company.metrics.equity_ratio, '%', benchmark?.equity_ratio, 'equity_ratio']
            ])}
          </div>
          <div class="at-form-section">
            <div class="at-form-section-title"><i class="bi bi-graph-up me-2"></i>æˆé•·æ€§</div>
            ${generateMetricRows([
              ['å£²ä¸Šæˆé•·ç‡', company.metrics.revenue_growth, '%', benchmark?.revenue_growth, 'revenue_growth'],
              ['åˆ©ç›Šæˆé•·ç‡', company.metrics.profit_growth, '%', benchmark?.profit_growth, 'profit_growth']
            ])}
          </div>
        </div>
      </div>
    `;
    container.appendChild(item);
  });
}

function generateMetricRows(metrics) {
  return metrics.map(([label, value, unit, benchmark, key]) => {
    let comparison = '';
    let scoreBar = '';
    
    if (benchmark && value != null) {
      const diff = Number(value) - Number(benchmark.avg);
      
      // é€†æŒ‡æ¨™åˆ¤å®š: excellent < avg ã®å ´åˆ
      const isReverse = benchmark.excellent != null && benchmark.excellent < benchmark.avg;
      
      // é€†æŒ‡æ¨™ã®å ´åˆã¯è‰²ã‚’åè»¢ï¼ˆä½ã„æ–¹ãŒè‰¯ã„ï¼‰
      const isPositive = isReverse ? (diff < 0) : (diff > 0);
      const colorClass = isPositive ? 'at-text-success' : 'at-text-danger';
      const arrow = isPositive ? 'â†‘' : 'â†“';
      
      comparison = `<small class="${colorClass} ms-2">${arrow}${Math.abs(diff).toFixed(1)}</small>`;
      
      // ã‚¹ã‚³ã‚¢ãƒãƒ¼ï¼ˆnormalizeValueã‚’ä½¿ç”¨ï¼‰
      if (key) {
        const score = normalizeValue(value, key, benchmark);
        if (score != null) {
          const barColor = score >= 70 ? 'var(--at-success)' : score >= 50 ? 'var(--at-primary)' : 'var(--at-warning)';
          scoreBar = `<div class="at-score-bar" style="width:80px;height:6px;background:var(--at-bg-secondary);border-radius:3px;margin-left:8px;overflow:hidden;"><div style="width:${score}%;height:100%;background:${barColor};border-radius:3px;"></div></div>`;
        }
      }
    }
    return `
      <div class="at-benchmark-row" style="align-items:center;">
        <span class="at-benchmark-label">${label}</span>
        <span style="display:flex;align-items:center;"><strong class="at-benchmark-value">${value}${unit}</strong>${comparison}${scoreBar}</span>
      </div>`;
  }).join('');
}

// ========================================
// æ¥­ç¨®å¹³å‡ãƒªã‚¹ãƒˆç”Ÿæˆ
// ========================================
function generateBenchmarkList() {
  const container = document.getElementById('benchmarkList');
  
  if (!Object.keys(benchmarksData).length) {
    container.innerHTML = '<div class="at-card"><p class="text-center at-text-muted py-4">æ¥­ç¨®åˆ¥ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãŒæœªç™»éŒ²ã§ã™</p></div>';
    return;
  }
  
  container.innerHTML = '';
  
  Object.entries(benchmarksData).forEach(([code, benchmark]) => {
    const card = document.createElement('div');
    card.className = 'at-benchmark-card';
    card.innerHTML = `
      <div class="at-benchmark-title">${benchmark.name}</div>
      <div class="at-form-section">
        <div class="at-form-section-title" style="font-size:0.8rem;"><i class="bi bi-graph-up-arrow me-1"></i>åç›Šæ€§</div>
        ${generateBenchmarkMetricRow('ROE', benchmark.roe)}
        ${generateBenchmarkMetricRow('ROA', benchmark.roa)}
        ${generateBenchmarkMetricRow('å–¶æ¥­åˆ©ç›Šç‡', benchmark.operating_margin)}
      </div>
      <div class="at-form-section">
        <div class="at-form-section-title" style="font-size:0.8rem;"><i class="bi bi-currency-yen me-1"></i>ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³</div>
        ${generateBenchmarkMetricRow('PER', benchmark.per, true)}
        ${generateBenchmarkMetricRow('PBR', benchmark.pbr, true)}
      </div>
      <div class="at-form-section">
        <div class="at-form-section-title" style="font-size:0.8rem;"><i class="bi bi-graph-up me-1"></i>æˆé•·æ€§ãƒ»é…å½“</div>
        ${generateBenchmarkMetricRow('å£²ä¸Šæˆé•·ç‡', benchmark.revenue_growth)}
        ${generateBenchmarkMetricRow('åˆ©ç›Šæˆé•·ç‡', benchmark.profit_growth)}
        ${generateBenchmarkMetricRow('é…å½“åˆ©å›ã‚Š', benchmark.dividend_yield)}
      </div>
    `;
    container.appendChild(card);
  });
}

function generateBenchmarkMetricRow(label, data, isReverse = false) {
  if (!data) return '';
  
  // é€†æŒ‡æ¨™ã®å ´åˆã¯è‡ªå‹•åˆ¤å®šã‚‚è¡Œã†
  const actualReverse = isReverse || (data.excellent != null && data.excellent < data.avg);
  
  // è©•ä¾¡åŸºæº–ã®è¡¨ç¤º
  let thresholds = '';
  if (data.excellent != null && data.poor != null) {
    if (actualReverse) {
      thresholds = `<span class="at-benchmark-thresholds"><span class="at-text-success">å„ªè‰¯â‰¤${data.excellent}</span> / <span class="at-text-danger">è¦æ³¨æ„â‰¥${data.poor}</span></span>`;
    } else {
      thresholds = `<span class="at-benchmark-thresholds"><span class="at-text-success">å„ªè‰¯â‰¥${data.excellent}</span> / <span class="at-text-danger">è¦æ³¨æ„â‰¤${data.poor}</span></span>`;
    }
  }
  
  return `
    <div class="at-benchmark-row">
      <span class="at-benchmark-label">${label}</span>
      <span class="at-benchmark-values">
        <strong class="at-benchmark-value">${data.avg}</strong>
        ${thresholds}
      </span>
    </div>`;
}

// ========================================
// æ¯”è¼ƒãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
// ========================================
function generateComparisonTable() {
  const table = document.getElementById('comparison-table');
  
  if (!companiesData.length) {
    table.innerHTML = '<tbody><tr><td class="text-center py-4 at-text-muted">ä¼æ¥­ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr></tbody>';
    return;
  }
  
  const metrics = [
    { key: 'roe', label: 'ROE', unit: '%' },
    { key: 'roa', label: 'ROA', unit: '%' },
    { key: 'operating_margin', label: 'å–¶æ¥­åˆ©ç›Šç‡', unit: '%' },
    { key: 'per', label: 'PER', unit: 'å€' },
    { key: 'pbr', label: 'PBR', unit: 'å€' },
    { key: 'dividend_yield', label: 'é…å½“åˆ©å›ã‚Š', unit: '%' },
    { key: 'equity_ratio', label: 'è‡ªå·±è³‡æœ¬æ¯”ç‡', unit: '%' }
  ];
  
  let html = '<thead><tr><th>æŒ‡æ¨™</th>';
  companiesData.forEach(c => html += `<th>${c.name.substring(0, 8)}${c.name.length > 8 ? '...' : ''}</th>`);
  html += '</tr></thead><tbody>';
  
  metrics.forEach(m => {
    html += `<tr><td class="fw-semibold">${m.label}</td>`;
    companiesData.forEach(c => {
      const v = c.metrics[m.key];
      html += `<td class="text-end">${v}${v != null ? m.unit : ''}</td>`;
    });
    html += '</tr>';
  });
  
  table.innerHTML = html + '</tbody>';
}

// ========================================
// ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆç”Ÿæˆ
// ========================================
function generateRadarChart() {
  const ctx = document.getElementById('radar-chart');
  
  if (!companiesData.length) {
    ctx.parentElement.innerHTML = '<div class="text-center at-text-muted py-4">ä¼æ¥­ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
    return;
  }
  
  const colors = [
    { bg: 'rgba(59, 130, 246, 0.2)', border: 'rgb(59, 130, 246)' },
    { bg: 'rgba(16, 185, 129, 0.2)', border: 'rgb(16, 185, 129)' },
    { bg: 'rgba(249, 115, 22, 0.2)', border: 'rgb(249, 115, 22)' },
    { bg: 'rgba(168, 85, 247, 0.2)', border: 'rgb(168, 85, 247)' },
    { bg: 'rgba(236, 72, 153, 0.2)', border: 'rgb(236, 72, 153)' },
    { bg: 'rgba(20, 184, 166, 0.2)', border: 'rgb(20, 184, 166)' }
  ];
  
  const datasets = companiesData.map((company, i) => {
    const color = colors[i % colors.length];
    const benchmark = benchmarksData[company.industry_code_33];
    
    return {
      label: company.name,
      data: [
        normalizeValue(company.metrics.roe, 'roe', benchmark?.roe),
        normalizeValue(company.metrics.roa, 'roa', benchmark?.roa),
        normalizeValue(company.metrics.operating_margin, 'operating_margin', benchmark?.operating_margin),
        normalizeValue(company.metrics.revenue_growth, 'revenue_growth', benchmark?.revenue_growth),
        normalizeValue(company.metrics.profit_growth, 'profit_growth', benchmark?.profit_growth),
        normalizeValue(company.metrics.equity_ratio, 'equity_ratio', benchmark?.equity_ratio),
        normalizeValue(company.metrics.dividend_yield, 'dividend_yield', benchmark?.dividend_yield),
        normalizeValue(company.metrics.pbr, 'pbr', benchmark?.pbr)
      ],
      backgroundColor: color.bg,
      borderColor: color.border,
      borderWidth: 2,
      pointBackgroundColor: color.border,
      pointBorderColor: '#fff',
      pointRadius: 3,
      pointHoverRadius: 5
    };
  });
  
  // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
  const isDarkMode = document.body.classList.contains('dark-mode') || 
                     document.documentElement.getAttribute('data-theme') === 'dark';
  
  // è‰²è¨­å®šï¼ˆãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ / ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼‰
  const chartColors = isDarkMode ? {
    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ - æ˜ã‚‹ã„è‰²ã‚’ä½¿ç”¨
    grid: 'rgba(148, 163, 184, 0.4)',
    tick: '#e2e8f0',
    label: '#f8fafc',
    legendLabel: '#f8fafc'
  } : {
    // ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ - æ¿ƒã„è‰²ã‚’ä½¿ç”¨
    grid: 'rgba(100, 116, 139, 0.25)',
    tick: '#334155',
    label: '#0f172a',
    legendLabel: '#0f172a'
  };
  
  new Chart(ctx, {
    type: 'radar',
    data: {
      labels: ['ROE', 'ROA', 'å–¶æ¥­åˆ©ç›Šç‡', 'å£²ä¸Šæˆé•·ç‡', 'åˆ©ç›Šæˆé•·ç‡', 'è‡ªå·±è³‡æœ¬æ¯”ç‡', 'é…å½“åˆ©å›ã‚Š', 'PBR'],
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        r: {
          beginAtZero: true,
          max: 100,
          ticks: {
            stepSize: 25,
            font: { size: 10, weight: '500' },
            color: chartColors.tick,
            backdropColor: 'transparent',
            showLabelBackdrop: false
          },
          pointLabels: {
            font: { size: 12, weight: '600' },
            color: chartColors.label
          },
          grid: { 
            color: chartColors.grid,
            lineWidth: 1
          },
          angleLines: { 
            color: chartColors.grid,
            lineWidth: 1
          }
        }
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 16,
            font: { size: 11, weight: '500' },
            boxWidth: 12,
            color: chartColors.legendLabel,
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          backgroundColor: isDarkMode ? 'rgba(30, 41, 59, 0.95)' : 'rgba(255, 255, 255, 0.95)',
          titleColor: isDarkMode ? '#f1f5f9' : '#1e293b',
          bodyColor: isDarkMode ? '#cbd5e1' : '#475569',
          borderColor: isDarkMode ? '#475569' : '#e2e8f0',
          borderWidth: 1,
          padding: 12,
          boxPadding: 6
        }
      }
    }
  });
}

// ãƒ†ãƒ¼ãƒå¤‰æ›´æ™‚ã«ãƒãƒ£ãƒ¼ãƒˆã‚’å†æç”»
function setupThemeChangeListener() {
  // MutationObserverã§ãƒ†ãƒ¼ãƒå¤‰æ›´ã‚’ç›£è¦–
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class' || mutation.attributeName === 'data-theme') {
        // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„ã—ã¦å†ç”Ÿæˆ
        const chartCanvas = document.getElementById('radar-chart');
        if (chartCanvas) {
          const existingChart = Chart.getChart(chartCanvas);
          if (existingChart) {
            existingChart.destroy();
          }
          generateRadarChart();
        }
      }
    });
  });
  
  // bodyã¨htmlã®ä¸¡æ–¹ã‚’ç›£è¦–
  observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
  observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
}

// ========================================
// åˆæœŸåŒ–
// ========================================
document.addEventListener('DOMContentLoaded', () => {
  generateCompanyCards();
  generateDetailsAccordion();
  generateBenchmarkList();
  generateComparisonTable();
  generateRadarChart();
  setupThemeChangeListener();
});
</script>
{% endblock %}
