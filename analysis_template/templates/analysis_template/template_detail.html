{% extends 'base.html' %}
{% load static %}

{% block title %}{{ template.name }} - 分析レポート{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
  
  body {
    font-family: 'Noto Sans JP', sans-serif;
  }
  
  /* ヘッダー */
  .report-header {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    color: white;
    padding: 0.75rem 0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  .header-title {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
  }
  
  .header-subtitle {
    font-size: 0.75rem;
    opacity: 0.9;
  }
  
  .header-actions {
    display: flex;
    gap: 0.375rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
  }
  
  .header-actions .btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
  
  /* コンパクトなセクション */
  .section-title {
    font-size: 1.125rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    padding-bottom: 0.375rem;
    border-bottom: 2px solid #3b82f6;
  }
  
  /* アコーディオン */
  .accordion-button {
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
    color: black;
  }
  
  .accordion-body {
    padding: 0.75rem;
  }
  
  /* 企業カード - 超コンパクト */
  .company-card-compact {
    border-left: 3px solid;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    border-radius: 0.375rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .company-card-compact .company-name {
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.125rem;
  }
  
  .company-card-compact .company-code {
    font-size: 0.7rem;
    color: #64748b;
  }
  
  .company-card-compact .score-badge {
    font-size: 1.25rem;
    font-weight: 700;
  }
  
  .company-card-compact .metric-row {
    display: flex;
    justify-content: space-between;
    padding: 0.25rem 0;
    border-top: 1px solid #f1f5f9;
    font-size: 0.75rem;
  }
  
  /* チャート */
  .chart-container-mobile {
    height: 220px;
    margin: 0.5rem 0;
  }
  
  /* タブ */
  .nav-tabs {
    border-bottom: 2px solid #e2e8f0;
  }
  
  .nav-tabs .nav-link {
    font-size: 0.8rem;
    padding: 0.375rem 0.75rem;
    border: none;
    color: #64748b;
  }
  
  .nav-tabs .nav-link.active {
    color: #0369a1;
    border-bottom: 2px solid #0369a1;
    font-weight: 600;
  }
  
  /* テーブル - コンパクト */
  .table-compact {
    font-size: 0.7rem;
  }
  
  .table-compact th,
  .table-compact td {
    padding: 0.25rem;
  }
  
  /* ベンチマークカード */
  .benchmark-card-compact {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    border-radius: 0.375rem;
    background: #f8fafc;
    font-size: 0.75rem;
  }
  
  /* 余白削減 */
  .py-compact {
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
  }
  
  .mb-compact {
    margin-bottom: 0.75rem;
  }
  
  /* デスクトップ */
  @media (min-width: 768px) {
    .report-header {
      padding: 1.5rem 0;
    }
    
    .header-title {
      font-size: 1.75rem;
    }
    
    .header-subtitle {
      font-size: 1rem;
    }
    
    .section-title {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .chart-container-mobile {
      height: 400px;
    }
    
    .company-card-compact {
      padding: 1rem;
    }
    
    .py-compact {
      padding-top: 1.5rem;
      padding-bottom: 1.5rem;
    }
    
    .mb-compact {
      margin-bottom: 1.5rem;
    }
  }
  
  /* モバイル専用 */
  @media (max-width: 767.98px) {
    .desktop-only {
      display: none !important;
    }
    
    .header-actions .btn-text {
      display: none;
    }
    
    /* 余白を最小限に */
    .container {
      padding-left: 0.75rem;
      padding-right: 0.75rem;
    }
    
    .card {
      margin-bottom: 0.75rem;
    }
    
    .card-body {
      padding: 0.75rem;
    }
  }
  
  /* 印刷 */
  @media print {
    .no-print {
      display: none;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen">
  <!-- ヘッダー -->
  <header class="report-header no-print">
    <div class="container">
      <h1 class="header-title">{{ template.name }}</h1>
      <p class="header-subtitle">業種別ベンチマーク比較分析</p>
      <div class="header-actions">
        <a href="{% url 'analysis_template:company_select' template.pk %}" class="btn btn-success btn-sm">
          <i class="bi bi-building-add"></i>
          <span class="btn-text ms-1">企業</span>
        </a>
        <a href="{% url 'analysis_template:metrics_edit' template.pk %}" class="btn btn-warning btn-sm">
          <i class="bi bi-bar-chart"></i>
          <span class="btn-text ms-1">指標</span>
        </a>
        <a href="{% url 'analysis_template:list' %}" class="btn btn-secondary btn-sm">
          <i class="bi bi-arrow-left"></i>
          <span class="btn-text ms-1">一覧</span>
        </a>
      </div>
    </div>
  </header>

  <!-- メインコンテンツ -->
  <main class="container py-compact">
    
    <!-- 企業サマリー（コンパクト版） -->
    <section class="mb-compact">
      <h2 class="section-title">企業一覧</h2>
      <div id="company-summary-compact">
        <!-- JavaScriptで生成 -->
      </div>
    </section>

    <!-- タブナビゲーション -->
    <ul class="nav nav-tabs mb-3" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-chart">
          <i class="bi bi-pie-chart"></i> チャート
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-details">
          <i class="bi bi-list-ul"></i> 詳細
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-benchmark">
          <i class="bi bi-graph-up"></i> 業種平均
        </button>
      </li>
    </ul>

    <!-- タブコンテンツ -->
    <div class="tab-content">
      <!-- チャートタブ -->
      <div class="tab-pane fade show active" id="tab-chart">
        <div class="card border-0 shadow-sm mb-compact">
          <div class="card-body p-2">
            <h6 class="mb-2" style="font-size: 0.875rem;">8指標レーダーチャート</h6>
            <div class="chart-container-mobile">
              <canvas id="radar-chart"></canvas>
            </div>
          </div>
        </div>
        
        <!-- 比較テーブル（折りたたみ） -->
        <div class="accordion" id="accordionComparison">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTable">
                <i class="bi bi-table me-2"></i>詳細比較表
              </button>
            </h2>
            <div id="collapseTable" class="accordion-collapse collapse" data-bs-parent="#accordionComparison">
              <div class="accordion-body">
                <div class="table-responsive">
                  <table class="table table-compact table-hover mb-0" id="comparison-table">
                    <!-- JavaScriptで生成 -->
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 詳細タブ -->
      <div class="tab-pane fade" id="tab-details">
        <div class="accordion" id="accordionDetails">
          <!-- JavaScriptで企業ごとのアコーディオンを生成 -->
        </div>
      </div>

      <!-- 業種平均タブ -->
      <div class="tab-pane fade" id="tab-benchmark">
        <div id="benchmark-list">
          <!-- JavaScriptで生成 -->
        </div>
      </div>
    </div>

  </main>
</div>

<script>
// データをJavaScriptに渡す
const companiesData = {{ companies_data|safe }};
const benchmarksData = {{ benchmarks_data|safe }};
const templateId = {{ template.pk }};

// デバッグモード
const DEBUG_MODE = new URLSearchParams(window.location.search).get('debug') === '1';

// ========================================
// ユーティリティ関数
// ========================================
function formatNumber(num, decimals = 1) {
  if (num === null || num === undefined || isNaN(num)) return '-';
  return Number(num).toFixed(decimals);
}

function getScoreColor(score) {
  if (score >= 70) return 'success';
  if (score >= 50) return 'primary';
  return 'warning';
}

// ========================================
// スコア計算
// ========================================
function calculateScore(company) {
  const industryCode = company.industry_code_33;
  const benchmark = benchmarksData[industryCode];
  const metrics = ['roe', 'roa', 'operating_margin'];
  let totalScore = 0;
  let count = 0;
  
  if (benchmark) {
    metrics.forEach(metric => {
      const value = company.metrics[metric];
      const benchmarkData = benchmark[metric];
      if (value !== null && value !== undefined && benchmarkData && benchmarkData.avg > 0) {
        const score = (Number(value) / Number(benchmarkData.avg)) * 50;
        totalScore += Math.max(0, Math.min(100, score));
        count++;
      }
    });
  }
  
  if (count === 0) {
    const templateAverages = {};
    metrics.forEach(metric => {
      const values = companiesData
        .map(c => c.metrics[metric])
        .filter(v => v !== null && v !== undefined && !isNaN(v))
        .map(v => Number(v));
      if (values.length > 0) {
        templateAverages[metric] = values.reduce((a, b) => a + b, 0) / values.length;
      }
    });
    
    metrics.forEach(metric => {
      const value = company.metrics[metric];
      const avg = templateAverages[metric];
      if (value !== null && value !== undefined && avg && avg > 0) {
        const score = (Number(value) / avg) * 50;
        totalScore += Math.max(0, Math.min(100, score));
        count++;
      }
    });
  }
  
  return count > 0 ? totalScore / count : 50;
}

// ========================================
// 正規化関数
// ========================================
function normalizeValue(value, metricKey, benchmark) {
  if (value === null || value === undefined || isNaN(value)) return null;
  
  const numValue = Number(value);
  
  if (benchmark && benchmark.avg && benchmark.avg > 0) {
    let score = (numValue / Number(benchmark.avg)) * 50;
    if (metricKey === 'pbr' || metricKey === 'per') {
      score = 100 - score;
    }
    return Math.max(0, Math.min(100, score));
  }
  
  const values = companiesData
    .map(c => c.metrics[metricKey])
    .filter(v => v !== null && v !== undefined && !isNaN(v))
    .map(v => Number(v));
  
  if (values.length === 0) return null;
  
  const avg = values.reduce((a, b) => a + b, 0) / values.length;
  if (avg === 0) return null;
  
  let score = (numValue / avg) * 50;
  if (metricKey === 'pbr' || metricKey === 'per') {
    score = 100 - score;
  }
  
  return Math.max(0, Math.min(100, score));
}

// ========================================
// コンパクト企業サマリー生成
// ========================================
function generateCompactSummary() {
  const container = document.getElementById('company-summary-compact');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (companiesData.length === 0) {
    container.innerHTML = '<div class="alert alert-info small">企業が登録されていません</div>';
    return;
  }
  
  companiesData.forEach(company => {
    const score = calculateScore(company);
    const colorClass = getScoreColor(score);
    
    const card = document.createElement('div');
    card.className = `company-card-compact border-${colorClass}`;
    card.innerHTML = `
      <div class="d-flex justify-content-between align-items-start">
        <div class="flex-grow-1">
          <div class="company-name">${company.name}</div>
          <div class="company-code">${company.code}</div>
        </div>
        <div class="text-end">
          <div class="score-badge text-${colorClass}">${score.toFixed(0)}</div>
          <small style="font-size: 0.65rem; color: #94a3b8;">スコア</small>
        </div>
      </div>
      <div class="metric-row">
        <span class="text-muted">ROE</span>
        <strong>${formatNumber(company.metrics.roe)}%</strong>
      </div>
      <div class="metric-row">
        <span class="text-muted">営業利益率</span>
        <strong>${formatNumber(company.metrics.operating_margin)}%</strong>
      </div>
    `;
    
    container.appendChild(card);
  });
}

// ========================================
// 企業詳細アコーディオン生成
// ========================================
function generateDetailsAccordion() {
  const container = document.getElementById('accordionDetails');
  if (!container) return;
  
  container.innerHTML = '';
  
  companiesData.forEach((company, index) => {
    const benchmark = benchmarksData[company.industry_code_33];
    
    const item = document.createElement('div');
    item.className = 'accordion-item';
    item.innerHTML = `
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#detail${index}">
          ${company.name} <small class="ms-2 text-muted">${company.code}</small>
        </button>
      </h2>
      <div id="detail${index}" class="accordion-collapse collapse" data-bs-parent="#accordionDetails">
        <div class="accordion-body">
          <div class="mb-2">
            <strong style="font-size: 0.8rem;">収益性</strong>
            ${generateMetricBadge('ROE', company.metrics.roe, '%', benchmark?.roe)}
            ${generateMetricBadge('ROA', company.metrics.roa, '%', benchmark?.roa)}
            ${generateMetricBadge('営業利益率', company.metrics.operating_margin, '%', benchmark?.operating_margin)}
          </div>
          <div class="mb-2">
            <strong style="font-size: 0.8rem;">バリュエーション</strong>
            ${generateMetricBadge('PER', company.metrics.per, '倍', benchmark?.per)}
            ${generateMetricBadge('PBR', company.metrics.pbr, '倍', benchmark?.pbr)}
            ${generateMetricBadge('配当利回り', company.metrics.dividend_yield, '%', benchmark?.dividend_yield)}
          </div>
          <div>
            <strong style="font-size: 0.8rem;">財務健全性</strong>
            ${generateMetricBadge('自己資本比率', company.metrics.equity_ratio, '%', benchmark?.equity_ratio)}
          </div>
        </div>
      </div>
    `;
    
    container.appendChild(item);
  });
}

function generateMetricBadge(label, value, unit, benchmark) {
  let comparison = '';
  if (benchmark && value) {
    const diff = Number(value) - Number(benchmark.avg);
    const arrow = diff > 0 ? '↑' : '↓';
    const color = diff > 0 ? 'text-success' : 'text-danger';
    comparison = `<small class="${color} ms-1">${arrow}${Math.abs(diff).toFixed(1)}</small>`;
  }
  
  return `
    <div class="d-flex justify-content-between py-1 border-bottom" style="font-size: 0.75rem;">
      <span class="text-muted">${label}</span>
      <span><strong>${formatNumber(value)}${unit}</strong>${comparison}</span>
    </div>
  `;
}

// ========================================
// 業種平均リスト生成
// ========================================
function generateBenchmarkList() {
  const container = document.getElementById('benchmark-list');
  if (!container) return;
  
  if (Object.keys(benchmarksData).length === 0) {
    container.innerHTML = '<div class="alert alert-warning small">業種別ベンチマークが未登録です</div>';
    return;
  }
  
  container.innerHTML = '';
  
  Object.entries(benchmarksData).forEach(([code, benchmark]) => {
    const card = document.createElement('div');
    card.className = 'benchmark-card-compact';
    card.innerHTML = `
      <strong class="d-block mb-2">${benchmark.name}</strong>
      ${generateBenchmarkRow('ROE', benchmark.roe)}
      ${generateBenchmarkRow('ROA', benchmark.roa)}
      ${generateBenchmarkRow('営業利益率', benchmark.operating_margin)}
    `;
    container.appendChild(card);
  });
}

function generateBenchmarkRow(label, data) {
  if (!data) return '';
  return `
    <div class="d-flex justify-content-between py-1">
      <span>${label}</span>
      <span><strong>${formatNumber(data.avg)}</strong> <small class="text-muted">(優良:${formatNumber(data.excellent)})</small></span>
    </div>
  `;
}

// ========================================
// 比較テーブル生成
// ========================================
function generateComparisonTable() {
  const table = document.getElementById('comparison-table');
  if (!table) return;
  
  if (companiesData.length === 0) {
    table.innerHTML = '<tbody><tr><td class="text-center py-3 small">企業が登録されていません</td></tr></tbody>';
    return;
  }
  
  const metrics = [
    { key: 'roe', label: 'ROE', unit: '%' },
    { key: 'roa', label: 'ROA', unit: '%' },
    { key: 'operating_margin', label: '営業利益率', unit: '%' },
    { key: 'per', label: 'PER', unit: '倍' },
    { key: 'pbr', label: 'PBR', unit: '倍' },
    { key: 'dividend_yield', label: '配当', unit: '%' }
  ];
  
  let html = '<thead><tr><th>指標</th>';
  companiesData.forEach(c => {
    html += `<th style="font-size: 0.65rem;">${c.name}</th>`;
  });
  html += '</tr></thead><tbody>';
  
  metrics.forEach(metric => {
    html += '<tr><td class="fw-semibold">' + metric.label + '</td>';
    companiesData.forEach(company => {
      const value = company.metrics[metric.key];
      html += `<td class="text-center">${formatNumber(value)}${metric.unit}</td>`;
    });
    html += '</tr>';
  });
  
  html += '</tbody>';
  table.innerHTML = html;
}

// ========================================
// レーダーチャート生成
// ========================================
function generateRadarChart() {
  const ctx = document.getElementById('radar-chart');
  if (!ctx) return;
  
  if (companiesData.length === 0) {
    ctx.parentElement.innerHTML = '<div class="alert alert-info small">企業が登録されていません</div>';
    return;
  }
  
  const datasets = companiesData.map((company, index) => {
    const colors = [
      { bg: 'rgba(59, 130, 246, 0.2)', border: 'rgb(59, 130, 246)' },
      { bg: 'rgba(16, 185, 129, 0.2)', border: 'rgb(16, 185, 129)' },
      { bg: 'rgba(249, 115, 22, 0.2)', border: 'rgb(249, 115, 22)' },
      { bg: 'rgba(168, 85, 247, 0.2)', border: 'rgb(168, 85, 247)' },
      { bg: 'rgba(236, 72, 153, 0.2)', border: 'rgb(236, 72, 153)' }
    ];
    
    const color = colors[index % colors.length];
    const benchmark = benchmarksData[company.industry_code_33];
    
    const data = [
      normalizeValue(company.metrics.roe, 'roe', benchmark?.roe),
      normalizeValue(company.metrics.roa, 'roa', benchmark?.roa),
      normalizeValue(company.metrics.operating_margin, 'operating_margin', benchmark?.operating_margin),
      normalizeValue(company.metrics.revenue_growth, 'revenue_growth', benchmark?.revenue_growth),
      normalizeValue(company.metrics.profit_growth, 'profit_growth', benchmark?.profit_growth),
      normalizeValue(company.metrics.equity_ratio, 'equity_ratio', benchmark?.equity_ratio),
      normalizeValue(company.metrics.dividend_yield, 'dividend_yield', benchmark?.dividend_yield),
      normalizeValue(company.metrics.pbr, 'pbr', benchmark?.pbr)
    ];
    
    return {
      label: company.name,
      data: data,
      backgroundColor: color.bg,
      borderColor: color.border,
      borderWidth: 1.5,
      pointBackgroundColor: color.border,
      pointBorderColor: '#fff',
      pointRadius: 2,
      pointHoverRadius: 4
    };
  });
  
  new Chart(ctx, {
    type: 'radar',
    data: {
      labels: ['ROE', 'ROA', '営業\n利益率', '売上\n成長率', '利益\n成長率', '自己資本\n比率', '配当\n利回り', 'PBR'],
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        r: {
          beginAtZero: true,
          max: 100,
          ticks: {
            stepSize: 25,
            font: { size: 8 }
          },
          pointLabels: {
            font: { size: 9 }
          }
        }
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 6,
            font: { size: 9 },
            boxWidth: 10
          }
        }
      }
    }
  });
}

// ========================================
// 初期化
// ========================================
document.addEventListener('DOMContentLoaded', () => {
  generateCompactSummary();
  generateDetailsAccordion();
  generateBenchmarkList();
  generateComparisonTable();
  generateRadarChart();
});
</script>
{% endblock %}