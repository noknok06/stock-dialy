{% extends 'base.html' %}
{% load static %}

{% block title %}{{ template.name }} - åˆ†æãƒ¬ãƒãƒ¼ãƒˆ{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="{% static 'css/2-layouts/analysis-template.css' %}">
{% endblock %}

{% block content %}
<div class="at-container">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="at-report-header">
    <div class="at-header-content">
      <div>
        <h1 class="at-header-title">{{ template.name }}</h1>
        <p class="at-header-subtitle">{{ template.description|default:"æ¥­ç¨®åˆ¥ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æ¯”è¼ƒåˆ†æ" }}</p>
      </div>
      <div class="at-header-actions">
        <a href="{% url 'analysis_template:company_select' template.pk %}" class="btn btn-primary btn-sm">
          <i class="bi bi-building-add"></i>
          <span class="d-none d-sm-inline">ä¼æ¥­è¿½åŠ </span>
        </a>
        <a href="{% url 'analysis_template:metrics_edit' template.pk %}" class="btn btn-success btn-sm">
          <i class="bi bi-bar-chart"></i>
          <span class="d-none d-sm-inline">æŒ‡æ¨™ç·¨é›†</span>
        </a>
        <a href="{% url 'analysis_template:list' %}" class="btn btn-outline-light btn-sm">
          <i class="bi bi-arrow-left"></i>
          <span class="d-none d-sm-inline">ä¸€è¦§</span>
        </a>
      </div>
    </div>
  </div>

  <!-- ä¼æ¥­ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <section class="mb-4">
    <h2 class="at-section-title">
      <i class="bi bi-building"></i>
      ä¼æ¥­ä¸€è¦§
      <span class="badge bg-primary ms-2" id="companyCount">0</span>
    </h2>
    
    <div class="at-company-grid" id="companyGrid">
      <!-- JavaScript ã§ç”Ÿæˆ -->
    </div>
  </section>

  <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="at-tabs" role="tablist">
    <button class="at-tab active" data-bs-toggle="tab" data-bs-target="#tab-chart" role="tab">
      <i class="bi bi-pie-chart"></i>
      <span>ãƒãƒ£ãƒ¼ãƒˆ</span>
    </button>
    <button class="at-tab" data-bs-toggle="tab" data-bs-target="#tab-details" role="tab">
      <i class="bi bi-list-ul"></i>
      <span>è©³ç´°</span>
    </button>
    <button class="at-tab" data-bs-toggle="tab" data-bs-target="#tab-benchmark" role="tab">
      <i class="bi bi-graph-up"></i>
      <span>æ¥­ç¨®å¹³å‡</span>
    </button>
  </div>

  <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="tab-content">
    <!-- ãƒãƒ£ãƒ¼ãƒˆã‚¿ãƒ– -->
    <div class="tab-pane fade show active" id="tab-chart" role="tabpanel">
      <div class="at-card">
        <h6 class="at-chart-title">
          <i class="bi bi-radar me-2"></i>8æŒ‡æ¨™ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆæ¯”è¼ƒ
        </h6>
        <div class="at-chart-container">
          <canvas id="radar-chart"></canvas>
        </div>
      </div>
      
      <!-- æ¯”è¼ƒè¡¨ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ -->
      <div class="at-accordion-item">
        <button class="at-accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTable" aria-expanded="false">
          <span><i class="bi bi-table me-2"></i>è©³ç´°æ¯”è¼ƒè¡¨</span>
        </button>
        <div id="collapseTable" class="collapse">
          <div class="at-accordion-body">
            <div class="at-table-wrapper">
              <table class="at-table" id="comparison-table">
                <!-- JavaScript ã§ç”Ÿæˆ -->
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- è©³ç´°ã‚¿ãƒ– -->
    <div class="tab-pane fade" id="tab-details" role="tabpanel">
      <div id="detailsAccordion">
        <!-- JavaScript ã§ç”Ÿæˆ -->
      </div>
    </div>

    <!-- æ¥­ç¨®å¹³å‡ã‚¿ãƒ– -->
    <div class="tab-pane fade" id="tab-benchmark" role="tabpanel">
      <div id="benchmarkList">
        <!-- JavaScript ã§ç”Ÿæˆ -->
      </div>
    </div>
  </div>
</div>

<script>
const companiesData = {{ companies_data|safe }};
const benchmarksData = {{ benchmarks_data|safe }};
const templateId = {{ template.pk }};

// ========================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ========================================
function formatNumber(num, decimals = 1) {
  if (num === null || num === undefined || isNaN(num)) return '-';
  return Number(num).toFixed(decimals);
}

function getScoreColor(score) {
  if (score >= 70) return 'success';
  if (score >= 50) return 'primary';
  return 'warning';
}

// ========================================
// ã‚¹ã‚³ã‚¢è¨ˆç®—
// ========================================
function calculateScore(company) {
  const benchmark = benchmarksData[company.industry_code_33];
  const metrics = ['roe', 'roa', 'operating_margin'];
  let totalScore = 0, count = 0;
  
  if (benchmark) {
    metrics.forEach(m => {
      const v = company.metrics[m];
      const b = benchmark[m];
      if (v != null && b?.avg > 0) {
        totalScore += Math.max(0, Math.min(100, (Number(v) / Number(b.avg)) * 50));
        count++;
      }
    });
  }
  
  if (count === 0) {
    const avgs = {};
    metrics.forEach(m => {
      const vals = companiesData.map(c => c.metrics[m]).filter(v => v != null).map(Number);
      if (vals.length) avgs[m] = vals.reduce((a, b) => a + b, 0) / vals.length;
    });
    
    metrics.forEach(m => {
      const v = company.metrics[m];
      if (v != null && avgs[m] > 0) {
        totalScore += Math.max(0, Math.min(100, (Number(v) / avgs[m]) * 50));
        count++;
      }
    });
  }
  
  return count > 0 ? totalScore / count : 50;
}

// æ­£è¦åŒ–
function normalizeValue(value, key, benchmark) {
  if (value == null || isNaN(value)) return null;
  const v = Number(value);
  
  let avg = benchmark?.avg;
  if (!avg || avg <= 0) {
    const vals = companiesData.map(c => c.metrics[key]).filter(x => x != null).map(Number);
    if (!vals.length) return null;
    avg = vals.reduce((a, b) => a + b, 0) / vals.length;
  }
  if (!avg || avg === 0) return null;
  
  let score = (v / avg) * 50;
  if (key === 'pbr' || key === 'per') score = 100 - score;
  return Math.max(0, Math.min(100, score));
}

// ========================================
// ä¼æ¥­ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
// ========================================
function generateCompanyCards() {
  const grid = document.getElementById('companyGrid');
  const countEl = document.getElementById('companyCount');
  
  if (!companiesData.length) {
    grid.innerHTML = `
      <div class="at-empty-state" style="grid-column: 1/-1;">
        <div class="at-empty-icon">ğŸ“Š</div>
        <h3 class="at-empty-title">ä¼æ¥­ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</h3>
        <p class="at-empty-desc">åˆ†æå¯¾è±¡ã®ä¼æ¥­ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
        <a href="{% url 'analysis_template:company_select' template.pk %}" class="btn btn-primary">
          <i class="bi bi-plus-circle me-2"></i>ä¼æ¥­ã‚’è¿½åŠ 
        </a>
      </div>`;
    return;
  }
  
  countEl.textContent = companiesData.length;
  grid.innerHTML = '';
  
  companiesData.forEach(company => {
    const score = calculateScore(company);
    const color = getScoreColor(score);
    
    const card = document.createElement('div');
    card.className = `at-company-card score-${score >= 70 ? 'high' : score >= 50 ? 'mid' : 'low'}`;
    card.innerHTML = `
      <div class="at-company-header">
        <div class="at-company-info">
          <div class="at-company-name">${company.name}</div>
          <div class="at-company-code">${company.code} Â· ${company.industry_name_33 || '-'}</div>
        </div>
        <div class="at-score-display">
          <span class="at-score-badge text-${color}">${score.toFixed(0)}</span>
          <div class="at-score-label">ã‚¹ã‚³ã‚¢</div>
        </div>
      </div>
      <div class="at-metrics-grid">
        <div class="at-metric-item">
          <span class="at-metric-label">ROE</span>
          <span class="at-metric-value">${formatNumber(company.metrics.roe)}%</span>
        </div>
        <div class="at-metric-item">
          <span class="at-metric-label">ROA</span>
          <span class="at-metric-value">${formatNumber(company.metrics.roa)}%</span>
        </div>
        <div class="at-metric-item">
          <span class="at-metric-label">å–¶æ¥­åˆ©ç›Šç‡</span>
          <span class="at-metric-value">${formatNumber(company.metrics.operating_margin)}%</span>
        </div>
        <div class="at-metric-item">
          <span class="at-metric-label">é…å½“åˆ©å›ã‚Š</span>
          <span class="at-metric-value">${formatNumber(company.metrics.dividend_yield)}%</span>
        </div>
      </div>
    `;
    grid.appendChild(card);
  });
}

// ========================================
// è©³ç´°ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ç”Ÿæˆ
// ========================================
function generateDetailsAccordion() {
  const container = document.getElementById('detailsAccordion');
  if (!companiesData.length) {
    container.innerHTML = '<div class="at-card"><p class="text-center at-text-muted py-4">ä¼æ¥­ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
    return;
  }
  
  container.innerHTML = '';
  
  companiesData.forEach((company, i) => {
    const benchmark = benchmarksData[company.industry_code_33];
    
    const item = document.createElement('div');
    item.className = 'at-accordion-item';
    item.innerHTML = `
      <button class="at-accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#detail${i}" aria-expanded="false">
        <span>${company.name} <small class="at-text-muted ms-2">${company.code}</small></span>
      </button>
      <div id="detail${i}" class="collapse">
        <div class="at-accordion-body">
          <div class="at-form-section">
            <div class="at-form-section-title"><i class="bi bi-graph-up-arrow me-2"></i>åç›Šæ€§</div>
            ${generateMetricRows([
              ['ROE', company.metrics.roe, '%', benchmark?.roe],
              ['ROA', company.metrics.roa, '%', benchmark?.roa],
              ['å–¶æ¥­åˆ©ç›Šç‡', company.metrics.operating_margin, '%', benchmark?.operating_margin]
            ])}
          </div>
          <div class="at-form-section">
            <div class="at-form-section-title"><i class="bi bi-currency-yen me-2"></i>ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³</div>
            ${generateMetricRows([
              ['PER', company.metrics.per, 'å€', benchmark?.per],
              ['PBR', company.metrics.pbr, 'å€', benchmark?.pbr],
              ['é…å½“åˆ©å›ã‚Š', company.metrics.dividend_yield, '%', benchmark?.dividend_yield]
            ])}
          </div>
          <div class="at-form-section">
            <div class="at-form-section-title"><i class="bi bi-shield-check me-2"></i>è²¡å‹™å¥å…¨æ€§</div>
            ${generateMetricRows([
              ['è‡ªå·±è³‡æœ¬æ¯”ç‡', company.metrics.equity_ratio, '%', benchmark?.equity_ratio]
            ])}
          </div>
        </div>
      </div>
    `;
    container.appendChild(item);
  });
}

function generateMetricRows(metrics) {
  return metrics.map(([label, value, unit, benchmark]) => {
    let comparison = '';
    if (benchmark && value != null) {
      const diff = Number(value) - Number(benchmark.avg);
      comparison = `<small class="${diff > 0 ? 'at-text-success' : 'at-text-danger'} ms-2">${diff > 0 ? 'â†‘' : 'â†“'}${Math.abs(diff).toFixed(1)}</small>`;
    }
    return `
      <div class="at-benchmark-row">
        <span class="at-benchmark-label">${label}</span>
        <span><strong class="at-benchmark-value">${formatNumber(value)}${unit}</strong>${comparison}</span>
      </div>`;
  }).join('');
}

// ========================================
// æ¥­ç¨®å¹³å‡ãƒªã‚¹ãƒˆç”Ÿæˆ
// ========================================
function generateBenchmarkList() {
  const container = document.getElementById('benchmarkList');
  
  if (!Object.keys(benchmarksData).length) {
    container.innerHTML = '<div class="at-card"><p class="text-center at-text-muted py-4">æ¥­ç¨®åˆ¥ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãŒæœªç™»éŒ²ã§ã™</p></div>';
    return;
  }
  
  container.innerHTML = '';
  
  Object.entries(benchmarksData).forEach(([code, benchmark]) => {
    const card = document.createElement('div');
    card.className = 'at-benchmark-card';
    card.innerHTML = `
      <div class="at-benchmark-title">${benchmark.name}</div>
      ${generateBenchmarkMetricRow('ROE', benchmark.roe)}
      ${generateBenchmarkMetricRow('ROA', benchmark.roa)}
      ${generateBenchmarkMetricRow('å–¶æ¥­åˆ©ç›Šç‡', benchmark.operating_margin)}
      ${generateBenchmarkMetricRow('PER', benchmark.per)}
      ${generateBenchmarkMetricRow('PBR', benchmark.pbr)}
    `;
    container.appendChild(card);
  });
}

function generateBenchmarkMetricRow(label, data) {
  if (!data) return '';
  return `
    <div class="at-benchmark-row">
      <span class="at-benchmark-label">${label}</span>
      <span>
        <strong class="at-benchmark-value">${formatNumber(data.avg)}</strong>
        ${data.excellent ? `<span class="at-benchmark-excellent">(å„ªè‰¯: ${formatNumber(data.excellent)})</span>` : ''}
      </span>
    </div>`;
}

// ========================================
// æ¯”è¼ƒãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
// ========================================
function generateComparisonTable() {
  const table = document.getElementById('comparison-table');
  
  if (!companiesData.length) {
    table.innerHTML = '<tbody><tr><td class="text-center py-4 at-text-muted">ä¼æ¥­ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr></tbody>';
    return;
  }
  
  const metrics = [
    { key: 'roe', label: 'ROE', unit: '%' },
    { key: 'roa', label: 'ROA', unit: '%' },
    { key: 'operating_margin', label: 'å–¶æ¥­åˆ©ç›Šç‡', unit: '%' },
    { key: 'per', label: 'PER', unit: 'å€' },
    { key: 'pbr', label: 'PBR', unit: 'å€' },
    { key: 'dividend_yield', label: 'é…å½“åˆ©å›ã‚Š', unit: '%' },
    { key: 'equity_ratio', label: 'è‡ªå·±è³‡æœ¬æ¯”ç‡', unit: '%' }
  ];
  
  let html = '<thead><tr><th>æŒ‡æ¨™</th>';
  companiesData.forEach(c => html += `<th>${c.name.substring(0, 8)}${c.name.length > 8 ? '...' : ''}</th>`);
  html += '</tr></thead><tbody>';
  
  metrics.forEach(m => {
    html += `<tr><td class="fw-semibold">${m.label}</td>`;
    companiesData.forEach(c => {
      const v = c.metrics[m.key];
      html += `<td class="text-end">${formatNumber(v)}${v != null ? m.unit : ''}</td>`;
    });
    html += '</tr>';
  });
  
  table.innerHTML = html + '</tbody>';
}

// ========================================
// ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆç”Ÿæˆ
// ========================================
function generateRadarChart() {
  const ctx = document.getElementById('radar-chart');
  
  if (!companiesData.length) {
    ctx.parentElement.innerHTML = '<div class="text-center at-text-muted py-4">ä¼æ¥­ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
    return;
  }
  
  const colors = [
    { bg: 'rgba(59, 130, 246, 0.2)', border: 'rgb(59, 130, 246)' },
    { bg: 'rgba(16, 185, 129, 0.2)', border: 'rgb(16, 185, 129)' },
    { bg: 'rgba(249, 115, 22, 0.2)', border: 'rgb(249, 115, 22)' },
    { bg: 'rgba(168, 85, 247, 0.2)', border: 'rgb(168, 85, 247)' },
    { bg: 'rgba(236, 72, 153, 0.2)', border: 'rgb(236, 72, 153)' },
    { bg: 'rgba(20, 184, 166, 0.2)', border: 'rgb(20, 184, 166)' }
  ];
  
  const datasets = companiesData.map((company, i) => {
    const color = colors[i % colors.length];
    const benchmark = benchmarksData[company.industry_code_33];
    
    return {
      label: company.name,
      data: [
        normalizeValue(company.metrics.roe, 'roe', benchmark?.roe),
        normalizeValue(company.metrics.roa, 'roa', benchmark?.roa),
        normalizeValue(company.metrics.operating_margin, 'operating_margin', benchmark?.operating_margin),
        normalizeValue(company.metrics.revenue_growth, 'revenue_growth', benchmark?.revenue_growth),
        normalizeValue(company.metrics.profit_growth, 'profit_growth', benchmark?.profit_growth),
        normalizeValue(company.metrics.equity_ratio, 'equity_ratio', benchmark?.equity_ratio),
        normalizeValue(company.metrics.dividend_yield, 'dividend_yield', benchmark?.dividend_yield),
        normalizeValue(company.metrics.pbr, 'pbr', benchmark?.pbr)
      ],
      backgroundColor: color.bg,
      borderColor: color.border,
      borderWidth: 2,
      pointBackgroundColor: color.border,
      pointBorderColor: '#fff',
      pointRadius: 3,
      pointHoverRadius: 5
    };
  });
  
  // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
  const isDarkMode = document.body.classList.contains('dark-mode') || 
                     document.documentElement.getAttribute('data-theme') === 'dark';
  
  // è‰²è¨­å®šï¼ˆãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ / ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼‰
  const chartColors = isDarkMode ? {
    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ - æ˜ã‚‹ã„è‰²ã‚’ä½¿ç”¨
    grid: 'rgba(148, 163, 184, 0.4)',
    tick: '#e2e8f0',
    label: '#f8fafc',
    legendLabel: '#f8fafc'
  } : {
    // ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ - æ¿ƒã„è‰²ã‚’ä½¿ç”¨
    grid: 'rgba(100, 116, 139, 0.25)',
    tick: '#334155',
    label: '#0f172a',
    legendLabel: '#0f172a'
  };
  
  new Chart(ctx, {
    type: 'radar',
    data: {
      labels: ['ROE', 'ROA', 'å–¶æ¥­åˆ©ç›Šç‡', 'å£²ä¸Šæˆé•·ç‡', 'åˆ©ç›Šæˆé•·ç‡', 'è‡ªå·±è³‡æœ¬æ¯”ç‡', 'é…å½“åˆ©å›ã‚Š', 'PBR'],
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        r: {
          beginAtZero: true,
          max: 100,
          ticks: {
            stepSize: 25,
            font: { size: 10, weight: '500' },
            color: chartColors.tick,
            backdropColor: 'transparent',
            showLabelBackdrop: false
          },
          pointLabels: {
            font: { size: 12, weight: '600' },
            color: chartColors.label
          },
          grid: { 
            color: chartColors.grid,
            lineWidth: 1
          },
          angleLines: { 
            color: chartColors.grid,
            lineWidth: 1
          }
        }
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 16,
            font: { size: 11, weight: '500' },
            boxWidth: 12,
            color: chartColors.legendLabel,
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          backgroundColor: isDarkMode ? 'rgba(30, 41, 59, 0.95)' : 'rgba(255, 255, 255, 0.95)',
          titleColor: isDarkMode ? '#f1f5f9' : '#1e293b',
          bodyColor: isDarkMode ? '#cbd5e1' : '#475569',
          borderColor: isDarkMode ? '#475569' : '#e2e8f0',
          borderWidth: 1,
          padding: 12,
          boxPadding: 6
        }
      }
    }
  });
}

// ãƒ†ãƒ¼ãƒå¤‰æ›´æ™‚ã«ãƒãƒ£ãƒ¼ãƒˆã‚’å†æç”»
function setupThemeChangeListener() {
  // MutationObserverã§ãƒ†ãƒ¼ãƒå¤‰æ›´ã‚’ç›£è¦–
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class' || mutation.attributeName === 'data-theme') {
        // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„ã—ã¦å†ç”Ÿæˆ
        const chartCanvas = document.getElementById('radar-chart');
        if (chartCanvas) {
          const existingChart = Chart.getChart(chartCanvas);
          if (existingChart) {
            existingChart.destroy();
          }
          generateRadarChart();
        }
      }
    });
  });
  
  // bodyã¨htmlã®ä¸¡æ–¹ã‚’ç›£è¦–
  observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
  observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
}

// ========================================
// åˆæœŸåŒ–
// ========================================
document.addEventListener('DOMContentLoaded', () => {
  generateCompanyCards();
  generateDetailsAccordion();
  generateBenchmarkList();
  generateComparisonTable();
  generateRadarChart();
  setupThemeChangeListener();
});
</script>
{% endblock %}