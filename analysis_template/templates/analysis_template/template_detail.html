{% extends 'base.html' %}
{% load static %}

{% block title %}{{ template.name }} - åˆ†æãƒ¬ãƒãƒ¼ãƒˆ{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="{% static 'css/2-layouts/analysis-template.css' %}?v={{ STATIC_VERSION }}">
<style>
/* ========== Modern Header ========== */
.detail-header {
    background: linear-gradient(135deg, var(--at-primary, #3b82f6), var(--at-primary-dark, #2563eb));
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 0 0 24px 24px;
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.2);
}

.detail-header-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1.5rem;
    flex-wrap: wrap;
}

.detail-header-info {
    flex: 1;
    min-width: 0;
}

.detail-title {
    font-size: 2rem;
    font-weight: 800;
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.detail-subtitle {
    font-size: 1rem;
    opacity: 0.9;
    margin: 0;
}

.detail-header-actions {
    display: flex;
    gap: 0.75rem;
}

.header-action-btn {
    padding: 0.75rem 1.25rem;
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.9375rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    transition: all 0.2s;
}

.header-action-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
    color: white;
}

/* ========== Stats Cards ========== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: var(--at-bg-card, #ffffff);
    border: 2px solid var(--at-border, #e2e8f0);
    border-radius: 16px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s;
}

.stat-card:hover {
    border-color: var(--at-primary, #3b82f6);
    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);
    transform: translateY(-2px);
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    flex-shrink: 0;
}

.stat-icon.primary {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.2));
    color: var(--at-primary, #3b82f6);
}

.stat-icon.success {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2));
    color: var(--at-success, #10b981);
}

.stat-icon.warning {
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(249, 115, 22, 0.2));
    color: var(--at-warning, #f97316);
}

.stat-content {
    flex: 1;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--at-text-muted, #64748b);
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.stat-value {
    font-size: 1.75rem;
    font-weight: 800;
    color: var(--at-text-primary, #0f172a);
    line-height: 1;
}

/* ========== Modern Tabs ========== */
.modern-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    padding: 0.5rem;
    background: var(--at-bg-secondary, #f8fafc);
    border-radius: 16px;
    border: 2px solid var(--at-border, #e2e8f0);
}

.modern-tab {
    flex: 1;
    min-width: 120px;
    padding: 0.875rem 1.25rem;
    background: transparent;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.9375rem;
    color: var(--at-text-secondary, #64748b);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
}

.modern-tab:hover {
    background: rgba(59, 130, 246, 0.05);
    color: var(--at-primary, #3b82f6);
}

.modern-tab.active {
    background: white;
    color: var(--at-primary, #3b82f6);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

/* ========== Company Grid ========== */
.company-grid {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 1.25rem;
    margin-bottom: 2rem;
}

.company-card-modern {
    background: var(--at-bg-card, #ffffff);
    border: 2px solid var(--at-border, #e2e8f0);
    border-radius: 16px;
    padding: 1.5rem;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
}

.company-card-modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--at-primary, #3b82f6), var(--at-primary-light, #60a5fa));
    opacity: 0;
    transition: opacity 0.3s;
}

.company-card-modern:hover {
    border-color: var(--at-primary, #3b82f6);
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.12);
    transform: translateY(-4px);
}

.company-card-modern:hover::before {
    opacity: 1;
}

.company-card-modern.high-score {
    border-color: var(--at-success, #10b981);
}

.company-card-modern.high-score::before {
    background: linear-gradient(90deg, var(--at-success, #10b981), var(--at-success-light, #34d399));
    opacity: 1;
}

.company-header-modern {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.25rem;
    gap: 1rem;
}

.company-info-modern {
    flex: 1;
    min-width: 0;
}

.company-name-modern {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--at-text-primary, #0f172a);
    margin-bottom: 0.375rem;
}

.company-meta-modern {
    font-size: 0.8125rem;
    color: var(--at-text-muted, #64748b);
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.score-badge-modern {
    width: 64px;
    height: 64px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.15));
    border: 2px solid rgba(59, 130, 246, 0.2);
    flex-shrink: 0;
}

.score-number-modern {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--at-primary, #3b82f6);
    line-height: 1;
}

.score-label-modern {
    font-size: 0.625rem;
    font-weight: 600;
    color: var(--at-text-muted, #64748b);
    margin-top: 0.125rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.score-badge-modern.high {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.15));
    border-color: rgba(16, 185, 129, 0.2);
}

.score-badge-modern.high .score-number-modern {
    color: var(--at-success, #10b981);
}

.score-badge-modern.low {
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(249, 115, 22, 0.15));
    border-color: rgba(249, 115, 22, 0.2);
}

.score-badge-modern.low .score-number-modern {
    color: var(--at-warning, #f97316);
}

.metrics-preview {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
}

.metric-preview-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.metric-preview-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--at-text-muted, #64748b);
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.metric-preview-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--at-text-primary, #0f172a);
}

/* ========== Chart Card ========== */
.chart-card {
    background: var(--at-bg-card, #ffffff);
    border: 2px solid var(--at-border, #e2e8f0);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.chart-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--at-text-primary, #0f172a);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.chart-container {
    max-width: 700px;
    margin: 0 auto;
}

/* ========== Empty State ========== */
.empty-state-modern {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--at-bg-card, #ffffff);
    border: 2px dashed var(--at-border, #e2e8f0);
    border-radius: 16px;
}

.empty-icon-modern {
    font-size: 4rem;
    margin-bottom: 1.5rem;
    opacity: 0.3;
}

.empty-title-modern {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--at-text-primary, #0f172a);
    margin-bottom: 0.75rem;
}

.empty-desc-modern {
    font-size: 1rem;
    color: var(--at-text-muted, #64748b);
    margin-bottom: 2rem;
}

/* ========== Accordion Modern ========== */
.accordion-modern {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.accordion-item-modern {
    background: var(--at-bg-card, #ffffff);
    border: 2px solid var(--at-border, #e2e8f0);
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.2s;
}

.accordion-button-modern {
    width: 100%;
    padding: 1.25rem 1.5rem;
    background: transparent;
    border: none;
    text-align: left;
    font-weight: 600;
    font-size: 1rem;
    color: var(--at-text-primary, #0f172a);
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: all 0.2s;
}

.accordion-button-modern:hover {
    background: var(--at-bg-secondary, #f8fafc);
}

.accordion-button-modern .icon {
    transition: transform 0.2s;
}

.accordion-button-modern[aria-expanded="true"] .icon {
    transform: rotate(180deg);
}

.accordion-body-modern {
    padding: 1.5rem;
    border-top: 2px solid var(--at-border, #e2e8f0);
}

.metrics-grid-detail {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

.metric-detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.metric-detail-label {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--at-text-muted, #64748b);
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.metric-detail-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--at-text-primary, #0f172a);
}

.metric-detail-comparison {
    font-size: 0.8125rem;
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.comparison-positive {
    color: var(--at-success, #10b981);
}

.comparison-negative {
    color: var(--at-danger, #ef4444);
}

/* ========== Progress Bar ========== */
.progress-bar-modern {
    width: 100%;
    height: 8px;
    background: var(--at-bg-secondary, #e2e8f0);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 0.5rem;
}

.progress-fill-modern {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease;
}

.progress-fill-modern.high {
    background: linear-gradient(90deg, var(--at-success, #10b981), var(--at-success-light, #34d399));
}

.progress-fill-modern.mid {
    background: linear-gradient(90deg, var(--at-primary, #3b82f6), var(--at-primary-light, #60a5fa));
}

.progress-fill-modern.low {
    background: linear-gradient(90deg, var(--at-warning, #f97316), var(--at-warning-light, #fb923c));
}

/* ========== Compare Mode ========== */
.compare-toggle-btn {
    position: fixed;
    bottom: 1rem;
    left: 2rem;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--at-primary), var(--at-primary-dark, #2563eb));
    color: white;
    border: none;
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    transition: all 0.3s;
    z-index: 90;
}

.compare-toggle-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 12px 32px rgba(59, 130, 246, 0.4);
}

.compare-toggle-btn.active {
    background: linear-gradient(135deg, var(--at-success), #059669);
}

@media (max-width: 768px) {
    .compare-toggle-btn {
        bottom: 1rem;
        width: 56px;
        height: 56px;
        font-size: 1.375rem;
    }
}

.compare-mode-view {
    display: none;
}

.compare-mode-view.active {
    display: block;
}

.compare-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.compare-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--at-bg-card);
    border: 2px solid var(--at-border);
    border-radius: 12px;
    overflow: hidden;
}

.compare-table thead th {
    background: var(--at-bg-secondary);
    color: var(--at-text-primary);
    font-weight: 700;
    padding: 1rem;
    text-align: left;
    border-bottom: 2px solid var(--at-border);
    position: sticky;
    top: 0;
    z-index: 10;
}

.compare-table thead th:first-child {
    width: 180px;
    min-width: 180px;
}

.compare-table tbody td {
    padding: 1rem;
    border-bottom: 1px solid var(--at-border);
    color: var(--at-text-primary);
}

.compare-table tbody tr:hover {
    background: var(--at-bg-secondary);
}

.compare-table .metric-name {
    font-weight: 600;
    color: var(--at-text-secondary);
}

.compare-table .company-header {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.compare-table .company-name {
    font-size: 0.9375rem;
    font-weight: 700;
    color: var(--at-text-primary);
}

.compare-table .company-code {
    font-size: 0.8125rem;
    color: var(--at-primary);
    font-weight: 600;
}

.compare-table .metric-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--at-text-primary);
}

.compare-table .metric-value.best {
    color: var(--at-success);
}

.compare-table .metric-value.worst {
    color: var(--at-warning);
}

.compare-section-header {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
    padding: 0.75rem 1rem;
    font-weight: 700;
    color: var(--at-primary);
    border-bottom: 2px solid var(--at-primary);
}

/* ========== Dark Mode ========== */
.dark-mode .detail-header,
[data-theme="dark"] .detail-header {
    background: linear-gradient(135deg, #2563eb, #1e40af);
}

.dark-mode .stat-card,
.dark-mode .company-card-modern,
.dark-mode .chart-card,
.dark-mode .accordion-item-modern,
.dark-mode .empty-state-modern,
[data-theme="dark"] .stat-card,
[data-theme="dark"] .company-card-modern,
[data-theme="dark"] .chart-card,
[data-theme="dark"] .accordion-item-modern,
[data-theme="dark"] .empty-state-modern {
    background: var(--at-bg-card);
    border-color: var(--at-border);
}

.dark-mode .stat-card:hover,
.dark-mode .company-card-modern:hover,
[data-theme="dark"] .stat-card:hover,
[data-theme="dark"] .company-card-modern:hover {
    border-color: var(--at-primary);
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.2);
}

.dark-mode .stat-label,
.dark-mode .company-meta-modern,
.dark-mode .score-label-modern,
.dark-mode .metric-preview-label,
.dark-mode .metric-detail-label,
[data-theme="dark"] .stat-label,
[data-theme="dark"] .company-meta-modern,
[data-theme="dark"] .score-label-modern,
[data-theme="dark"] .metric-preview-label,
[data-theme="dark"] .metric-detail-label {
    color: var(--at-text-secondary);
}

.dark-mode .stat-value,
.dark-mode .company-name-modern,
.dark-mode .metric-preview-value,
.dark-mode .metric-detail-value,
.dark-mode .chart-title,
.dark-mode .empty-title-modern,
.dark-mode .accordion-button-modern,
[data-theme="dark"] .stat-value,
[data-theme="dark"] .company-name-modern,
[data-theme="dark"] .metric-preview-value,
[data-theme="dark"] .metric-detail-value,
[data-theme="dark"] .chart-title,
[data-theme="dark"] .empty-title-modern,
[data-theme="dark"] .accordion-button-modern {
    color: var(--at-text-primary);
}

.dark-mode .empty-desc-modern,
[data-theme="dark"] .empty-desc-modern {
    color: var(--at-text-muted);
}

.dark-mode .modern-tabs,
[data-theme="dark"] .modern-tabs {
    background: var(--at-bg-secondary);
    border-color: var(--at-border);
}

.dark-mode .modern-tab,
[data-theme="dark"] .modern-tab {
    color: var(--at-text-secondary);
}

.dark-mode .modern-tab:hover,
[data-theme="dark"] .modern-tab:hover {
    background: rgba(59, 130, 246, 0.1);
    color: var(--at-primary);
}

.dark-mode .modern-tab.active,
[data-theme="dark"] .modern-tab.active {
    background: var(--at-bg-card);
    color: var(--at-primary);
}

.dark-mode .accordion-button-modern:hover,
[data-theme="dark"] .accordion-button-modern:hover {
    background: var(--at-bg-secondary);
}

.dark-mode .accordion-body-modern,
[data-theme="dark"] .accordion-body-modern {
    border-top-color: var(--at-border);
}

.dark-mode .stat-icon.primary,
[data-theme="dark"] .stat-icon.primary {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.25));
}

.dark-mode .stat-icon.success,
[data-theme="dark"] .stat-icon.success {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.25));
}

.dark-mode .stat-icon.warning,
[data-theme="dark"] .stat-icon.warning {
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(249, 115, 22, 0.25));
}

.dark-mode .score-badge-modern,
[data-theme="dark"] .score-badge-modern {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.2));
    border-color: rgba(59, 130, 246, 0.3);
}

.dark-mode .score-badge-modern.high,
[data-theme="dark"] .score-badge-modern.high {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.2));
    border-color: rgba(16, 185, 129, 0.3);
}

.dark-mode .score-badge-modern.low,
[data-theme="dark"] .score-badge-modern.low {
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(249, 115, 22, 0.2));
    border-color: rgba(249, 115, 22, 0.3);
}

.dark-mode .compare-toggle-btn,
[data-theme="dark"] .compare-toggle-btn {
    background: linear-gradient(135deg, #2563eb, #1e40af);
}

.dark-mode .compare-toggle-btn.active,
[data-theme="dark"] .compare-toggle-btn.active {
    background: linear-gradient(135deg, var(--at-success), #059669);
}

.dark-mode .compare-table,
[data-theme="dark"] .compare-table {
    background: var(--at-bg-card);
    border-color: var(--at-border);
}

.dark-mode .compare-table thead th,
[data-theme="dark"] .compare-table thead th {
    background: var(--at-bg-secondary);
    border-bottom-color: var(--at-border);
}

.dark-mode .compare-table tbody tr:hover,
[data-theme="dark"] .compare-table tbody tr:hover {
    background: var(--at-bg-secondary);
}

.dark-mode .compare-section-header,
[data-theme="dark"] .compare-section-header {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15));
}

/* ========== Responsive ========== */
@media (max-width: 768px) {
    .detail-header {
        padding: 1.5rem 0;
        margin-bottom: 1.5rem;
        border-radius: 0 0 16px 16px;
    }

    .detail-title {
        font-size: 1.5rem;
    }

    .detail-header-actions {
        width: 100%;
        justify-content: stretch;
    }

    .header-action-btn {
        flex: 1;
        justify-content: center;
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .chart-card {
        padding: 1.5rem;
    }

    .company-card-modern {
        padding: 1.25rem;
    }

    .score-badge-modern {
        width: 56px;
        height: 56px;
    }

    .score-number-modern {
        font-size: 1.25rem;
    }

    .accordion-body-modern {
        padding: 1.25rem;
    }
}

@media (max-width: 640px) {
    .modern-tabs {
        flex-direction: column;
        gap: 0.375rem;
    }

    .modern-tab {
        width: 100%;
    }

    .company-name-modern {
        font-size: 1rem;
    }

    .metric-preview-value {
        font-size: 1rem;
    }

    .metric-detail-value {
        font-size: 1.25rem;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<header class="detail-header">
    <div class="detail-header-content">
        <div class="detail-header-info">
            <h1 class="detail-title">
                <i class="bi bi-file-earmark-bar-graph"></i>
                {{ template.name }}
            </h1>
            <p class="detail-subtitle">{{ template.description|default:"ä¼æ¥­åˆ†æãƒ¬ãƒãƒ¼ãƒˆ" }}</p>
        </div>
        <div class="detail-header-actions">
            <a href="{% url 'analysis_template:company_select' template.pk %}" class="header-action-btn">
                <i class="bi bi-building-add"></i>
                <span class="d-none d-sm-inline">ä¼æ¥­</span>
            </a>
            <a href="{% url 'analysis_template:metrics_input' template.pk %}" class="header-action-btn">
                <i class="bi bi-bar-chart-line"></i>
                <span class="d-none d-sm-inline">æŒ‡æ¨™</span>
            </a>
            <a href="{% url 'analysis_template:update' template.pk %}" class="header-action-btn">
                <i class="bi bi-pencil"></i>
                <span class="d-none d-sm-inline">ç·¨é›†</span>
            </a>
        </div>
    </div>
</header>

<div class="at-container">
    <!-- Stats Cards -->
    <div class="stats-grid" id="statsGrid">
        <!-- JavaScript ã§ç”Ÿæˆ -->
    </div>

    <!-- Tabs -->
    <div class="modern-tabs" role="tablist">
        <button class="modern-tab active" data-tab="overview" onclick="switchTab('overview')">
            <i class="bi bi-grid-3x2"></i>
            <span>æ¦‚è¦</span>
        </button>
        <button class="modern-tab" data-tab="chart" onclick="switchTab('chart')">
            <i class="bi bi-radar"></i>
            <span>ãƒãƒ£ãƒ¼ãƒˆ</span>
        </button>
        <button class="modern-tab" data-tab="details" onclick="switchTab('details')">
            <i class="bi bi-list-ul"></i>
            <span>è©³ç´°</span>
        </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content-modern">
        <!-- Overview Tab -->
        <div class="tab-pane-modern active" id="tab-overview">
            <!-- ã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ -->
            <div class="company-grid" id="companyGrid">
                <!-- JavaScript ã§ç”Ÿæˆ -->
            </div>

            <!-- æ¯”è¼ƒãƒ“ãƒ¥ãƒ¼ -->
            <div class="compare-mode-view" id="compareView">
                <div class="compare-table-wrapper">
                    <table class="compare-table" id="compareTable">
                        <!-- JavaScript ã§ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
        </div>

        <!-- Chart Tab -->
        <div class="tab-pane-modern" id="tab-chart" style="display: none;">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="bi bi-radar"></i>
                        8æŒ‡æ¨™ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆæ¯”è¼ƒ
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Details Tab -->
        <div class="tab-pane-modern" id="tab-details" style="display: none;">
            <div class="accordion-modern" id="detailsAccordion">
                <!-- JavaScript ã§ç”Ÿæˆ -->
            </div>
        </div>
    </div>
</div>

<!-- æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³ -->
<button class="compare-toggle-btn" id="compareToggleBtn" onclick="toggleCompareMode()" title="æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">
    <i class="bi bi-arrow-left-right"></i>
</button>

{% include 'speed_dial.html' with actions=form_actions %}
<script>
const companiesData = {{ companies_data|safe }};
const benchmarksData = {{ benchmarks_data|safe }};
const templateId = {{ template.pk }};
let compareMode = false;

// ========== Tab Switching ==========
function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.modern-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabName) {
            tab.classList.add('active');
        }
    });

    // Update tab content
    document.querySelectorAll('.tab-pane-modern').forEach(pane => {
        pane.style.display = 'none';
    });
    document.getElementById(`tab-${tabName}`).style.display = 'block';

    // Initialize chart if switching to chart tab
    if (tabName === 'chart' && !window.chartInitialized) {
        generateRadarChart();
        window.chartInitialized = true;
    }
}

// ========== Utilities ==========
function formatNumber(num, decimals = 2) {
    if (num === null || num === undefined || isNaN(num)) return '-';
    return Number(num).toFixed(decimals);
}

// ========== Score Calculation ==========
function calculateScore(company) {
    const metrics = ['roe', 'roa', 'operating_margin', 'per', 'pbr', 'dividend_yield', 'equity_ratio'];
    let total = 0;
    let count = 0;

    metrics.forEach(key => {
        const value = company.metrics[key];
        if (value != null && !isNaN(value)) {
            // Simple normalization (can be enhanced)
            const normalized = Math.min(100, Math.max(0, Number(value) * 5));
            total += normalized;
            count++;
        }
    });

    return count > 0 ? Math.round(total / count) : 50;
}

// ========== Generate Stats Cards ==========
function generateStatsCards() {
    const container = document.getElementById('statsGrid');

    const companyCount = companiesData.length;
    const avgScore = companyCount > 0
        ? Math.round(companiesData.reduce((sum, c) => sum + calculateScore(c), 0) / companyCount)
        : 0;
    const highScore = companyCount > 0
        ? Math.max(...companiesData.map(c => calculateScore(c)))
        : 0;

    container.innerHTML = `
        <div class="stat-card">
            <div class="stat-icon primary">
                <i class="bi bi-building"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">ç™»éŒ²ä¼æ¥­æ•°</div>
                <div class="stat-value">${companyCount}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon success">
                <i class="bi bi-graph-up-arrow"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">å¹³å‡ã‚¹ã‚³ã‚¢</div>
                <div class="stat-value">${avgScore}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon warning">
                <i class="bi bi-trophy"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">æœ€é«˜ã‚¹ã‚³ã‚¢</div>
                <div class="stat-value">${highScore}</div>
            </div>
        </div>
    `;
}

// ========== Generate Company Cards ==========
function generateCompanyCards() {
    const container = document.getElementById('companyGrid');

    if (!companiesData.length) {
        container.innerHTML = `
            <div class="empty-state-modern" style="grid-column: 1/-1;">
                <div class="empty-icon-modern">ğŸ“Š</div>
                <h3 class="empty-title-modern">ä¼æ¥­ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</h3>
                <p class="empty-desc-modern">åˆ†æå¯¾è±¡ã®ä¼æ¥­ã‚’è¿½åŠ ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</p>
                <a href="{% url 'analysis_template:company_select' template.pk %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>ä¼æ¥­ã‚’è¿½åŠ 
                </a>
            </div>
        `;
        return;
    }

    container.innerHTML = '';

    companiesData.forEach(company => {
        const score = calculateScore(company);
        const scoreClass = score >= 70 ? 'high' : score >= 50 ? 'mid' : 'low';

        const card = document.createElement('div');
        card.className = `company-card-modern ${score >= 70 ? 'high-score' : ''}`;
        card.innerHTML = `
            <div class="company-header-modern">
                <div class="company-info-modern">
                    <div class="company-name-modern">${company.name}</div>
                    <div class="company-meta-modern">
                        <span>${company.code}</span>
                        ${company.industry_name_33 ? `<span>Â·</span><span>${company.industry_name_33}</span>` : ''}
                    </div>
                </div>
                <div class="score-badge-modern ${scoreClass}">
                    <div class="score-number-modern">${score}</div>
                    <div class="score-label-modern">Score</div>
                </div>
            </div>
            <div class="metrics-preview">
                <div class="metric-preview-item">
                    <div class="metric-preview-label">ROE</div>
                    <div class="metric-preview-value">${formatNumber(company.metrics.roe, 1)}%</div>
                </div>
                <div class="metric-preview-item">
                    <div class="metric-preview-label">ROA</div>
                    <div class="metric-preview-value">${formatNumber(company.metrics.roa, 1)}%</div>
                </div>
                <div class="metric-preview-item">
                    <div class="metric-preview-label">PER</div>
                    <div class="metric-preview-value">${formatNumber(company.metrics.per, 1)}x</div>
                </div>
                <div class="metric-preview-item">
                    <div class="metric-preview-label">é…å½“</div>
                    <div class="metric-preview-value">${formatNumber(company.metrics.dividend_yield, 1)}%</div>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

// ========== Generate Details Accordion ==========
function generateDetailsAccordion() {
    const container = document.getElementById('detailsAccordion');

    if (!companiesData.length) {
        container.innerHTML = `
            <div class="empty-state-modern">
                <div class="empty-icon-modern">ğŸ“‹</div>
                <p class="empty-desc-modern">ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        `;
        return;
    }

    container.innerHTML = '';

    companiesData.forEach((company, i) => {
        const item = document.createElement('div');
        item.className = 'accordion-item-modern';
        item.innerHTML = `
            <button class="accordion-button-modern"
                    onclick="toggleAccordion(this)"
                    aria-expanded="false">
                <span>${company.name} <small style="opacity: 0.6;">${company.code}</small></span>
                <i class="bi bi-chevron-down icon"></i>
            </button>
            <div class="accordion-body-modern" style="display: none;">
                <div class="metrics-grid-detail">
                    <div class="metric-detail-item">
                        <div class="metric-detail-label">
                            <i class="bi bi-graph-up"></i>
                            ROE
                        </div>
                        <div class="metric-detail-value">${formatNumber(company.metrics.roe, 1)}%</div>
                    </div>
                    <div class="metric-detail-item">
                        <div class="metric-detail-label">
                            <i class="bi bi-graph-up"></i>
                            ROA
                        </div>
                        <div class="metric-detail-value">${formatNumber(company.metrics.roa, 1)}%</div>
                    </div>
                    <div class="metric-detail-item">
                        <div class="metric-detail-label">
                            <i class="bi bi-percent"></i>
                            å–¶æ¥­åˆ©ç›Šç‡
                        </div>
                        <div class="metric-detail-value">${formatNumber(company.metrics.operating_margin, 1)}%</div>
                    </div>
                    <div class="metric-detail-item">
                        <div class="metric-detail-label">
                            <i class="bi bi-tag"></i>
                            PER
                        </div>
                        <div class="metric-detail-value">${formatNumber(company.metrics.per, 1)}x</div>
                    </div>
                    <div class="metric-detail-item">
                        <div class="metric-detail-label">
                            <i class="bi bi-tag"></i>
                            PBR
                        </div>
                        <div class="metric-detail-value">${formatNumber(company.metrics.pbr, 2)}x</div>
                    </div>
                    <div class="metric-detail-item">
                        <div class="metric-detail-label">
                            <i class="bi bi-cash-coin"></i>
                            é…å½“åˆ©å›ã‚Š
                        </div>
                        <div class="metric-detail-value">${formatNumber(company.metrics.dividend_yield, 1)}%</div>
                    </div>
                    <div class="metric-detail-item">
                        <div class="metric-detail-label">
                            <i class="bi bi-shield-check"></i>
                            è‡ªå·±è³‡æœ¬æ¯”ç‡
                        </div>
                        <div class="metric-detail-value">${formatNumber(company.metrics.equity_ratio, 1)}%</div>
                    </div>
                    <div class="metric-detail-item">
                        <div class="metric-detail-label">
                            <i class="bi bi-arrow-up-right"></i>
                            å£²ä¸Šæˆé•·ç‡
                        </div>
                        <div class="metric-detail-value">${formatNumber(company.metrics.revenue_growth, 1)}%</div>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(item);
    });
}

function toggleAccordion(button) {
    const body = button.nextElementSibling;
    const isExpanded = button.getAttribute('aria-expanded') === 'true';

    button.setAttribute('aria-expanded', !isExpanded);
    body.style.display = isExpanded ? 'none' : 'block';
}

// ========== Generate Radar Chart ==========
function generateRadarChart() {
    const ctx = document.getElementById('radarChart');

    if (!companiesData.length) {
        ctx.parentElement.innerHTML = `
            <div class="empty-state-modern">
                <div class="empty-icon-modern">ğŸ“Š</div>
                <p class="empty-desc-modern">ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤ºã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        `;
        return;
    }

    const colors = [
        { bg: 'rgba(59, 130, 246, 0.2)', border: 'rgb(59, 130, 246)' },
        { bg: 'rgba(16, 185, 129, 0.2)', border: 'rgb(16, 185, 129)' },
        { bg: 'rgba(249, 115, 22, 0.2)', border: 'rgb(249, 115, 22)' },
        { bg: 'rgba(168, 85, 247, 0.2)', border: 'rgb(168, 85, 247)' },
        { bg: 'rgba(236, 72, 153, 0.2)', border: 'rgb(236, 72, 153)' }
    ];

    const datasets = companiesData.map((company, i) => {
        const color = colors[i % colors.length];
        return {
            label: company.name,
            data: [
                company.metrics.roe || 0,
                company.metrics.roa || 0,
                company.metrics.operating_margin || 0,
                company.metrics.revenue_growth || 0,
                company.metrics.profit_growth || 0,
                company.metrics.equity_ratio || 0,
                company.metrics.dividend_yield || 0,
                company.metrics.pbr ? Math.min(5, company.metrics.pbr) : 0
            ],
            backgroundColor: color.bg,
            borderColor: color.border,
            borderWidth: 2,
            pointBackgroundColor: color.border,
            pointBorderColor: '#fff',
            pointRadius: 4,
            pointHoverRadius: 6
        };
    });

    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
    const isDark = document.body.classList.contains('dark-mode') ||
                   document.documentElement.getAttribute('data-theme') === 'dark';

    const chartColors = isDark ? {
        grid: 'rgba(148, 163, 184, 0.3)',
        tick: '#e2e8f0',
        label: '#f8fafc'
    } : {
        grid: 'rgba(100, 116, 139, 0.2)',
        tick: '#475569',
        label: '#0f172a'
    };

    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['ROE', 'ROA', 'å–¶æ¥­åˆ©ç›Šç‡', 'å£²ä¸Šæˆé•·', 'åˆ©ç›Šæˆé•·', 'è‡ªå·±è³‡æœ¬æ¯”ç‡', 'é…å½“åˆ©å›ã‚Š', 'PBR'],
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                r: {
                    beginAtZero: true,
                    ticks: {
                        font: { size: 11, weight: '500' },
                        color: chartColors.tick
                    },
                    pointLabels: {
                        font: { size: 12, weight: '600' },
                        color: chartColors.label
                    },
                    grid: { color: chartColors.grid },
                    angleLines: { color: chartColors.grid }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 16,
                        font: { size: 12, weight: '500' },
                        color: chartColors.label,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

// ========== Compare Mode ==========
function toggleCompareMode() {
    compareMode = !compareMode;
    const btn = document.getElementById('compareToggleBtn');
    const cardView = document.getElementById('companyGrid');
    const compareView = document.getElementById('compareView');

    if (compareMode) {
        btn.classList.add('active');
        btn.innerHTML = '<i class="bi bi-grid-3x2"></i>';
        btn.title = 'ã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼';
        cardView.style.display = 'none';
        compareView.classList.add('active');
        generateCompareTable();
    } else {
        btn.classList.remove('active');
        btn.innerHTML = '<i class="bi bi-arrow-left-right"></i>';
        btn.title = 'æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿';
        cardView.style.display = 'grid';
        compareView.classList.remove('active');
    }
}

function generateCompareTable() {
    const table = document.getElementById('compareTable');

    if (!companiesData.length) {
        table.innerHTML = '<tbody><tr><td colspan="100%" class="text-center text-muted">ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr></tbody>';
        return;
    }

    // ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—å®šç¾©
    const metricsGroups = {
        'åç›Šæ€§': ['roe', 'roa', 'operating_margin'],
        'æˆé•·æ€§': ['revenue_growth', 'profit_growth'],
        'å®‰å…¨æ€§': ['equity_ratio', 'current_ratio'],
        'ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³': ['per', 'pbr', 'dividend_yield']
    };

    const metricLabels = {
        'roe': 'ROE',
        'roa': 'ROA',
        'operating_margin': 'å–¶æ¥­åˆ©ç›Šç‡',
        'revenue_growth': 'å£²ä¸Šæˆé•·ç‡',
        'profit_growth': 'åˆ©ç›Šæˆé•·ç‡',
        'equity_ratio': 'è‡ªå·±è³‡æœ¬æ¯”ç‡',
        'current_ratio': 'æµå‹•æ¯”ç‡',
        'per': 'PER',
        'pbr': 'PBR',
        'dividend_yield': 'é…å½“åˆ©å›ã‚Š'
    };

    // ãƒ˜ãƒƒãƒ€ãƒ¼ç”Ÿæˆ
    let headerHTML = '<thead><tr><th>æŒ‡æ¨™</th>';
    companiesData.forEach(company => {
        headerHTML += `
            <th>
                <div class="company-header">
                    <div class="company-name">${company.name}</div>
                    <div class="company-code">${company.code}</div>
                </div>
            </th>
        `;
    });
    headerHTML += '</tr></thead>';

    // ãƒœãƒ‡ã‚£ç”Ÿæˆ
    let bodyHTML = '<tbody>';
    Object.entries(metricsGroups).forEach(([groupName, metrics]) => {
        bodyHTML += `<tr><td colspan="${companiesData.length + 1}" class="compare-section-header">${groupName}</td></tr>`;

        metrics.forEach(metric => {
            bodyHTML += `<tr><td class="metric-name">${metricLabels[metric]}</td>`;

            // å„ä¼æ¥­ã®å€¤ã‚’å–å¾—
            const values = companiesData.map(c => c.metrics[metric] || null);
            const numericValues = values.filter(v => v !== null && !isNaN(v));
            const max = numericValues.length > 0 ? Math.max(...numericValues) : null;
            const min = numericValues.length > 0 ? Math.min(...numericValues) : null;

            companiesData.forEach((company, i) => {
                const value = company.metrics[metric];
                let className = 'metric-value';

                // é«˜ã„æ–¹ãŒè‰¯ã„æŒ‡æ¨™
                const higherIsBetter = !['per', 'pbr'].includes(metric);

                if (value !== null && !isNaN(value) && numericValues.length > 1) {
                    if (higherIsBetter) {
                        if (value === max) className += ' best';
                        if (value === min) className += ' worst';
                    } else {
                        if (value === min) className += ' best';
                        if (value === max) className += ' worst';
                    }
                }

                const displayValue = value !== null && !isNaN(value) ? formatNumber(value, 1) : '-';
                const unit = ['per', 'pbr'].includes(metric) ? 'x' : '%';

                bodyHTML += `<td><span class="${className}">${displayValue}${value !== null && !isNaN(value) ? unit : ''}</span></td>`;
            });

            bodyHTML += '</tr>';
        });
    });
    bodyHTML += '</tbody>';

    table.innerHTML = headerHTML + bodyHTML;
}

// ========== Initialize ==========
document.addEventListener('DOMContentLoaded', () => {
    generateStatsCards();
    generateCompanyCards();
    generateDetailsAccordion();
    // Chart will be initialized when tab is clicked
});
</script>
{% endblock %}
