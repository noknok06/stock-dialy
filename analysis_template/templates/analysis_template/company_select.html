{% extends 'base.html' %}
{% load static %}

{% block title %}企業選択 - {{ template.name }} - カブログ{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/2-layouts/analysis-template.css' %}">
<style>
/* モバイル用追加スタイル */
@media (max-width: 767px) {
    .company-table-mobile {
        display: block;
    }
    
    .company-table-mobile thead {
        display: none;
    }
    
    .company-table-mobile tbody,
    .company-table-mobile tr {
        display: block;
    }
    
    .company-table-mobile tr {
        background: var(--at-bg-card, #ffffff);
        border: 1px solid var(--at-border, #e2e8f0);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        position: relative;
    }
    
    .company-table-mobile tr.table-active {
        border-color: var(--at-primary, #3b82f6);
        background: rgba(59, 130, 246, 0.05);
    }
    
    .company-table-mobile td {
        display: block;
        padding: 0.5rem 0;
        border: none;
    }
    
    .company-table-mobile td:first-child {
        position: absolute;
        top: 1rem;
        right: 1rem;
    }
    
    .company-table-mobile .fw-medium {
        font-size: 1.125rem;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .company-checkbox-cell {
        padding: 0 !important;
    }
}

.sticky-actions {
    position: sticky;
    bottom: 0;
    background: var(--at-bg-card, #ffffff);
    border-top: 2px solid var(--at-border, #e2e8f0);
    padding: 1rem;
    margin: 0 -1rem -1rem;
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
    z-index: 10;
}

@media (min-width: 768px) {
    .sticky-actions {
        position: static;
        box-shadow: none;
        margin: 1rem 0 0;
        padding: 0;
        border: none;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="at-container">
    <!-- ヘッダー -->
    <div class="page-header mb-3 mb-md-4">
        <h1 class="page-title">
            <i class="bi bi-building"></i>
            <span>企業選択</span>
        </h1>
        <p class="page-subtitle">{{ template.name }}</p>
    </div>

    <div class="row g-3 g-md-4">
        <!-- 左: 企業検索・選択 -->
        <div class="col-lg-8">
            <!-- 検索フォーム -->
            <div class="at-card mb-3">
                <form method="get" id="searchForm">
                    <div class="row g-2">
                        <div class="col-12">
                            {{ search_form.query }}
                        </div>
                        <div class="col-6">
                            {{ search_form.industry }}
                        </div>
                        <div class="col-6">
                            {{ search_form.market }}
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-3">
                        <button type="submit" class="btn btn-primary btn-sm flex-fill" onclick="saveBeforeSearch()">
                            <i class="bi bi-search me-1"></i>検索
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm flex-fill" onclick="resetSearch()">
                            <i class="bi bi-arrow-clockwise me-1"></i>リセット
                        </button>
                    </div>
                </form>
            </div>

            <!-- 一括選択バー -->
            <div class="at-card mb-3">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div class="d-flex align-items-center gap-2">
                        <span class="fw-semibold">選択中:</span>
                        <span class="badge bg-primary" id="selectionCount" style="font-size: 1rem; padding: 0.375rem 0.75rem;">0</span>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="selectAllOnPage()">
                            <i class="bi bi-check-square me-1"></i>
                            <span class="d-none d-sm-inline">ページ全選択</span>
                            <span class="d-sm-none">全選択</span>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearAllSelections()">
                            <i class="bi bi-x-circle me-1"></i>クリア
                        </button>
                    </div>
                </div>
            </div>

            <!-- 企業リスト -->
            <div class="at-card">
                <form method="post" id="companySelectForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" id="actionInput" value="add">
                    <div id="hiddenInputsContainer"></div>
                    
                    <div class="at-table-wrapper">
                        <table class="at-table company-table-mobile">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>コード</th>
                                    <th>銘柄名</th>
                                    <th class="d-none d-md-table-cell">業種</th>
                                    <th class="d-none d-lg-table-cell">市場</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for company in page_obj %}
                                <tr class="company-row" data-company-code="{{ company.code }}">
                                    <td class="company-checkbox-cell">
                                        <input type="checkbox" 
                                               value="{{ company.code }}"
                                               class="at-checkbox company-checkbox"
                                               data-company-code="{{ company.code }}"
                                               data-company-name="{{ company.name }}">
                                    </td>
                                    <td>
                                        <span class="fw-medium">{{ company.code }}</span>
                                        <span class="selected-badge badge bg-success ms-1 d-none">✓</span>
                                    </td>
                                    <td>
                                        <strong>{{ company.name }}</strong>
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        <small class="at-text-muted">{{ company.industry_name_33|default:"-" }}</small>
                                    </td>
                                    <td class="d-none d-lg-table-cell">
                                        <small class="at-text-muted">{{ company.market|default:"-" }}</small>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center at-text-muted py-4">
                                        該当する企業が見つかりませんでした
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- ページネーション -->
                    {% if page_obj.has_other_pages %}
                    <nav class="mt-3">
                        <ul class="pagination pagination-sm justify-content-center mb-0">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.query %}&query={{ request.GET.query }}{% endif %}{% if request.GET.industry %}&industry={{ request.GET.industry }}{% endif %}{% if request.GET.market %}&market={{ request.GET.market }}{% endif %}" onclick="saveBeforeNavigate(event)">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
                            </li>
                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.query %}&query={{ request.GET.query }}{% endif %}{% if request.GET.industry %}&industry={{ request.GET.industry }}{% endif %}{% if request.GET.market %}&market={{ request.GET.market }}{% endif %}" onclick="saveBeforeNavigate(event)">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}

                    <!-- アクションボタン -->
                    <div class="sticky-actions">
                        <div class="d-grid gap-2">
                            <div class="row g-2">
                                <div class="col-6 col-sm-4">
                                    <a href="{% url 'analysis_template:detail' template.pk %}" class="btn btn-secondary w-100">
                                        <i class="bi bi-x-circle me-1"></i>
                                        <span class="d-none d-sm-inline">キャンセル</span>
                                        <span class="d-sm-none">戻る</span>
                                    </a>
                                </div>
                                <div class="col-6 col-sm-4">
                                    <button type="button" class="btn btn-success w-100" onclick="submitForm('add')">
                                        <i class="bi bi-plus-circle me-1"></i>追加
                                    </button>
                                </div>
                                <div class="col-12 col-sm-4">
                                    <button type="button" class="btn btn-primary w-100" onclick="submitForm('replace')">
                                        <i class="bi bi-arrow-repeat me-1"></i>
                                        <span class="d-none d-sm-inline">置き換え</span>
                                        <span class="d-sm-none">置換</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 右: 選択済み企業 -->
        <div class="col-lg-4">
            <div class="at-card sticky-lg-top" style="top: 1rem;">
                <h6 class="at-card-title mb-3">
                    <i class="bi bi-check-circle me-1"></i>選択済み企業
                    <span class="badge bg-primary ms-2" id="selectedCount2">0</span>
                </h6>
                <div id="selectedCompaniesList" style="max-height: 300px; overflow-y: auto;">
                    <div class="text-center at-text-muted py-4" id="emptyState">
                        <i class="bi bi-inbox" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p class="mb-0 mt-2 small">企業が選択されていません</p>
                    </div>
                </div>
            </div>
            
            <!-- 使い方 -->
            <div class="at-card mt-3 d-none d-lg-block">
                <h6 class="at-card-title">
                    <i class="bi bi-info-circle me-1"></i>使い方
                </h6>
                <ol class="small mb-0 ps-3">
                    <li class="mb-2">企業を検索してチェック</li>
                    <li class="mb-2">検索条件を変えて追加選択可</li>
                    <li class="mb-2">「追加」または「置き換え」</li>
                </ol>
                <hr class="my-3">
                <div class="small">
                    <p class="mb-1"><strong>追加:</strong> 既存+新規</p>
                    <p class="mb-0"><strong>置き換え:</strong> 既存削除</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'speed_dial.html' with actions=form_actions %}
<script>
const templateId = {{ template.pk }};
const storageKey = `template_${templateId}_selected_companies`;

const existingCompanies = {
    {% for company in selected_companies %}
    '{{ company.code }}': { code: '{{ company.code }}', name: '{{ company.name|escapejs }}' }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

let selectedCompanies = {};

document.addEventListener('DOMContentLoaded', function() {
    loadSelections();
    setupEventListeners();
    updateUI();
});

function loadSelections() {
    const saved = sessionStorage.getItem(storageKey);
    if (saved) {
        try {
            selectedCompanies = JSON.parse(saved);
        } catch (e) {
            selectedCompanies = {};
        }
    } else if (Object.keys(existingCompanies).length > 0) {
        selectedCompanies = { ...existingCompanies };
        saveSelections();
    }
}

function saveSelections() {
    sessionStorage.setItem(storageKey, JSON.stringify(selectedCompanies));
}

function setupEventListeners() {
    document.querySelectorAll('.company-checkbox').forEach(cb => {
        cb.addEventListener('change', function(e) {
            e.stopPropagation();
            const code = this.value;
            const name = this.dataset.companyName;
            
            if (this.checked) {
                selectedCompanies[code] = { code, name };
            } else {
                delete selectedCompanies[code];
            }
            
            saveSelections();
            updateUI();
        });
    });
}

function updateUI() {
    document.querySelectorAll('.company-checkbox').forEach(cb => {
        const code = cb.value;
        const isSelected = selectedCompanies.hasOwnProperty(code);
        cb.checked = isSelected;
        
        const row = cb.closest('tr');
        if (row) {
            row.classList.toggle('table-active', isSelected);
            const badge = row.querySelector('.selected-badge');
            if (badge) badge.classList.toggle('d-none', !isSelected);
        }
    });
    
    const count = Object.keys(selectedCompanies).length;
    document.querySelectorAll('#selectionCount, #selectedCount2').forEach(el => el.textContent = count);
    
    const container = document.getElementById('selectedCompaniesList');
    const emptyState = document.getElementById('emptyState');
    
    if (count === 0) {
        emptyState.classList.remove('d-none');
        container.querySelectorAll('.selected-company-item').forEach(item => item.remove());
        return;
    }
    
    emptyState.classList.add('d-none');
    container.querySelectorAll('.selected-company-item').forEach(item => item.remove());
    
    Object.values(selectedCompanies).sort((a, b) => a.code.localeCompare(b.code)).forEach(company => {
        const item = document.createElement('div');
        item.className = 'selected-company-item d-flex justify-content-between align-items-center py-2 border-bottom';
        item.innerHTML = `
            <div>
                <div class="fw-semibold small">${company.code}</div>
                <small class="at-text-muted">${company.name}</small>
            </div>
            <button type="button" class="btn btn-sm btn-link text-danger p-0" onclick="removeFromSelection('${company.code}')">
                <i class="bi bi-x-circle"></i>
            </button>
        `;
        container.appendChild(item);
    });
}

function removeFromSelection(code) {
    delete selectedCompanies[code];
    saveSelections();
    updateUI();
}

function clearAllSelections() {
    const count = Object.keys(selectedCompanies).length;
    if (!count) {
        alert('選択されている企業がありません');
        return;
    }
    if (confirm(`${count}社の選択をすべてクリアしますか？`)) {
        selectedCompanies = {};
        saveSelections();
        updateUI();
    }
}

function selectAllOnPage() {
    let added = 0;
    document.querySelectorAll('.company-checkbox').forEach(cb => {
        const code = cb.value;
        if (!selectedCompanies[code]) {
            selectedCompanies[code] = { code, name: cb.dataset.companyName };
            added++;
        }
    });
    
    if (added > 0) {
        saveSelections();
        updateUI();
    } else {
        alert('このページの企業はすべて選択済みです');
    }
}

function saveBeforeSearch() { saveSelections(); }
function saveBeforeNavigate(e) { saveSelections(); }

function resetSearch() {
    saveSelections();
    window.location.href = '{% url "analysis_template:company_select" template.pk %}';
}

function submitForm(action) {
    const count = Object.keys(selectedCompanies).length;
    if (!count) {
        alert('企業を選択してください');
        return;
    }
    
    const msg = action === 'add' 
        ? `${count}社を追加します。よろしいですか？`
        : `既存の企業を削除し、${count}社で置き換えます。よろしいですか？`;
    
    if (!confirm(msg)) return;
    
    document.getElementById('actionInput').value = action;
    
    const container = document.getElementById('hiddenInputsContainer');
    container.innerHTML = '';
    Object.keys(selectedCompanies).forEach(code => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'companies';
        input.value = code;
        container.appendChild(input);
    });
    
    sessionStorage.removeItem(storageKey);
    document.getElementById('companySelectForm').submit();
}
</script>
{% endblock %}