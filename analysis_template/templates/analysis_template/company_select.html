{% extends 'base.html' %}
{% load static %}

{% block title %}企業選択 - {{ template.name }} - カブログ{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/2-layouts/analysis-template.css' %}">

{% endblock %}

{% block content %}
<div class="at-container">
    <!-- ヘッダー -->
    <div class="at-page-header-mobile">
        <h1 class="at-page-title-mobile">
            <i class="bi bi-building"></i>
            企業選択
        </h1>
        <p class="at-page-subtitle-mobile">{{ template.name }}</p>
    </div>

    <div class="row g-3 g-md-4">
        <!-- 左: 企業検索・選択 -->
        <div class="col-lg-8">
            <!-- 検索フォーム -->
            <div class="at-card at-card--compact mb-3">
                <form method="get" id="searchForm">
                    <div class="at-search-row">
                        <div class="at-search-input-wrap">
                            {{ search_form.query }}
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm at-search-submit" onclick="saveBeforeSearch()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    <div class="at-filter-row">
                        <div class="at-filter-item">
                            {{ search_form.industry }}
                        </div>
                        <div class="at-filter-item">
                            {{ search_form.market }}
                        </div>
                        <button type="button" class="at-filter-reset" onclick="resetSearch()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- 一括選択バー -->
            <div class="at-selection-bar mb-3">
                <div class="at-selection-bar-left">
                    <span class="at-selection-label">選択</span>
                    <span class="at-selection-count-badge" id="selectionCount">0</span>
                </div>
                <div class="at-selection-bar-right">
                    <button type="button" class="at-chip-btn" onclick="selectAllOnPage()">
                        <i class="bi bi-check-square"></i>
                        全選択
                    </button>
                    <button type="button" class="at-chip-btn at-chip-btn--danger" onclick="clearAllSelections()">
                        <i class="bi bi-x-circle"></i>
                        クリア
                    </button>
                </div>
            </div>

            <!-- 企業リスト -->
            <div class="at-card">
                <form method="post" id="companySelectForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" id="actionInput" value="add">
                    <div id="hiddenInputsContainer"></div>
                    
                    <div class="at-table-wrapper">
                        <table class="at-table company-table-mobile">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>コード</th>
                                    <th>銘柄名</th>
                                    <th class="d-none d-md-table-cell">業種</th>
                                    <th class="d-none d-lg-table-cell">市場</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for company in page_obj %}
                                <tr class="company-row" data-company-code="{{ company.code }}">
                                    <td class="company-checkbox-cell">
                                        <input type="checkbox" 
                                               value="{{ company.code }}"
                                               class="at-checkbox company-checkbox"
                                               data-company-code="{{ company.code }}"
                                               data-company-name="{{ company.name }}">
                                    </td>
                                    <td>
                                        <span class="fw-medium">{{ company.code }}</span>
                                        <span class="selected-badge badge bg-success ms-1 d-none">✓</span>
                                    </td>
                                    <td>
                                        <strong>{{ company.name }}</strong>
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        <small class="at-text-muted">{{ company.industry_name_33|default:"-" }}</small>
                                    </td>
                                    <td class="d-none d-lg-table-cell">
                                        <small class="at-text-muted">{{ company.market|default:"-" }}</small>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center at-text-muted py-4">
                                        該当する企業が見つかりませんでした
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- ページネーション -->
                    {% if page_obj.has_other_pages %}
                    <nav class="mt-3">
                        <ul class="pagination pagination-sm justify-content-center mb-0">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.query %}&query={{ request.GET.query }}{% endif %}{% if request.GET.industry %}&industry={{ request.GET.industry }}{% endif %}{% if request.GET.market %}&market={{ request.GET.market }}{% endif %}" onclick="saveBeforeNavigate(event)">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
                            </li>
                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.query %}&query={{ request.GET.query }}{% endif %}{% if request.GET.industry %}&industry={{ request.GET.industry }}{% endif %}{% if request.GET.market %}&market={{ request.GET.market }}{% endif %}" onclick="saveBeforeNavigate(event)">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}

                    <!-- 固定ボトムバー -->
                    <div class="at-fixed-bottom-bar at-fixed-bottom-bar--triple">
                        <a href="{% url 'analysis_template:detail' template.pk %}" class="btn btn-secondary at-fixed-btn">
                            <i class="bi bi-arrow-left"></i>
                            <span>戻る</span>
                        </a>
                        <button type="button" class="btn btn-success at-fixed-btn" onclick="submitForm('add')">
                            <i class="bi bi-plus-circle"></i>
                            <span>追加</span>
                        </button>
                        <button type="button" class="btn btn-primary at-fixed-btn" onclick="submitForm('replace')">
                            <i class="bi bi-arrow-repeat"></i>
                            <span>置換</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 右: 選択済み企業（PC表示のみフル表示、モバイルは折りたたみ） -->
        <div class="col-lg-4">
            <div class="at-card at-selected-panel">
                <button class="at-selected-panel-toggle d-lg-none" type="button" onclick="toggleSelectedPanel(this)">
                    <span>
                        <i class="bi bi-check-circle me-1"></i>
                        選択済み <strong id="selectedCount2">0</strong> 社
                    </span>
                    <i class="bi bi-chevron-down at-toggle-icon"></i>
                </button>
                <h6 class="at-card-title mb-3 d-none d-lg-block">
                    <i class="bi bi-check-circle me-1"></i>選択済み企業
                    <span class="badge bg-primary ms-2" id="selectedCount3">0</span>
                </h6>
                <div id="selectedCompaniesList" class="at-selected-list" style="max-height: 300px; overflow-y: auto;">
                    <div class="text-center at-text-muted py-4" id="emptyState">
                        <i class="bi bi-inbox" style="font-size: 1.5rem; opacity: 0.5;"></i>
                        <p class="mb-0 mt-2 small">企業が選択されていません</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 固定ボトムバー分のスペーサー -->
<div style="height: 80px;"></div>

{% include 'speed_dial.html' with actions=form_actions %}
<script>
const templateId = {{ template.pk }};
const storageKey = `template_${templateId}_selected_companies`;

const existingCompanies = {
    {% for company in selected_companies %}
    '{{ company.code }}': { code: '{{ company.code }}', name: '{{ company.name|escapejs }}' }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

let selectedCompanies = {};

document.addEventListener('DOMContentLoaded', function() {
    loadSelections();
    setupEventListeners();
    updateUI();
});

function loadSelections() {
    const saved = sessionStorage.getItem(storageKey);
    if (saved) {
        try {
            selectedCompanies = JSON.parse(saved);
        } catch (e) {
            selectedCompanies = {};
        }
    } else if (Object.keys(existingCompanies).length > 0) {
        selectedCompanies = { ...existingCompanies };
        saveSelections();
    }
}

function saveSelections() {
    sessionStorage.setItem(storageKey, JSON.stringify(selectedCompanies));
}

function setupEventListeners() {
    document.querySelectorAll('.company-checkbox').forEach(cb => {
        cb.addEventListener('change', function(e) {
            e.stopPropagation();
            const code = this.value;
            const name = this.dataset.companyName;
            
            if (this.checked) {
                selectedCompanies[code] = { code, name };
            } else {
                delete selectedCompanies[code];
            }
            
            saveSelections();
            updateUI();
        });
    });
}

function updateUI() {
    document.querySelectorAll('.company-checkbox').forEach(cb => {
        const code = cb.value;
        const isSelected = selectedCompanies.hasOwnProperty(code);
        cb.checked = isSelected;
        
        const row = cb.closest('tr');
        if (row) {
            row.classList.toggle('table-active', isSelected);
            const badge = row.querySelector('.selected-badge');
            if (badge) badge.classList.toggle('d-none', !isSelected);
        }
    });
    
    const count = Object.keys(selectedCompanies).length;
    document.querySelectorAll('#selectionCount, #selectedCount2, #selectedCount3').forEach(el => el.textContent = count);
    
    const container = document.getElementById('selectedCompaniesList');
    const emptyState = document.getElementById('emptyState');
    
    if (count === 0) {
        emptyState.classList.remove('d-none');
        container.querySelectorAll('.selected-company-item').forEach(item => item.remove());
        return;
    }
    
    emptyState.classList.add('d-none');
    container.querySelectorAll('.selected-company-item').forEach(item => item.remove());
    
    Object.values(selectedCompanies).sort((a, b) => a.code.localeCompare(b.code)).forEach(company => {
        const item = document.createElement('div');
        item.className = 'selected-company-item d-flex justify-content-between align-items-center py-2 border-bottom';
        item.innerHTML = `
            <div>
                <div class="fw-semibold small">${company.code}</div>
                <small class="at-text-muted">${company.name}</small>
            </div>
            <button type="button" class="btn btn-sm btn-link text-danger p-0" onclick="removeFromSelection('${company.code}')">
                <i class="bi bi-x-circle"></i>
            </button>
        `;
        container.appendChild(item);
    });
}

function removeFromSelection(code) {
    delete selectedCompanies[code];
    saveSelections();
    updateUI();
}

function clearAllSelections() {
    const count = Object.keys(selectedCompanies).length;
    if (!count) {
        alert('選択されている企業がありません');
        return;
    }
    if (confirm(`${count}社の選択をすべてクリアしますか？`)) {
        selectedCompanies = {};
        saveSelections();
        updateUI();
    }
}

function selectAllOnPage() {
    let added = 0;
    document.querySelectorAll('.company-checkbox').forEach(cb => {
        const code = cb.value;
        if (!selectedCompanies[code]) {
            selectedCompanies[code] = { code, name: cb.dataset.companyName };
            added++;
        }
    });
    
    if (added > 0) {
        saveSelections();
        updateUI();
    } else {
        alert('このページの企業はすべて選択済みです');
    }
}

function saveBeforeSearch() { saveSelections(); }
function saveBeforeNavigate(e) { saveSelections(); }

function resetSearch() {
    saveSelections();
    window.location.href = '{% url "analysis_template:company_select" template.pk %}';
}

function toggleSelectedPanel(btn) {
    const list = document.getElementById('selectedCompaniesList');
    const icon = btn.querySelector('.at-toggle-icon');
    list.classList.toggle('at-selected-list--open');
    icon.classList.toggle('bi-chevron-down');
    icon.classList.toggle('bi-chevron-up');
}

function submitForm(action) {
    const count = Object.keys(selectedCompanies).length;
    if (!count) {
        alert('企業を選択してください');
        return;
    }
    
    const msg = action === 'add' 
        ? `${count}社を追加します。よろしいですか？`
        : `既存の企業を削除し、${count}社で置き換えます。よろしいですか？`;
    
    if (!confirm(msg)) return;
    
    document.getElementById('actionInput').value = action;
    
    const container = document.getElementById('hiddenInputsContainer');
    container.innerHTML = '';
    Object.keys(selectedCompanies).forEach(code => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'companies';
        input.value = code;
        container.appendChild(input);
    });
    
    sessionStorage.removeItem(storageKey);
    document.getElementById('companySelectForm').submit();
}
</script>
{% endblock %}
