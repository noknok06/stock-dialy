{% extends 'base.html' %}
{% load static %}

{% block title %}指標編集 - {{ template.name }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/2-layouts/analysis-template.css' %}?v={{ STATIC_VERSION }}">
{% endblock %}

{% block content %}
<div class="at-container">
    <div class="page-header mb-4">
        <h1 class="page-title">
            <i class="bi bi-bar-chart"></i>
            <span>指標編集</span>
        </h1>
        <p class="page-subtitle">{{ template.name }} の企業指標を入力・編集します</p>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="at-card mb-4">
                <div class="at-card-header">
                    <h5 class="at-card-title mb-0">
                        <i class="bi bi-pencil-square me-2"></i>指標入力
                    </h5>
                </div>
                
                <form method="post" id="metrics-form">
                    {% csrf_token %}
                    
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label for="{{ form.company.id_for_label }}" class="at-form-label">
                                企業 <span class="text-danger">*</span>
                            </label>
                            {{ form.company }}
                        </div>
                    </div>

                    {% for field in form %}
                        {% if field.name != 'company' %}
                        <div class="at-form-group">
                            <label for="{{ field.id_for_label }}" class="at-form-label">{{ field.label }}</label>
                            {{ field }}
                        </div>
                        {% endif %}
                    {% endfor %}

                    <div class="at-action-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i>保存
                        </button>
                        <button type="button" class="btn btn-secondary" id="load-metrics">
                            <i class="bi bi-arrow-clockwise me-1"></i>既存データ読込
                        </button>
                        <button type="button" class="btn btn-info" id="fetch-api-data">
                            <i class="bi bi-cloud-download me-1"></i>APIから取得
                        </button>
                    </div>
                </form>
            </div>

            <!-- 登録済み指標一覧 -->
            <div class="at-card">
                <div class="at-card-header">
                    <h5 class="at-card-title mb-0">
                        <i class="bi bi-table me-2"></i>登録済み指標一覧
                    </h5>
                </div>
                
                <div class="at-table-wrapper">
                    <table class="at-table">
                        <thead>
                            <tr>
                                <th>企業</th>
                                <th>指標数</th>
                                <th>最終更新</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for data in metrics_data %}
                            <tr>
                                <td>
                                    <strong>{{ data.company.name }}</strong><br>
                                    <small class="at-text-muted">{{ data.company.code }}</small>
                                </td>
                                <td><span class="badge bg-primary">{{ data.metrics|length }}件</span></td>
                                <td>
                                    {% if data.first_metric %}{{ data.first_metric.updated_at|date:"Y/m/d H:i" }}{% else %}-{% endif %}
                                </td>
                                <td>
                                    <button class="at-btn-icon load-company-data" data-company-id="{{ data.company.id }}" title="編集">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center at-text-muted py-4">指標データがありません</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="at-card mb-3">
                <h6 class="at-card-title">
                    <i class="bi bi-lightbulb text-warning me-2"></i>操作ガイド
                </h6>
                <ol class="small mb-0 ps-3">
                    <li class="mb-2">企業を選択します</li>
                    <li class="mb-2">各指標の値を入力します</li>
                    <li class="mb-2">「保存」ボタンをクリックします</li>
                    <li class="mb-2">他の企業も同様に入力します</li>
                </ol>
                <hr class="my-3">
                <p class="small mb-0 at-text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    既存データがある企業は「既存データ読込」で編集できます
                </p>
            </div>

            <div class="at-card">
                <h6 class="at-card-title mb-3">アクション</h6>
                <div class="d-grid gap-2">
                    <a href="{% url 'analysis_template:detail' template.pk %}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-eye me-1"></i>レポート表示
                    </a>
                    <a href="{% url 'analysis_template:update' template.pk %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-pencil me-1"></i>基本情報編集
                    </a>
                    <a href="{% url 'analysis_template:calculate_scores' template.pk %}" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-calculator me-1"></i>スコア計算
                    </a>
                    <a href="{% url 'analysis_template:list' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>一覧へ戻る
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'speed_dial.html' with actions=form_actions %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const companySelect = document.querySelector('select[name="company"]');
    const loadButton = document.getElementById('load-metrics');
    const fetchApiButton = document.getElementById('fetch-api-data');
    const templateId = {{ template.pk }};
    const csrfToken = '{{ csrf_token }}';
    
    // 企業選択時に自動読込
    companySelect.addEventListener('change', function() {
        if (this.value) loadExistingMetrics(this.value);
    });
    
    // 初期表示
    if (companySelect.value) loadExistingMetrics(companySelect.value);
    
    loadButton.addEventListener('click', function() {
        if (!companySelect.value) {
            alert('企業を選択してください');
            return;
        }
        loadExistingMetrics(companySelect.value);
    });
    
    fetchApiButton.addEventListener('click', function() {
        if (!companySelect.value) {
            alert('企業を選択してください');
            return;
        }
        
        const selectedOption = companySelect.options[companySelect.selectedIndex];
        const companyCode = selectedOption.text.match(/^(\d+)/)?.[1];
        
        if (!companyCode) {
            alert('企業コードを取得できませんでした');
            return;
        }
        
        fetchFromApi(companyCode, selectedOption.text);
    });
    
    document.querySelectorAll('.load-company-data').forEach(button => {
        button.addEventListener('click', function() {
            const companyId = this.dataset.companyId;
            companySelect.value = companyId;
            loadExistingMetrics(companyId);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    });
    
    function loadExistingMetrics(companyId) {
        loadButton.disabled = true;
        loadButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>読込中...';
        
        fetch(`/analysis_template/${templateId}/api/company/${companyId}/metrics/`)
            .then(r => r.json())
            .then(data => {
                let count = 0;
                Object.entries(data).forEach(([key, value]) => {
                    const input = document.getElementById(`id_${key}`);
                    if (input) {
                        input.value = value;
                        count++;
                        input.classList.add('bg-success', 'bg-opacity-10');
                        setTimeout(() => input.classList.remove('bg-success', 'bg-opacity-10'), 1000);
                    }
                });
                
                showToast(count > 0 ? `${count}件のデータを読み込みました` : 'この企業のデータはまだ登録されていません', count > 0 ? 'success' : 'info');
            })
            .catch(e => {
                console.error('Error:', e);
                alert('データの読み込みに失敗しました');
            })
            .finally(() => {
                loadButton.disabled = false;
                loadButton.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>既存データ読込';
            });
    }
    
    function fetchFromApi(companyCode, companyName) {
        fetchApiButton.disabled = true;
        fetchApiButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>取得中...';

        fetch(`/analysis_template/${templateId}/metrics/auto-fetch/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                company_codes: [companyCode],
                overwrite: true
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success && data.results.length > 0) {
                const result = data.results[0];
                
                if (result.status === 'success' && result.values) {
                    let count = 0;
                    Object.entries(result.values).forEach(([metricName, metricData]) => {
                        const input = document.getElementById(`id_metric_${metricData.metric_id}`);
                        if (input) {
                            input.value = metricData.value;
                            count++;
                            input.classList.add('bg-info', 'bg-opacity-25');
                            setTimeout(() => input.classList.remove('bg-info', 'bg-opacity-25'), 1500);
                        }
                    });
                    
                    showToast(`${count}件の指標をAPIから取得しました`, 'success');
                    
                    fetchApiButton.classList.remove('btn-info');
                    fetchApiButton.classList.add('btn-success');
                    fetchApiButton.innerHTML = `<i class="bi bi-check-circle me-1"></i>取得完了 (${result.metrics_count}指標)`;
                    
                    setTimeout(() => {
                        fetchApiButton.classList.remove('btn-success');
                        fetchApiButton.classList.add('btn-info');
                        fetchApiButton.innerHTML = '<i class="bi bi-cloud-download me-1"></i>APIから取得';
                    }, 3000);
                } else {
                    alert(`取得失敗: ${result.message || 'データを取得できませんでした'}`);
                }
            } else {
                alert('データの取得に失敗しました: ' + (data.error || '不明なエラー'));
            }
        })
        .catch(e => {
            console.error('Error:', e);
            alert('APIからの取得に失敗しました: ' + e.message);
        })
        .finally(() => {
            fetchApiButton.disabled = false;
            if (!fetchApiButton.classList.contains('btn-success')) {
                fetchApiButton.innerHTML = '<i class="bi bi-cloud-download me-1"></i>APIから取得';
            }
        });
    }
    
    function showToast(message, type = 'info') {
        const existing = document.querySelector('.metrics-toast');
        if (existing) existing.remove();
        
        const toast = document.createElement('div');
        toast.className = `metrics-toast alert alert-${type} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; animation: fadeIn 0.3s ease;';
        toast.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>${message}`;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
});
</script>

<style>
/* フォームコントロールのダークモード対応 */
.dark-mode .form-control,
.dark-mode .form-select,
[data-theme="dark"] .form-control,
[data-theme="dark"] .form-select {
    background-color: var(--at-bg-card-hover, rgba(71, 85, 105, 0.3));
    border-color: var(--at-border, #334155);
    color: var(--at-text-primary, #f1f5f9);
}

.dark-mode .form-control:focus,
.dark-mode .form-select:focus,
[data-theme="dark"] .form-control:focus,
[data-theme="dark"] .form-select:focus {
    background-color: var(--at-bg-card-hover, rgba(71, 85, 105, 0.4));
    border-color: var(--at-primary, #3b82f6);
    color: var(--at-text-primary, #f1f5f9);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}