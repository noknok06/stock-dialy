{% comment %}
ã‚¯ã‚¤ãƒƒã‚¯è¨˜éŒ²ç”¨ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆ
ä½¿ç”¨æ–¹æ³•: {% include 'components/quick_record_sheet.html' %}
{% endcomment %}

<div class="bottom-sheet" id="quickRecordSheet" aria-hidden="true">
  <div class="bottom-sheet-backdrop"></div>

  <div class="bottom-sheet-content">
    <!-- ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ« -->
    <div class="bottom-sheet-handle" aria-label="ã‚·ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹ã«ã¯ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ãã ã•ã„"></div>

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="bottom-sheet-header">
      <h3>
        <i class="bi bi-lightning-charge-fill" style="color: var(--warning-color, #f59e0b);"></i>
        ã‚¯ã‚¤ãƒƒã‚¯è¨˜éŒ²
      </h3>
      <button type="button" class="btn-close" aria-label="é–‰ã˜ã‚‹">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <!-- ãƒœãƒ‡ã‚£ -->
    <div class="bottom-sheet-body">
      <form id="quickRecordForm" method="post" action="{% url 'stockdiary:quick_create' %}">
        {% csrf_token %}

        <!-- Step ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
        <div class="step-indicator" aria-label="å…¥åŠ›ã‚¹ãƒ†ãƒƒãƒ—">
          <span class="step active" aria-label="ã‚¹ãƒ†ãƒƒãƒ—1: éŠ˜æŸ„å">1</span>
          <span class="step" aria-label="ã‚¹ãƒ†ãƒƒãƒ—2: è³¼å…¥æƒ…å ±">2</span>
          <span class="step" aria-label="ã‚¹ãƒ†ãƒƒãƒ—3: æŠ•è³‡ç†ç”±">3</span>
        </div>

        <!-- Step 1: éŠ˜æŸ„åã®ã¿ï¼ˆä»»æ„ï¼‰ -->
        <div class="form-step active" data-step="1">
          <label for="stock_name_quick">
            éŠ˜æŸ„åï¼ˆä»»æ„ãƒ»ãƒ¡ãƒ¢ã®ã¿ã‚‚å¯ï¼‰
          </label>
          <div class="input-with-suggestions">
            <input
              type="text"
              name="stock_name"
              id="stock_name_quick"
              class="form-control form-control-lg"
              placeholder="ä¾‹: ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š ã¾ãŸã¯ 7203"
              autocomplete="off"
              aria-describedby="stock_name_help">

            <div class="form-text small text-muted mt-2" id="stock_name_help">
              ğŸ’¡ éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã¾ãŸã¯ä¼šç¤¾åã‚’å…¥åŠ›ï¼ˆç©ºæ¬„ã§ãƒ¡ãƒ¢ã®ã¿è¨˜éŒ²ã‚‚å¯èƒ½ï¼‰
            </div>

            <!-- ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆå€™è£œ -->
            <div class="suggestions-inline" id="suggestions_quick" role="listbox">
              <div class="suggestions-list"></div>
            </div>
          </div>
        </div>

        <!-- Step 2: è³¼å…¥æƒ…å ±ï¼ˆä»»æ„ï¼‰ -->
        <div class="form-step" data-step="2">
          <label>è³¼å…¥æƒ…å ±ï¼ˆä»»æ„ãƒ»ã‚¹ã‚­ãƒƒãƒ—å¯ï¼‰</label>
          <p class="text-muted small mb-3">
            å¾Œã‹ã‚‰è©³ç´°ãƒšãƒ¼ã‚¸ã§è¿½åŠ ã§ãã¾ã™
          </p>

          <div class="row g-2">
            <div class="col-6">
              <label for="purchase_price_quick" class="small">è³¼å…¥å˜ä¾¡ï¼ˆå††ï¼‰</label>
              <input
                type="number"
                name="purchase_price"
                id="purchase_price_quick"
                class="form-control"
                placeholder="2500"
                step="0.01"
                min="0">
            </div>
            <div class="col-6">
              <label for="purchase_quantity_quick" class="small">è³¼å…¥æ•°é‡ï¼ˆæ ªï¼‰</label>
              <input
                type="number"
                name="purchase_quantity"
                id="purchase_quantity_quick"
                class="form-control"
                placeholder="100"
                step="1"
                min="1">
            </div>
          </div>

          <div class="mt-3">
            <label for="purchase_date_quick" class="small">è³¼å…¥æ—¥</label>
            <input
              type="date"
              name="purchase_date"
              id="purchase_date_quick"
              class="form-control"
              value="{{ today|date:'Y-m-d' }}">
          </div>
        </div>

        <!-- Step 3: æŠ•è³‡ç†ç”±ï¼ˆä»»æ„ï¼‰ -->
        <div class="form-step" data-step="3">
          <label for="reason_quick">æŠ•è³‡ç†ç”±ï¼ˆä»»æ„ãƒ»ã‚¹ã‚­ãƒƒãƒ—å¯ï¼‰</label>
          <p class="text-muted small mb-3">
            å¾Œã‹ã‚‰è©³ç´°ãƒšãƒ¼ã‚¸ã§è©³ã—ãè¨˜å…¥ã§ãã¾ã™
          </p>

          <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ -->
          <div class="mb-3">
            <label class="small fw-bold mb-2">
              <i class="bi bi-file-earmark-text me-1"></i>
              ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã†ï¼ˆä»»æ„ï¼‰
            </label>
            <div class="d-flex flex-wrap gap-2">
              <button type="button" class="btn btn-sm btn-outline-primary template-btn" data-template="growth">
                ğŸš€ æˆé•·æ ª
              </button>
              <button type="button" class="btn btn-sm btn-outline-success template-btn" data-template="dividend">
                ğŸ’° é…å½“
              </button>
              <button type="button" class="btn btn-sm btn-outline-info template-btn" data-template="value">
                ğŸ“Š ãƒãƒªãƒ¥ãƒ¼
              </button>
              <button type="button" class="btn btn-sm btn-outline-warning template-btn" data-template="swing">
                ğŸ“ˆ ã‚¹ã‚¤ãƒ³ã‚°
              </button>
            </div>
          </div>

          <textarea
            name="reason"
            id="reason_quick"
            class="form-control"
            rows="6"
            placeholder="è³¼å…¥ã‚’æ¤œè¨ã—ãŸç†ç”±ã‚„æ³¨ç›®ãƒã‚¤ãƒ³ãƒˆã‚’å…¥åŠ›...

ä¾‹:
ãƒ»æ±ºç®—ãŒè‰¯ã‹ã£ãŸ
ãƒ»ãƒãƒ£ãƒ¼ãƒˆãŒä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰
ãƒ»é…å½“åˆ©å›ã‚ŠãŒé«˜ã„"
            maxlength="2000"></textarea>

          <div class="form-text small text-muted mt-2">
            <i class="bi bi-info-circle me-1"></i>
            2000æ–‡å­—ã¾ã§å…¥åŠ›å¯èƒ½
          </div>
        </div>

        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="step-navigation">
          <button type="button" class="btn btn-outline" id="prevBtn" style="display:none;">
            <i class="bi bi-arrow-left me-1"></i>
            æˆ»ã‚‹
          </button>
          <button type="button" class="btn btn-primary" id="nextBtn">
            æ¬¡ã¸
            <i class="bi bi-arrow-right ms-1"></i>
          </button>
          <button type="submit" class="btn btn-success" id="submitBtn" style="display:none;">
            <i class="bi bi-check-lg me-1"></i>
            ä¿å­˜
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% comment %}
JavaScriptåˆæœŸåŒ–
â€» bottom-sheet.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå‰æ
{% endcomment %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  const templateBtns = document.querySelectorAll('.template-btn');
  const reasonTextarea = document.getElementById('reason_quick');

  templateBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const template = this.dataset.template;

      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
      templateBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');

      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥
      const templates = {
        'growth': `## æ³¨ç›®ç†ç”±
- æ¥­ç¸¾ã®æˆé•·æ€§ãŒé«˜ã„
- å¸‚å ´ã‚·ã‚§ã‚¢æ‹¡å¤§ä¸­

## ãƒªã‚¹ã‚¯
- å‰²é«˜æ„Ÿã«æ³¨æ„`,
        'dividend': `## é…å½“æƒ…å ±
- é…å½“åˆ©å›ã‚Š: %
- é…å½“æ€§å‘: %

## å®‰å®šæ€§
- æ¥­ç¸¾å®‰å®š`,
        'value': `## ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
- PER:
- PBR:
- å‰²å®‰ã¨åˆ¤æ–­ã—ãŸç†ç”±: `,
        'swing': `## ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¡ä»¶
- ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™:
- ç›®æ¨™ä¾¡æ ¼:
- æåˆ‡ã‚Šãƒ©ã‚¤ãƒ³: `
      };

      if (templates[template]) {
        reasonTextarea.value = templates[template];

        // è§¦è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        if (navigator.vibrate) {
          navigator.vibrate(10);
        }
      }
    });
  });

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
  const form = document.getElementById('quickRecordForm');
  form.addEventListener('submit', function(e) {
    e.preventDefault();

    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆäºŒé‡é€ä¿¡é˜²æ­¢ï¼‰
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ä¿å­˜ä¸­...';

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    const formData = new FormData(form);

    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // æˆåŠŸæ™‚ã®å‡¦ç†
        if (navigator.vibrate) {
          navigator.vibrate([10, 5, 10]); // æˆåŠŸã®æŒ¯å‹•
        }

        // ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹
        closeBottomSheet('quickRecordSheet');

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        showToast('success', 'ã‚¯ã‚¤ãƒƒã‚¯è¨˜éŒ²ã‚’ä½œæˆã—ã¾ã—ãŸ');

        // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã¾ãŸã¯æ—¥è¨˜ã‚’è¿½åŠ 
        if (data.redirect_url) {
          setTimeout(() => {
            window.location.href = data.redirect_url;
          }, 500);
        } else {
          setTimeout(() => {
            window.location.reload();
          }, 500);
        }
      } else {
        // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
        showToast('error', data.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i> ä¿å­˜';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('error', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i> ä¿å­˜';
    });
  });
});

// ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function showToast(type, message) {
  // æ—¢å­˜ã®ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
  // ãªã‘ã‚Œã°ã‚·ãƒ³ãƒ—ãƒ«ãªalertã§ä»£æ›¿
  if (typeof window.showNotification === 'function') {
    window.showNotification(message, type);
  } else {
    alert(message);
  }
}
</script>
