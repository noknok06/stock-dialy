{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{% block title %}JPXãƒ‡ãƒ¼ã‚¿å–å¾—å®Ÿè¡Œ{% endblock %}

{% block extrahead %}
<style>
.batch-form {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 5px;
    margin: 20px 0;
}
.batch-form h3 {
    margin-top: 0;
    color: #333;
}
.form-row {
    margin: 15px 0;
}
.form-row label {
    display: inline-block;
    width: 120px;
    font-weight: bold;
}
.form-row input, .form-row select {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 3px;
}
.btn-execute {
    background: #417690;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 14px;
}
.btn-execute:hover {
    background: #205067;
}
.recent-logs {
    margin-top: 30px;
}
.log-entry {
    background: white;
    border: 1px solid #ddd;
    margin: 10px 0;
    padding: 15px;
    border-radius: 3px;
}
.log-status {
    font-weight: bold;
    padding: 3px 8px;
    border-radius: 3px;
    color: white;
}
.status-SUCCESS { background: #28a745; }
.status-FAILED { background: #dc3545; }
.status-SKIPPED { background: #ffc107; color: black; }
.status-PROCESSING { background: #007bff; }
.help-text {
    color: #666;
    font-size: 12px;
    margin-top: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="content">
    <h1>JPXãƒ‡ãƒ¼ã‚¿å–å¾—å®Ÿè¡Œ</h1>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <div class="batch-form">
        <h3>ğŸš€ ãƒãƒƒãƒå®Ÿè¡Œ</h3>
        
        <form method="post">
            {% csrf_token %}
            
            <div class="form-row">
                <label for="date">å¯¾è±¡æ—¥ä»˜:</label>
                <input type="text" id="date" name="date" value="{{ today }}" placeholder="YYYYMMDDå½¢å¼">
                <div class="help-text">ç©ºæ¬„ã§å½“æ—¥ã‚’å–å¾—ã€‚ä¾‹: 20240725</div>
            </div>
            
            <div class="form-row">
                <label for="command_type">å®Ÿè¡Œæ–¹å¼:</label>
                <select id="command_type" name="command_type">
                    <option value="standard">æ¨™æº–å®Ÿè¡Œ</option>
                    <option value="monitor">ç›£è¦–ä»˜ãå®Ÿè¡Œ</option>
                </select>
                <div class="help-text">ç›£è¦–ä»˜ãå®Ÿè¡Œã¯ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’ç›£è¦–ã—ã¾ã™</div>
            </div>
            
            <div class="form-row">
                <label for="force">
                    <input type="checkbox" id="force" name="force">
                    å¼·åˆ¶å®Ÿè¡Œ
                </label>
                <div class="help-text">æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã§ã‚‚ä¸Šæ›¸ãã—ã¾ã™</div>
            </div>
            
            <div class="form-row">
                <button type="submit" class="btn-execute">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹</button>
            </div>
        </form>
    </div>
    
    <div class="recent-logs">
        <h3>ğŸ“‹ æœ€è¿‘ã®å®Ÿè¡Œãƒ­ã‚°</h3>
        
        {% if recent_logs %}
            {% for log in recent_logs %}
                <div class="log-entry">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                        <strong>{{ log.date }}</strong>
                        <span class="log-status status-{{ log.status }}">{{ log.get_status_display }}</span>
                        <small style="margin-left: auto;">{{ log.executed_at|date:"Y/m/d H:i:s" }}</small>
                    </div>
                    
                    <div style="margin: 10px 0;">
                        <strong>å–å¾—ä»¶æ•°:</strong> {{ log.records_count|default:"0" }}ä»¶
                    </div>
                    
                    <div style="margin: 10px 0;">
                        <strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong>
                        <div style="background: #f5f5f5; padding: 10px; margin-top: 5px; border-radius: 3px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
                            {{ log.message|linebreaksbr }}
                        </div>
                    </div>
                    
                    {% if log.pdf_url %}
                        <div style="margin: 10px 0;">
                            <strong>PDF URL:</strong> <a href="{{ log.pdf_url }}" target="_blank">{{ log.pdf_url }}</a>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p>å®Ÿè¡Œãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        {% endif %}
    </div>
    
    <div style="margin-top: 30px;">
        <h3>ğŸ“Š ä½¿ç”¨æ–¹æ³•</h3>
        <ul>
            <li><strong>æ¨™æº–å®Ÿè¡Œ:</strong> é€šå¸¸ã®ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™</li>
            <li><strong>ç›£è¦–ä»˜ãå®Ÿè¡Œ:</strong> ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’ç›£è¦–ã—ãªãŒã‚‰å®Ÿè¡Œã—ã€è©³ç´°ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¾ã™</li>
            <li><strong>å¼·åˆ¶å®Ÿè¡Œ:</strong> æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹æ—¥ä»˜ã§ã‚‚ä¸Šæ›¸ãã—ã¦å–å¾—ã—ã¾ã™</li>
            <li><strong>å¯¾è±¡æ—¥ä»˜:</strong> ç©ºæ¬„ã®å ´åˆã¯å½“æ—¥ã€æŒ‡å®šã™ã‚‹å ´åˆã¯YYYYMMDDå½¢å¼ï¼ˆä¾‹: 20240725ï¼‰</li>
        </ul>
        
        <p><strong>âš ï¸ æ³¨æ„:</strong> ãƒãƒƒãƒå‡¦ç†ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚å‡¦ç†å®Œäº†ã¾ã§æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
    </div>
    
    <div style="margin-top: 20px; text-align: center;">
        <a href="/admin/margin_trading/dataimportlog/" class="btn btn-default">ğŸ“„ å®Ÿè¡Œãƒ­ã‚°ä¸€è¦§ã¸</a>
        <a href="/admin/margin_trading/margintradingdata/" class="btn btn-default">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ã¸</a>
    </div>
</div>

<script>
// 5ç§’ã”ã¨ã«ãƒãƒƒãƒçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
function checkBatchStatus() {
    fetch('/admin/margin_trading/margintradingdata/batch-status/')
        .then(response => response.json())
        .then(data => {
            if (data.has_log && data.last_status === 'PROCESSING') {
                // å‡¦ç†ä¸­ã®å ´åˆã¯ç”»é¢ã‚’è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                setTimeout(() => {
                    location.reload();
                }, 30000); // 30ç§’å¾Œã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
            }
        })
        .catch(error => // console.log('Status check error:', error));
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯é–‹å§‹
document.addEventListener('DOMContentLoaded', checkBatchStatus);
</script>
{% endblock %}