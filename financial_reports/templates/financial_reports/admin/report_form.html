<!-- financial_reports/templates/financial_reports/admin/report_form.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}
{% if form.instance.pk %}決算レポート編集{% else %}新規決算レポート{% endif %} | カブログ
{% endblock %}

{% block head %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<style>
  .form-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    border-radius: 0.5rem;
    background-color: #f8f9fa;
  }
  
  .form-section-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: #4f46e5;
  }
  
  .preview-section {
    margin-top: 2rem;
    display: none;
  }
  
  .preview-container {
    max-width: 100%;
    margin: 0 auto;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
  }
  
  .json-sample-button {
    position: absolute;
    right: 20px;
    top: 10px;
  }

  /* 自動設定されたフィールドのスタイル */
  .auto-filled {
    background-color: #f0f9ff !important;
    border-color: #3b82f6 !important;
    transition: background-color 0.3s ease;
  }
  
  /* Select2カスタマイズ */
  .select2-container--bootstrap-5 .select2-selection {
    border-radius: 0.5rem;
    min-height: 38px;
  }
  
  .company-option {
    display: flex;
    align-items: center;
  }
  
  .company-code {
    font-weight: bold;
    margin-right: 10px;
    color: #3b82f6;
    min-width: 60px;
  }
  
  .company-name {
    flex-grow: 1;
  }
  
  /* 会社選択フィールドがクリックされたときのガイダンス */
  .select2-dropdown .select2-results__message {
    padding: 8px 12px;
    background-color: #f0f9ff;
    border: 1px dashed #3b82f6;
    border-radius: 4px;
    margin: 5px;
    font-size: 0.875rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="mb-4">
    <a href="{% url 'financial_reports:admin_dashboard' %}" class="btn btn-sm btn-outline-primary">
      <i class="bi bi-arrow-left"></i> ダッシュボードに戻る
    </a>
  </div>
  
  <h1 class="h3 mb-4">
    {% if form.instance.pk %}決算レポート編集{% else %}新規決算レポート{% endif %}
  </h1>
  
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="post" id="reportForm" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- 基本情報 -->
        <div class="form-section">
          <h3 class="form-section-title">基本情報</h3>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.company.id_for_label }}" class="form-label">企業</label>
              {{ form.company }}
              {% if form.company.errors %}
                <div class="text-danger">{{ form.company.errors }}</div>
              {% endif %}
            </div>
            <div class="col-md-6 mb-3">
              <label for="{{ form.fiscal_period.id_for_label }}" class="form-label">決算期</label>
              {{ form.fiscal_period }}
              {% if form.fiscal_period.errors %}
                <div class="text-danger">{{ form.fiscal_period.errors }}</div>
              {% endif %}
            </div>
            <div class="col-md-6 mb-3">
              <label for="{{ form.achievement_badge.id_for_label }}" class="form-label">業績バッジ</label>
              {{ form.achievement_badge }}
              {% if form.achievement_badge.errors %}
                <div class="text-danger">{{ form.achievement_badge.errors }}</div>
              {% endif %}
            </div>
            <div class="col-md-4 mb-3">
              <label for="{{ form.overall_rating.id_for_label }}" class="form-label">総合評価 (1-10)</label>
              {{ form.overall_rating }}
              {% if form.overall_rating.errors %}
                <div class="text-danger">{{ form.overall_rating.errors }}</div>
              {% endif %}
            </div>
            <div class="col-md-2 mb-3">
              <label for="{{ form.is_public.id_for_label }}" class="form-label">公開設定</label>
              <div class="form-check form-switch mt-2">
                {{ form.is_public }}
                <label class="form-check-label" for="{{ form.is_public.id_for_label }}">公開する</label>
              </div>
              {% if form.is_public.errors %}
                <div class="text-danger">{{ form.is_public.errors }}</div>
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- JSONデータ入力 -->
        <div class="form-section position-relative">
          <h3 class="form-section-title">レポートデータ (JSON形式)</h3>
          
          <button type="button" id="sampleJsonBtn" class="btn btn-sm btn-outline-secondary json-sample-button">
            <i class="bi bi-file-earmark-code"></i> サンプルデータ
          </button>
          
          <div class="mb-3">
            <label for="{{ form.json_file.id_for_label }}" class="form-label">JSONファイル</label>
            {{ form.json_file }}
            <div class="form-text">{{ form.json_file.help_text }}</div>
            {% if form.json_file.errors %}
              <div class="text-danger">{{ form.json_file.errors }}</div>
            {% endif %}
          </div>
          
          <div class="mb-3">
            <label for="{{ form.data_json.id_for_label }}" class="form-label">JSONデータ</label>
            {{ form.data_json }}
            <div class="form-text">{{ form.data_json.help_text }}</div>
            {% if form.data_json.errors %}
              <div class="text-danger">{{ form.data_json.errors }}</div>
            {% endif %}
          </div>
          
          {{ form.data }}
        </div>
        
        <!-- プレビューセクション -->
        <div class="preview-section" id="previewSection">
          <h3 class="form-section-title">プレビュー</h3>
          <div id="preview-container" class="preview-container"></div>
        </div>
        
        <!-- 送信ボタン -->
        <div class="d-flex justify-content-between mt-4">
          <button type="button" id="previewBtn" class="btn btn-secondary">
            <i class="bi bi-eye"></i> プレビュー
          </button>
          <div>
            <a href="{% url 'financial_reports:admin_dashboard' %}" class="btn btn-light me-2">キャンセル</a>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-save"></i> 保存
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- jQuery (Select2の依存関係) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- テンプレートHTMLとJSを読み込む -->
<!-- template.jsではなくプレビュー専用スクリプトを使用 -->
<script src="{% static 'js/report-preview.js' %}"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const previewBtn = document.getElementById('previewBtn');
    const previewSection = document.getElementById('previewSection');
    const sampleJsonBtn = document.getElementById('sampleJsonBtn');
    const dataJsonField = document.getElementById('{{ form.data_json.id_for_label }}');
    const reportForm = document.getElementById('reportForm');
    const fiscalPeriodField = document.getElementById('{{ form.fiscal_period.id_for_label }}');
    const achievementBadgeField = document.getElementById('{{ form.achievement_badge.id_for_label }}');
    const overallRatingField = document.getElementById('{{ form.overall_rating.id_for_label }}');
    
    // Select2を企業選択フィールドに適用
    $('#{{ form.company.id_for_label }}').select2({
      theme: 'bootstrap-5',
      width: '100%',
      placeholder: '企業名または証券コードで検索...',
      allowClear: true,
      templateResult: formatCompany,
      templateSelection: formatCompanySelection,
      language: {
        inputTooShort: function() {
          return "検索するには文字を入力してください";
        },
        noResults: function() {
          return "該当する企業が見つかりません";
        },
        searching: function() {
          return "検索中...";
        }
      }
    }).on('select2:select', function(e) {
      // 企業が選択されたときに最近使用した企業リストを更新
      const selectedId = e.params.data.id;
      if (selectedId) {
        let recentCompanies = JSON.parse(localStorage.getItem('recentCompanies') || '[]');
        // 既に存在する場合は削除
        recentCompanies = recentCompanies.filter(id => id !== selectedId);
        // リストの先頭に追加
        recentCompanies.unshift(selectedId);
        // 最大10社まで保存
        recentCompanies = recentCompanies.slice(0, 10);
        localStorage.setItem('recentCompanies', JSON.stringify(recentCompanies));
      }
    });
    
    // 検索結果のフォーマット
    function formatCompany(company) {
      if (!company.id) {
        return company.text;
      }
      
      // company.textは通常「企業名 (証券コード)」の形式
      const text = company.text;
      const match = text.match(/(.+) \((.+)\)$/);
      
      if (match) {
        const companyName = match[1];
        const companyCode = match[2];
        
        const $container = $(
          `<div class="company-option">
             <span class="company-code">${companyCode}</span>
             <span class="company-name">${companyName}</span>
           </div>`
        );
        
        return $container;
      }
      
      return company.text;
    }
    
    // 選択後の表示フォーマット
    function formatCompanySelection(company) {
      if (!company.id) {
        return company.text;
      }
      
      const text = company.text;
      const match = text.match(/(.+) \((.+)\)$/);
      
      if (match) {
        const companyName = match[1];
        const companyCode = match[2];
        return `${companyName} (${companyCode})`;
      }
      
      return company.text;
    }
    
    // フィールドに自動セットされたことを視覚的に表示
    function flashField(field) {
      field.classList.add('auto-filled');
      setTimeout(() => {
        field.classList.remove('auto-filled');
      }, 2000);
    }
    
    // JSONデータからフィールドを更新する関数
    function updateFieldsFromJson(jsonData) {
      try {
        const data = (typeof jsonData === 'string') ? JSON.parse(jsonData) : jsonData;
        let updated = false;
        
        // 決算期を設定
        if (data.fiscalPeriod && !fiscalPeriodField.value) {
          fiscalPeriodField.value = data.fiscalPeriod;
          flashField(fiscalPeriodField);
          updated = true;
        }
        
        // 業績バッジを設定
        if (data.achievementBadge && !achievementBadgeField.value) {
          achievementBadgeField.value = data.achievementBadge;
          flashField(achievementBadgeField);
          updated = true;
        }
        
        // 総合評価を設定
        if (data.overallRating && !overallRatingField.value) {
          // 数値に変換して設定
          const rating = parseFloat(data.overallRating);
          if (!isNaN(rating)) {
            overallRatingField.value = rating;
            flashField(overallRatingField);
            updated = true;
          }
        }
        
        // 企業コードから企業を選択（企業が選択されていない場合のみ）
        if (data.companyCode && $('#{{ form.company.id_for_label }}').val() === '') {
          // 企業コードが一致するオプションを探す
          $('#{{ form.company.id_for_label }} option').each(function() {
            const optionText = $(this).text();
            if (optionText.includes(`(${data.companyCode})`)) {
              // 企業を選択
              $('#{{ form.company.id_for_label }}').val($(this).val()).trigger('change');
              updated = true;
              return false; // ループを終了
            }
          });
        }
        
        return updated;
      } catch (e) {
        console.error('JSONデータの解析に失敗しました:', e);
        return false;
      }
    }

    // JSONデータテキストエリアの変更監視
    dataJsonField.addEventListener('change', function() {
      updateFieldsFromJson(this.value);
    });
    
    // 入力中のデバウンス処理（タイピング中の頻繁な更新を防ぐ）
    let debounceTimer;
    dataJsonField.addEventListener('input', function() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        updateFieldsFromJson(this.value);
      }, 800);
    });
    
    // JSONファイルアップロード処理
    document.getElementById('{{ form.json_file.id_for_label }}').addEventListener('change', function(e) {
      if (this.files && this.files[0]) {
        const file = this.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const fileContent = e.target.result;
          
          // JSONテキストエリアに表示
          dataJsonField.value = fileContent;
          
          // フィールドを更新
          const updated = updateFieldsFromJson(fileContent);
          
          if (updated) {
            // 通知メッセージ
            const messageDiv = document.createElement('div');
            messageDiv.className = 'alert alert-info mt-2';
            messageDiv.innerHTML = '<strong>ヒント:</strong> JSONファイルから基本情報を自動設定しました';
            document.querySelector('.form-section').appendChild(messageDiv);
            
            // 3秒後に消去
            setTimeout(() => {
              messageDiv.remove();
            }, 3000);
          }
        };
        
        reader.readAsText(file);
      }
    });
    
    // フォーム送信前のデータ設定処理
    reportForm.addEventListener('submit', function(e) {
      try {
        // JSONデータを取得
        const jsonData = dataJsonField.value;
        if (!jsonData) {
          alert('JSONデータが入力されていません。');
          e.preventDefault();
          return;
        }
        
        // JSONデータをパース
        const data = JSON.parse(jsonData);
        
        // 必須フィールドとJSONデータの整合性を確保
        const fiscalPeriod = fiscalPeriodField.value;
        const achievementBadge = achievementBadgeField.value;
        const overallRating = overallRatingField.value;
        
        // JSONデータを最新値で更新
        data.fiscalPeriod = fiscalPeriod;
        data.achievementBadge = achievementBadge;
        data.overallRating = overallRating.toString();
        
        // 選択された企業の情報を取得
        const companySelect = document.getElementById('{{ form.company.id_for_label }}');
        if (companySelect && companySelect.selectedIndex > 0) {
          const companyText = companySelect.options[companySelect.selectedIndex].text;
          const match = companyText.match(/(.+) \((.+)\)$/);
          
          if (match) {
            data.companyName = match[1];
            data.companyCode = match[2];
          }
        }
        
        // 更新されたJSONをテキストエリアに戻す
        dataJsonField.value = JSON.stringify(data, null, 2);
        
        // 隠しフィールドにJSONデータを設定
        const hiddenDataField = document.querySelector('input[name="data"]');
        if (hiddenDataField) {
          hiddenDataField.value = JSON.stringify(data);
          console.log('データフィールドに値を設定:', hiddenDataField.value.substring(0, 100) + '...');
        } else {
          console.error('data フィールドが見つかりません');
          alert('エラー: データフィールドが見つかりません。');
          e.preventDefault();
        }
      } catch (e) {
        alert('JSONデータの解析に失敗しました: ' + e.message);
        console.error('JSONデータ解析エラー:', e);
        e.preventDefault();
      }
    });
    
    // プレビューボタン
    previewBtn.addEventListener('click', function() {
      try {
        // JSONデータを取得
        const jsonData = dataJsonField.value;
        if (!jsonData) {
          alert('JSONデータが入力されていません。');
          return;
        }
        
        const data = JSON.parse(jsonData);
        
        // 会社情報とレポート情報を補完
        const companySelect = document.getElementById('{{ form.company.id_for_label }}');
        const companyName = companySelect.options[companySelect.selectedIndex].text;
        const companyCode = companySelect.value;
        const fiscalPeriod = fiscalPeriodField.value;
        const achievementBadge = achievementBadgeField.value;
        const overallRating = overallRatingField.value;
        
        // データ補完
        if (!data.companyName) data.companyName = companyName;
        if (!data.companyCode) data.companyCode = companyCode;
        if (!data.fiscalPeriod) data.fiscalPeriod = fiscalPeriod;
        if (!data.achievementBadge) data.achievementBadge = achievementBadge;
        if (!data.overallRating) data.overallRating = overallRating;
        
        // プレビューを表示
        previewSection.style.display = 'block';
        setPreviewData(data); // プレビューデータを設定
        
        // プレビューセクションまでスクロール
        previewSection.scrollIntoView({ behavior: 'smooth' });
      } catch (e) {
        alert('JSONデータの解析に失敗しました: ' + e.message);
      }
    });
    
    // サンプルデータボタン
    sampleJsonBtn.addEventListener('click', function() {
      const sampleData = {
        // 会社情報
        companyAbbr: "MRB",
        companyColor: "#E60012", 
        companyName: "丸紅株式会社",
        companyCode: "8002",
        fiscalPeriod: "2025年3月期 決算サマリー",
        achievementBadge: "過去2番目の高水準達成",
        
        // 総合評価
        overallRating: "8.5",
        overallRatingText: "優秀（7-9点）",
        overallSummary: "前期比6.7%増益となる5,030億円の純利益を計上し、従来見通しを上回る好業績。非資源分野は過去最高の3,230億円の実態純利益を達成。積極的な資本配分と株主還元も強化し、総合的に良好な決算内容。",
        recommendationText: "買い推奨",
        starRating: "★★★★☆",
        investmentReason: "非資源事業の安定的な収益拡大と積極的な株主還元策が評価でき、PER8.4倍と割安感もある。中期経営戦略で掲げる時価総額10兆円目標に向けた成長期待も投資魅力。",
        
        // 業績ハイライト
        performanceRating: "8",
        netIncome: "5,030億円",
        netIncomeChange: "+316億円 (+6.7%)",
        eps: "302.78円",
        epsChange: "+23.16円 (+8.3%)",
        dividend: "95円",
        dividendChange: "+10円 (+11.8%)",
        roe: "14.2%",
        roeChange: "-1.0pt",
        
        // 最低限必要なその他の項目
        positivePoints: [
          "非資源分野の実態純利益が過去最高を達成",
          "基礎営業キャッシュフローが過去最高を記録"
        ],
        negativePoints: [
          "資源分野は市況下落の影響を受け減益",
          "世界経済の減速懸念や地政学リスクによる不確実性"
        ]
      };
      
      // テキストエリアに設定
      dataJsonField.value = JSON.stringify(sampleData, null, 2);
      
      // 基本フィールドを設定
      if (!fiscalPeriodField.value) {
        fiscalPeriodField.value = sampleData.fiscalPeriod;
        flashField(fiscalPeriodField);
      }
      
      if (!achievementBadgeField.value) {
        achievementBadgeField.value = sampleData.achievementBadge;
        flashField(achievementBadgeField);
      }
      
      if (!overallRatingField.value) {
        overallRatingField.value = parseFloat(sampleData.overallRating);
        flashField(overallRatingField);
      }
      
      // 企業を選択（コード 8002 の丸紅）
      $('#{{ form.company.id_for_label }} option').each(function() {
        const optionText = $(this).text();
        if (optionText.includes('(8002)')) {
          $('#{{ form.company.id_for_label }}').val($(this).val()).trigger('change');
          return false; // ループを終了
        }
      });
    });
    
    // 最近使用した企業を優先表示
    try {
      const recentCompanies = JSON.parse(localStorage.getItem('recentCompanies') || '[]');
      if (recentCompanies.length > 0) {
        // Select2の既存のデータを取得
        const $select = $('#{{ form.company.id_for_label }}');
        const existingOptions = $select.find('option').map(function() {
          return {
            id: $(this).val(),
            text: $(this).text()
          };
        }).get();
        
        // 最近使用した企業を先頭に追加
        const recentOptions = [];
        recentCompanies.forEach(companyId => {
          const option = existingOptions.find(opt => opt.id === companyId);
          if (option) {
            recentOptions.push(option);
          }
        });
        
        // 最近使用した企業がある場合、グループを作成
        if (recentOptions.length > 0) {
          // データを再構築
          const data = {
            results: [
              {
                text: '最近使用した企業',
                children: recentOptions
              },
              {
                text: '全ての企業',
                children: existingOptions
              }
            ]
          };
          
          // データフォーマットを変更
          $select.select2('destroy').empty();
          
          // オプションを再構築
          $select.append('<option></option>'); // 空のオプション
          
          const recentGroup = $('<optgroup label="最近使用した企業"></optgroup>');
          recentOptions.forEach(option => {
            recentGroup.append(`<option value="${option.id}">${option.text}</option>`);
          });
          $select.append(recentGroup);
          
          const allGroup = $('<optgroup label="全ての企業"></optgroup>');
          existingOptions.forEach(option => {
            if (option.id) { // 空のオプションは除外
              allGroup.append(`<option value="${option.id}">${option.text}</option>`);
            }
          });
          $select.append(allGroup);
          
          // Select2を再初期化
          $select.select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: '企業名または証券コードで検索...',
            allowClear: true,
            templateResult: formatCompany,
            templateSelection: formatCompanySelection
          });
        }
      }
    } catch (e) {
      console.error('最近使用した企業の表示中にエラーが発生しました:', e);
    }
  });
</script>
{% endblock %}