{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - カブログ{% endblock %}

{% block content %}
<div class="container-fluid px-3">
    <!-- ページヘッダー -->
    <div class="title_header mb-4">
        <h1 class="page-title d-flex align-items-center">
            <i class="bi bi-pie-chart-fill me-2"></i>
            {{ page_title }}
        </h1>
        <p class="subtitle text-muted">{{ page_subtitle }}</p>
    </div>

    {% if has_holdings %}
    <!-- ポートフォリオ評価実行カード -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0 d-flex align-items-center">
                <i class="bi bi-robot me-2"></i>
                AI ポートフォリオ評価
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-lg-8">
                    <h6 class="fw-bold mb-3">分析内容</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0 me-3">
                                    <i class="bi bi-graph-up text-success fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">ファンダメンタル分析</h6>
                                    <small class="text-muted">PER, PBR, 配当利回り, ROE等の指標分析</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0 me-3">
                                    <i class="bi bi-activity text-info fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">テクニカル分析</h6>
                                    <small class="text-muted">移動平均, RSI, トレンド分析</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0 me-3">
                                    <i class="bi bi-shield-check text-warning fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">リスク分析</h6>
                                    <small class="text-muted">分散度, 集中度, セクター偏り分析</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0 me-3">
                                    <i class="bi bi-globe text-primary fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1">市場環境分析</h6>
                                    <small class="text-muted">金利動向, 為替, 経済指標との整合性</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info d-flex align-items-center mb-3">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <div>
                            <strong>プロ投資家目線での評価</strong><br>
                            <small>20年以上の経験を持つ投資アドバイザーの視点で、あなたのポートフォリオを厳格かつ建設的に評価します。</small>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="bg-light rounded p-3">
                        <h6 class="fw-bold mb-3">現在の保有状況</h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span>保有銘柄数:</span>
                            <span class="fw-bold">{{ current_holdings_count }}銘柄</span>
                        </div>
                        
                        <div class="mt-4">
                            <button type="button" class="btn btn-primary btn-lg w-100" id="startEvaluationBtn">
                                <i class="bi bi-play-fill me-2"></i>
                                ポートフォリオを評価する
                            </button>
                            <small class="text-muted d-block mt-2 text-center">
                                分析には2-3分程度かかります
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 過去の評価履歴（最新3件） -->
    {% if recent_evaluations %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="bi bi-clock-history me-2"></i>
                最近の評価履歴
            </h5>
            <a href="{% url 'investment_review:portfolio_history' %}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-list me-1"></i>全履歴を見る
            </a>
        </div>
        <div class="card-body">
            <div class="row">
                {% for evaluation in recent_evaluations %}
                <div class="col-lg-4 mb-3">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">{{ evaluation.get_evaluation_period_display }}</h6>
                                <span class="badge bg-success">完了</span>
                            </div>
                            <div class="row text-center mb-2">
                                <div class="col-4">
                                    <small class="text-muted d-block">銘柄数</small>
                                    <strong>{{ evaluation.total_holdings }}</strong>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block">リターン</small>
                                    <strong class="{% if evaluation.total_return_pct and evaluation.total_return_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                                        {% if evaluation.total_return_pct is not None %}{{ evaluation.total_return_pct|floatformat:1 }}%{% else %}-{% endif %}
                                    </strong>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block">AI分析</small>
                                    {% if evaluation.api_used %}<i class="bi bi-robot text-success"></i>{% else %}<i class="bi bi-cpu text-secondary"></i>{% endif %}
                                </div>
                            </div>
                            <div class="d-grid">
                                <a href="{% url 'investment_review:portfolio_evaluation_detail' evaluation.pk %}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye me-1"></i>詳細を見る
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 評価項目の説明 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="bi bi-list-check me-2"></i>
                評価項目
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-4">
                <div class="col-md-6">
                    <h6 class="text-success fw-bold">
                        <i class="bi bi-plus-circle me-1"></i>
                        強み・ポジティブ要素
                    </h6>
                    <ul class="small text-muted">
                        <li>優れているポイントの具体的な指摘</li>
                        <li>数値的根拠を含めた客観的評価</li>
                        <li>継続すべき投資戦略の特定</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6 class="text-danger fw-bold">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        弱み・リスク要素
                    </h6>
                    <ul class="small text-muted">
                        <li>改善が必要な具体的な問題点</li>
                        <li>潜在的なリスク要因の洗い出し</li>
                        <li>市場変化への脆弱性分析</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6 class="text-info fw-bold">
                        <i class="bi bi-balance me-1"></i>
                        中立的な現状判断
                    </h6>
                    <ul class="small text-muted">
                        <li>現在のポジショニングの妥当性</li>
                        <li>市場環境との整合性評価</li>
                        <li>投資スタイルの一貫性確認</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6 class="text-warning fw-bold">
                        <i class="bi bi-gear me-1"></i>
                        具体的な改善提案
                    </h6>
                    <ul class="small text-muted">
                        <li>実行可能なアクションプラン</li>
                        <li>リスク管理の改善策</li>
                        <li>パフォーマンス向上のための戦略</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- 保有株式なしの場合 -->
    <div class="card text-center">
        <div class="card-body py-5">
            <i class="bi bi-inbox display-1 text-muted mb-3"></i>
            <h4>保有株式がありません</h4>
            <p class="text-muted mb-4">
                ポートフォリオ評価を行うには、まず株式を記録してください。<br>
                購入価格と数量が入力された株式のみが評価対象となります。
            </p>
            <a href="{% url 'stockdiary:create' %}" class="btn btn-primary me-2">
                <i class="bi bi-plus-circle me-1"></i>
                株式を記録する
            </a>
            <a href="{% url 'stockdiary:home' %}" class="btn btn-outline-secondary">
                <i class="bi bi-journal-text me-1"></i>
                日記一覧を見る
            </a>
        </div>
    </div>
    {% endif %}

    <!-- 注意事項 -->
    <div class="card border-warning mb-4">
        <div class="card-header bg-warning bg-opacity-10 border-warning">
            <h6 class="card-title mb-0 text-warning-emphasis">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                重要な注意事項
            </h6>
        </div>
        <div class="card-body">
            <div class="small">
                <p class="mb-2">
                    <strong>投資判断について:</strong> 
                    本評価は情報提供を目的としており、投資勧誘や投資判断の根拠として使用することを意図していません。
                </p>
                <p class="mb-2">
                    <strong>データの精度について:</strong> 
                    株価や財務データは外部APIから取得しており、リアルタイムではない場合があります。
                </p>
                <p class="mb-0">
                    <strong>リスクについて:</strong> 
                    投資はリスクを伴います。最終的な投資判断は、ご自身の責任において行ってください。
                </p>
            </div>
        </div>
    </div>
</div>

<!-- 評価実行モーダル -->
<div class="modal fade" id="evaluationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-gear-fill me-2"></i>
                    ポートフォリオ評価中
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mb-2">AI がポートフォリオを分析しています...</p>
                <small class="text-muted">
                    株価データの取得、指標の計算、市場環境の分析を実行中です。<br>
                    しばらくお待ちください。
                </small>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('startEvaluationBtn');
    const modal = new bootstrap.Modal(document.getElementById('evaluationModal'));
    
    if (startBtn) {
        startBtn.addEventListener('click', function() {
            // モーダルを表示
            modal.show();
            
            // 評価開始のPOSTリクエスト
            fetch('{% url "investment_review:portfolio_evaluation" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'started') {
                    // 結果ページにリダイレクト
                    window.location.href = data.redirect_url;
                } else {
                    modal.hide();
                    alert('評価の開始に失敗しました: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                modal.hide();
                console.error('Error:', error);
                alert('評価の開始中にエラーが発生しました。');
            });
        });
    }
});
</script>
{% endblock %}