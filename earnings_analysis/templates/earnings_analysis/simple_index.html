<!-- earnings_analysis/templates/earnings_analysis/simple_index.html（書類種別表示名対応版） -->
{% extends 'earnings_analysis/simple_base.html' %}

{% block title %}ホーム -コポモ{% endblock %}

{% block extra_css %}
<style>
/* カードのoverflow設定 */
.analysis-card {
    overflow: visible !important;
}

.analysis-card .card-body {
    overflow: visible !important;
}

/* 検索候補の改善スタイル */
.search-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    border: 1px solid #dee2e6;
    max-height: 60vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: #cbd5e0 #f8f9fa;
    z-index: 9999;
    margin-top: 4px;
}

.search-suggestions::-webkit-scrollbar {
    width: 8px;
}

.search-suggestions::-webkit-scrollbar-track {
    background: #f8f9fa;
    border-radius: 4px;
}

.search-suggestions::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 4px;
}

.search-suggestions::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
}

/* 候補項目の改善 */
.suggestion-item {
    padding: 16px !important;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 80px;
    display: flex;
    align-items: center;
}

.suggestion-item:hover,
.suggestion-item.active {
    background-color: #f8f9fa;
    border-left: 4px solid #007bff;
}

.suggestion-item:last-child {
    border-bottom: none;
}

/* スマホでのタッチ領域改善 */
@media (max-width: 768px) {
    .suggestion-item {
        padding: 20px 16px !important;
        min-height: 90px;
    }
    
    .search-suggestions {
        max-height: 50vh;
    }
    
    .suggestion-item .fw-semibold {
        font-size: 1.1rem;
    }
    
    .suggestion-item .small {
        font-size: 0.9rem;
    }
}

/* 検索状態とエラー表示の改善 */
#searchStatus, #noResults {
    padding: 20px;
    text-align: center;
    font-size: 1rem;
}

/* mark要素の改善 */
.suggestion-item mark {
    background-color: #fff3cd;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: 600;
}

/* バッジの改善 */
.suggestion-item .badge {
    font-size: 0.75rem;
    padding: 4px 8px;
}

/* 候補数が多い場合の表示改善 */
.suggestion-count {
    position: sticky;
    top: 0;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 8px 16px;
    font-size: 0.85rem;
    color: #6c757d;
    z-index: 10;
}

/* 書類種別表示名用のスタイル */
.doc-type-display {
    color: #28a745;
    font-weight: 600;
}

.latest-doc-info {
    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
    border-radius: 6px;
    padding: 6px 10px;
    margin-top: 8px;
}
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="page-header text-center mb-4">
    <div class="row align-items-center">
        <div class="col-12">
            <h1 class="display-5 display-md-4 fw-bold mb-3">
                <i class="fas fa-chart-line me-2 me-md-3"></i>
                <span class="d-block d-sm-inline">コポモ（CopoMo）</span>
            </h1>
            <p class="lead mb-3 mb-md-4">
                「コポモ」は、“Corporate Mood（企業のムード）”を読み取るアプリです。
            </p>
        </div>
    </div>
</div>

<!-- Search Section -->
<div class="row justify-content-center mb-4 mb-md-5">
    <div class="col-12 col-lg-10 col-xl-8">
        <div class="card analysis-card">
            <div class="card-body p-3 p-md-4">
                <h3 class="card-title text-center mb-3 mb-md-4">
                    <i class="fas fa-search text-primary me-2"></i>企業検索
                </h3>
                
                <div class="search-container position-relative">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-light border-end-0">
                            <i class="fas fa-building text-muted"></i>
                        </span>
                        <input type="text" 
                               class="form-control border-start-0" 
                               id="companySearch" 
                               placeholder="企業名または証券コード"
                               autocomplete="off"
                               aria-describedby="searchHelp">
                        <button class="btn btn-primary px-3 px-md-4" type="button" onclick="performDirectSearch()" 
                                aria-label="検索実行">
                            <i class="fas fa-search"></i>
                            <span class="d-none d-sm-inline ms-2">検索</span>
                        </button>
                    </div>
                    
                    <!-- Search Suggestions Dropdown -->
                    <div class="position-absolute w-100" style="z-index: 1050; top: 100%;">
                        <div id="searchSuggestions" class="search-suggestions" style="display: none;">
                            <!-- 候補数表示 -->
                            <div id="suggestionCount" class="suggestion-count" style="display: none;">
                                <i class="fas fa-list me-1"></i>
                                <span id="countText">0件の候補</span>
                            </div>
                            
                            <div id="suggestionsList">
                                <!-- Dynamic suggestions -->
                            </div>
                            
                            <div id="searchStatus" class="px-4 py-3 text-muted text-center" style="display: none;">
                                <i class="fas fa-spinner fa-spin me-2"></i>検索中...
                            </div>
                            
                            <div id="noResults" class="px-4 py-3 text-muted text-center" style="display: none;">
                                <i class="fas fa-search me-2"></i>該当する企業が見つかりませんでした
                                <div class="small mt-2">
                                    企業名の一部や証券コードで検索してください
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3 g-2">
                    <div class="col-12 col-md-8">
                        <small id="searchHelp" class="text-muted d-block">
                            <i class="fas fa-lightbulb me-1"></i>
                            <strong>検索のコツ:</strong> 企業名の一部、証券コード、EDINETコードで検索できます
                        </small>
                    </div>
                    <div class="col-12 col-md-4 text-md-end">
                        <small class="text-muted d-none d-md-block">
                            <i class="fas fa-keyboard me-1"></i>
                            <kbd>↑</kbd><kbd>↓</kbd>で選択、<kbd>Enter</kbd>で決定
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'earnings_analysis/ads/ad_responsive.html' %}
<!-- Process Flow -->
<div class="row justify-content-center mb-4 mb-md-5">
    <div class="col-12 col-lg-11">
        <div class="card">
            <div class="card-body p-3 p-md-4">
                <h4 class="text-center mb-3 mb-md-4">
                    <i class="fas fa-route text-success me-2"></i>簡単4ステップで分析実行
                </h4>
                <div class="row g-3">
                    <div class="col-6 col-md-3">
                        <div class="text-center p-2 p-md-3">
                            <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2 mb-md-3" 
                                 style="width: 40px; height: 40px; font-size: 1.1rem; font-weight: 600;">
                                1
                            </div>
                            <h6 class="mb-1 mb-md-2">企業検索</h6>
                            <small class="text-muted">企業名または証券コード</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="text-center p-2 p-md-3">
                            <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2 mb-md-3" 
                                 style="width: 40px; height: 40px; font-size: 1.1rem; font-weight: 600;">
                                2
                            </div>
                            <h6 class="mb-1 mb-md-2">企業選択</h6>
                            <small class="text-muted">企業詳細ページへ</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="text-center p-2 p-md-3">
                            <div class="bg-warning text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2 mb-md-3" 
                                 style="width: 40px; height: 40px; font-size: 1.1rem; font-weight: 600;">
                                3
                            </div>
                            <h6 class="mb-1 mb-md-2">分析実行</h6>
                            <small class="text-muted">ワンクリックまたは選択</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="text-center p-2 p-md-3">
                            <div class="bg-info text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2 mb-md-3" 
                                 style="width: 40px; height: 40px; font-size: 1.1rem; font-weight: 600;">
                                4
                            </div>
                            <h6 class="mb-1 mb-md-2">結果確認</h6>
                            <small class="text-muted">詳細分析結果</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics -->
<div class="row mb-4 mb-md-5 g-3">
    <div class="col-12 mb-3">
        <h3 class="text-center">
            <i class="fas fa-chart-bar text-primary me-2"></i>システム統計
        </h3>
    </div>
    
    <div class="col-6 col-md-3">
        <div class="card text-center h-100">
            <div class="card-body p-3">
                <i class="fas fa-building fa-2x fa-md-3x text-primary mb-2 mb-md-3"></i>
                <div class="h3 h-md-2 text-primary" data-count="{{ total_companies|default:0 }}">0</div>
                <div class="small text-muted">登録企業数</div>
            </div>
        </div>
    </div>
    
    <div class="col-6 col-md-3">
        <div class="card text-center h-100">
            <div class="card-body p-3">
                <i class="fas fa-file-alt fa-2x fa-md-3x text-success mb-2 mb-md-3"></i>
                <div class="h3 h-md-2 text-success" data-count="{{ total_documents|default:0 }}">0</div>
                <div class="small text-muted">利用可能書類数</div>
            </div>
        </div>
    </div>
    
    <div class="col-6 col-md-3">
        <div class="card text-center h-100">
            <div class="card-body p-3">
                <i class="fas fa-plus-circle fa-2x fa-md-3x text-info mb-2 mb-md-3"></i>
                <div class="h3 h-md-2 text-info" data-count="{{ recent_documents_count|default:0 }}">0</div>
                <div class="small text-muted">今週の新着</div>
            </div>
        </div>
    </div>
    
    <div class="col-6 col-md-3">
        <div class="card text-center h-100">
            <div class="card-body p-3">
                <i class="fas fa-brain fa-2x fa-md-3x text-warning mb-2 mb-md-3"></i>
                <div class="h3 h-md-2 text-warning">AI</div>
                <div class="small text-muted">分析機能</div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Access -->
<div class="row g-3">
    <div class="col-12 mb-3">
        <h3 class="text-center">
            <i class="fas fa-bolt text-primary me-2"></i>クイックアクセス
        </h3>
    </div>
    
    <div class="col-12 col-md-6">
        <div class="card h-100">
            <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-list text-primary me-3 fa-2x"></i>
                    <div>
                        <h5 class="card-title mb-1">書類一覧</h5>
                        <p class="card-text small text-muted mb-0">最近提出された書類を確認</p>
                    </div>
                </div>
                <div class="mt-auto">
                    <a href="{% url 'earnings_analysis:document-list-ui' %}" class="btn btn-primary w-100">
                        <i class="fas fa-arrow-right me-2"></i>書類一覧へ
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-12 col-md-6">
        <div class="card h-100">
            <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-rocket text-warning me-3 fa-2x"></i>
                    <div>
                        <h5 class="card-title mb-1">
                            ワンクリック分析
                            <span class="badge bg-danger small ms-1">NEW</span>
                        </h5>
                        <p class="card-text small text-muted mb-0">企業の最新決算書類を自動選択して包括分析</p>
                    </div>
                </div>
                <div class="small text-success mb-3">
                    <i class="fas fa-check me-1"></i>財務分析 + 感情分析を一括実行
                </div>
                <div class="mt-auto">
                    <button class="btn btn-warning w-100" onclick="showAnalysisInfo()">
                        <i class="fas fa-info-circle me-2"></i>詳細を見る
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Info Modal -->
<div class="modal fade" id="analysisInfoModal" tabindex="-1" aria-labelledby="analysisInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="analysisInfoModalLabel">
                    <i class="fas fa-rocket me-2"></i>ワンクリック包括分析について
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="閉じる"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-12">
                        <h6 class="text-primary">
                            <i class="fas fa-chart-pie me-2"></i>財務分析機能
                        </h6>
                        <ul class="list-unstyled ps-3">
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                キャッシュフロー構造分析（理想型、成長型、危険型等の判定）
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                財務健全性評価と投資リスク評価
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                投資推奨度の総合判定
                            </li>
                        </ul>
                    </div>
                    <div class="col-12">
                        <h6 class="text-warning">
                            <i class="fas fa-brain me-2"></i>感情分析機能
                        </h6>
                        <ul class="list-unstyled ps-3">
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                経営陣の自信度測定（決算説明書のテキスト分析）
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                ポジティブ・ネガティブ表現の自動検出
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                市場への影響予測
                            </li>
                        </ul>
                    </div>
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>分析時間:</strong> 約3-5分で包括的な分析結果をお届けします
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                <button type="button" class="btn btn-primary" onclick="startSearch()">
                    <i class="fas fa-search me-2"></i>企業検索を開始
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Search functionality
let searchTimeout;
let currentSuggestions = [];
let selectedIndex = -1;
let isSearching = false;

const searchInput = document.getElementById('companySearch');
const suggestionsContainer = document.getElementById('searchSuggestions');
const suggestionsList = document.getElementById('suggestionsList');
const searchStatus = document.getElementById('searchStatus');
const noResults = document.getElementById('noResults');
const suggestionCount = document.getElementById('suggestionCount');
const countText = document.getElementById('countText');

document.addEventListener('DOMContentLoaded', function() {
    setupSearchHandlers();
    animateNumbers();
});

function setupSearchHandlers() {
    if (!searchInput) return;
    
    searchInput.addEventListener('input', handleSearchInput);
    searchInput.addEventListener('keydown', handleKeyNavigation);
    searchInput.addEventListener('focus', function() {
        if (currentSuggestions.length > 0) {
            showSuggestions();
        }
    });
    
    document.addEventListener('click', handleOutsideClick);
}

function handleSearchInput(event) {
    const query = event.target.value.trim();
    clearTimeout(searchTimeout);
    
    if (query.length < 1) {
        hideSuggestions();
        return;
    }
    
    searchTimeout = setTimeout(() => {
        fetchCompanySuggestions(query);
    }, 300);
}

function handleKeyNavigation(event) {
    if (!suggestionsContainer.style.display || suggestionsContainer.style.display === 'none') {
        return;
    }
    
    switch (event.key) {
        case 'ArrowDown':
            event.preventDefault();
            navigateDown();
            break;
        case 'ArrowUp':
            event.preventDefault();
            navigateUp();
            break;
        case 'Enter':
            event.preventDefault();
            selectCurrent();
            break;
        case 'Escape':
            hideSuggestions();
            break;
    }
}

function navigateDown() {
    if (selectedIndex < currentSuggestions.length - 1) {
        selectedIndex++;
        updateSelectedItem();
    }
}

function navigateUp() {
    if (selectedIndex > 0) {
        selectedIndex--;
        updateSelectedItem();
    } else if (selectedIndex === 0) {
        selectedIndex = -1;
        updateSelectedItem();
    }
}

function updateSelectedItem() {
    const items = suggestionsList.querySelectorAll('.suggestion-item');
    
    items.forEach((item, index) => {
        if (index === selectedIndex) {
            item.classList.add('active');
            item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        } else {
            item.classList.remove('active');
        }
    });
    
    if (selectedIndex >= 0) {
        searchInput.value = currentSuggestions[selectedIndex].company_name;
    }
}

function handleKeyNavigation(event) {
    // 候補が表示されていない場合はキーナビゲーションを無効化
    if (!suggestionsContainer.style.display || suggestionsContainer.style.display === 'none') {
        if (event.key === 'Enter') {
            event.preventDefault();
            // 何もしない（直接検索を防ぐ）
            return;
        }
        return;
    }
    
    switch (event.key) {
        case 'ArrowDown':
            event.preventDefault();
            navigateDown();
            break;
        case 'ArrowUp':
            event.preventDefault();
            navigateUp();
            break;
        case 'Enter':
            event.preventDefault();
            selectCurrent();
            break;
        case 'Escape':
            hideSuggestions();
            break;
    }
}

function handleOutsideClick(event) {
    if (!event.target.closest('.search-container')) {
        hideSuggestions();
    }
}

async function fetchCompanySuggestions(query) {
    if (isSearching) return;
    
    isSearching = true;
    showSearchStatus();
    
    try {
        const response = await fetch(`/earnings_analysis/companies/search/?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        currentSuggestions = data.results || [];
        selectedIndex = -1;
        
        displaySuggestions(currentSuggestions, query);
        
    } catch (error) {
        console.error('Search error:', error);
        showError();
    } finally {
        isSearching = false;
        hideSearchStatus();
    }
}

function displaySuggestions(companies, query) {
    if (companies.length === 0) {
        showNoResults();
        return;
    }
    
    // 候補数の表示
    updateSuggestionCount(companies.length);
    
    suggestionsList.innerHTML = '';
    
    companies.forEach((company, index) => {
        const item = createSuggestionItem(company, index, query);
        suggestionsList.appendChild(item);
    });
    
    showSuggestions();
}

function updateSuggestionCount(count) {
    countText.textContent = `${count}件の候補が見つかりました`;
    suggestionCount.style.display = count > 0 ? 'block' : 'none';
}

function createSuggestionItem(company, index, query) {
    const item = document.createElement('div');
    item.className = 'suggestion-item';
    
    const matchBadge = getMatchTypeBadge(company.match_type);
    const analysisStatus = company.has_analysis_ready ? 
        '<span class="badge bg-success ms-2">分析可能</span>' : 
        '<span class="badge bg-secondary ms-2">書類のみ</span>';
    
    // 最新決算書類の表示名対応
    let latestDocInfo = '';
    if (company.latest_financial_date && company.latest_financial_type_name) {
        latestDocInfo = `
            <div class="latest-doc-info">
                <i class="fas fa-chart-line me-1"></i>
                <span class="doc-type-display">${company.latest_financial_type_name}</span>
                <small class="text-muted ms-1">(${new Date(company.latest_financial_date).toLocaleDateString('ja-JP')})</small>
            </div>
        `;
    }
    
    item.innerHTML = `
        <div class="d-flex justify-content-between align-items-start w-100">
            <div class="flex-grow-1 pe-3">
                <div class="fw-semibold mb-2" style="line-height: 1.3;">
                    ${highlightMatch(company.company_name, query)}
                    ${matchBadge}
                    ${analysisStatus}
                </div>
                <div class="small text-muted mb-2">
                    ${company.securities_code ? `証券: <strong>${company.securities_code}</strong>` : ''}
                    ${company.securities_code && company.edinet_code ? ' | ' : ''}
                    EDINET: ${company.edinet_code}
                </div>
                ${latestDocInfo}
            </div>
            <div class="text-end flex-shrink-0">
                <div class="badge bg-primary rounded-pill mb-1">${company.document_count}件</div>
                ${company.financial_count > 0 ? `
                    <div class="small text-success">
                        <i class="fas fa-rocket me-1"></i>決算${company.financial_count}件
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    item.addEventListener('click', () => selectCompany(company));
    item.addEventListener('mouseenter', () => {
        selectedIndex = index;
        updateSelectedItem();
    });
    
    return item;
}

function getMatchTypeBadge(matchType) {
    const badges = {
        'securities_exact': '<span class="badge bg-warning text-dark">証券コード</span>',
        'name_prefix': '<span class="badge bg-info">前方一致</span>',
        'securities_prefix': '<span class="badge bg-warning text-dark">証券コード</span>',
        'name_partial': '<span class="badge bg-secondary">部分一致</span>',
        'other': ''
    };
    return badges[matchType] || '';
}

function highlightMatch(text, query) {
    if (!query) return escapeHtml(text);
    
    const escapedText = escapeHtml(text);
    const escapedQuery = escapeHtml(query);
    
    const regex = new RegExp(`(${escapedQuery})`, 'gi');
    return escapedText.replace(regex, '<mark>$1</mark>');
}

function selectCompany(company) {
    searchInput.value = company.company_name;
    hideSuggestions();
    
    const url = `/earnings_analysis/company/${company.edinet_code}/`;
    
    searchInput.value = `${company.company_name} - 移動中...`;
    searchInput.disabled = true;
    
    setTimeout(() => {
        window.location.href = url;
    }, 200);
}

function performDirectSearch() {
    const query = searchInput.value.trim();
    
    if (query) {
        const url = `/earnings_analysis/documents/?company=${encodeURIComponent(query)}`;
        window.location.href = url;
    }
}

function showSuggestions() {
    suggestionsContainer.style.display = 'block';
    hideSearchStatus();
    hideNoResults();
}

function hideSuggestions() {
    suggestionsContainer.style.display = 'none';
    selectedIndex = -1;
    suggestionCount.style.display = 'none';
}

function showSearchStatus() {
    hideNoResults();
    suggestionCount.style.display = 'none';
    searchStatus.style.display = 'block';
    suggestionsContainer.style.display = 'block';
}

function hideSearchStatus() {
    searchStatus.style.display = 'none';
}

function showNoResults() {
    hideSearchStatus();
    suggestionCount.style.display = 'none';
    noResults.style.display = 'block';
    suggestionsContainer.style.display = 'block';
}

function hideNoResults() {
    noResults.style.display = 'none';
}

function showError() {
    hideSearchStatus();
    hideNoResults();
    suggestionCount.style.display = 'none';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Number animation
function animateNumbers() {
    const numberElements = document.querySelectorAll('[data-count]');
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const element = entry.target;
                const finalValue = parseInt(element.dataset.count);
                
                if (!isNaN(finalValue)) {
                    animateNumber(element, 0, finalValue, 2000);
                }
                
                observer.unobserve(element);
            }
        });
    });
    
    numberElements.forEach(element => observer.observe(element));
}

function animateNumber(element, start, end, duration) {
    const startTime = performance.now();
    
    function updateNumber(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        const current = Math.floor(start + (end - start) * progress);
        element.textContent = current.toLocaleString();
        
        if (progress < 1) {
            requestAnimationFrame(updateNumber);
        }
    }
    
    requestAnimationFrame(updateNumber);
}

// Modal functions
function showAnalysisInfo() {
    const modal = new bootstrap.Modal(document.getElementById('analysisInfoModal'));
    modal.show();
}

function startSearch() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('analysisInfoModal'));
    modal.hide();
    searchInput.focus();
}
</script>
{% endblock %}