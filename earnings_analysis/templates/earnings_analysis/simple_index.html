<!-- earnings_analysis/templates/earnings_analysis/simple_index_improved.html -->
{% extends 'earnings_analysis/simple_base.html' %}

{% block title %}ホーム - コポモ{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ============================================
   ホームページ専用スタイル
   ============================================ */
:root {
    --primary-500: #3b82f6;
    --primary-600: #2563eb;
    --primary-700: #1d4ed8;
    --primary-100: #dbeafe;
    --success-500: #10b981;
    --success-600: #059669;
    --warning-500: #f59e0b;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --radius-2xl: 1.5rem;
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
}

body {
    font-family: 'Noto Sans JP', sans-serif;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    min-height: 100vh;
}

/* ヒーローセクション */
.hero-section {
    background: linear-gradient(135deg, var(--primary-600) 0%, #4f46e5 50%, #7c3aed 100%);
    color: white;
    padding: 3rem 1.5rem;
    border-radius: var(--radius-2xl);
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}

.hero-section::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 60%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
    pointer-events: none;
}

.hero-title {
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.hero-subtitle {
    font-size: 1rem;
    opacity: 0.95;
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.7;
}

@media (min-width: 768px) {
    .hero-section {
        padding: 4rem 2rem;
    }
    .hero-title {
        font-size: 2.75rem;
    }
    .hero-subtitle {
        font-size: 1.125rem;
    }
}

/* 検索セクション */
.search-section {
    background: white;
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
    position: relative;
}

@media (min-width: 768px) {
    .search-section {
        padding: 2rem;
    }
}

.search-title {
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.search-input-wrapper {
    position: relative;
}

.search-input-group {
    display: flex;
    gap: 0;
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 2px solid var(--gray-200);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.search-input-group:focus-within {
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px var(--primary-100);
}

.search-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 52px;
    background: var(--gray-50);
    color: var(--gray-400);
    flex-shrink: 0;
}

.search-input {
    flex: 1;
    border: none;
    padding: 1rem;
    font-size: 1rem;
    min-height: 52px;
    background: white;
}

.search-input:focus {
    outline: none;
}

.search-input::placeholder {
    color: var(--gray-400);
}

.search-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0 1.5rem;
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    color: white;
    border: none;
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 100px;
}

.search-btn:hover {
    background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
}

@media (max-width: 575.98px) {
    .search-btn span {
        display: none;
    }
    .search-btn {
        min-width: 52px;
        padding: 0 1rem;
    }
}

.search-hint {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.75rem;
    font-size: 0.8125rem;
    color: var(--gray-500);
}

/* 検索候補ドロップダウン */
.search-suggestions {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    right: 0;
    background: white;
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--gray-200);
    max-height: 65vh;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.suggestion-header {
    position: sticky;
    top: 0;
    background: var(--gray-50);
    padding: 0.75rem 1rem;
    font-size: 0.8125rem;
    color: var(--gray-500);
    border-bottom: 1px solid var(--gray-100);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.suggestion-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-bottom: 1px solid var(--gray-100);
    cursor: pointer;
    transition: background 0.15s ease;
    min-height: 72px;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-item:hover,
.suggestion-item.active {
    background: var(--primary-100);
}

.suggestion-item-icon {
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--gray-100);
    color: var(--gray-500);
    border-radius: var(--radius-lg);
    flex-shrink: 0;
}

.suggestion-item:hover .suggestion-item-icon,
.suggestion-item.active .suggestion-item-icon {
    background: var(--primary-500);
    color: white;
}

.suggestion-item-content {
    flex: 1;
    min-width: 0;
}

.suggestion-item-title {
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.suggestion-item-title mark {
    background: #fef3c7;
    color: #d97706;
    padding: 0 4px;
    border-radius: 4px;
    font-weight: 600;
}

.suggestion-item-meta {
    font-size: 0.8125rem;
    color: var(--gray-500);
}

.suggestion-item-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.125rem 0.5rem;
    background: var(--primary-100);
    color: var(--primary-700);
    border-radius: 9999px;
    font-size: 0.6875rem;
    font-weight: 600;
}

.suggestion-item-count {
    text-align: right;
    flex-shrink: 0;
}

.suggestion-item-count-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--primary-600);
}

.suggestion-item-count-label {
    font-size: 0.6875rem;
    color: var(--gray-500);
}

.search-loading,
.search-no-results {
    padding: 2rem;
    text-align: center;
    color: var(--gray-500);
}

.search-loading i {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    color: var(--primary-500);
}

/* プロセスフロー */
.process-section {
    background: white;
    border-radius: var(--radius-xl);
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

@media (min-width: 768px) {
    .process-section {
        padding: 2rem;
    }
}

.process-title {
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: 1.5rem;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.process-steps {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

@media (min-width: 768px) {
    .process-steps {
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
    }
}

.process-step {
    text-align: center;
    padding: 1rem;
    position: relative;
}

.process-step-number {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.75rem;
    border-radius: 50%;
    font-weight: 700;
    font-size: 1rem;
    color: white;
}

.process-step:nth-child(1) .process-step-number { background: var(--primary-500); }
.process-step:nth-child(2) .process-step-number { background: var(--success-500); }
.process-step:nth-child(3) .process-step-number { background: var(--warning-500); }
.process-step:nth-child(4) .process-step-number { background: #8b5cf6; }

.process-step-title {
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: 0.25rem;
    font-size: 0.9375rem;
}

.process-step-desc {
    font-size: 0.8125rem;
    color: var(--gray-500);
}

/* ステップ間の矢印（PC表示時のみ） */
@media (min-width: 768px) {
    .process-step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 28px;
        right: -12px;
        width: 24px;
        height: 2px;
        background: var(--gray-200);
    }
}

/* 統計セクション */
.stats-section {
    margin-bottom: 2rem;
}

.stats-title {
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: 1rem;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

@media (min-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

.stat-card {
    background: white;
    border-radius: var(--radius-xl);
    box-shadow: 0 2px 4px rgb(0 0 0 / 0.05);
    padding: 1.25rem;
    text-align: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgb(0 0 0 / 0.1);
}

.stat-icon {
    width: 48px;
    height: 48px;
    margin: 0 auto 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-lg);
    font-size: 1.25rem;
}

.stat-icon-primary { background: var(--primary-100); color: var(--primary-600); }
.stat-icon-success { background: #d1fae5; color: var(--success-600); }
.stat-icon-info { background: #e0e7ff; color: #4f46e5; }
.stat-icon-warning { background: #fef3c7; color: #d97706; }

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: 0.125rem;
}

.stat-label {
    font-size: 0.75rem;
    color: var(--gray-500);
}

/* クイックアクセス */
.quick-access-section {
    margin-bottom: 2rem;
}

.quick-access-title {
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: 1rem;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.quick-access-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
}

@media (min-width: 768px) {
    .quick-access-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

.quick-access-card {
    background: white;
    border-radius: var(--radius-xl);
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.quick-access-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.quick-access-header {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.quick-access-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-lg);
    font-size: 1.25rem;
    flex-shrink: 0;
}

.quick-access-icon-primary { background: var(--primary-100); color: var(--primary-600); }
.quick-access-icon-warning { background: #fef3c7; color: #d97706; }

.quick-access-info h5 {
    font-weight: 700;
    color: var(--gray-800);
    margin: 0 0 0.25rem;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.quick-access-info p {
    font-size: 0.875rem;
    color: var(--gray-500);
    margin: 0;
}

.quick-access-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.125rem 0.5rem;
    background: #fee2e2;
    color: #dc2626;
    border-radius: 9999px;
    font-size: 0.6875rem;
    font-weight: 600;
}

.quick-access-features {
    font-size: 0.8125rem;
    color: var(--success-600);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.quick-access-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.875rem 1.5rem;
    border-radius: var(--radius-lg);
    font-weight: 600;
    font-size: 0.9375rem;
    text-decoration: none;
    transition: all 0.2s ease;
    min-height: 48px;
}

.quick-access-btn-primary {
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    color: white;
}

.quick-access-btn-primary:hover {
    background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
    transform: translateY(-1px);
    text-decoration: none;
    color: white;
}

.quick-access-btn-outline {
    background: white;
    border: 2px solid var(--gray-200);
    color: var(--gray-700);
}

.quick-access-btn-outline:hover {
    border-color: var(--primary-500);
    color: var(--primary-600);
    background: var(--primary-100);
    text-decoration: none;
}

/* アニメーション */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-fade-in-up {
    animation: fadeInUp 0.5s ease-out forwards;
}

.delay-1 { animation-delay: 0.1s; }
.delay-2 { animation-delay: 0.2s; }
.delay-3 { animation-delay: 0.3s; }

/* スピナー */
@keyframes spin {
    to { transform: rotate(360deg); }
}

.fa-spin {
    animation: spin 1s linear infinite;
}
</style>
{% endblock %}

{% block content %}
<!-- ヒーローセクション -->
<section class="hero-section text-center animate-fade-in-up">
    <h1 class="hero-title">
        <i class="fas fa-chart-line"></i>
        <span>コポモ（CopoMo）</span>
    </h1>
    <p class="hero-subtitle">
        企業の決算書類をAIが分析し、経営陣のムード（感情）を可視化。<br class="d-none d-md-inline">
        投資判断をサポートする新しい分析ツールです。
    </p>
</section>

{% include 'earnings_analysis/ads/ad_responsive.html' %}

<!-- 検索セクション -->
<section class="search-section animate-fade-in-up delay-1">
    <h2 class="search-title">
        <i class="fas fa-search text-primary"></i>
        企業を検索
    </h2>
    
    <div class="search-input-wrapper">
        <div class="search-input-group">
            <div class="search-icon">
                <i class="fas fa-building"></i>
            </div>
            <input type="text" 
                   class="search-input" 
                   id="companySearch"
                   placeholder="企業名または証券コードを入力"
                   autocomplete="off"
                   aria-label="企業検索">
            <button type="button" class="search-btn" onclick="performDirectSearch()" aria-label="検索">
                <i class="fas fa-search"></i>
                <span>検索</span>
            </button>
        </div>
        
        <!-- 検索候補 -->
        <div id="searchSuggestions" class="search-suggestions">
            <div id="suggestionHeader" class="suggestion-header" style="display: none;">
                <i class="fas fa-lightbulb"></i>
                <span id="suggestionCount">0件の候補</span>
            </div>
            <div id="suggestionsList"></div>
            <div id="searchLoading" class="search-loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
                <div>検索中...</div>
            </div>
            <div id="searchNoResults" class="search-no-results" style="display: none;">
                <i class="fas fa-search mb-2" style="font-size: 1.5rem;"></i>
                <div>該当する企業が見つかりませんでした</div>
                <div class="mt-2" style="font-size: 0.8125rem;">
                    企業名の一部や証券コードで検索してください
                </div>
            </div>
        </div>
    </div>
    
    <div class="search-hint">
        <i class="fas fa-lightbulb"></i>
        <span>企業名の一部、証券コード、EDINETコードで検索できます</span>
    </div>
</section>

<!-- プロセスフロー -->
<section class="process-section animate-fade-in-up delay-2">
    <h3 class="process-title">
        <i class="fas fa-route text-success"></i>
        かんたん4ステップで分析
    </h3>
    
    <div class="process-steps">
        <div class="process-step">
            <div class="process-step-number">1</div>
            <div class="process-step-title">企業検索</div>
            <div class="process-step-desc">企業名またはコード</div>
        </div>
        <div class="process-step">
            <div class="process-step-number">2</div>
            <div class="process-step-title">企業選択</div>
            <div class="process-step-desc">詳細ページへ移動</div>
        </div>
        <div class="process-step">
            <div class="process-step-number">3</div>
            <div class="process-step-title">分析実行</div>
            <div class="process-step-desc">ワンクリックで開始</div>
        </div>
        <div class="process-step">
            <div class="process-step-number">4</div>
            <div class="process-step-title">結果確認</div>
            <div class="process-step-desc">AIによる詳細分析</div>
        </div>
    </div>
</section>

<!-- 統計セクション -->
<section class="stats-section animate-fade-in-up delay-3">
    <h3 class="stats-title">
        <i class="fas fa-chart-bar text-primary"></i>
        システム統計
    </h3>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon stat-icon-primary">
                <i class="fas fa-building"></i>
            </div>
            <div class="stat-value" data-count="{{ total_companies|default:0 }}">0</div>
            <div class="stat-label">登録企業数</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon stat-icon-success">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="stat-value" data-count="{{ total_documents|default:0 }}">0</div>
            <div class="stat-label">利用可能書類数</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon stat-icon-info">
                <i class="fas fa-plus-circle"></i>
            </div>
            <div class="stat-value" data-count="{{ recent_documents_count|default:0 }}">0</div>
            <div class="stat-label">今週の新着</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon stat-icon-warning">
                <i class="fas fa-brain"></i>
            </div>
            <div class="stat-value">AI</div>
            <div class="stat-label">分析機能</div>
        </div>
    </div>
</section>

<!-- クイックアクセス -->
<section class="quick-access-section">
    <h3 class="quick-access-title">
        <i class="fas fa-bolt text-warning"></i>
        クイックアクセス
    </h3>
    
    <div class="quick-access-grid">
        <div class="quick-access-card">
            <div class="quick-access-header">
                <div class="quick-access-icon quick-access-icon-primary">
                    <i class="fas fa-list"></i>
                </div>
                <div class="quick-access-info">
                    <h5>書類一覧</h5>
                    <p>最近提出された書類を確認</p>
                </div>
            </div>
            <a href="{% url 'copomo:document-list-ui' %}" class="quick-access-btn quick-access-btn-primary">
                <i class="fas fa-arrow-right"></i>
                書類一覧へ
            </a>
        </div>
        
        <div class="quick-access-card">
            <div class="quick-access-header">
                <div class="quick-access-icon quick-access-icon-warning">
                    <i class="fas fa-rocket"></i>
                </div>
                <div class="quick-access-info">
                    <h5>
                        ワンクリック分析
                        <span class="quick-access-badge">NEW</span>
                    </h5>
                    <p>最新決算書類を自動選択して包括分析</p>
                </div>
            </div>
            <div class="quick-access-features">
                <i class="fas fa-check"></i>
                財務分析 + 感情分析を一括実行
            </div>
            <button class="quick-access-btn quick-access-btn-outline" onclick="showAnalysisInfo()">
                <i class="fas fa-info-circle"></i>
                詳細を見る
            </button>
        </div>
    </div>
</section>

{% include 'earnings_analysis/ads/ad_responsive.html' %}

<!-- 分析情報モーダル -->
<div class="modal fade" id="analysisInfoModal" tabindex="-1" aria-labelledby="analysisInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="border-radius: var(--radius-xl); overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-600), #4f46e5); color: white; border: none;">
                <h5 class="modal-title" id="analysisInfoModalLabel">
                    <i class="fas fa-rocket me-2"></i>ワンクリック包括分析
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="閉じる"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div style="background: var(--primary-50); border-radius: var(--radius-lg); padding: 1.25rem;">
                            <h6 style="color: var(--primary-700); margin-bottom: 1rem;">
                                <i class="fas fa-chart-pie me-2"></i>財務分析機能
                            </h6>
                            <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.875rem;">
                                <li style="margin-bottom: 0.5rem;">
                                    <i class="fas fa-check text-success me-2"></i>
                                    キャッシュフロー構造分析
                                </li>
                                <li style="margin-bottom: 0.5rem;">
                                    <i class="fas fa-check text-success me-2"></i>
                                    財務健全性評価
                                </li>
                                <li>
                                    <i class="fas fa-check text-success me-2"></i>
                                    投資推奨度の総合判定
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div style="background: #fef3c7; border-radius: var(--radius-lg); padding: 1.25rem;">
                            <h6 style="color: #d97706; margin-bottom: 1rem;">
                                <i class="fas fa-brain me-2"></i>感情分析機能
                            </h6>
                            <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.875rem;">
                                <li style="margin-bottom: 0.5rem;">
                                    <i class="fas fa-check text-success me-2"></i>
                                    経営陣の自信度測定
                                </li>
                                <li style="margin-bottom: 0.5rem;">
                                    <i class="fas fa-check text-success me-2"></i>
                                    ポジティブ・ネガティブ検出
                                </li>
                                <li>
                                    <i class="fas fa-check text-success me-2"></i>
                                    市場への影響予測
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info mt-4 mb-0" style="border-radius: var(--radius-lg);">
                    <i class="fas fa-clock me-2"></i>
                    <strong>分析時間:</strong> 約3-5分で包括的な分析結果をお届けします
                </div>
            </div>
            <div class="modal-footer" style="border: none; padding: 1rem 1.5rem 1.5rem;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: var(--radius-lg);">閉じる</button>
                <button type="button" class="btn btn-primary" onclick="startSearch()" style="border-radius: var(--radius-lg);">
                    <i class="fas fa-search me-2"></i>企業検索を開始
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 検索機能
let searchTimeout;
let currentSuggestions = [];
let selectedIndex = -1;
let isSearching = false;

const searchInput = document.getElementById('companySearch');
const suggestionsContainer = document.getElementById('searchSuggestions');
const suggestionsList = document.getElementById('suggestionsList');
const suggestionHeader = document.getElementById('suggestionHeader');
const suggestionCountEl = document.getElementById('suggestionCount');
const searchLoading = document.getElementById('searchLoading');
const searchNoResults = document.getElementById('searchNoResults');

document.addEventListener('DOMContentLoaded', function() {
    setupSearchHandlers();
    animateNumbers();
});

function setupSearchHandlers() {
    if (!searchInput) return;
    
    searchInput.addEventListener('input', handleSearchInput);
    searchInput.addEventListener('keydown', handleKeyNavigation);
    searchInput.addEventListener('focus', function() {
        if (currentSuggestions.length > 0) {
            showSuggestions();
        }
    });
    
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.search-input-wrapper')) {
            hideSuggestions();
        }
    });
}

function handleSearchInput(event) {
    const query = event.target.value.trim();
    clearTimeout(searchTimeout);
    
    if (query.length < 1) {
        hideSuggestions();
        return;
    }
    
    searchTimeout = setTimeout(() => {
        fetchCompanySuggestions(query);
    }, 300);
}

function handleKeyNavigation(event) {
    if (suggestionsContainer.style.display === 'none') {
        if (event.key === 'Enter') {
            event.preventDefault();
        }
        return;
    }
    
    switch (event.key) {
        case 'ArrowDown':
            event.preventDefault();
            if (selectedIndex < currentSuggestions.length - 1) {
                selectedIndex++;
                updateSelectedItem();
            }
            break;
        case 'ArrowUp':
            event.preventDefault();
            if (selectedIndex > 0) {
                selectedIndex--;
                updateSelectedItem();
            }
            break;
        case 'Enter':
            event.preventDefault();
            if (selectedIndex >= 0) {
                selectCompany(currentSuggestions[selectedIndex]);
            }
            break;
        case 'Escape':
            hideSuggestions();
            break;
    }
}

function updateSelectedItem() {
    const items = suggestionsList.querySelectorAll('.suggestion-item');
    items.forEach((item, index) => {
        item.classList.toggle('active', index === selectedIndex);
        if (index === selectedIndex) {
            item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
    });
}

async function fetchCompanySuggestions(query) {
    if (isSearching) return;
    
    isSearching = true;
    showSearchLoading();
    
    try {
        const response = await fetch(`/copomo/companies/search/?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.error) throw new Error(data.error);
        
        currentSuggestions = data.results || [];
        selectedIndex = -1;
        
        displaySuggestions(currentSuggestions, query);
    } catch (error) {
        console.error('Search error:', error);
        showNoResults();
    } finally {
        isSearching = false;
        hideSearchLoading();
    }
}

function displaySuggestions(companies, query) {
    if (companies.length === 0) {
        showNoResults();
        return;
    }
    
    suggestionCountEl.textContent = `${companies.length}件の候補`;
    suggestionHeader.style.display = 'flex';
    searchNoResults.style.display = 'none';
    
    suggestionsList.innerHTML = '';
    
    companies.forEach((company, index) => {
        const item = createSuggestionItem(company, index, query);
        suggestionsList.appendChild(item);
    });
    
    showSuggestions();
}

function createSuggestionItem(company, index, query) {
    const item = document.createElement('div');
    item.className = 'suggestion-item';
    
    const badge = company.has_analysis_ready 
        ? '<span class="suggestion-item-badge"><i class="fas fa-check"></i> 分析可</span>'
        : '';
    
    item.innerHTML = `
        <div class="suggestion-item-icon">
            <i class="fas fa-building"></i>
        </div>
        <div class="suggestion-item-content">
            <div class="suggestion-item-title">
                ${highlightMatch(company.company_name, query)}
                ${badge}
            </div>
            <div class="suggestion-item-meta">
                ${company.securities_code ? `証券: <strong>${company.securities_code}</strong>` : ''}
                ${company.securities_code ? ' | ' : ''}
                EDINET: ${company.edinet_code}
            </div>
        </div>
        <div class="suggestion-item-count">
            <div class="suggestion-item-count-value">${company.document_count}</div>
            <div class="suggestion-item-count-label">書類</div>
        </div>
    `;
    
    item.addEventListener('click', () => selectCompany(company));
    item.addEventListener('mouseenter', () => {
        selectedIndex = index;
        updateSelectedItem();
    });
    
    return item;
}

function highlightMatch(text, query) {
    if (!query) return escapeHtml(text);
    const escapedText = escapeHtml(text);
    const escapedQuery = escapeHtml(query);
    const regex = new RegExp(`(${escapedQuery})`, 'gi');
    return escapedText.replace(regex, '<mark>$1</mark>');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function selectCompany(company) {
    searchInput.value = company.company_name + ' - 移動中...';
    searchInput.disabled = true;
    hideSuggestions();
    
    setTimeout(() => {
        window.location.href = `/copomo/company/${company.edinet_code}/`;
    }, 200);
}

function performDirectSearch() {
    const query = searchInput.value.trim();
    if (query) {
        window.location.href = `/copomo/documents/?company=${encodeURIComponent(query)}`;
    }
}

function showSuggestions() {
    suggestionsContainer.style.display = 'block';
}

function hideSuggestions() {
    suggestionsContainer.style.display = 'none';
    selectedIndex = -1;
}

function showSearchLoading() {
    suggestionHeader.style.display = 'none';
    searchNoResults.style.display = 'none';
    searchLoading.style.display = 'block';
    suggestionsContainer.style.display = 'block';
}

function hideSearchLoading() {
    searchLoading.style.display = 'none';
}

function showNoResults() {
    suggestionHeader.style.display = 'none';
    searchLoading.style.display = 'none';
    searchNoResults.style.display = 'block';
    suggestionsContainer.style.display = 'block';
}

// 数値アニメーション
function animateNumbers() {
    const numberElements = document.querySelectorAll('[data-count]');
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const element = entry.target;
                const finalValue = parseInt(element.dataset.count);
                
                if (!isNaN(finalValue)) {
                    animateNumber(element, 0, finalValue, 2000);
                }
                
                observer.unobserve(element);
            }
        });
    });
    
    numberElements.forEach(element => observer.observe(element));
}

function animateNumber(element, start, end, duration) {
    const startTime = performance.now();
    
    function updateNumber(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const current = Math.floor(start + (end - start) * easeOutQuart(progress));
        element.textContent = current.toLocaleString();
        
        if (progress < 1) {
            requestAnimationFrame(updateNumber);
        }
    }
    
    requestAnimationFrame(updateNumber);
}

function easeOutQuart(x) {
    return 1 - Math.pow(1 - x, 4);
}

// モーダル
function showAnalysisInfo() {
    const modal = new bootstrap.Modal(document.getElementById('analysisInfoModal'));
    modal.show();
}

function startSearch() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('analysisInfoModal'));
    modal.hide();
    searchInput.focus();
}
</script>
{% endblock %}