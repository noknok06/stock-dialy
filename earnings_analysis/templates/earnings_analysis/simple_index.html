<!-- earnings_analysis/templates/earnings_analysis/simple_index.html（企業詳細対応版） -->
{% extends 'earnings_analysis/simple_base.html' %}

{% block title %}ホーム - 決算書類管理システム{% endblock %}

{% block content %}
<!-- ヒーローセクション -->
<div class="bg-primary text-white rounded p-5 mb-4">
    <div class="text-center">
        <h1 class="display-4 fw-bold mb-3">
            <i class="fas fa-chart-line me-3"></i>決算書類管理システム
        </h1>
        <p class="lead mb-4">
            EDINET APIを活用した企業書類検索・ダウンロードシステム
        </p>
        <div class="badge bg-warning text-dark fs-6 px-3 py-2">
            <i class="fas fa-rocket me-1"></i>新機能: ワンクリック包括分析
        </div>
    </div>
</div>

<!-- 検索セクション -->
<div class="row justify-content-center mb-5">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <h3 class="card-title text-center mb-4">
                    <i class="fas fa-search text-primary me-2"></i>企業検索
                </h3>
                
                <div class="position-relative">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-light">
                            <i class="fas fa-building text-muted"></i>
                        </span>
                        <input type="text" 
                               class="form-control" 
                               id="companySearch" 
                               placeholder="企業名または証券コードを入力（例: トヨタ、ソニー、7203）"
                               autocomplete="off"
                               aria-describedby="searchHelp">
                        <button class="btn btn-primary" type="button" onclick="performDirectSearch()" title="直接検索">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <!-- 検索候補ドロップダウン -->
                    <div class="position-absolute w-100" style="z-index: 1050; top: 100%;">
                        <div id="searchSuggestions" class="dropdown-menu w-100 shadow-lg" style="display: none; max-height: 400px; overflow-y: auto;">
                            <div id="suggestionsList">
                                <!-- 動的に生成される候補リスト -->
                            </div>
                            <div id="searchStatus" class="px-3 py-2 text-muted small" style="display: none;">
                                <i class="fas fa-spinner fa-spin me-1"></i>検索中...
                            </div>
                            <div id="noResults" class="px-3 py-2 text-muted text-center" style="display: none;">
                                <i class="fas fa-search me-1"></i>該当する企業が見つかりませんでした
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-8">
                        <small id="searchHelp" class="text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            <strong>検索のコツ:</strong> 企業名の一部（「トヨタ」「ソニー」）、証券コード（「7203」）、EDINETコード（「E02144」）で検索できます
                        </small>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <small class="text-muted">
                            <i class="fas fa-keyboard me-1"></i>
                            <kbd>↑</kbd><kbd>↓</kbd>で選択、<kbd>Enter</kbd>で決定
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- フロー改善の説明 -->
<div class="row justify-content-center mb-5">
    <div class="col-lg-10">
        <div class="card bg-light">
            <div class="card-body">
                <h4 class="text-center mb-4">
                    <i class="fas fa-route text-success me-2"></i>簡単4ステップで分析実行
                </h4>
                <div class="row text-center">
                    <div class="col-md-3 mb-3">
                        <div class="p-3">
                            <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2" 
                                 style="width: 50px; height: 50px;">
                                <span class="fw-bold">1</span>
                            </div>
                            <h6>企業検索</h6>
                            <small class="text-muted">企業名または証券コードで検索</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="p-3">
                            <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2" 
                                 style="width: 50px; height: 50px;">
                                <span class="fw-bold">2</span>
                            </div>
                            <h6>企業選択</h6>
                            <small class="text-muted">企業詳細ページへ移動</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="p-3">
                            <div class="bg-warning text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2" 
                                 style="width: 50px; height: 50px;">
                                <span class="fw-bold">3</span>
                            </div>
                            <h6>分析実行</h6>
                            <small class="text-muted">ワンクリックまたは書類選択</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="p-3">
                            <div class="bg-info text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2" 
                                 style="width: 50px; height: 50px;">
                                <span class="fw-bold">4</span>
                            </div>
                            <h6>結果確認</h6>
                            <small class="text-muted">詳細分析結果を確認</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 統計情報 -->
<div class="row mb-5">
    <div class="col-12 mb-4">
        <h3 class="text-center">
            <i class="fas fa-chart-bar text-primary me-2"></i>システム統計
        </h3>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card stats-card text-center">
            <div class="card-body">
                <i class="fas fa-building fa-3x text-primary mb-3"></i>
                <div class="h2 text-primary">{{ total_companies|default:0 }}</div>
                <div class="text-muted">登録企業数</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card stats-card text-center">
            <div class="card-body">
                <i class="fas fa-file-alt fa-3x text-success mb-3"></i>
                <div class="h2 text-success">{{ total_documents|default:0 }}</div>
                <div class="text-muted">利用可能書類数</div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card stats-card text-center">
            <div class="card-body">
                <i class="fas fa-plus-circle fa-3x text-info mb-3"></i>
                <div class="h2 text-info">{{ recent_documents_count|default:0 }}</div>
                <div class="text-muted">今週の新着</div>
            </div>
        </div>
    </div>
</div>

<!-- クイックアクセス -->
<div class="row">
    <div class="col-12 mb-4">
        <h3 class="text-center">
            <i class="fas fa-bolt text-primary me-2"></i>クイックアクセス
        </h3>
    </div>
    
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-list text-primary me-2"></i>書類一覧
                </h5>
                <p class="card-text">最近提出された書類を確認</p>
                <a href="{% url 'earnings_analysis:document-list-ui' %}" class="btn btn-primary">
                    <i class="fas fa-arrow-right me-1"></i>書類一覧へ
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-rocket text-warning me-2"></i>NEW: ワンクリック分析
                </h5>
                <p class="card-text">企業の最新決算書類を自動選択して包括分析</p>
                <div class="small text-muted">
                    <i class="fas fa-check me-1"></i>財務分析 + 感情分析を一括実行
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 検索関連のグローバル変数
let searchTimeout;
let currentSuggestions = [];
let selectedIndex = -1;
let isSearching = false;

// デバッグモード（本番環境では false に設定）
const DEBUG_MODE = true;

// ログ出力関数
function debugLog(message, data = null) {
    if (DEBUG_MODE) {
        console.log('[企業検索]', message, data || '');
    }
}

// DOM要素の取得
const searchInput = document.getElementById('companySearch');
const suggestionsContainer = document.getElementById('searchSuggestions');
const suggestionsList = document.getElementById('suggestionsList');
const searchStatus = document.getElementById('searchStatus');
const noResults = document.getElementById('noResults');

// 初期化
document.addEventListener('DOMContentLoaded', function() {
    debugLog('企業検索機能を初期化中...');
    setupSearchHandlers();
    
    // 接続テスト
    testApiConnection();
});

function testApiConnection() {
    debugLog('API接続テスト中...');
    fetch('/earnings_analysis/companies/search/?q=test')
        .then(response => {
            debugLog('API応答ステータス:', response.status);
            return response.json();
        })
        .then(data => {
            debugLog('API接続テスト成功:', data);
        })
        .catch(error => {
            debugLog('API接続テストエラー:', error);
            console.error('企業検索API接続エラー:', error);
        });
}

function setupSearchHandlers() {
    if (!searchInput) {
        debugLog('エラー: 検索入力フィールドが見つかりません');
        return;
    }
    
    // 入力イベント
    searchInput.addEventListener('input', handleSearchInput);
    
    // キーボードナビゲーション
    searchInput.addEventListener('keydown', handleKeyNavigation);
    
    // フォーカス外し
    document.addEventListener('click', handleOutsideClick);
    
    // フォーカス時の候補再表示
    searchInput.addEventListener('focus', function() {
        if (currentSuggestions.length > 0) {
            showSuggestions();
        }
    });
    
    debugLog('検索ハンドラー設定完了');
}

function handleSearchInput(event) {
    const query = event.target.value.trim();
    debugLog('検索入力:', query);
    
    clearTimeout(searchTimeout);
    
    if (query.length < 1) {
        hideSuggestions();
        return;
    }
    
    // デバウンス処理
    searchTimeout = setTimeout(() => {
        fetchCompanySuggestions(query);
    }, 300);
}

function handleKeyNavigation(event) {
    if (!suggestionsContainer.style.display || suggestionsContainer.style.display === 'none') {
        return;
    }
    
    switch (event.key) {
        case 'ArrowDown':
            event.preventDefault();
            navigateDown();
            break;
        case 'ArrowUp':
            event.preventDefault();
            navigateUp();
            break;
        case 'Enter':
            event.preventDefault();
            selectCurrent();
            break;
        case 'Escape':
            hideSuggestions();
            searchInput.blur();
            break;
    }
}

function navigateDown() {
    if (selectedIndex < currentSuggestions.length - 1) {
        selectedIndex++;
        updateSelectedItem();
    }
}

function navigateUp() {
    if (selectedIndex > 0) {
        selectedIndex--;
        updateSelectedItem();
    } else if (selectedIndex === 0) {
        selectedIndex = -1;
        updateSelectedItem();
    }
}

function updateSelectedItem() {
    const items = suggestionsList.querySelectorAll('.suggestion-item');
    
    items.forEach((item, index) => {
        if (index === selectedIndex) {
            item.classList.add('active');
            item.scrollIntoView({ block: 'nearest' });
        } else {
            item.classList.remove('active');
        }
    });
    
    // 入力フィールドの値を更新
    if (selectedIndex >= 0) {
        searchInput.value = currentSuggestions[selectedIndex].company_name;
    }
}

function selectCurrent() {
    if (selectedIndex >= 0 && selectedIndex < currentSuggestions.length) {
        selectCompany(currentSuggestions[selectedIndex]);
    } else {
        performDirectSearch();
    }
}

function handleOutsideClick(event) {
    if (!event.target.closest('.position-relative')) {
        hideSuggestions();
    }
}

async function fetchCompanySuggestions(query) {
    if (isSearching) {
        debugLog('既に検索中のためスキップ');
        return;
    }
    
    isSearching = true;
    showSearchStatus();
    debugLog('企業検索開始:', query);
    
    try {
        const url = `/earnings_analysis/companies/search/?q=${encodeURIComponent(query)}`;
        debugLog('検索URL:', url);
        
        const response = await fetch(url);
        debugLog('レスポンス受信:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        debugLog('検索結果:', data);
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        currentSuggestions = data.results || [];
        selectedIndex = -1;
        
        displaySuggestions(currentSuggestions, query);
        
    } catch (error) {
        debugLog('検索エラー:', error);
        console.error('企業検索エラー:', error);
        showError(error.message);
    } finally {
        isSearching = false;
        hideSearchStatus();
    }
}

function displaySuggestions(companies, query) {
    debugLog('候補表示:', companies.length + '件');
    
    if (companies.length === 0) {
        showNoResults();
        return;
    }
    
    suggestionsList.innerHTML = '';
    
    companies.forEach((company, index) => {
        const item = createSuggestionItem(company, index, query);
        suggestionsList.appendChild(item);
    });
    
    showSuggestions();
}

function createSuggestionItem(company, index, query) {
    const item = document.createElement('div');
    item.className = 'suggestion-item dropdown-item d-flex justify-content-between align-items-center p-3 border-bottom';
    item.style.cursor = 'pointer';
    
    // マッチタイプに応じたバッジ
    const matchBadge = getMatchTypeBadge(company.match_type);
    
    // 分析準備状況
    const analysisStatus = company.has_analysis_ready ? 
        '<span class="badge bg-success ms-2">分析可能</span>' : 
        '<span class="badge bg-secondary ms-2">書類のみ</span>';
    
    // 最新決算情報
    let latestInfo = '';
    if (company.latest_financial_date) {
        const date = new Date(company.latest_financial_date);
        latestInfo = `
            <div class="small text-success mt-1">
                <i class="fas fa-chart-line me-1"></i>
                最新: ${company.latest_financial_type} (${date.getFullYear()}/${String(date.getMonth()+1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')})
            </div>
        `;
    }
    
    item.innerHTML = `
        <div class="flex-grow-1">
            <div class="fw-semibold">
                ${highlightMatch(company.company_name, query)}
                ${matchBadge}
                ${analysisStatus}
            </div>
            <div class="small text-muted">
                ${company.securities_code ? `証券コード: <strong>${company.securities_code}</strong>` : ''}
                ${company.securities_code && company.edinet_code ? ' | ' : ''}
                EDINETコード: ${company.edinet_code}
            </div>
            ${latestInfo}
        </div>
        <div class="text-end ms-3">
            <div class="badge bg-primary rounded-pill mb-1">${company.document_count}件</div>
            ${company.financial_count > 0 ? 
                `<div class="small text-success">
                    <i class="fas fa-rocket me-1"></i>決算${company.financial_count}件
                 </div>` : ''}
        </div>
    `;
    
    // イベントハンドラ
    item.addEventListener('click', () => selectCompany(company));
    item.addEventListener('mouseenter', () => {
        selectedIndex = index;
        updateSelectedItem();
    });
    
    return item;
}

function getMatchTypeBadge(matchType) {
    const badges = {
        'securities_exact': '<span class="badge bg-warning">証券コード</span>',
        'name_prefix': '<span class="badge bg-info">前方一致</span>',
        'securities_prefix': '<span class="badge bg-warning">証券コード</span>',
        'name_partial': '<span class="badge bg-secondary">部分一致</span>',
        'other': ''
    };
    return badges[matchType] || '';
}

function highlightMatch(text, query) {
    if (!query) return escapeHtml(text);
    
    const escapedText = escapeHtml(text);
    const escapedQuery = escapeHtml(query);
    
    const regex = new RegExp(`(${escapedQuery})`, 'gi');
    return escapedText.replace(regex, '<mark class="bg-warning">$1</mark>');
}

function selectCompany(company) {
    debugLog('企業選択:', company);
    searchInput.value = company.company_name;
    hideSuggestions();
    
    // 企業詳細ページに遷移
    const url = `/earnings_analysis/company/${company.edinet_code}/`;
    debugLog('遷移URL:', url);
    
    // 遷移前にローディング表示
    searchInput.value = `${company.company_name} - 読み込み中...`;
    searchInput.disabled = true;
    
    // 少し遅延を入れてから遷移（ユーザーフィードバック）
    setTimeout(() => {
        window.location.href = url;
    }, 200);
}

function performDirectSearch() {
    const query = searchInput.value.trim();
    debugLog('直接検索実行:', query);
    
    if (query) {
        // フォールバック: 書類一覧ページへ
        const url = `/earnings_analysis/documents/?company=${encodeURIComponent(query)}`;
        debugLog('フォールバック遷移URL:', url);
        window.location.href = url;
    }
}

function showSuggestions() {
    suggestionsContainer.style.display = 'block';
    suggestionsContainer.classList.add('show');
    hideSearchStatus();
    hideNoResults();
    hideError();
}

function hideSuggestions() {
    suggestionsContainer.style.display = 'none';
    suggestionsContainer.classList.remove('show');
    selectedIndex = -1;
}

function showSearchStatus() {
    hideNoResults();
    hideError();
    searchStatus.style.display = 'block';
    suggestionsContainer.style.display = 'block';
}

function hideSearchStatus() {
    searchStatus.style.display = 'none';
}

function showNoResults() {
    hideSearchStatus();
    hideError();
    noResults.style.display = 'block';
    suggestionsContainer.style.display = 'block';
}

function hideNoResults() {
    noResults.style.display = 'none';
}

function showError(message) {
    hideSearchStatus();
    hideNoResults();
    
    // エラー表示要素を作成または更新
    let errorDiv = document.getElementById('searchError');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'searchError';
        errorDiv.className = 'px-3 py-2 text-danger small';
        suggestionsList.parentNode.insertBefore(errorDiv, suggestionsList);
    }
    
    errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-1"></i>検索エラー: ${escapeHtml(message)}`;
    errorDiv.style.display = 'block';
    suggestionsContainer.style.display = 'block';
}

function hideError() {
    const errorDiv = document.getElementById('searchError');
    if (errorDiv) {
        errorDiv.style.display = 'none';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// エンターキーでの検索（レガシー対応）
if (searchInput) {
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && selectedIndex === -1) {
            performDirectSearch();
        }
    });
}

// エラー回復機能
window.addEventListener('error', function(e) {
    if (e.message.includes('企業検索')) {
        debugLog('グローバルエラーキャッチ:', e.message);
        showError('検索機能でエラーが発生しました。ページを再読み込みしてください。');
    }
});

// ページ離脱前のクリーンアップ
window.addEventListener('beforeunload', function() {
    clearTimeout(searchTimeout);
    debugLog('検索機能クリーンアップ');
});
</script>

<style>
/* 検索候補のスタイル */
.suggestion-item {
    transition: background-color 0.2s ease;
}

.suggestion-item:hover,
.suggestion-item.active {
    background-color: #f8f9fa !important;
}

.suggestion-item.active {
    background-color: #e3f2fd !important;
}

.dropdown-menu {
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

mark {
    padding: 0.1em 0.2em;
    border-radius: 0.2em;
}

@media (max-width: 768px) {
    .suggestion-item {
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    .suggestion-item .text-end {
        align-self: flex-end;
        margin-top: 0.5rem;
        margin-left: 0 !important;
    }
}

/* 検索ボックスのフォーカス時のスタイル */
#companySearch:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    border-color: #80bdff;
}

/* キーボードナビゲーション用のヘルプ */
kbd {
    background-color: #e9ecef;
    border: 1px solid #adb5bd;
    border-radius: 0.2rem;
    color: #495057;
    font-size: 0.75em;
    padding: 0.2rem 0.4rem;
}
</style>
{% endblock %}