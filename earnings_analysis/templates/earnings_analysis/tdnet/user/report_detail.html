{% extends 'base.html' %}
{% load static %}

{% block title %}{{ report.one_line_summary|default:report.title }} - COPOMO{% endblock %}

{% block content %}
<div class="report-container" style="--score: {{ report.overall_score }}; --score-color: {{ report.signal_color|default:'#64748b' }}">
  
  <!-- 戻るリンク -->
  <a href="{% url 'copomo:tdnet-report-list' %}" class="back-link">
    <i class="bi bi-arrow-left"></i> レポート一覧
  </a>

  <!-- メインカード -->
  <div class="main-card">
    <div class="company-row">
      <div class="company-badge">
        <span class="code">{{ report.disclosure.company_code }}</span>
        <span>{{ report.disclosure.company_name }}</span>
      </div>
      <span class="disclosure-date">
        <i class="bi bi-calendar3"></i> {{ report.disclosure.disclosure_date|date:"Y/m/d" }}
      </span>
    </div>
    
    <div class="score-row">
      <div class="score-circle">
        <span class="score-value">{{ report.overall_score }}</span>
      </div>
      <div class="score-info">
        <div class="signal-badge">
          {% if report.signal == 'strong_positive' %}<i class="bi bi-arrow-up-circle-fill"></i> 強い買い
          {% elif report.signal == 'positive' %}<i class="bi bi-arrow-up"></i> やや強気
          {% elif report.signal == 'neutral' %}<i class="bi bi-dash-circle"></i> 様子見
          {% elif report.signal == 'negative' %}<i class="bi bi-arrow-down"></i> やや弱気
          {% else %}<i class="bi bi-arrow-down-circle-fill"></i> 警戒{% endif %}
        </div>
        <div class="one-line">{{ report.one_line_summary|default:"—" }}</div>
        <div class="report-title">{{ report.disclosure.title }}</div>
      </div>
    </div>

    <!-- スコア詳細（横4列） -->
    {% if report.score_details %}
    <div class="score-details">
      {% for key, detail in report.score_details.items %}
      <div class="score-detail-item">
        <div class="score-detail-label">{{ detail.label }}</div>
        <div class="score-detail-value {% if detail.score >= 60 %}high{% elif detail.score >= 40 %}mid{% else %}low{% endif %}">
          {{ detail.score }}
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>

  <!-- サマリー＆キーポイント -->
  <div class="content-grid">
    <div class="summary-card">
      <div class="card-label"><i class="bi bi-chat-quote"></i> サマリー</div>
      <div class="summary-text">{{ report.summary }}</div>
    </div>

    {% if report.key_points %}
    <div class="keypoints-card">
      <div class="card-label"><i class="bi bi-check-circle-fill"></i> キーポイント</div>
      {% for point in report.key_points %}
      <div class="keypoint-item">{{ point }}</div>
      {% endfor %}
    </div>
    {% endif %}
  </div>

  <!-- セクション -->
  {% if sections %}
  <div class="sections-grid">
    {% for section in sections %}
    <div class="section-card{% if not forloop.first %} collapsed{% endif %}" id="section-{{ forloop.counter }}">
      <div class="section-header {{ section.section_type }}" onclick="toggleSection('section-{{ forloop.counter }}')">
        {% if section.section_type == 'overview' %}<i class="bi bi-lightbulb-fill"></i>
        {% elif section.section_type == 'analysis' %}<i class="bi bi-graph-up-arrow"></i>
        {% elif section.section_type == 'risk' %}<i class="bi bi-exclamation-triangle-fill"></i>
        {% else %}<i class="bi bi-file-text"></i>{% endif %}
        {{ section.title }}
      </div>
      <div class="section-content">{{ section.content|linebreaks }}</div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- フッター -->
  <div class="report-footer">
    {% if report.disclosure.pdf_url %}
    <a href="{{ report.disclosure.pdf_url }}" target="_blank" rel="noopener" class="pdf-btn">
      <i class="bi bi-file-earmark-pdf-fill"></i> 原文PDF
      <i class="bi bi-box-arrow-up-right"></i>
    </a>
    {% endif %}

    <div class="meta-info">
      <span><i class="bi bi-clock"></i> {{ report.published_at|date:"Y/m/d H:i" }}</span>
      <span><i class="bi bi-eye"></i> {{ report.view_count }}回</span>
      <span><i class="bi bi-tag"></i> {{ report.get_report_type_display }}</span>
    </div>
  </div>
</div>

<script>
// スマホ用アコーディオン
function toggleSection(id) {
  if (window.innerWidth <= 768) {
    const card = document.getElementById(id);
    card.classList.toggle('collapsed');
  }
}

// PC表示時はcollapsedを解除
document.addEventListener('DOMContentLoaded', function() {
  function handleResize() {
    const cards = document.querySelectorAll('.section-card');
    if (window.innerWidth > 768) {
      // PC: 全て開く
      cards.forEach(card => card.classList.remove('collapsed'));
    } else {
      // スマホ: 最初以外閉じる
      cards.forEach((card, index) => {
        if (index > 0) card.classList.add('collapsed');
        else card.classList.remove('collapsed');
      });
    }
  }
  
  handleResize();
  window.addEventListener('resize', handleResize);
});
</script>
{% endblock %}