{% extends "base.html" %}
{% load static %}

{% block title %}é–‹ç¤ºãƒ¬ãƒãƒ¼ãƒˆä¸€è¦§ | ã‚«ãƒ–ãƒ­ã‚°{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/2-layouts/tdnet-report-list.css' %}?v={{ STATIC_VERSION }}">
{% endblock %}

{% block content %}
<!-- æ¤œç´¢ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<div class="search-header">
  <div class="search-title">
    <i class="bi bi-file-earmark-text"></i>
    é–‹ç¤ºãƒ¬ãƒãƒ¼ãƒˆ
  </div>
  
  <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
  <form method="get" class="search-form">
    <div class="search-input-wrap">
      <i class="bi bi-search search-icon"></i>
      <input type="text" 
             name="q" 
             class="search-input" 
             placeholder="ä¼æ¥­åãƒ»è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰ã§æ¤œç´¢..."
             value="{{ current_keyword }}"
             autocomplete="off">
    </div>
    <!-- ä»–ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å€¤ã‚’ä¿æŒ -->
    {% if current_type %}<input type="hidden" name="type" value="{{ current_type }}">{% endif %}
    {% if current_signal %}<input type="hidden" name="signal" value="{{ current_signal }}">{% endif %}
    <button type="submit" class="search-btn">
      <i class="bi bi-search"></i> æ¤œç´¢
    </button>
  </form>
  
  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div class="filter-row">
    <span class="filter-label">ã‚·ã‚°ãƒŠãƒ«:</span>
    <a href="?{% if current_keyword %}q={{ current_keyword }}&{% endif %}{% if current_type %}type={{ current_type }}{% endif %}" 
       class="filter-btn {% if not current_signal %}active{% endif %}">
      ã™ã¹ã¦<span class="count">({{ total_count }})</span>
    </a>
    <a href="?{% if current_keyword %}q={{ current_keyword }}&{% endif %}{% if current_type %}type={{ current_type }}&{% endif %}signal=positive" 
       class="filter-btn {% if current_signal == 'positive' %}active{% endif %}">
      ğŸ“ˆ å¼·æ°—<span class="count">({{ positive_count }})</span>
    </a>
    <a href="?{% if current_keyword %}q={{ current_keyword }}&{% endif %}{% if current_type %}type={{ current_type }}&{% endif %}signal=neutral" 
       class="filter-btn {% if current_signal == 'neutral' %}active{% endif %}">
      â¡ï¸ ä¸­ç«‹<span class="count">({{ neutral_count }})</span>
    </a>
    <a href="?{% if current_keyword %}q={{ current_keyword }}&{% endif %}{% if current_type %}type={{ current_type }}&{% endif %}signal=negative" 
       class="filter-btn {% if current_signal == 'negative' %}active{% endif %}">
      ğŸ“‰ å¼±æ°—<span class="count">({{ negative_count }})</span>
    </a>
    
    <!-- <span class="filter-label" style="margin-left: 12px;">ç¨®åˆ¥:</span>
    <select name="type" class="type-select" onchange="this.form.submit()" form="type-form">
      <option value="">ã™ã¹ã¦</option>
      {% for value, label in report_types %}
      <option value="{{ value }}" {% if current_type == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <form id="type-form" method="get" style="display:none;">
      {% if current_keyword %}<input type="hidden" name="q" value="{{ current_keyword }}">{% endif %}
      {% if current_signal %}<input type="hidden" name="signal" value="{{ current_signal }}">{% endif %}
    </form>
     -->
    {% if current_keyword or current_type or current_signal %}
    <a href="{% url 'copomo:tdnet-report-list' %}" class="clear-link">
      <i class="bi bi-x-circle"></i> ã‚¯ãƒªã‚¢
    </a>
    {% endif %}
  </div>
  
  <!-- çµ±è¨ˆ -->
  <div class="stats-row">
    <div class="stat-item">
      <div class="stat-value">{{ total_count }}</div>
      <div class="stat-label">ç·ãƒ¬ãƒãƒ¼ãƒˆ</div>
    </div>
    <div class="stat-item">
      <div class="stat-value positive">{{ positive_count }}</div>
      <div class="stat-label">å¼·æ°—</div>
    </div>
    <div class="stat-item">
      <div class="stat-value neutral">{{ neutral_count }}</div>
      <div class="stat-label">ä¸­ç«‹</div>
    </div>
    <div class="stat-item">
      <div class="stat-value negative">{{ negative_count }}</div>
      <div class="stat-label">å¼±æ°—</div>
    </div>
    <div class="stat-item">
      <div class="stat-value">{{ avg_score }}</div>
      <div class="stat-label">å¹³å‡ã‚¹ã‚³ã‚¢</div>
    </div>
  </div>
</div>

<!-- æ¤œç´¢çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
{% if current_keyword %}
<div style="margin-bottom: 10px; font-size: 13px; color: var(--text-secondary);">
  ã€Œ<strong>{{ current_keyword }}</strong>ã€ã®æ¤œç´¢çµæœ: {{ reports|length }}ä»¶
</div>
{% endif %}

<!-- ãƒ¬ãƒãƒ¼ãƒˆä¸€è¦§ï¼ˆã‚°ãƒªãƒƒãƒ‰ï¼‰ -->
{% if reports %}
<div class="report-grid">
  {% for report in reports %}
  <a href="{% url 'copomo:tdnet-report-detail' report.report_id %}" class="report-card">
    <div class="report-card-header">
      <div class="report-date">
        <i class="bi bi-calendar3"></i>
        {{ report.published_at|date:"Y/m/d" }}
      </div>
      <div class="report-signal">
        <span class="signal-tag {{ report.signal }}">
          {% if report.signal == 'strong_positive' %}å¼·ã„è²·ã„
          {% elif report.signal == 'positive' %}ã‚„ã‚„å¼·æ°—
          {% elif report.signal == 'neutral' %}æ§˜å­è¦‹
          {% elif report.signal == 'negative' %}ã‚„ã‚„å¼±æ°—
          {% else %}è­¦æˆ’{% endif %}
        </span>
        <span class="score-badge {% if report.overall_score >= 60 %}high{% elif report.overall_score >= 40 %}medium{% else %}low{% endif %}">
          {{ report.overall_score }}
        </span>
      </div>
    </div>
    <div class="report-card-body">
      <div class="report-company">
        <span class="company-code">{{ report.disclosure.company_code }}</span>
        <span class="company-name">{{ report.disclosure.company_name }}</span>
      </div>
      <h3 class="report-title">{{ report.one_line_summary|default:report.title }}</h3>
      <p class="report-summary">{{ report.summary|truncatechars:80 }}</p>
      {% if report.key_points %}
      <div class="report-chips">
        {% for point in report.key_points|slice:":2" %}
        <span class="chip">{{ point|truncatechars:18 }}</span>
        {% endfor %}
      </div>
      {% endif %}
    </div>
  </a>
  {% endfor %}
</div>

<!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
{% if page_obj.has_other_pages %}
<div class="pagination-wrap">
  {% if page_obj.has_previous %}
  <a href="?page={{ page_obj.previous_page_number }}{% if current_keyword %}&q={{ current_keyword }}{% endif %}{% if current_type %}&type={{ current_type }}{% endif %}{% if current_signal %}&signal={{ current_signal }}{% endif %}" class="page-btn">
    <i class="bi bi-chevron-left"></i>
  </a>
  {% endif %}
  
  <span class="page-info">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
  
  {% if page_obj.has_next %}
  <a href="?page={{ page_obj.next_page_number }}{% if current_keyword %}&q={{ current_keyword }}{% endif %}{% if current_type %}&type={{ current_type }}{% endif %}{% if current_signal %}&signal={{ current_signal }}{% endif %}" class="page-btn">
    <i class="bi bi-chevron-right"></i>
  </a>
  {% endif %}
</div>
{% endif %}

{% else %}
<div class="empty-state">
  <div class="empty-icon">
    <i class="bi bi-file-earmark-x"></i>
  </div>
  <h4>ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h4>
  {% if current_keyword or current_type or current_signal %}
  <p>æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãŠè©¦ã—ãã ã•ã„</p>
  <a href="{% url 'copomo:tdnet-report-list' %}" class="filter-btn" style="margin-top: 10px; display: inline-block; background: var(--primary-color); color: #fff; padding: 8px 16px;">
    æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢
  </a>
  {% else %}
  <p>å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ãƒ¬ãƒãƒ¼ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
  {% endif %}
</div>
{% endif %}
{% endblock %}