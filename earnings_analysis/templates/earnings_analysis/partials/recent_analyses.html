<!-- earnings_analysis/templates/earnings_analysis/partials/recent_analyses.html（改善版） -->
{% if recent_analyses %}
  {% for analysis in recent_analyses %}
  <div class="card analysis-result-card mb-3">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h5 class="card-title mb-2">
            <strong>{{ analysis.company.company_name }}</strong>
            <span class="text-muted">({{ analysis.company.company_code }})</span>
          </h5>
          <p class="text-muted mb-2">
            <i class="bi bi-calendar me-1"></i>
            分析日: {{ analysis.analysis_date|date:"Y年m月d日" }}
            <span class="ms-3">
              <i class="bi bi-file-text me-1"></i>
              {{ analysis.report.fiscal_year }} {{ analysis.report.quarter }}
            </span>
          </p>
          
          <!-- 分析結果のサマリー -->
          <div class="row mt-3">
            {% if analysis.sentiment_analysis %}
            <div class="col-md-6 mb-2">
              <div class="d-flex align-items-center">
                <span class="me-2"><strong>感情スコア:</strong></span>
                <span class="badge {% if analysis.sentiment_analysis.sentiment_score > 0 %}bg-success{% elif analysis.sentiment_analysis.sentiment_score < -20 %}bg-danger{% else %}bg-primary{% endif %} me-2">
                  {{ analysis.sentiment_analysis.sentiment_score|floatformat:1 }}
                </span>
                <small class="text-muted">
                  ({{ analysis.sentiment_analysis.get_confidence_level_display }})
                </small>
              </div>
            </div>
            
            <div class="col-md-6 mb-2">
              <div class="d-flex align-items-center">
                <span class="me-2"><strong>リスク言及:</strong></span>
                <span class="badge {% if analysis.sentiment_analysis.risk_mentions > 15 %}bg-danger{% elif analysis.sentiment_analysis.risk_mentions > 10 %}bg-warning{% else %}bg-success{% endif %}">
                  {{ analysis.sentiment_analysis.risk_mentions }}回
                </span>
              </div>
            </div>
            {% endif %}
            
            {% if analysis.cashflow_analysis %}
            <div class="col-md-6 mb-2">
              <div class="d-flex align-items-center">
                <span class="me-2"><strong>CFパターン:</strong></span>
                <span class="badge cf-pattern-badge cf-{{ analysis.cashflow_analysis.cf_pattern }}">
                  {% if analysis.cashflow_analysis.cf_pattern == 'ideal' %}理想型
                  {% elif analysis.cashflow_analysis.cf_pattern == 'growth' %}成長型
                  {% elif analysis.cashflow_analysis.cf_pattern == 'danger' %}危険型
                  {% elif analysis.cashflow_analysis.cf_pattern == 'recovery' %}回復型
                  {% elif analysis.cashflow_analysis.cf_pattern == 'restructuring' %}再構築型
                  {% else %}その他{% endif %}
                </span>
              </div>
            </div>
            
            <div class="col-md-6 mb-2">
              <div class="d-flex align-items-center">
                <span class="me-2"><strong>健全性:</strong></span>
                <span class="badge {% if analysis.cashflow_analysis.health_score == 'excellent' %}bg-success{% elif analysis.cashflow_analysis.health_score == 'good' %}bg-primary{% elif analysis.cashflow_analysis.health_score == 'fair' %}bg-warning{% else %}bg-danger{% endif %}">
                  {% if analysis.cashflow_analysis.health_score == 'excellent' %}優秀
                  {% elif analysis.cashflow_analysis.health_score == 'good' %}良好
                  {% elif analysis.cashflow_analysis.health_score == 'fair' %}普通
                  {% elif analysis.cashflow_analysis.health_score == 'poor' %}要注意
                  {% else %}危険{% endif %}
                </span>
              </div>
            </div>
            {% else %}
            <div class="col-md-12 mb-2">
              <div class="d-flex align-items-center">
                <span class="me-2"><strong>CFデータ:</strong></span>
                <span class="badge bg-secondary">データなし</span>
                <small class="text-muted ms-2">感情分析のみ実行済み</small>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
        
        <div class="col-md-4 text-md-end">
          <div class="btn-group-vertical d-grid gap-2" role="group">
            <button class="btn btn-outline-primary btn-sm" 
                    onclick="showAnalysisDetail('{{ analysis.company.company_code }}')">
              <i class="bi bi-eye me-1"></i>詳細を見る
            </button>
            <button class="btn btn-primary btn-sm" 
                    onclick="refreshAnalysis('{{ analysis.company.company_code }}')">
              <i class="bi bi-arrow-clockwise me-1"></i>再分析
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
  
  {% if recent_analyses|length >= 5 %}
  <div class="text-center mt-3">
    <p class="text-muted">最新5件を表示中</p>
  </div>
  {% endif %}
  
{% else %}
<div class="text-center py-5">
  <i class="bi bi-graph-up-arrow text-muted" style="font-size: 3rem;"></i>
  <h4 class="mt-3 text-muted">まだ分析結果がありません</h4>
  <p class="text-muted">企業を検索して分析を開始してください</p>
  <div class="mt-4">
    <button class="btn btn-primary me-2" onclick="quickAnalyze('7203')">
      <i class="bi bi-lightning me-1"></i>トヨタで試す
    </button>
    <button class="btn btn-success" onclick="quickAnalyze('9984')">
      <i class="bi bi-lightning me-1"></i>SBGで試す
    </button>
  </div>
</div>
{% endif %}

{% if error %}
<div class="alert alert-warning" role="alert">
  <i class="bi bi-exclamation-triangle me-2"></i>
  分析結果の読み込み中にエラーが発生しました: {{ error }}
</div>
{% endif %}

<style>
.cf-pattern-badge {
  padding: 0.35em 0.65em;
  font-size: 0.75em;
  border-radius: 0.25rem;
  color: white;
}

.cf-ideal { background-color: #28a745; }
.cf-growth { background-color: #007bff; }
.cf-danger { background-color: #dc3545; }
.cf-recovery { background-color: #ffc107; color: #212529; }
.cf-restructuring { background-color: #17a2b8; }
.cf-unknown { background-color: #6c757d; }

.analysis-result-card {
  border-left: 4px solid #007bff;
  transition: all 0.3s ease;
}

.analysis-result-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}
</style>