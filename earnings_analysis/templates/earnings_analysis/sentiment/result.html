<!-- earnings_analysis/templates/earnings_analysis/sentiment/result.html -->
{% extends 'earnings_analysis/base.html' %}
{% load static %}
{% load sentiment_filters %}

{% block title %}感情分析結果 - {{ document.company_name }} - 決算書類管理システム{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'earnings_analysis:index' %}">ホーム</a></li>
        <li class="breadcrumb-item"><a href="{% url 'earnings_analysis:document-detail-ui' document.doc_id %}">{{ document.doc_id }}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'earnings_analysis:sentiment-analysis' document.doc_id %}">感情分析</a></li>
        <li class="breadcrumb-item active">分析結果</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="page-header mb-4">
    <div class="row align-items-center g-3">
        <div class="col-12 col-md-8">
            <h1 class="h3 h-md-2 mb-2">
                <i class="fas fa-chart-line me-2 me-md-3"></i>感情分析結果
            </h1>
            <p class="h6 h-md-5 mb-3 opacity-90 text-truncate">{{ document.company_name }}</p>
            <p class="mb-0 opacity-80 text-truncate-2">{{ document.doc_description }}</p>
        </div>
        <div class="col-12 col-md-4 text-center text-md-end">
            <div class="d-flex flex-column gap-2">
                <div class="badge bg-primary bg-opacity-90 px-3 py-2">
                    <i class="fas fa-calendar me-1"></i>{{ session.created_at|date:"Y/m/d H:i" }}
                </div>
                <div class="badge bg-success px-3 py-2">
                    <i class="fas fa-check me-1"></i>分析完了
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 g-md-4">
    <!-- Main Results Area -->
    <div class="col-12 col-lg-8">
        <!-- Overall Sentiment Score -->
        <div class="analysis-card card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-thermometer-half me-2"></i>全体感情スコア
                </h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center g-3">
                    <div class="col-12 col-md-6">
                        {% if session.sentiment_label == 'positive' %}
                            <div class="score-display score-positive">
                                <div class="score-number">{{ session.overall_score|floatformat:3 }}</div>
                                <div class="score-label">
                                    <i class="fas fa-smile me-2"></i>
                                    <span class="badge {{ session.sentiment_label|sentiment_badge }} fs-6">ポジティブ</span>
                                </div>
                            </div>
                        {% elif session.sentiment_label == 'negative' %}
                            <div class="score-display score-negative">
                                <div class="score-number">{{ session.overall_score|floatformat:3 }}</div>
                                <div class="score-label">
                                    <i class="fas fa-frown me-2"></i>
                                    <span class="badge {{ session.sentiment_label|sentiment_badge }} fs-6">ネガティブ</span>
                                </div>
                            </div>
                        {% else %}
                            <div class="score-display score-neutral">
                                <div class="score-number">{{ session.overall_score|floatformat:3 }}</div>
                                <div class="score-label">
                                    <i class="fas fa-meh me-2"></i>
                                    <span class="badge {{ session.sentiment_label|sentiment_badge }} fs-6">中立</span>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-12 col-md-6">
                        <h6>スコア解釈</h6>
                        <div class="small text-muted mb-3">
                            <div class="d-flex justify-content-between">
                                <span>-1.0</span>
                                <span>0.0</span>
                                <span>+1.0</span>
                            </div>
                            <div class="progress mb-2" style="height: 10px;">
                                <div class="progress-bar bg-danger" style="width: 50%"></div>
                                <div class="progress-bar bg-success" style="width: 50%"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>ネガティブ</span>
                                <span>ポジティブ</span>
                            </div>
                        </div>
                        
                        {% if session.overall_score > 0.5 %}
                            <div class="alert alert-success">
                                <i class="fas fa-thumbs-up me-2"></i>
                                非常にポジティブな内容です
                            </div>
                        {% elif session.overall_score > 0.2 %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                やや前向きな内容です
                            </div>
                        {% elif session.overall_score < -0.5 %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                非常にネガティブな内容です
                            </div>
                        {% elif session.overall_score < -0.2 %}
                            <div class="alert alert-warning">
                                <i class="fas fa-minus-circle me-2"></i>
                                やや慎重な内容です
                            </div>
                        {% else %}
                            <div class="alert alert-secondary">
                                <i class="fas fa-balance-scale me-2"></i>
                                中立的な内容です
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Score Breakdown -->
        {% if session.analysis_result.score_calculation %}
            {% with calc=session.analysis_result.score_calculation %}
                <div class="analysis-card card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-calculator me-2"></i>語彙レベルでのスコア計算詳細
                        </h5>
                        <div class="small text-muted mt-1">
                            <i class="fas fa-info-circle me-1"></i>
                            検出された個別の語彙を集計（1つの文章に複数の語彙が含まれる場合があります）
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 text-center mb-4">
                            <div class="col-6 col-md-3">
                                <div class="border rounded p-3">
                                    <div class="h4 text-success mb-1">{{ calc.positive_scores|length }}</div>
                                    <div class="small text-muted">ポジティブ語彙数</div>
                                    {% if calc.positive_sum > 0 %}
                                        <div class="small text-success mt-1">合計: +{{ calc.positive_sum|floatformat:2 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-6 col-md-3">
                                <div class="border rounded p-3">
                                    <div class="h4 text-danger mb-1">{{ calc.negative_scores|length }}</div>
                                    <div class="small text-muted">ネガティブ語彙数</div>
                                    {% if calc.negative_sum < 0 %}
                                        <div class="small text-danger mt-1">合計: {{ calc.negative_sum|floatformat:2 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-6 col-md-3">
                                <div class="border rounded p-3">
                                    <div class="h4 text-primary mb-1">{{ calc.score_count }}</div>
                                    <div class="small text-muted">総分析語数</div>
                                    <div class="small text-primary mt-1">
                                        {% if session.analysis_result.statistics.unique_words_found %}
                                            (ユニーク: {{ session.analysis_result.statistics.unique_words_found }}語)
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-6 col-md-3">
                                <div class="border rounded p-3">
                                    <div class="h4 text-info mb-1">{{ calc.final_score|floatformat:2 }}</div>
                                    <div class="small text-muted">最終スコア</div>
                                    <div class="small text-info mt-1">
                                        平均: {{ calc.average_score|floatformat:2 }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Final Score Calculation -->
                        <div class="border rounded p-3 bg-light">
                            <h6 class="mb-2">
                                <i class="fas fa-calculator me-1"></i>最終スコア計算
                            </h6>
                            <div class="small">
                                {% if calc.positive_sum != 0 and calc.negative_sum != 0 %}
                                    <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                                        <span class="badge bg-success">ポジティブ: +{{ calc.positive_sum|floatformat:2 }}</span>
                                        <span class="d-none d-sm-inline">+</span>
                                        <span class="badge bg-danger">ネガティブ: {{ calc.negative_sum|floatformat:2 }}</span>
                                        <span class="d-none d-sm-inline">=</span>
                                        <span class="badge bg-primary fs-6">最終: {{ session.overall_score|floatformat:2 }}</span>
                                    </div>
                                    <div class="d-sm-none text-center mt-2">
                                        <small class="text-muted">{{ calc.positive_sum|floatformat:2 }} + {{ calc.negative_sum|floatformat:2 }} = {{ session.overall_score|floatformat:2 }}</small>
                                    </div>
                                {% elif calc.positive_sum != 0 %}
                                    <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                                        <span class="badge bg-success">ポジティブのみ: +{{ calc.positive_sum|floatformat:2 }}</span>
                                        <span class="d-none d-sm-inline">=</span>
                                        <span class="badge bg-primary fs-6">最終: {{ session.overall_score|floatformat:2 }}</span>
                                    </div>
                                {% elif calc.negative_sum != 0 %}
                                    <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                                        <span class="badge bg-danger">ネガティブのみ: {{ calc.negative_sum|floatformat:2 }}</span>
                                        <span class="d-none d-sm-inline">=</span>
                                        <span class="badge bg-primary fs-6">最終: {{ session.overall_score|floatformat:2 }}</span>
                                    </div>
                                {% else %}
                                    <span class="badge bg-secondary">感情語彙なし: 0.0</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endwith %}
        {% endif %}

        <!-- Sample Sentences -->
        {% if session.analysis_result.sample_sentences %}
            {% with samples=session.analysis_result.sample_sentences %}
                <div class="analysis-card card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-file-text me-2"></i>判定された文章の詳細
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Positive sentences -->
                        {% if samples.positive %}
                            <div class="mb-4">
                                <h6 class="text-success d-flex align-items-center justify-content-between">
                                    <span>
                                        <i class="fas fa-smile me-2"></i>ポジティブと判定された文章
                                    </span>
                                    <span class="badge bg-success">{{ samples.positive|length }}件</span>
                                </h6>
                                
                                <div class="accordion" id="positiveAccordion">
                                    {% for sentence in samples.positive|slice:":10" %}
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="positive-heading-{{ forloop.counter }}">
                                                <button class="accordion-button" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#positive-collapse-{{ forloop.counter }}"
                                                        aria-expanded="true">
                                                    <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                                        <span class="fw-semibold text-success">
                                                            スコア: {{ sentence.score|floatformat:2 }}
                                                        </span>
                                                        <span class="small text-muted">
                                                            {% if sentence.score > 0.7 %}
                                                                強いポジティブ
                                                            {% elif sentence.score > 0.4 %}
                                                                中程度のポジティブ
                                                            {% else %}
                                                                軽微なポジティブ
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                </button>
                                            </h2>
                                            <div id="positive-collapse-{{ forloop.counter }}" 
                                                 class="accordion-collapse collapse show"
                                                 data-bs-parent="#positiveAccordion">
                                                <div class="accordion-body">
                                                    <div class="mb-3">
                                                        {% if sentence.highlighted_text %}
                                                            {{ sentence.highlighted_text|safe }}
                                                        {% elif sentence.keywords %}
                                                            {% with highlighted_text=sentence.text|highlight_all_keywords:sentence.keywords %}
                                                                {{ highlighted_text|safe }}
                                                            {% endwith %}
                                                        {% else %}
                                                            {{ sentence.text }}
                                                        {% endif %}
                                                    </div>
                                                    
                                                    {% if sentence.keywords %}
                                                        <div class="small text-muted">
                                                            <strong>検出キーワード:</strong>
                                                            <div class="mt-1">
                                                                {% for keyword in sentence.keywords %}
                                                                    <span class="badge bg-success me-1 mb-1">{{ keyword }}</span>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    
                                    {% if samples.positive|length > 10 %}
                                        <div class="text-center mt-3">
                                            <small class="text-muted">
                                                他{{ samples.positive|length|add:"-10" }}件のポジティブ文章があります
                                            </small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                        
                        <!-- Negative sentences -->
                        {% if samples.negative %}
                            <div class="mb-4">
                                <h6 class="text-danger d-flex align-items-center justify-content-between">
                                    <span>
                                        <i class="fas fa-frown me-2"></i>ネガティブと判定された文章
                                    </span>
                                    <span class="badge bg-danger">{{ samples.negative|length }}件</span>
                                </h6>
                                
                                <div class="accordion" id="negativeAccordion">
                                    {% for sentence in samples.negative|slice:":10" %}
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="negative-heading-{{ forloop.counter }}">
                                                <button class="accordion-button" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#negative-collapse-{{ forloop.counter }}"
                                                        aria-expanded="true">
                                                    <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                                        <span class="fw-semibold text-danger">
                                                            スコア: {{ sentence.score|floatformat:2 }}
                                                        </span>
                                                        <span class="small text-muted">
                                                            {% if sentence.score < -0.7 %}
                                                                強いネガティブ
                                                            {% elif sentence.score < -0.4 %}
                                                                中程度のネガティブ
                                                            {% else %}
                                                                軽微なネガティブ
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                </button>
                                            </h2>
                                            <div id="negative-collapse-{{ forloop.counter }}" 
                                                 class="accordion-collapse collapse show"
                                                 data-bs-parent="#negativeAccordion">
                                                <div class="accordion-body">
                                                    <div class="mb-3">
                                                        {% if sentence.highlighted_text %}
                                                            {{ sentence.highlighted_text|safe }}
                                                        {% elif sentence.keywords %}
                                                            {% with highlighted_text=sentence.text|highlight_all_keywords:sentence.keywords %}
                                                                {{ highlighted_text|safe }}
                                                            {% endwith %}
                                                        {% else %}
                                                            {{ sentence.text }}
                                                        {% endif %}
                                                    </div>
                                                    
                                                    {% if sentence.keywords %}
                                                        <div class="small text-muted">
                                                            <strong>検出キーワード:</strong>
                                                            <div class="mt-1">
                                                                {% for keyword in sentence.keywords %}
                                                                    <span class="badge bg-danger me-1 mb-1">{{ keyword }}</span>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    
                                    {% if samples.negative|length > 10 %}
                                        <div class="text-center mt-3">
                                            <small class="text-muted">
                                                他{{ samples.negative|length|add:"-10" }}件のネガティブ文章があります
                                            </small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if not samples.positive and not samples.negative %}
                            <div class="text-center py-4">
                                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">特徴的な文章は検出されませんでした</h5>
                                <p class="text-muted">感情スコアが閾値を超える文章がありませんでした</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endwith %}
        {% endif %}

        <!-- User Insights -->
        <div class="analysis-card card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>分析から読み取れる見解
                </h5>
            </div>
            <div class="card-body">
                {% if formatted_insights %}
                    <!-- Market Implications -->
                    {% if formatted_insights.market_implications %}
                        <div class="alert alert-info mb-4">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-chart-line me-2"></i>市場への影響分析
                            </h6>
                            {% if formatted_insights.market_implications.sentiment %}
                                <p><strong>市場の反応予想:</strong> {{ formatted_insights.market_implications.sentiment }}</p>
                            {% endif %}
                            {% if formatted_insights.market_implications.stock_impact %}
                                <p class="mb-0"><strong>株価への影響:</strong> {{ formatted_insights.market_implications.stock_impact }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <!-- Strategy Reading -->
                    {% if formatted_insights.strategy_reading %}
                        <div class="alert alert-success mb-4">
                            <h6 class="text-success mb-3">
                                <i class="fas fa-chess me-2"></i>経営戦略の読み取り
                            </h6>
                            {% if formatted_insights.strategy_reading.management_stance %}
                                <p><strong>経営スタンス:</strong> {{ formatted_insights.strategy_reading.management_stance }}</p>
                            {% endif %}
                            {% if formatted_insights.strategy_reading.strategic_direction %}
                                <p class="mb-0"><strong>戦略的方向性:</strong> {{ formatted_insights.strategy_reading.strategic_direction }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <!-- Risk Assessment -->
                    {% if formatted_insights.risk_assessment %}
                        <div class="alert alert-warning mb-4">
                            <h6 class="text-warning mb-3">
                                <i class="fas fa-shield-alt me-2"></i>リスク評価
                            </h6>
                            <p><strong>リスクレベル:</strong> 
                                {% if formatted_insights.risk_assessment.risk_level == 'high' %}
                                    <span class="badge bg-danger">高</span>
                                {% elif formatted_insights.risk_assessment.risk_level == 'medium' %}
                                    <span class="badge bg-warning">中</span>
                                {% else %}
                                    <span class="badge bg-success">低</span>
                                {% endif %}
                            </p>
                            {% if formatted_insights.risk_assessment.identified_risks %}
                                <div class="mb-2">
                                    <strong>特定されたリスク:</strong>
                                    <ul class="small mt-1 mb-0">
                                        {% for risk in formatted_insights.risk_assessment.identified_risks %}
                                            <li>{{ risk }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                {% else %}
                    <!-- Fallback insights -->
                    <div class="alert alert-info">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-chart-line me-2"></i>全体的な傾向
                        </h6>
                        {% if session.sentiment_label == 'positive' %}
                            <p>この書類からは<strong>前向きな経営姿勢</strong>が読み取れます。</p>
                            {% if session.overall_score > 0.6 %}
                                <p class="mb-0">特に、成長への意欲や収益改善への取り組みが強く表現されており、投資家にとって安心感を与える内容となっています。</p>
                            {% endif %}
                        {% elif session.sentiment_label == 'negative' %}
                            <p>この書類からは<strong>慎重な経営スタンス</strong>や<strong>課題への言及</strong>が多く見られます。</p>
                            {% if session.overall_score < -0.6 %}
                                <p class="mb-0">リスクや困難な状況についての記述が目立ちますが、これは企業の透明性の表れとも捉えられます。</p>
                            {% endif %}
                        {% else %}
                            <p class="mb-0">この書類は<strong>バランスの取れた内容</strong>となっており、客観的な報告が主体となっています。</p>
                        {% endif %}
                    </div>
                {% endif %}
                
                <!-- Reliability Assessment -->
                {% if reliability_score %}
                    <div class="alert {% if reliability_score.level == 'very_high' or reliability_score.level == 'high' %}alert-success{% elif reliability_score.level == 'medium' %}alert-warning{% else %}alert-secondary{% endif %}">
                        <h6 class="alert-heading">
                            <i class="fas fa-shield-check me-2"></i>分析の信頼性評価
                        </h6>
                        <p class="mb-2">{{ reliability_score.description }}</p>
                        <div class="progress mb-2" style="height: 10px;">
                            <div class="progress-bar {% if reliability_score.score >= 80 %}bg-success{% elif reliability_score.score >= 60 %}bg-info{% elif reliability_score.score >= 40 %}bg-warning{% else %}bg-secondary{% endif %}" 
                                 style="width: {{ reliability_score.score|score_percentage }}%">
                            </div>
                        </div>
                        {% if reliability_score.factors %}
                            <small>根拠: {{ reliability_score.factors|join:"、" }}</small>
                        {% endif %}
                    </div>
                {% endif %}
                
                <div class="alert alert-info">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>注意事項:</strong> 
                    この感情分析は文書の表現を機械的に分析したものです。投資判断や経営判断を行う際は、財務データや市場環境など他の要因も総合的に検討してください。
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-12 col-lg-4">
        <!-- Statistics -->
        {% if session.analysis_result.statistics %}
            {% with stats=session.analysis_result.statistics %}
                <div class="analysis-card card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>分析統計
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center g-2">
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="h6 text-primary mb-1">{{ stats.total_words_analyzed }}</div>
                                    <div class="small text-muted">分析語数</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="h6 text-info mb-1">{{ stats.context_patterns_found }}</div>
                                    <div class="small text-muted">文脈パターン</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="h6 text-success mb-1">{{ stats.basic_words_found }}</div>
                                    <div class="small text-muted">基本語彙</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="h6 text-secondary mb-1">{{ stats.sentences_analyzed }}</div>
                                    <div class="small text-muted">分析文数</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="small text-muted mt-3">
                            <div class="mb-2">
                                <strong>文脈パターン:</strong> 「減収の改善」のような複合表現
                            </div>
                            <div>
                                <strong>基本語彙:</strong> 辞書に登録された個別の語
                            </div>
                        </div>
                    </div>
                </div>
            {% endwith %}
        {% endif %}
        
        <!-- Actions -->
        <div class="analysis-card card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-tools me-2"></i>アクション
                </h6>
            </div>
            <div class="card-body">
                <div class="action-buttons">
                    <a href="{% url 'earnings_analysis:sentiment-analysis' document.doc_id %}" 
                       class="btn btn-primary w-100">
                        <i class="fas fa-redo me-1"></i>再分析実行
                    </a>
                    <a href="{% url 'earnings_analysis:financial-analysis' document.doc_id %}" 
                       class="btn btn-outline-primary w-100">
                        <i class="fas fa-chart-pie me-1"></i>財務分析も実行
                    </a>
                    <a href="{% url 'earnings_analysis:document-detail-ui' document.doc_id %}" 
                       class="btn btn-outline-secondary w-100">
                        <i class="fas fa-arrow-left me-1"></i>書類詳細に戻る
                    </a>
                    <button type="button" class="btn btn-outline-info w-100" onclick="shareResult()">
                        <i class="fas fa-share me-1"></i>結果を共有
                    </button>
                    <button type="button" class="btn btn-outline-success w-100" onclick="exportSummary()">
                        <i class="fas fa-download me-1"></i>サマリー保存
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function shareResult() {
    const url = window.location.href;
    const title = `感情分析結果: {{ document.company_name }} (スコア: {{ session.overall_score|floatformat:2 }})`;
    
    if (navigator.share) {
        navigator.share({
            title: title,
            url: url
        }).catch(error => {
            console.log('Share failed:', error);
            fallbackShare(url, title);
        });
    } else {
        fallbackShare(url, title);
    }
}

function fallbackShare(url, title) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
            showToast('URLをコピーしました', 'success');
        }).catch(() => {
            promptShare(url);
        });
    } else {
        promptShare(url);
    }
}

function promptShare(url) {
    const textarea = document.createElement('textarea');
    textarea.value = url;
    document.body.appendChild(textarea);
    textarea.select();
    try {
        document.execCommand('copy');
        showToast('URLをコピーしました', 'success');
    } catch (err) {
        prompt('URLをコピーしてください:', url);
    }
    document.body.removeChild(textarea);
}

function exportSummary() {
    const summary = {
        company: '{{ document.company_name }}',
        document: '{{ document.doc_description }}',
        analysis_date: '{{ session.created_at|date:"Y-m-d H:i:s" }}',
        overall_score: {{ session.overall_score }},
        sentiment_label: '{{ session.sentiment_label }}',
        positive_words: {{ session.analysis_result.score_calculation.positive_scores|length }},
        negative_words: {{ session.analysis_result.score_calculation.negative_scores|length }},
        total_analyzed_words: {{ session.analysis_result.statistics.total_words_analyzed }},
        key_insights: [
            {% if session.sentiment_label == 'positive' %}
                '前向きな経営姿勢が表れている',
                '成長への期待が持てる内容'
            {% elif session.sentiment_label == 'negative' %}
                'リスクや課題への言及が多い',
                '慎重な経営スタンス'
            {% else %}
                'バランスの取れた客観的な内容',
                '安定した状況を示している'
            {% endif %}
        ]
    };
    
    const blob = new Blob([JSON.stringify(summary, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sentiment_analysis_${summary.company}_${summary.analysis_date.replace(/[: ]/g, '_')}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Toast notification
function showToast(message, type = 'info') {
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0`;
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    container.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
}

// Initialize page animations
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.analysis-card');
    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry, index) => {
            if (entry.isIntersecting) {
                setTimeout(() => {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }, index * 100);
            }
        });
    }, { threshold: 0.1 });

    cards.forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(card);
    });

    // Scroll to top on load
    window.scrollTo({ top: 0, behavior: 'smooth' });
});
</script>
{% endblock %}