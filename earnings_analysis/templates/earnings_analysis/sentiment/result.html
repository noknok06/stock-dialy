<!-- earnings_analysis/templates/earnings_analysis/sentiment/result_improved.html -->
{% extends 'earnings_analysis/base.html' %}
{% load static %}
{% load sentiment_filters %}

{% block title %}感情分析結果 - {{ document.company_name }} - コポモ{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
    --primary-500: #3b82f6;
    --primary-600: #2563eb;
    --primary-700: #1d4ed8;
    --primary-100: #dbeafe;
    --primary-50: #eff6ff;
    --success-500: #10b981;
    --success-600: #059669;
    --success-100: #d1fae5;
    --success-50: #ecfdf5;
    --warning-500: #f59e0b;
    --warning-600: #d97706;
    --warning-100: #fef3c7;
    --warning-50: #fffbeb;
    --danger-500: #ef4444;
    --danger-600: #dc2626;
    --danger-100: #fee2e2;
    --danger-50: #fef2f2;
    --info-500: #8b5cf6;
    --info-100: #ede9fe;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --radius-2xl: 1.5rem;
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
}

body {
    font-family: 'Noto Sans JP', sans-serif;
    background: var(--gray-50);
}

/* パンくず */
.breadcrumb {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 0;
    margin: 0 0 1.5rem;
    list-style: none;
    font-size: 0.875rem;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
}

.breadcrumb-item + .breadcrumb-item::before {
    content: '/';
    margin-right: 0.5rem;
    color: var(--gray-400);
}

.breadcrumb-item a {
    color: var(--gray-600);
    text-decoration: none;
}

.breadcrumb-item a:hover {
    color: var(--primary-600);
}

.breadcrumb-item.active {
    color: var(--gray-500);
}

/* 結果ヘッダー */
.result-header {
    padding: 1.5rem;
    border-radius: var(--radius-xl);
    margin-bottom: 1.5rem;
    color: white;
    position: relative;
    overflow: hidden;
}

@media (min-width: 768px) {
    .result-header {
        padding: 2rem;
    }
}

.result-header.positive {
    background: linear-gradient(135deg, var(--success-500) 0%, #22c55e 50%, #34d399 100%);
}

.result-header.negative {
    background: linear-gradient(135deg, var(--danger-500) 0%, #f87171 50%, #fb923c 100%);
}

.result-header.neutral {
    background: linear-gradient(135deg, var(--gray-500) 0%, var(--gray-600) 50%, #64748b 100%);
}

.result-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 60%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 60%);
    pointer-events: none;
}

.result-header-content {
    position: relative;
    z-index: 1;
}

.result-header h1 {
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 0.5rem;
    color: white;
}

@media (min-width: 768px) {
    .result-header h1 {
        font-size: 1.75rem;
    }
}

.result-header-subtitle {
    font-size: 1rem;
    opacity: 0.95;
    margin-bottom: 0.25rem;
}

.result-header-desc {
    font-size: 0.875rem;
    opacity: 0.85;
}

.result-header-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
}

.result-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    background: rgba(255,255,255,0.2);
    border-radius: var(--radius-lg);
    font-size: 0.8125rem;
    backdrop-filter: blur(4px);
}

/* メインレイアウト */
.main-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
}

@media (min-width: 992px) {
    .main-layout {
        grid-template-columns: 1fr 320px;
    }
}

/* カード */
.card {
    background: white;
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-100);
    overflow: hidden;
    margin-bottom: 1.5rem;
}

.card-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--gray-100);
    background: var(--gray-50);
}

.card-header h5,
.card-header h6 {
    margin: 0;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    color: var(--gray-800);
}

.card-body {
    padding: 1.25rem;
}

@media (min-width: 768px) {
    .card-header {
        padding: 1.25rem 1.5rem;
    }
    .card-body {
        padding: 1.5rem;
    }
}

/* タブナビゲーション */
.tab-nav {
    display: flex;
    gap: 0.25rem;
    background: var(--gray-100);
    padding: 0.25rem;
    border-radius: var(--radius-lg);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.tab-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: transparent;
    border: none;
    border-radius: var(--radius-md);
    color: var(--gray-600);
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    min-height: 44px;
}

.tab-btn:hover {
    background: white;
    color: var(--gray-800);
}

.tab-btn.active {
    background: white;
    color: var(--primary-600);
    box-shadow: var(--shadow-sm);
}

.tab-panel {
    display: none;
    animation: fadeIn 0.3s ease;
}

.tab-panel.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* スコア表示エリア */
.score-display {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

@media (min-width: 768px) {
    .score-display {
        grid-template-columns: 1fr 1fr;
    }
}

.score-box {
    padding: 1.5rem;
    border-radius: var(--radius-xl);
    text-align: center;
}

.score-box-primary {
    background: linear-gradient(135deg, var(--primary-50) 0%, var(--info-100) 100%);
    border: 2px solid var(--primary-100);
}

.score-box-grade {
    background: var(--gray-50);
    border: 2px solid var(--gray-200);
}

.score-box-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--gray-500);
    margin-bottom: 0.75rem;
}

.score-box-value {
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-size: 3rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 0.5rem;
}

.score-box-value.score-high { color: var(--success-600); }
.score-box-value.score-medium { color: var(--primary-600); }
.score-box-value.score-low { color: var(--warning-600); }
.score-box-value.score-danger { color: var(--danger-600); }

.score-box-unit {
    font-size: 1rem;
    font-weight: 400;
    opacity: 0.7;
}

.score-box-desc {
    font-size: 0.8125rem;
    color: var(--gray-500);
    margin-top: 0.5rem;
}

/* 投資グレードバッジ */
.grade-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-size: 2.5rem;
    font-weight: 700;
    width: 80px;
    height: 80px;
    border-radius: var(--radius-xl);
    color: white;
}

.grade-badge.grade-a { background: linear-gradient(135deg, var(--success-500), #22c55e); }
.grade-badge.grade-b { background: linear-gradient(135deg, var(--primary-500), #6366f1); }
.grade-badge.grade-c { background: linear-gradient(135deg, var(--warning-500), var(--warning-600)); }
.grade-badge.grade-d { background: linear-gradient(135deg, var(--danger-500), var(--danger-600)); }

/* プログレスバー */
.score-progress {
    height: 8px;
    background: var(--gray-200);
    border-radius: 9999px;
    overflow: hidden;
    margin-top: 1rem;
}

.score-progress-bar {
    height: 100%;
    border-radius: 9999px;
    transition: width 1s ease-out;
}

.score-progress-bar.high { background: linear-gradient(90deg, var(--success-500), #22c55e); }
.score-progress-bar.medium { background: linear-gradient(90deg, var(--primary-500), #6366f1); }
.score-progress-bar.low { background: linear-gradient(90deg, var(--warning-500), var(--warning-600)); }
.score-progress-bar.danger { background: linear-gradient(90deg, var(--danger-500), #f87171); }

/* 評価基準説明 */
.criteria-info {
    background: var(--primary-50);
    border: 1px solid var(--primary-100);
    border-radius: var(--radius-lg);
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.criteria-info-title {
    font-weight: 600;
    color: var(--primary-700);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.criteria-info-list {
    margin: 0;
    padding-left: 1.25rem;
    font-size: 0.8125rem;
    color: var(--gray-600);
}

.criteria-info-list li {
    margin-bottom: 0.25rem;
}

/* スコア内訳 */
.score-breakdown {
    margin-top: 1.5rem;
}

.breakdown-title {
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.breakdown-base {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--gray-100);
    border-radius: var(--radius-lg);
    margin-bottom: 1rem;
}

.breakdown-base-label {
    font-weight: 600;
    color: var(--gray-700);
}

.breakdown-base-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--gray-600);
}

.factor-section {
    margin-bottom: 1rem;
}

.factor-section-title {
    font-size: 0.8125rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.factor-section-title.positive { color: var(--success-600); }
.factor-section-title.negative { color: var(--danger-600); }

.factor-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 0.75rem;
    border-radius: var(--radius-md);
    margin-bottom: 0.5rem;
    transition: transform 0.2s ease;
}

.factor-item:hover {
    transform: translateX(4px);
}

.factor-item.positive {
    background: var(--success-50);
    border-left: 3px solid var(--success-500);
}

.factor-item.negative {
    background: var(--danger-50);
    border-left: 3px solid var(--danger-500);
}

.factor-content {
    flex: 1;
    min-width: 0;
}

.factor-name {
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: 0.125rem;
}

.factor-desc {
    font-size: 0.75rem;
    color: var(--gray-500);
}

.factor-impact {
    flex-shrink: 0;
    margin-left: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 700;
}

.factor-impact.positive {
    background: var(--success-100);
    color: var(--success-600);
}

.factor-impact.negative {
    background: var(--danger-100);
    color: var(--danger-600);
}

.final-calculation {
    background: var(--primary-100);
    border: 1px solid var(--primary-200);
    border-radius: var(--radius-lg);
    padding: 1rem;
    margin-top: 1rem;
}

.final-calculation-title {
    font-weight: 600;
    color: var(--primary-700);
    margin-bottom: 0.25rem;
}

.final-calculation-text {
    font-size: 0.875rem;
    color: var(--gray-600);
}

/* ワードクラウドセクション */
.wordcloud-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    padding: 1rem;
    background: var(--gray-50);
    border-radius: var(--radius-lg);
    margin-bottom: 1rem;
}

.wordcloud-btn-group {
    display: flex;
    background: white;
    border-radius: var(--radius-md);
    overflow: hidden;
    border: 1px solid var(--gray-200);
}

.wordcloud-btn {
    padding: 0.5rem 1rem;
    background: white;
    border: none;
    color: var(--gray-600);
    font-weight: 600;
    font-size: 0.8125rem;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 40px;
}

.wordcloud-btn:hover {
    background: var(--gray-100);
}

.wordcloud-btn.active {
    background: var(--primary-500);
    color: white;
}

.wordcloud-select {
    padding: 0.5rem 1rem;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    background: white;
    font-size: 0.875rem;
    min-height: 40px;
}

.wordcloud-update-btn {
    padding: 0.5rem 1rem;
    background: var(--primary-500);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 40px;
}

.wordcloud-update-btn:hover {
    background: var(--primary-600);
}

.wordcloud-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.wordcloud-stat {
    text-align: center;
    padding: 0.5rem;
}

.wordcloud-stat-value {
    font-weight: 700;
    font-size: 1.125rem;
    color: var(--primary-600);
}

.wordcloud-stat-label {
    font-size: 0.6875rem;
    color: var(--gray-500);
}

.wordcloud-canvas {
    min-height: 400px;
    background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

@media (max-width: 767.98px) {
    .wordcloud-canvas {
        min-height: 300px;
    }
    .wordcloud-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* サンプル文章 */
.sentence-section {
    margin-bottom: 1.5rem;
}

.sentence-section:last-child {
    margin-bottom: 0;
}

.sentence-section-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
}

.sentence-section-title.positive { color: var(--success-600); }
.sentence-section-title.negative { color: var(--danger-600); }

.sentence-count {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
}

.sentence-count.positive {
    background: var(--success-100);
    color: var(--success-600);
}

.sentence-count.negative {
    background: var(--danger-100);
    color: var(--danger-600);
}

.sentence-item {
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    margin-bottom: 0.5rem;
    overflow: hidden;
}

.sentence-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: var(--gray-50);
    cursor: pointer;
    transition: background 0.2s ease;
    min-height: 48px;
}

.sentence-item-header:hover {
    background: var(--gray-100);
}

.sentence-item-header.positive.expanded {
    background: var(--success-500);
    color: white;
}

.sentence-item-header.negative.expanded {
    background: var(--danger-500);
    color: white;
}

.sentence-item-score {
    font-weight: 600;
}

.sentence-item-toggle {
    font-size: 0.75rem;
    opacity: 0.7;
}

.sentence-item-body {
    padding: 1rem;
    display: none;
    border-top: 1px solid var(--gray-200);
}

.sentence-item-body.expanded {
    display: block;
}

.sentence-text {
    margin-bottom: 0.75rem;
    line-height: 1.7;
}

.sentence-keywords {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
}

.keyword-tag {
    padding: 0.125rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.6875rem;
    font-weight: 600;
}

.keyword-tag.positive {
    background: var(--success-100);
    color: var(--success-600);
}

.keyword-tag.negative {
    background: var(--danger-100);
    color: var(--danger-600);
}

.keyword-highlight {
    background: var(--warning-100);
    padding: 0.125rem 0.25rem;
    border-radius: 0.125rem;
    font-weight: 600;
    border: 1px solid var(--warning-500);
}

/* サイドバー */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
}

.stat-box {
    padding: 1rem;
    background: var(--gray-50);
    border-radius: var(--radius-lg);
    text-align: center;
}

.stat-box-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-600);
    margin-bottom: 0.125rem;
}

.stat-box-label {
    font-size: 0.6875rem;
    color: var(--gray-500);
}

/* アクションボタン */
.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    min-height: 44px;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-lg);
    font-weight: 600;
    font-size: 0.875rem;
    text-decoration: none;
    transition: all 0.2s ease;
    border: 2px solid var(--gray-200);
    background: white;
    color: var(--gray-700);
    cursor: pointer;
}

.action-btn:hover {
    border-color: var(--primary-500);
    color: var(--primary-600);
    background: var(--primary-50);
    text-decoration: none;
}

.action-btn-primary {
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    color: white;
    border: none;
}

.action-btn-primary:hover {
    background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
    color: white;
}

/* 警告アラート */
.warning-alert {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: var(--warning-50);
    border: 1px solid var(--warning-100);
    border-radius: var(--radius-lg);
    margin-bottom: 1rem;
}

.warning-alert-icon {
    color: var(--warning-500);
    flex-shrink: 0;
    margin-top: 0.125rem;
}

.warning-alert-content {
    flex: 1;
    font-size: 0.8125rem;
    color: var(--warning-600);
}

.warning-alert-title {
    font-weight: 600;
    margin-bottom: 0.125rem;
}

/* モーダル */
.modal-custom .modal-content {
    border-radius: var(--radius-xl);
    overflow: hidden;
}

.modal-custom .modal-header {
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    color: white;
    border: none;
    padding: 1.25rem;
}

.modal-custom .modal-title {
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-weight: 700;
}

.modal-custom .modal-body {
    padding: 1.5rem;
}

.modal-custom .modal-footer {
    border: none;
    padding: 1rem 1.5rem 1.5rem;
}

/* 空の状態 */
.empty-state {
    text-align: center;
    padding: 3rem 1.5rem;
}

.empty-state-icon {
    font-size: 3rem;
    color: var(--gray-300);
    margin-bottom: 1rem;
}

.empty-state-title {
    font-weight: 600;
    color: var(--gray-600);
    margin-bottom: 0.5rem;
}

.empty-state-desc {
    font-size: 0.875rem;
    color: var(--gray-500);
}

/* アニメーション */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-fade-in-up {
    animation: fadeInUp 0.5s ease-out forwards;
}

.delay-1 { animation-delay: 0.1s; opacity: 0; }
.delay-2 { animation-delay: 0.2s; opacity: 0; }
.delay-3 { animation-delay: 0.3s; opacity: 0; }

/* レスポンシブ */
@media (max-width: 767.98px) {
    .score-box-value {
        font-size: 2.25rem;
    }
    
    .grade-badge {
        width: 64px;
        height: 64px;
        font-size: 2rem;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .tab-nav {
        gap: 0.125rem;
    }
    
    .tab-btn {
        padding: 0.625rem 0.75rem;
        font-size: 0.8125rem;
    }
}

@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
    }
}
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'copomo:index' %}">ホーム</a></li>
        <li class="breadcrumb-item"><a href="{% url 'copomo:document-detail-ui' document.doc_id %}">{{ document.doc_id }}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'copomo:sentiment-analysis' document.doc_id %}">感情分析</a></li>
        <li class="breadcrumb-item active">分析結果</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<!-- 結果ヘッダー -->
<header class="result-header {{ session.sentiment_label }} animate-fade-in-up">
    <div class="result-header-content">
        <h1>
            <i class="fas fa-chart-line me-2"></i>感情分析結果
        </h1>
        <p class="result-header-subtitle">{{ document.company_name }}</p>
        <p class="result-header-desc">{{ document.doc_description|truncatechars:80 }}</p>
        
        <div class="result-header-badges">
            <span class="result-badge">
                <i class="fas fa-calendar"></i>
                {{ session.created_at|date:"Y/m/d H:i" }}
            </span>
            <span class="result-badge">
                <i class="fas fa-check-circle"></i>
                分析完了
            </span>
            {% if time_remaining %}
                <span class="result-badge">
                    <i class="fas fa-clock"></i>
                    期限: {{ session.expires_at|date:"m/d H:i" }}
                </span>
            {% endif %}
        </div>
    </div>
</header>

<!-- メインレイアウト -->
<div class="main-layout">
    <!-- メインコンテンツ -->
    <div class="main-content">
        {% include 'earnings_analysis/ads/ad_responsive.html' %}
        
        <!-- 分析タブ -->
        <div class="card animate-fade-in-up delay-1">
            <div class="card-header">
                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="ai-analysis">
                        <i class="fas fa-robot"></i>
                        <span>AI分析</span>
                    </button>
                    <button class="tab-btn" data-tab="word-analysis">
                        <i class="fas fa-cloud"></i>
                        <span>語彙分析</span>
                    </button>
                    <button class="tab-btn" data-tab="samples">
                        <i class="fas fa-file-alt"></i>
                        <span>判定文章</span>
                    </button>
                </div>
            </div>
            
            <!-- AI分析タブ -->
            <div class="tab-panel active" id="ai-analysis">
                <div class="card-body">
                    {% if session.analysis_result.ai_expert_analysis %}
                        {% with ai=session.analysis_result.ai_expert_analysis %}
                            
                            <!-- 整合性チェック警告 -->
                            {% if ai.consistency_check and not ai.consistency_check.passed %}
                                <div class="warning-alert">
                                    <i class="fas fa-exclamation-triangle warning-alert-icon"></i>
                                    <div class="warning-alert-content">
                                        <div class="warning-alert-title">評価調整のお知らせ</div>
                                        総合スコア（{{ session.analysis_result.ai_overall_score|floatformat:2 }}）と当初の推奨グレード（{{ ai.original_grade }}）に
                                        不整合が検出されたため、グレードを<strong>{{ ai.investment_grade }}</strong>に調整しました。
                                    </div>
                                </div>
                            {% endif %}
                            
                            <!-- スコア表示 -->
                            <div class="score-display">
                                <div class="score-box score-box-primary">
                                    <div class="score-box-label">総合評価スコア</div>
                                    <div class="score-box-value {% if session.analysis_result.ai_overall_score >= 75 %}score-high{% elif session.analysis_result.ai_overall_score >= 50 %}score-medium{% elif session.analysis_result.ai_overall_score >= 35 %}score-low{% else %}score-danger{% endif %}">
                                        {{ session.analysis_result.ai_overall_score|floatformat:0 }}<span class="score-box-unit">/100点</span>
                                    </div>
                                    <div class="score-box-desc">{{ ai.consistency_check.score_range }}</div>
                                    <div class="score-progress">
                                        <div class="score-progress-bar {% if session.analysis_result.ai_overall_score >= 75 %}high{% elif session.analysis_result.ai_overall_score >= 50 %}medium{% elif session.analysis_result.ai_overall_score >= 35 %}low{% else %}danger{% endif %}" 
                                             style="width: {{ session.analysis_result.ai_overall_score }}%"></div>
                                    </div>
                                </div>
                                
                                <div class="score-box score-box-grade">
                                    <div class="score-box-label">投資推奨グレード</div>
                                    <div class="grade-badge {% if ai.investment_grade == 'A+' or ai.investment_grade == 'A' %}grade-a{% elif ai.investment_grade == 'B' or ai.investment_grade == 'B+' %}grade-b{% elif ai.investment_grade == 'C' %}grade-c{% else %}grade-d{% endif %}">
                                        {{ ai.investment_grade }}
                                    </div>
                                    <div class="score-box-desc">
                                        {% if ai.investment_grade == 'A+' %}強気買い推奨 (85点以上)
                                        {% elif ai.investment_grade == 'A' %}買い推奨 (75～84点)
                                        {% elif ai.investment_grade == 'B+' %}やや買い推奨 (65～74点)
                                        {% elif ai.investment_grade == 'B' %}中立・保有 (50～64点)
                                        {% elif ai.investment_grade == 'C' %}慎重・売り検討 (35～49点)
                                        {% else %}強気売り推奨 (34点以下){% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 評価基準説明 -->
                            <div class="criteria-info">
                                <div class="criteria-info-title">
                                    <i class="fas fa-info-circle"></i>
                                    評価基準について
                                </div>
                                <ul class="criteria-info-list">
                                    <li><strong>60点</strong>を標準点として設定</li>
                                    <li>明確なポジティブ要素で加点、リスク要因で減点</li>
                                    <li>単なる増収増益では65点程度、大幅な増収増益で70～75点</li>
                                    <li>80点以上は非常に優れた内容、90点以上は例外的</li>
                                </ul>
                            </div>
                            
                            <!-- スコア内訳 -->
                            {% if ai.score_breakdown %}
                                <div class="score-breakdown">
                                    <h6 class="breakdown-title">
                                        <i class="fas fa-calculator"></i>
                                        スコア算出の詳細
                                    </h6>
                                    
                                    {% if ai.score_breakdown.base_score %}
                                        <div class="breakdown-base">
                                            <span class="breakdown-base-label">基準点</span>
                                            <span class="breakdown-base-value">{{ ai.score_breakdown.base_score }}点</span>
                                        </div>
                                    {% endif %}
                                    
                                    {% if ai.score_breakdown.positive_factors %}
                                        <div class="factor-section">
                                            <div class="factor-section-title positive">
                                                <i class="fas fa-plus-circle"></i>
                                                プラス要因
                                            </div>
                                            {% for factor in ai.score_breakdown.positive_factors %}
                                                <div class="factor-item positive">
                                                    <div class="factor-content">
                                                        <div class="factor-name">{{ factor.factor }}</div>
                                                        <div class="factor-desc">{{ factor.description }}</div>
                                                    </div>
                                                    <span class="factor-impact positive">+{{ factor.impact }}点</span>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    
                                    {% if ai.score_breakdown.negative_factors %}
                                        <div class="factor-section">
                                            <div class="factor-section-title negative">
                                                <i class="fas fa-minus-circle"></i>
                                                マイナス要因
                                            </div>
                                            {% for factor in ai.score_breakdown.negative_factors %}
                                                <div class="factor-item negative">
                                                    <div class="factor-content">
                                                        <div class="factor-name">{{ factor.factor }}</div>
                                                        <div class="factor-desc">{{ factor.description }}</div>
                                                    </div>
                                                    <span class="factor-impact negative">{{ factor.impact }}点</span>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    
                                    {% if ai.score_breakdown.final_calculation %}
                                        <div class="final-calculation">
                                            <div class="final-calculation-title">
                                                <i class="fas fa-equals me-1"></i>
                                                最終計算
                                            </div>
                                            <div class="final-calculation-text">{{ ai.score_breakdown.final_calculation }}</div>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                            
                        {% endwith %}
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <h5 class="empty-state-title">AI分析データがありません</h5>
                            <p class="empty-state-desc">標準的な語彙分析結果をご確認ください</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- 語彙分析タブ -->
            <div class="tab-panel" id="word-analysis">
                <div class="card-body">
                    <div class="wordcloud-controls">
                        <div class="wordcloud-btn-group">
                            <button type="button" class="wordcloud-btn active" id="wordcloud-sentiment-btn">
                                <i class="fas fa-heart me-1"></i>感情語彙
                            </button>
                            <button type="button" class="wordcloud-btn" id="wordcloud-all-btn">
                                <i class="fas fa-list me-1"></i>全語彙
                            </button>
                        </div>
                        
                        <select class="wordcloud-select" id="wordcloud-min-count">
                            <option value="3">3回以上</option>
                            <option value="5">5回以上</option>
                            <option value="10" selected>10回以上</option>
                            <option value="20">20回以上</option>
                        </select>
                        
                        <button type="button" class="wordcloud-update-btn" id="wordcloud-update-btn">
                            <i class="fas fa-sync-alt me-1"></i>更新
                        </button>
                    </div>
                    
                    <div class="wordcloud-stats">
                        <div class="wordcloud-stat">
                            <div class="wordcloud-stat-value" id="total-words">-</div>
                            <div class="wordcloud-stat-label">総語彙数</div>
                        </div>
                        <div class="wordcloud-stat">
                            <div class="wordcloud-stat-value" id="wordcloud-displayed-count">-</div>
                            <div class="wordcloud-stat-label">表示語彙数</div>
                        </div>
                        <div class="wordcloud-stat">
                            <div class="wordcloud-stat-value" id="total-occurrences">-</div>
                            <div class="wordcloud-stat-label">総出現回数</div>
                        </div>
                        <div class="wordcloud-stat">
                            <div class="wordcloud-stat-value" id="max-occurrences">-</div>
                            <div class="wordcloud-stat-label">最大出現</div>
                        </div>
                    </div>
                    
                    <div id="wordcloud-canvas" class="wordcloud-canvas">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status"></div>
                            <div class="mt-2" style="color: var(--gray-500);">ワードクラウドを生成しています...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- サンプル文章タブ -->
            <div class="tab-panel" id="samples">
                <div class="card-body">
                    {% if session.analysis_result.sample_sentences %}
                        {% with samples=session.analysis_result.sample_sentences %}
                            
                            {% if samples.positive %}
                                <div class="sentence-section">
                                    <h6 class="sentence-section-title positive">
                                        <i class="fas fa-smile"></i>
                                        ポジティブと判定された文章
                                        <span class="sentence-count positive">{{ samples.positive|length }}件</span>
                                    </h6>
                                    
                                    {% for sentence in samples.positive|slice:":5" %}
                                        <div class="sentence-item">
                                            <div class="sentence-item-header positive" onclick="toggleSentence(this)">
                                                <span class="sentence-item-score">スコア: {{ sentence.score|floatformat:2 }}</span>
                                                <span class="sentence-item-toggle">{{ forloop.counter }}件目 ▼</span>
                                            </div>
                                            <div class="sentence-item-body">
                                                <div class="sentence-text">
                                                    {% if sentence.highlighted_text %}
                                                        {{ sentence.highlighted_text|safe }}
                                                    {% else %}
                                                        {{ sentence.text }}
                                                    {% endif %}
                                                </div>
                                                {% if sentence.keywords %}
                                                    <div class="sentence-keywords">
                                                        <strong class="me-2" style="font-size: 0.75rem; color: var(--gray-500);">キーワード:</strong>
                                                        {% for keyword in sentence.keywords %}
                                                            <span class="keyword-tag positive">{{ keyword }}</span>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if samples.negative %}
                                <div class="sentence-section">
                                    <h6 class="sentence-section-title negative">
                                        <i class="fas fa-frown"></i>
                                        ネガティブと判定された文章
                                        <span class="sentence-count negative">{{ samples.negative|length }}件</span>
                                    </h6>
                                    
                                    {% for sentence in samples.negative|slice:":5" %}
                                        <div class="sentence-item">
                                            <div class="sentence-item-header negative" onclick="toggleSentence(this)">
                                                <span class="sentence-item-score">スコア: {{ sentence.score|floatformat:2 }}</span>
                                                <span class="sentence-item-toggle">{{ forloop.counter }}件目 ▼</span>
                                            </div>
                                            <div class="sentence-item-body">
                                                <div class="sentence-text">
                                                    {% if sentence.highlighted_text %}
                                                        {{ sentence.highlighted_text|safe }}
                                                    {% else %}
                                                        {{ sentence.text }}
                                                    {% endif %}
                                                </div>
                                                {% if sentence.keywords %}
                                                    <div class="sentence-keywords">
                                                        <strong class="me-2" style="font-size: 0.75rem; color: var(--gray-500);">キーワード:</strong>
                                                        {% for keyword in sentence.keywords %}
                                                            <span class="keyword-tag negative">{{ keyword }}</span>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if not samples.positive and not samples.negative %}
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <h5 class="empty-state-title">特徴的な文章は検出されませんでした</h5>
                                </div>
                            {% endif %}
                            
                        {% endwith %}
                    {% endif %}
                </div>
            </div>
        </div>
        
        {% include 'earnings_analysis/ads/ad_responsive.html' %}
    </div>
    
    <!-- サイドバー -->
    <div class="sidebar">
        <!-- 統計情報 -->
        {% if session.analysis_result.statistics %}
            <div class="card animate-fade-in-up delay-2">
                <div class="card-header">
                    <h6>
                        <i class="fas fa-chart-bar text-primary"></i>
                        分析統計
                    </h6>
                </div>
                <div class="card-body">
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-box-value">{{ session.analysis_result.statistics.total_words_analyzed }}</div>
                            <div class="stat-box-label">分析語数</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-value">{{ session.analysis_result.statistics.context_patterns_found }}</div>
                            <div class="stat-box-label">文脈パターン</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-value">{{ session.analysis_result.statistics.basic_words_found }}</div>
                            <div class="stat-box-label">基本語彙</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-value">{{ session.analysis_result.statistics.sentences_analyzed }}</div>
                            <div class="stat-box-label">分析文数</div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- アクション -->
        <div class="card animate-fade-in-up delay-3">
            <div class="card-header">
                <h6>
                    <i class="fas fa-tools text-primary"></i>
                    アクション
                </h6>
            </div>
            <div class="card-body">
                {% if time_remaining and time_remaining.total_seconds < 3600 %}
                    <div class="warning-alert" style="margin-bottom: 0.75rem;">
                        <i class="fas fa-exclamation-triangle warning-alert-icon"></i>
                        <div class="warning-alert-content" style="font-size: 0.75rem;">
                            この結果は約{{ time_remaining.seconds|floatformat:0|div:60 }}分後に期限切れとなります
                        </div>
                    </div>
                {% endif %}
                
                <div class="action-buttons">
                    <a href="{% url 'copomo:sentiment-analysis' document.doc_id %}" class="action-btn action-btn-primary">
                        <i class="fas fa-redo"></i>
                        再分析実行
                    </a>
                    <a href="{% url 'copomo:financial-analysis' document.doc_id %}" class="action-btn">
                        <i class="fas fa-chart-pie"></i>
                        財務分析も実行
                    </a>
                    <a href="{% url 'copomo:document-detail-ui' document.doc_id %}" class="action-btn">
                        <i class="fas fa-arrow-left"></i>
                        書類詳細に戻る
                    </a>
                    <button type="button" class="action-btn" onclick="shareResult()">
                        <i class="fas fa-share"></i>
                        結果を共有
                    </button>
                    <button type="button" class="action-btn" onclick="exportSummary()">
                        <i class="fas fa-download"></i>
                        サマリー保存
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 語彙詳細モーダル -->
<div class="modal fade modal-custom" id="wordDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>語彙詳細分析
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="text-center mb-3">
                            <h3 id="selected-word" style="color: var(--gray-800);">語彙</h3>
                            <span class="badge fs-6" id="word-sentiment-badge">感情</span>
                        </div>
                        <div class="stats-grid mb-3">
                            <div class="stat-box">
                                <div class="stat-box-value" id="word-frequency">0</div>
                                <div class="stat-box-label">出現回数</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-box-value" id="word-score">0.0</div>
                                <div class="stat-box-label">感情スコア</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 style="color: var(--gray-700); margin-bottom: 0.75rem;">出現文脈</h6>
                        <div id="word-context-list" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center py-3" style="color: var(--gray-500);">
                                <i class="fas fa-spinner fa-spin"></i>
                                <div class="mt-2">文脈を検索中...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="action-btn" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                    閉じる
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>

<script>
// データ
const actualScore = {{ session.overall_score }};
const sentimentLabel = '{{ session.sentiment_label }}';
const actualAnalysisData = {
    keyword_frequency_data: {{ session.analysis_result.keyword_frequency_data|safe|default:'{}' }},
    statistics: {{ session.analysis_result.statistics|safe|default:'{}' }},
    sample_sentences: {{ session.analysis_result.sample_sentences|safe|default:'{}' }}
};

let currentWordcloudData = [];
let currentDisplayMode = 'sentiment';
const actualWordcloudData = { sentiment: [], all: [] };

// タブ切り替え
document.querySelectorAll('.tab-btn').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        const targetTab = this.dataset.tab;
        document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
        document.getElementById(targetTab).classList.add('active');
    });
});

// 文章の展開/折りたたみ
function toggleSentence(header) {
    const body = header.nextElementSibling;
    const isExpanded = body.classList.contains('expanded');
    
    // 他の展開を閉じる
    document.querySelectorAll('.sentence-item-body.expanded').forEach(el => el.classList.remove('expanded'));
    document.querySelectorAll('.sentence-item-header.expanded').forEach(el => el.classList.remove('expanded'));
    
    if (!isExpanded) {
        body.classList.add('expanded');
        header.classList.add('expanded');
    }
}

// ワードクラウド
function initializeWordcloud() {
    actualWordcloudData.sentiment = convertToWordcloudData(actualAnalysisData.keyword_frequency_data || {}, false);
    currentWordcloudData = actualWordcloudData.sentiment;
    
    if (actualWordcloudData.sentiment.length > 0) {
        generateWordcloud(actualWordcloudData.sentiment);
    } else {
        showWordcloudError('表示する語彙がありません');
    }
    
    setupWordcloudEvents();
}

function convertToWordcloudData(frequencyData, includeAll = false) {
    const wordcloudData = [];
    const sentimentWords = new Set();
    
    if (frequencyData.positive) {
        frequencyData.positive.forEach(item => {
            sentimentWords.add(item.word);
            wordcloudData.push({
                text: item.word,
                size: item.count,
                sentiment: "positive",
                score: item.score,
                color: "#10b981"
            });
        });
    }
    
    if (frequencyData.negative) {
        frequencyData.negative.forEach(item => {
            sentimentWords.add(item.word);
            wordcloudData.push({
                text: item.word,
                size: item.count,
                sentiment: "negative",
                score: item.score,
                color: "#ef4444"
            });
        });
    }
    
    if (frequencyData.neutral && includeAll) {
        frequencyData.neutral.forEach(item => {
            if (!sentimentWords.has(item.word)) {
                wordcloudData.push({
                    text: item.word,
                    size: item.count,
                    sentiment: "neutral",
                    score: 0,
                    color: "#6b7280"
                });
            }
        });
    }
    
    wordcloudData.sort((a, b) => b.size - a.size);
    
    return wordcloudData.length > 0 ? wordcloudData : [{
        text: "データなし",
        size: 1,
        sentiment: "neutral",
        score: 0.0,
        color: "#6b7280"
    }];
}

function generateWordcloud(wordsData) {
    const canvas = document.getElementById('wordcloud-canvas');
    if (!canvas || !wordsData || wordsData.length === 0) {
        showWordcloudError('表示する語彙がありません');
        return;
    }
    
    const limitedData = wordsData.slice(0, 50);
    canvas.innerHTML = '';
    
    try {
        const isMobile = window.innerWidth <= 768;
        const containerWidth = Math.floor(canvas.offsetWidth) || (isMobile ? 320 : 800);
        const containerHeight = isMobile ? Math.max(300, containerWidth * 0.9) : Math.max(400, containerWidth * 0.5);
        
        canvas.style.height = containerHeight + 'px';
        canvas.style.width = containerWidth + 'px';
        
        const counts = limitedData.map(w => w.size);
        const minCount = Math.min(...counts);
        const maxCount = Math.max(...counts);
        
        const wordcloudList = limitedData.map(word => {
            let fontSize;
            if (maxCount === minCount) {
                fontSize = isMobile ? 16 : 24;
            } else {
                const relativePosition = (word.size - minCount) / (maxCount - minCount);
                const minFontSize = isMobile ? 12 : 14;
                const maxFontSize = isMobile ? 36 : 48;
                fontSize = minFontSize + (maxFontSize - minFontSize) * relativePosition;
            }
            fontSize = Math.floor(Math.max(12, Math.min(fontSize, 60)));
            return [word.text, fontSize, 0, 0, null, null, word.color];
        });
        
        WordCloud(canvas, {
            list: wordcloudList,
            gridSize: Math.max(8, Math.floor(16 * (isMobile ? 0.5 : 1))),
            weightFactor: 1,
            fontFamily: 'Noto Sans JP, sans-serif',
            color: function(word) {
                const wordData = limitedData.find(w => w.text === word);
                return wordData ? wordData.color : '#6b7280';
            },
            backgroundColor: 'transparent',
            rotateRatio: 0,
            shuffle: true,
            ellipticity: isMobile ? 1 : 0.65,
            drawOutOfBound: false,
            shrinkToFit: true,
            click: function(item) {
                if (item && item[0]) showWordDetail(item[0]);
            }
        });
        
        updateDisplayedCount(limitedData.length);
        updateStatistics(limitedData);
        
    } catch (error) {
        console.error('ワードクラウド生成エラー:', error);
        showWordcloudError('ワードクラウドの生成に失敗しました');
    }
}

function showWordcloudError(message) {
    const canvas = document.getElementById('wordcloud-canvas');
    if (canvas) {
        canvas.innerHTML = `
            <div class="text-center" style="color: var(--gray-500);">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <div>${message}</div>
                <button class="action-btn" style="margin-top: 1rem;" onclick="initializeWordcloud()">
                    <i class="fas fa-redo me-1"></i>再試行
                </button>
            </div>
        `;
    }
}

function updateStatistics(wordsData) {
    const totalWords = wordsData.length;
    const totalOccurrences = wordsData.reduce((sum, w) => sum + w.size, 0);
    const maxOccurrences = wordsData.length > 0 ? Math.max(...wordsData.map(w => w.size)) : 0;
    
    const el1 = document.getElementById('total-words');
    const el2 = document.getElementById('total-occurrences');
    const el3 = document.getElementById('max-occurrences');
    
    if (el1) el1.textContent = totalWords;
    if (el2) el2.textContent = totalOccurrences;
    if (el3) el3.textContent = maxOccurrences;
}

function updateDisplayedCount(count) {
    const el = document.getElementById('wordcloud-displayed-count');
    if (el) el.textContent = count;
}

function setupWordcloudEvents() {
    const sentimentBtn = document.getElementById('wordcloud-sentiment-btn');
    const allBtn = document.getElementById('wordcloud-all-btn');
    const updateBtn = document.getElementById('wordcloud-update-btn');
    
    if (sentimentBtn) {
        sentimentBtn.addEventListener('click', function() {
            if (currentDisplayMode !== 'sentiment') {
                currentDisplayMode = 'sentiment';
                this.classList.add('active');
                if (allBtn) allBtn.classList.remove('active');
                currentWordcloudData = actualWordcloudData.sentiment;
                generateWordcloud(currentWordcloudData);
            }
        });
    }
    
    if (allBtn) {
        allBtn.addEventListener('click', function() {
            if (currentDisplayMode !== 'all') {
                currentDisplayMode = 'all';
                this.classList.add('active');
                if (sentimentBtn) sentimentBtn.classList.remove('active');
                
                if (actualWordcloudData.all.length === 0) {
                    actualWordcloudData.all = convertToWordcloudData(actualAnalysisData.keyword_frequency_data || {}, true);
                }
                
                currentWordcloudData = actualWordcloudData.all;
                generateWordcloud(currentWordcloudData);
            }
        });
    }
    
    if (updateBtn) {
        updateBtn.addEventListener('click', applyFilters);
    }
}

function applyFilters() {
    const minCount = parseInt(document.getElementById('wordcloud-min-count')?.value || '10');
    const sourceData = currentDisplayMode === 'all' ? actualWordcloudData.all : actualWordcloudData.sentiment;
    const filteredData = sourceData.filter(word => word && word.size >= minCount);
    
    if (filteredData.length === 0) {
        showWordcloudError('選択した条件に一致する語彙がありません');
        return;
    }
    
    generateWordcloud(filteredData);
}

function showWordDetail(wordText) {
    const wordData = currentWordcloudData.find(w => w.text === wordText);
    if (!wordData) return;
    
    document.getElementById('selected-word').textContent = wordData.text;
    document.getElementById('word-frequency').textContent = wordData.size;
    document.getElementById('word-score').textContent = wordData.score ? wordData.score.toFixed(2) : '0.0';
    
    const sentimentBadge = document.getElementById('word-sentiment-badge');
    const sentimentText = wordData.sentiment === 'positive' ? 'ポジティブ' : 
                         wordData.sentiment === 'negative' ? 'ネガティブ' : '中立';
    const sentimentClass = wordData.sentiment === 'positive' ? 'bg-success' : 
                          wordData.sentiment === 'negative' ? 'bg-danger' : 'bg-secondary';
    
    sentimentBadge.textContent = sentimentText;
    sentimentBadge.className = `badge fs-6 ${sentimentClass}`;
    
    findWordContexts(wordText);
    
    const modal = new bootstrap.Modal(document.getElementById('wordDetailModal'));
    modal.show();
}

function findWordContexts(wordText) {
    const contextList = document.getElementById('word-context-list');
    contextList.innerHTML = '<div class="text-center py-3" style="color: var(--gray-500);"><i class="fas fa-spinner fa-spin"></i><div class="mt-2">文脈を検索中...</div></div>';
    
    const contexts = [];
    const sentences = [
        ...(actualAnalysisData.sample_sentences.positive || []),
        ...(actualAnalysisData.sample_sentences.negative || [])
    ];
    
    sentences.forEach(sentence => {
        if (sentence.text && sentence.text.includes(wordText)) {
            const highlightedText = sentence.text.replace(
                new RegExp(wordText, 'g'),
                `<span class="keyword-highlight">${wordText}</span>`
            );
            contexts.push({
                text: highlightedText,
                score: sentence.score || 0,
                sentiment: sentence.score > 0 ? 'positive' : sentence.score < 0 ? 'negative' : 'neutral'
            });
        }
    });
    
    setTimeout(() => {
        if (contexts.length === 0) {
            contextList.innerHTML = '<div class="text-center py-3" style="color: var(--gray-500);"><i class="fas fa-search"></i><div class="mt-2">この語彙の文脈は見つかりませんでした</div></div>';
        } else {
            const contextHTML = contexts.slice(0, 3).map(context => {
                const borderColor = context.sentiment === 'positive' ? 'var(--success-500)' : 
                                   context.sentiment === 'negative' ? 'var(--danger-500)' : 'var(--gray-300)';
                return `
                    <div style="padding: 0.75rem; margin-bottom: 0.5rem; border-left: 3px solid ${borderColor}; background: var(--gray-50); border-radius: 0 var(--radius-md) var(--radius-md) 0;">
                        <div style="margin-bottom: 0.5rem; line-height: 1.6;">${context.text}</div>
                        <small style="color: var(--gray-500);">スコア: ${context.score.toFixed(2)}</small>
                    </div>
                `;
            }).join('');
            contextList.innerHTML = contextHTML;
        }
    }, 300);
}

// ユーティリティ
function shareResult() {
    const url = window.location.href;
    const title = `感情分析結果: {{ document.company_name }} (スコア: {{ session.overall_score|floatformat:2 }})`;
    
    if (navigator.share) {
        navigator.share({ title, url }).catch(() => {});
    } else if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
            alert('URLをコピーしました');
        });
    }
}

function exportSummary() {
    const summary = {
        company: '{{ document.company_name }}',
        analysis_date: '{{ session.created_at|date:"Y-m-d H:i:s" }}',
        overall_score: {{ session.overall_score }},
        sentiment_label: '{{ session.sentiment_label }}'
    };
    
    const blob = new Blob([JSON.stringify(summary, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sentiment_analysis_${summary.company}_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// 初期化
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeWordcloud, 500);
    window.scrollTo({ top: 0, behavior: 'smooth' });
});
</script>
{% endblock %}