<!-- earnings_analysis/templates/earnings_analysis/sentiment/result.html（詳細表示強化版） -->
{% extends 'earnings_analysis/base.html' %}
{% load static %}
{% load sentiment_filters %}

{% block title %}感情分析結果 - {{ document.company_name }} - 決算書類管理システム{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'earnings_analysis:index' %}">ホーム</a></li>
        <li class="breadcrumb-item"><a href="{% url 'earnings_analysis:document-detail-ui' document.doc_id %}">{{ document.doc_id }}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'earnings_analysis:sentiment-analysis' document.doc_id %}">感情分析</a></li>
        <li class="breadcrumb-item active">分析結果</li>
    </ol>
</nav>
{% endblock %}

{% block extra_css %}
<style>
    .result-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .result-card {
        border: none;
        border-radius: 1rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        margin-bottom: 1.5rem;
    }
    
    .sentiment-score-large {
        font-size: 4rem;
        font-weight: 700;
        text-align: center;
        padding: 3rem 2rem;
        border-radius: 1rem;
        margin: 1rem 0;
    }
    
    .sentiment-positive {
        background: linear-gradient(135deg, #48bb78, #38a169);
        color: white;
    }
    
    .sentiment-negative {
        background: linear-gradient(135deg, #f56565, #e53e3e);
        color: white;
    }
    
    .sentiment-neutral {
        background: linear-gradient(135deg, #a0aec0, #718096);
        color: white;
    }
    
    .insight-card {
        background: linear-gradient(135deg, #e8f4fd, #f0f9ff);
        border: 1px solid #93c5fd;
        border-radius: 1rem;
        padding: 1.5rem;
        margin: 1rem 0;
    }
    
    .word-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }
    
    .word-stat-item {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1.5rem;
        text-align: center;
        transition: transform 0.2s ease;
    }
    
    .word-stat-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .detailed-breakdown {
        background: #f8fafc;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin: 1rem 0;
    }
    
    .sentence-analysis-section {
        margin-top: 2rem;
    }
    
    .analyzed-sentence {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1rem;
        margin: 0.75rem 0;
        border-left: 5px solid #d1d5db;
    }
    
    .analyzed-sentence.positive {
        border-left-color: #10b981;
        background: linear-gradient(to right, #ecfdf5, #ffffff);
    }
    
    .analyzed-sentence.negative {
        border-left-color: #ef4444;
        background: linear-gradient(to right, #fef2f2, #ffffff);
    }
    
    .keyword-highlight {
        background: #fef3c7;
        color: #92400e;
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        font-weight: 600;
        margin: 0 0.1rem;
    }
    
    .insight-suggestion {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        border: 1px solid #60a5fa;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin: 1rem 0;
    }
    
    .recommendation-list {
        list-style: none;
        padding: 0;
    }
    
    .recommendation-list li {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1rem;
        margin: 0.5rem 0;
        position: relative;
        padding-left: 3rem;
    }
    
    .recommendation-list li::before {
        content: "💡";
        position: absolute;
        left: 1rem;
        top: 1rem;
        font-size: 1.2rem;
    }
    
    .impact-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }
    
    .impact-high { background: #dc2626; }
    .impact-medium { background: #f59e0b; }
    .impact-low { background: #10b981; }
    
    .text-purple { color: #8b5cf6 !important; }
    
    .alert-heading {
        margin-bottom: 0.5rem;
    }
    
    .progress {
        background-color: #e5e7eb;
    }
    
    .badge {
        font-size: 0.8rem;
    }
.word-cloud-container {
    min-height: 300px;
    padding: 20px;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    background: #f9fafb;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 10px;
}

.word-cloud-item {
    display: inline-block;
    padding: 0.3rem 0.8rem;
    margin: 0.2rem;
    border-radius: 2rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    position: relative;
}

.word-cloud-item:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 10;
}

.word-cloud-item.positive {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    color: #155724;
    border: 2px solid #b8dacc;
}

.word-cloud-item.negative {
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    color: #721c24;
    border: 2px solid #f1b0b7;
}

.word-cloud-item.size-xs { font-size: 0.75rem; }
.word-cloud-item.size-sm { font-size: 0.875rem; }
.word-cloud-item.size-md { font-size: 1rem; }
.word-cloud-item.size-lg { font-size: 1.25rem; }
.word-cloud-item.size-xl { font-size: 1.5rem; }
.word-cloud-item.size-xxl { font-size: 1.75rem; }

.keyword-ranking {
    background: white;
    border-radius: 0.75rem;
    overflow: hidden;
}

.ranking-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    transition: background-color 0.2s ease;
    cursor: pointer;
}

.ranking-item:hover {
    background-color: #f9fafb;
}

.ranking-item:last-child {
    border-bottom: none;
}

.ranking-number {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    font-size: 0.875rem;
}

.ranking-number.gold { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #92400e; }
.ranking-number.silver { background: linear-gradient(135deg, #c0c0c0, #e5e7eb); color: #374151; }
.ranking-number.bronze { background: linear-gradient(135deg, #cd7f32, #d97706); color: white; }
.ranking-number.other { background: #6b7280; }

.keyword-info {
    flex: 1;
    margin: 0 1rem;
}

.keyword-text {
    font-weight: 600;
    font-size: 1rem;
}

.keyword-meta {
    font-size: 0.875rem;
    color: #6b7280;
}

.occurrence-badge {
    background: #e5e7eb;
    color: #374151;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 600;
}

.chart-container canvas {
    max-height: 400px !important;
}
</style>
{% endblock %}

{% block content %}
<!-- ヘッダー -->
<div class="result-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="h3 mb-2">
                <i class="fas fa-chart-line me-3"></i>感情分析結果
            </h1>
            <p class="h5 mb-3 opacity-90">{{ document.company_name }}</p>
            <p class="mb-0 opacity-80">{{ document.doc_description }}</p>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <div class="badge bg-light text-dark fs-6 px-3 py-2 mb-2">
                <i class="fas fa-calendar me-1"></i>{{ session.created_at|date:"Y/m/d H:i" }}
            </div>
            <br>
            <div class="badge bg-success fs-6 px-3 py-2">
                <i class="fas fa-check me-1"></i>分析完了
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- メイン結果エリア -->
    <div class="col-lg-8">
        <!-- 全体感情スコア -->
        <div class="result-card card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-thermometer-half me-2"></i>全体感情スコア
                </h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        {% if session.sentiment_label == 'positive' %}
                            <div class="sentiment-score-large sentiment-positive">
                                <div>{{ session.overall_score|floatformat:3 }}</div>
                                <div class="fs-4">
                                    <i class="fas fa-smile me-2"></i>
                                    <span class="badge {{ session.sentiment_label|sentiment_badge }} fs-6">ポジティブ</span>
                                </div>
                            </div>
                        {% elif session.sentiment_label == 'negative' %}
                            <div class="sentiment-score-large sentiment-negative">
                                <div>{{ session.overall_score|floatformat:3 }}</div>
                                <div class="fs-4">
                                    <i class="fas fa-frown me-2"></i>
                                    <span class="badge {{ session.sentiment_label|sentiment_badge }} fs-6">ネガティブ</span>
                                </div>
                            </div>
                        {% else %}
                            <div class="sentiment-score-large sentiment-neutral">
                                <div>{{ session.overall_score|floatformat:3 }}</div>
                                <div class="fs-4">
                                    <i class="fas fa-meh me-2"></i>
                                    <span class="badge {{ session.sentiment_label|sentiment_badge }} fs-6">中立</span>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h6>スコア解釈</h6>
                        <div class="small text-muted mb-3">
                            <div class="d-flex justify-content-between">
                                <span>-1.0</span>
                                <span>0.0</span>
                                <span>+1.0</span>
                            </div>
                            <div class="progress mb-2" style="height: 10px;">
                                <div class="progress-bar bg-danger" style="width: 50%"></div>
                                <div class="progress-bar bg-success" style="width: 50%"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>ネガティブ</span>
                                <span>ポジティブ</span>
                            </div>
                        </div>
                        
                        {% if session.overall_score > 0.5 %}
                            <div class="alert alert-success">
                                <i class="fas fa-thumbs-up me-2"></i>
                                非常にポジティブな内容です
                            </div>
                        {% elif session.overall_score > 0.2 %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                やや前向きな内容です
                            </div>
                        {% elif session.overall_score < -0.5 %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                非常にネガティブな内容です
                            </div>
                        {% elif session.overall_score < -0.2 %}
                            <div class="alert alert-warning">
                                <i class="fas fa-minus-circle me-2"></i>
                                やや慎重な内容です
                            </div>
                        {% else %}
                            <div class="alert alert-secondary">
                                <i class="fas fa-balance-scale me-2"></i>
                                中立的な内容です
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <!-- 詳細なスコア内訳 -->
        {% if session.analysis_result.score_calculation %}
            {% with calc=session.analysis_result.score_calculation %}
                <div class="result-card card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-calculator me-2"></i>語彙レベルでのスコア計算詳細
                        </h5>
                        <div class="small text-muted mt-1">
                            <i class="fas fa-info-circle me-1"></i>
                            検出された個別の語彙を集計（1つの文章に複数の語彙が含まれる場合があります）
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="word-stats-grid">
                            <div class="word-stat-item">
                                <div class="h3 text-success mb-2">{{ calc.positive_scores|length }}</div>
                                <div class="text-muted small">ポジティブ語彙数</div>
                                {% if calc.positive_sum > 0 %}
                                    <div class="small text-success mt-1">合計: +{{ calc.positive_sum|floatformat:2 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="word-stat-item">
                                <div class="h3 text-danger mb-2">{{ calc.negative_scores|length }}</div>
                                <div class="text-muted small">ネガティブ語彙数</div>
                                {% if calc.negative_sum < 0 %}
                                    <div class="small text-danger mt-1">合計: {{ calc.negative_sum|floatformat:2 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="word-stat-item">
                                <div class="h3 text-primary mb-2">{{ calc.score_count }}</div>
                                <div class="text-muted small">総分析語数</div>
                                <div class="small text-primary mt-1">
                                    {% if session.analysis_result.statistics.unique_words_found %}
                                        (ユニーク: {{ session.analysis_result.statistics.unique_words_found }}語)
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="word-stat-item">
                                <div class="h3 text-info mb-2">{{ calc.final_score|floatformat:2 }}</div>
                                <div class="text-muted small">最終スコア</div>
                                <div class="small text-info mt-1">
                                    平均: {{ calc.average_score|floatformat:2 }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="detailed-breakdown">
                            <h6 class="mb-3">
                                <i class="fas fa-chart-bar me-2"></i>スコア分布の詳細
                            </h6>
                            
                            <!-- スコア分布の要約 -->
                            <div class="row mb-3">
                                <div class="col-lg-6 mb-3">
                                    <div class="p-3 bg-success bg-opacity-10 rounded">
                                        <h6 class="text-success mb-2">
                                            <i class="fas fa-thumbs-up me-1"></i>ポジティブ語彙 ({{ calc.positive_scores|length }}個)
                                        </h6>
                                        <div id="positiveScoreDistribution"></div>
                                        
                                        <!-- 代表的なスコア値（最初の5個） -->
                                        <div class="mt-2">
                                            <small class="text-muted">代表値:</small>
                                            <div id="positiveScorePreview" class="mt-1"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-lg-6 mb-3">
                                    <div class="p-3 bg-danger bg-opacity-10 rounded">
                                        <h6 class="text-danger mb-2">
                                            <i class="fas fa-thumbs-down me-1"></i>ネガティブ語彙 ({{ calc.negative_scores|length }}個)
                                        </h6>
                                        <div id="negativeScoreDistribution"></div>
                                        
                                        <!-- 代表的なスコア値（最初の5個） -->
                                        <div class="mt-2">
                                            <small class="text-muted">代表値:</small>
                                            <div id="negativeScorePreview" class="mt-1"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 詳細表示ボタン（スマホ対応） -->
                            {% if calc.positive_scores|length > 10 or calc.negative_scores|length > 10 %}
                                <div class="text-center mb-3">
                                    <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#scoreDetails" aria-expanded="false" aria-controls="scoreDetails">
                                        <i class="fas fa-eye me-1"></i>全スコアを表示 <span class="badge bg-primary">{{ calc.positive_scores|length|add:calc.negative_scores|length }}個</span>
                                    </button>
                                </div>
                                
                                <div class="collapse" id="scoreDetails">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>表示について:</strong> スコアが多数検出されたため、スクロール可能な形式で表示しています。
                                    </div>
                                    <div class="row">
                                        {% if calc.positive_scores %}
                                            <div class="col-md-6 mb-3">
                                                <div class="small">
                                                    <strong>全ポジティブスコア ({{ calc.positive_scores|length }}個):</strong>
                                                    <div class="mt-2 p-2 border rounded" style="max-height: 200px; overflow-y: auto;">
                                                        {% for score in calc.positive_scores %}
                                                            <span class="badge bg-success me-1 mb-1">+{{ score|floatformat:1 }}</span>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                        {% if calc.negative_scores %}
                                            <div class="col-md-6 mb-3">
                                                <div class="small">
                                                    <strong>全ネガティブスコア ({{ calc.negative_scores|length }}個):</strong>
                                                    <div class="mt-2 p-2 border rounded" style="max-height: 200px; overflow-y: auto;">
                                                        {% for score in calc.negative_scores %}
                                                            <span class="badge bg-danger me-1 mb-1">{{ score|floatformat:1 }}</span>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% else %}
                                <!-- スコア数が少ない場合は直接表示 -->
                                <div class="row">
                                    {% if calc.positive_scores %}
                                        <div class="col-md-6 mb-3">
                                            <div class="small">
                                                <strong>ポジティブスコア:</strong>
                                                <div class="mt-2">
                                                    {% for score in calc.positive_scores %}
                                                        <span class="badge bg-success me-1 mb-1">+{{ score|floatformat:1 }}</span>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {% if calc.negative_scores %}
                                        <div class="col-md-6 mb-3">
                                            <div class="small">
                                                <strong>ネガティブスコア:</strong>
                                                <div class="mt-2">
                                                    {% for score in calc.negative_scores %}
                                                        <span class="badge bg-danger me-1 mb-1">{{ score|floatformat:1 }}</span>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                            
                            <!-- 計算式（モバイルフレンドリー） -->
                            <div class="mt-3 p-3 bg-white rounded border">
                                <h6 class="mb-2">
                                    <i class="fas fa-calculator me-1"></i>最終スコア計算
                                </h6>
                                <div class="small">
                                    {% if calc.positive_sum != 0 and calc.negative_sum != 0 %}
                                        <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                                            <span class="badge bg-success">ポジティブ: +{{ calc.positive_sum|floatformat:2 }}</span>
                                            <span class="d-none d-sm-inline">+</span>
                                            <span class="badge bg-danger">ネガティブ: {{ calc.negative_sum|floatformat:2 }}</span>
                                            <span class="d-none d-sm-inline">=</span>
                                            <span class="badge bg-primary fs-6">最終: {{ session.overall_score|floatformat:2 }}</span>
                                        </div>
                                        <div class="d-sm-none text-center mt-2">
                                            <small class="text-muted">{{ calc.positive_sum|floatformat:2 }} + {{ calc.negative_sum|floatformat:2 }} = {{ session.overall_score|floatformat:2 }}</small>
                                        </div>
                                    {% elif calc.positive_sum != 0 %}
                                        <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                                            <span class="badge bg-success">ポジティブのみ: +{{ calc.positive_sum|floatformat:2 }}</span>
                                            <span class="d-none d-sm-inline">=</span>
                                            <span class="badge bg-primary fs-6">最終: {{ session.overall_score|floatformat:2 }}</span>
                                        </div>
                                    {% elif calc.negative_sum != 0 %}
                                        <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                                            <span class="badge bg-danger">ネガティブのみ: {{ calc.negative_sum|floatformat:2 }}</span>
                                            <span class="d-none d-sm-inline">=</span>
                                            <span class="badge bg-primary fs-6">最終: {{ session.overall_score|floatformat:2 }}</span>
                                        </div>
                                    {% else %}
                                        <span class="badge bg-secondary">感情語彙なし: 0.0</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endwith %}
        {% endif %}
        {% if session.analysis_result.sample_sentences %}
            {% with samples=session.analysis_result.sample_sentences %}
                <div class="result-card card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-file-text me-2"></i>判定された文章の詳細
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="sentence-analysis-section">
                            {% if samples.positive %}
                                <div class="mb-4">
                                    <h6 class="text-success">
                                        <i class="fas fa-smile me-2"></i>ポジティブと判定された文章 ({{ samples.positive|length }}件)
                                    </h6>
                                    {% for sentence in samples.positive %}
                                        <div class="analyzed-sentence positive">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div class="fw-semibold text-success">
                                                    <span class="impact-indicator impact-{% if sentence.score > 0.7 %}high{% elif sentence.score > 0.4 %}medium{% else %}low{% endif %}"></span>
                                                    スコア: {{ sentence.score|floatformat:2 }}
                                                </div>
                                                <div class="small text-muted">
                                                    {% if sentence.score > 0.7 %}
                                                        強いポジティブ
                                                    {% elif sentence.score > 0.4 %}
                                                        中程度のポジティブ
                                                    {% else %}
                                                        軽微なポジティブ
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                            <!-- 修正：キーワードが複数ある場合の重複表示を防ぐ -->
                                            <div class="mb-2">
                                                {% if sentence.highlighted_text %}
                                                    {{ sentence.highlighted_text|safe }}
                                                {% elif sentence.keywords %}
                                                    {% with highlighted_text=sentence.text|highlight_all_keywords:sentence.keywords %}
                                                        {{ highlighted_text|safe }}
                                                    {% endwith %}
                                                {% else %}
                                                    {{ sentence.text }}
                                                {% endif %}
                                            </div>
                                            
                                            {% if sentence.keywords %}
                                                <div class="small text-muted">
                                                    <strong>検出キーワード:</strong> 
                                                    {% for keyword in sentence.keywords %}
                                                        <span class="badge bg-success me-1">{{ keyword }}</span>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if samples.negative %}
                                <div class="mb-4">
                                    <h6 class="text-danger">
                                        <i class="fas fa-frown me-2"></i>ネガティブと判定された文章 ({{ samples.negative|length }}件)
                                    </h6>
                                    {% for sentence in samples.negative %}
                                        <div class="analyzed-sentence negative">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div class="fw-semibold text-danger">
                                                    <span class="impact-indicator impact-{% if sentence.score < -0.7 %}high{% elif sentence.score < -0.4 %}medium{% else %}low{% endif %}"></span>
                                                    スコア: {{ sentence.score|floatformat:2 }}
                                                </div>
                                                <div class="small text-muted">
                                                    {% if sentence.score < -0.7 %}
                                                        強いネガティブ
                                                    {% elif sentence.score < -0.4 %}
                                                        中程度のネガティブ
                                                    {% else %}
                                                        軽微なネガティブ
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                            <!-- 修正：キーワードが複数ある場合の重複表示を防ぐ -->
                                            <div class="mb-2">
                                                {% if sentence.highlighted_text %}
                                                    {{ sentence.highlighted_text|safe }}
                                                {% elif sentence.keywords %}
                                                    {% with highlighted_text=sentence.text|highlight_all_keywords:sentence.keywords %}
                                                        {{ highlighted_text|safe }}
                                                    {% endwith %}
                                                {% else %}
                                                    {{ sentence.text }}
                                                {% endif %}
                                            </div>
                                            
                                            {% if sentence.keywords %}
                                                <div class="small text-muted">
                                                    <strong>検出キーワード:</strong> 
                                                    {% for keyword in sentence.keywords %}
                                                        <span class="badge bg-danger me-1">{{ keyword }}</span>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if not samples.positive and not samples.negative %}
                                <div class="text-center py-4">
                                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">特徴的な文章は検出されませんでした</h5>
                                    <p class="text-muted">感情スコアが閾値を超える文章がありませんでした</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endwith %}
        {% endif %}

        <!-- キーワード出現頻度の視覚化セクション（新規追加） -->
        {% if session.analysis_result.keyword_frequency_data %}
            <div class="result-card card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-word-cloud me-2"></i>キーワード出現頻度分析
                    </h5>
                    <div class="small text-muted mt-1">
                        検出されたキーワードの使用頻度を視覚的に表示
                    </div>
                </div>
                <div class="card-body">
                    <!-- タブ切り替え -->
                    <ul class="nav nav-tabs mb-3" id="visualizationTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="bubble-tab" data-bs-toggle="tab" data-bs-target="#bubble-chart" type="button" role="tab">
                                <i class="fas fa-circle me-1"></i>バブルチャート
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="cloud-tab" data-bs-toggle="tab" data-bs-target="#word-cloud" type="button" role="tab">
                                <i class="fas fa-cloud me-1"></i>ワードクラウド
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ranking-tab" data-bs-toggle="tab" data-bs-target="#ranking-list" type="button" role="tab">
                                <i class="fas fa-list-ol me-1"></i>ランキング
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="visualizationTabContent">
                        <!-- バブルチャート -->
                        <div class="tab-pane fade show active" id="bubble-chart" role="tabpanel">
                            <div class="row">
                                {% if session.analysis_result.keyword_frequency_data.positive %}
                                    <div class="col-lg-6 mb-4">
                                        <h6 class="text-success mb-3">
                                            <i class="fas fa-smile me-2"></i>ポジティブキーワード
                                        </h6>
                                        <div class="chart-container" style="height: 400px; position: relative;">
                                            <canvas id="positiveBubbleChart"></canvas>
                                        </div>
                                    </div>
                                {% endif %}
                                {% if session.analysis_result.keyword_frequency_data.negative %}
                                    <div class="col-lg-6 mb-4">
                                        <h6 class="text-danger mb-3">
                                            <i class="fas fa-frown me-2"></i>ネガティブキーワード
                                        </h6>
                                        <div class="chart-container" style="height: 400px; position: relative;">
                                            <canvas id="negativeBubbleChart"></canvas>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                            {% if not session.analysis_result.keyword_frequency_data.positive and not session.analysis_result.keyword_frequency_data.negative %}
                                <div class="text-center py-4">
                                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">表示するキーワードがありません</h5>
                                    <p class="text-muted">出現回数が十分なキーワードが見つかりませんでした</p>
                                </div>
                            {% endif %}
                        </div>

                        <!-- ワードクラウド風表示 -->
                        <div class="tab-pane fade" id="word-cloud" role="tabpanel">
                            <div class="row">
                                {% if session.analysis_result.keyword_frequency_data.positive %}
                                    <div class="col-lg-6 mb-4">
                                        <h6 class="text-success mb-3">
                                            <i class="fas fa-smile me-2"></i>ポジティブキーワード
                                        </h6>
                                        <div class="word-cloud-container positive-cloud" id="positiveWordCloud">
                                            <!-- JavaScriptで動的に生成 -->
                                        </div>
                                    </div>
                                {% endif %}
                                {% if session.analysis_result.keyword_frequency_data.negative %}
                                    <div class="col-lg-6 mb-4">
                                        <h6 class="text-danger mb-3">
                                            <i class="fas fa-frown me-2"></i>ネガティブキーワード
                                        </h6>
                                        <div class="word-cloud-container negative-cloud" id="negativeWordCloud">
                                            <!-- JavaScriptで動的に生成 -->
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- ランキング表示 -->
                        <div class="tab-pane fade" id="ranking-list" role="tabpanel">
                            <div class="row">
                                {% if session.analysis_result.keyword_frequency_data.positive %}
                                    <div class="col-lg-6 mb-4">
                                        <h6 class="text-success mb-3">
                                            <i class="fas fa-trophy me-2"></i>ポジティブキーワード TOP10
                                        </h6>
                                        <div id="positiveRanking" class="keyword-ranking">
                                            <!-- JavaScriptで動的に生成 -->
                                        </div>
                                    </div>
                                {% endif %}
                                {% if session.analysis_result.keyword_frequency_data.negative %}
                                    <div class="col-lg-6 mb-4">
                                        <h6 class="text-danger mb-3">
                                            <i class="fas fa-trophy me-2"></i>ネガティブキーワード TOP10
                                        </h6>
                                        <div id="negativeRanking" class="keyword-ranking">
                                            <!-- JavaScriptで動的に生成 -->
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- 統計サマリー -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="h4 text-primary" id="totalUniqueWords">
                                    {{ session.analysis_result.keyword_frequency_data.positive|length|add:session.analysis_result.keyword_frequency_data.negative|length }}
                                </div>
                                <div class="small text-muted">ユニークワード数</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h4 text-success" id="positiveWordsCount">
                                    {{ session.analysis_result.keyword_frequency_data.positive|length }}
                                </div>
                                <div class="small text-muted">ポジティブワード</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h4 text-danger" id="negativeWordsCount">
                                    {{ session.analysis_result.keyword_frequency_data.negative|length }}
                                </div>
                                <div class="small text-muted">ネガティブワード</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h4 text-info" id="totalOccurrences">
                                    {{ session.analysis_result.statistics.total_keyword_occurrences|default:0 }}
                                </div>
                                <div class="small text-muted">総出現回数</div>
                            </div>
                        </div>
                    </div>

                    <!-- 詳細情報パネル -->
                    <div id="keywordDetailPanel" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-2"></i>選択されたキーワード: <span id="selectedKeyword"></span>
                            </h6>
                            <div id="keywordDetails"></div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        <!-- ユーザー向け見解・提案 -->
        <div class="result-card card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>分析から読み取れる見解
                </h5>
            </div>
            <div class="card-body">
                {% if formatted_insights %}
                    <!-- 市場への影響 -->
                    {% if formatted_insights.market_implications %}
                        <div class="insight-card mb-4">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-chart-line me-2"></i>市場への影響分析
                            </h6>
                            {% if formatted_insights.market_implications.sentiment %}
                                <p><strong>市場の反応予想:</strong> {{ formatted_insights.market_implications.sentiment }}</p>
                            {% endif %}
                            {% if formatted_insights.market_implications.stock_impact %}
                                <p><strong>株価への影響:</strong> {{ formatted_insights.market_implications.stock_impact }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <!-- 経営戦略の読み取り -->
                    {% if formatted_insights.strategy_reading %}
                        <div class="insight-card mb-4">
                            <h6 class="text-success mb-3">
                                <i class="fas fa-chess me-2"></i>経営戦略の読み取り
                            </h6>
                            {% if formatted_insights.strategy_reading.management_stance %}
                                <p><strong>経営スタンス:</strong> {{ formatted_insights.strategy_reading.management_stance }}</p>
                            {% endif %}
                            {% if formatted_insights.strategy_reading.strategic_direction %}
                                <p><strong>戦略的方向性:</strong> {{ formatted_insights.strategy_reading.strategic_direction }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <!-- 投資家視点 -->
                    {% if formatted_insights.investor_perspective %}
                        <div class="insight-card mb-4">
                            <h6 class="text-info mb-3">
                                <i class="fas fa-user-tie me-2"></i>投資家視点での評価
                            </h6>
                            {% if formatted_insights.investor_perspective.investment_appeal %}
                                <p><strong>投資魅力度:</strong> {{ formatted_insights.investor_perspective.investment_appeal }}</p>
                            {% endif %}
                            {% if formatted_insights.investor_perspective.growth_potential %}
                                <p><strong>成長ポテンシャル:</strong> {{ formatted_insights.investor_perspective.growth_potential }}</p>
                            {% endif %}
                            {% if formatted_insights.investor_perspective.dividend_outlook %}
                                <p><strong>配当見通し:</strong> {{ formatted_insights.investor_perspective.dividend_outlook }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <!-- リスク評価 -->
                    {% if formatted_insights.risk_assessment %}
                        <div class="insight-card mb-4">
                            <h6 class="text-warning mb-3">
                                <i class="fas fa-shield-alt me-2"></i>リスク評価
                            </h6>
                            <p><strong>リスクレベル:</strong> 
                                {% if formatted_insights.risk_assessment.risk_level == 'high' %}
                                    <span class="badge bg-danger">高</span>
                                {% elif formatted_insights.risk_assessment.risk_level == 'medium' %}
                                    <span class="badge bg-warning">中</span>
                                {% else %}
                                    <span class="badge bg-success">低</span>
                                {% endif %}
                            </p>
                            {% if formatted_insights.risk_assessment.identified_risks %}
                                <p><strong>特定されたリスク:</strong></p>
                                <ul class="small">
                                    {% for risk in formatted_insights.risk_assessment.identified_risks %}
                                        <li>{{ risk }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                            {% if formatted_insights.risk_assessment.monitoring_points %}
                                <p><strong>監視ポイント:</strong></p>
                                <ul class="small">
                                    {% for point in formatted_insights.risk_assessment.monitoring_points %}
                                        <li>{{ point }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <!-- 将来展望 -->
                    {% if formatted_insights.future_outlook %}
                        <div class="insight-card mb-4">
                            <h6 class="text-purple mb-3">
                                <i class="fas fa-crystal-ball me-2"></i>将来展望
                            </h6>
                            {% if formatted_insights.future_outlook.short_term %}
                                <p><strong>短期見通し:</strong> {{ formatted_insights.future_outlook.short_term }}</p>
                            {% endif %}
                            {% if formatted_insights.future_outlook.medium_term %}
                                <p><strong>中期戦略:</strong> {{ formatted_insights.future_outlook.medium_term }}</p>
                            {% endif %}
                            {% if formatted_insights.future_outlook.long_term %}
                                <p><strong>長期ビジョン:</strong> {{ formatted_insights.future_outlook.long_term }}</p>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <!-- ステークホルダー別推奨事項 -->
                    {% if formatted_insights.recommendations %}
                        <div class="insight-suggestion">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-users me-2"></i>ステークホルダー別推奨事項
                            </h6>
                            
                            {% if formatted_insights.recommendations.investors %}
                                <div class="mb-3">
                                    <strong class="text-primary">投資家向け:</strong>
                                    <ul class="recommendation-list">
                                        {% for recommendation in formatted_insights.recommendations.investors %}
                                            <li>{{ recommendation }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                            
                            {% if formatted_insights.recommendations.management %}
                                <div class="mb-3">
                                    <strong class="text-success">経営陣向け:</strong>
                                    <ul class="recommendation-list">
                                        {% for recommendation in formatted_insights.recommendations.management %}
                                            <li>{{ recommendation }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                {% else %}
                    <!-- フォールバック：基本的な見解 -->
                    <div class="insight-card">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-chart-line me-2"></i>全体的な傾向
                        </h6>
                        {% if session.sentiment_label == 'positive' %}
                            <p>この書類からは<strong>前向きな経営姿勢</strong>が読み取れます。</p>
                            {% if session.overall_score > 0.6 %}
                                <p>特に、成長への意欲や収益改善への取り組みが強く表現されており、投資家にとって安心感を与える内容となっています。</p>
                            {% endif %}
                        {% elif session.sentiment_label == 'negative' %}
                            <p>この書類からは<strong>慎重な経営スタンス</strong>や<strong>課題への言及</strong>が多く見られます。</p>
                            {% if session.overall_score < -0.6 %}
                                <p>リスクや困難な状況についての記述が目立ちますが、これは企業の透明性の表れとも捉えられます。</p>
                            {% endif %}
                        {% else %}
                            <p>この書類は<strong>バランスの取れた内容</strong>となっており、客観的な報告が主体となっています。</p>
                        {% endif %}
                    </div>
                {% endif %}
                
                <!-- 業界比較 -->
                {% if industry_stats %}
                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="fas fa-industry me-2"></i>業界比較
                        </h6>
                        <p class="mb-1">{{ industry_stats.comparison_text }}</p>
                        <small>同種書類{{ industry_stats.industry_count }}件との比較（上位{{ industry_stats.percentile }}%）</small>
                    </div>
                {% endif %}
                
                <!-- 信頼性評価 -->
                {% if reliability_score %}
                    <div class="alert {% if reliability_score.level == 'very_high' or reliability_score.level == 'high' %}alert-success{% elif reliability_score.level == 'medium' %}alert-warning{% else %}alert-secondary{% endif %}">
                        <h6 class="alert-heading">
                            <i class="fas fa-shield-check me-2"></i>分析の信頼性評価
                        </h6>
                        <p class="mb-2">{{ reliability_score.description }}</p>
                        <div class="progress mb-2" style="height: 10px;">
                            <div class="progress-bar {% if reliability_score.score >= 80 %}bg-success{% elif reliability_score.score >= 60 %}bg-info{% elif reliability_score.score >= 40 %}bg-warning{% else %}bg-secondary{% endif %}" 
                                 style="width: {{ reliability_score.score|score_percentage }}%">
                                {{ reliability_score.score|score_percentage }}%
                            </div>
                        </div>
                        {% if reliability_score.factors %}
                            <small>根拠: {{ reliability_score.factors|join:"、" }}</small>
                        {% endif %}
                    </div>
                {% endif %}
                
                <div class="alert alert-info">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>注意事項:</strong> 
                    この感情分析は文書の表現を機械的に分析したものです。投資判断や経営判断を行う際は、財務データや市場環境など他の要因も総合的に検討してください。
                </div>
            </div>
        </div>
    </div>
    
    <!-- サイドバー -->
    <div class="col-lg-4">
        <!-- 統計情報 -->
        {% if session.analysis_result.statistics %}
            {% with stats=session.analysis_result.statistics %}
                <div class="result-card card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>分析統計
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="h4 text-primary">{{ stats.total_words_analyzed }}</div>
                                <div class="small text-muted">分析した語数</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="h4 text-info">{{ stats.context_patterns_found }}</div>
                                <div class="small text-muted">文脈パターン</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="h4 text-success">{{ stats.basic_words_found }}</div>
                                <div class="small text-muted">基本語彙</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="h4 text-secondary">{{ stats.sentences_analyzed }}</div>
                                <div class="small text-muted">分析文数</div>
                            </div>
                        </div>
                        
                        <div class="small text-muted">
                            <div class="mb-2">
                                <strong>文脈パターン:</strong> 「減収の改善」のような複合表現
                            </div>
                            <div>
                                <strong>基本語彙:</strong> 辞書に登録された個別の語
                            </div>
                        </div>
                    </div>
                </div>
            {% endwith %}
        {% endif %}
        
        <!-- アクション -->
        <div class="result-card card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-tools me-2"></i>アクション
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'earnings_analysis:sentiment-analysis' document.doc_id %}" 
                       class="btn btn-primary">
                        <i class="fas fa-redo me-1"></i>再分析実行
                    </a>
                    <a href="{% url 'earnings_analysis:document-detail-ui' document.doc_id %}" 
                       class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>書類詳細に戻る
                    </a>
                    <button type="button" class="btn btn-outline-info" onclick="shareResult()">
                        <i class="fas fa-share me-1"></i>結果を共有
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="exportSummary()">
                        <i class="fas fa-download me-1"></i>サマリーを保存
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // スコアデータの取得
    const positiveScores = [{% for score in calc.positive_scores %}{{ score }}{% if not forloop.last %},{% endif %}{% endfor %}];
    const negativeScores = [{% for score in calc.negative_scores %}{{ score }}{% if not forloop.last %},{% endif %}{% endfor %}];
    
    // ポジティブスコアの分布生成
    generateScoreDistribution('positiveScoreDistribution', positiveScores, 'positive');
    generateScorePreview('positiveScorePreview', positiveScores, 'positive');
    
    // ネガティブスコアの分布生成
    generateScoreDistribution('negativeScoreDistribution', negativeScores, 'negative');
    generateScorePreview('negativeScorePreview', negativeScores, 'negative');

    const keywordData = {
        positive: {{ session.analysis_result.keyword_frequency_data.positive|safe|default:"[]" }},
        negative: {{ session.analysis_result.keyword_frequency_data.negative|safe|default:"[]" }}
    };
    
    // 各視覚化を初期化
    if (keywordData.positive.length > 0 || keywordData.negative.length > 0) {
        initializeBubbleCharts(keywordData);
        initializeWordClouds(keywordData);
        initializeRankings(keywordData);
    }
});

function generateScoreDistribution(containerId, scores, type) {
    const container = document.getElementById(containerId);
    if (!container || scores.length === 0) return;
    
    let ranges, colors;
    if (type === 'positive') {
        ranges = [
            { min: 0.7, max: 1.0, label: '高スコア (0.7+)', class: 'bg-success' },
            { min: 0.4, max: 0.7, label: '中スコア (0.4-0.6)', class: 'bg-success bg-opacity-75' },
            { min: 0.0, max: 0.4, label: '低スコア (0.1-0.3)', class: 'bg-success bg-opacity-50' }
        ];
    } else {
        ranges = [
            { min: -1.0, max: -0.7, label: '高スコア (-0.7以下)', class: 'bg-danger' },
            { min: -0.7, max: -0.4, label: '中スコア (-0.4〜-0.6)', class: 'bg-danger bg-opacity-75' },
            { min: -0.4, max: 0.0, label: '低スコア (-0.1〜-0.3)', class: 'bg-danger bg-opacity-50' }
        ];
    }
    
    ranges.forEach(range => {
        const count = scores.filter(score => score >= range.min && score < range.max).length;
        const div = document.createElement('div');
        div.className = 'd-flex justify-content-between align-items-center mb-1';
        div.innerHTML = `
            <span class="small">${range.label}</span>
            <span class="badge ${range.class}">${count}個</span>
        `;
        container.appendChild(div);
    });
}

function generateScorePreview(containerId, scores, type) {
    const container = document.getElementById(containerId);
    if (!container || scores.length === 0) return;
    
    const preview = scores.slice(0, 5);
    const badgeClass = type === 'positive' ? 'bg-success' : 'bg-danger';
    const prefix = type === 'positive' ? '+' : '';
    
    preview.forEach(score => {
        const span = document.createElement('span');
        span.className = `badge ${badgeClass} me-1 mb-1`;
        span.textContent = `${prefix}${score.toFixed(1)}`;
        container.appendChild(span);
    });
    
    if (scores.length > 5) {
        const span = document.createElement('span');
        span.className = 'small text-muted ms-1';
        span.textContent = `...他${scores.length - 5}個`;
        container.appendChild(span);
    }
}
function shareResult() {
    const url = window.location.href;
    const title = `感情分析結果: {{ document.company_name }} (スコア: {{ session.overall_score|floatformat:2 }})`;
    
    if (navigator.share) {
        navigator.share({
            title: title,
            url: url
        }).catch(console.error);
    } else if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
            alert('URLをコピーしました');
        });
    } else {
        prompt('URLをコピーしてください:', url);
    }
}

function exportSummary() {
    const summary = {
        company: '{{ document.company_name }}',
        document: '{{ document.doc_description }}',
        analysis_date: '{{ session.created_at|date:"Y-m-d H:i:s" }}',
        overall_score: {{ session.overall_score }},
        sentiment_label: '{{ session.sentiment_label }}',
        positive_words: {{ session.analysis_result.score_calculation.positive_scores|length }},
        negative_words: {{ session.analysis_result.score_calculation.negative_scores|length }},
        total_analyzed_words: {{ session.analysis_result.statistics.total_words_analyzed }},
        key_insights: [
            {% if session.sentiment_label == 'positive' %}
                '前向きな経営姿勢が表れている',
                '成長への期待が持てる内容'
            {% elif session.sentiment_label == 'negative' %}
                'リスクや課題への言及が多い',
                '慎重な経営スタンス'
            {% else %}
                'バランスの取れた客観的な内容',
                '安定した状況を示している'
            {% endif %}
        ]
    };
    
    const blob = new Blob([JSON.stringify(summary, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sentiment_analysis_${summary.company}_${summary.analysis_date.replace(/[: ]/g, '_')}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// スムーズスクロール
document.addEventListener('DOMContentLoaded', function() {
    // キーワードハイライトのホバー効果
    document.querySelectorAll('.keyword-highlight').forEach(el => {
        el.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05)';
            this.style.transition = 'transform 0.2s ease';
        });
        
        el.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });
    
    // 分析結果のアニメーション
    const cards = document.querySelectorAll('.result-card');
    const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    });
    
    cards.forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(card);
    });
});

function initializeBubbleCharts(data) {
    // ポジティブバブルチャート
    if (data.positive && data.positive.length > 0) {
        createBubbleChart('positiveBubbleChart', data.positive, 'positive');
    }
    
    // ネガティブバブルチャート
    if (data.negative && data.negative.length > 0) {
        createBubbleChart('negativeBubbleChart', data.negative, 'negative');
    }
}

function createBubbleChart(canvasId, keywords, type) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    // バブルチャート用データ変換
    const bubbleData = keywords.map((keyword, index) => ({
        x: Math.random() * 100, // X座標（ランダム配置）
        y: Math.random() * 100, // Y座標（ランダム配置）
        r: Math.max(5, Math.min(50, keyword.count * 3)), // 半径（出現回数に比例）
        keyword: keyword.word,
        count: keyword.count,
        score: keyword.score
    }));
    
    const color = type === 'positive' ? 'rgba(72, 187, 120, 0.7)' : 'rgba(245, 101, 101, 0.7)';
    const borderColor = type === 'positive' ? 'rgba(72, 187, 120, 1)' : 'rgba(245, 101, 101, 1)';
    
    new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: [{
                label: type === 'positive' ? 'ポジティブキーワード' : 'ネガティブキーワード',
                data: bubbleData,
                backgroundColor: color,
                borderColor: borderColor,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const data = context.raw;
                            return [
                                `キーワード: ${data.keyword}`,
                                `出現回数: ${data.count}回`,
                                `スコア: ${data.score.toFixed(2)}`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: false,
                    min: 0,
                    max: 100
                },
                y: {
                    display: false,
                    min: 0,
                    max: 100
                }
            },
            onClick: function(event, elements) {
                if (elements.length > 0) {
                    const data = elements[0].element.$context.raw;
                    showKeywordDetails(data.keyword, data.count, data.score, type);
                }
            }
        }
    });
}

function initializeWordClouds(data) {
    if (data.positive && data.positive.length > 0) {
        createWordCloud('positiveWordCloud', data.positive, 'positive');
    }
    if (data.negative && data.negative.length > 0) {
        createWordCloud('negativeWordCloud', data.negative, 'negative');
    }
}

function createWordCloud(containerId, keywords, type) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // 最大出現回数を取得してサイズを正規化
    const maxCount = Math.max(...keywords.map(k => k.count));
    
    keywords.forEach(keyword => {
        const item = document.createElement('div');
        item.className = `word-cloud-item ${type}`;
        item.textContent = keyword.word;
        
        // 出現回数に基づいてサイズを決定
        const sizeClass = getSizeClass(keyword.count, maxCount);
        item.classList.add(sizeClass);
        
        // ツールチップ情報
        item.title = `${keyword.word}: ${keyword.count}回 (スコア: ${keyword.score.toFixed(2)})`;
        
        // クリックイベント
        item.addEventListener('click', () => {
            showKeywordDetails(keyword.word, keyword.count, keyword.score, type);
        });
        
        container.appendChild(item);
    });
}

function getSizeClass(count, maxCount) {
    const ratio = count / maxCount;
    if (ratio >= 0.8) return 'size-xxl';
    if (ratio >= 0.6) return 'size-xl';
    if (ratio >= 0.4) return 'size-lg';
    if (ratio >= 0.2) return 'size-md';
    if (ratio >= 0.1) return 'size-sm';
    return 'size-xs';
}

function initializeRankings(data) {
    if (data.positive && data.positive.length > 0) {
        createRanking('positiveRanking', data.positive, 'positive');
    }
    if (data.negative && data.negative.length > 0) {
        createRanking('negativeRanking', data.negative, 'negative');
    }
}

function createRanking(containerId, keywords, type) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // 出現回数でソート
    const sortedKeywords = [...keywords].sort((a, b) => b.count - a.count);
    
    sortedKeywords.slice(0, 10).forEach((keyword, index) => {
        const item = document.createElement('div');
        item.className = 'ranking-item';
        
        const rankNumber = document.createElement('div');
        rankNumber.className = `ranking-number ${getRankClass(index)}`;
        rankNumber.textContent = index + 1;
        
        const keywordInfo = document.createElement('div');
        keywordInfo.className = 'keyword-info';
        keywordInfo.innerHTML = `
            <div class="keyword-text">${keyword.word}</div>
            <div class="keyword-meta">スコア: ${keyword.score.toFixed(2)}</div>
        `;
        
        const badge = document.createElement('div');
        badge.className = 'occurrence-badge';
        badge.textContent = `${keyword.count}回`;
        
        item.appendChild(rankNumber);
        item.appendChild(keywordInfo);
        item.appendChild(badge);
        
        // クリックイベント
        item.addEventListener('click', () => {
            showKeywordDetails(keyword.word, keyword.count, keyword.score, type);
        });
        
        container.appendChild(item);
    });
}

function getRankClass(index) {
    if (index === 0) return 'gold';
    if (index === 1) return 'silver';
    if (index === 2) return 'bronze';
    return 'other';
}

function showKeywordDetails(keyword, count, score, type) {
    const panel = document.getElementById('keywordDetailPanel');
    const keywordSpan = document.getElementById('selectedKeyword');
    const detailsDiv = document.getElementById('keywordDetails');
    
    if (!panel || !keywordSpan || !detailsDiv) return;
    
    keywordSpan.textContent = keyword;
    detailsDiv.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <strong>出現回数:</strong> ${count}回
            </div>
            <div class="col-md-4">
                <strong>スコア:</strong> ${score.toFixed(3)}
            </div>
            <div class="col-md-4">
                <strong>種別:</strong> <span class="badge ${type === 'positive' ? 'bg-success' : 'bg-danger'}">${type === 'positive' ? 'ポジティブ' : 'ネガティブ'}</span>
            </div>
        </div>
        <div class="mt-2">
            <strong>影響度:</strong> 
            ${Math.abs(score) > 0.7 ? '<span class="badge bg-danger">高</span>' : 
              Math.abs(score) > 0.4 ? '<span class="badge bg-warning">中</span>' : 
              '<span class="badge bg-success">低</span>'}
        </div>
    `;
    
    panel.style.display = 'block';
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
</script>
{% endblock %}