<!-- earnings_analysis/templates/earnings_analysis/sentiment/result.html -->
{% extends 'earnings_analysis/base.html' %}
{% load static %}
{% load sentiment_filters %}

{% block title %}感情分析結果 - {{ document.company_name }} -コーポマインドリーダー{% endblock %}

    <style>
        .insight-section {
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .insight-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .insight-section h6 {
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .insight-section .badge {
            font-size: 0.85em;
            padding: 0.4em 0.8em;
        }

        .insight-section ul {
            padding-left: 1.5rem;
        }

        .insight-section ul li {
            margin-bottom: 0.5rem;
        }

        .insight-section ul li:last-child {
            margin-bottom: 0;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .insight-section {
                padding: 1rem !important;
            }
            
            .insight-section h6 {
                font-size: 1rem;
            }
        }        
        /* ワードクラウド用CSS - 修正版 */
        .wordcloud-canvas {
            cursor: pointer;
            border: 1px solid #dee2e6;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            min-height: 500px; /* 基本の高さを大きく */
        }

        .wordcloud-legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }

        #wordcloud-tooltip {
            font-size: 0.875rem;
            max-width: 200px;
            line-height: 1.4;
        }

        /* レスポンシブ対応 - 修正版 */
        @media (max-width: 768px) {
            .wordcloud-canvas {
                min-height: 400px !important; /* モバイルでも十分な高さ */
            }
            
            .btn-group-sm .btn {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }
        }

        /* ワードクラウド内のテキストアニメーション */
        .wordcloud-canvas canvas {
            transition: all 0.3s ease;
        }

        /* ローディング状態 */
        .wordcloud-canvas .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        /* ボタングループのスタイル調整 */
        .wordcloud-container .btn-group .btn {
            font-size: 0.875rem;
        }

        /* ワードクラウドのホバー効果強化 */
        .wordcloud-canvas:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'earnings_analysis:index' %}">ホーム</a></li>
        <li class="breadcrumb-item"><a href="{% url 'earnings_analysis:document-detail-ui' document.doc_id %}">{{ document.doc_id }}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'earnings_analysis:sentiment-analysis' document.doc_id %}">感情分析</a></li>
        <li class="breadcrumb-item active">分析結果</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="page-header mb-4">
    <div class="row align-items-center g-3">
        <div class="col-12 col-md-8">
            <h1 class="h3 h-md-2 mb-2">
                <i class="fas fa-chart-line me-2 me-md-3"></i>感情分析結果
            </h1>
            <p class="h6 h-md-5 mb-3 opacity-90 text-truncate">{{ document.company_name }}</p>
            <p class="mb-0 opacity-80 text-truncate-2">{{ document.doc_description }}</p>
        </div>
        <div class="col-12 col-md-4 text-center text-md-end">
            <div class="d-flex flex-column gap-2">
                <div class="badge bg-primary bg-opacity-90 px-3 py-2">
                    <i class="fas fa-calendar me-1"></i>{{ session.created_at|date:"Y/m/d H:i" }}
                </div>
                <div class="badge bg-success px-3 py-2">
                    <i class="fas fa-check me-1"></i>分析完了
                </div>
            </div>
        </div>
    </div>
</div>

<div class="analysis-card card mb-4">
    {% include 'earnings_analysis/ads/ad_responsive.html' %}
</div>

<div class="row g-3 g-md-4">
    <!-- Main Results Area -->
    <div class="col-12 col-lg-8">
        <!-- Overall Sentiment Score -->
        <div class="analysis-card card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-thermometer-half me-2"></i>全体感情スコア
                </h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center g-3">
                    <div class="col-12 col-md-6">
                        {% if session.sentiment_label == 'positive' %}
                            <div class="score-display score-positive">
                                <div class="score-number">{{ session.overall_score|floatformat:3 }}</div>
                                <div class="score-label">
                                    <i class="fas fa-smile me-2"></i>
                                    <span class="badge {{ session.sentiment_label|sentiment_badge }} fs-6">ポジティブ</span>
                                </div>
                            </div>
                        {% elif session.sentiment_label == 'negative' %}
                            <div class="score-display score-negative">
                                <div class="score-number">{{ session.overall_score|floatformat:3 }}</div>
                                <div class="score-label">
                                    <i class="fas fa-frown me-2"></i>
                                    <span class="badge {{ session.sentiment_label|sentiment_badge }} fs-6">ネガティブ</span>
                                </div>
                            </div>
                        {% else %}
                            <div class="score-display score-neutral">
                                <div class="score-number">{{ session.overall_score|floatformat:3 }}</div>
                                <div class="score-label">
                                    <i class="fas fa-meh me-2"></i>
                                    <span class="badge {{ session.sentiment_label|sentiment_badge }} fs-6">中立</span>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-12 col-md-6">
                        <h6>スコア解釈</h6>
                        <div class="small text-muted mb-3">
                            <div class="d-flex justify-content-between">
                                <span>-1.0</span>
                                <span>0.0</span>
                                <span>+1.0</span>
                            </div>
                            <div class="progress mb-2" style="height: 10px;">
                                <div class="progress-bar bg-danger" style="width: 50%"></div>
                                <div class="progress-bar bg-success" style="width: 50%"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>ネガティブ</span>
                                <span>ポジティブ</span>
                            </div>
                        </div>
                        
                        {% if session.overall_score > 0.5 %}
                            <div class="alert alert-success">
                                <i class="fas fa-thumbs-up me-2"></i>
                                非常にポジティブな内容です
                            </div>
                        {% elif session.overall_score > 0.2 %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                やや前向きな内容です
                            </div>
                        {% elif session.overall_score < -0.5 %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                非常にネガティブな内容です
                            </div>
                        {% elif session.overall_score < -0.2 %}
                            <div class="alert alert-warning">
                                <i class="fas fa-minus-circle me-2"></i>
                                やや慎重な内容です
                            </div>
                        {% else %}
                            <div class="alert alert-secondary">
                                <i class="fas fa-balance-scale me-2"></i>
                                中立的な内容です
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Score Breakdown -->
        {% if session.analysis_result.score_calculation %}
            {% with calc=session.analysis_result.score_calculation %}
                <div class="analysis-card card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-calculator me-2"></i>語彙レベルでのスコア計算詳細
                        </h5>
                        <div class="small text-muted mt-1">
                            <i class="fas fa-info-circle me-1"></i>
                            検出された個別の語彙を集計（1つの文章に複数の語彙が含まれる場合があります）
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 text-center mb-4">
                            <div class="col-6 col-md-3">
                                <div class="border rounded p-3">
                                    <div class="h4 text-success mb-1">{{ calc.positive_scores|length }}</div>
                                    <div class="small text-muted">ポジティブ語彙数</div>
                                    {% if calc.positive_sum > 0 %}
                                        <div class="small text-success mt-1">合計: +{{ calc.positive_sum|floatformat:2 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-6 col-md-3">
                                <div class="border rounded p-3">
                                    <div class="h4 text-danger mb-1">{{ calc.negative_scores|length }}</div>
                                    <div class="small text-muted">ネガティブ語彙数</div>
                                    {% if calc.negative_sum < 0 %}
                                        <div class="small text-danger mt-1">合計: {{ calc.negative_sum|floatformat:2 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-6 col-md-3">
                                <div class="border rounded p-3">
                                    <div class="h4 text-primary mb-1">{{ calc.score_count }}</div>
                                    <div class="small text-muted">総分析語数</div>
                                    <div class="small text-primary mt-1">
                                        {% if session.analysis_result.statistics.unique_words_found %}
                                            (ユニーク: {{ session.analysis_result.statistics.unique_words_found }}語)
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-6 col-md-3">
                                <div class="border rounded p-3">
                                    <div class="h4 text-info mb-1">{{ calc.final_score|floatformat:2 }}</div>
                                    <div class="small text-muted">最終スコア</div>
                                    <div class="small text-info mt-1">
                                        平均: {{ calc.average_score|floatformat:2 }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Final Score Calculation -->
                        <div class="border rounded p-3 bg-light">
                            <h6 class="mb-2">
                                <i class="fas fa-calculator me-1"></i>最終スコア計算
                            </h6>
                            <div class="small">
                                {% if calc.positive_sum != 0 and calc.negative_sum != 0 %}
                                    <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                                        <span class="badge bg-success">ポジティブ: +{{ calc.positive_sum|floatformat:2 }}</span>
                                        <span class="d-none d-sm-inline">+</span>
                                        <span class="badge bg-danger">ネガティブ: {{ calc.negative_sum|floatformat:2 }}</span>
                                        <span class="d-none d-sm-inline">=</span>
                                        <span class="badge bg-primary fs-6">最終: {{ session.overall_score|floatformat:2 }}</span>
                                    </div>
                                    <div class="d-sm-none text-center mt-2">
                                        <small class="text-muted">{{ calc.positive_sum|floatformat:2 }} + {{ calc.negative_sum|floatformat:2 }} = {{ session.overall_score|floatformat:2 }}</small>
                                    </div>
                                {% elif calc.positive_sum != 0 %}
                                    <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                                        <span class="badge bg-success">ポジティブのみ: +{{ calc.positive_sum|floatformat:2 }}</span>
                                        <span class="d-none d-sm-inline">=</span>
                                        <span class="badge bg-primary fs-6">最終: {{ session.overall_score|floatformat:2 }}</span>
                                    </div>
                                {% elif calc.negative_sum != 0 %}
                                    <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                                        <span class="badge bg-danger">ネガティブのみ: {{ calc.negative_sum|floatformat:2 }}</span>
                                        <span class="d-none d-sm-inline">=</span>
                                        <span class="badge bg-primary fs-6">最終: {{ session.overall_score|floatformat:2 }}</span>
                                    </div>
                                {% else %}
                                    <span class="badge bg-secondary">感情語彙なし: 0.0</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endwith %}
        {% endif %}

        <!-- ワードクラウドセクションを以下に置き換え -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-cloud me-2"></i>語彙の出現頻度（ワードクラウド）
                    </h5>
                    <!-- 表示切り替えボタンを追加 -->
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-primary active" id="wordcloud-sentiment-btn">
                            <i class="fas fa-heart me-1"></i>感情語彙のみ
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="wordcloud-all-btn">
                            <i class="fas fa-list me-1"></i>全語彙
                        </button>
                    </div>
                </div>
                <div class="small text-muted mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    語彙の大きさは出現頻度に比例します。（緑：ポジティブ、赤：ネガティブ、灰：中立）
                </div>
            </div>
            <div class="card-body">
                <!-- 統計情報 -->
                <div class="row mb-3 text-center">
                    <div class="col-3">
                        <div class="small text-muted">総語彙数</div>
                        <div class="fw-bold text-primary" id="total-words">-</div>
                    </div>
                    <div class="col-3">
                        <div class="small text-muted">表示語彙数</div>
                        <div class="fw-bold text-info" id="wordcloud-displayed-count">-</div>
                    </div>
                    <div class="col-3">
                        <div class="small text-muted">総出現回数</div>
                        <div class="fw-bold text-success" id="total-occurrences">-</div>
                    </div>
                    <div class="col-3">
                        <div class="small text-muted">最大出現回数</div>
                        <div class="fw-bold text-warning" id="max-occurrences">-</div>
                    </div>
                </div>
                
                <!-- 感情別統計（全語彙表示時のみ表示） -->
                <div class="row mb-3 text-center d-none" id="sentiment-stats">
                    <div class="col-4">
                        <div class="small text-success">ポジティブ</div>
                        <div class="fw-bold" id="positive-count">-</div>
                    </div>
                    <div class="col-4">
                        <div class="small text-danger">ネガティブ</div>
                        <div class="fw-bold" id="negative-count">-</div>
                    </div>
                    <div class="col-4">
                        <div class="small text-secondary">中立</div>
                        <div class="fw-bold" id="neutral-count">-</div>
                    </div>
                </div>
                
                <!-- ワードクラウド表示エリア -->
                <div class="wordcloud-container">
                    <div id="wordcloud-canvas" class="wordcloud-canvas bg-light rounded" style="min-height: 500px; position: relative;">
                        <div class="d-flex justify-content-center align-items-center h-100">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">ワードクラウド生成中...</span>
                                </div>
                                <div class="mt-2 text-muted">ワードクラウドを生成しています...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- コントロールパネル -->
                <div class="mt-3">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label for="wordcloud-min-count" class="form-label small">最小出現回数</label>
                            <select class="form-select form-select-sm" id="wordcloud-min-count">
                                <option value="1">1回以上</option>
                                <option value="2">2回以上</option>
                                <option value="3" selected>3回以上（推奨）</option>
                                <option value="5">5回以上</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="wordcloud-max-words" class="form-label small">最大表示語数</label>
                            <select class="form-select form-select-sm" id="wordcloud-max-words">
                                <option value="30">30語</option>
                                <option value="50"></option>
                                <option value="100" selected>100語（推奨）</option>
                                <option value="200">200語</option>
                                <option value="0">制限なし</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button" class="btn btn-sm btn-primary w-100" id="wordcloud-update-btn">
                                <i class="fas fa-sync-alt me-1"></i>更新
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="analysis-card card mb-4">
            {% include 'earnings_analysis/ads/ad_responsive.html' %}
        </div>

        <!-- Sample Sentences -->
        {% if session.analysis_result.sample_sentences %}
            {% with samples=session.analysis_result.sample_sentences %}
                <div class="analysis-card card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-file-text me-2"></i>判定された文章の詳細
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Positive sentences -->
                        {% if samples.positive %}
                            <div class="mb-4">
                                <h6 class="text-success d-flex align-items-center justify-content-between">
                                    <span>
                                        <i class="fas fa-smile me-2"></i>ポジティブと判定された文章
                                    </span>
                                    <span class="badge bg-success">{{ samples.positive|length }}件</span>
                                </h6>
                                
                                <div class="accordion" id="positiveAccordion">
                                    {% for sentence in samples.positive|slice:":10" %}
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="positive-heading-{{ forloop.counter }}">
                                                <button class="accordion-button" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#positive-collapse-{{ forloop.counter }}"
                                                        aria-expanded="true">
                                                    <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                                        <span class="fw-semibold text-success">
                                                            スコア: {{ sentence.score|floatformat:2 }}
                                                        </span>
                                                        <span class="small text-muted">
                                                            {% if sentence.score > 0.7 %}
                                                                強いポジティブ
                                                            {% elif sentence.score > 0.4 %}
                                                                中程度のポジティブ
                                                            {% else %}
                                                                軽微なポジティブ
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                </button>
                                            </h2>
                                            <div id="positive-collapse-{{ forloop.counter }}" 
                                                 class="accordion-collapse collapse show"
                                                 data-bs-parent="#positiveAccordion">
                                                <div class="accordion-body">
                                                    <div class="mb-3">
                                                        {% if sentence.highlighted_text %}
                                                            {{ sentence.highlighted_text|safe }}
                                                        {% elif sentence.keywords %}
                                                            {% with highlighted_text=sentence.text|highlight_all_keywords:sentence.keywords %}
                                                                {{ highlighted_text|safe }}
                                                            {% endwith %}
                                                        {% else %}
                                                            {{ sentence.text }}
                                                        {% endif %}
                                                    </div>
                                                    
                                                    {% if sentence.keywords %}
                                                        <div class="small text-muted">
                                                            <strong>検出キーワード:</strong>
                                                            <div class="mt-1">
                                                                {% for keyword in sentence.keywords %}
                                                                    <span class="badge bg-success me-1 mb-1">{{ keyword }}</span>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    
                                    {% if samples.positive|length > 10 %}
                                        <div class="text-center mt-3">
                                            <small class="text-muted">
                                                他{{ samples.positive|length|add:"-10" }}件のポジティブ文章があります
                                            </small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                        
                        <div class="analysis-card card mb-4">
                            {% include 'earnings_analysis/ads/ad_responsive.html' %}
                        </div>
                        <!-- Negative sentences -->
                        {% if samples.negative %}
                            <div class="mb-4">
                                <h6 class="text-danger d-flex align-items-center justify-content-between">
                                    <span>
                                        <i class="fas fa-frown me-2"></i>ネガティブと判定された文章
                                    </span>
                                    <span class="badge bg-danger">{{ samples.negative|length }}件</span>
                                </h6>
                                
                                <div class="accordion" id="negativeAccordion">
                                    {% for sentence in samples.negative|slice:":10" %}
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="negative-heading-{{ forloop.counter }}">
                                                <button class="accordion-button" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#negative-collapse-{{ forloop.counter }}"
                                                        aria-expanded="true">
                                                    <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                                        <span class="fw-semibold text-danger">
                                                            スコア: {{ sentence.score|floatformat:2 }}
                                                        </span>
                                                        <span class="small text-muted">
                                                            {% if sentence.score < -0.7 %}
                                                                強いネガティブ
                                                            {% elif sentence.score < -0.4 %}
                                                                中程度のネガティブ
                                                            {% else %}
                                                                軽微なネガティブ
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                </button>
                                            </h2>
                                            <div id="negative-collapse-{{ forloop.counter }}" 
                                                 class="accordion-collapse collapse show"
                                                 data-bs-parent="#negativeAccordion">
                                                <div class="accordion-body">
                                                    <div class="mb-3">
                                                        {% if sentence.highlighted_text %}
                                                            {{ sentence.highlighted_text|safe }}
                                                        {% elif sentence.keywords %}
                                                            {% with highlighted_text=sentence.text|highlight_all_keywords:sentence.keywords %}
                                                                {{ highlighted_text|safe }}
                                                            {% endwith %}
                                                        {% else %}
                                                            {{ sentence.text }}
                                                        {% endif %}
                                                    </div>
                                                    
                                                    {% if sentence.keywords %}
                                                        <div class="small text-muted">
                                                            <strong>検出キーワード:</strong>
                                                            <div class="mt-1">
                                                                {% for keyword in sentence.keywords %}
                                                                    <span class="badge bg-danger me-1 mb-1">{{ keyword }}</span>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    
                                    {% if samples.negative|length > 10 %}
                                        <div class="text-center mt-3">
                                            <small class="text-muted">
                                                他{{ samples.negative|length|add:"-10" }}件のネガティブ文章があります
                                            </small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if not samples.positive and not samples.negative %}
                            <div class="text-center py-4">
                                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">特徴的な文章は検出されませんでした</h5>
                                <p class="text-muted">感情スコアが閾値を超える文章がありませんでした</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endwith %}
        {% endif %}
        <!-- User Insights -->
        <div class="analysis-card card mb-4">
            {% include 'earnings_analysis/ads/ad_responsive.html' %}
        </div>
        <div class="analysis-card card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>分析から読み取れる見解
                </h5>
            </div>
            <div class="card-body">
                {% if formatted_insights %}
                    <!-- Market Implications -->
                    {% if formatted_insights.market_implications %}
                        <div class="insight-section border rounded p-3 mb-4" style="background-color: #e7f3ff; border-color: #0d6efd !important;">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-chart-line me-2"></i>市場への影響分析
                            </h6>
                            {% if formatted_insights.market_implications.sentiment %}
                                <div class="mb-2">
                                    <strong class="text-dark">市場の反応予想:</strong> 
                                    <span class="text-body">{{ formatted_insights.market_implications.sentiment }}</span>
                                </div>
                            {% endif %}
                            {% if formatted_insights.market_implications.stock_impact %}
                                <div class="mb-0">
                                    <strong class="text-dark">株価への影響:</strong> 
                                    <span class="text-body">{{ formatted_insights.market_implications.stock_impact }}</span>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <!-- Strategy Reading -->
                    {% if formatted_insights.strategy_reading %}
                        <div class="insight-section border rounded p-3 mb-4" style="background-color: #e8f5e8; border-color: #198754 !important;">
                            <h6 class="text-success mb-3">
                                <i class="fas fa-chess me-2"></i>経営戦略の読み取り
                            </h6>
                            {% if formatted_insights.strategy_reading.management_stance %}
                                <div class="mb-2">
                                    <strong class="text-dark">経営スタンス:</strong> 
                                    <span class="text-body">{{ formatted_insights.strategy_reading.management_stance }}</span>
                                </div>
                            {% endif %}
                            {% if formatted_insights.strategy_reading.strategic_direction %}
                                <div class="mb-0">
                                    <strong class="text-dark">戦略的方向性:</strong> 
                                    <span class="text-body">{{ formatted_insights.strategy_reading.strategic_direction }}</span>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <!-- Risk Assessment -->
                    {% if formatted_insights.risk_assessment %}
                        <div class="insight-section border rounded p-3 mb-4" style="background-color: #fff3cd; border-color: #ffc107 !important;">
                            <h6 class="text-warning mb-3">
                                <i class="fas fa-shield-alt me-2"></i>リスク評価
                            </h6>
                            <div class="mb-2">
                                <strong class="text-dark">リスクレベル:</strong> 
                                {% if formatted_insights.risk_assessment.risk_level == 'high' %}
                                    <span class="badge bg-danger ms-2">高</span>
                                {% elif formatted_insights.risk_assessment.risk_level == 'medium' %}
                                    <span class="badge bg-warning ms-2">中</span>
                                {% else %}
                                    <span class="badge bg-success ms-2">低</span>
                                {% endif %}
                            </div>
                            {% if formatted_insights.risk_assessment.identified_risks %}
                                <div class="mb-0">
                                    <strong class="text-dark">特定されたリスク:</strong>
                                    <ul class="mt-2 mb-0">
                                        {% for risk in formatted_insights.risk_assessment.identified_risks %}
                                            <li class="text-body">{{ risk }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                {% else %}
                    <!-- Fallback insights -->
                    <div class="insight-section border rounded p-3 mb-4" style="background-color: #e7f3ff; border-color: #0d6efd !important;">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-chart-line me-2"></i>全体的な傾向
                        </h6>
                        {% if session.sentiment_label == 'positive' %}
                            <div class="mb-2">
                                <span class="text-body">この書類からは<strong class="text-success">前向きな経営姿勢</strong>が読み取れます。</span>
                            </div>
                            {% if session.overall_score > 0.6 %}
                                <div class="mb-0">
                                    <span class="text-body">特に、成長への意欲や収益改善への取り組みが強く表現されており、投資家にとって安心感を与える内容となっています。</span>
                                </div>
                            {% endif %}
                        {% elif session.sentiment_label == 'negative' %}
                            <div class="mb-2">
                                <span class="text-body">この書類からは<strong class="text-warning">慎重な経営スタンス</strong>や<strong class="text-danger">課題への言及</strong>が多く見られます。</span>
                            </div>
                            {% if session.overall_score < -0.6 %}
                                <div class="mb-0">
                                    <span class="text-body">リスクや困難な状況についての記述が目立ちますが、これは企業の透明性の表れとも捉えられます。</span>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="mb-0">
                                <span class="text-body">この書類は<strong class="text-info">バランスの取れた内容</strong>となっており、客観的な報告が主体となっています。</span>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
                
                <!-- Reliability Assessment -->
                {% if reliability_score %}
                    <div class="insight-section border rounded p-3 mb-4" style="background-color: {% if reliability_score.level == 'very_high' or reliability_score.level == 'high' %}#e8f5e8{% elif reliability_score.level == 'medium' %}#fff3cd{% else %}#f8f9fa{% endif %}; border-color: {% if reliability_score.level == 'very_high' or reliability_score.level == 'high' %}#198754{% elif reliability_score.level == 'medium' %}#ffc107{% else %}#6c757d{% endif %} !important;">
                        <h6 class="alert-heading {% if reliability_score.level == 'very_high' or reliability_score.level == 'high' %}text-success{% elif reliability_score.level == 'medium' %}text-warning{% else %}text-secondary{% endif %} mb-3">
                            <i class="fas fa-shield-check me-2"></i>分析の信頼性評価
                        </h6>
                        <div class="mb-2">
                            <span class="text-body">{{ reliability_score.description }}</span>
                        </div>
                        <div class="progress mb-2" style="height: 10px;">
                            <div class="progress-bar {% if reliability_score.score >= 80 %}bg-success{% elif reliability_score.score >= 60 %}bg-info{% elif reliability_score.score >= 40 %}bg-warning{% else %}bg-secondary{% endif %}" 
                                style="width: {{ reliability_score.score|score_percentage }}%">
                            </div>
                        </div>
                        {% if reliability_score.factors %}
                            <div class="mb-0">
                                <small class="text-muted">根拠: {{ reliability_score.factors|join:"、" }}</small>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
                
                <!-- Important Notice -->
                <div class="insight-section border rounded p-3" style="background-color: #e7f3ff; border-color: #0d6efd !important;">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-exclamation-circle text-primary me-2 mt-1"></i>
                        <div>
                            <strong class="text-dark">注意事項:</strong> 
                            <span class="text-body">この感情分析は文書の表現を機械的に分析したものです。投資判断や経営判断を行う際は、財務データや市場環境など他の要因も総合的に検討してください。</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-12 col-lg-4">
        <!-- Statistics -->
        {% if session.analysis_result.statistics %}
            {% with stats=session.analysis_result.statistics %}
                <div class="analysis-card card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>分析統計
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center g-2">
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="h6 text-primary mb-1">{{ stats.total_words_analyzed }}</div>
                                    <div class="small text-muted">分析語数</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="h6 text-info mb-1">{{ stats.context_patterns_found }}</div>
                                    <div class="small text-muted">文脈パターン</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="h6 text-success mb-1">{{ stats.basic_words_found }}</div>
                                    <div class="small text-muted">基本語彙</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <div class="h6 text-secondary mb-1">{{ stats.sentences_analyzed }}</div>
                                    <div class="small text-muted">分析文数</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="small text-muted mt-3">
                            <div class="mb-2">
                                <strong>文脈パターン:</strong> 「減収の改善」のような複合表現
                            </div>
                            <div>
                                <strong>基本語彙:</strong> 辞書に登録された個別の語
                            </div>
                        </div>
                    </div>
                </div>
            {% endwith %}
        {% endif %}
        
        <!-- Actions -->
        <div class="analysis-card card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-tools me-2"></i>アクション
                </h6>
            </div>
            <div class="card-body">
                <div class="action-buttons">
                    <a href="{% url 'earnings_analysis:sentiment-analysis' document.doc_id %}" 
                       class="btn btn-primary w-100">
                        <i class="fas fa-redo me-1"></i>再分析実行
                    </a>
                    <a href="{% url 'earnings_analysis:financial-analysis' document.doc_id %}" 
                       class="btn btn-outline-primary w-100">
                        <i class="fas fa-chart-pie me-1"></i>財務分析も実行
                    </a>
                    <a href="{% url 'earnings_analysis:document-detail-ui' document.doc_id %}" 
                       class="btn btn-outline-secondary w-100">
                        <i class="fas fa-arrow-left me-1"></i>書類詳細に戻る
                    </a>
                    <button type="button" class="btn btn-outline-info w-100" onclick="shareResult()">
                        <i class="fas fa-share me-1"></i>結果を共有
                    </button>
                    <button type="button" class="btn btn-outline-success w-100" onclick="exportSummary()">
                        <i class="fas fa-download me-1"></i>サマリー保存
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}

<!-- WordCloud2.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<!-- kuromoji.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js"></script>

<script>
// ========================================
// グローバル変数
// ========================================
let wordcloudInstance = null;
let currentWordcloudData = [];
let currentDisplayMode = 'sentiment'; // 'sentiment' or 'all'
let tokenizer = null; // kuromoji tokenizer

// 実際の分析データを取得
const actualAnalysisData = {
    keyword_frequency_data: {{ session.analysis_result.keyword_frequency_data|safe|default:'{}' }},
    statistics: {{ session.analysis_result.statistics|safe|default:'{}' }},
    sample_sentences: {{ session.analysis_result.sample_sentences|safe|default:'{}' }},
    keyword_analysis: {{ session.analysis_result.keyword_analysis|safe|default:'{}' }}
};

// ワードクラウドデータ構造
const actualWordcloudData = {
    sentiment: [],  // 感情語彙のみ
    all: [],        // 全語彙
    maxSize: 1,
    stats: {}
};

// ========================================
// kuromoji初期化
// ========================================
function initializeKuromoji() {
    console.log('kuromoji.js初期化開始...');
    
    // ローディング表示
    const canvas = document.getElementById('wordcloud-canvas');
    if (canvas) {
        canvas.innerHTML = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">辞書読み込み中...</span>
                    </div>
                    <div class="text-muted">
                        <div>日本語解析エンジンを初期化しています...</div>
                        <small>初回は少し時間がかかる場合があります</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    // kuromoji初期化
    kuromoji.builder({ 
        dicPath: "https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/" 
    }).build(function (err, _tokenizer) {
        if (err) {
            console.error('kuromoji初期化エラー:', err);
            showWordcloudError('日本語解析エンジンの初期化に失敗しました');
            // フォールバックとして簡易版を使用
            initializeWordcloudSimple();
            return;
        }
        
        console.log('kuromoji.js初期化完了');
        tokenizer = _tokenizer;
        
        // ワードクラウド初期化
        initializeWordcloud();
    });
}

// ========================================
// データ処理関数（kuromoji版）- 修正版
// ========================================

// 形態素解析を使った全語彙抽出（緩和版）
const STOP_WORDS = new Set([
    // 助詞
    'の', 'に', 'は', 'を', 'が', 'で', 'と', 'から', 'まで', 'より', 'へ', 'や', 'か',
    // 助動詞・動詞活用
    'だ', 'である', 'です', 'ます', 'だっ', 'であっ', 'でし', 'まし', 'た', 'て', 'し',
    // 代名詞
    'これ', 'それ', 'あれ', 'この', 'その', 'あの', 'ここ', 'そこ', 'あそこ',
    // 一般的な語
    'こと', 'もの', 'ため', 'よう', 'など', 'なる', 'ある', 'いる', 'する', 'れる', 'られる', 'となりました', 'があるか',
    // 数詞・記号
    '一', '二', '三', '四', '五', '六', '七', '八', '九', '十', '百', '千', '万', '億',
    // 接頭・接尾辞
    'ご', 'お', 'さん', 'くん', 'ちゃん', '様', '氏', '君', '社', '部', '課', '店', '号', '番', '名', '社名', '会社名', '部署名', '商品名',
    // その他の一般的な語
    'あのような', 'このような', 'そのような', 'あのように', 'このように', 'そのように', 'あのこと', 'このこと', 'そのこと',
    'あのもの', 'このもの', 'そのもの', 'あのため', 'このため', 'そのため', 'あのようなこと', 'このようなこと', 'そのようなこと',
    'あのようなもの', 'このようなもの', 'そのようなもの', 'あのようにする', 'このようにする', 'そのようにする',
    
]);

// 形態素解析による高精度な単語抽出
function extractAllWordsFromSentences() {
    if (!tokenizer) {
        console.warn('tokenizerが初期化されていません');
        return {};
    }
    
    const wordFrequency = {};
    const sentences = collectSentences();
    
    console.log('抽出対象文章数:', sentences.length);
    
    sentences.forEach((sentenceObj, index) => {
        if (!sentenceObj.text) return;
        
        // HTMLタグと特殊文字を除去
        const cleanText = cleanSentenceText(sentenceObj.text);
        
        try {
            // 形態素解析実行
            const tokens = tokenizer.tokenize(cleanText);
            console.log(`文章${index + 1}: "${cleanText.substring(0, 50)}..." -> ${tokens.length}トークン`);
            
            tokens.forEach(token => {
                const word = processToken(token);
                if (word && isValidWord(word, token)) {
                    wordFrequency[word] = (wordFrequency[word] || 0) + 1;
                }
            });
            
        } catch (error) {
            console.error(`文章${index + 1}の形態素解析エラー:`, error);
        }
    });
    
    // 結果をログ出力
    logExtractionResults(wordFrequency);
    
    return wordFrequency;
}

function logExtractionResults(wordFrequency) {
    const sortedWords = Object.entries(wordFrequency)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 20);
    
    console.log('=== 形態素解析結果 ===');
    console.log('総語彙数:', Object.keys(wordFrequency).length);
    console.log('上位20語:');
    sortedWords.forEach(([word, count], index) => {
        console.log(`${index + 1}. ${word}: ${count}回`);
    });
    console.log('=====================');
}


// 文章データの収集
function collectSentences() {
    const sentences = [];
    
    if (actualAnalysisData.sample_sentences) {
        if (actualAnalysisData.sample_sentences.positive) {
            sentences.push(...actualAnalysisData.sample_sentences.positive);
        }
        if (actualAnalysisData.sample_sentences.negative) {
            sentences.push(...actualAnalysisData.sample_sentences.negative);
        }
    }
    
    return sentences;
}


// 有効な単語かどうかの判定
function isValidWord(word, token) {
    const pos = token.pos;
    const posDetail1 = token.pos_detail_1;
    const posDetail2 = token.pos_detail_2;
    
    // 基本的な除外条件
    if (STOP_WORDS.has(word)) return false;
    if (word.length < 2) return false;
    if (/^[0-9０-９]+$/.test(word)) return false;        // 数字のみ
    if (/^[a-zA-Z]+$/.test(word)) return false;          // 英字のみ
    if (/^[\s　\-\+\*\/\=\<\>\!\?]+$/.test(word)) return false; // 記号のみ
    
    // 品詞による詳細フィルタリング
    switch (pos) {
        case '名詞':
            // 有効な名詞の種類
            const validNounTypes = ['一般', '固有名詞', 'サ変接続', '形容動詞語幹'];
            if (!validNounTypes.includes(posDetail1)) return false;
            
            // 特定の名詞は除外
            if (posDetail1 === '数' || posDetail1 === '非自立') return false;
            if (posDetail2 === '人名' || posDetail2 === '地域') return false; // 個人情報保護
            break;
            
        case '動詞':
            // 自立動詞のみ
            if (posDetail1 === '非自立') return false;
            break;
            
        case '形容詞':
            // 自立形容詞のみ
            if (posDetail1 === '非自立') return false;
            break;
            
        case '副詞':
            // 一般的な副詞のみ
            if (posDetail1 !== '一般') return false;
            break;
            
        default:
            // その他の品詞は基本的に除外
            return false;
    }
    
    return true;
}

// 文章テキストのクリーニング
function cleanSentenceText(text) {
    return text
        .replace(/<[^>]*>/g, '')                    // HTMLタグ除去
        .replace(/&[a-zA-Z0-9#]+;/g, '')            // HTML実体参照除去
        .replace(/https?:\/\/[^\s]+/g, '')          // URL除去
        .replace(/[【】『』「」（）()［］｛｝]/g, '') // 括弧除去
        .replace(/[・※★☆♪♫]/g, '')               // 記号除去
        .replace(/\s+/g, ' ')                       // 空白正規化
        .trim();
}

// トークン処理
function processToken(token) {
    let word = token.surface_form;
    const pos = token.pos;
    const posDetail1 = token.pos_detail_1;
    const posDetail2 = token.pos_detail_2;
    const basicForm = token.basic_form;
    
    // 動詞・形容詞は基本形を使用
    if ((pos === '動詞' || pos === '形容詞') && basicForm && basicForm !== '*') {
        word = basicForm;
    }
    
    // 名詞の複合語処理
    if (pos === '名詞' && posDetail1 === '一般' && word.length >= 4) {
        // 長い名詞は分割を検討（例：「株式会社」→「株式」「会社」）
        const subTokens = tokenizer.tokenize(word);
        if (subTokens.length > 1) {
            // 複合語の場合は元の語を使用
            return word;
        }
    }
    
    return word;
}


function extractAllWordsSimple() {
    console.log('簡易版単語抽出を開始');
    
    const wordFrequency = {};
    const sentences = collectSentences();
    
    sentences.forEach((sentenceObj, index) => {
        if (!sentenceObj.text) return;
        
        const cleanText = cleanSentenceText(sentenceObj.text);
        
        // 日本語の単語境界を考慮した分割
        const words = segmentJapaneseText(cleanText);
        
        words.forEach(word => {
            if (isValidSimpleWord(word)) {
                wordFrequency[word] = (wordFrequency[word] || 0) + 1;
            }
        });
    });
    
    console.log('簡易版: 抽出語彙数', Object.keys(wordFrequency).length);
    
    // 結果をログ出力
    logExtractionResults(wordFrequency);
    
    return wordFrequency;
}

// 日本語テキストの単語分割（簡易版）
function segmentJapaneseText(text) {
    const words = [];
    
    // 句読点と記号で分割
    const sentences = text.split(/[。！？\n]/);
    
    sentences.forEach(sentence => {
        // カンマや読点で分割
        const phrases = sentence.split(/[、，,]/);
        
        phrases.forEach(phrase => {
            // 空白で分割
            const tokens = phrase.split(/[\s　]+/);
            
            tokens.forEach(token => {
                if (token.length === 0) return;
                
                // 長い文字列を文字種で分割
                const segmented = segmentByCharacterType(token);
                words.push(...segmented);
            });
        });
    });
    
    return words.filter(word => word.length > 0);
}

// 文字種による分割
function segmentByCharacterType(text) {
    const words = [];
    let currentWord = '';
    let currentType = '';
    
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        let charType = getCharacterType(char);
        
        if (charType !== currentType) {
            if (currentWord.length > 0) {
                words.push(currentWord);
            }
            currentWord = char;
            currentType = charType;
        } else {
            currentWord += char;
        }
    }
    
    if (currentWord.length > 0) {
        words.push(currentWord);
    }
    
    return words;
}

// 文字種判定
function getCharacterType(char) {
    const code = char.charCodeAt(0);
    
    if ((code >= 0x3040 && code <= 0x309F)) return 'hiragana';    // ひらがな
    if ((code >= 0x30A0 && code <= 0x30FF)) return 'katakana';    // カタカナ
    if ((code >= 0x4E00 && code <= 0x9FAF)) return 'kanji';       // 漢字
    if ((code >= 0xFF10 && code <= 0xFF19) || (code >= 0x30 && code <= 0x39)) return 'number'; // 数字
    if ((code >= 0x41 && code <= 0x5A) || (code >= 0x61 && code <= 0x7A) || 
        (code >= 0xFF21 && code <= 0xFF3A) || (code >= 0xFF41 && code <= 0xFF5A)) return 'alphabet'; // 英字
    
    return 'other';
}

// 簡易版の単語有効性チェック
function isValidSimpleWord(word) {
    // 基本的な除外条件
    if (STOP_WORDS.has(word)) return false;
    if (word.length < 2) return false;
    if (/^[0-9０-９]+$/.test(word)) return false;
    if (/^[a-zA-Z]+$/.test(word)) return false;
    if (/^[\s　\-\+\*\/\=\<\>\!\?、。，．]+$/.test(word)) return false;
    
    // ひらがなのみの短い語は除外
    if (word.length <= 2 && /^[ぁ-ゟ]+$/.test(word)) return false;
    
    return true;
}

// ========================================
// デバッグ用ヘルパー関数
// ========================================

function debugTokenization(sampleText) {
    if (!tokenizer) {
        console.log('Tokenizerが初期化されていません');
        return;
    }
    
    console.log('=== トークン化デバッグ ===');
    console.log('入力:', sampleText);
    
    const tokens = tokenizer.tokenize(sampleText);
    tokens.forEach((token, index) => {
        console.log(`${index + 1}. ${token.surface_form} (${token.pos}-${token.pos_detail_1})`);
    });
    
    console.log('========================');
}

// ワードクラウドデータ変換時のデバッグ情報追加
function convertToWordcloudDataWithDebug(frequencyData, includeAll = false) {
    console.log('=== ワードクラウドデータ変換開始 ===');
    console.log('入力データ:', frequencyData);
    console.log('全語彙モード:', includeAll);
    
    const result = convertToWordcloudData(frequencyData, includeAll);
    
    console.log('変換結果:', result.length, '語');
    console.log('感情別内訳:');
    console.log('- ポジティブ:', result.filter(w => w.sentiment === 'positive').length);
    console.log('- ネガティブ:', result.filter(w => w.sentiment === 'negative').length);
    console.log('- 中立:', result.filter(w => w.sentiment === 'neutral').length);
    console.log('================================');
    
    return result;
}

// 実際のデータをワードクラウド用に変換（修正版）
function convertToWordcloudData(frequencyData, includeAll = false) {
    const wordcloudData = [];
    const sentimentWords = new Set();
    
    console.log('convertToWordcloudData開始:', { frequencyData, includeAll });
    
    // ポジティブ語彙を追加
    if (frequencyData.positive) {
        console.log('ポジティブ語彙数:', frequencyData.positive.length);
        frequencyData.positive.forEach(item => {
            sentimentWords.add(item.word);
            wordcloudData.push({
                text: item.word,
                size: item.count,
                sentiment: "positive",
                score: item.score,
                color: "#28a745"
            });
        });
    }
    
    // ネガティブ語彙を追加
    if (frequencyData.negative) {
        console.log('ネガティブ語彙数:', frequencyData.negative.length);
        frequencyData.negative.forEach(item => {
            sentimentWords.add(item.word);
            wordcloudData.push({
                text: item.word,
                size: item.count,
                sentiment: "negative",
                score: item.score,
                color: "#dc3545"
            });
        });
    }
    
    // 全語彙モードの場合
    if (includeAll) {
        let allWords;
        if (tokenizer) {
            console.log('kuromojiで全語彙抽出');
            allWords = extractAllWordsFromSentences();
        } else {
            console.log('簡易版で全語彙抽出');
            allWords = extractAllWordsSimple();
        }
        
        console.log('全語彙抽出結果:', Object.keys(allWords).length, '語');
        
        // 出現回数2回以上の語彙を追加（条件を緩和）
        Object.entries(allWords).forEach(([word, count]) => {
            // 既に感情語彙に含まれていない、かつ出現回数1回以上
            if (!sentimentWords.has(word) && count >= 1) {
                wordcloudData.push({
                    text: word,
                    size: count,
                    sentiment: "neutral",
                    score: 0,
                    color: "#6c757d"
                });
            }
        });
    }
    
    // 出現回数でソート
    wordcloudData.sort((a, b) => b.size - a.size);
    
    console.log('最終的なワードクラウドデータ数:', wordcloudData.length);
    console.log('上位10語:', wordcloudData.slice(0, 10).map(w => `${w.text}(${w.size}回)`));
    
    // データが存在しない場合のフォールバック
    if (wordcloudData.length === 0) {
        return [{
            text: "データなし",
            size: 1,
            sentiment: "neutral",
            score: 0.0,
            color: "#6c757d"
        }];
    }
    
    return wordcloudData;
}

// ========================================
// 簡易版フォールバック
// ========================================
function initializeWordcloudSimple() {
    console.log('簡易版ワードクラウドで初期化');
    tokenizer = null; // tokenizerをnullに設定
    initializeWordcloud();
}

// ========================================
// その他の関数は前回と同じ
// ========================================

// 統計表示の更新
function updateStatisticsDisplay() {
    const currentData = currentDisplayMode === 'all' ? actualWordcloudData.all : actualWordcloudData.sentiment;
    const stats = calculateStats(currentData);
    
    document.getElementById('total-words').textContent = stats.total_unique_words;
    document.getElementById('total-occurrences').textContent = stats.total_occurrences;
    document.getElementById('max-occurrences').textContent = currentData.length > 0 ? Math.max(...currentData.map(w => w.size)) : 0;
    
    // 感情別統計の要素が存在する場合のみ更新
    const positiveCountEl = document.getElementById('positive-count');
    const negativeCountEl = document.getElementById('negative-count');
    const neutralCountEl = document.getElementById('neutral-count');
    
    if (positiveCountEl) positiveCountEl.textContent = stats.positive_count;
    if (negativeCountEl) negativeCountEl.textContent = stats.negative_count;
    if (neutralCountEl) neutralCountEl.textContent = stats.neutral_count;
    
    // 全語彙モードの場合は感情別統計を表示
    const sentimentStatsElement = document.getElementById('sentiment-stats');
    if (sentimentStatsElement) {
        if (currentDisplayMode === 'all') {
            sentimentStatsElement.classList.remove('d-none');
        } else {
            sentimentStatsElement.classList.add('d-none');
        }
    }
}

// 統計情報の計算
function calculateStats(wordcloudData) {
    return {
        total_unique_words: wordcloudData.length,
        total_occurrences: wordcloudData.reduce((sum, w) => sum + w.size, 0),
        positive_count: wordcloudData.filter(w => w.sentiment === 'positive').length,
        negative_count: wordcloudData.filter(w => w.sentiment === 'negative').length,
        neutral_count: wordcloudData.filter(w => w.sentiment === 'neutral').length
    };
}

// 表示語数更新
function updateDisplayedCount(count) {
    const countElement = document.getElementById('wordcloud-displayed-count');
    if (countElement) {
        countElement.textContent = count;
    }
}

// ワードクラウド生成
function generateWordcloud(wordsData) {
    console.log('ワードクラウド生成開始:', wordsData.length, '語');
    
    const canvas = document.getElementById('wordcloud-canvas');
    if (!canvas) {
        console.error('キャンバス要素が見つかりません');
        return;
    }
    
    if (!wordsData || wordsData.length === 0) {
        showWordcloudError('表示する語彙がありません');
        return;
    }
    
    // キャンバスクリア
    canvas.innerHTML = '';
    
    // キャンバスサイズ設定
    const containerWidth = canvas.offsetWidth;
    const containerHeight = Math.max(500, containerWidth * 0.7);
    canvas.style.height = containerHeight + 'px';
    
    // WordCloud2.js用のデータ変換
    const wordcloudList = wordsData.map(word => {
        // 文字サイズを語彙の出現頻度に基づいて差別化
        let fontSize;
        
        if (word.size >= 20) {
            fontSize = Math.min(100, word.size * 3 + 40);
        } else if (word.size >= 10) {
            fontSize = Math.min(80, word.size * 2.5 + 30);
        } else if (word.size >= 5) {
            fontSize = Math.min(60, word.size * 2 + 20);
        } else {
            fontSize = Math.min(40, word.size * 1.5 + 15);
        }
        
        fontSize = Math.max(16, fontSize);
        
        return [word.text, fontSize, null, null, null, null, word.color];
    });
    
    try {
        // ワードクラウド生成
        WordCloud(canvas, {
            list: wordcloudList,
            gridSize: Math.round(24 * containerWidth / 1024),
            weightFactor: function(size) {
                return Math.pow(size, 0.9) * containerWidth / 512;
            },
            fontFamily: '"Hiragino Kaku Gothic Pro", "ヒラギノ角ゴ Pro", "Yu Gothic", "游ゴシック", Meiryo, "メイリオ", sans-serif',
            color: function(word, weight, fontSize, distance, theta) {
                const wordData = wordsData.find(w => w.text === word);
                return wordData ? wordData.color : '#666';
            },
            backgroundColor: 'transparent',
            rotateRatio: 0.3,
            maxRotation: Math.PI / 6,
            minRotation: -Math.PI / 6,
            shuffle: true,
            rotationSteps: 2,
            ellipticity: 0.6,
            shrinkToFit: true,
            hover: function(item, dimension, event) {
                if (item) {
                    showWordTooltip(item[0], item[1], event);
                } else {
                    hideWordTooltip();
                }
            },
            click: function(item, dimension, event) {
                if (item) {
                    highlightWord(item[0]);
                }
            }
        });
        
        // 表示語数更新
        updateDisplayedCount(wordsData.length);
        
        console.log('ワードクラウド生成完了');
        
    } catch (error) {
        console.error('ワードクラウド生成エラー:', error);
        showWordcloudError('ワードクラウドの生成に失敗しました');
    }
}

// エラー表示
function showWordcloudError(message) {
    const canvas = document.getElementById('wordcloud-canvas');
    if (canvas) {
        canvas.innerHTML = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center text-muted">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <div>${message}</div>
                    <button class="btn btn-sm btn-primary mt-3" onclick="initializeWordcloudSimple()">
                        簡易版で再試行
                    </button>
                </div>
            </div>
        `;
    }
}

// ツールチップ表示
function showWordTooltip(word, weight, event) {
    const wordData = currentWordcloudData.find(w => w.text === word);
    if (!wordData) return;
    
    // 既存のツールチップ削除
    hideWordTooltip();
    
    const tooltip = document.createElement('div');
    tooltip.id = 'wordcloud-tooltip';
    tooltip.className = 'position-absolute bg-dark text-white p-2 rounded shadow-sm small';
    tooltip.style.zIndex = '1000';
    tooltip.style.pointerEvents = 'none';
    
    const sentimentText = wordData.sentiment === 'positive' ? 'ポジティブ' : 
                        wordData.sentiment === 'negative' ? 'ネガティブ' : '中立';
    tooltip.innerHTML = `
        <div><strong>${word}</strong></div>
        <div>出現回数: ${wordData.size}回</div>
        <div>感情: ${sentimentText}</div>
        ${wordData.score !== 0 ? `<div>スコア: ${wordData.score.toFixed(2)}</div>` : ''}
    `;
    
    document.body.appendChild(tooltip);
    
    // 位置調整
    const rect = tooltip.getBoundingClientRect();
    tooltip.style.left = (event.pageX - rect.width / 2) + 'px';
    tooltip.style.top = (event.pageY - rect.height - 10) + 'px';
}

// ツールチップ非表示
function hideWordTooltip() {
    const tooltip = document.getElementById('wordcloud-tooltip');
    if (tooltip) {
        tooltip.remove();
    }
}

// 語彙強調
function highlightWord(word) {
    const wordData = currentWordcloudData.find(w => w.text === word);
    if (wordData) {
        const sentimentText = wordData.sentiment === 'positive' ? 'ポジティブ' : 
                            wordData.sentiment === 'negative' ? 'ネガティブ' : '中立';
        const message = `「${word}」: ${wordData.size}回出現、${sentimentText}`;
        showToast(message, 'info');
    }
}

// イベントリスナー設定
function setupWordcloudEvents() {
    // 表示切り替えボタン
    const sentimentBtn = document.getElementById('wordcloud-sentiment-btn');
    const allBtn = document.getElementById('wordcloud-all-btn');
    
    if (sentimentBtn && allBtn) {
        sentimentBtn.addEventListener('click', function() {
            if (currentDisplayMode !== 'sentiment') {
                currentDisplayMode = 'sentiment';
                this.classList.add('active', 'btn-primary');
                this.classList.remove('btn-outline-primary');
                allBtn.classList.remove('active', 'btn-primary');
                allBtn.classList.add('btn-outline-primary');
                
                // 感情語彙のみのデータに切り替え
                applyCurrentFilters();
            }
        });
        
        allBtn.addEventListener('click', function() {
            if (currentDisplayMode !== 'all') {
                currentDisplayMode = 'all';
                this.classList.add('active', 'btn-primary');
                this.classList.remove('btn-outline-primary');
                sentimentBtn.classList.remove('active', 'btn-primary');
                sentimentBtn.classList.add('btn-outline-primary');
                
                // 全語彙が未生成の場合は生成
                if (actualWordcloudData.all.length === 0) {
                    console.log('全語彙データ生成開始');
                    actualWordcloudData.all = convertToWordcloudData(actualAnalysisData.keyword_frequency_data || {}, true);
                }
                
                // 全語彙のデータに切り替え
                applyCurrentFilters();
            }
        });
    }
    
    // 更新ボタン
    const updateBtn = document.getElementById('wordcloud-update-btn');
    if (updateBtn) {
        updateBtn.addEventListener('click', function() {
            applyCurrentFilters();
        });
    }
    
    // リサイズ対応
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            if (currentWordcloudData.length > 0) {
                generateWordcloud(currentWordcloudData);
            }
        }, 300);
    });
}

// フィルター適用
function applyCurrentFilters() {
    const minCount = parseInt(document.getElementById('wordcloud-min-count').value || '2');
    const maxWords = parseInt(document.getElementById('wordcloud-max-words').value || '50');
    
    // 現在のモードに応じたデータを取得
    const sourceData = currentDisplayMode === 'all' ? actualWordcloudData.all : actualWordcloudData.sentiment;
    
    console.log('フィルター適用:', { mode: currentDisplayMode, sourceDataLength: sourceData.length, minCount, maxWords });
    
    // 出現回数でフィルター
    let filteredData = sourceData.filter(word => word.size >= minCount);
    
    // 語数制限
    if (maxWords > 0) {
        filteredData = filteredData.slice(0, maxWords);
    }
    
    console.log('フィルター後のデータ数:', filteredData.length);
    
    currentWordcloudData = filteredData;
    generateWordcloud(filteredData);
    updateStatisticsDisplay();
}

// ワードクラウド初期化
function initializeWordcloud() {
    console.log('ワードクラウド初期化開始');
    console.log('分析データ:', actualAnalysisData);
    
    // 感情語彙のみのデータを作成
    actualWordcloudData.sentiment = convertToWordcloudData(actualAnalysisData.keyword_frequency_data || {}, false);
    
    // 全語彙のデータは遅延生成（クリック時）
    actualWordcloudData.all = [];
    
    console.log('感情語彙数:', actualWordcloudData.sentiment.length);
    
    // 初期表示は感情語彙のみ
    currentDisplayMode = 'sentiment';
    applyCurrentFilters();
    
    // イベントリスナー設定
    setupWordcloudEvents();
}

// Toast notification
function showToast(message, type = 'info') {
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0`;
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    container.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
}

// その他の機能（共有・エクスポート）
function shareResult() {
    const url = window.location.href;
    const title = `感情分析結果: {{ document.company_name }} (スコア: {{ session.overall_score|floatformat:2 }})`;
    
    if (navigator.share) {
        navigator.share({
            title: title,
            url: url
        }).catch(error => {
            console.log('Share failed:', error);
            fallbackShare(url, title);
        });
    } else {
        fallbackShare(url, title);
    }
}

function fallbackShare(url, title) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
            showToast('URLをコピーしました', 'success');
        }).catch(() => {
            promptShare(url);
        });
    } else {
        promptShare(url);
    }
}

function promptShare(url) {
    const textarea = document.createElement('textarea');
    textarea.value = url;
    document.body.appendChild(textarea);
    textarea.select();
    try {
        document.execCommand('copy');
        showToast('URLをコピーしました', 'success');
    } catch (err) {
        prompt('URLをコピーしてください:', url);
    }
    document.body.removeChild(textarea);
}

function exportSummary() {
    const summary = {
        company: '{{ document.company_name }}',
        document: '{{ document.doc_description }}',
        analysis_date: '{{ session.created_at|date:"Y-m-d H:i:s" }}',
        overall_score: {{ session.overall_score }},
        sentiment_label: '{{ session.sentiment_label }}',
        positive_words: {{ session.analysis_result.score_calculation.positive_scores|length|default:0 }},
        negative_words: {{ session.analysis_result.score_calculation.negative_scores|length|default:0 }},
        total_analyzed_words: {{ session.analysis_result.statistics.total_words_analyzed|default:0 }},
        key_insights: [
            {% if session.sentiment_label == 'positive' %}
                '前向きな経営姿勢が表れている',
                '成長への期待が持てる内容'
            {% elif session.sentiment_label == 'negative' %}
                'リスクや課題への言及が多い',
                '慎重な経営スタンス'
            {% else %}
                'バランスの取れた客観的な内容',
                '安定した状況を示している'
            {% endif %}
        ]
    };
    
    const blob = new Blob([JSON.stringify(summary, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sentiment_analysis_${summary.company}_${summary.analysis_date.replace(/[: ]/g, '_')}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
    // アニメーション効果
    const cards = document.querySelectorAll('.analysis-card');
    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry, index) => {
            if (entry.isIntersecting) {
                setTimeout(() => {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }, index * 100);
            }
        });
    }, { threshold: 0.1 });

    cards.forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(card);
    });

    // kuromoji初期化（辞書読み込みを含む）
    initializeKuromoji();
    
    // ページトップへスクロール
    window.scrollTo({ top: 0, behavior: 'smooth' });
});
</script>
{% endblock %}