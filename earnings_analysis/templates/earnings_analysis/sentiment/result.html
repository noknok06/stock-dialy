<!-- earnings_analysis/templates/earnings_analysis/sentiment/result.html -->
{% extends 'earnings_analysis/base.html' %}
{% load static %}
{% load sentiment_filters %}

{% block title %}感情分析結果 - {{ document.company_name }} -コポモ{% endblock %}

{% block extra_css %}
<style>
    /* ========== 共通スタイル ========== */
    .analysis-card {
        margin-bottom: 1.5rem;
        animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ========== スコア表示エリア ========== */
    .score-main-display {
        padding: 2rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%);
        border-radius: 1rem;
    }
    
    .score-circle-container {
        filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.1));
    }
    
    .score-circle-container svg circle {
        transition: stroke-dashoffset 2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .score-number-large {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1.2;
    }
    
    .score-indicator {
        transition: left 2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========== 分析タブ ========== */
    .analysis-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid var(--border-light);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .analysis-tab {
        padding: 0.75rem 1.5rem;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        color: var(--text-secondary);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    
    .analysis-tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }
    
    .analysis-tab:hover:not(.active) {
        color: var(--text-primary);
    }
    
    .tab-content-panel {
        display: none;
        animation: fadeIn 0.3s ease-in;
    }
    
    .tab-content-panel.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* ========== AI分析セクション ========== */
    .ai-grade-display {
        text-align: center;
        padding: 2rem;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
        border-radius: 1rem;
        margin-bottom: 2rem;
    }
    
    .ai-grade-badge {
        font-size: 4rem;
        font-weight: 800;
        padding: 1rem 2rem;
        border-radius: 1rem;
        display: inline-block;
        margin-bottom: 1rem;
    }
    
    .ai-score-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .score-box {
        padding: 1.5rem;
        border-radius: 0.75rem;
        text-align: center;
    }
    
    .score-box.primary {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border: 2px solid #93c5fd;
    }
    
    .score-box.secondary {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        border: 2px solid #d1d5db;
    }

    /* ========== 詳細スコア ========== */
    .detailed-scores-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
        margin: 1.5rem 0;
    }
    
    .score-item {
        text-align: center;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: 0.5rem;
        border: 1px solid var(--border-light);
    }
    
    .score-item-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.25rem;
    }
    
    .score-item-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    /* ========== 投資ポイント ========== */
    .investment-points {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .point-card {
        padding: 1rem;
        border-radius: 0.5rem;
        border-left: 4px solid;
        background: var(--bg-primary);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
    }
    
    .point-card:hover {
        transform: translateX(4px);
    }
    
    .point-card.positive {
        border-left-color: var(--success-color);
        background: linear-gradient(90deg, rgba(16, 185, 129, 0.05) 0%, transparent 100%);
    }
    
    .point-card.negative {
        border-left-color: var(--danger-color);
        background: linear-gradient(90deg, rgba(239, 68, 68, 0.05) 0%, transparent 100%);
    }
    
    .point-card.neutral {
        border-left-color: var(--gray-400);
    }
    
    .point-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .point-title {
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .importance-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .importance-badge.high {
        background: var(--danger-color);
        color: white;
    }
    
    .importance-badge.medium {
        background: var(--warning-color);
        color: white;
    }
    
    .importance-badge.low {
        background: var(--info-color);
        color: white;
    }

    /* ========== ワードクラウドセクション ========== */
    .wordcloud-controls {
        background: var(--bg-secondary);
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .wordcloud-canvas {
        cursor: pointer;
        border: 1px solid var(--border-light);
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        min-height: 400px;
        border-radius: 0.5rem;
        overflow: hidden;
    }

    /* ========== サンプル文章セクション ========== */
    .sentence-accordion .accordion-item {
        border: 1px solid var(--border-light);
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
        overflow: hidden;
    }
    
    .sentence-accordion .accordion-button {
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-weight: 600;
    }
    
    .sentence-accordion .accordion-button:not(.collapsed) {
        background: var(--primary-color);
        color: white;
    }
    
    .keyword-highlight {
        background-color: #fff3cd;
        padding: 0.15rem 0.3rem;
        border-radius: 0.25rem;
        font-weight: 600;
        border: 1px solid #ffc107;
    }

    /* ========== サイドバー ========== */
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }
    
    .stat-box {
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: 0.5rem;
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    /* ========== レスポンシブ対応 ========== */
    @media (max-width: 991.98px) {
        .score-main-display {
            padding: 1.5rem;
        }
        
        .ai-score-comparison {
            grid-template-columns: 1fr;
        }
        
        .detailed-scores-grid {
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        }
    }
    
    @media (max-width: 767.98px) {
        .analysis-tabs {
            gap: 0.25rem;
        }
        
        .analysis-tab {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .score-circle-container {
            width: 150px !important;
            height: 150px !important;
        }
        
        .score-number-large {
            font-size: 1.8rem !important;
        }
        
        .ai-grade-badge {
            font-size: 3rem;
            padding: 0.75rem 1.5rem;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .wordcloud-canvas {
            min-height: 350px !important;
        }
    }
    
    @media (max-width: 575.98px) {
        .score-main-display {
            padding: 1rem;
        }
        
        .score-circle-container {
            width: 120px !important;
            height: 120px !important;
        }
        
        .score-number-large {
            font-size: 1.5rem !important;
        }
        
        .ai-grade-badge {
            font-size: 2.5rem;
        }
        
        .detailed-scores-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        
        .wordcloud-canvas {
            min-height: 300px !important;
        }
    }
    
    @media (prefers-reduced-motion: reduce) {
        .analysis-card,
        .point-card,
        .score-indicator,
        svg circle {
            animation: none !important;
            transition: none !important;
        }
    }
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'copomo:index' %}">ホーム</a></li>
        <li class="breadcrumb-item"><a href="{% url 'copomo:document-detail-ui' document.doc_id %}">{{ document.doc_id }}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'copomo:sentiment-analysis' document.doc_id %}">感情分析</a></li>
        <li class="breadcrumb-item active">分析結果</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<!-- ヘッダー -->
<div class="page-header mb-4">
    <div class="row align-items-center g-3">
        <div class="col-12 col-md-8">
            <h1 class="h3 mb-2">
                <i class="fas fa-chart-line me-2"></i>感情分析結果
            </h1>
            <p class="h6 mb-2 opacity-90">{{ document.company_name }}</p>
            <p class="mb-0 opacity-80 small">{{ document.doc_description }}</p>
        </div>
        <div class="col-12 col-md-4 text-center text-md-end">
            <div class="d-flex flex-column gap-2">
                <div class="badge bg-primary px-3 py-2">
                    <i class="fas fa-calendar me-1"></i>{{ session.created_at|date:"Y/m/d H:i" }}
                </div>
                <div class="badge bg-success px-3 py-2">
                    <i class="fas fa-check me-1"></i>分析完了
                </div>
                {% if time_remaining %}
                    <div class="badge bg-info px-3 py-2">
                        <i class="fas fa-clock me-1"></i>期限: {{ session.expires_at|date:"m/d H:i" }}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row g-3 g-md-4">
    <!-- メインコンテンツエリア -->
    <div class="col-12 col-lg-8">
        <!-- 全体スコア表示 -->
        <div class="analysis-card card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-thermometer-half me-2"></i>総合評価スコア
                </h5>
            </div>
            <div class="card-body">
                <div class="score-main-display">
                    <div class="row align-items-center g-4">
                        <!-- スコア円グラフ -->
                        <div class="col-12 col-lg-6 text-center">
                            <div class="score-circle-container mb-3" style="position: relative; width: 200px; height: 200px; margin: 0 auto;">
                                <svg width="200" height="200" viewBox="0 0 200 200" style="position: absolute; top: 0; left: 0;">
                                    <circle cx="100" cy="100" r="80" fill="none" stroke="#e9ecef" stroke-width="12"></circle>
                                    <circle id="score-arc" cx="100" cy="100" r="80" fill="none" 
                                            stroke-width="12" 
                                            stroke-dasharray="502.65" 
                                            stroke-dashoffset="502.65"
                                            style="transform: rotate(-90deg); transform-origin: center; transition: stroke-dashoffset 2s cubic-bezier(0.4, 0, 0.2, 1);">
                                    </circle>
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 100%;">
                                    <div class="score-number-large" id="animated-score">0.000</div>
                                    <div style="margin-top: 0.5rem;">
                                        {% if session.sentiment_label == 'positive' %}
                                            <span class="badge bg-success" style="font-size: 0.875rem; padding: 0.35em 0.65em;" id="sentiment-badge">
                                                <i class="fas fa-smile me-1"></i>ポジティブ
                                            </span>
                                        {% elif session.sentiment_label == 'negative' %}
                                            <span class="badge bg-danger" style="font-size: 0.875rem; padding: 0.35em 0.65em;" id="sentiment-badge">
                                                <i class="fas fa-frown me-1"></i>ネガティブ
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary" style="font-size: 0.875rem; padding: 0.35em 0.65em;" id="sentiment-badge">
                                                <i class="fas fa-meh me-1"></i>中立
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- スコア範囲ガイド -->
                            <div class="mt-3" style="max-width: 300px; margin-left: auto; margin-right: auto;">
                                <div class="d-flex justify-content-between mb-2">
                                    <small class="text-danger fw-bold">-1.0</small>
                                    <small class="text-muted">スコア範囲</small>
                                    <small class="text-success fw-bold">+1.0</small>
                                </div>
                                <div class="position-relative" style="height: 12px;">
                                    <div class="progress" style="height: 8px; margin-top: 2px;">
                                        <div class="progress-bar bg-danger" style="width: 50%"></div>
                                        <div class="progress-bar bg-success" style="width: 50%"></div>
                                    </div>
                                    <div class="score-indicator" id="score-position" 
                                        style="position: absolute; top: 0; width: 12px; height: 12px; 
                                                background: #007bff; border: 2px solid white; border-radius: 50%; 
                                                box-shadow: 0 2px 4px rgba(0,0,0,0.3); transform: translateX(-50%);
                                                transition: left 2s cubic-bezier(0.4, 0, 0.2, 1); left: 50%;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI比較 -->
                        <div class="col-12 col-lg-6">
                            {% if session.analysis_result.ai_expert_analysis %}
                                <div class="ai-score-comparison">
                                    <div class="score-box secondary">
                                        <div class="small text-muted mb-2">ワードベース分析</div>
                                        <div class="h3 mb-1">{{ session.overall_score|floatformat:3 }}</div>
                                        <small class="text-muted">語彙パターン検出</small>
                                    </div>
                                    <div class="score-box primary">
                                        <div class="small text-primary mb-2">AI専門家分析</div>
                                        <div class="h3 text-primary mb-1">{{ session.analysis_result.ai_overall_score|floatformat:3 }}</div>
                                        <small class="text-muted">文脈理解・将来予測</small>
                                    </div>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-lightbulb me-2"></i>分析から読み取れるポイント
                                    </h6>
                                    <p class="mb-0">{{ session.sentiment_label|yesno:"前向きな経営姿勢が表れています,慎重な経営スタンスが見られます,バランスの取れた客観的な内容です" }}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% include 'earnings_analysis/ads/ad_responsive.html' %}

        <!-- 分析タブ -->
        <div class="analysis-card card">
            <div class="card-header">
                <div class="analysis-tabs">
                    <button class="analysis-tab active" data-tab="ai-analysis">
                        <i class="fas fa-robot me-1"></i>AI分析
                    </button>
                    <button class="analysis-tab" data-tab="word-analysis">
                        <i class="fas fa-cloud me-1"></i>語彙分析
                    </button>
                    <button class="analysis-tab" data-tab="samples">
                        <i class="fas fa-file-text me-1"></i>判定文章
                    </button>
                </div>
            </div>
            
            <!-- AI分析タブ -->
            <div class="tab-content-panel active" id="ai-analysis">
                <div class="card-body">
                    {% if session.analysis_result.ai_expert_analysis %}
                        {% with ai=session.analysis_result.ai_expert_analysis %}
                            <!-- 投資グレード -->
                            <div class="ai-grade-display">
                                <div class="ai-grade-badge 
                                    {% if ai.investment_grade == 'A+' or ai.investment_grade == 'A' %}bg-success
                                    {% elif ai.investment_grade == 'B' %}bg-info
                                    {% elif ai.investment_grade == 'C' %}bg-warning
                                    {% else %}bg-danger{% endif %}">
                                    {{ ai.investment_grade }}
                                </div>
                                <div class="h5">投資推奨グレード</div>
                                <small class="text-muted">AI確信度: {{ ai.confidence|floatformat:0|mul:100 }}%</small>
                            </div>
                            
                            <!-- 詳細スコア -->
                            <div class="detailed-scores-grid">
                                {% for key, label in scores_labels.items %}
                                    <div class="score-item">
                                        <div class="score-item-value">{{ ai.detailed_scores|get_item:key }}/10</div>
                                        <div class="score-item-label">{{ label }}</div>
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <!-- 投資ポイント -->
                            {% if ai.investment_points %}
                                <h6 class="mt-4 mb-3">投資判断ポイント</h6>
                                <div class="investment-points">
                                    {% for point in ai.investment_points %}
                                        <div class="point-card {{ point.impact }}">
                                            <div class="point-header">
                                                <span class="point-title">{{ point.title }}</span>
                                                <span class="importance-badge {{ point.importance }}">
                                                    {{ point.importance|upper }}
                                                </span>
                                            </div>
                                            <p class="small mb-0 text-muted">{{ point.description }}</p>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">AI分析データがありません</h5>
                            <p class="text-muted">標準的な語彙分析結果をご確認ください</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- 語彙分析タブ -->
            <div class="tab-content-panel" id="word-analysis">
                <div class="card-body">
                    <!-- ワードクラウド制御 -->
                    <div class="wordcloud-controls">
                        <div class="row g-2 align-items-center">
                            <div class="col-12 col-md-6">
                                <div class="btn-group btn-group-sm w-100" role="group">
                                    <button type="button" class="btn btn-primary active" id="wordcloud-sentiment-btn">
                                        <i class="fas fa-heart me-1"></i>感情語彙のみ
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="wordcloud-all-btn">
                                        <i class="fas fa-list me-1"></i>全語彙
                                    </button>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <select class="form-select form-select-sm" id="wordcloud-min-count">
                                    <option value="3">3回以上</option>
                                    <option value="5">5回以上</option>
                                    <option value="10" selected>10回以上</option>
                                    <option value="20">20回以上</option>
                                </select>
                            </div>
                            <div class="col-6 col-md-3">
                                <button type="button" class="btn btn-sm btn-primary w-100" id="wordcloud-update-btn">
                                    <i class="fas fa-sync-alt me-1"></i>更新
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 統計情報 -->
                    <div class="row mb-3 text-center">
                        <div class="col-3">
                            <div class="small text-muted">総語彙数</div>
                            <div class="fw-bold text-primary" id="total-words">-</div>
                        </div>
                        <div class="col-3">
                            <div class="small text-muted">表示語彙数</div>
                            <div class="fw-bold text-info" id="wordcloud-displayed-count">-</div>
                        </div>
                        <div class="col-3">
                            <div class="small text-muted">総出現回数</div>
                            <div class="fw-bold text-success" id="total-occurrences">-</div>
                        </div>
                        <div class="col-3">
                            <div class="small text-muted">最大出現</div>
                            <div class="fw-bold text-warning" id="max-occurrences">-</div>
                        </div>
                    </div>
                    
                    <!-- ワードクラウド表示 -->
                    <div id="wordcloud-canvas" class="wordcloud-canvas">
                        <div class="d-flex justify-content-center align-items-center h-100">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status"></div>
                                <div class="mt-2 text-muted">ワードクラウドを生成しています...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- サンプル文章タブ -->
            <div class="tab-content-panel" id="samples">
                <div class="card-body">
                    {% if session.analysis_result.sample_sentences %}
                        {% with samples=session.analysis_result.sample_sentences %}
                            <!-- ポジティブ文章 -->
                            {% if samples.positive %}
                                <h6 class="text-success mb-3">
                                    <i class="fas fa-smile me-2"></i>ポジティブと判定された文章
                                    <span class="badge bg-success ms-2">{{ samples.positive|length }}件</span>
                                </h6>
                                <div class="accordion sentence-accordion mb-4" id="positiveAccordion">
                                    {% for sentence in samples.positive|slice:":5" %}
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#pos-{{ forloop.counter }}">
                                                    <div class="d-flex justify-content-between w-100 me-3">
                                                        <span class="fw-semibold">スコア: {{ sentence.score|floatformat:2 }}</span>
                                                        <span class="small text-muted">{{ forloop.counter }}件目</span>
                                                    </div>
                                                </button>
                                            </h2>
                                            <div id="pos-{{ forloop.counter }}" class="accordion-collapse collapse">
                                                <div class="accordion-body">
                                                    <div class="mb-3">
                                                        {% if sentence.highlighted_text %}
                                                            {{ sentence.highlighted_text|safe }}
                                                        {% else %}
                                                            {{ sentence.text }}
                                                        {% endif %}
                                                    </div>
                                                    {% if sentence.keywords %}
                                                        <div class="small text-muted">
                                                            <strong>検出キーワード:</strong>
                                                            {% for keyword in sentence.keywords %}
                                                                <span class="badge bg-success me-1">{{ keyword }}</span>
                                                            {% endfor %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <!-- ネガティブ文章 -->
                            {% if samples.negative %}
                                <h6 class="text-danger mb-3">
                                    <i class="fas fa-frown me-2"></i>ネガティブと判定された文章
                                    <span class="badge bg-danger ms-2">{{ samples.negative|length }}件</span>
                                </h6>
                                <div class="accordion sentence-accordion" id="negativeAccordion">
                                    {% for sentence in samples.negative|slice:":5" %}
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#neg-{{ forloop.counter }}">
                                                    <div class="d-flex justify-content-between w-100 me-3">
                                                        <span class="fw-semibold">スコア: {{ sentence.score|floatformat:2 }}</span>
                                                        <span class="small text-muted">{{ forloop.counter }}件目</span>
                                                    </div>
                                                </button>
                                            </h2>
                                            <div id="neg-{{ forloop.counter }}" class="accordion-collapse collapse">
                                                <div class="accordion-body">
                                                    <div class="mb-3">
                                                        {% if sentence.highlighted_text %}
                                                            {{ sentence.highlighted_text|safe }}
                                                        {% else %}
                                                            {{ sentence.text }}
                                                        {% endif %}
                                                    </div>
                                                    {% if sentence.keywords %}
                                                        <div class="small text-muted">
                                                            <strong>検出キーワード:</strong>
                                                            {% for keyword in sentence.keywords %}
                                                                <span class="badge bg-danger me-1">{{ keyword }}</span>
                                                            {% endfor %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if not samples.positive and not samples.negative %}
                                <div class="text-center py-5">
                                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">特徴的な文章は検出されませんでした</h5>
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                </div>
            </div>
        </div>

        {% include 'earnings_analysis/ads/ad_responsive.html' %}
    </div>
    
    <!-- サイドバー -->
    <div class="col-12 col-lg-4">
        <!-- 統計情報 -->
        {% if session.analysis_result.statistics %}
            <div class="analysis-card card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>分析統計
                    </h6>
                </div>
                <div class="card-body">
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value">{{ session.analysis_result.statistics.total_words_analyzed }}</div>
                            <div class="stat-label">分析語数</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">{{ session.analysis_result.statistics.context_patterns_found }}</div>
                            <div class="stat-label">文脈パターン</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">{{ session.analysis_result.statistics.basic_words_found }}</div>
                            <div class="stat-label">基本語彙</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">{{ session.analysis_result.statistics.sentences_analyzed }}</div>
                            <div class="stat-label">分析文数</div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- アクション -->
        <div class="analysis-card card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-tools me-2"></i>アクション
                </h6>
            </div>
            <div class="card-body">
                {% if time_remaining and time_remaining.total_seconds < 3600 %}
                    <div class="alert alert-warning py-2 mb-3">
                        <small>
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            この結果は約{{ time_remaining.seconds|floatformat:0|div:60 }}分後に期限切れとなります
                        </small>
                    </div>
                {% endif %}
                
                <div class="d-grid gap-2">
                    <a href="{% url 'copomo:sentiment-analysis' document.doc_id %}" class="btn btn-primary">
                        <i class="fas fa-redo me-1"></i>再分析実行
                    </a>
                    <a href="{% url 'copomo:financial-analysis' document.doc_id %}" class="btn btn-outline-primary">
                        <i class="fas fa-chart-pie me-1"></i>財務分析も実行
                    </a>
                    <a href="{% url 'copomo:document-detail-ui' document.doc_id %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>書類詳細に戻る
                    </a>
                    <button type="button" class="btn btn-outline-info" onclick="shareResult()">
                        <i class="fas fa-share me-1"></i>結果を共有
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="exportSummary()">
                        <i class="fas fa-download me-1"></i>サマリー保存
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 語彙詳細モーダル -->
<div class="modal fade" id="wordDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>語彙詳細分析
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="text-center mb-3">
                            <h3 id="selected-word">語彙</h3>
                            <span class="badge fs-6" id="word-sentiment-badge">感情</span>
                        </div>
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <div class="stat-box">
                                    <div class="stat-value" id="word-frequency">0</div>
                                    <div class="stat-label">出現回数</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-box">
                                    <div class="stat-value" id="word-score">0.0</div>
                                    <div class="stat-label">感情スコア</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>出現文脈</h6>
                        <div id="word-context-list" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-spinner fa-spin"></i>
                                <div class="mt-2">文脈を検索中...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>閉じる
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js"></script>

<script>
// ========================================
// データと変数
// ========================================
const actualScore = {{ session.overall_score }};
const sentimentLabel = '{{ session.sentiment_label }}';
const actualAnalysisData = {
    keyword_frequency_data: {{ session.analysis_result.keyword_frequency_data|safe|default:'{}' }},
    statistics: {{ session.analysis_result.statistics|safe|default:'{}' }},
    sample_sentences: {{ session.analysis_result.sample_sentences|safe|default:'{}' }}
};

let wordcloudInstance = null;
let currentWordcloudData = [];
let currentDisplayMode = 'sentiment';
let tokenizer = null;

// ========================================
// タブ切り替え機能
// ========================================
document.querySelectorAll('.analysis-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        // タブのアクティブ状態切り替え
        document.querySelectorAll('.analysis-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // コンテンツパネルの表示切り替え
        const targetTab = this.dataset.tab;
        document.querySelectorAll('.tab-content-panel').forEach(panel => {
            panel.classList.remove('active');
        });
        document.getElementById(targetTab).classList.add('active');
    });
});

// ========================================
// スコアアニメーション
// ========================================
function animateScoreArc() {
    const arc = document.getElementById('score-arc');
    const radius = 80;
    const circumference = 2 * Math.PI * radius;
    
    let strokeColor;
    if (actualScore > 0.4) strokeColor = '#198754';
    else if (actualScore > 0.15) strokeColor = '#0dcaf0';
    else if (actualScore >= -0.15) strokeColor = '#6c757d';
    else if (actualScore >= -0.4) strokeColor = '#fd7e14';
    else strokeColor = '#dc3545';
    
    arc.style.stroke = strokeColor;
    
    const percentage = (actualScore + 1) / 2;
    const offset = circumference - (percentage * circumference);
    
    setTimeout(() => {
        arc.style.strokeDashoffset = offset;
    }, 500);
}

function animateScoreNumber() {
    const scoreElement = document.getElementById('animated-score');
    const duration = 2000;
    const startTime = performance.now();
    
    function updateScore(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easedProgress = 1 - Math.pow(1 - progress, 3);
        const currentScore = actualScore * easedProgress;
        
        scoreElement.textContent = currentScore.toFixed(3);
        
        if (progress < 1) {
            requestAnimationFrame(updateScore);
        }
    }
    
    requestAnimationFrame(updateScore);
}

function animatePositionIndicator() {
    const indicator = document.getElementById('score-position');
    const percentage = (actualScore + 1) / 2;
    const leftPosition = percentage * 100;
    
    setTimeout(() => {
        indicator.style.left = leftPosition + '%';
    }, 1000);
}

// ========================================
// ワードクラウド機能
// ========================================
const actualWordcloudData = {
    sentiment: [],
    all: []
};

function initializeWordcloud() {
    console.log('ワードクラウド初期化開始');
    
    // 感情語彙のみのデータを作成
    actualWordcloudData.sentiment = convertToWordcloudData(actualAnalysisData.keyword_frequency_data || {}, false);
    currentWordcloudData = actualWordcloudData.sentiment;
    
    console.log('感情語彙データ数:', actualWordcloudData.sentiment.length);
    
    // 初期表示
    if (actualWordcloudData.sentiment.length > 0) {
        generateWordcloud(actualWordcloudData.sentiment);
    } else {
        showWordcloudError('表示する語彙がありません');
    }
    
    // イベントリスナー設定
    setupWordcloudEvents();
}

function convertToWordcloudData(frequencyData, includeAll = false) {
    const wordcloudData = [];
    const sentimentWords = new Set();
    
    console.log('convertToWordcloudData:', { frequencyData, includeAll });
    
    if (frequencyData.positive) {
        console.log('ポジティブ語彙数:', frequencyData.positive.length);
        frequencyData.positive.forEach(item => {
            sentimentWords.add(item.word);
            wordcloudData.push({
                text: item.word,
                size: item.count,
                sentiment: "positive",
                score: item.score,
                color: "#28a745"
            });
        });
    }
    
    if (frequencyData.negative) {
        console.log('ネガティブ語彙数:', frequencyData.negative.length);
        frequencyData.negative.forEach(item => {
            sentimentWords.add(item.word);
            wordcloudData.push({
                text: item.word,
                size: item.count,
                sentiment: "negative",
                score: item.score,
                color: "#dc3545"
            });
        });
    }
    
    if (frequencyData.neutral && includeAll) {
        console.log('中立語彙数:', frequencyData.neutral.length);
        frequencyData.neutral.forEach(item => {
            if (!sentimentWords.has(item.word)) {
                wordcloudData.push({
                    text: item.word,
                    size: item.count,
                    sentiment: "neutral",
                    score: 0,
                    color: "#6c757d"
                });
            }
        });
    }
    
    wordcloudData.sort((a, b) => b.size - a.size);
    
    console.log('最終的なワードクラウドデータ数:', wordcloudData.length);
    console.log('上位5語:', wordcloudData.slice(0, 5).map(w => `${w.text}(${w.size}回)`));
    
    if (wordcloudData.length === 0) {
        return [{
            text: "データなし",
            size: 1,
            sentiment: "neutral",
            score: 0.0,
            color: "#6c757d"
        }];
    }
    
    return wordcloudData;
}

function generateWordcloud(wordsData) {
    console.log('ワードクラウド生成開始:', wordsData.length, '語');
    
    const canvas = document.getElementById('wordcloud-canvas');
    if (!canvas) {
        console.error('キャンバス要素が見つかりません');
        return;
    }
    
    if (!wordsData || wordsData.length === 0) {
        showWordcloudError('表示する語彙がありません');
        return;
    }
    
    // データを最大50語に制限（スタックオーバーフロー防止）
    const limitedData = wordsData.slice(0, 50);
    console.log('表示語彙数を制限:', limitedData.length, '語');
    
    canvas.innerHTML = '';
    
    try {
        const isMobile = window.innerWidth <= 768;
        const containerWidth = Math.floor(canvas.offsetWidth);
        let containerHeight;
        
        if (containerWidth <= 0) {
            console.warn('無効なキャンバス幅、デフォルト値を使用');
            canvas.style.width = (isMobile ? '320px' : '800px');
            canvas.style.height = (isMobile ? '350px' : '400px');
            return;
        }
        
        containerHeight = isMobile ? 
            Math.max(350, Math.min(containerWidth * 1.2, 500)) : 
            Math.max(400, containerWidth * 0.6);
        
        canvas.style.height = containerHeight + 'px';
        canvas.style.width = containerWidth + 'px';
        
        console.log('キャンバスサイズ:', { containerWidth, containerHeight });
        
        // カウントの範囲を計算
        const counts = limitedData.map(w => w.size);
        const minCount = Math.min(...counts);
        const maxCount = Math.max(...counts);
        
        console.log('カウント範囲:', { minCount, maxCount, 比率: maxCount / minCount });
        
        // WordCloud用のリストを作成（フォントサイズ計算を簡素化）
        const wordcloudList = limitedData.map(word => {
            let fontSize;
            
            if (maxCount === minCount) {
                // 全て同じカウントの場合
                fontSize = isMobile ? 16 : 24;
            } else {
                // 相対的な位置を計算（0-1の範囲）
                const relativePosition = (word.size - minCount) / (maxCount - minCount);
                
                // フォントサイズの範囲を設定（控えめに）
                const minFontSize = isMobile ? 12 : 14;
                const maxFontSize = isMobile ? 36 : 48;  // 最大値を抑える
                
                // 線形スケーリング
                fontSize = minFontSize + (maxFontSize - minFontSize) * relativePosition;
            }
            
            // フォントサイズを整数に丸める
            fontSize = Math.floor(Math.max(12, Math.min(fontSize, 60)));
            
            // [word, size, rotation, rotationFit, attributes, extraData, color]
            return [word.text, fontSize, 0, 0, null, null, word.color];
        });
        
        console.log('WordCloudリスト作成完了:', wordcloudList.length, '語');
        console.log('フォントサイズ範囲:', {
            min: Math.min(...wordcloudList.map(w => w[1])),
            max: Math.max(...wordcloudList.map(w => w[1]))
        });
        
        // 上位5語を表示
        console.log('上位5語:', wordcloudList.slice(0, 5).map(w => `${w[0]}(size:${w[1]})`));
        
        // WordCloud2.jsのオプション（安全な設定）
        const options = {
            list: wordcloudList,
            gridSize: Math.max(8, Math.floor(16 * (isMobile ? 0.5 : 1))),
            weightFactor: 1,  // 固定値（フォントサイズは既に計算済み）
            fontFamily: 'Hiragino Kaku Gothic Pro, メイリオ, Arial, sans-serif',
            color: function(word, weight) {
                const wordData = limitedData.find(w => w.text === word);
                return wordData ? wordData.color : '#666666';
            },
            backgroundColor: 'transparent',
            rotateRatio: 0,  // 回転を無効化（パフォーマンス向上）
            minRotation: 0,
            maxRotation: 0,
            rotationSteps: 0,
            shuffle: true,
            ellipticity: isMobile ? 1 : 0.65,
            drawOutOfBound: false,
            shrinkToFit: true,
            clearCanvas: true,
            wait: isMobile ? 50 : 0,  // モバイルでは描画待機時間を設定
            abortThreshold: 10000,  // タイムアウト設定
            abort: function() {
                console.warn('WordCloud描画タイムアウト');
                return false;
            },
            click: function(item, dimension, event) {
                if (item && item[0]) {
                    console.log('ワードクリック:', item[0]);
                    showWordDetail(item[0]);
                }
            }
        };
        
        console.log('WordCloud2.js実行開始');
        
        // WordCloud生成
        WordCloud(canvas, options);
        
        console.log('ワードクラウド生成完了');
        
        // 統計情報を更新
        updateDisplayedCount(limitedData.length);
        updateStatistics(limitedData);
        
    } catch (error) {
        console.error('ワードクラウド生成エラー:', error);
        console.error('エラースタック:', error.stack);
        showWordcloudError('ワードクラウドの生成に失敗しました');
    }
}

function showWordcloudError(message) {
    const canvas = document.getElementById('wordcloud-canvas');
    if (canvas) {
        canvas.innerHTML = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center text-muted">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <div>${message}</div>
                    <button class="btn btn-sm btn-primary mt-3" onclick="initializeWordcloud()">
                        再試行
                    </button>
                </div>
            </div>
        `;
    }
}

function updateStatistics(wordsData) {
    const totalWords = wordsData.length;
    const totalOccurrences = wordsData.reduce((sum, w) => sum + w.size, 0);
    const maxOccurrences = wordsData.length > 0 ? Math.max(...wordsData.map(w => w.size)) : 0;
    
    const el1 = document.getElementById('total-words');
    const el2 = document.getElementById('total-occurrences');
    const el3 = document.getElementById('max-occurrences');
    
    if (el1) el1.textContent = totalWords;
    if (el2) el2.textContent = totalOccurrences;
    if (el3) el3.textContent = maxOccurrences;
}

function setupWordcloudEvents() {
    console.log('ワードクラウドイベント設定');
    
    const sentimentBtn = document.getElementById('wordcloud-sentiment-btn');
    const allBtn = document.getElementById('wordcloud-all-btn');
    const updateBtn = document.getElementById('wordcloud-update-btn');
    
    if (sentimentBtn) {
        sentimentBtn.addEventListener('click', function() {
            console.log('感情語彙ボタンクリック');
            if (currentDisplayMode !== 'sentiment') {
                currentDisplayMode = 'sentiment';
                this.classList.add('active', 'btn-primary');
                this.classList.remove('btn-outline-primary');
                if (allBtn) {
                    allBtn.classList.remove('active', 'btn-primary');
                    allBtn.classList.add('btn-outline-primary');
                }
                
                currentWordcloudData = actualWordcloudData.sentiment;
                generateWordcloud(currentWordcloudData);
            }
        });
    }
    
    if (allBtn) {
        allBtn.addEventListener('click', function() {
            console.log('全語彙ボタンクリック');
            if (currentDisplayMode !== 'all') {
                currentDisplayMode = 'all';
                this.classList.add('active', 'btn-primary');
                this.classList.remove('btn-outline-primary');
                if (sentimentBtn) {
                    sentimentBtn.classList.remove('active', 'btn-primary');
                    sentimentBtn.classList.add('btn-outline-primary');
                }
                
                // 全語彙データがまだない場合は生成
                if (actualWordcloudData.all.length === 0) {
                    console.log('全語彙データ生成');
                    actualWordcloudData.all = convertToWordcloudData(
                        actualAnalysisData.keyword_frequency_data || {}, 
                        true
                    );
                }
                
                currentWordcloudData = actualWordcloudData.all;
                generateWordcloud(currentWordcloudData);
            }
        });
    }
    
    if (updateBtn) {
        updateBtn.addEventListener('click', function() {
            console.log('更新ボタンクリック');
            applyFilters();
        });
    }
}

function applyFilters() {
    const minCount = parseInt(document.getElementById('wordcloud-min-count')?.value || '10');
    console.log('フィルター適用: minCount =', minCount);
    
    const sourceData = currentDisplayMode === 'all' ? actualWordcloudData.all : actualWordcloudData.sentiment;
    const filteredData = sourceData.filter(word => word && word.size >= minCount);
    
    console.log('フィルター後:', filteredData.length, '語');
    
    if (filteredData.length === 0) {
        showWordcloudError('選択した条件に一致する語彙がありません');
        return;
    }
    
    generateWordcloud(filteredData);
}

function showWordDetail(wordText) {
    const wordData = currentWordcloudData.find(w => w.text === wordText);
    if (!wordData) return;
    
    document.getElementById('selected-word').textContent = wordData.text;
    document.getElementById('word-frequency').textContent = wordData.size;
    document.getElementById('word-score').textContent = wordData.score ? wordData.score.toFixed(2) : '0.0';
    
    const sentimentBadge = document.getElementById('word-sentiment-badge');
    const sentimentText = wordData.sentiment === 'positive' ? 'ポジティブ' : 
                         wordData.sentiment === 'negative' ? 'ネガティブ' : '中立';
    const sentimentClass = wordData.sentiment === 'positive' ? 'bg-success' : 
                          wordData.sentiment === 'negative' ? 'bg-danger' : 'bg-secondary';
    
    sentimentBadge.textContent = sentimentText;
    sentimentBadge.className = `badge fs-6 ${sentimentClass}`;
    
    findWordContexts(wordText);
    
    const modal = new bootstrap.Modal(document.getElementById('wordDetailModal'));
    modal.show();
}

function findWordContexts(wordText) {
    const contextList = document.getElementById('word-context-list');
    contextList.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i><div class="mt-2">文脈を検索中...</div></div>';
    
    const contexts = [];
    const sentences = [
        ...(actualAnalysisData.sample_sentences.positive || []),
        ...(actualAnalysisData.sample_sentences.negative || [])
    ];
    
    sentences.forEach(sentence => {
        if (sentence.text && sentence.text.includes(wordText)) {
            const highlightedText = sentence.text.replace(
                new RegExp(wordText, 'g'),
                `<span class="keyword-highlight">${wordText}</span>`
            );
            contexts.push({
                text: highlightedText,
                score: sentence.score || 0,
                sentiment: sentence.score > 0 ? 'positive' : sentence.score < 0 ? 'negative' : 'neutral'
            });
        }
    });
    
    setTimeout(() => {
        if (contexts.length === 0) {
            contextList.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-search"></i><div class="mt-2">この語彙の文脈は見つかりませんでした</div></div>';
        } else {
            const contextHTML = contexts.slice(0, 3).map((context, index) => {
                const borderClass = context.sentiment === 'positive' ? 'border-success' : 
                                   context.sentiment === 'negative' ? 'border-danger' : 'border-secondary';
                return `
                    <div class="p-3 mb-2 border-start border-3 ${borderClass}" style="background: var(--bg-secondary);">
                        <div class="mb-2">${context.text}</div>
                        <small class="text-muted">スコア: ${context.score.toFixed(2)}</small>
                    </div>
                `;
            }).join('');
            contextList.innerHTML = contextHTML;
        }
    }, 300);
}

function updateDisplayedCount(count) {
    const el = document.getElementById('wordcloud-displayed-count');
    if (el) el.textContent = count;
}

// ========================================
// イベントリスナー
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded - 初期化開始');
    console.log('分析データ:', actualAnalysisData);
    
    // アニメーション実行
    animateScoreArc();
    animateScoreNumber();
    animatePositionIndicator();
    
    // ワードクラウド初期化（タブが表示されていなくても初期化）
    setTimeout(() => {
        console.log('ワードクラウド初期化タイマー実行');
        initializeWordcloud();
    }, 500);
    
    // ページトップへスクロール
    window.scrollTo({ top: 0, behavior: 'smooth' });
});

// ========================================
// ユーティリティ関数
// ========================================
function shareResult() {
    const url = window.location.href;
    const title = `感情分析結果: {{ document.company_name }} (スコア: {{ session.overall_score|floatformat:2 }})`;
    
    if (navigator.share) {
        navigator.share({ title, url }).catch(() => {});
    } else if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
            alert('URLをコピーしました');
        });
    }
}

function exportSummary() {
    const summary = {
        company: '{{ document.company_name }}',
        analysis_date: '{{ session.created_at|date:"Y-m-d H:i:s" }}',
        overall_score: {{ session.overall_score }},
        sentiment_label: '{{ session.sentiment_label }}'
    };
    
    const blob = new Blob([JSON.stringify(summary, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sentiment_analysis_${summary.company}_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}