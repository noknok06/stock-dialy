<!-- earnings_analysis/templates/earnings_analysis/sentiment/analysis_improved.html -->
{% extends 'earnings_analysis/base.html' %}
{% load static %}

{% block title %}感情分析 - {{ document.company_name }} - コポモ{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
    /* プライマリカラー（青系） */
    --primary-700: #2d5a8a;
    --primary-600: #4072B3;
    --primary-500: #6088C6;
    --primary-400: #7a9fd1;
    --primary-300: #AEC4E5;
    --primary-200: #c5d6ed;
    --primary-100: #dce7f4;
    --primary-50: #f0f5fa;
    
    /* アクセントカラー（サーモンピンク） */
    --accent-600: #d96a6a;
    --accent-500: #EB8686;
    --accent-400: #ef9e9e;
    --accent-300: #f4b8b8;
    --accent-200: #f9d1d1;
    --accent-100: #fceaea;
    --accent-50: #fef5f5;
    
    /* 成功（緑系） */
    --success-600: #059669;
    --success-500: #10b981;
    --success-100: #d1fae5;
    --success-50: #ecfdf5;
    
    /* 警告（オレンジ系） */
    --warning-600: #d97706;
    --warning-500: #f59e0b;
    --warning-100: #fef3c7;
    --warning-50: #fffbeb;
    
    /* 危険（赤系） */
    --danger-600: #dc2626;
    --danger-500: #ef4444;
    --danger-100: #fee2e2;
    --danger-50: #fef2f2;
    
    /* グレースケール */
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #C0C0C0;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --radius-2xl: 1.5rem;
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
}

body {
    font-family: 'Noto Sans JP', sans-serif;
    background: linear-gradient(135deg, var(--gray-50) 0%, var(--primary-50) 100%);
}

/* パンくず */
.breadcrumb {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 0;
    margin: 0 0 1.5rem;
    list-style: none;
    font-size: 0.875rem;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
}

.breadcrumb-item + .breadcrumb-item::before {
    content: '/';
    margin-right: 0.5rem;
    color: var(--gray-400);
}

.breadcrumb-item a {
    color: var(--gray-600);
    text-decoration: none;
}

.breadcrumb-item a:hover {
    color: var(--primary-600);
}

.breadcrumb-item.active {
    color: var(--gray-500);
}

/* ページヘッダー */
.page-header {
    background: linear-gradient(135deg, var(--accent-500) 0%, var(--primary-500) 50%, var(--primary-600) 100%);
    color: white;
    padding: 1.5rem;
    border-radius: var(--radius-xl);
    margin-bottom: 1.5rem;
    position: relative;
    overflow: hidden;
}

.page-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 60%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
    pointer-events: none;
}

@media (min-width: 768px) {
    .page-header {
        padding: 2rem;
    }
}

.page-header-content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

@media (min-width: 768px) {
    .page-header-content {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
    }
}

.page-header h1 {
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: white;
}

@media (min-width: 768px) {
    .page-header h1 {
        font-size: 1.75rem;
    }
}

.page-header-subtitle {
    font-size: 1rem;
    opacity: 0.95;
    margin-bottom: 0.25rem;
}

.page-header-desc {
    font-size: 0.875rem;
    opacity: 0.85;
}

.page-header-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(255,255,255,0.2);
    border-radius: var(--radius-lg);
    font-size: 0.875rem;
    backdrop-filter: blur(4px);
}

/* メインレイアウト */
.main-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
}

@media (min-width: 992px) {
    .main-layout {
        grid-template-columns: 1fr 320px;
    }
}

/* カード */
.card {
    background: white;
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-100);
    overflow: hidden;
}

.card-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--gray-100);
    background: var(--gray-50);
}

.card-header h5,
.card-header h6 {
    margin: 0;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    color: var(--gray-800);
}

.card-body {
    padding: 1.25rem;
}

@media (min-width: 768px) {
    .card-header {
        padding: 1.25rem 1.5rem;
    }
    .card-body {
        padding: 1.5rem;
    }
}

/* 分析実行セクション */
.analysis-hero {
    text-align: center;
    padding: 2rem 1rem;
}

@media (min-width: 768px) {
    .analysis-hero {
        padding: 3rem 2rem;
    }
}

.analysis-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--primary-100), var(--primary-200));
    border-radius: 50%;
    font-size: 2rem;
    color: var(--primary-600);
}

@media (min-width: 768px) {
    .analysis-icon {
        width: 100px;
        height: 100px;
        font-size: 2.5rem;
    }
}

.analysis-title {
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: 1rem;
}

.analysis-info {
    background: var(--primary-50);
    border: 1px solid var(--primary-100);
    border-radius: var(--radius-lg);
    padding: 1rem;
    margin-bottom: 1.5rem;
    text-align: left;
}

.analysis-info-title {
    font-weight: 600;
    color: var(--primary-700);
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
}

.analysis-info-text {
    font-size: 0.8125rem;
    color: var(--gray-600);
}

.analysis-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    min-height: 56px;
    padding: 1rem 2rem;
    background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
    color: white;
    border: none;
    border-radius: var(--radius-lg);
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-size: 1.125rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(64, 114, 179, 0.3);
}

.analysis-btn:hover {
    background: linear-gradient(135deg, var(--primary-700), var(--primary-600));
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(64, 114, 179, 0.4);
}

.analysis-btn-success {
    background: linear-gradient(135deg, var(--success-500), var(--success-600));
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.analysis-btn-success:hover {
    background: linear-gradient(135deg, var(--success-600), #047857);
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
}

.analysis-hint {
    margin-top: 1rem;
    font-size: 0.8125rem;
    color: var(--gray-500);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

/* 分析結果あり状態 */
.analysis-result-exists {
    background: var(--success-50);
    border: 1px solid var(--success-100);
    border-radius: var(--radius-lg);
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.analysis-result-exists-title {
    font-weight: 600;
    color: var(--success-600);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
}

.analysis-result-exists-text {
    font-size: 0.8125rem;
    color: var(--gray-600);
}

.analysis-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-width: 320px;
    margin: 0 auto;
}

@media (min-width: 576px) {
    .analysis-buttons {
        flex-direction: row;
        max-width: none;
        justify-content: center;
    }
}

.analysis-btn-secondary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    min-height: 48px;
    padding: 0.75rem 1.5rem;
    background: white;
    color: var(--warning-500);
    border: 2px solid var(--warning-500);
    border-radius: var(--radius-lg);
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.analysis-btn-secondary:hover {
    background: var(--warning-50);
}

/* スコア説明 */
.score-explanation {
    margin-top: 1.5rem;
}

.score-bar-container {
    position: relative;
    height: 40px;
    background: linear-gradient(to right, 
        var(--danger-500) 0%, 
        var(--warning-500) 35%, 
        var(--gray-300) 45%, 
        var(--gray-300) 55%, 
        #22c55e 65%, 
        var(--success-500) 100%
    );
    border-radius: var(--radius-lg);
    margin-bottom: 0.75rem;
    overflow: hidden;
}

.score-bar-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--gray-500);
    margin-bottom: 1.5rem;
}

.score-ranges {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
}

@media (min-width: 768px) {
    .score-ranges {
        grid-template-columns: repeat(4, 1fr);
    }
}

.score-range-card {
    padding: 1rem;
    border-radius: var(--radius-lg);
    text-align: center;
    transition: all 0.2s ease;
    cursor: pointer;
}

.score-range-card:hover {
    transform: translateY(-2px);
}

.score-range-card.range-negative {
    background: var(--danger-50);
    border: 2px solid var(--danger-100);
}

.score-range-card.range-negative:hover {
    border-color: var(--danger-500);
}

.score-range-card.range-slightly-negative {
    background: var(--warning-50);
    border: 2px solid var(--warning-100);
}

.score-range-card.range-slightly-negative:hover {
    border-color: var(--warning-500);
}

.score-range-card.range-slightly-positive {
    background: #ecfdf5;
    border: 2px solid #a7f3d0;
}

.score-range-card.range-slightly-positive:hover {
    border-color: #22c55e;
}

.score-range-card.range-positive {
    background: var(--success-50);
    border: 2px solid var(--success-100);
}

.score-range-card.range-positive:hover {
    border-color: var(--success-500);
}

.score-range-icon {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.range-negative .score-range-icon { color: var(--danger-500); }
.range-slightly-negative .score-range-icon { color: var(--warning-500); }
.range-slightly-positive .score-range-icon { color: #22c55e; }
.range-positive .score-range-icon { color: var(--success-500); }

.score-range-title {
    font-weight: 600;
    font-size: 0.8125rem;
    margin-bottom: 0.25rem;
}

.range-negative .score-range-title { color: var(--danger-600); }
.range-slightly-negative .score-range-title { color: var(--warning-600); }
.range-slightly-positive .score-range-title { color: #16a34a; }
.range-positive .score-range-title { color: var(--success-600); }

.score-range-value {
    font-weight: 700;
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.range-negative .score-range-value { color: var(--danger-500); }
.range-slightly-negative .score-range-value { color: var(--warning-500); }
.range-slightly-positive .score-range-value { color: #22c55e; }
.range-positive .score-range-value { color: var(--success-500); }

.score-range-desc {
    font-size: 0.6875rem;
    color: var(--gray-500);
}

.score-neutral-note {
    text-align: center;
    margin-top: 1rem;
    padding: 0.75rem;
    background: var(--gray-100);
    border-radius: var(--radius-lg);
    font-size: 0.8125rem;
    color: var(--gray-600);
}

/* サイドバー */
.sidebar-card {
    margin-bottom: 1rem;
}

.history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border: 1px solid var(--gray-100);
    border-radius: var(--radius-lg);
    margin-bottom: 0.75rem;
}

.history-item:last-child {
    margin-bottom: 0;
}

.history-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    font-size: 0.875rem;
}

.history-label.positive { color: var(--success-600); }
.history-label.negative { color: var(--danger-500); }
.history-label.neutral { color: var(--gray-500); }

.history-date {
    font-size: 0.75rem;
    color: var(--gray-500);
    margin-top: 0.25rem;
}

.history-score {
    text-align: right;
}

.history-score-value {
    font-weight: 700;
    font-size: 1rem;
    color: var(--gray-800);
}

.history-score-duration {
    font-size: 0.6875rem;
    color: var(--gray-500);
}

/* ヘルプカード */
.help-item {
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--gray-100);
}

.help-item:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.help-item-title {
    font-weight: 600;
    font-size: 0.8125rem;
    color: var(--gray-700);
    margin-bottom: 0.25rem;
}

.help-item-text {
    font-size: 0.8125rem;
    color: var(--gray-500);
}

.help-item-warning {
    background: var(--warning-50);
    border-left: 3px solid var(--warning-500);
    padding: 0.75rem;
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    font-size: 0.8125rem;
    color: var(--warning-600);
}

/* アクションボタン */
.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    min-height: 44px;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-lg);
    font-weight: 600;
    font-size: 0.875rem;
    text-decoration: none;
    transition: all 0.2s ease;
    border: 2px solid var(--gray-200);
    background: white;
    color: var(--gray-700);
}

.action-btn:hover {
    border-color: var(--primary-500);
    color: var(--primary-600);
    background: var(--primary-50);
    text-decoration: none;
}

.action-btn-primary {
    background: linear-gradient(135deg, var(--accent-500), var(--accent-600));
    color: white;
    border: none;
}

.action-btn-primary:hover {
    background: linear-gradient(135deg, var(--accent-600), #c45555);
    color: white;
}

.progress-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
}

/* プログレスオーバーレイ - 修正版 */
.progress-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1050;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

/* 表示状態 */
.progress-overlay.active {
    opacity: 1;
    pointer-events: auto;
}

/* コンテンツを初期状態で画面外に配置 */
.progress-content {
    background: white;
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-xl);
    max-width: 480px;
    width: 100%;
    min-width: 320px;
    max-height: 90vh;
    overflow-y: auto;
    transform: translateY(20px);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
}

.progress-overlay.active .progress-content {
    transform: translateY(0);
    opacity: 1;
}

/* 広告コンテナ - 幅を明示的に指定 */
.progress-ad-container {
    background: var(--gray-50);
    border-radius: var(--radius-lg);
    min-height: 250px;
    width: 100%;
    display: block;  /* flexからblockに変更 */
    margin-bottom: 1rem;
    padding: 1rem;
    box-sizing: border-box;
}

#modalAdSlot {
    width: 100%;
    min-height: 200px;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.progress-header {
    padding: 1.5rem 1.5rem 0;
    text-align: center;
}

.progress-title {
    font-family: 'M PLUS Rounded 1c', sans-serif;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--gray-800);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
}

.progress-body {
    padding: 1.5rem;
    text-align: center;
}

.progress-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary-100);
    border-radius: 50%;
    font-size: 2rem;
    color: var(--primary-600);
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.progress-bar-wrapper {
    background: var(--gray-200);
    border-radius: 9999px;
    height: 12px;
    overflow: hidden;
    margin-bottom: 1rem;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-600), var(--accent-500));
    border-radius: 9999px;
    transition: width 0.3s ease;
    position: relative;
}

.progress-bar-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.progress-text {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-600);
    margin-bottom: 0.5rem;
}

.progress-status {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-bottom: 1.5rem;
}

.progress-ad-container {
    background: var(--gray-50);
    border-radius: var(--radius-lg);
    min-height: 200px;
    min-width: 300px;  /* 追加: 最小幅を指定 */
    width: 100%;       /* 追加 */
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    padding: 1rem;
}

.progress-hint {
    font-size: 0.75rem;
    color: var(--gray-500);
}

.progress-footer {
    padding: 0 1.5rem 1.5rem;
    text-align: center;
}

.progress-cancel-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    min-height: 44px;
    padding: 0.75rem 1.5rem;
    background: var(--gray-100);
    color: var(--gray-600);
    border: none;
    border-radius: var(--radius-lg);
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.progress-cancel-btn:hover {
    background: var(--gray-200);
}

/* 開発モードバッジ */
.dev-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    background: var(--warning-100);
    color: var(--warning-600);
    border-radius: var(--radius-md);
    font-size: 0.6875rem;
    font-weight: 600;
}

/* テキストカラー */
.text-primary { color: var(--primary-600) !important; }
.text-accent { color: var(--accent-500) !important; }
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'copomo:index' %}">ホーム</a></li>
        <li class="breadcrumb-item"><a href="{% url 'copomo:document-list-ui' %}">書類一覧</a></li>
        <li class="breadcrumb-item"><a href="{% url 'copomo:document-detail-ui' document.doc_id %}">{{ document.doc_id }}</a></li>
        <li class="breadcrumb-item active">感情分析</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<form style="display: none;" id="csrf-form">
    {% csrf_token %}
</form>

<!-- ページヘッダー -->
<header class="page-header">
    <div class="page-header-content">
        <div>
            <h1>
                <i class="fas fa-brain"></i>
                感情分析
            </h1>
            <p class="page-header-subtitle">{{ document.company_name }}</p>
            <p class="page-header-desc">{{ document.doc_description|truncatechars:60 }}</p>
        </div>
        <div class="page-header-badge">
            <i class="fas fa-file-alt"></i>
            {{ document.doc_id }}
        </div>
    </div>
</header>

<!-- メインレイアウト -->
<div class="main-layout">
    <!-- メインコンテンツ -->
    <div class="main-content">
        <!-- 分析実行カード -->
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-play-circle text-primary"></i>
                    感情分析実行
                    {% if dev_mode %}
                        <span class="dev-badge">
                            <i class="fas fa-wrench"></i>
                            開発モード
                        </span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="analysis-hero">
                    <div class="analysis-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    
                    {% if not has_analysis_result or has_expired_session %}
                        <!-- 初回分析 -->
                        <h3 class="analysis-title">感情分析を開始</h3>
                        
                        <div class="analysis-info">
                            <div class="analysis-info-title">
                                <i class="fas fa-info-circle me-1"></i>
                                分析対象書類
                            </div>
                            <div class="analysis-info-text">
                                {{ document.doc_description }}
                            </div>
                        </div>
                        
                        <button type="button" class="analysis-btn" 
                                onclick="startSentimentAnalysis('{{ document.doc_id }}', false)">
                            <i class="fas fa-play"></i>
                            分析を実行
                        </button>
                        
                        <div class="analysis-hint">
                            <i class="fas fa-clock"></i>
                            分析には約1-2分かかる場合があります
                        </div>
                        
                    {% elif has_analysis_result %}
                        <!-- 分析結果あり -->
                        <h3 class="analysis-title">分析結果があります</h3>
                        
                        <div class="analysis-result-exists">
                            <div class="analysis-result-exists-title">
                                <i class="fas fa-check-circle"></i>
                                最新の分析完了
                            </div>
                            <div class="analysis-result-exists-text">
                                {{ latest_session.created_at|date:"Y年m月d日 H:i" }} に分析済み
                            </div>
                        </div>
                        
                        <div class="analysis-buttons">
                            <a href="{% url 'copomo:sentiment-result' latest_session.session_id %}" 
                               class="analysis-btn analysis-btn-success">
                                <i class="fas fa-chart-line"></i>
                                分析結果を表示
                            </a>
                            
                            {% if dev_mode %}
                                <button type="button" class="analysis-btn-secondary" 
                                        onclick="startSentimentAnalysis('{{ document.doc_id }}', true)">
                                    <i class="fas fa-redo"></i>
                                    再分析（開発用）
                                </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {% include 'earnings_analysis/ads/ad_responsive.html' %}

        <!-- スコア説明 -->
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-info-circle text-primary"></i>
                    感情スコアについて
                </h5>
            </div>
            <div class="card-body">
                <div class="score-explanation">
                    <!-- スコアバー -->
                    <div class="score-bar-container"></div>
                    <div class="score-bar-labels">
                        <span>-1.0（ネガティブ）</span>
                        <span>0（中立）</span>
                        <span>+1.0（ポジティブ）</span>
                    </div>
                    
                    <!-- スコア範囲カード -->
                    <div class="score-ranges">
                        <div class="score-range-card range-negative">
                            <div class="score-range-icon">
                                <i class="fas fa-frown-open"></i>
                            </div>
                            <div class="score-range-title">非常にネガティブ</div>
                            <div class="score-range-value">-1.0 〜 -0.5</div>
                            <div class="score-range-desc">深刻な問題や困難</div>
                        </div>
                        
                        <div class="score-range-card range-slightly-negative">
                            <div class="score-range-icon">
                                <i class="fas fa-frown"></i>
                            </div>
                            <div class="score-range-title">やや否定的</div>
                            <div class="score-range-value">-0.5 〜 -0.1</div>
                            <div class="score-range-desc">課題や慎重姿勢</div>
                        </div>
                        
                        <div class="score-range-card range-slightly-positive">
                            <div class="score-range-icon">
                                <i class="fas fa-smile"></i>
                            </div>
                            <div class="score-range-title">やや肯定的</div>
                            <div class="score-range-value">+0.1 〜 +0.5</div>
                            <div class="score-range-desc">改善や前向き姿勢</div>
                        </div>
                        
                        <div class="score-range-card range-positive">
                            <div class="score-range-icon">
                                <i class="fas fa-laugh"></i>
                            </div>
                            <div class="score-range-title">非常にポジティブ</div>
                            <div class="score-range-value">+0.5 〜 +1.0</div>
                            <div class="score-range-desc">大幅な成長や成功</div>
                        </div>
                    </div>
                    
                    <div class="score-neutral-note">
                        <i class="fas fa-balance-scale me-2"></i>
                        <strong>中立範囲（-0.1 〜 +0.1）：</strong>客観的・事実的な表現
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- サイドバー -->
    <div class="sidebar">
        <!-- 分析履歴 -->
        {% if analysis_history %}
            <div class="card sidebar-card">
                <div class="card-header">
                    <h6>
                        <i class="fas fa-history text-primary"></i>
                        分析履歴
                    </h6>
                </div>
                <div class="card-body">
                    {% for history in analysis_history %}
                        <div class="history-item">
                            <div>
                                <div class="history-label {% if history.sentiment_label == 'positive' %}positive{% elif history.sentiment_label == 'negative' %}negative{% else %}neutral{% endif %}">
                                    {% if history.sentiment_label == 'positive' %}
                                        <i class="fas fa-smile"></i>
                                        ポジティブ
                                    {% elif history.sentiment_label == 'negative' %}
                                        <i class="fas fa-frown"></i>
                                        ネガティブ
                                    {% else %}
                                        <i class="fas fa-meh"></i>
                                        中立
                                    {% endif %}
                                </div>
                                <div class="history-date">
                                    {{ history.analysis_date|date:"m/d H:i" }}
                                </div>
                            </div>
                            <div class="history-score">
                                <div class="history-score-value">
                                    {{ history.overall_score|floatformat:3 }}
                                </div>
                                {% if history.analysis_duration %}
                                    <div class="history-score-duration">
                                        {{ history.analysis_duration|floatformat:1 }}秒
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
        
        <!-- ヘルプ -->
        <div class="card sidebar-card">
            <div class="card-header">
                <h6>
                    <i class="fas fa-question-circle text-primary"></i>
                    感情分析について
                </h6>
            </div>
            <div class="card-body">
                <div class="help-item">
                    <div class="help-item-title">感情スコア</div>
                    <div class="help-item-text">
                        -1.0（非常にネガティブ）から +1.0（非常にポジティブ）の範囲で算出されます。
                    </div>
                </div>
                
                <div class="help-item">
                    <div class="help-item-title">分析対象</div>
                    <div class="help-item-text">
                        書類内のテキスト全体から感情を表現する語彙を抽出し、統計的に分析します。
                    </div>
                </div>
                
                <div class="help-item">
                    <div class="help-item-title">文脈解析</div>
                    <div class="help-item-text">
                        単語だけでなく、前後の文脈も考慮して総合的に判定します。
                    </div>
                </div>
                
                <div class="help-item-warning">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    分析結果は参考情報です。投資判断には十分な検討をお願いします。
                </div>
            </div>
        </div>
        
        <!-- アクション -->
        <div class="card sidebar-card">
            <div class="card-header">
                <h6>
                    <i class="fas fa-tools text-primary"></i>
                    アクション
                </h6>
            </div>
            <div class="card-body">
                <div class="action-buttons">
                    <a href="{% url 'copomo:financial-analysis' document.doc_id %}" class="action-btn action-btn-primary">
                        <i class="fas fa-chart-pie"></i>
                        財務分析も実行
                    </a>
                    <a href="{% url 'copomo:document-detail-ui' document.doc_id %}" class="action-btn">
                        <i class="fas fa-arrow-left"></i>
                        書類詳細に戻る
                    </a>
                    <button type="button" class="action-btn" onclick="window.print()">
                        <i class="fas fa-print"></i>
                        この画面を印刷
                    </button>
                </div>
            </div>
        </div>
        
        {% include 'earnings_analysis/ads/ad_responsive.html' %}
    </div>
</div>

<!-- プログレスオーバーレイ -->
<div id="progressOverlay" class="progress-overlay">
    <div class="progress-backdrop"></div>
    <div class="progress-container">
        <div class="progress-content">
            <div class="progress-header">
                <h5 class="progress-title">
                    <i class="fas fa-brain text-primary"></i>
                    感情分析実行中
                </h5>
            </div>
            
            <div class="progress-body">
                <div class="progress-icon">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                
                <div class="progress-bar-wrapper">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
                </div>
                
                <div class="progress-text" id="progressText">0%</div>
                <div class="progress-status" id="statusMessage">分析を開始しています...</div>
                
                <div id="progressAdContainer" class="progress-ad-container">
                    <!-- 広告は動的に挿入される -->
                    <div id="modalAdSlot"></div>
                </div>
                
                <div class="progress-hint">
                    この処理には数分かかる場合があります。<br>
                    テキストの解析と感情スコアの計算を行います。
                </div>
            </div>
            
            <div class="progress-footer">
                <button type="button" class="progress-cancel-btn" id="cancelBtn" onclick="cancelAnalysis()">
                    <i class="fas fa-times"></i>
                    キャンセル
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentSessionId = null;
let progressInterval = null;

function getCSRFToken() {
    const metaCsrf = document.querySelector('meta[name=csrf-token]');
    if (metaCsrf) return metaCsrf.getAttribute('content');
    
    const cookieCsrf = getCookie('csrftoken');
    if (cookieCsrf) return cookieCsrf;
    
    const hiddenCsrf = document.querySelector('#csrf-form input[name=csrfmiddlewaretoken]');
    if (hiddenCsrf) return hiddenCsrf.value;
    
    return null;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function startSentimentAnalysis(docId, force = false) {
    showProgressOverlay();
    
    const csrfToken = getCSRFToken();
    if (!csrfToken) {
        hideProgressOverlay();
        showToast('認証情報を取得できません。ページをリロードしてください。', 'error');
        return;
    }
    
    fetch('{% url "copomo:sentiment-start" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            doc_id: docId,
            force: force
        })
    })
    .then(response => {
        if (response.status === 403) {
            hideProgressOverlay();
            showToast('認証エラーが発生しました。ページをリロードしてください。', 'error');
            setTimeout(() => window.location.reload(), 2000);
            return null;
        }
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (!data) return;
        
        if (data.status === 'started') {
            currentSessionId = data.session_id;
            startProgressPolling();
        } else if (data.status === 'already_analyzed') {
            hideProgressOverlay();
            window.location.href = `{% url "copomo:sentiment-result" "SESSION_ID" %}`.replace('SESSION_ID', data.session_id);
        } else {
            throw new Error(data.message || '分析開始に失敗しました');
        }
    })
    .catch(error => {
        console.error('Analysis start error:', error);
        hideProgressOverlay();
        showToast('分析開始に失敗しました: ' + error.message, 'error');
    });
}

function startProgressPolling() {
    if (!currentSessionId) return;
    
    progressInterval = setInterval(fetchProgress, 2000);
    fetchProgress();
}

function fetchProgress() {
    if (!currentSessionId) return;
    
    fetch(`{% url "copomo:sentiment-progress" %}?session_id=${currentSessionId}`, {
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        updateProgressUI(data);
        
        if (data.status === 'COMPLETED') {
            clearInterval(progressInterval);
            setTimeout(() => {
                window.location.href = `{% url "copomo:sentiment-result" "SESSION_ID" %}`.replace('SESSION_ID', currentSessionId);
            }, 1000);
        } else if (data.status === 'FAILED') {
            clearInterval(progressInterval);
            document.getElementById('statusMessage').innerHTML = '<span style="color: var(--danger-500);">分析中にエラーが発生しました</span>';
            document.getElementById('cancelBtn').textContent = '閉じる';
        }
    })
    .catch(error => {
        console.error('Progress fetch error:', error);
    });
}

function updateProgressUI(data) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const statusMessage = document.getElementById('statusMessage');
    
    const progress = data.progress || 0;
    progressBar.style.width = progress + '%';
    progressText.textContent = progress + '%';
    statusMessage.textContent = data.message || '処理中...';
    
    if (progress >= 100) {
        statusMessage.innerHTML = '<span style="color: var(--success-500);">分析完了！結果画面に移動します...</span>';
    }
}

function showProgressOverlay() {
    const overlay = document.getElementById('progressOverlay');
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // アニメーション完了後に広告を読み込み（transitionの300msを待つ）
    setTimeout(loadModalAd, 350);
}

function loadModalAd() {
    const adSlot = document.getElementById('modalAdSlot');
    if (!adSlot || adSlot.dataset.adLoaded === 'true') return;
    
    const container = document.getElementById('progressAdContainer');
    
    // 幅を強制的に再計算
    void container.offsetWidth;
    
    const width = container.clientWidth;
    console.log('Ad container width:', width); // デバッグ用
    
    if (width < 100) {
        // 幅が小さすぎる場合はリトライ
        console.log('Container width too small, retrying...');
        setTimeout(loadModalAd, 300);
        return;
    }
    
    // 広告要素を動的に作成
    adSlot.innerHTML = `
        <ins class="adsbygoogle"
             style="display:block; width:100%; min-height:200px;"
             data-ad-client="ca-pub-3954701883136363"
             data-ad-slot="2912928129"
             data-ad-format="rectangle"
             data-full-width-responsive="false"></ins>
    `;
    
    // 次のフレームで広告を読み込み
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            try {
                (adsbygoogle = window.adsbygoogle || []).push({});
                adSlot.dataset.adLoaded = 'true';
                console.log('Ad loaded successfully');
            } catch (e) {
                console.warn('Ad loading failed:', e);
            }
        });
    });
}


function hideProgressOverlay() {
    document.getElementById('progressOverlay').classList.remove('active');
    document.body.style.overflow = '';
}

function cancelAnalysis() {
    if (progressInterval) {
        clearInterval(progressInterval);
    }
    hideProgressOverlay();
    currentSessionId = null;
}

function showToast(message, type = 'info') {
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    const bgColor = type === 'error' ? 'var(--danger-500)' : type === 'success' ? 'var(--success-500)' : 'var(--primary-600)';
    toast.style.cssText = `background:${bgColor};color:white;padding:1rem 1.5rem;border-radius:var(--radius-lg);margin-bottom:0.5rem;box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:0.5rem;animation:slideUp 0.3s ease-out;`;
    toast.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>${message}`;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// ページ離脱警告
window.addEventListener('beforeunload', function(e) {
    if (currentSessionId) {
        e.preventDefault();
        e.returnValue = '分析実行中です。ページを離れますか？';
    }
});
</script>
{% endblock %}