{% extends 'base.html' %}
{% load stockdiary_filters %}
{% load static %}
{% load humanize %}
{% load ads_tags %}
{% block title %}株式日記 | カブログ{% endblock %}

{% block head %}
<!-- 共通スタイルシートを読み込み -->
<link rel="stylesheet" href="{% static 'css/diary-theme.css' %}">
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/quick-diary.css' %}">
<!-- モバイルジェスチャー用のスタイルシート追加 -->

<!-- モバイルジェスチャー用のスタイルシート -->
<link rel="stylesheet" href="{% static 'css/mobile-gestures.css' %}">
<link rel="stylesheet" href="{% static 'css/search-suggestions.css' %}">

<style>
/* 日記カードタブのスタイル */
.diary-card-tabs {
  margin-top: 1rem;
}

.card-tabs .nav-link {
  padding: 0.4rem 0.75rem;
  font-size: 0.85rem;
  color: var(--text-light);
  border: none;
  border-radius: 0;
  position: relative;
}

.card-tabs .nav-link::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 100%;
  height: 2px;
  background-color: transparent;
  transition: background-color 0.2s;
}

.card-tabs .nav-link.active {
  color: var(--primary-color);
  font-weight: 500;
  background-color: transparent;
}

.card-tabs .nav-link.active::after {
  background-color: var(--primary-color);
}

.card-tabs .nav-link:hover:not(.active) {
  color: var(--primary-color);
  background-color: rgba(79, 70, 229, 0.05);
}

.card-tabs .nav-link i {
  margin-right: 0.3rem;
}

/* 検索ハイライト */
.search-highlight {
  background-color: #ffc107;
  color: #000;
  padding: 0 2px;
  border-radius: 2px;
  font-weight: bold;
}

/* 日記カードの強調 */
.diary-card-highlight {
  border-left: 3px solid #ffc107 !important;
}

/* インジケーターのスタイルを改善 */
.htmx-indicator {
  opacity: 0;
  transition: opacity 200ms ease-in;
  display: none;
}

.htmx-request .htmx-indicator {
  opacity: 1;
  display: flex !important;
  justify-content: center;
  align-items: center;
}

/* インジケーターを常に表示 */
#day-events-loading-desktop,
#day-events-loading-mobile {
  display: none !important;
}

.htmx-request #day-events-loading-desktop,
.htmx-request #day-events-loading-mobile {
  display: flex !important;
}

/* 無限スクロールのローディング表示 */
#loading-indicator {
  padding: 1rem;
  margin: 1rem 0;
  text-align: center;
}

#loading-indicator .spinner-border {
  width: 2rem;
  height: 2rem;
}

/* オフラインモード用 */
.offline-alert {
  display: none;
}
.is-offline .offline-alert {
  display: block;
}

/* PCでの2列表示用スタイル追加 */
.home-diary-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
}

/* タブレット以上のサイズでは2列表示に */
@media (min-width: 992px) {
  .home-diary-grid {
    grid-template-columns: 1fr 1fr;
  }
}

/* グリッドレイアウトでの表示調整用スタイル */
.grid-column-span {
  grid-column: 1 / -1; /* すべての列にまたがる */
}

/* オフラインバッジのスタイル */
.offline-badge {
  display: none;
}
</style>
{% endblock %}

{% block content %}
<!-- CSRF トークンを追加 -->
{% csrf_token %}

<!-- オフライン状態バッジ -->
<div class="offline-badge">
  <i class="bi bi-wifi-off me-1"></i> オフライン状態です
</div>

<!-- コンテンツ上部の広告 -->
{% if show_ads %}
    {% show_template_ad "diary_top" %}
{% endif %}
<div class="container py-4">
  <!-- ヘッダー部分 -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h1 class="diary-title mb-2 mb-md-0">株式日記</h1>
    <a href="{% url 'stockdiary:create' %}" class="btn btn-diary btn-diary-primary">
      <i class="bi bi-plus-lg me-1"></i> 新規作成
    </a>
  </div>

  <!-- カレンダーセクション - HTMX対応 -->
  <div class="calendar-section mb-4">
    <!-- スマホ用カレンダーアコーディオン -->
    <!-- Mobile Calendar Accordion - Improved HTMX Loading -->
    <div class="d-lg-none">
      <div class="accordion" id="calendarAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header" id="calendarHeading">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#calendarCollapse" aria-expanded="false" aria-controls="calendarCollapse">
              <i class="bi bi-calendar-week me-2"></i> 投資カレンダーを表示
            </button>
          </h2>
          <div id="calendarCollapse" class="accordion-collapse collapse" aria-labelledby="calendarHeading">
            <div class="accordion-body p-0">
              <!-- Mobile Calendar - Improved Loading Handling -->
              <div class="calendar-view" id="mobile-calendar-container"
                  hx-get="{% url 'stockdiary:calendar_partial' %}?view=mobile"
                  hx-trigger="revealed"
                  hx-swap="innerHTML"
                  hx-indicator="#mobile-calendar-loading">
                <div id="mobile-calendar-loading" class="text-center py-4 htmx-indicator">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2">カレンダーを読み込んでいます...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Event Display Section for Mobile -->
    <div class="d-lg-none">
      <div class="card mt-3 mb-4" id="mobile-events-card">
        <div class="card-header bg-white">
          <h6 class="mb-0" id="mobile-selected-date">選択日のイベント</h6>
        </div>
        <div class="card-body" id="mobile-day-events"
            hx-get="{% url 'stockdiary:day_events' %}"
            hx-trigger="date-selected from:body"
            hx-target="#mobile-day-events"
            hx-swap="innerHTML"
            hx-include="[name='date'], [name='view']">
          <p class="text-muted">日付を選択するとイベントが表示されます</p>
          <!-- Event Loading Indicator -->
          <div id="day-events-loading-mobile" class="htmx-indicator text-center mt-3">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">読み込み中...</span>
            </div>
          </div>
          <input type="hidden" name="view" value="mobile">
          <input type="hidden" name="date" value="">
        </div>
      </div>
    </div>

    <!-- Desktop Calendar Container - Enhanced HTMX Loading -->
    <div class="d-none d-lg-block">
      <div class="row">
        <!-- Calendar Part: Left Side (7/10) -->
        <div class="col-lg-7">
          <div class="calendar-view pe-lg-3">
            <div id="desktop-calendar-container" class="calendar-container"
                hx-get="{% url 'stockdiary:calendar_partial' %}?view=desktop"
                hx-trigger="load"
                hx-swap="innerHTML"
                hx-indicator="#desktop-calendar-loading">
              <div id="desktop-calendar-loading" class="text-center py-4 htmx-indicator">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">カレンダーを読み込んでいます...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Events Part: Right Side (3/10) -->
        <div class="col-lg-5">
          <div class="card h-100" id="desktop-events-card">
            <div class="card-header bg-white">
              <h6 class="mb-0" id="desktop-selected-date">選択日のイベント</h6>
            </div>
            <div class="card-body" id="desktop-day-events"
                hx-get="{% url 'stockdiary:day_events' %}"
                hx-trigger="date-selected from:body"
                hx-target="#desktop-day-events"
                hx-swap="innerHTML"
                hx-include="[name='date'], [name='view']">
              <p class="text-muted">日付を選択するとイベントが表示されます</p>
              <!-- Event Loading Indicator -->
              <div id="day-events-loading-desktop" class="htmx-indicator text-center mt-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">読み込み中...</span>
                </div>
              </div>
              <input type="hidden" name="view" value="desktop">
              <input type="hidden" name="date" value="">
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- スマホ用のイベント表示カード -->
    <div class="d-lg-none">
      <div class="card mt-3 mb-4" id="mobile-events-card" style="display: none;">
        <div class="card-header bg-white">
          <h6 class="mb-0" id="mobile-selected-date">選択日のイベント</h6>
        </div>
        <div class="card-body" id="mobile-day-events">
          <p class="text-muted">日付を選択するとイベントが表示されます</p>
          <!-- イベントローディングインジケータ追加 -->
          <div id="day-events-loading-mobile" class="htmx-indicator text-center">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">読み込み中...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="diary-search mb-4">
    <form hx-get="{% url 'stockdiary:diary_list' %}" 
          hx-target="#diary-container"
          hx-indicator="#search-indicator"
          hx-push-url="true"
          class="mb-3">
      <div class="row g-2">
        <!-- 検索フィールド -->
        <div class="col-md-4 col-sm-12 mb-2">
          <label for="query" class="form-label">検索</label>
          <div class="position-relative">
            <i class="bi bi-search" style="position: absolute; right: 10px; top: 10px; color: #aaa;"></i>
            <input type="text" id="query" name="query" class="form-control validate-inline" 
                   placeholder="銘柄名/シンボル/内容/メモ"
                   value="{{ request.GET.query }}"
                   hx-get="{% url 'stockdiary:search_suggestion' %}"
                   hx-trigger="keyup changed delay:500ms"
                   hx-target="#search-suggestion">
          </div>
          <div id="search-suggestion" class="small"></div>
          <small class="form-text text-muted">日記内容も含めて検索できます</small>
        </div>
  
        <!-- タグ絞り込みセレクト -->
        <div class="col-md-4 col-sm-12 mb-2">
          <label for="tag" class="form-label">タグで絞り込み</label>
          <select id="tag" name="tag" class="form-select" 
                 hx-get="{% url 'stockdiary:diary_list' %}" 
                 hx-target="#diary-container" 
                 hx-indicator="#search-indicator"
                 hx-push-url="true">
            <option value="">すべて表示</option>
            {% for tag in tags %}
            <option value="{{ tag.id }}" {% if request.GET.tag == tag.id|stringformat:"i" %}selected{% endif %}>
              {{ tag.name }}
            </option>
            {% endfor %}
          </select>
        </div>
  
        <!-- 保有状態フィルター -->
        <div class="col-md-4 col-sm-12 mb-2">
          <label for="status" class="form-label">保有状態</label>
          <select id="status" name="status" class="form-select" 
                 hx-get="{% url 'stockdiary:diary_list' %}" 
                 hx-target="#diary-container" 
                 hx-indicator="#search-indicator"
                 hx-push-url="true">
            <option value="" {% if not request.GET.status %}selected{% endif %}>すべて</option>
            <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>保有中</option>
            <option value="sold" {% if request.GET.status == 'sold' %}selected{% endif %}>売却済み</option>
            <option value="memo" {% if request.GET.status == 'memo' %}selected{% endif %}>メモのみ</option>
          </select>
        </div>
      </div>
  
      <div class="d-flex justify-content-end mt-2">
        <div id="search-indicator" class="htmx-indicator me-2">
          <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">検索中...</span>
          </div>
        </div>
        <button type="submit" class="btn btn-diary btn-diary-primary me-2">
          <i class="bi bi-search me-1"></i> 検索
        </button>
        <a href="{% url 'stockdiary:home' %}" class="btn btn-diary btn-diary-outline"
           hx-get="{% url 'stockdiary:diary_list' %}" 
           hx-target="#diary-container"
           hx-push-url="true">
          <i class="bi bi-arrow-counterclockwise me-1"></i> リセット
        </a>
      </div>
    </form>
  </div>

  <!-- 日記カード一覧 -->
  <h4 class="mb-3 diary-title px-2">
    <i class="bi bi-journal-richtext"></i> 株式日記リスト
  </h4>

  <!-- オフライン通知 -->
  <div class="offline-alert alert alert-warning mb-3">
    <i class="bi bi-wifi-off me-2"></i>
    <span>オフライン状態です。ネットワーク接続を確認してください。</span>
  </div>

  <!-- 日記リストコンテナ - HTMX対応 (PCでの2列表示のためのクラスを追加) -->
  <div id="diary-container" class="home-diary-grid"
       hx-get="{% url 'stockdiary:diary_list' %}"
       hx-trigger="load, pulldown"
       hx-indicator="#diary-loading"
       data-hx-offline-queue="true">
    <div id="diary-loading" class="text-center py-4 htmx-indicator grid-column-span">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">日記を読み込んでいます...</span>
      </div>
      <p class="mt-2">日記を読み込んでいます...</p>
    </div>
  </div>
</div>

{% include 'speed_dial.html' with actions=form_actions %}
{% include "stockdiary/partials/quick_diary_modal.html" %}
{% endblock %}

{% block scripts %}
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/ja.js"></script>
<script src="{% static 'js/quick-diary.js' %}"></script>
<!-- モバイルジェスチャー用のJSを追加 -->
<script src="{% static 'js/mobile-gestures.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // 基本的な初期化
  if (typeof initializeSpeedDial === 'function') {
    initializeSpeedDial();
  }
  
  // モバイルカレンダーのアコーディオン処理を強化
  const calendarCollapse = document.getElementById('calendarCollapse');
  if (calendarCollapse) {
    calendarCollapse.addEventListener('shown.bs.collapse', function() {
      const container = document.getElementById('mobile-calendar-container');
      if (container && !container.getAttribute('data-loaded')) {
        htmx.trigger(container, 'revealed');
        container.setAttribute('data-loaded', 'true');
        // モバイルイベントカードを表示
        const mobileEventsCard = document.getElementById('mobile-events-card');
        if (mobileEventsCard) {
          mobileEventsCard.style.display = 'block';
        }
      }
    });
  }
  
  // オフライン状態の監視
  window.addEventListener('online', function() {
    document.body.classList.remove('is-offline');
  });
  
  window.addEventListener('offline', function() {
    document.body.classList.add('is-offline');
  });
  
  // 初期状態のチェック
  if (!navigator.onLine) {
    document.body.classList.add('is-offline');
  }
  
  // カレンダー日付クリック処理を強化
  document.addEventListener('click', function(e) {
    const td = e.target.closest('td[data-date]');
    if (td) {
      // クリックされた日付をハイライト
      document.querySelectorAll('td').forEach(cell => cell.classList.remove('fc-day-clicked'));
      td.classList.add('fc-day-clicked');
      
      // データと日付を取得して、イベントをトリガー
      const dateStr = td.getAttribute('data-date');
      if (dateStr) {
        // 日付を入力フィールドに設定
        document.querySelectorAll('input[name="date"]').forEach(input => {
          input.value = dateStr;
        });
        
        // カスタムイベントをディスパッチ
        htmx.trigger('body', 'date-selected');
        
        // 選択日の表示を更新
        const dateObj = new Date(dateStr);
        const formattedDate = dateObj.getFullYear() + '年' + 
                             (dateObj.getMonth() + 1) + '月' + 
                             dateObj.getDate() + '日のイベント';
        
        const mobileDate = document.getElementById('mobile-selected-date');
        const desktopDate = document.getElementById('desktop-selected-date');
        
        if (mobileDate) mobileDate.textContent = formattedDate;
        if (desktopDate) desktopDate.textContent = formattedDate;
        
        // スマホ表示の場合は自動スクロール
        if (window.innerWidth < 992) {
          const eventsCard = document.getElementById('mobile-events-card');
          if (eventsCard) {
            eventsCard.style.display = 'block';
            eventsCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        }
      }
    }
  });
  
  // HTMX エラーハンドリング
  document.body.addEventListener('htmx:responseError', function(event) {
    console.error('HTMX エラー:', event.detail.xhr.status, event.detail.xhr.statusText);
    
    // ターゲット要素
    const target = event.detail.target;
    
    // エラーメッセージ表示
    if (target.id === 'desktop-day-events' || target.id === 'mobile-day-events') {
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-exclamation-triangle me-2"></i>
          イベントの読み込みに失敗しました。ネットワーク接続を確認してください。
        </div>
      `;
    } else if (target.id === 'desktop-calendar-container' || target.id === 'mobile-calendar-container') {
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-exclamation-triangle me-2"></i>
          カレンダーの読み込みに失敗しました。ネットワーク接続を確認してください。
        </div>
      `;
    }
  });
  
  // イベントリスト読み込み完了イベント
  document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'desktop-day-events' || event.detail.target.id === 'mobile-day-events') {
      // イベントがロードされたら、アニメーション効果を追加
      const items = event.detail.target.querySelectorAll('.calendar-event-item');
      items.forEach((item, index) => {
        // 少し遅延させて順番にフェードイン
        item.style.opacity = '0';
        item.style.transform = 'translateY(10px)';
        item.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        
        setTimeout(() => {
          item.style.opacity = '1';
          item.style.transform = 'translateY(0)';
        }, 50 * index);
      });
    }
  });
  
  // HTMXリクエストにCSRFトークンを追加
  document.body.addEventListener('htmx:configRequest', function(evt) {
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    if (!evt.detail.headers) {
      evt.detail.headers = {};
    }
    evt.detail.headers['X-CSRFToken'] = csrfToken;
  });
});

// HTMX設定
htmx.config.defaultSwapStyle = "innerHTML";
htmx.config.includeIndicatorStyles = true;
htmx.config.withCredentials = true;

// エラー処理を強化
htmx.on('htmx:beforeRequest', function(evt) {
  // インジケーター要素を取得
  const indicatorSelector = evt.detail.elt.getAttribute('hx-indicator');
  if (indicatorSelector) {
    const indicator = document.querySelector(indicatorSelector);
    if (!indicator) {
      console.warn('Indicator not found:', indicatorSelector);
      // インジケーターが存在しない場合は属性を削除
      evt.detail.elt.removeAttribute('hx-indicator');
    }
  }
});

// オフライン状態検出
htmx.on('htmx:beforeRequest', function(evt) {
  if (!navigator.onLine) {
    evt.preventDefault();
    document.body.classList.add('is-offline');
    
    // オフライン通知を表示
    const target = evt.detail.target;
    if (target) {
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-wifi-off me-2"></i>
          現在オフライン状態です。ネットワーク接続を確認してください。
        </div>
      `;
    }
  }
});
</script>
{% endblock %}