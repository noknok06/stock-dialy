{% extends 'base.html' %}
{% load stockdiary_filters %}
{% load static %}
{% load humanize %}
{% load ads_tags %}
{% block title %}株式日記 | カブログ{% endblock %}

{% block head %}
<!-- 共通スタイルシートを読み込み -->
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/quick-diary.css' %}">
<!-- モバイルジェスチャー用のスタイルシート追加 -->

<!-- モバイルジェスチャー用のスタイルシート -->
<link rel="stylesheet" href="{% static 'css/mobile-gestures.css' %}">
<link rel="stylesheet" href="{% static 'css/search-suggestions.css' %}">

<style>
/* 日記カードタブのスタイル */
.diary-card-tabs {
  margin-top: 1rem;
}

.card-tabs .nav-link {
  padding: 0.4rem 0.75rem;
  font-size: 0.85rem;
  color: var(--text-light);
  border: none;
  border-radius: 0;
  position: relative;
}

.card-tabs .nav-link::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 100%;
  height: 2px;
  background-color: transparent;
  transition: background-color 0.2s;
}

.card-tabs .nav-link.active {
  color: var(--primary-color);
  font-weight: 500;
  background-color: transparent;
}

.card-tabs .nav-link.active::after {
  background-color: var(--primary-color);
}

.card-tabs .nav-link:hover:not(.active) {
  color: var(--primary-color);
  background-color: rgba(79, 70, 229, 0.05);
}

.card-tabs .nav-link i {
  margin-right: 0.3rem;
}

/* 検索ハイライト */
.search-highlight {
  background-color: #ffc107;
  color: #000;
  padding: 0 2px;
  border-radius: 2px;
  font-weight: bold;
}

/* 日記カードの強調 */
.diary-card-highlight {
  border-left: 3px solid #ffc107 !important;
}

/* インジケーターのスタイルを改善 */
.htmx-indicator {
  opacity: 0;
  transition: opacity 200ms ease-in;
  display: none;
}

.htmx-request .htmx-indicator {
  opacity: 1;
  display: flex !important;
  justify-content: center;
  align-items: center;
}

/* インジケーターを常に表示 */
#day-events-loading-desktop,
#day-events-loading-mobile {
  display: none !important;
}

.htmx-request #day-events-loading-desktop,
.htmx-request #day-events-loading-mobile {
  display: flex !important;
}

/* 無限スクロールのローディング表示 */
#loading-indicator {
  padding: 1rem;
  margin: 1rem 0;
  text-align: center;
}

#loading-indicator .spinner-border {
  width: 2rem;
  height: 2rem;
}

/* オフラインモード用 */
.offline-alert {
  display: none;
}
.is-offline .offline-alert {
  display: block;
}

/* PCでの2列表示用スタイル追加 */
.home-diary-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
}

/* タブレット以上のサイズでは2列表示に */
@media (min-width: 992px) {
  .home-diary-grid {
    grid-template-columns: 1fr 1fr;
  }
}

/* グリッドレイアウトでの表示調整用スタイル */
.grid-column-span {
  grid-column: 1 / -1; /* すべての列にまたがる */
}

/* オフラインバッジのスタイル */
.offline-badge {
  display: none;
}

/* ========== 1. 日記カードグリッドの調整 ========== */
.home-diary-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1.5rem; /* ギャップを統一 */
  width: 100%;
  max-width: 100%;
}

/* タブレット以上での2列表示を改善 */
@media (min-width: 992px) {
  .home-diary-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem; /* PCでは少し広いギャップ */
  }
}

/* 超大画面では最大幅を制限 */
@media (min-width: 1400px) {
  .home-diary-grid {
    max-width: 1200px;
    margin: 0 auto;
  }
}

/* ========== 2. カレンダーの幅調整 ========== */
.calendar-view {
  width: 100%;
  max-width: 100%;
  overflow: hidden; /* はみ出し防止 */
}

.calendar-container {
  width: 100%;
  min-height: 350px;
}

/* デスクトップでのカレンダーとイベントの幅比率調整 */
@media (min-width: 992px) {
  .calendar-view .col-lg-7 {
    padding-right: 1rem;
  }
  
  .calendar-view .col-lg-5 {
    padding-left: 1rem;
  }
}

/* ========== 3. 検索フォームの調整 ========== */
.diary-search .row.g-2 > .col-md-4 {
  margin-bottom: 0.75rem;
}

@media (max-width: 767.98px) {
  .diary-search .row.g-2 > .col-md-4 {
    width: 100%;
    margin-bottom: 1rem;
  }
}

/* ========== 4. 日記カードの内部調整 ========== */
.diary-card {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
}

.diary-card-header {
  padding: 1.25rem 1.5rem 1rem;
  min-height: auto;
}

.diary-card-body {
  padding: 0.75rem 1.25rem 1.25rem;
}

/* タブの幅調整 */
.card-tabs {
  margin: 0 -0.25rem 0.75rem;
  overflow-x: auto;
  overflow-y: hidden;
  scrollbar-width: none;
  -ms-overflow-style: none;
}

.card-tabs::-webkit-scrollbar {
  display: none;
}

.card-tabs .nav-link {
  white-space: nowrap;
  flex-shrink: 0;
  min-width: 80px;
}

/* ========== 5. 情報ブロックの幅調整 ========== */
.info-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 1rem;
  width: 100%;
}

@media (max-width: 576px) {
  .info-row {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
}

.info-item {
  min-width: 0; /* グリッドアイテムの幅制限を解除 */
  margin-bottom: 0;
}

/* ========== 6. ボタン配置の調整 ========== */
.action-buttons {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  justify-content: flex-start;
}

@media (max-width: 576px) {
  .action-buttons {
    flex-direction: column;
    width: 100%;
  }
  
  .action-buttons .btn {
    width: 100%;
    margin-bottom: 0.5rem;
  }
}

/* ========== 7. カードタイトル部分の調整 ========== */
.diary-title {
  word-break: break-word;
  overflow-wrap: break-word;
  line-height: 1.4;
  margin-bottom: 0.5rem;
}

.diary-meta {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex-wrap: wrap;
}

/* ========== 8. 価格情報表示の調整 ========== */
.diary-price-info {
  text-align: right;
  min-width: 90px;
  max-width: 120px;
}

@media (max-width: 576px) {
  .diary-card-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .diary-price-info {
    text-align: left;
    margin-top: 0.75rem;
    min-width: auto;
    max-width: none;
    width: 100%;
  }
}

/* ========== 9. タグ表示の調整 ========== */
.diary-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin: 0.75rem 0 0.5rem;
  max-width: 100%;
}

.diary-tag {
  flex-shrink: 0;
  word-break: keep-all;
  white-space: nowrap;
}

/* ========== 10. モーダルの幅調整 ========== */
@media (max-width: 767.98px) {
  .modal-dialog {
    margin: 0.5rem;
    max-width: calc(100vw - 1rem);
    width: calc(100vw - 1rem);
  }
  
  .modal-content {
    border-radius: 0.75rem;
  }
}

/* ========== 11. フォーム要素の調整 ========== */
.form-control, .form-select {
  width: 100%;
  box-sizing: border-box;
}

.input-group {
  width: 100%;
}

.input-group .form-control {
  flex: 1;
  min-width: 0;
}

/* ========== 12. テーブルの調整 ========== */
.table-responsive {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

@media (max-width: 767.98px) {
  .table-responsive {
    margin-left: -0.5rem;
    margin-right: -0.5rem;
    padding: 0 0.5rem;
  }
}

/* ========== 13. アコーディオンの調整 ========== */
.accordion-item {
  border-left: none;
  border-right: none;
}

.accordion-button {
  padding: 1rem 1.25rem;
}

.accordion-body {
  padding: 0;
}

/* ========== 14. カレンダーテーブルの調整 ========== */
.fc-scrollgrid-sync-table {
  width: 100%;
  table-layout: fixed;
}

.fc-scrollgrid-sync-table td,
.fc-scrollgrid-sync-table th {
  width: calc(100% / 7);
  text-align: center;
  vertical-align: middle;
}

/* ========== 15. コンテナの最大幅調整 ========== */
@media (min-width: 1200px) {
  .container {
    max-width: 1140px;
  }
}

@media (min-width: 1400px) {
  .container {
    max-width: 1200px; /* 超大画面でも適度な幅に制限 */
  }
}

/* ========== 16. スピードダイアルボタンの位置調整 ========== */
.speed-dial-container {
  position: fixed;
  bottom: 1.5rem;
  right: 1.5rem;
  z-index: 1040;
}

@media (max-width: 768px) {
  .speed-dial-container {
    bottom: 1rem;
    right: 1rem;
  }
}

/* ========== 17. 広告コンテナの調整 ========== */
.ad-container {
  width: 100%;
  max-width: 100%;
  margin: 1.5rem auto;
  text-align: center;
  overflow: hidden;
}

@media (max-width: 767.98px) {
  .ad-container {
    margin: 1rem auto;
    padding: 0 0.5rem;
  }
}

/* ========== 18. グリッドアイテムの調整 ========== */
.grid-column-span {
  grid-column: 1 / -1;
  width: 100%;
  max-width: 100%;
}

/* ========== 19. ナビゲーション調整 ========== */
.floating-nav-button {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 1041;
}

/* ========== 20. レスポンシブ画像 ========== */
img {
  max-width: 100%;
  height: auto;
}

/* ========== 21. オーバーフロー修正 ========== */
.card, .modal-content, .alert, .form-control, .btn {
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* ========== 22. フレックスアイテムの調整 ========== */
.d-flex {
  min-width: 0; /* フレックスアイテムの縮小を許可 */
}

.flex-shrink-0 {
  flex-shrink: 0;
}

.flex-grow-1 {
  flex-grow: 1;
  min-width: 0;
}

/* ========== 23. 小さなデバイス用の追加調整 ========== */
@media (max-width: 360px) {
  .container {
    padding-left: 0.75rem;
    padding-right: 0.75rem;
  }
  
  .diary-card-header,
  .diary-card-body {
    padding-left: 1rem;
    padding-right: 1rem;
  }
  
  .card-tabs .nav-link {
    padding: 0.5rem 0.4rem;
    font-size: 0.8rem;
  }
}

</style>
{% endblock %}

{% block content %}
<!-- CSRF トークンを追加 -->
{% csrf_token %}

<!-- オフライン状態バッジ -->
<div class="offline-badge">
  <i class="bi bi-wifi-off me-1"></i> オフライン状態です
</div>

<!-- コンテンツ上部の広告 -->
{% if show_ads %}
    {% show_template_ad "diary_top" %}
{% endif %}
<div class="container py-4">
  <!-- ヘッダー部分 -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h1 class="diary-title mb-2 mb-md-0">株式日記</h1>
    <a href="{% url 'stockdiary:create' %}" class="btn btn-diary btn-diary-primary">
      <i class="bi bi-plus-lg me-1"></i> 新規作成
    </a>
  </div>

  <!-- カレンダーセクションの改善 - 修正版 -->
  <div class="calendar-section mb-4">
    <!-- スマホ用カレンダーアコーディオン -->
    <div class="d-lg-none">
      <div class="accordion" id="calendarAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header" id="calendarHeading">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#calendarCollapse" aria-expanded="false" aria-controls="calendarCollapse">
              <i class="bi bi-calendar-week me-2"></i> 投資カレンダーを表示
            </button>
          </h2>
          <div id="calendarCollapse" class="accordion-collapse collapse" aria-labelledby="calendarHeading">
            <div class="accordion-body p-1">
              <!-- モバイルカレンダーコンテナ -->
              <div class="calendar-view" id="mobile-calendar-container"
                  hx-get="{% url 'stockdiary:calendar_partial' %}?view=mobile"
                  hx-trigger="revealed"
                  hx-swap="innerHTML"
                  hx-indicator="#mobile-calendar-loading">
                <div id="mobile-calendar-loading" class="text-center py-4 htmx-indicator">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2 mb-0">カレンダーを読み込んでいます...</p>
                </div>
              </div>
              
              <!-- ★ モバイル用イベント表示エリアを追加 ★ -->
              <div class="card mt-3" id="mobile-events-card" style="display: none;">
                <div class="card-header bg-white">
                  <h6 class="mb-0" id="mobile-selected-date">選択日のイベント</h6>
                </div>
                <div class="card-body p-2" id="mobile-day-events">
                  <p class="text-muted mb-0">日付を選択するとイベントが表示されます</p>
                  <div id="day-events-loading-mobile" class="htmx-indicator text-center mt-3" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                      <span class="visually-hidden">読み込み中...</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- デスクトップカレンダーコンテナ -->
    <div class="d-none d-lg-block">
      <div class="row g-3">
        <!-- カレンダー部分: 左側 (8/12) -->
        <div class="col-lg-8">
          <div class="calendar-view">
            <div id="desktop-calendar-container" class="calendar-container"
                hx-get="{% url 'stockdiary:calendar_partial' %}?view=desktop"
                hx-trigger="load"
                hx-swap="innerHTML"
                hx-indicator="#desktop-calendar-loading">
              <div id="desktop-calendar-loading" class="text-center py-4 htmx-indicator">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 mb-0">カレンダーを読み込んでいます...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- イベント部分: 右側 (4/12) -->
        <div class="col-lg-4">
          <div class="card h-100" id="desktop-events-card">
            <div class="card-header bg-white">
              <h6 class="mb-0" id="desktop-selected-date">選択日のイベント</h6>
            </div>
            <div class="card-body p-2" id="desktop-day-events">
              <p class="text-muted mb-0">日付を選択するとイベントが表示されます</p>
              <div id="day-events-loading-desktop" class="htmx-indicator text-center mt-3" style="display: none;">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">読み込み中...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="diary-search mb-4">
    <form hx-get="{% url 'stockdiary:diary_list' %}" 
          hx-target="#diary-container"
          hx-indicator="#search-indicator"
          hx-push-url="true"
          class="mb-3">
      <!-- グリッドレイアウトを微調整 -->
      <div class="row g-3"> <!-- g-2からg-3に変更 -->
        <!-- 検索フィールド -->
        <div class="col-lg-4 col-md-6 col-sm-12"> <!-- col-md-4からcol-lg-4 col-md-6に変更 -->
          <label for="query" class="form-label">検索</label>
          <div class="position-relative">
            <i class="bi bi-search" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #aaa; z-index: 5;"></i>
            <input type="text" id="query" name="query" class="form-control validate-inline" 
                  placeholder="銘柄名/シンボル/内容/メモ"
                  value="{{ request.GET.query }}"
                  hx-get="{% url 'stockdiary:search_suggestion' %}"
                  hx-trigger="keyup changed delay:500ms"
                  hx-target="#search-suggestion"
                  style="padding-right: 2.5rem;">
          </div>
          <div id="search-suggestion" class="small"></div>
          <small class="form-text text-muted">日記内容も含めて検索できます</small>
        </div>

        <!-- タグ絞り込みセレクト -->
        <div class="col-lg-4 col-md-6 col-sm-12"> <!-- col-md-4からcol-lg-4 col-md-6に変更 -->
          <label for="tag" class="form-label">タグで絞り込み</label>
          <select id="tag" name="tag" class="form-select" 
                hx-get="{% url 'stockdiary:diary_list' %}" 
                hx-target="#diary-container" 
                hx-indicator="#search-indicator"
                hx-push-url="true">
            <option value="">すべて表示</option>
            {% for tag in tags %}
            <option value="{{ tag.id }}" {% if request.GET.tag == tag.id|stringformat:"i" %}selected{% endif %}>
              {{ tag.name }}
            </option>
            {% endfor %}
          </select>
        </div>

        <!-- 保有状態フィルター -->
        <div class="col-lg-4 col-md-12 col-sm-12"> <!-- col-md-4からcol-lg-4 col-md-12に変更 -->
          <label for="status" class="form-label">保有状態</label>
          <select id="status" name="status" class="form-select" 
                hx-get="{% url 'stockdiary:diary_list' %}" 
                hx-target="#diary-container" 
                hx-indicator="#search-indicator"
                hx-push-url="true">
            <option value="" {% if not request.GET.status %}selected{% endif %}>すべて</option>
            <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>保有中</option>
            <option value="sold" {% if request.GET.status == 'sold' %}selected{% endif %}>売却済み</option>
            <option value="memo" {% if request.GET.status == 'memo' %}selected{% endif %}>メモのみ</option>
          </select>
        </div>
      </div>

      <!-- ボタンエリアの改善 -->
      <div class="d-flex flex-column flex-md-row justify-content-end align-items-stretch align-items-md-center gap-2 mt-3">
        <div id="search-indicator" class="htmx-indicator">
          <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">検索中...</span>
          </div>
        </div>
        <button type="submit" class="btn btn-diary btn-diary-primary">
          <i class="bi bi-search me-1"></i> 検索
        </button>
        <a href="{% url 'stockdiary:home' %}" class="btn btn-diary btn-diary-outline"
          hx-get="{% url 'stockdiary:diary_list' %}" 
          hx-target="#diary-container"
          hx-push-url="true">
          <i class="bi bi-arrow-counterclockwise me-1"></i> リセット
        </a>
      </div>
    </form>
  </div>


  <!-- 日記カード一覧 -->
  <h4 class="mb-3 diary-title px-2">
    <i class="bi bi-journal-richtext"></i> 株式日記リスト
  </h4>

  <!-- オフライン通知 -->
  <div class="offline-alert alert alert-warning mb-3">
    <i class="bi bi-wifi-off me-2"></i>
    <span>オフライン状態です。ネットワーク接続を確認してください。</span>
  </div>

  <!-- 日記リストコンテナ - HTMX対応 (PCでの2列表示のためのクラスを追加) -->
  <div id="diary-container" class="home-diary-grid"
       hx-get="{% url 'stockdiary:diary_list' %}"
       hx-trigger="load, pulldown"
       hx-indicator="#diary-loading"
       data-hx-offline-queue="true">
    <div id="diary-loading" class="text-center py-4 htmx-indicator grid-column-span">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">日記を読み込んでいます...</span>
      </div>
      <p class="mt-2">日記を読み込んでいます...</p>
    </div>
  </div>
</div>

{% include 'speed_dial.html' with actions=form_actions %}
{% include "stockdiary/partials/quick_diary_modal.html" %}
{% endblock %}

{% block scripts %}
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/ja.js"></script>
<script src="{% static 'js/quick-diary.js' %}"></script>
<!-- モバイルジェスチャー用のJSを追加 -->
<script src="{% static 'js/mobile-gestures.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // 基本的な初期化
  if (typeof initializeSpeedDial === 'function') {
    initializeSpeedDial();
  }
  
  // モバイルカレンダーのアコーディオン処理を強化
  const calendarCollapse = document.getElementById('calendarCollapse');
  if (calendarCollapse) {
    calendarCollapse.addEventListener('shown.bs.collapse', function() {
      const container = document.getElementById('mobile-calendar-container');
      if (container && !container.getAttribute('data-loaded')) {
        htmx.trigger(container, 'revealed');
        container.setAttribute('data-loaded', 'true');
      }
    });
  }
  
  // オフライン状態の監視
  window.addEventListener('online', function() {
    document.body.classList.remove('is-offline');
  });
  
  window.addEventListener('offline', function() {
    document.body.classList.add('is-offline');
  });
  
  // 初期状態のチェック
  if (!navigator.onLine) {
    document.body.classList.add('is-offline');
  }
  
  // ★ 修正: カレンダー日付クリック処理の統合 ★
  function setupCalendarClicks() {
    // 既存のクリックハンドラーを削除
    document.querySelectorAll('.calendar-cell').forEach(cell => {
      cell.removeEventListener('click', handleCalendarClick);
    });
    
    // 新しいクリックハンドラーを追加
    document.querySelectorAll('.calendar-cell').forEach(cell => {
      cell.addEventListener('click', handleCalendarClick);
    });
  }
  
  function handleCalendarClick(e) {
    const cell = e.currentTarget;
    const dateStr = cell.getAttribute('data-date');
    const view = cell.getAttribute('data-view');
    
    if (!dateStr || !view) return;
    
    // すべてのセルからクリック状態を削除
    document.querySelectorAll('.calendar-cell').forEach(c => {
      c.classList.remove('fc-day-clicked');
    });
    
    // クリックされたセルをハイライト
    cell.classList.add('fc-day-clicked');
    
    // 日付表示を更新
    updateSelectedDateDisplay(dateStr, view);
    
    // イベントを取得・表示
    loadDayEvents(dateStr, view);
    
    // モバイルの場合はイベントカードを表示してスクロール
    if (view === 'mobile') {
      const eventsCard = document.getElementById('mobile-events-card');
      if (eventsCard) {
        eventsCard.style.display = 'block';
        setTimeout(() => {
          eventsCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }
    }
  }
  
  function updateSelectedDateDisplay(dateStr, view) {
    try {
      const dateObj = new Date(dateStr);
      const formattedDate = dateObj.getFullYear() + '年' + 
                           (dateObj.getMonth() + 1) + '月' + 
                           dateObj.getDate() + '日のイベント';
      
      const targetId = view === 'mobile' ? 'mobile-selected-date' : 'desktop-selected-date';
      const dateElement = document.getElementById(targetId);
      
      if (dateElement) {
        dateElement.textContent = formattedDate;
      }
    } catch (e) {
      console.warn('日付の解析に失敗しました:', dateStr);
    }
  }
  
  function loadDayEvents(dateStr, view) {
    const targetId = view === 'mobile' ? 'mobile-day-events' : 'desktop-day-events';
    const loadingId = view === 'mobile' ? 'day-events-loading-mobile' : 'day-events-loading-desktop';
    
    const target = document.getElementById(targetId);
    const loading = document.getElementById(loadingId);
    
    if (!target) {
      console.warn('イベント表示ターゲットが見つかりません:', targetId);
      return;
    }
    
    // ローディング表示
    if (loading) {
      loading.style.display = 'block';
    }
    
    // HTMXでイベントを取得
    htmx.ajax('GET', `/stockdiary/day-events/?date=${dateStr}&view=${view}`, {
      target: `#${targetId}`,
      swap: 'innerHTML'
    }).then(() => {
      // ローディング非表示
      if (loading) {
        loading.style.display = 'none';
      }
      
      // アニメーション効果
      const items = target.querySelectorAll('.calendar-event-item');
      items.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(10px)';
        item.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        
        setTimeout(() => {
          item.style.opacity = '1';
          item.style.transform = 'translateY(0)';
        }, 50 * index);
      });
    }).catch((error) => {
      console.error('イベントの読み込みに失敗しました:', error);
      if (loading) {
        loading.style.display = 'none';
      }
      
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-exclamation-triangle me-2"></i>
          イベントの読み込みに失敗しました。ネットワーク接続を確認してください。
        </div>
      `;
    });
  }
  
  // HTMX エラーハンドリング
  document.body.addEventListener('htmx:responseError', function(event) {
    console.error('HTMX エラー:', event.detail.xhr.status, event.detail.xhr.statusText);
    
    const target = event.detail.target;
    
    if (target.id === 'desktop-day-events' || target.id === 'mobile-day-events') {
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-exclamation-triangle me-2"></i>
          イベントの読み込みに失敗しました。ネットワーク接続を確認してください。
        </div>
      `;
    } else if (target.id === 'desktop-calendar-container' || target.id === 'mobile-calendar-container') {
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-exclamation-triangle me-2"></i>
          カレンダーの読み込みに失敗しました。ネットワーク接続を確認してください。
        </div>
      `;
    }
  });
  
  // カレンダー読み込み完了時の処理
  document.body.addEventListener('htmx:afterSwap', function(event) {
    const targetId = event.detail.target.id;
    
    if (targetId === 'desktop-calendar-container' || targetId === 'mobile-calendar-container') {
      // カレンダーが更新されたらクリックハンドラーを再設定
      setTimeout(setupCalendarClicks, 100);
    }
    
    if (targetId === 'desktop-day-events' || targetId === 'mobile-day-events') {
      // イベントリストのアニメーション
      const items = event.detail.target.querySelectorAll('.calendar-event-item');
      items.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(10px)';
        item.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        
        setTimeout(() => {
          item.style.opacity = '1';
          item.style.transform = 'translateY(0)';
        }, 50 * index);
      });
    }
  });
  
  // HTMXリクエストにCSRFトークンを追加
  document.body.addEventListener('htmx:configRequest', function(evt) {
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    if (!evt.detail.headers) {
      evt.detail.headers = {};
    }
    evt.detail.headers['X-CSRFToken'] = csrfToken;
  });
  
  // 初期セットアップ
  setTimeout(setupCalendarClicks, 1000);
});

// HTMX設定
htmx.config.defaultSwapStyle = "innerHTML";
htmx.config.includeIndicatorStyles = true;
htmx.config.withCredentials = true;

// オフライン状態検出
htmx.on('htmx:beforeRequest', function(evt) {
  if (!navigator.onLine) {
    evt.preventDefault();
    document.body.classList.add('is-offline');
    
    const target = evt.detail.target;
    if (target) {
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-wifi-off me-2"></i>
          現在オフライン状態です。ネットワーク接続を確認してください。
        </div>
      `;
    }
  }
});

// HTMX設定
htmx.config.defaultSwapStyle = "innerHTML";
htmx.config.includeIndicatorStyles = true;
htmx.config.withCredentials = true;

// エラー処理を強化
htmx.on('htmx:beforeRequest', function(evt) {
  // インジケーター要素を取得
  const indicatorSelector = evt.detail.elt.getAttribute('hx-indicator');
  if (indicatorSelector) {
    const indicator = document.querySelector(indicatorSelector);
    if (!indicator) {
      console.warn('Indicator not found:', indicatorSelector);
      // インジケーターが存在しない場合は属性を削除
      evt.detail.elt.removeAttribute('hx-indicator');
    }
  }
});

// オフライン状態検出
htmx.on('htmx:beforeRequest', function(evt) {
  if (!navigator.onLine) {
    evt.preventDefault();
    document.body.classList.add('is-offline');
    
    // オフライン通知を表示
    const target = evt.detail.target;
    if (target) {
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-wifi-off me-2"></i>
          現在オフライン状態です。ネットワーク接続を確認してください。
        </div>
      `;
    }
  }
});
</script>
{% endblock %}