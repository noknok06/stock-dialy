{% extends 'base.html' %}
{% load stockdiary_filters %}
{% load static %}
{% load humanize %}
{% load ads_tags %}
{% block title %}株式日記 | カブログ{% endblock %}

{% block head %}
<!-- 共通スタイルシート -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/quick-diary.css' %}">
<link rel="stylesheet" href="{% static 'css/mobile-gestures.css' %}">
<link rel="stylesheet" href="{% static 'css/search-suggestions.css' %}">
<!-- コンポーネントCSS -->
<link rel="stylesheet" href="{% static 'css/3-components/components.css' %}">
<link rel="stylesheet" href="{% static 'css/3-components/dark-mode-components.css' %}">

<style>
/* ========== ページ固有スタイル ========== */
body {
  background-color: var(--bg-color);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* ========== 検索フォーム ========== */
.mobile-search-container {
  background-color: var(--card-bg-color);
  border-radius: var(--border-radius);
  box-shadow: var(--card-shadow);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-lg);
}

.search-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-md);
}

.search-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--primary-color);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.search-toggle {
  background: none;
  border: none;
  color: var(--primary-color);
  font-size: 1.2rem;
  padding: 0.25rem;
  border-radius: 4px;
  transition: background-color 0.2s;
}

.search-toggle:hover {
  background-color: rgba(90, 126, 197, 0.1);
}

/* メイン検索バー */
.main-search-wrapper {
  position: relative;
  margin-bottom: var(--spacing-md);
}

.main-search-input {
  width: 100%;
  min-height: var(--button-height-md);
  padding: 0.75rem 3rem 0.75rem 1rem;
  border: 2px solid #e5e7eb;
  border-radius: var(--border-radius);
  font-size: 16px;
  transition: all 0.2s ease;
}

.dark-mode .main-search-input,
[data-theme="dark"] .main-search-input {
  background: var(--reverse-bg-color);
  border: var(--primary-color) 1px solid;
}

.main-search-input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(90, 126, 197, 0.1);
}

.main-search-input::placeholder {
  color: #9ca3af;
  font-size: 0.95rem;
}

.search-icon {
  position: absolute;
  right: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af;
  font-size: 1.2rem;
  pointer-events: none;
}

/* アドバンス検索パネル */
.advanced-search-panel {
  border-top: 1px solid #e5e7eb;
  padding-top: var(--spacing-md);
  margin-top: var(--spacing-md);
}

.advanced-search-panel.collapsed {
  display: none;
}

.form-group {
  margin-bottom: var(--spacing-lg);
}

.form-label {
  font-weight: 500;
  color: var(--text-color);
  margin-bottom: var(--spacing-sm);
  font-size: 0.9rem;
}

.form-control, .form-select {
  min-height: var(--button-height-md);
  border: 1px solid #d1d5db;
  border-radius: var(--border-radius);
  font-size: 16px;
  padding: 0.75rem 1rem;
  transition: all 0.2s ease;
}

.form-control:focus, .form-select:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(90, 126, 197, 0.1);
  outline: none;
}

/* 検索サジェスチョン */
.search-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #e5e7eb;
  border-top: none;
  border-radius: 0 0 var(--border-radius) var(--border-radius);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  max-height: 300px;
  overflow-y: auto;
}

.suggestion-item {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid #f3f4f6;
  cursor: pointer;
  transition: background-color 0.2s;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.suggestion-item:hover {
  background-color: #f8f9fa;
}

.suggestion-item:last-child {
  border-bottom: none;
}

.suggestion-icon {
  color: var(--primary-color);
  font-size: 1rem;
}

.suggestion-text {
  flex: 1;
}

.suggestion-type {
  font-size: 0.8rem;
  color: var(--text-light);
  background-color: #f3f4f6;
  padding: 0.2rem 0.5rem;
  border-radius: 12px;
}

/* アクションボタン */
.search-actions {
  display: flex;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-lg);
}

/* アクティブフィルター */
.active-filters {
  margin-bottom: var(--spacing-md);
}

.filter-chip {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  background-color: var(--primary-color);
  color: white;
  padding: 0.5rem 0.75rem;
  border-radius: 20px;
  font-size: 0.85rem;
  margin-right: 0.5rem;
  margin-bottom: 0.5rem;
}

.filter-chip-remove {
  background: none;
  border: none;
  color: white;
  font-size: 0.9rem;
  padding: 0;
  cursor: pointer;
}

/* インジケーター */
.search-indicator {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--primary-color);
  font-size: 0.9rem;
}

/* レスポンシブ調整 */
@media (min-width: 768px) {
  .mobile-search-container {
    padding: 2rem;
  }
  
  .search-actions {
    justify-content: flex-end;
  }
  
  .advanced-fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-lg);
  }
  
  .form-group.full-width {
    grid-column: 1 / -1;
  }
}

/* アニメーション */
.slide-down {
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* 検索履歴 */
.search-history {
  margin-top: var(--spacing-md);
  padding-top: var(--spacing-md);
  border-top: 1px solid #f3f4f6;
}

.history-title {
  font-size: 0.85rem;
  color: var(--text-light);
  margin-bottom: var(--spacing-sm);
}

.history-items {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.history-item {
  background-color: #f8f9fa;
  border: 1px solid #e5e7eb;
  padding: 0.4rem 0.8rem;
  border-radius: 16px;
  font-size: 0.85rem;
  color: var(--text-color);
  cursor: pointer;
  transition: all 0.2s ease;
}

.history-item:hover {
  background-color: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

/* 検索結果カウント */
.search-results-info {
  background-color: #f8f9fa;
  border: 1px solid #e5e7eb;
  border-radius: var(--border-radius);
  padding: 0.75rem 1rem;
  margin-bottom: var(--spacing-lg);
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 0.9rem;
  color: var(--text-color);
}

/* 日記カードグリッド */
.home-diary-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1.5rem;
  width: 100%;
  max-width: 100%;
}

@media (min-width: 992px) {
  .home-diary-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 1.75rem;
  }
}

@media (min-width: 1400px) {
  .home-diary-grid {
    max-width: 1300px;
    margin: 0 auto;
    gap: 2rem;
  }
}

/* グリッドレイアウトでの表示調整 */
.grid-column-span {
  grid-column: 1 / -1;
}

/* オフラインバッジ */
.offline-badge {
  display: none;
}

.offline-alert {
  display: none;
}

.is-offline .offline-alert {
  display: block;
}

/* タグクリック */
.diary-tag {
  cursor: pointer !important;
  user-select: none;
  position: relative;
  overflow: hidden;
}

.diary-tag::before {
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(255, 255, 255, 0.2);
  opacity: 0;
  transition: opacity 0.2s ease;
}

.diary-tag:hover::before {
  opacity: 1;
}

.diary-tag:active {
  transform: scale(0.95);
}

.filter-notification {
  position: fixed;
  top: 80px;
  right: 20px;
  background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
  color: white;
  padding: 12px 20px;
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  z-index: 1050;
  display: flex;
  align-items: center;
  font-size: 0.9rem;
  font-weight: 500;
  opacity: 0;
  transform: translateX(400px);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.filter-notification.show {
  opacity: 1;
  transform: translateX(0);
}

@media (max-width: 768px) {
  .filter-notification {
    top: 70px;
    right: 10px;
    left: 10px;
    font-size: 0.85rem;
    padding: 10px 15px;
  }
}

.dark-mode .filter-notification,
[data-theme="dark"] .filter-notification {
  background: linear-gradient(135deg, var(--dm-primary), var(--dm-primary-hover));
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
}

.dark-mode .mobile-search-container,
[data-theme="dark"] .mobile-search-container {
  background-color: var(--bg-100);
  border: 1px solid var(--bg-200);
}

.dark-mode .main-search-input,
[data-theme="dark"] .main-search-input {
  background-color: var(--bg-200);
  border-color: var(--bg-300);
  color: var(--text-100);
}

.dark-mode .main-search-input:focus,
[data-theme="dark"] .main-search-input:focus {
  border-color: var(--primary-200);
  box-shadow: 0 0 0 3px rgba(89, 142, 243, 0.2);
}

.dark-mode .search-suggestions,
[data-theme="dark"] .search-suggestions {
  background-color: var(--bg-100);
  border-color: var(--bg-200);
}

.dark-mode .suggestion-item:hover,
[data-theme="dark"] .suggestion-item:hover {
  background-color: var(--bg-200);
}

.dark-mode .filter-chip,
[data-theme="dark"] .filter-chip {
  background: linear-gradient(135deg, var(--primary-100), var(--primary-200));
  color: white;
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<!-- オフライン状態バッジ -->
<div class="offline-badge">
  <i class="bi bi-wifi-off me-1"></i> オフライン状態です
</div>

<!-- コンテンツ上部の広告 -->
{% if show_ads %}
  {% show_template_ad "diary_top" %}
{% endif %}

<div class="container py-4">
  <div class="page-header page-header-with-actions mb-4">
    <div class="page-header-content">
      <h1 class="page-title">
        <i class="bi bi-journal-richtext"></i>
        <span>株式日記</span>
      </h1>
    </div>
    <div class="page-header-actions">
      <a href="{% url 'stockdiary:create' %}" class="btn btn-primary">
        <i class="bi bi-plus-lg me-1"></i>
        <span class="d-none d-sm-inline">新規作成</span>
        <span class="d-sm-none">作成</span>
      </a>
    </div>
  </div>

  <!-- 検索フォーム -->
  <div class="mobile-search-container mb-4">
    <div class="search-header">
      <div class="search-title">
        <i class="bi bi-search"></i>
        検索・フィルター
      </div>
      <button type="button" class="search-toggle" id="advancedToggle">
        <i class="bi bi-sliders"></i>
      </button>
    </div>

    <form hx-get="{% url 'stockdiary:diary_list' %}" 
          hx-target="#diary-container"
          hx-indicator="#search-indicator"
          hx-push-url="true"
          id="optimizedSearchForm">
      
      {% csrf_token %}
      
      <!-- メイン検索バー -->
      <div class="main-search-wrapper">
        <input type="text" 
               class="main-search-input validate-inline" 
               id="mainSearchInput"
               name="query" 
               placeholder="銘柄名、シンボル、内容で検索..."
               value="{{ request.GET.query }}"
               hx-get="{% url 'stockdiary:search_suggestion' %}"
               hx-trigger="keyup changed delay:500ms"
               hx-target="#searchSuggestions">
        <i class="bi bi-search search-icon"></i>
        
        <div class="search-suggestions" id="searchSuggestions"></div>
      </div>

      <!-- アクティブフィルターの表示 -->
      <div class="active-filters" id="activeFilters">
        {% with status_value=request.GET.status|default:"active" %}
          <div class="filter-chip" data-filter="status" data-value="{{ status_value }}">
            <span>
              {% if status_value == 'active' %}保有中のみ
              {% elif status_value == 'all' %}すべて表示
              {% elif status_value == 'sold' %}売却済み
              {% elif status_value == 'memo' %}メモのみ
              {% endif %}
            </span>
            <button type="button" class="filter-chip-remove" onclick="removeFilter('status')">
              <i class="bi bi-x"></i>
            </button>
          </div>
        {% endwith %}
        
        {% if request.GET.tag %}
          {% for tag in tags %}
            {% if tag.id|stringformat:"i" == request.GET.tag %}
              <div class="filter-chip" data-filter="tag" data-value="{{ tag.id }}">
                <span>タグ: {{ tag.name }}</span>
                <button type="button" class="filter-chip-remove" onclick="removeFilter('tag')">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}
        
        {% if request.GET.sector %}
          <div class="filter-chip" data-filter="sector" data-value="{{ request.GET.sector }}">
            <span>業種: {{ request.GET.sector }}</span>
            <button type="button" class="filter-chip-remove" onclick="removeFilter('sector')">
              <i class="bi bi-x"></i>
            </button>
          </div>
        {% endif %}
        
        {% if request.GET.transaction_date_range %}
          <div class="filter-chip" data-filter="transaction_date_range" data-value="{{ request.GET.transaction_date_range }}">
            <span>取引登録: 
              {% if request.GET.transaction_date_range == '1w' %}過去1週間
              {% elif request.GET.transaction_date_range == '1m' %}過去1ヶ月
              {% elif request.GET.transaction_date_range == '3m' %}過去3ヶ月
              {% elif request.GET.transaction_date_range == '6m' %}過去6ヶ月
              {% elif request.GET.transaction_date_range == '1y' %}過去1年
              {% endif %}
            </span>
            <button type="button" class="filter-chip-remove" onclick="removeFilter('transaction_date_range')">
              <i class="bi bi-x"></i>
            </button>
          </div>
        {% endif %}
        
        {% if request.GET.date_range %}
          <div class="filter-chip" data-filter="date_range" data-value="{{ request.GET.date_range }}">
            <span>購入日: 
              {% if request.GET.date_range == '1w' %}過去1週間
              {% elif request.GET.date_range == '1m' %}過去1ヶ月
              {% elif request.GET.date_range == '3m' %}過去3ヶ月
              {% elif request.GET.date_range == '6m' %}過去6ヶ月
              {% elif request.GET.date_range == '1y' %}過去1年
              {% endif %}
            </span>
            <button type="button" class="filter-chip-remove" onclick="removeFilter('date_range')">
              <i class="bi bi-x"></i>
            </button>
          </div>
        {% endif %}
        
        {% if request.GET.sort %}
          <div class="filter-chip" data-filter="sort" data-value="{{ request.GET.sort }}">
            <span>並び順: 
              {% if request.GET.sort == 'date_desc' %}取引日（新）
              {% elif request.GET.sort == 'date_asc' %}取引日（古）
              {% elif request.GET.sort == 'name' %}銘柄名順
              {% elif request.GET.sort == 'symbol' %}コード順
              {% elif request.GET.sort == 'profit_desc' %}損益（高）
              {% elif request.GET.sort == 'profit_asc' %}損益（低）
              {% elif request.GET.sort == 'transaction_count_desc' %}取引回数（多）
              {% elif request.GET.sort == 'transaction_count_asc' %}取引回数（少）
              {% elif request.GET.sort == 'total_cost_desc' %}総原価（高）
              {% elif request.GET.sort == 'total_cost_asc' %}総原価（低）
              {% endif %}
            </span>
            <button type="button" class="filter-chip-remove" onclick="removeFilter('sort')">
              <i class="bi bi-x"></i>
            </button>
          </div>
        {% endif %}
      </div>

      <!-- 詳細検索パネル -->
      <div class="advanced-search-panel collapsed" id="advancedPanel">
        <div class="advanced-fields">
          
          <!-- 保有状態フィルター -->
          <div class="form-group">
            <label class="form-label" for="statusFilter">
              <i class="bi bi-circle-fill me-1"></i>
              保有状態
            </label>
            <select class="form-select" id="statusFilter" name="status">
              {% with status_value=request.GET.status|default:"active" %}
                <option value="active" {% if status_value == 'active' %}selected{% endif %}>保有中のみ</option>
                <option value="all" {% if status_value == 'all' %}selected{% endif %}>すべて表示</option>
                <option value="sold" {% if status_value == 'sold' %}selected{% endif %}>売却済み</option>
                <option value="memo" {% if status_value == 'memo' %}selected{% endif %}>メモのみ</option>
              {% endwith %}
            </select>
          </div>

          <!-- タグフィルター -->
          <div class="form-group">
            <label class="form-label" for="tagFilter">
              <i class="bi bi-tag me-1"></i>
              タグで絞り込み
            </label>
            <select class="form-select" id="tagFilter" name="tag">
              <option value="">すべて表示</option>
              {% for tag in tags %}
                <option value="{{ tag.id }}" {% if request.GET.tag == tag.id|stringformat:"i" %}selected{% endif %}>
                  {{ tag.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- 業種フィルター -->
          <div class="form-group">
            <label class="form-label" for="sectorFilter">
              <i class="bi bi-diagram-3 me-1"></i>
              業種で絞り込み
            </label>
            <select class="form-select" id="sectorFilter" name="sector">
              <option value="">すべて表示</option>
              {% for sector in sectors %}
                <option value="{{ sector }}" {% if request.GET.sector == sector %}selected{% endif %}>
                  {{ sector }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- ソート順 -->
          <div class="form-group">
            <label class="form-label" for="sortFilter">
              <i class="bi bi-sort-down me-1"></i>
              並び順
            </label>
            <select class="form-select" id="sortFilter" name="sort">
              <option value="" {% if not request.GET.sort %}selected{% endif %}>更新日時（新しい順）</option>
              <option value="date_desc" {% if request.GET.sort == 'date_desc' %}selected{% endif %}>取引日（新しい順）</option>
              <option value="date_asc" {% if request.GET.sort == 'date_asc' %}selected{% endif %}>取引日（古い順）</option>
              <option value="name" {% if request.GET.sort == 'name' %}selected{% endif %}>銘柄名（あいうえお順）</option>
              <option value="symbol" {% if request.GET.sort == 'symbol' %}selected{% endif %}>証券コード順</option>
              <option value="profit_desc" {% if request.GET.sort == 'profit_desc' %}selected{% endif %}>実現損益（高い順）</option>
              <option value="profit_asc" {% if request.GET.sort == 'profit_asc' %}selected{% endif %}>実現損益（低い順）</option>
              <option value="transaction_count_desc" {% if request.GET.sort == 'transaction_count_desc' %}selected{% endif %}>取引回数（多い順）</option>
              <option value="transaction_count_asc" {% if request.GET.sort == 'transaction_count_asc' %}selected{% endif %}>取引回数（少ない順）</option>
              <option value="total_cost_desc" {% if request.GET.sort == 'total_cost_desc' %}selected{% endif %}>総取得原価（高い順）</option>
              <option value="total_cost_asc" {% if request.GET.sort == 'total_cost_asc' %}selected{% endif %}>総取得原価（低い順）</option>
            </select>
          </div>

          <!-- トランザクション期間フィルター -->
          <div class="form-group">
            <label class="form-label" for="transactionDateRangeFilter">
              <i class="bi bi-clock-history me-1"></i>
              取引登録日で絞り込み
            </label>
            <select class="form-select" id="transactionDateRangeFilter" name="transaction_date_range">
              <option value="" {% if not request.GET.transaction_date_range %}selected{% endif %}>すべての期間</option>
              <option value="1w" {% if request.GET.transaction_date_range == '1w' %}selected{% endif %}>過去1週間</option>
              <option value="1m" {% if request.GET.transaction_date_range == '1m' %}selected{% endif %}>過去1ヶ月</option>
              <option value="3m" {% if request.GET.transaction_date_range == '3m' %}selected{% endif %}>過去3ヶ月</option>
              <option value="6m" {% if request.GET.transaction_date_range == '6m' %}selected{% endif %}>過去6ヶ月</option>
              <option value="1y" {% if request.GET.transaction_date_range == '1y' %}selected{% endif %}>過去1年</option>
            </select>
          </div>

          <!-- 日付範囲フィルター -->
          <div class="form-group">
            <label class="form-label" for="dateRangeFilter">
              <i class="bi bi-calendar-range me-1"></i>
              購入日で絞り込み
            </label>
            <select class="form-select" id="dateRangeFilter" name="date_range">
              <option value="" {% if not request.GET.date_range %}selected{% endif %}>すべての期間</option>
              <option value="1w" {% if request.GET.date_range == '1w' %}selected{% endif %}>過去1週間</option>
              <option value="1m" {% if request.GET.date_range == '1m' %}selected{% endif %}>過去1ヶ月</option>
              <option value="3m" {% if request.GET.date_range == '3m' %}selected{% endif %}>過去3ヶ月</option>
              <option value="6m" {% if request.GET.date_range == '6m' %}selected{% endif %}>過去6ヶ月</option>
              <option value="1y" {% if request.GET.date_range == '1y' %}selected{% endif %}>過去1年</option>
            </select>
          </div>
        </div>

        <!-- 検索履歴 -->
        <div class="search-history" id="searchHistory" style="display: none;">
          <div class="history-title">最近の検索</div>
          <div class="history-items" id="historyItems"></div>
        </div>
      </div>

      <!-- アクションボタン -->
      <div class="search-actions">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-search"></i>
          検索
        </button>
        <a href="{% url 'stockdiary:home' %}?status=active" class="btn btn-outline-primary"
           hx-get="{% url 'stockdiary:diary_list' %}?status=active" 
           hx-target="#diary-container"
           hx-push-url="true">
          <i class="bi bi-arrow-counterclockwise"></i>
          リセット
        </a>
      </div>

      <!-- ローディングインジケーター（コンポーネント使用） -->
      {% include "stockdiary/components/_loading.html" with id="search-indicator" htmx=True text="検索中..." inline=True size="sm" %}
    </form>
  </div>

  <!-- 日記カード一覧 -->
  <h4 class="mb-3 diary-title px-2">
    <i class="bi bi-journal-richtext"></i> 株式日記リスト
  </h4>

  <!-- オフライン通知（コンポーネント使用） -->
  <div class="offline-alert mb-3">
    {% include "stockdiary/components/_alert.html" with type="warning" icon="bi-wifi-off" message="オフライン状態です。ネットワーク接続を確認してください。" %}
  </div>

  <!-- 日記リストコンテナ -->
  <div id="diary-container" class="home-diary-grid"
       hx-get="{% url 'stockdiary:diary_list' %}?status=active"
       hx-trigger="load, pulldown"
       hx-indicator="#diary-loading"
       data-hx-offline-queue="true">
    {% include "stockdiary/components/_loading.html" with id="diary-loading" htmx=True text="日記を読み込んでいます..." extra_class="grid-column-span" %}
  </div>
</div>

{% include 'speed_dial.html' with actions=form_actions %}
{% include "stockdiary/partials/quick_diary_modal.html" %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/ja.js"></script>
<script src="{% static 'js/mobile-gestures.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// 詳細検索パネルの切り替え
document.getElementById('advancedToggle').addEventListener('click', function() {
  const panel = document.getElementById('advancedPanel');
  const isCollapsed = panel.classList.contains('collapsed');
  
  if (isCollapsed) {
    panel.classList.remove('collapsed');
    panel.classList.add('slide-down');
    this.innerHTML = '<i class="bi bi-x"></i>';
  } else {
    panel.classList.add('collapsed');
    this.innerHTML = '<i class="bi bi-sliders"></i>';
  }
});

// メイン検索入力のフォーカス処理
const mainSearchInput = document.getElementById('mainSearchInput');
const searchSuggestions = document.getElementById('searchSuggestions');

mainSearchInput.addEventListener('focus', function() {
  if (this.value.length > 0) {
    searchSuggestions.style.display = 'block';
  }
});

mainSearchInput.addEventListener('input', function() {
  if (this.value.length > 1) {
    searchSuggestions.style.display = 'block';
  } else {
    searchSuggestions.style.display = 'none';
  }
});

// 外部クリックでサジェスチョンを閉じる
document.addEventListener('click', function(e) {
  if (!e.target.closest('.main-search-wrapper')) {
    searchSuggestions.style.display = 'none';
  }
});

// レスポンシブ対応
function handleResize() {
  const isMobile = window.innerWidth < 768;
  const advancedFields = document.querySelector('.advanced-fields');
  
  if (advancedFields) {
    if (isMobile) {
      advancedFields.style.display = 'block';
    } else {
      advancedFields.style.display = 'grid';
    }
  }
}

window.addEventListener('resize', handleResize);
handleResize();
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  if (typeof initializeSpeedDial === 'function') {
    initializeSpeedDial();
  }
  
  // オフライン状態の監視
  window.addEventListener('online', function() {
    document.body.classList.remove('is-offline');
  });
  
  window.addEventListener('offline', function() {
    document.body.classList.add('is-offline');
  });
  
  if (!navigator.onLine) {
    document.body.classList.add('is-offline');
  }
  
  // HTMXリクエストにCSRFトークンを追加
  document.body.addEventListener('htmx:configRequest', function(evt) {
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (csrfToken) {
      if (!evt.detail.headers) {
        evt.detail.headers = {};
      }
      evt.detail.headers['X-CSRFToken'] = csrfToken.value;
    }
  });
});

// HTMX設定
htmx.config.defaultSwapStyle = "innerHTML";
htmx.config.includeIndicatorStyles = true;
htmx.config.withCredentials = true;

// エラー処理
htmx.on('htmx:beforeRequest', function(evt) {
  const indicatorSelector = evt.detail.elt.getAttribute('hx-indicator');
  if (indicatorSelector) {
    const indicator = document.querySelector(indicatorSelector);
    if (!indicator) {
      console.warn('Indicator not found:', indicatorSelector);
      evt.detail.elt.removeAttribute('hx-indicator');
    }
  }
  
  if (!navigator.onLine) {
    evt.preventDefault();
    document.body.classList.add('is-offline');
    
    const target = evt.detail.target;
    if (target) {
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-wifi-off me-2"></i>
          現在オフライン状態です。ネットワーク接続を確認してください。
        </div>
      `;
    }
  }
});
</script>

<script>
function removeFilter(filterName) {
  const urlParams = new URLSearchParams(window.location.search);
  
  urlParams.delete(filterName);
  
  if (filterName === 'status') {
    urlParams.set('status', 'all');
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
      statusFilter.value = 'all';
    }
  } else if (filterName === 'tag') {
    const tagFilter = document.getElementById('tagFilter');
    if (tagFilter) {
      tagFilter.value = '';
    }
  } else if (filterName === 'sector') {
    const sectorFilter = document.getElementById('sectorFilter');
    if (sectorFilter) {
      sectorFilter.value = '';
    }
  } else if (filterName === 'transaction_date_range') {
    const transactionDateRangeFilter = document.getElementById('transactionDateRangeFilter');
    if (transactionDateRangeFilter) {
      transactionDateRangeFilter.value = '';
    }
  } else if (filterName === 'date_range') {
    const dateRangeFilter = document.getElementById('dateRangeFilter');
    if (dateRangeFilter) {
      dateRangeFilter.value = '';
    }
  } else if (filterName === 'sort') {
    const sortFilter = document.getElementById('sortFilter');
    if (sortFilter) {
      sortFilter.value = '';
    }
  }
  
  const badge = document.querySelector(`[data-filter="${filterName}"]`);
  if (badge) {
    badge.remove();
  }
  
  urlParams.delete('page');
  
  const newUrl = `/stockdiary/diary-list/?${urlParams.toString()}`;
  htmx.ajax('GET', newUrl, {
    target: '#diary-container', 
    swap: 'innerHTML', 
    pushUrl: true
  }).then(() => {
    if (typeof updateFilterBadges === 'function') {
      updateFilterBadges();
    }
  });
}

function updateFilterBadges() {
  const activeFiltersContainer = document.getElementById('activeFilters');
  if (!activeFiltersContainer) return;
  
  activeFiltersContainer.innerHTML = '';
  
  const currentUrlParams = new URLSearchParams(window.location.search);
  
  const statusFilter = document.getElementById('statusFilter');
  const tagFilter = document.getElementById('tagFilter');
  const sectorFilter = document.getElementById('sectorFilter');
  const sortFilter = document.getElementById('sortFilter');
  const transactionDateRangeFilter = document.getElementById('transactionDateRangeFilter');
  const dateRangeFilter = document.getElementById('dateRangeFilter');
  
  if (statusFilter) {
    const statusValue = statusFilter.value || 'active';
    if (currentUrlParams.has('status') || (!currentUrlParams.has('status') && statusValue === 'active')) {
      const statusText = {
        'active': '保有中のみ',
        'all': 'すべて表示',
        'sold': '売却済み',
        'memo': 'メモのみ'
      };
      addFilterBadge('status', statusValue, statusText[statusValue] || statusValue);
    }
  }
  
  if (tagFilter && tagFilter.value) {
    const tagName = tagFilter.options[tagFilter.selectedIndex].text;
    addFilterBadge('tag', tagFilter.value, `タグ: ${tagName}`);
  }
  
  if (sectorFilter && sectorFilter.value) {
    addFilterBadge('sector', sectorFilter.value, `業種: ${sectorFilter.value}`);
  }
  
  if (transactionDateRangeFilter && transactionDateRangeFilter.value) {
    const rangeText = {
      '1w': '過去1週間', '1m': '過去1ヶ月', '3m': '過去3ヶ月',
      '6m': '過去6ヶ月', '1y': '過去1年'
    };
    addFilterBadge('transaction_date_range', transactionDateRangeFilter.value, 
      `取引登録: ${rangeText[transactionDateRangeFilter.value] || transactionDateRangeFilter.value}`);
  }
  
  if (dateRangeFilter && dateRangeFilter.value) {
    const rangeText = {
      '1w': '過去1週間', '1m': '過去1ヶ月', '3m': '過去3ヶ月',
      '6m': '過去6ヶ月', '1y': '過去1年'
    };
    addFilterBadge('date_range', dateRangeFilter.value, 
      `購入日: ${rangeText[dateRangeFilter.value] || dateRangeFilter.value}`);
  }
  
  if (sortFilter && sortFilter.value) {
    const sortText = {
      'date_desc': '取引日（新）', 'date_asc': '取引日（古）',
      'name': '銘柄名順', 'symbol': 'コード順',
      'profit_desc': '損益（高）', 'profit_asc': '損益（低）',
      'transaction_count_desc': '取引回数（多）', 'transaction_count_asc': '取引回数（少）',
      'total_cost_desc': '総原価（高）', 'total_cost_asc': '総原価（低）'
    };
    addFilterBadge('sort', sortFilter.value, `並び順: ${sortText[sortFilter.value] || sortFilter.value}`);
  }
}

function addFilterBadge(filterName, filterValue, displayText) {
  const activeFiltersContainer = document.getElementById('activeFilters');
  if (!activeFiltersContainer) return;
  
  const badge = document.createElement('div');
  badge.className = 'filter-chip';
  badge.setAttribute('data-filter', filterName);
  badge.setAttribute('data-value', filterValue);
  badge.innerHTML = `
    <span>${displayText}</span>
    <button type="button" class="filter-chip-remove" onclick="removeFilter('${filterName}')">
      <i class="bi bi-x"></i>
    </button>
  `;
  activeFiltersContainer.appendChild(badge);
}

document.addEventListener('DOMContentLoaded', function() {
  setTimeout(updateFilterBadges, 100);
  
  const filters = ['statusFilter', 'tagFilter', 'sectorFilter', 'sortFilter', 'transactionDateRangeFilter', 'dateRangeFilter'];
  filters.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('change', updateFilterBadges);
    }
  });
  
  document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'diary-container') {
      setTimeout(updateFilterBadges, 100);
    }
  });
});
</script>

<script>
// タグクリックフィルタリング機能
document.addEventListener('DOMContentLoaded', function() {
  function setupTagClickHandlers() {
    const tagElements = document.querySelectorAll('.diary-tag');
    
    tagElements.forEach(tag => {
      tag.removeEventListener('click', handleTagClick);
      tag.addEventListener('click', handleTagClick);
      tag.style.cursor = 'pointer';
      tag.style.transition = 'all 0.2s ease';
      
      tag.addEventListener('mouseenter', function() {
        this.style.transform = 'scale(1.05)';
        this.style.opacity = '0.8';
      });
      
      tag.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
        this.style.opacity = '1';
      });
    });
  }
  
  function handleTagClick(event) {
    event.preventDefault();
    event.stopPropagation();
    
    const tagElement = event.currentTarget;
    const tagId = tagElement.getAttribute('data-tag-id');
    const tagName = tagElement.textContent.trim();
    
    if (!tagId) {
      console.warn('タグIDが見つかりません');
      return;
    }
    
    applyTagFilter(tagId, tagName);
  }
  
  function applyTagFilter(tagId, tagName) {
    const tagFilterSelect = document.getElementById('tagFilter');
    if (tagFilterSelect) {
      tagFilterSelect.value = tagId;
    }
    
    const advancedPanel = document.getElementById('advancedPanel');
    const advancedToggle = document.getElementById('advancedToggle');
    
    if (advancedPanel && advancedPanel.classList.contains('collapsed')) {
      advancedPanel.classList.remove('collapsed');
      advancedPanel.classList.add('slide-down');
      
      if (advancedToggle) {
        advancedToggle.innerHTML = '<i class="bi bi-x"></i>';
        advancedToggle.setAttribute('aria-expanded', 'true');
      }
    }
    
    const searchForm = document.getElementById('optimizedSearchForm');
    if (searchForm) {
      htmx.trigger(searchForm, 'submit');
      
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
      
      showFilterNotification(tagName);
    }
  }
  
  function showFilterNotification(tagName) {
    const existingNotification = document.querySelector('.filter-notification');
    if (existingNotification) {
      existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = 'filter-notification';
    notification.innerHTML = `
      <i class="bi bi-tag-fill me-2"></i>
      タグ「${tagName}」でフィルタリング中
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.add('show');
    }, 10);
    
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        notification.remove();
      }, 300);
    }, 3000);
  }
  
  document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'diary-container') {
      setTimeout(setupTagClickHandlers, 100);
    }
  });
  
  setupTagClickHandlers();
});
</script>
{% endblock %}