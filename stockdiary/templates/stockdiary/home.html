{% extends 'base.html' %}
{% load stockdiary_filters %}
{% load static %}
{% load humanize %}
{% load ads_tags %}
{% block title %}株式日記 | カブログ{% endblock %}

{% block head %}
<!-- 共通スタイルシートを読み込み -->
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/quick-diary.css' %}">
<!-- モバイルジェスチャー用のスタイルシート追加 -->

<!-- モバイルジェスチャー用のスタイルシート -->
<link rel="stylesheet" href="{% static 'css/mobile-gestures.css' %}">
<link rel="stylesheet" href="{% static 'css/search-suggestions.css' %}">

<style>
/* 既存の変数を使用 */
:root {
    --primary-color: #5a7ec5;
    --secondary-color: #f8c291;
    --success-color: #5db075;
    --danger-color: #e15a5a;
    --warning-color: #f7b731;
    --info-color: #5da1e5;
    --bg-color: #f6f8fa;
    --card-bg-color: #ffffff;
    --text-color: #3a4a5a;
    --text-light: #6b7280;
    --border-radius: 8px;
    --spacing-xs: 0.25rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --card-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    --button-height-md: 44px;
}

body {
    background-color: var(--bg-color);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* ========== 検索フォーム最適化 ========== */
.mobile-search-container {
    background-color: var(--card-bg-color);
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
}

.search-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
}

.search-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.search-toggle {
    background: none;
    border: none;
    color: var(--primary-color);
    font-size: 1.2rem;
    padding: 0.25rem;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.search-toggle:hover {
    background-color: rgba(90, 126, 197, 0.1);
}

/* メイン検索バー */
.main-search-wrapper {
    position: relative;
    margin-bottom: var(--spacing-md);
}

.main-search-input {
    width: 100%;
    min-height: var(--button-height-md);
    padding: 0.75rem 3rem 0.75rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: var(--border-radius);
    font-size: 16px; /* iOSでズームを防ぐ */
    transition: all 0.2s ease;
    background-color: white;
}

.main-search-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(90, 126, 197, 0.1);
}

.main-search-input::placeholder {
    color: #9ca3af;
    font-size: 0.95rem;
}

.search-icon {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    font-size: 1.2rem;
    pointer-events: none;
}

/* アドバンス検索パネル（折りたたみ式） */
.advanced-search-panel {
    border-top: 1px solid #e5e7eb;
    padding-top: var(--spacing-md);
    margin-top: var(--spacing-md);
}

.advanced-search-panel.collapsed {
    display: none;
}

.form-group {
    margin-bottom: var(--spacing-lg);
}

.form-label {
    font-weight: 500;
    color: var(--text-color);
    margin-bottom: var(--spacing-sm);
    font-size: 0.9rem;
}

.form-control, .form-select {
    min-height: var(--button-height-md);
    border: 1px solid #d1d5db;
    border-radius: var(--border-radius);
    font-size: 16px;
    padding: 0.75rem 1rem;
    transition: all 0.2s ease;
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(90, 126, 197, 0.1);
    outline: none;
}

/* 検索サジェスチョン */
.search-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e5e7eb;
    border-top: none;
    border-radius: 0 0 var(--border-radius) var(--border-radius);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
}

.suggestion-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f3f4f6;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.suggestion-item:hover {
    background-color: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-icon {
    color: var(--primary-color);
    font-size: 1rem;
}

.suggestion-text {
    flex: 1;
}

.suggestion-type {
    font-size: 0.8rem;
    color: var(--text-light);
    background-color: #f3f4f6;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
}

/* アクションボタン */
.search-actions {
    display: flex;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-lg);
}

.btn-search {
    flex: 1;
    min-height: var(--button-height-md);
    background-color: var(--primary-color);
    border: none;
    color: white;
    border-radius: var(--border-radius);
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
}

.btn-search:hover {
    background-color: #4a6eaf;
    transform: translateY(-1px);
}

.btn-reset {
    min-height: var(--button-height-md);
    background-color: transparent;
    border: 2px solid #e5e7eb;
    color: var(--text-color);
    border-radius: var(--border-radius);
    padding: 0 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    text-decoration: none;
}

.btn-reset:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
    background-color: rgba(90, 126, 197, 0.05);
}

/* アクティブフィルターの表示 */
.active-filters {
    margin-bottom: var(--spacing-md);
}

.filter-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background-color: var(--primary-color);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

.filter-chip-remove {
    background: none;
    border: none;
    color: white;
    font-size: 0.9rem;
    padding: 0;
    cursor: pointer;
}

/* インジケーター */
.search-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--primary-color);
    font-size: 0.9rem;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

/* レスポンシブ調整 */
@media (min-width: 768px) {
    .mobile-search-container {
        padding: 2rem;
    }
    
    .search-actions {
        justify-content: flex-end;
    }
    
    .btn-search {
        flex: none;
        min-width: 120px;
    }
    
    /* デスクトップでは2列レイアウト */
    .advanced-fields {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-lg);
    }
    
    .form-group.full-width {
        grid-column: 1 / -1;
    }
}

/* アニメーション */
.slide-down {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* 検索履歴（オプション） */
.search-history {
    margin-top: var(--spacing-md);
    padding-top: var(--spacing-md);
    border-top: 1px solid #f3f4f6;
}

.history-title {
    font-size: 0.85rem;
    color: var(--text-light);
    margin-bottom: var(--spacing-sm);
}

.history-items {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.history-item {
    background-color: #f8f9fa;
    border: 1px solid #e5e7eb;
    padding: 0.4rem 0.8rem;
    border-radius: 16px;
    font-size: 0.85rem;
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.2s ease;
}

.history-item:hover {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

/* 検索結果カウント */
.search-results-info {
    background-color: #f8f9fa;
    border: 1px solid #e5e7eb;
    border-radius: var(--border-radius);
    padding: 0.75rem 1rem;
    margin-bottom: var(--spacing-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.9rem;
    color: var(--text-color);
}
/* 日記カードタブのスタイル */
.diary-card-tabs {
  margin-top: 1rem;
}

.card-tabs .nav-link {
  padding: 0.4rem 0.75rem;
  font-size: 0.85rem;
  color: var(--text-light);
  border: none;
  border-radius: 0;
  position: relative;
}

.card-tabs .nav-link::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 100%;
  height: 2px;
  background-color: transparent;
  transition: background-color 0.2s;
}

.card-tabs .nav-link.active {
  color: var(--primary-color);
  font-weight: 500;
  background-color: transparent;
}

.card-tabs .nav-link.active::after {
  background-color: var(--primary-color);
}

.card-tabs .nav-link:hover:not(.active) {
  color: var(--primary-color);
  background-color: rgba(79, 70, 229, 0.05);
}

.card-tabs .nav-link i {
  margin-right: 0.3rem;
}

/* 検索ハイライト */
.search-highlight {
  background-color: #ffc107;
  color: #000;
  padding: 0 2px;
  border-radius: 2px;
  font-weight: bold;
}

/* 日記カードの強調 */
.diary-card-highlight {
  border-left: 3px solid #ffc107 !important;
}

/* インジケーターのスタイルを改善 */
.htmx-indicator {
  opacity: 0;
  transition: opacity 200ms ease-in;
  display: none;
}

.htmx-request .htmx-indicator {
  opacity: 1;
  display: flex !important;
  justify-content: center;
  align-items: center;
}

/* 無限スクロールのローディング表示 */
#loading-indicator {
  padding: 1rem;
  margin: 1rem 0;
  text-align: center;
}

#loading-indicator .spinner-border {
  width: 2rem;
  height: 2rem;
}

/* オフラインモード用 */
.offline-alert {
  display: none;
}
.is-offline .offline-alert {
  display: block;
}

/* PCでの2列表示用スタイル追加 */
.home-diary-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
}

/* タブレット以上のサイズでは2列表示に */
@media (min-width: 992px) {
  .home-diary-grid {
    grid-template-columns: 1fr 1fr;
  }
}

/* グリッドレイアウトでの表示調整用スタイル */
.grid-column-span {
  grid-column: 1 / -1; /* すべての列にまたがる */
}

/* オフラインバッジのスタイル */
.offline-badge {
  display: none;
}

/* ========== 1. 日記カードグリッドの調整 ========== */
.home-diary-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1.5rem; /* ギャップを統一 */
  width: 100%;
  max-width: 100%;
}

/* タブレット以上での2列表示を改善 */
@media (min-width: 992px) {
  .home-diary-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem; /* PCでは少し広いギャップ */
  }
}

/* 超大画面では最大幅を制限 */
@media (min-width: 1400px) {
  .home-diary-grid {
    max-width: 1200px;
    margin: 0 auto;
  }
}

/* ========== 2. カレンダーの幅調整 ========== */
.calendar-view {
  width: 100%;
  max-width: 100%;
  overflow: hidden; /* はみ出し防止 */
}

.calendar-container {
  width: 100%;
  min-height: 350px;
}

/* デスクトップでのカレンダーとイベントの幅比率調整 */
@media (min-width: 992px) {
  .calendar-view .col-lg-7 {
    padding-right: 1rem;
  }
  
  .calendar-view .col-lg-5 {
    padding-left: 1rem;
  }
}

/* ========== 3. 検索フォームの調整 ========== */
.diary-search .row.g-2 > .col-md-4 {
  margin-bottom: 0.75rem;
}

@media (max-width: 767.98px) {
  .diary-search .row.g-2 > .col-md-4 {
    width: 100%;
    margin-bottom: 1rem;
  }
}

/* ========== 4. 日記カードの内部調整 ========== */
.diary-card {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
}

.diary-card-header {
  padding: 1.25rem 1.5rem 1rem;
  min-height: auto;
}

.diary-card-body {
  padding: 0.75rem 1.25rem 1.25rem;
}

/* タブの幅調整 */
.card-tabs {
  margin: 0 -0.25rem 0.75rem;
  overflow-x: auto;
  overflow-y: hidden;
  scrollbar-width: none;
  -ms-overflow-style: none;
}

.card-tabs::-webkit-scrollbar {
  display: none;
}

.card-tabs .nav-link {
  white-space: nowrap;
  flex-shrink: 0;
  min-width: 80px;
}

/* ========== 5. 情報ブロックの幅調整 ========== */
.info-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 1rem;
  width: 100%;
}

@media (max-width: 576px) {
  .info-row {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
}

.info-item {
  min-width: 0; /* グリッドアイテムの幅制限を解除 */
  margin-bottom: 0;
}

/* ========== 6. ボタン配置の調整 ========== */
.action-buttons {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  justify-content: flex-start;
}

@media (max-width: 576px) {
  .action-buttons {
    flex-direction: column;
    width: 100%;
  }
  
  .action-buttons .btn {
    width: 100%;
    margin-bottom: 0.5rem;
  }
}

/* ========== 7. カードタイトル部分の調整 ========== */
.diary-title {
  word-break: break-word;
  overflow-wrap: break-word;
  line-height: 1.4;
  margin-bottom: 0.5rem;
}

.diary-meta {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex-wrap: wrap;
}

/* ========== 8. 価格情報表示の調整 ========== */
.diary-price-info {
  text-align: right;
  min-width: 90px;
  max-width: 120px;
}

@media (max-width: 576px) {
  .diary-card-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .diary-price-info {
    text-align: left;
    margin-top: 0.75rem;
    min-width: auto;
    max-width: none;
    width: 100%;
  }
}

/* ========== 9. タグ表示の調整 ========== */
.diary-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin: 0.75rem 0 0.5rem;
  max-width: 100%;
}

.diary-tag {
  flex-shrink: 0;
  word-break: keep-all;
  white-space: nowrap;
}

/* ========== 10. モーダルの幅調整 ========== */
@media (max-width: 767.98px) {
  .modal-dialog {
    margin: 0.5rem;
    max-width: calc(100vw - 1rem);
    width: calc(100vw - 1rem);
  }
  
  .modal-content {
    border-radius: 0.75rem;
  }
}

/* ========== 11. フォーム要素の調整 ========== */
.form-control, .form-select {
  width: 100%;
  box-sizing: border-box;
}

.input-group {
  width: 100%;
}

.input-group .form-control {
  flex: 1;
  min-width: 0;
}

/* ========== 12. テーブルの調整 ========== */
.table-responsive {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

@media (max-width: 767.98px) {
  .table-responsive {
    margin-left: -0.5rem;
    margin-right: -0.5rem;
    padding: 0 0.5rem;
  }
}

/* ========== 13. アコーディオンの調整 ========== */
.accordion-item {
  border-left: none;
  border-right: none;
}

.accordion-button {
  padding: 1rem 1.25rem;
}

.accordion-body {
  padding: 0;
}

/* ========== 14. カレンダーテーブルの調整 ========== */
.fc-scrollgrid-sync-table {
  width: 100%;
  table-layout: fixed;
}

.fc-scrollgrid-sync-table td,
.fc-scrollgrid-sync-table th {
  width: calc(100% / 7);
  text-align: center;
  vertical-align: middle;
}

/* ========== 15. コンテナの最大幅調整 ========== */
@media (min-width: 1200px) {
  .container {
    max-width: 1140px;
  }
}

@media (min-width: 1400px) {
  .container {
    max-width: 1200px; /* 超大画面でも適度な幅に制限 */
  }
}

/* ========== 16. スピードダイアルボタンの位置調整 ========== */
.speed-dial-container {
  position: fixed;
  bottom: 1.5rem;
  right: 1.5rem;
  z-index: 1040;
}

@media (max-width: 768px) {
  .speed-dial-container {
    bottom: 1rem;
    right: 1rem;
  }
}

/* ========== 17. 広告コンテナの調整 ========== */
.ad-container {
  width: 100%;
  max-width: 100%;
  margin: 1.5rem auto;
  text-align: center;
  overflow: hidden;
}

@media (max-width: 767.98px) {
  .ad-container {
    margin: 1rem auto;
    padding: 0 0.5rem;
  }
}

/* ========== 18. グリッドアイテムの調整 ========== */
.grid-column-span {
  grid-column: 1 / -1;
  width: 100%;
  max-width: 100%;
}

/* ========== 19. ナビゲーション調整 ========== */
.floating-nav-button {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 1041;
}

/* ========== 20. レスポンシブ画像 ========== */
img {
  max-width: 100%;
  height: auto;
}

/* ========== 21. オーバーフロー修正 ========== */
.card, .modal-content, .alert, .form-control, .btn {
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* ========== 22. フレックスアイテムの調整 ========== */
.d-flex {
  min-width: 0; /* フレックスアイテムの縮小を許可 */
}

.flex-shrink-0 {
  flex-shrink: 0;
}

.flex-grow-1 {
  flex-grow: 1;
  min-width: 0;
}

/* ========== 23. 小さなデバイス用の追加調整 ========== */
@media (max-width: 360px) {
  .container {
    padding-left: 0.75rem;
    padding-right: 0.75rem;
  }
  
  .diary-card-header,
  .diary-card-body {
    padding-left: 1rem;
    padding-right: 1rem;
  }
  
  .card-tabs .nav-link {
    padding: 0.5rem 0.4rem;
    font-size: 0.8rem;
  }
}

</style>
{% endblock %}

{% block content %}
<!-- CSRF トークンを追加 -->
{% csrf_token %}

<!-- オフライン状態バッジ -->
<div class="offline-badge">
  <i class="bi bi-wifi-off me-1"></i> オフライン状態です
</div>

<!-- コンテンツ上部の広告 -->
{% if show_ads %}
    {% show_template_ad "diary_top" %}
{% endif %}
<div class="container py-4">
  <!-- ヘッダー部分 -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h1 class="diary-title mb-2 mb-md-0">株式日記</h1>
    <a href="{% url 'stockdiary:create' %}" class="btn btn-diary btn-diary-primary">
      <i class="bi bi-plus-lg me-1"></i> 新規作成
    </a>
  </div>
<div class="mobile-search-container mb-4">
  <!-- 検索ヘッダー -->
  <div class="search-header">
    <div class="search-title">
      <i class="bi bi-search"></i>
      検索・フィルター
    </div>
    <button type="button" class="search-toggle" id="advancedToggle">
      <i class="bi bi-sliders"></i>
    </button>
  </div>

  <form hx-get="{% url 'stockdiary:diary_list' %}" 
        hx-target="#diary-container"
        hx-indicator="#search-indicator"
        hx-push-url="true"
        id="optimizedSearchForm">
    
    {% csrf_token %}
    
    <!-- メイン検索バー -->
    <div class="main-search-wrapper">
      <input type="text" 
             class="main-search-input validate-inline" 
             id="mainSearchInput"
             name="query" 
             placeholder="銘柄名、シンボル、内容で検索..."
             value="{{ request.GET.query }}"
             hx-get="{% url 'stockdiary:search_suggestion' %}"
             hx-trigger="keyup changed delay:500ms"
             hx-target="#searchSuggestions">
      <i class="bi bi-search search-icon"></i>
      
      <!-- 検索サジェスチョン -->
      <div class="search-suggestions" id="searchSuggestions">
        <!-- HTMXによって動的に更新される -->
      </div>
    </div>

    <!-- アクティブフィルターの表示 -->
    <div class="active-filters" id="activeFilters" style="{% if not request.GET.tag and not request.GET.status and not request.GET.sector %}display: none;{% endif %}">
      {% if request.GET.tag %}
        {% for tag in tags %}
          {% if tag.id|stringformat:"i" == request.GET.tag %}
            <div class="filter-chip" data-filter="tag" data-value="{{ tag.id }}">
              <span>{{ tag.name }}</span>
              <button type="button" class="filter-chip-remove" onclick="removeFilter('tag')">
                <i class="bi bi-x"></i>
              </button>
            </div>
          {% endif %}
        {% endfor %}
      {% endif %}
      
      {% if request.GET.status %}
        <div class="filter-chip" data-filter="status" data-value="{{ request.GET.status }}">
          <span>
            {% if request.GET.status == 'active' %}保有中
            {% elif request.GET.status == 'sold' %}売却済み
            {% elif request.GET.status == 'memo' %}メモのみ
            {% endif %}
          </span>
          <button type="button" class="filter-chip-remove" onclick="removeFilter('status')">
            <i class="bi bi-x"></i>
          </button>
        </div>
      {% endif %}
    </div>

    <!-- 詳細検索パネル（折りたたみ式） -->
    <div class="advanced-search-panel collapsed" id="advancedPanel">
      <div class="advanced-fields">
        <div class="form-group">
          <label class="form-label" for="tagFilter">
            <i class="bi bi-tag me-1"></i>
            タグで絞り込み
          </label>
          <select class="form-select" id="tagFilter" name="tag">
            <option value="">すべて表示</option>
            {% for tag in tags %}
              <option value="{{ tag.id }}" {% if request.GET.tag == tag.id|stringformat:"i" %}selected{% endif %}>
                {{ tag.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" for="statusFilter">
            <i class="bi bi-graph-up me-1"></i>
            保有状態
          </label>
          <select class="form-select" id="statusFilter" name="status">
            <option value="" {% if not request.GET.status %}selected{% endif %}>すべて</option>
            <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>保有中</option>
            <option value="sold" {% if request.GET.status == 'sold' %}selected{% endif %}>売却済み</option>
            <option value="memo" {% if request.GET.status == 'memo' %}selected{% endif %}>メモのみ</option>
          </select>
        </div>

      </div>

      <!-- 検索履歴（オプション - セッションまたはローカルストレージベース） -->
      <div class="search-history" id="searchHistory" style="display: none;">
        <div class="history-title">最近の検索</div>
        <div class="history-items" id="historyItems">
          <!-- JavaScriptで動的に生成 -->
        </div>
      </div>
    </div>

    <!-- アクションボタン -->
    <div class="search-actions">
      <button type="submit" class="btn-search">
        <i class="bi bi-search"></i>
        検索
      </button>
      <a href="{% url 'stockdiary:home' %}" class="btn-reset"
         hx-get="{% url 'stockdiary:diary_list' %}" 
         hx-target="#diary-container"
         hx-push-url="true">
        <i class="bi bi-arrow-counterclockwise"></i>
        リセット
      </a>
    </div>

    <!-- インジケーター -->
    <div class="search-indicator" id="search-indicator" style="display: none;">
      <div class="spinner-border spinner-border-sm" role="status">
        <span class="visually-hidden">検索中...</span>
      </div>
      <span>検索中...</span>
    </div>
  </form>
</div>

<!-- 検索結果情報 -->
<div class="search-results-info" id="searchResultsInfo" style="{% if not request.GET.query and not request.GET.tag and not request.GET.status %}display: none;{% endif %}">
  <div>
    <strong id="resultsCount">{{ diaries.paginator.count|default:0 }}件</strong>の日記が見つかりました
    {% if request.GET.query %}
      「<strong>{{ request.GET.query }}</strong>」の検索結果
    {% endif %}
  </div>
  <div>
    <small class="text-muted">
      {% if request.GET.query %}
        検索時間: {{ search_time|default:"--" }}秒
      {% endif %}
    </small>
  </div>
</div>

  <!-- 日記カード一覧 -->
  <h4 class="mb-3 diary-title px-2">
    <i class="bi bi-journal-richtext"></i> 株式日記リスト
  </h4>

  <!-- オフライン通知 -->
  <div class="offline-alert alert alert-warning mb-3">
    <i class="bi bi-wifi-off me-2"></i>
    <span>オフライン状態です。ネットワーク接続を確認してください。</span>
  </div>

  <!-- 日記リストコンテナ - HTMX対応 (PCでの2列表示のためのクラスを追加) -->
  <div id="diary-container" class="home-diary-grid"
       hx-get="{% url 'stockdiary:diary_list' %}"
       hx-trigger="load, pulldown"
       hx-indicator="#diary-loading"
       data-hx-offline-queue="true">
    <div id="diary-loading" class="text-center py-4 htmx-indicator grid-column-span">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">日記を読み込んでいます...</span>
      </div>
      <p class="mt-2">日記を読み込んでいます...</p>
    </div>
  </div>
</div>

{% include 'speed_dial.html' with actions=form_actions %}
{% include "stockdiary/partials/quick_diary_modal.html" %}
{% endblock %}

{% block scripts %}
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/ja.js"></script>
<script src="{% static 'js/quick-diary.js' %}"></script>
<!-- モバイルジェスチャー用のJSを追加 -->
<script src="{% static 'js/mobile-gestures.js' %}"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 詳細検索パネルの切り替え
    document.getElementById('advancedToggle').addEventListener('click', function() {
        const panel = document.getElementById('advancedPanel');
        const isCollapsed = panel.classList.contains('collapsed');
        
        if (isCollapsed) {
            panel.classList.remove('collapsed');
            panel.classList.add('slide-down');
            this.innerHTML = '<i class="bi bi-x"></i>';
        } else {
            panel.classList.add('collapsed');
            this.innerHTML = '<i class="bi bi-sliders"></i>';
        }
    });

    // メイン検索入力のフォーカス処理
    const mainSearchInput = document.getElementById('mainSearchInput');
    const searchSuggestions = document.getElementById('searchSuggestions');
    
    mainSearchInput.addEventListener('focus', function() {
        if (this.value.length > 0) {
            searchSuggestions.style.display = 'block';
        }
    });

    mainSearchInput.addEventListener('input', function() {
        if (this.value.length > 1) {
            searchSuggestions.style.display = 'block';
            // ここで実際のサジェスチョン取得APIを呼び出す
        } else {
            searchSuggestions.style.display = 'none';
        }
    });

    // 外部クリックでサジェスチョンを閉じる
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.main-search-wrapper')) {
            searchSuggestions.style.display = 'none';
        }
    });

    // サジェスチョンアイテムのクリック
    document.querySelectorAll('.suggestion-item').forEach(item => {
        item.addEventListener('click', function() {
            mainSearchInput.value = this.querySelector('.suggestion-text').textContent;
            searchSuggestions.style.display = 'none';
            // 検索を実行
            document.getElementById('searchForm').dispatchEvent(new Event('submit'));
        });
    });

    // フィルターチップの削除
    document.querySelectorAll('.filter-chip-remove').forEach(button => {
        button.addEventListener('click', function() {
            this.parentElement.remove();
            // アクティブフィルターがなくなったら非表示にする
            const activeFilters = document.getElementById('activeFilters');
            if (activeFilters.children.length === 0) {
                activeFilters.style.display = 'none';
            }
        });
    });

    // 検索履歴アイテムのクリック
    document.querySelectorAll('.history-item').forEach(item => {
        item.addEventListener('click', function() {
            mainSearchInput.value = this.textContent;
            document.getElementById('searchForm').dispatchEvent(new Event('submit'));
        });
    });

    // フォーム送信処理
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // 検索インジケーターを表示
        const indicator = document.getElementById('searchIndicator');
        const resultsInfo = document.getElementById('searchResultsInfo');
        
        indicator.style.display = 'flex';
        
        // デモ用の遅延（実際にはHTMXまたはAPIリクエスト）
        setTimeout(() => {
            indicator.style.display = 'none';
            resultsInfo.style.display = 'flex';
        }, 1500);
    });

    // レスポンシブ対応
    function handleResize() {
        const isMobile = window.innerWidth < 768;
        const advancedFields = document.querySelector('.advanced-fields');
        
        if (isMobile) {
            advancedFields.style.display = 'block';
        } else {
            advancedFields.style.display = 'grid';
        }
    }

    window.addEventListener('resize', handleResize);
    handleResize(); // 初期実行
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // 基本的な初期化
  if (typeof initializeSpeedDial === 'function') {
    initializeSpeedDial();
  }
  
  // オフライン状態の監視
  window.addEventListener('online', function() {
    document.body.classList.remove('is-offline');
  });
  
  window.addEventListener('offline', function() {
    document.body.classList.add('is-offline');
  });
  
  // 初期状態のチェック
  if (!navigator.onLine) {
    document.body.classList.add('is-offline');
  }
  
  // ★ 修正: カレンダー日付クリック処理の統合 ★
  function setupCalendarClicks() {
    // 既存のクリックハンドラーを削除
    document.querySelectorAll('.calendar-cell').forEach(cell => {
      cell.removeEventListener('click', handleCalendarClick);
    });
    
    // 新しいクリックハンドラーを追加
    document.querySelectorAll('.calendar-cell').forEach(cell => {
      cell.addEventListener('click', handleCalendarClick);
    });
  }
  
  function handleCalendarClick(e) {
    const cell = e.currentTarget;
    const dateStr = cell.getAttribute('data-date');
    const view = cell.getAttribute('data-view');
    
    if (!dateStr || !view) return;
    
    // すべてのセルからクリック状態を削除
    document.querySelectorAll('.calendar-cell').forEach(c => {
      c.classList.remove('fc-day-clicked');
    });
    
    // クリックされたセルをハイライト
    cell.classList.add('fc-day-clicked');
    
    // 日付表示を更新
    updateSelectedDateDisplay(dateStr, view);
    
    // イベントを取得・表示
    loadDayEvents(dateStr, view);
    
    // モバイルの場合はイベントカードを表示してスクロール
    if (view === 'mobile') {
      const eventsCard = document.getElementById('mobile-events-card');
      if (eventsCard) {
        eventsCard.style.display = 'block';
        setTimeout(() => {
          eventsCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }
    }
  }
  
  function updateSelectedDateDisplay(dateStr, view) {
    try {
      const dateObj = new Date(dateStr);
      const formattedDate = dateObj.getFullYear() + '年' + 
                           (dateObj.getMonth() + 1) + '月' + 
                           dateObj.getDate() + '日のイベント';
      
      const targetId = view === 'mobile' ? 'mobile-selected-date' : 'desktop-selected-date';
      const dateElement = document.getElementById(targetId);
      
      if (dateElement) {
        dateElement.textContent = formattedDate;
      }
    } catch (e) {
      console.warn('日付の解析に失敗しました:', dateStr);
    }
  }
   
  // HTMX エラーハンドリング
  document.body.addEventListener('htmx:responseError', function(event) {
    console.error('HTMX エラー:', event.detail.xhr.status, event.detail.xhr.statusText);
    
    const target = event.detail.target;
    
    if (target.id === 'desktop-day-events' || target.id === 'mobile-day-events') {
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-exclamation-triangle me-2"></i>
          イベントの読み込みに失敗しました。ネットワーク接続を確認してください。
        </div>
      `;
    } else if (target.id === 'desktop-calendar-container' || target.id === 'mobile-calendar-container') {
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-exclamation-triangle me-2"></i>
          カレンダーの読み込みに失敗しました。ネットワーク接続を確認してください。
        </div>
      `;
    }
  });
  
  // カレンダー読み込み完了時の処理
  document.body.addEventListener('htmx:afterSwap', function(event) {
    const targetId = event.detail.target.id;
    
    if (targetId === 'desktop-calendar-container' || targetId === 'mobile-calendar-container') {
      // カレンダーが更新されたらクリックハンドラーを再設定
      setTimeout(setupCalendarClicks, 100);
    }
    
    if (targetId === 'desktop-day-events' || targetId === 'mobile-day-events') {
      // イベントリストのアニメーション
      const items = event.detail.target.querySelectorAll('.calendar-event-item');
      items.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(10px)';
        item.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        
        setTimeout(() => {
          item.style.opacity = '1';
          item.style.transform = 'translateY(0)';
        }, 50 * index);
      });
    }
  });
  
  // HTMXリクエストにCSRFトークンを追加
  document.body.addEventListener('htmx:configRequest', function(evt) {
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    if (!evt.detail.headers) {
      evt.detail.headers = {};
    }
    evt.detail.headers['X-CSRFToken'] = csrfToken;
  });
  
  // 初期セットアップ
  setTimeout(setupCalendarClicks, 1000);
});

// HTMX設定
htmx.config.defaultSwapStyle = "innerHTML";
htmx.config.includeIndicatorStyles = true;
htmx.config.withCredentials = true;

// オフライン状態検出
htmx.on('htmx:beforeRequest', function(evt) {
  if (!navigator.onLine) {
    evt.preventDefault();
    document.body.classList.add('is-offline');
    
    const target = evt.detail.target;
    if (target) {
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-wifi-off me-2"></i>
          現在オフライン状態です。ネットワーク接続を確認してください。
        </div>
      `;
    }
  }
});

// HTMX設定
htmx.config.defaultSwapStyle = "innerHTML";
htmx.config.includeIndicatorStyles = true;
htmx.config.withCredentials = true;

// エラー処理を強化
htmx.on('htmx:beforeRequest', function(evt) {
  // インジケーター要素を取得
  const indicatorSelector = evt.detail.elt.getAttribute('hx-indicator');
  if (indicatorSelector) {
    const indicator = document.querySelector(indicatorSelector);
    if (!indicator) {
      console.warn('Indicator not found:', indicatorSelector);
      // インジケーターが存在しない場合は属性を削除
      evt.detail.elt.removeAttribute('hx-indicator');
    }
  }
});

// オフライン状態検出
htmx.on('htmx:beforeRequest', function(evt) {
  if (!navigator.onLine) {
    evt.preventDefault();
    document.body.classList.add('is-offline');
    
    // オフライン通知を表示
    const target = evt.detail.target;
    if (target) {
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-wifi-off me-2"></i>
          現在オフライン状態です。ネットワーク接続を確認してください。
        </div>
      `;
    }
  }
});
</script>
{% endblock %}