{% extends 'base.html' %}
{% load stockdiary_filters %}
{% load static %}
{% load humanize %}
{% load ads_tags %}
{% block title %}æ ªå¼æ—¥è¨˜ | ã‚«ãƒ–ãƒ­ã‚°{% endblock %}

{% block head %}
<!-- å…±é€šã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ -->
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/quick-diary.css' %}">
<!-- ãƒ¢ãƒã‚¤ãƒ«ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆè¿½åŠ  -->

<!-- ãƒ¢ãƒã‚¤ãƒ«ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ -->
<link rel="stylesheet" href="{% static 'css/mobile-gestures.css' %}">
<link rel="stylesheet" href="{% static 'css/search-suggestions.css' %}">

<style>
/* æ—¢å­˜ã®å¤‰æ•°ã‚’ä½¿ç”¨ */

body {
    background-color: var(--bg-color);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* ========== æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ æœ€é©åŒ– ========== */
.mobile-search-container {
    background-color: var(--card-bg-color);
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
}

.search-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
}

.search-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.search-toggle {
    background: none;
    border: none;
    color: var(--primary-color);
    font-size: 1.2rem;
    padding: 0.25rem;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.search-toggle:hover {
    background-color: rgba(90, 126, 197, 0.1);
}

/* ãƒ¡ã‚¤ãƒ³æ¤œç´¢ãƒãƒ¼ */
.main-search-wrapper {
    position: relative;
    margin-bottom: var(--spacing-md);
}

.main-search-input {
    width: 100%;
    min-height: var(--button-height-md);
    padding: 0.75rem 3rem 0.75rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: var(--border-radius);
    font-size: 16px; /* iOSã§ã‚ºãƒ¼ãƒ ã‚’é˜²ã */
    transition: all 0.2s ease;
    background-color: white;
}

.main-search-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(90, 126, 197, 0.1);
}

.main-search-input::placeholder {
    color: #9ca3af;
    font-size: 0.95rem;
}

.search-icon {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    font-size: 1.2rem;
    pointer-events: none;
}

/* ã‚¢ãƒ‰ãƒãƒ³ã‚¹æ¤œç´¢ãƒ‘ãƒãƒ«ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¼ï¼‰ */
.advanced-search-panel {
    border-top: 1px solid #e5e7eb;
    padding-top: var(--spacing-md);
    margin-top: var(--spacing-md);
}

.advanced-search-panel.collapsed {
    display: none;
}

.form-group {
    margin-bottom: var(--spacing-lg);
}

.form-label {
    font-weight: 500;
    color: var(--text-color);
    margin-bottom: var(--spacing-sm);
    font-size: 0.9rem;
}

.form-control, .form-select {
    min-height: var(--button-height-md);
    border: 1px solid #d1d5db;
    border-radius: var(--border-radius);
    font-size: 16px;
    padding: 0.75rem 1rem;
    transition: all 0.2s ease;
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(90, 126, 197, 0.1);
    outline: none;
}

/* æ¤œç´¢ã‚µã‚¸ã‚§ã‚¹ãƒãƒ§ãƒ³ */
.search-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e5e7eb;
    border-top: none;
    border-radius: 0 0 var(--border-radius) var(--border-radius);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
}

.suggestion-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f3f4f6;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.suggestion-item:hover {
    background-color: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-icon {
    color: var(--primary-color);
    font-size: 1rem;
}

.suggestion-text {
    flex: 1;
}

.suggestion-type {
    font-size: 0.8rem;
    color: var(--text-light);
    background-color: #f3f4f6;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
}

/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
.search-actions {
    display: flex;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-lg);
}

/* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®è¡¨ç¤º */
.active-filters {
    margin-bottom: var(--spacing-md);
}

.filter-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background-color: var(--primary-color);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

.filter-chip-remove {
    background: none;
    border: none;
    color: white;
    font-size: 0.9rem;
    padding: 0;
    cursor: pointer;
}

/* ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
.search-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--primary-color);
    font-size: 0.9rem;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
@media (min-width: 768px) {
    .mobile-search-container {
        padding: 2rem;
    }
    
    .search-actions {
        justify-content: flex-end;
    }
    
    /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .advanced-fields {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-lg);
    }
    
    .form-group.full-width {
        grid-column: 1 / -1;
    }
}

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.slide-down {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* æ¤œç´¢å±¥æ­´ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ */
.search-history {
    margin-top: var(--spacing-md);
    padding-top: var(--spacing-md);
    border-top: 1px solid #f3f4f6;
}

.history-title {
    font-size: 0.85rem;
    color: var(--text-light);
    margin-bottom: var(--spacing-sm);
}

.history-items {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.history-item {
    background-color: #f8f9fa;
    border: 1px solid #e5e7eb;
    padding: 0.4rem 0.8rem;
    border-radius: 16px;
    font-size: 0.85rem;
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.2s ease;
}

.history-item:hover {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

/* æ¤œç´¢çµæœã‚«ã‚¦ãƒ³ãƒˆ */
.search-results-info {
    background-color: #f8f9fa;
    border: 1px solid #e5e7eb;
    border-radius: var(--border-radius);
    padding: 0.75rem 1rem;
    margin-bottom: var(--spacing-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.9rem;
    color: var(--text-color);
}

/* æ—¥è¨˜ã‚«ãƒ¼ãƒ‰ã‚¿ãƒ–ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.diary-card-tabs {
  margin-top: 1rem;
}

.card-tabs .nav-link {
  padding: 0.4rem 0.75rem;
  font-size: 0.85rem;
  color: var(--text-light);
  border: none;
  border-radius: 0;
  position: relative;
}

.card-tabs .nav-link::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 100%;
  height: 2px;
  background-color: transparent;
  transition: background-color 0.2s;
}

.card-tabs .nav-link.active {
  color: var(--primary-color);
  font-weight: 500;
  background-color: transparent;
}

.card-tabs .nav-link.active::after {
  background-color: var(--primary-color);
}

.card-tabs .nav-link:hover:not(.active) {
  color: var(--primary-color);
  background-color: rgba(79, 70, 229, 0.05);
}

.card-tabs .nav-link i {
  margin-right: 0.3rem;
}

/* æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
.search-highlight {
  background-color: #ffc107;
  color: #000;
  padding: 0 2px;
  border-radius: 2px;
  font-weight: bold;
}

/* æ—¥è¨˜ã‚«ãƒ¼ãƒ‰ã®å¼·èª¿ */
.diary-card-highlight {
  border-left: 3px solid #ffc107 !important;
}

/* ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ”¹å–„ */
.htmx-indicator {
  opacity: 0;
  transition: opacity 200ms ease-in;
  display: none;
}

.htmx-request .htmx-indicator {
  opacity: 1;
  display: flex !important;
  justify-content: center;
  align-items: center;
}

/* ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
#loading-indicator {
  padding: 1rem;
  margin: 1rem 0;
  text-align: center;
}

#loading-indicator .spinner-border {
  width: 2rem;
  height: 2rem;
}

/* ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ç”¨ */
.offline-alert {
  display: none;
}
.is-offline .offline-alert {
  display: block;
}

/* PCã§ã®2åˆ—è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ  */
.home-diary-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
}

/* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸Šã®ã‚µã‚¤ã‚ºã§ã¯2åˆ—è¡¨ç¤ºã« */
@media (min-width: 992px) {
  .home-diary-grid {
    grid-template-columns: 1fr 1fr;
  }
}

/* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã®è¡¨ç¤ºèª¿æ•´ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.grid-column-span {
  grid-column: 1 / -1; /* ã™ã¹ã¦ã®åˆ—ã«ã¾ãŸãŒã‚‹ */
}

/* ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒãƒƒã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.offline-badge {
  display: none;
}

/* ========== 1. æ—¥è¨˜ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ã®èª¿æ•´ ========== */
.home-diary-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1.5rem;
  width: 100%;
  max-width: 100%;
}

/* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸Šã§ã®2åˆ—è¡¨ç¤ºã‚’æ”¹å–„ */
@media (min-width: 992px) {
  .home-diary-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 1.75rem;
  }
}

/* è¶…å¤§ç”»é¢ã§ã¯æœ€å¤§å¹…ã‚’åˆ¶é™ */
@media (min-width: 1400px) {
  .home-diary-grid {
    max-width: 1300px;
    margin: 0 auto;
    gap: 2rem;
  }
}

/* ========== 2. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å¹…èª¿æ•´ ========== */
.calendar-view {
  width: 100%;
  max-width: 100%;
  overflow: hidden; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
}

.calendar-container {
  width: 100%;
  min-height: 350px;
}

/* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨ã‚¤ãƒ™ãƒ³ãƒˆã®å¹…æ¯”ç‡èª¿æ•´ */
@media (min-width: 992px) {
  .calendar-view .col-lg-7 {
    padding-right: 1rem;
  }
  
  .calendar-view .col-lg-5 {
    padding-left: 1rem;
  }
}

/* ========== 3. æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã®èª¿æ•´ ========== */
.diary-search .row.g-2 > .col-md-4 {
  margin-bottom: 0.75rem;
}

@media (max-width: 767.98px) {
  .diary-search .row.g-2 > .col-md-4 {
    width: 100%;
    margin-bottom: 1rem;
  }
}

/* ========== 4. æ—¥è¨˜ã‚«ãƒ¼ãƒ‰ã®å†…éƒ¨èª¿æ•´ ========== */
.diary-card {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
}

.diary-card-header {
  padding: 1.25rem 1.5rem 1rem;
  min-height: auto;
}

.diary-card-body {
  padding: 0.75rem 1.25rem 1.25rem;
}

/* ã‚¿ãƒ–ã®å¹…èª¿æ•´ */
.card-tabs {
  margin: 0.75rem -0.25rem 0.75rem;
  overflow-x: auto;
  overflow-y: hidden;
  scrollbar-width: none;
  -ms-overflow-style: none;
}

.card-tabs::-webkit-scrollbar {
  display: none;
}

.card-tabs .nav-link {
  white-space: nowrap;
  flex-shrink: 0;
  min-width: 90px;
  padding: 0.75rem 1rem;
  font-size: 0.9rem;
}

/* ========== 5. æƒ…å ±ãƒ–ãƒ­ãƒƒã‚¯ã®å¹…èª¿æ•´ ========== */
.info-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 1rem;
  width: 100%;
}

@media (max-width: 576px) {
  .info-row {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
}

.info-item {
  min-width: 0; /* ã‚°ãƒªãƒƒãƒ‰ã‚¢ã‚¤ãƒ†ãƒ ã®å¹…åˆ¶é™ã‚’è§£é™¤ */
  margin-bottom: 0;
}

/* ========== 6. ãƒœã‚¿ãƒ³é…ç½®ã®èª¿æ•´ ========== */
.action-buttons {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  justify-content: flex-start;
}

@media (max-width: 576px) {
  .action-buttons {
    flex-direction: column;
    width: 100%;
  }
  
  .action-buttons .btn {
    width: 100%;
    margin-bottom: 0.5rem;
  }
}

/* ========== 7. ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ã®èª¿æ•´ ========== */
.diary-title {
  word-break: break-word;
  overflow-wrap: break-word;
  line-height: 1.4;
  margin-bottom: 0.5rem;
}

.diary-meta {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex-wrap: wrap;
}

/* ========== 8. ä¾¡æ ¼æƒ…å ±è¡¨ç¤ºã®èª¿æ•´ ========== */
.diary-price-info {
  text-align: right;
  min-width: 90px;
  max-width: 120px;
}

@media (max-width: 576px) {
  .diary-card-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .diary-price-info {
    text-align: left;
    margin-top: 0.75rem;
    min-width: auto;
    max-width: none;
    width: 100%;
  }
}

/* ========== 9. ã‚¿ã‚°è¡¨ç¤ºã®èª¿æ•´ ========== */
.diary-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin: 0.75rem 0 0.5rem;
  max-width: 100%;
}

.diary-tag {
  flex-shrink: 0;
  word-break: keep-all;
  white-space: nowrap;
}

/* ========== 10. ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¹…èª¿æ•´ ========== */
@media (max-width: 767.98px) {
  .modal-dialog {
    margin: 0.5rem;
    max-width: calc(100vw - 1rem);
    width: calc(100vw - 1rem);
  }
  
  .modal-content {
    border-radius: 0.75rem;
  }
}

/* ========== 11. ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®èª¿æ•´ ========== */
.form-control, .form-select {
  width: 100%;
  box-sizing: border-box;
}

.input-group {
  width: 100%;
}

.input-group .form-control {
  flex: 1;
  min-width: 0;
}

/* ========== 12. ãƒ†ãƒ¼ãƒ–ãƒ«ã®èª¿æ•´ ========== */
.table-responsive {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

@media (max-width: 767.98px) {
  .table-responsive {
    margin-left: -0.5rem;
    margin-right: -0.5rem;
    padding: 0 0.5rem;
  }
}

/* ========== 13. ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®èª¿æ•´ ========== */
.accordion-item {
  border-left: none;
  border-right: none;
}

.accordion-button {
  padding: 1rem 1.25rem;
}

.accordion-body {
  padding: 0;
}

/* ========== 14. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã®èª¿æ•´ ========== */
.fc-scrollgrid-sync-table {
  width: 100%;
  table-layout: fixed;
}

.fc-scrollgrid-sync-table td,
.fc-scrollgrid-sync-table th {
  width: calc(100% / 7);
  text-align: center;
  vertical-align: middle;
}

/* ========== 15. ã‚³ãƒ³ãƒ†ãƒŠã®æœ€å¤§å¹…èª¿æ•´ ========== */
@media (min-width: 1200px) {
  .container {
    max-width: 1140px;
  }
}

@media (min-width: 1400px) {
  .container {
    max-width: 1200px; /* è¶…å¤§ç”»é¢ã§ã‚‚é©åº¦ãªå¹…ã«åˆ¶é™ */
  }
}

/* ========== 16. ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ€ã‚¤ã‚¢ãƒ«ãƒœã‚¿ãƒ³ã®ä½ç½®èª¿æ•´ ========== */
.speed-dial-container {
  position: fixed;
  bottom: 1.5rem;
  right: 1.5rem;
  z-index: 1040;
}

@media (max-width: 768px) {
  .speed-dial-container {
    bottom: 1rem;
    right: 1rem;
  }
}

/* ========== 17. åºƒå‘Šã‚³ãƒ³ãƒ†ãƒŠã®èª¿æ•´ ========== */
.ad-container {
  width: 100%;
  max-width: 100%;
  margin: 1.5rem auto;
  text-align: center;
  overflow: hidden;
}

@media (max-width: 767.98px) {
  .ad-container {
    margin: 1rem auto;
    padding: 0 0.5rem;
  }
}

/* ========== 18. ã‚°ãƒªãƒƒãƒ‰ã‚¢ã‚¤ãƒ†ãƒ ã®èª¿æ•´ ========== */
.grid-column-span {
  grid-column: 1 / -1;
  width: 100%;
  max-width: 100%;
}

/* ========== 19. ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³èª¿æ•´ ========== */
.floating-nav-button {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 1041;
}

/* ========== 20. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ç”»åƒ ========== */
img {
  max-width: 100%;
  height: auto;
}

/* ========== 21. ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ä¿®æ­£ ========== */
.card, .modal-content, .alert, .form-control, .btn {
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* ========== 22. ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã‚¢ã‚¤ãƒ†ãƒ ã®èª¿æ•´ ========== */
.d-flex {
  min-width: 0; /* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã‚¢ã‚¤ãƒ†ãƒ ã®ç¸®å°ã‚’è¨±å¯ */
}

.flex-shrink-0 {
  flex-shrink: 0;
}

.flex-grow-1 {
  flex-grow: 1;
  min-width: 0;
}

/* ========== 23. å°ã•ãªãƒ‡ãƒã‚¤ã‚¹ç”¨ã®è¿½åŠ èª¿æ•´ ========== */
@media (max-width: 360px) {
  .container {
    padding-left: 0.75rem;
    padding-right: 0.75rem;
  }
  
  .diary-card-header,
  .diary-card-body {
    padding-left: 1rem;
    padding-right: 1rem;
  }
  
  .card-tabs .nav-link {
    padding: 0.6rem 0.5rem;
    font-size: 0.8rem;
    min-width: 70px;
  }
  
  .diary-title {
    font-size: 0.95rem;
  }
  
  .diary-meta {
    font-size: 0.75rem;
  }
}
</style>
{% endblock %}

{% block content %}
<!-- CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿½åŠ  -->
{% csrf_token %}

<!-- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ãƒãƒƒã‚¸ -->
<div class="offline-badge">
  <i class="bi bi-wifi-off me-1"></i> ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ã™
</div>

<!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä¸Šéƒ¨ã®åºƒå‘Š -->
{% if show_ads %}
    {% show_template_ad "diary_top" %}
{% endif %}
<div class="container py-4">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h1 class="diary-title mb-2 mb-md-0">æ ªå¼æ—¥è¨˜</h1>
    <a href="{% url 'stockdiary:create' %}" class="btn btn-primary">
      <i class="bi bi-plus-lg me-1"></i> æ–°è¦ä½œæˆ
    </a>
  </div>
<div class="mobile-search-container mb-4">
  <!-- æ¤œç´¢ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="search-header">
    <div class="search-title">
      <i class="bi bi-search"></i>
      æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    </div>
    <button type="button" class="search-toggle" id="advancedToggle">
      <i class="bi bi-sliders"></i>
    </button>
  </div>

  <form hx-get="{% url 'stockdiary:diary_list' %}" 
        hx-target="#diary-container"
        hx-indicator="#search-indicator"
        hx-push-url="true"
        id="optimizedSearchForm">
    
    {% csrf_token %}
    
    <!-- ãƒ¡ã‚¤ãƒ³æ¤œç´¢ãƒãƒ¼ -->
    <div class="main-search-wrapper">
      <input type="text" 
             class="main-search-input validate-inline" 
             id="mainSearchInput"
             name="query" 
             placeholder="éŠ˜æŸ„åã€ã‚·ãƒ³ãƒœãƒ«ã€å†…å®¹ã§æ¤œç´¢..."
             value="{{ request.GET.query }}"
             hx-get="{% url 'stockdiary:search_suggestion' %}"
             hx-trigger="keyup changed delay:500ms"
             hx-target="#searchSuggestions">
      <i class="bi bi-search search-icon"></i>
      
      <!-- æ¤œç´¢ã‚µã‚¸ã‚§ã‚¹ãƒãƒ§ãƒ³ -->
      <div class="search-suggestions" id="searchSuggestions">
        <!-- HTMXã«ã‚ˆã£ã¦å‹•çš„ã«æ›´æ–°ã•ã‚Œã‚‹ -->
      </div>
    </div>

 
    <!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®è¡¨ç¤º -->
    <div class="active-filters" id="activeFilters">
      
      <!-- ğŸ”§ ä¿æœ‰çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå¸¸ã«è¡¨ç¤ºã€statusãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯activeã¨ã—ã¦æ‰±ã†ï¼‰ -->
      {% with status_value=request.GET.status|default:"active" %}
        <div class="filter-chip" data-filter="status" data-value="{{ status_value }}">
          <span>
            {% if status_value == 'active' %}ä¿æœ‰ä¸­ã®ã¿
            {% elif status_value == 'all' %}ã™ã¹ã¦è¡¨ç¤º
            {% elif status_value == 'sold' %}å£²å´æ¸ˆã¿
            {% elif status_value == 'memo' %}ãƒ¡ãƒ¢ã®ã¿
            {% endif %}
          </span>
          <button type="button" class="filter-chip-remove" onclick="removeFilter('status')">
            <i class="bi bi-x"></i>
          </button>
        </div>
      {% endwith %}
      
      <!-- ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      {% if request.GET.tag %}
        {% for tag in tags %}
          {% if tag.id|stringformat:"i" == request.GET.tag %}
            <div class="filter-chip" data-filter="tag" data-value="{{ tag.id }}">
              <span>ã‚¿ã‚°: {{ tag.name }}</span>
              <button type="button" class="filter-chip-remove" onclick="removeFilter('tag')">
                <i class="bi bi-x"></i>
              </button>
            </div>
          {% endif %}
        {% endfor %}
      {% endif %}
      
      <!-- æ¥­ç¨®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      {% if request.GET.sector %}
        <div class="filter-chip" data-filter="sector" data-value="{{ request.GET.sector }}">
          <span>æ¥­ç¨®: {{ request.GET.sector }}</span>
          <button type="button" class="filter-chip-remove" onclick="removeFilter('sector')">
            <i class="bi bi-x"></i>
          </button>
        </div>
      {% endif %}
      
      <!-- ğŸ†• å–å¼•ç™»éŒ²æ—¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      {% if request.GET.transaction_date_range %}
        <div class="filter-chip" data-filter="transaction_date_range" data-value="{{ request.GET.transaction_date_range }}">
          <span>å–å¼•ç™»éŒ²: 
            {% if request.GET.transaction_date_range == '1w' %}éå»1é€±é–“
            {% elif request.GET.transaction_date_range == '1m' %}éå»1ãƒ¶æœˆ
            {% elif request.GET.transaction_date_range == '3m' %}éå»3ãƒ¶æœˆ
            {% elif request.GET.transaction_date_range == '6m' %}éå»6ãƒ¶æœˆ
            {% elif request.GET.transaction_date_range == '1y' %}éå»1å¹´
            {% endif %}
          </span>
          <button type="button" class="filter-chip-remove" onclick="removeFilter('transaction_date_range')">
            <i class="bi bi-x"></i>
          </button>
        </div>
      {% endif %}
      
      <!-- è³¼å…¥æ—¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      {% if request.GET.date_range %}
        <div class="filter-chip" data-filter="date_range" data-value="{{ request.GET.date_range }}">
          <span>è³¼å…¥æ—¥: 
            {% if request.GET.date_range == '1w' %}éå»1é€±é–“
            {% elif request.GET.date_range == '1m' %}éå»1ãƒ¶æœˆ
            {% elif request.GET.date_range == '3m' %}éå»3ãƒ¶æœˆ
            {% elif request.GET.date_range == '6m' %}éå»6ãƒ¶æœˆ
            {% elif request.GET.date_range == '1y' %}éå»1å¹´
            {% endif %}
          </span>
          <button type="button" class="filter-chip-remove" onclick="removeFilter('date_range')">
            <i class="bi bi-x"></i>
          </button>
        </div>
      {% endif %}
      
      <!-- ğŸ†• ã‚½ãƒ¼ãƒˆé †ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      {% if request.GET.sort %}
        <div class="filter-chip" data-filter="sort" data-value="{{ request.GET.sort }}">
          <span>ä¸¦ã³é †: 
            {% if request.GET.sort == 'date_desc' %}å–å¼•æ—¥ï¼ˆæ–°ï¼‰
            {% elif request.GET.sort == 'date_asc' %}å–å¼•æ—¥ï¼ˆå¤ï¼‰
            {% elif request.GET.sort == 'name' %}éŠ˜æŸ„åé †
            {% elif request.GET.sort == 'symbol' %}ã‚³ãƒ¼ãƒ‰é †
            {% elif request.GET.sort == 'profit_desc' %}æç›Šï¼ˆé«˜ï¼‰
            {% elif request.GET.sort == 'profit_asc' %}æç›Šï¼ˆä½ï¼‰
            {% elif request.GET.sort == 'transaction_count_desc' %}å–å¼•å›æ•°ï¼ˆå¤šï¼‰
            {% elif request.GET.sort == 'transaction_count_asc' %}å–å¼•å›æ•°ï¼ˆå°‘ï¼‰
            {% elif request.GET.sort == 'total_cost_desc' %}ç·åŸä¾¡ï¼ˆé«˜ï¼‰
            {% elif request.GET.sort == 'total_cost_asc' %}ç·åŸä¾¡ï¼ˆä½ï¼‰
            {% endif %}
          </span>
          <button type="button" class="filter-chip-remove" onclick="removeFilter('sort')">
            <i class="bi bi-x"></i>
          </button>
        </div>
      {% endif %}
    </div>

    <!-- è©³ç´°æ¤œç´¢ãƒ‘ãƒãƒ«ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¼ï¼‰ -->
    <div class="advanced-search-panel collapsed" id="advancedPanel">
      <div class="advanced-fields">
        
        <!-- ğŸ†• ä¿æœ‰çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¿½åŠ ï¼‰ -->
        <div class="form-group">
          <label class="form-label" for="statusFilter">
            <i class="bi bi-circle-fill me-1"></i>
            ä¿æœ‰çŠ¶æ…‹
          </label>
          <select class="form-select" id="statusFilter" name="status">
            {% with status_value=request.GET.status|default:"active" %}
              <option value="active" {% if status_value == 'active' %}selected{% endif %}>ä¿æœ‰ä¸­ã®ã¿</option>
              <option value="all" {% if status_value == 'all' %}selected{% endif %}>ã™ã¹ã¦è¡¨ç¤º</option>
              <option value="sold" {% if status_value == 'sold' %}selected{% endif %}>å£²å´æ¸ˆã¿</option>
              <option value="memo" {% if status_value == 'memo' %}selected{% endif %}>ãƒ¡ãƒ¢ã®ã¿</option>
            {% endwith %}
          </select>
        </div>

        <!-- ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="form-group">
          <label class="form-label" for="tagFilter">
            <i class="bi bi-tag me-1"></i>
            ã‚¿ã‚°ã§çµã‚Šè¾¼ã¿
          </label>
          <select class="form-select" id="tagFilter" name="tag">
            <option value="">ã™ã¹ã¦è¡¨ç¤º</option>
            {% for tag in tags %}
              <option value="{{ tag.id }}" {% if request.GET.tag == tag.id|stringformat:"i" %}selected{% endif %}>
                {{ tag.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- æ¥­ç¨®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="form-group">
          <label class="form-label" for="sectorFilter">
            <i class="bi bi-diagram-3 me-1"></i>
            æ¥­ç¨®ã§çµã‚Šè¾¼ã¿
          </label>
          <select class="form-select" id="sectorFilter" name="sector">
            <option value="">ã™ã¹ã¦è¡¨ç¤º</option>
            {% for sector in sectors %}
              <option value="{{ sector }}" {% if request.GET.sector == sector %}selected{% endif %}>
                {{ sector }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- ğŸ†• ã‚½ãƒ¼ãƒˆé †ï¼ˆå–å¼•å›æ•°ãƒ»ç·å–å¾—åŸä¾¡ã‚’è¿½åŠ ï¼‰ -->
        <div class="form-group">
          <label class="form-label" for="sortFilter">
            <i class="bi bi-sort-down me-1"></i>
            ä¸¦ã³é †
          </label>
          <select class="form-select" id="sortFilter" name="sort">
            <option value="" {% if not request.GET.sort %}selected{% endif %}>æ›´æ–°æ—¥æ™‚ï¼ˆæ–°ã—ã„é †ï¼‰</option>
            <option value="date_desc" {% if request.GET.sort == 'date_desc' %}selected{% endif %}>å–å¼•æ—¥ï¼ˆæ–°ã—ã„é †ï¼‰</option>
            <option value="date_asc" {% if request.GET.sort == 'date_asc' %}selected{% endif %}>å–å¼•æ—¥ï¼ˆå¤ã„é †ï¼‰</option>
            <option value="name" {% if request.GET.sort == 'name' %}selected{% endif %}>éŠ˜æŸ„åï¼ˆã‚ã„ã†ãˆãŠé †ï¼‰</option>
            <option value="symbol" {% if request.GET.sort == 'symbol' %}selected{% endif %}>è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰é †</option>
            <option value="profit_desc" {% if request.GET.sort == 'profit_desc' %}selected{% endif %}>å®Ÿç¾æç›Šï¼ˆé«˜ã„é †ï¼‰</option>
            <option value="profit_asc" {% if request.GET.sort == 'profit_asc' %}selected{% endif %}>å®Ÿç¾æç›Šï¼ˆä½ã„é †ï¼‰</option>
            <!-- ğŸ†• å–å¼•å›æ•°é † -->
            <option value="transaction_count_desc" {% if request.GET.sort == 'transaction_count_desc' %}selected{% endif %}>å–å¼•å›æ•°ï¼ˆå¤šã„é †ï¼‰</option>
            <option value="transaction_count_asc" {% if request.GET.sort == 'transaction_count_asc' %}selected{% endif %}>å–å¼•å›æ•°ï¼ˆå°‘ãªã„é †ï¼‰</option>
            <!-- ğŸ†• ç·å–å¾—åŸä¾¡é † -->
            <option value="total_cost_desc" {% if request.GET.sort == 'total_cost_desc' %}selected{% endif %}>ç·å–å¾—åŸä¾¡ï¼ˆé«˜ã„é †ï¼‰</option>
            <option value="total_cost_asc" {% if request.GET.sort == 'total_cost_asc' %}selected{% endif %}>ç·å–å¾—åŸä¾¡ï¼ˆä½ã„é †ï¼‰</option>
          </select>
        </div>

        <!-- ğŸ†• ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="form-group">
          <label class="form-label" for="transactionDateRangeFilter">
            <i class="bi bi-clock-history me-1"></i>
            å–å¼•ç™»éŒ²æ—¥ã§çµã‚Šè¾¼ã¿
          </label>
          <select class="form-select" id="transactionDateRangeFilter" name="transaction_date_range">
            <option value="" {% if not request.GET.transaction_date_range %}selected{% endif %}>ã™ã¹ã¦ã®æœŸé–“</option>
            <option value="1w" {% if request.GET.transaction_date_range == '1w' %}selected{% endif %}>éå»1é€±é–“</option>
            <option value="1m" {% if request.GET.transaction_date_range == '1m' %}selected{% endif %}>éå»1ãƒ¶æœˆ</option>
            <option value="3m" {% if request.GET.transaction_date_range == '3m' %}selected{% endif %}>éå»3ãƒ¶æœˆ</option>
            <option value="6m" {% if request.GET.transaction_date_range == '6m' %}selected{% endif %}>éå»6ãƒ¶æœˆ</option>
            <option value="1y" {% if request.GET.transaction_date_range == '1y' %}selected{% endif %}>éå»1å¹´</option>
          </select>
        </div>

        <!-- æ—¥ä»˜ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè³¼å…¥æ—¥åŸºæº–ï¼‰ -->
        <div class="form-group">
          <label class="form-label" for="dateRangeFilter">
            <i class="bi bi-calendar-range me-1"></i>
            è³¼å…¥æ—¥ã§çµã‚Šè¾¼ã¿
          </label>
          <select class="form-select" id="dateRangeFilter" name="date_range">
            <option value="" {% if not request.GET.date_range %}selected{% endif %}>ã™ã¹ã¦ã®æœŸé–“</option>
            <option value="1w" {% if request.GET.date_range == '1w' %}selected{% endif %}>éå»1é€±é–“</option>
            <option value="1m" {% if request.GET.date_range == '1m' %}selected{% endif %}>éå»1ãƒ¶æœˆ</option>
            <option value="3m" {% if request.GET.date_range == '3m' %}selected{% endif %}>éå»3ãƒ¶æœˆ</option>
            <option value="6m" {% if request.GET.date_range == '6m' %}selected{% endif %}>éå»6ãƒ¶æœˆ</option>
            <option value="1y" {% if request.GET.date_range == '1y' %}selected{% endif %}>éå»1å¹´</option>
          </select>
        </div>
      </div>

      <!-- æ¤œç´¢å±¥æ­´ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ™ãƒ¼ã‚¹ï¼‰ -->
      <div class="search-history" id="searchHistory" style="display: none;">
        <div class="history-title">æœ€è¿‘ã®æ¤œç´¢</div>
        <div class="history-items" id="historyItems">
          <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="search-actions">
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-search"></i>
        æ¤œç´¢
      </button>
      <!-- ğŸ”§ ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ï¼ˆä¿æœ‰ä¸­ã®ã¿ï¼‰ã«æˆ»ã™ -->
      <a href="{% url 'stockdiary:home' %}?status=active" class="btn btn-outline-primary"
         hx-get="{% url 'stockdiary:diary_list' %}?status=active" 
         hx-target="#diary-container"
         hx-push-url="true">
        <i class="bi bi-arrow-counterclockwise"></i>
        ãƒªã‚»ãƒƒãƒˆ
      </a>
    </div>

    <!-- ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
    <div class="search-indicator" id="search-indicator" style="display: none;">
      <div class="spinner-border spinner-border-sm" role="status">
        <span class="visually-hidden">æ¤œç´¢ä¸­...</span>
      </div>
      <span>æ¤œç´¢ä¸­...</span>
    </div>
  </form>
</div>

  <!-- æ—¥è¨˜ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
  <h4 class="mb-3 diary-title px-2">
    <i class="bi bi-journal-richtext"></i> æ ªå¼æ—¥è¨˜ãƒªã‚¹ãƒˆ
  </h4>

  <!-- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³é€šçŸ¥ -->
  <div class="offline-alert alert alert-warning mb-3">
    <i class="bi bi-wifi-off me-2"></i>
    <span>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ã™ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</span>
  </div>

  <!-- æ—¥è¨˜ãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠ - HTMXå¯¾å¿œ (PCã§ã®2åˆ—è¡¨ç¤ºã®ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ) -->
  <div id="diary-container" class="home-diary-grid"
       hx-get="{% url 'stockdiary:diary_list' %}"
       hx-trigger="load, pulldown"
       hx-indicator="#diary-loading"
       data-hx-offline-queue="true">
    <div id="diary-loading" class="text-center py-4 htmx-indicator grid-column-span">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">æ—¥è¨˜ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</span>
      </div>
      <p class="mt-2">æ—¥è¨˜ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>
  </div>
</div>

{% include 'speed_dial.html' with actions=form_actions %}
{% include "stockdiary/partials/quick_diary_modal.html" %}
{% endblock %}

{% block scripts %}
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/ja.js"></script>
<script src="{% static 'js/quick-diary.js' %}"></script>
<!-- ãƒ¢ãƒã‚¤ãƒ«ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ç”¨ã®JSã‚’è¿½åŠ  -->
<script src="{% static 'js/mobile-gestures.js' %}"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // è©³ç´°æ¤œç´¢ãƒ‘ãƒãƒ«ã®åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('advancedToggle').addEventListener('click', function() {
        const panel = document.getElementById('advancedPanel');
        const isCollapsed = panel.classList.contains('collapsed');
        
        if (isCollapsed) {
            panel.classList.remove('collapsed');
            panel.classList.add('slide-down');
            this.innerHTML = '<i class="bi bi-x"></i>';
        } else {
            panel.classList.add('collapsed');
            this.innerHTML = '<i class="bi bi-sliders"></i>';
        }
    });

    // ãƒ¡ã‚¤ãƒ³æ¤œç´¢å…¥åŠ›ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å‡¦ç†
    const mainSearchInput = document.getElementById('mainSearchInput');
    const searchSuggestions = document.getElementById('searchSuggestions');
    
    mainSearchInput.addEventListener('focus', function() {
        if (this.value.length > 0) {
            searchSuggestions.style.display = 'block';
        }
    });

    mainSearchInput.addEventListener('input', function() {
        if (this.value.length > 1) {
            searchSuggestions.style.display = 'block';
            // ã“ã“ã§å®Ÿéš›ã®ã‚µã‚¸ã‚§ã‚¹ãƒãƒ§ãƒ³å–å¾—APIã‚’å‘¼ã³å‡ºã™
        } else {
            searchSuggestions.style.display = 'none';
        }
    });

    // å¤–éƒ¨ã‚¯ãƒªãƒƒã‚¯ã§ã‚µã‚¸ã‚§ã‚¹ãƒãƒ§ãƒ³ã‚’é–‰ã˜ã‚‹
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.main-search-wrapper')) {
            searchSuggestions.style.display = 'none';
        }
    });

    // ã‚µã‚¸ã‚§ã‚¹ãƒãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¯ãƒªãƒƒã‚¯
    document.querySelectorAll('.suggestion-item').forEach(item => {
        item.addEventListener('click', function() {
            mainSearchInput.value = this.querySelector('.suggestion-text').textContent;
            searchSuggestions.style.display = 'none';
            // æ¤œç´¢ã‚’å®Ÿè¡Œ
            document.getElementById('searchForm').dispatchEvent(new Event('submit'));
        });
    });

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒƒãƒ—ã®å‰Šé™¤
    document.querySelectorAll('.filter-chip-remove').forEach(button => {
        button.addEventListener('click', function() {
            this.parentElement.remove();
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒãªããªã£ãŸã‚‰éè¡¨ç¤ºã«ã™ã‚‹
            const activeFilters = document.getElementById('activeFilters');
            if (activeFilters.children.length === 0) {
                activeFilters.style.display = 'none';
            }
        });
    });

    // æ¤œç´¢å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¯ãƒªãƒƒã‚¯
    document.querySelectorAll('.history-item').forEach(item => {
        item.addEventListener('click', function() {
            mainSearchInput.value = this.textContent;
            document.getElementById('searchForm').dispatchEvent(new Event('submit'));
        });
    });

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // æ¤œç´¢ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
        const indicator = document.getElementById('searchIndicator');
        const resultsInfo = document.getElementById('searchResultsInfo');
        
        indicator.style.display = 'flex';
        
        // ãƒ‡ãƒ¢ç”¨ã®é…å»¶ï¼ˆå®Ÿéš›ã«ã¯HTMXã¾ãŸã¯APIãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
        setTimeout(() => {
            indicator.style.display = 'none';
            resultsInfo.style.display = 'flex';
        }, 1500);
    });

    // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ
    function handleResize() {
        const isMobile = window.innerWidth < 768;
        const advancedFields = document.querySelector('.advanced-fields');
        
        if (isMobile) {
            advancedFields.style.display = 'block';
        } else {
            advancedFields.style.display = 'grid';
        }
    }

    window.addEventListener('resize', handleResize);
    handleResize(); // åˆæœŸå®Ÿè¡Œ
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // åŸºæœ¬çš„ãªåˆæœŸåŒ–
  if (typeof initializeSpeedDial === 'function') {
    initializeSpeedDial();
  }
  
  // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–
  window.addEventListener('online', function() {
    document.body.classList.remove('is-offline');
  });
  
  window.addEventListener('offline', function() {
    document.body.classList.add('is-offline');
  });
  
  // åˆæœŸçŠ¶æ…‹ã®ãƒã‚§ãƒƒã‚¯
  if (!navigator.onLine) {
    document.body.classList.add('is-offline');
  }
  
  // â˜… ä¿®æ­£: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã®çµ±åˆ â˜…
  function setupCalendarClicks() {
    // æ—¢å­˜ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å‰Šé™¤
    document.querySelectorAll('.calendar-cell').forEach(cell => {
      cell.removeEventListener('click', handleCalendarClick);
    });
    
    // æ–°ã—ã„ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¿½åŠ 
    document.querySelectorAll('.calendar-cell').forEach(cell => {
      cell.addEventListener('click', handleCalendarClick);
    });
  }
  

  const urlParams = new URLSearchParams(window.location.search);
    const statusParam = urlParams.get('status');
    
    // statusãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„ã€ã¾ãŸã¯activeã®å ´åˆã¯ã€ä¿æœ‰ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
    if (!statusParam || statusParam === 'active') {
        const activeFilters = document.getElementById('activeFilters');
        if (activeFilters && !document.querySelector('[data-filter="status"]')) {
            const filterChip = document.createElement('div');
            filterChip.className = 'filter-chip';
            filterChip.setAttribute('data-filter', 'status');
            filterChip.setAttribute('data-value', 'active');
            filterChip.innerHTML = `
                <span>ä¿æœ‰ä¸­ã®ã¿è¡¨ç¤º</span>
                <button type="button" class="filter-chip-remove" onclick="removeFilter('status')">
                    <i class="bi bi-x"></i>
                </button>
            `;
            activeFilters.insertBefore(filterChip, activeFilters.firstChild);
            activeFilters.style.display = 'block';
        }
    }

  function handleCalendarClick(e) {
    const cell = e.currentTarget;
    const dateStr = cell.getAttribute('data-date');
    const view = cell.getAttribute('data-view');
    
    if (!dateStr || !view) return;
    
    // ã™ã¹ã¦ã®ã‚»ãƒ«ã‹ã‚‰ã‚¯ãƒªãƒƒã‚¯çŠ¶æ…‹ã‚’å‰Šé™¤
    document.querySelectorAll('.calendar-cell').forEach(c => {
      c.classList.remove('fc-day-clicked');
    });
    
    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚»ãƒ«ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    cell.classList.add('fc-day-clicked');
    
    // æ—¥ä»˜è¡¨ç¤ºã‚’æ›´æ–°
    updateSelectedDateDisplay(dateStr, view);
    
    // ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ãƒ»è¡¨ç¤º
    loadDayEvents(dateStr, view);
    
    // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    if (view === 'mobile') {
      const eventsCard = document.getElementById('mobile-events-card');
      if (eventsCard) {
        eventsCard.style.display = 'block';
        setTimeout(() => {
          eventsCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }
    }
  }
  
  function updateSelectedDateDisplay(dateStr, view) {
    try {
      const dateObj = new Date(dateStr);
      const formattedDate = dateObj.getFullYear() + 'å¹´' + 
                           (dateObj.getMonth() + 1) + 'æœˆ' + 
                           dateObj.getDate() + 'æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆ';
      
      const targetId = view === 'mobile' ? 'mobile-selected-date' : 'desktop-selected-date';
      const dateElement = document.getElementById(targetId);
      
      if (dateElement) {
        dateElement.textContent = formattedDate;
      }
    } catch (e) {
      console.warn('æ—¥ä»˜ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ:', dateStr);
    }
  }
   
  // HTMX ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  document.body.addEventListener('htmx:responseError', function(event) {
    console.error('HTMX ã‚¨ãƒ©ãƒ¼:', event.detail.xhr.status, event.detail.xhr.statusText);
    
    const target = event.detail.target;
    
    if (target.id === 'desktop-day-events' || target.id === 'mobile-day-events') {
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-exclamation-triangle me-2"></i>
          ã‚¤ãƒ™ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
        </div>
      `;
    } else if (target.id === 'desktop-calendar-container' || target.id === 'mobile-calendar-container') {
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-exclamation-triangle me-2"></i>
          ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
        </div>
      `;
    }
  });
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†
  document.body.addEventListener('htmx:afterSwap', function(event) {
    const targetId = event.detail.target.id;
    
    if (targetId === 'desktop-calendar-container' || targetId === 'mobile-calendar-container') {
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒæ›´æ–°ã•ã‚ŒãŸã‚‰ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å†è¨­å®š
      setTimeout(setupCalendarClicks, 100);
    }
    
    if (targetId === 'desktop-day-events' || targetId === 'mobile-day-events') {
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      const items = event.detail.target.querySelectorAll('.calendar-event-item');
      items.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(10px)';
        item.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        
        setTimeout(() => {
          item.style.opacity = '1';
          item.style.transform = 'translateY(0)';
        }, 50 * index);
      });
    }
  });
  
  // HTMXãƒªã‚¯ã‚¨ã‚¹ãƒˆã«CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿½åŠ 
  document.body.addEventListener('htmx:configRequest', function(evt) {
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    if (!evt.detail.headers) {
      evt.detail.headers = {};
    }
    evt.detail.headers['X-CSRFToken'] = csrfToken;
  });
  
  // åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  setTimeout(setupCalendarClicks, 1000);
});

// HTMXè¨­å®š
htmx.config.defaultSwapStyle = "innerHTML";
htmx.config.includeIndicatorStyles = true;
htmx.config.withCredentials = true;

// ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹æ¤œå‡º
htmx.on('htmx:beforeRequest', function(evt) {
  if (!navigator.onLine) {
    evt.preventDefault();
    document.body.classList.add('is-offline');
    
    const target = evt.detail.target;
    if (target) {
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-wifi-off me-2"></i>
          ç¾åœ¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ã™ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
        </div>
      `;
    }
  }
});

// HTMXè¨­å®š
htmx.config.defaultSwapStyle = "innerHTML";
htmx.config.includeIndicatorStyles = true;
htmx.config.withCredentials = true;

// ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’å¼·åŒ–
htmx.on('htmx:beforeRequest', function(evt) {
  // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¦ç´ ã‚’å–å¾—
  const indicatorSelector = evt.detail.elt.getAttribute('hx-indicator');
  if (indicatorSelector) {
    const indicator = document.querySelector(indicatorSelector);
    if (!indicator) {
      console.warn('Indicator not found:', indicatorSelector);
      // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å±æ€§ã‚’å‰Šé™¤
      evt.detail.elt.removeAttribute('hx-indicator');
    }
  }
});

// ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹æ¤œå‡º
htmx.on('htmx:beforeRequest', function(evt) {
  if (!navigator.onLine) {
    evt.preventDefault();
    document.body.classList.add('is-offline');
    
    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³é€šçŸ¥ã‚’è¡¨ç¤º
    const target = evt.detail.target;
    if (target) {
      target.innerHTML = `
        <div class="alert alert-warning m-2">
          <i class="bi bi-wifi-off me-2"></i>
          ç¾åœ¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ã™ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
        </div>
      `;
    }
  }
});
</script>
<script>
function removeFilter(filterName) {
    // ç¾åœ¨ã®URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    
    // æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å‰Šé™¤
    urlParams.delete(filterName);
    
    // ğŸ”§ statusãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆã¯ã€æ˜ç¤ºçš„ã«'all'ï¼ˆã™ã¹ã¦è¡¨ç¤ºï¼‰ã«è¨­å®š
    if (filterName === 'status') {
        urlParams.set('status', 'all');
    }
    
    // ãƒšãƒ¼ã‚¸ç•ªå·ã‚’ãƒªã‚»ãƒƒãƒˆ
    urlParams.delete('page');
    
    // æ–°ã—ã„URLã§é·ç§»ï¼ˆHTMXã‚’ä½¿ç”¨ï¼‰
    const newUrl = `{% url 'stockdiary:diary_list' %}?${urlParams.toString()}`;
    htmx.ajax('GET', newUrl, {target: '#diary-container', swap: 'innerHTML', pushUrl: true});
}

// ğŸ”§ åˆæœŸè¡¨ç¤ºæ™‚ã®å‡¦ç†ï¼ˆstatusãŒãªã„å ´åˆã¯activeã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦è¨­å®šï¼‰
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const statusParam = urlParams.get('status');
    
    // statusãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã€URLã«æ˜ç¤ºçš„ã«è¿½åŠ ï¼ˆå±¥æ­´ã‚’æ®‹ã•ãšï¼‰
    if (!statusParam) {
        urlParams.set('status', 'active');
        const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
        window.history.replaceState({}, '', newUrl);
    }
});

</script>
{% endblock %}