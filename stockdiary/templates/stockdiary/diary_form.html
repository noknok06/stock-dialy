{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}æ—¥è¨˜ã®ç·¨é›†{% else %}æ–°è¦æ—¥è¨˜ä½œæˆ{% endif %} | ã‚«ãƒ–ãƒ­ã‚°{% endblock %}

{% block head %}
{{ block.super }}
<style>
  .form-section {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .form-section-title {
    color: #374151;
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .form-control, .form-select {
    border: 2px solid #d1d5db;
    transition: all 0.2s ease;
  }

  .form-control:focus, .form-select:focus {
    border-color: #5a7ec5;
    box-shadow: 0 0 0 3px rgba(90, 126, 197, 0.25);
    outline: none;
  }

  /* æ—¥è¨˜ã‚‰ã—ã„ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
  .diary-textarea {
    font-family: 'Hiragino Kaku Gothic Pro', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
    line-height: 1.8;
    padding: 1rem;
    border-radius: 0.5rem;
    background-color: #fefefe;
    background-image: linear-gradient(transparent 1.7rem, #e5e7eb 1.7rem, #e5e7eb 1.8rem, transparent 1.8rem);
    background-size: 100% 1.8rem;
    min-height: 200px;
  }

  .dark-mode .diary-textarea,
  [data-theme="dark"] .diary-textarea {
    background-image: linear-gradient(transparent 1.7rem, #52626d 1.7rem, #0e2147 1.8rem, transparent 1.8rem);
  }

  .dark-mode .input-group-text,
  [data-theme="dark"] .input-group-text {
    background-color: #1e293b;
    color: #f3f4f6;
  }
  .dark-mode .tooltip-inner,
  [data-theme="dark"] .tooltip-inner {
      background-color: #333;
      color: #f3f4f6;
  }

  .dark-mode .form-control[type="file"],
  [data-theme="dark"] .form-control[type="file"] {
    background-color: #333;
    color: #f3f4f6;
    border-color: #555;
  }

  .dark-mode .form-control[type="file"]::file-selector-button,
  [data-theme="dark"] .form-control[type="file"]::file-selector-button {
    background-color: #444;
    color: #f3f4f6;
    border: 1px solid #666;
  }

  .dark-mode .form-control[type="file"]::file-selector-button:hover,
  [data-theme="dark"] .form-control[type="file"]::file-selector-button:hover {
    background-color: #555;
    border-color: #777;
  }

  .dark-mode .tooltip.bs-tooltip-top .tooltip-arrow::before,
  [data-theme="dark"] .tooltip.bs-tooltip-top .tooltip-arrow::before {
      border-top-color: #333;
  }

  .diary-memo-textarea {
    font-family: 'Hiragino Kaku Gothic Pro', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
    line-height: 1.8;
    padding: 1rem;
    border-radius: 0.5rem;
    background-color: #fffef5;
    border: 2px solid #fbbf24;
    min-height: 150px;
  }

  .initial-purchase-section {
    border: 2px dashed #d1d5db;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1rem;
  }

  .initial-purchase-section.active {
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .info-box {
    background-color: #eff6ff;
    border-left: 4px solid #3b82f6;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 0.25rem;
  }

  .info-box-icon {
    color: #3b82f6;
    margin-right: 0.5rem;
  }

  .character-count {
    font-size: 0.875rem;
    color: #6b7280;
    text-align: right;
    margin-top: 0.25rem;
  }

  .character-count.warning {
    color: #f59e0b;
  }

  /* ğŸ†• å–å¼•åŒºåˆ†ã®ãƒãƒƒã‚¸ã‚¹ã‚¿ã‚¤ãƒ« */
  .trade-type-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .trade-type-badge.cash {
    background-color: #dcfce7;
    color: #166534;
  }

  .trade-type-badge.margin {
    background-color: #fef3c7;
    color: #92400e;
  }

  /* ========== åˆ†æé …ç›®ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçµ±ä¸€ ========== */
  .analysis-item {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s ease;
  }

  .analysis-item:hover {
    border-color: #5a7ec5;
    box-shadow: 0 2px 4px rgba(90, 126, 197, 0.15);
  }

  .analysis-item-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
  }

  .analysis-item-label-wrapper {
    display: flex;
    align-items: flex-start;
    flex: 1;
    min-width: 0;
  }

  .analysis-item-label-wrapper i {
    flex-shrink: 0;
    margin-right: 0.5rem;
    margin-top: 0.25rem;
  }

  .analysis-item-label {
    font-weight: 600;
    font-size: 0.95rem;
    color: #111827;
    margin: 0;
    cursor: pointer;
    line-height: 1.4;
  }

  .analysis-item-desc {
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 0.25rem;
    line-height: 1.4;
  }

  .analysis-item-checkbox {
    flex-shrink: 0;
  }

  .analysis-item-checkbox .form-check {
    margin: 0;
    padding: 0;
  }

  .analysis-item-checkbox .form-check-input {
    width: 1.5rem;
    height: 1.5rem;
    margin: 0;
    cursor: pointer;
    border: 2px solid #d1d5db;
    border-radius: 0.375rem;
    transition: all 0.2s ease;
  }

  .analysis-item-checkbox .form-check-input:checked {
    background-color: #10b981;
    border-color: #10b981;
  }

  .analysis-item-checkbox .form-check-input:focus {
    border-color: #5a7ec5;
    box-shadow: 0 0 0 0.25rem rgba(90, 126, 197, 0.25);
    outline: none;
  }

  .analysis-item-input-section {
    margin-top: 0.75rem;
  }

  .analysis-item-input-section .form-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #4b5563;
    margin-bottom: 0.375rem;
  }

  .analysis-item .form-control,
  .analysis-item .form-select {
    border: 2px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    width: 100%;
  }

  @media (min-width: 768px) {
    .analysis-item .form-control[type="number"] {
      max-width: 200px;
    }
    
    .analysis-item .form-control[type="text"] {
      max-width: 400px;
    }
    
    .analysis-item .form-select {
      max-width: 300px;
    }
  }

  @media (min-width: 577px) and (max-width: 767px) {
    .analysis-item .form-control,
    .analysis-item .form-select {
      max-width: 100%;
    }
  }

  .analysis-item .form-control:focus,
  .analysis-item .form-select:focus {
    border-color: #5a7ec5;
    box-shadow: 0 0 0 3px rgba(90, 126, 197, 0.25);
    outline: none;
  }

  .analysis-item .form-control::placeholder {
    color: #9ca3af;
  }

  @media (max-width: 576px) {
    .analysis-item {
      padding: 0.875rem;
    }
    
    .analysis-item-header {
      gap: 0.75rem;
    }
    
    .analysis-item-label {
      font-size: 0.9rem;
    }
    
    .analysis-item-desc {
      font-size: 0.75rem;
    }
    
    .analysis-item-checkbox .form-check-input {
      width: 1.375rem;
      height: 1.375rem;
    }

    .analysis-item .form-control,
    .analysis-item .form-select {
      width: 100%;
      max-width: 100%;
    }
  }

  @media (hover: none) and (pointer: coarse) {
    .analysis-item-checkbox .form-check-input {
      width: 1.75rem;
      height: 1.75rem;
    }
    
    .analysis-item-label {
      padding: 0.5rem 0;
      min-height: 44px;
      display: flex;
      align-items: center;
    }

    .analysis-item .form-control,
    .analysis-item .form-select {
      min-height: 44px;
    }
  }

  .analysis-item-checkbox .form-check-input:focus-visible {
    outline: 2px solid #5a7ec5;
    outline-offset: 2px;
  }

  .analysis-item-input-section {
    margin-top: 0.75rem;
  }

  .analysis-item-input-section .form-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #4b5563;
    margin-bottom: 0.375rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="title_header">
    <h1 class="page-title">
      <i class="bi bi-journal-text"></i> {% if form.instance.pk %}æ—¥è¨˜ã®ç·¨é›†{% else %}æ–°è¦æ—¥è¨˜ä½œæˆ{% endif %}
    </h1>
  </div>

  {% if not form.instance.pk %}
  <div class="info-box">
    <i class="bi bi-info-circle info-box-icon"></i>
    <strong>æŠ•è³‡æ—¥è¨˜ã«ã¤ã„ã¦:</strong>
    æŠ•è³‡åˆ¤æ–­ã®ç†ç”±ã‚„æ°—ã¥ã„ãŸã“ã¨ã‚’è‡ªç”±ã«è¨˜éŒ²ã§ãã¾ã™ã€‚
    å¾Œã‹ã‚‰ã€Œå–å¼•å±¥æ­´ã€ã‚¿ãƒ–ã§å®Ÿéš›ã®å£²è²·ã‚’è¨˜éŒ²ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
  </div>
  {% endif %}

  <div class="diary-form">
    <div class="form-body">
      <form method="post" enctype="multipart/form-data" id="diaryForm">
        {% csrf_token %}

        <!-- æ ªå¼æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="bi bi-graph-up"></i> éŠ˜æŸ„æƒ…å ±
          </h4>

          <div class="info-block d-none" id="stockInfoCard">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0" id="stockInfoTitle">ä¼šç¤¾æƒ…å ±</h5>
              <span class="badge bg-primary" id="stockInfoCode"></span>
            </div>
            <div class="info-row">
              <div class="info-item">
                <div class="info-icon"><i class="bi bi-currency-yen"></i></div>
                <div class="info-content">
                  <span class="info-label">ç¾åœ¨æ ªä¾¡</span>
                  <span class="info-value" id="stockInfoPrice">--</span>
                </div>
              </div>
              <div class="info-item">
                <div class="info-icon"><i class="bi bi-graph-up-arrow"></i></div>
                <div class="info-content">
                  <span class="info-label">å‰æ—¥æ¯”</span>
                  <span class="info-value" id="stockInfoChange">--</span>
                </div>
              </div>
              <div class="info-item">
                <div class="info-icon"><i class="bi bi-building"></i></div>
                <div class="info-content">
                  <span class="info-label">å¸‚å ´</span>
                  <span class="info-value" id="stockInfoMarket">--</span>
                </div>
              </div>
              <div class="info-item">
                <div class="info-icon"><i class="bi bi-diagram-3"></i></div>
                <div class="info-content">
                  <span class="info-label">æ¥­ç¨®</span>
                  <span class="info-value" id="stockInfoIndustry">--</span>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.stock_symbol.id_for_label }}" class="form-label">
                {{ form.stock_symbol.label }}
              </label>
              <div class="input-group">
                {{ form.stock_symbol }}
                <button type="button" class="btn btn-primary" id="fetchStockInfo">
                  <i class="bi bi-search"></i> æ¤œç´¢
                </button>
              </div>
              <div class="spinner-container mt-2 d-none" id="symbolSpinnerContainer">
                <div class="spinner-border text-primary spinner-symbol" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <small class="text-muted">ä¼šç¤¾æƒ…å ±ã‚’å–å¾—ä¸­...</small>
              </div>
              <small class="form-text text-muted">{{ form.stock_symbol.help_text }}</small>
              {% if form.stock_symbol.errors %}
              <div class="text-danger">{{ form.stock_symbol.errors }}</div>
              {% endif %}
            </div>

            <div class="col-md-6 mb-3">
              <label for="{{ form.stock_name.id_for_label }}" class="form-label">
                éŠ˜æŸ„å/ãƒ¡ãƒ¢ã‚¿ã‚¤ãƒˆãƒ«<span class="text-danger">*</span>
              </label>
              {{ form.stock_name }}
              <small class="form-text text-muted">æ ªå¼ã®å ´åˆã¯éŠ˜æŸ„åã€ãƒ¡ãƒ¢ã®å ´åˆã¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›</small>
              {% if form.stock_name.errors %}
              <div class="text-danger">{{ form.stock_name.errors }}</div>
              {% endif %}
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.sector.id_for_label }}" class="form-label">æ¥­ç¨®</label>
              <div class="input-group">
                {{ form.sector }}
                <span class="input-group-text">
                  <i class="bi bi-info-circle" data-bs-toggle="tooltip" 
                     title="éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢ã™ã‚‹ã¨è‡ªå‹•è¨­å®šã•ã‚Œã¾ã™"></i>
                </span>
              </div>
              <small class="form-text text-muted">æ¥­ç¨®æƒ…å ±ã¯éŠ˜æŸ„æ¤œç´¢æ™‚ã«è‡ªå‹•è¨­å®šã•ã‚Œã¾ã™</small>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.tags.id_for_label }}" class="form-label">ã‚¿ã‚°</label>
              {{ form.tags }}
              <small class="form-text text-muted">è¤‡æ•°é¸æŠå¯èƒ½ã§ã™</small>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <label for="{{ form.reason.id_for_label }}" class="form-label">
            <strong>æŠ•è³‡ç†ç”±ãƒ»åˆ†æå†…å®¹</strong>
          </label>
          <textarea class="form-control diary-textarea" 
                    name="reason" 
                    id="{{ form.reason.id_for_label }}"
                    rows="10"
                    placeholder="ãªãœã“ã®éŠ˜æŸ„ã«æ³¨ç›®ã—ãŸã®ã‹ã€ã©ã®ã‚ˆã†ãªåˆ†æã‚’ã—ãŸã®ã‹ã€å°†æ¥ã®è¦‹é€šã—ãªã©ã‚’è‡ªç”±ã«è¨˜éŒ²ã—ã¦ãã ã•ã„...

ä¾‹:
ãƒ»æ±ºç®—ãŒå¥½èª¿ã§å¢—ç›Šå‚¾å‘ã«ã‚ã‚‹
ãƒ»æ–°è£½å“ã®ç™ºå£²ãŒæ§ãˆã¦ãŠã‚ŠæœŸå¾…ã§ãã‚‹
ãƒ»PERãŒåŒæ¥­ä»–ç¤¾ã¨æ¯”ã¹ã¦å‰²å®‰
ãƒ»é…å½“åˆ©å›ã‚ŠãŒé«˜ã„
ãƒ»æŠ€è¡“çš„ã«å¼·ã„ã‚µãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ãŒã‚ã‚‹"
                    maxlength="3000">{{ form.reason.value|default:'' }}</textarea>
          <div class="character-count" id="reasonCharCount">0 / 3000æ–‡å­—</div>
          {% if form.reason.errors %}
          <div class="text-danger small mt-1">{{ form.reason.errors }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          <label for="{{ form.memo.id_for_label }}" class="form-label">
            <strong>ãƒ¡ãƒ¢ãƒ»æ°—ã¥ã„ãŸã“ã¨</strong>
            <span class="badge bg-warning text-dark ms-2">
              <i class="bi bi-sticky"></i> ãƒ¡ãƒ¢
            </span>
          </label>
          <textarea class="form-control diary-memo-textarea" 
                    name="memo" 
                    id="{{ form.memo.id_for_label }}"
                    rows="6"
                    placeholder="ãã®ä»–ã®æ°—ã¥ãã€æ³¨æ„ç‚¹ã€æ„Ÿæƒ³ãªã©ã‚’è‡ªç”±ã«è¨˜å…¥ã—ã¦ãã ã•ã„...

ä¾‹:
ãƒ»çµŒå–¶é™£ã®ç™ºè¨€ãŒæ°—ã«ãªã£ãŸ
ãƒ»ç«¶åˆä»–ç¤¾ã®å‹•å‘ã‚‚ãƒã‚§ãƒƒã‚¯å¿…è¦
ãƒ»æ¬¡ã®æ±ºç®—ç™ºè¡¨ã¯â—‹æœˆâ—‹æ—¥
ãƒ»ã“ã®ä¾¡æ ¼å¸¯ã§è²·ã„å¢—ã—ã‚’æ¤œè¨"
                    maxlength="1000">{{ form.memo.value|default:'' }}</textarea>
          <div class="character-count" id="memoCharCount">0 / 1000æ–‡å­—</div>
          {% if form.memo.errors %}
          <div class="text-danger small mt-1">{{ form.memo.errors }}</div>
          {% endif %}
        </div>

        <!-- ğŸ†• åˆå›è³¼å…¥æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå–å¼•åŒºåˆ†è¿½åŠ ï¼‰ -->
        {% if not form.instance.pk %}
        <div class="form-section">
          <div class="form-check mb-3">
            <input type="checkbox" class="form-check-input" 
                   id="id_add_initial_purchase" 
                   name="add_initial_purchase"
                   {% if form.add_initial_purchase.value %}checked{% endif %}>
            <label class="form-check-label" for="id_add_initial_purchase">
              <strong>{{ form.add_initial_purchase.label }}</strong>
              <small class="d-block text-muted">
                ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã€æ—¥è¨˜ä½œæˆã¨åŒæ™‚ã«æœ€åˆã®è³¼å…¥å–å¼•ã‚’è¨˜éŒ²ã§ãã¾ã™
              </small>
            </label>
          </div>
        
          <div class="initial-purchase-section" id="initialPurchaseSection" 
               {% if not form.add_initial_purchase.value %}style="display: none;"{% endif %}>
            <div class="alert alert-info mb-3">
              <i class="bi bi-info-circle me-2"></i>
              <strong>åˆå›è³¼å…¥ã«ã¤ã„ã¦:</strong>
              <ul class="mb-0 mt-2 small">
                <li>æ—¥è¨˜ä½œæˆå¾Œã€ã€Œå–å¼•å±¥æ­´ã€ã‚¿ãƒ–ã‹ã‚‰è¿½åŠ è³¼å…¥ãƒ»å£²å´ã‚’è¨˜éŒ²ã§ãã¾ã™</li>
                <li>ã¾ã è³¼å…¥ã—ã¦ã„ãªã„å ´åˆã¯ã€ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦ãã ã•ã„</li>
                <li>å¾Œã‹ã‚‰ã€Œå–å¼•å±¥æ­´ã€ã‚¿ãƒ–ã§è¿½åŠ ã§ãã¾ã™</li>
              </ul>
            </div>
        
            <h6 class="mb-3">
              <i class="bi bi-cart-plus"></i> åˆå›è³¼å…¥æƒ…å ±
            </h6>
        
            <div class="row">
              <!-- ğŸ†• å–å¼•åŒºåˆ† -->
              <div class="col-md-3 mb-3">
                <label for="id_initial_trade_type" class="form-label">
                  å–å¼•åŒºåˆ†<span class="text-danger">*</span>
                </label>
                <select class="form-select" 
                        id="id_initial_trade_type"
                        name="initial_trade_type">
                  <option value="cash" selected>
                    <i class="bi bi-wallet2"></i> ç¾ç‰©
                  </option>
                  <option value="margin">
                    <i class="bi bi-currency-exchange"></i> ä¿¡ç”¨
                  </option>
                </select>
                <small class="form-text text-muted">ç¾ç‰©ã¾ãŸã¯ä¿¡ç”¨å–å¼•</small>
                {% if form.initial_trade_type.errors %}
                <div class="text-danger small">{{ form.initial_trade_type.errors }}</div>
                {% endif %}
              </div>

              <div class="col-md-3 mb-3">
                <label for="id_initial_purchase_date" class="form-label">
                  è³¼å…¥æ—¥<span class="text-danger">*</span>
                </label>
                <input type="date" 
                       class="form-control" 
                       id="id_initial_purchase_date"
                       name="initial_purchase_date"
                       value="{{ form.initial_purchase_date.value|default:'' }}">
                {% if form.initial_purchase_date.errors %}
                <div class="text-danger small">{{ form.initial_purchase_date.errors }}</div>
                {% endif %}
              </div>
        
              <div class="col-md-3 mb-3">
                <label for="id_initial_purchase_price" class="form-label">
                  è³¼å…¥å˜ä¾¡ï¼ˆå††ï¼‰<span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <input type="number" 
                         class="form-control" 
                         id="id_initial_purchase_price"
                         name="initial_purchase_price"
                         step="0.01" 
                         min="0.01"
                         placeholder="ä¾‹: 1000.00"
                         value="{{ form.initial_purchase_price.value|default:'' }}">
                  <button type="button" class="btn btn-outline-primary" 
                          id="fetch-current-price" title="ç¾åœ¨æ ªä¾¡ã‚’å–å¾—">
                    <i class="bi bi-arrow-repeat"></i>
                  </button>
                </div>
                <small class="form-text text-muted">1æ ªã‚ãŸã‚Šã®å˜ä¾¡</small>
                {% if form.initial_purchase_price.errors %}
                <div class="text-danger small">{{ form.initial_purchase_price.errors }}</div>
                {% endif %}
              </div>
        
              <div class="col-md-3 mb-3">
                <label for="id_initial_purchase_quantity" class="form-label">
                  è³¼å…¥æ•°é‡ï¼ˆæ ªï¼‰<span class="text-danger">*</span>
                </label>
                <input type="number" 
                       class="form-control"
                       id="id_initial_purchase_quantity"
                       name="initial_purchase_quantity"
                       step="1" 
                       min="1"
                       placeholder="ä¾‹: 100"
                       value="{{ form.initial_purchase_quantity.value|default:'' }}">
                <small class="form-text text-muted">å–å¼•æ ªæ•°</small>
                {% if form.initial_purchase_quantity.errors %}
                <div class="text-danger small">{{ form.initial_purchase_quantity.errors }}</div>
                {% endif %}
              </div>
            </div>
        
            <!-- ğŸ†• å–å¼•åŒºåˆ†ã®èª¬æ˜ -->
            <div class="alert alert-light mb-3" id="trade-type-info">
              <div class="d-flex align-items-start gap-2">
                <i class="bi bi-info-circle text-primary mt-1"></i>
                <div>
                  <strong id="trade-type-title">ç¾ç‰©å–å¼•</strong>
                  <p class="mb-0 small text-muted" id="trade-type-desc">
                    è‡ªå·±è³‡é‡‘ã§æ ªå¼ã‚’è³¼å…¥ãƒ»ä¿æœ‰ã™ã‚‹å–å¼•ã§ã™
                  </p>
                </div>
              </div>
            </div>

            <!-- åˆè¨ˆé‡‘é¡ã®è¡¨ç¤º -->
            <div class="alert alert-success" id="initial-purchase-preview" style="display: none;">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>åˆå›è³¼å…¥é‡‘é¡:</strong>
                  <span class="trade-type-badge ms-2" id="preview-trade-type-badge">
                    <i class="bi bi-wallet2"></i> ç¾ç‰©
                  </span>
                </div>
                <span id="initial-purchase-amount" class="fs-5">0</span>å††
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- åˆ†æãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="bi bi-clipboard-data"></i> åˆ†æãƒ‡ãƒ¼ã‚¿ï¼ˆä»»æ„ï¼‰
          </h4>

          <div class="row mb-3">
            <div class="col-md-8">
              <label for="{{ form.analysis_template.id_for_label }}" class="form-label">åˆ†æãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
              {{ form.analysis_template }}
              <small class="form-text text-muted">{{ form.analysis_template.help_text }}</small>
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button type="button" id="expandAnalysisBtn" class="btn btn-diary btn-diary-primary btn-sm">
                <i class="bi bi-clipboard-data me-1"></i> åˆ†æé …ç›®ã‚’è¡¨ç¤º
              </button>
            </div>
          </div>
        </div>

        <div id="analysisItemsContainer" class="form-section d-none">
          <h4 class="form-section-title">
            <i class="bi bi-table"></i> åˆ†æé …ç›®
          </h4>
          <div id="analysisItemsContent" class="analysis-container info-block">
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              åˆ†æãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã™ã‚‹ã¨ã€é …ç›®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
            </div>
          </div>
        </div>

        <!-- ç”»åƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="bi bi-image"></i> ç”»åƒæ·»ä»˜ï¼ˆä»»æ„ï¼‰
          </h4>

          <div class="mb-3">
            <label for="id_image" class="form-label">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«</label>
            {{ form.image }}
            <small class="form-text text-muted">
              ãƒãƒ£ãƒ¼ãƒˆã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç­‰ï¼ˆæœ€å¤§10MBã€JPEG/PNG/GIF/WebPå½¢å¼ï¼‰
            </small>

            <div id="image-preview-container" class="mt-3" style="display: none;">
              <div class="card" style="max-width: 300px;">
                <img id="image-preview" class="card-img-top" 
                     style="max-height: 200px; object-fit: cover;" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                <div class="card-body p-2">
                  <small class="text-muted">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</small>
                  <button type="button" id="remove-image" class="btn btn-sm btn-outline-danger float-end">
                    <i class="bi bi-x"></i> å‰Šé™¤
                  </button>
                </div>
              </div>
            </div>

            {% if form.instance.image_url %}
            <div class="mt-3">
              <div class="card" style="max-width: 300px;">
                <img src="{{ form.instance.image_url }}" class="card-img-top"
                     style="max-height: 200px; object-fit: cover;" alt="ç¾åœ¨ã®ç”»åƒ">
                <div class="card-body p-2">
                  <small class="text-muted">ç¾åœ¨ã®ç”»åƒ</small>
                  <div class="form-check mt-1">
                    <input type="checkbox" id="clear-image" name="clear_image" class="form-check-input">
                    <label for="clear-image" class="form-check-label small">
                      ã“ã®ç”»åƒã‚’å‰Šé™¤ã™ã‚‹
                    </label>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>

        <div class="form-footer">
          <a href="{% if form.instance.pk %}{% url 'stockdiary:detail' form.instance.pk %}{% else %}{% url 'stockdiary:home' %}{% endif %}"
             class="btn btn-diary btn-diary-outline">
            <i class="bi bi-arrow-left me-1"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </a>
          <button type="submit" class="btn btn-diary btn-diary-primary" id="submitBtn">
            <i class="bi bi-save me-1"></i> ä¿å­˜
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% include 'speed_dial.html' with actions=form_actions %}
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>

document.addEventListener('DOMContentLoaded', function() {

// ============================================
// ğŸ†• å–å¼•åŒºåˆ†ã®èª¬æ˜è¡¨ç¤º
// ============================================
const tradeTypeSelect = document.getElementById('id_initial_trade_type');
const tradeTypeInfo = document.getElementById('trade-type-info');
const tradeTypeTitle = document.getElementById('trade-type-title');
const tradeTypeDesc = document.getElementById('trade-type-desc');
const previewTradeBadge = document.getElementById('preview-trade-type-badge');

if (tradeTypeSelect) {
  tradeTypeSelect.addEventListener('change', function() {
    updateTradeTypeInfo(this.value);
    updateInitialPurchasePreview();
  });
  
  // åˆæœŸè¡¨ç¤º
  updateTradeTypeInfo(tradeTypeSelect.value);
}

function updateTradeTypeInfo(tradeType) {
  if (tradeType === 'margin') {
    tradeTypeTitle.textContent = 'ä¿¡ç”¨å–å¼•';
    tradeTypeDesc.textContent = 'è¨¼åˆ¸ä¼šç¤¾ã‹ã‚‰è³‡é‡‘ã‚„æ ªå¼ã‚’å€Ÿã‚Šã¦è¡Œã†å–å¼•ã§ã™ã€‚ãƒ¬ãƒãƒ¬ãƒƒã‚¸ã‚’åŠ¹ã‹ã›ãŸå–å¼•ãŒå¯èƒ½ã§ã™ã€‚';
    tradeTypeInfo.classList.remove('alert-light');
    tradeTypeInfo.classList.add('alert-warning');
    
    if (previewTradeBadge) {
      previewTradeBadge.className = 'trade-type-badge margin ms-2';
      previewTradeBadge.innerHTML = '<i class="bi bi-currency-exchange"></i> ä¿¡ç”¨';
    }
  } else {
    tradeTypeTitle.textContent = 'ç¾ç‰©å–å¼•';
    tradeTypeDesc.textContent = 'è‡ªå·±è³‡é‡‘ã§æ ªå¼ã‚’è³¼å…¥ãƒ»ä¿æœ‰ã™ã‚‹å–å¼•ã§ã™ã€‚';
    tradeTypeInfo.classList.remove('alert-warning');
    tradeTypeInfo.classList.add('alert-light');
    
    if (previewTradeBadge) {
      previewTradeBadge.className = 'trade-type-badge cash ms-2';
      previewTradeBadge.innerHTML = '<i class="bi bi-wallet2"></i> ç¾ç‰©';
    }
  }
}

// ============================================
// ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆæ©Ÿèƒ½
// ============================================
const stockSymbolInput = document.getElementById('id_stock_symbol');
let autocompleteTimeout;
let autocompleteResults = [];
let selectedIndex = -1;

if (stockSymbolInput) {
  const autocompleteContainer = document.createElement('div');
  autocompleteContainer.id = 'autocomplete-results';
  autocompleteContainer.className = 'autocomplete-results';
  autocompleteContainer.style.cssText = `
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    display: none;
  `;
  
  const inputGroup = stockSymbolInput.closest('.input-group');
  if (inputGroup) {
    inputGroup.style.position = 'relative';
    inputGroup.appendChild(autocompleteContainer);
  }
  
  stockSymbolInput.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    clearTimeout(autocompleteTimeout);
    
    if (query.length < 2) {
      autocompleteContainer.style.display = 'none';
      return;
    }
    
    autocompleteTimeout = setTimeout(async () => {
      try {
        const response = await fetch(`/stockdiary/api/stock/search/?query=${encodeURIComponent(query)}&limit=10`);
        const data = await response.json();
        
        if (data.success && data.companies.length > 0) {
          autocompleteResults = data.companies;
          displayAutocompleteResults(data.companies);
        } else {
          autocompleteContainer.style.display = 'none';
        }
      } catch (error) {
        console.error('Autocomplete error:', error);
        autocompleteContainer.style.display = 'none';
      }
    }, 300);
  });
  
  function displayAutocompleteResults(companies) {
    let html = '<div class="list-group list-group-flush">';
    
    companies.forEach((company, index) => {
      html += `
        <button type="button" 
                class="list-group-item list-group-item-action autocomplete-item" 
                data-index="${index}"
                style="border: none; padding: 0.75rem 1rem; cursor: pointer; text-align: left;">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong style="color: #2563eb;">${escapeHtml(company.code)}</strong>
              <span style="color: #374151; margin-left: 0.5rem;">${escapeHtml(company.name)}</span>
            </div>
            <div style="text-align: right;">
              <small style="color: #6b7280; display: block;">${escapeHtml(company.market)}</small>
              <small style="color: #9ca3af; display: block;">${escapeHtml(company.industry)}</small>
            </div>
          </div>
        </button>
      `;
    });
    
    html += '</div>';
    autocompleteContainer.innerHTML = html;
    autocompleteContainer.style.display = 'block';
    
    const items = autocompleteContainer.querySelectorAll('.autocomplete-item');
    items.forEach(item => {
      item.addEventListener('click', function() {
        const index = parseInt(this.dataset.index);
        selectCompany(autocompleteResults[index]);
      });
      
      item.addEventListener('mouseenter', function() {
        this.style.backgroundColor = '#f3f4f6';
      });
      item.addEventListener('mouseleave', function() {
        this.style.backgroundColor = 'white';
      });
    });
  }
  
  function selectCompany(company) {
    stockSymbolInput.value = company.code;
    
    const stockNameInput = document.getElementById('id_stock_name');
    const sectorInput = document.getElementById('id_sector');
    
    if (stockNameInput && !stockNameInput.value) {
      stockNameInput.value = company.name;
    }
    
    if (sectorInput && !sectorInput.value) {
      sectorInput.value = company.industry;
    }
    
    autocompleteContainer.style.display = 'none';
    selectedIndex = -1;
    
    const fetchStockInfoBtn = document.getElementById('fetchStockInfo');
    if (fetchStockInfoBtn) {
      fetchStockInfoBtn.click();
    }
  }
  
  stockSymbolInput.addEventListener('keydown', function(e) {
    const items = autocompleteContainer.querySelectorAll('.autocomplete-item');
    
    if (items.length === 0) return;
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
      updateSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, -1);
      updateSelection(items);
    } else if (e.key === 'Enter' && selectedIndex >= 0) {
      e.preventDefault();
      const index = parseInt(items[selectedIndex].dataset.index);
      selectCompany(autocompleteResults[index]);
    } else if (e.key === 'Escape') {
      autocompleteContainer.style.display = 'none';
      selectedIndex = -1;
    }
  });
  
  function updateSelection(items) {
    items.forEach((item, index) => {
      if (index === selectedIndex) {
        item.style.backgroundColor = '#dbeafe';
        item.scrollIntoView({ block: 'nearest' });
      } else {
        item.style.backgroundColor = 'white';
      }
    });
  }
  
  document.addEventListener('click', function(e) {
    if (!stockSymbolInput.contains(e.target) && !autocompleteContainer.contains(e.target)) {
      autocompleteContainer.style.display = 'none';
      selectedIndex = -1;
    }
  });
}

const fetchStockInfoBtn = document.getElementById('fetchStockInfo');
const stockNameInput = document.getElementById('id_stock_name');
const sectorInput = document.getElementById('id_sector');
const stockInfoCard = document.getElementById('stockInfoCard');
const symbolSpinnerContainer = document.getElementById('symbolSpinnerContainer');

if (fetchStockInfoBtn) {
  fetchStockInfoBtn.addEventListener('click', async function() {
    const stockCode = stockSymbolInput.value.trim();
    
    if (!stockCode) {
      alert('éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      stockSymbolInput.focus();
      return;
    }
    
    fetchStockInfoBtn.disabled = true;
    fetchStockInfoBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    symbolSpinnerContainer.classList.remove('d-none');
    stockInfoCard.classList.add('d-none');
    
    try {
      const response = await fetch(`/stockdiary/api/stock/info/${stockCode}/`);
      
      if (!response.ok) {
        throw new Error('æ ªå¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      
      const data = await response.json();
      
      if (data.success) {
        if (data.company_name) {
          stockNameInput.value = data.company_name;
        }
        
        if (data.industry && data.industry !== 'ä¸æ˜') {
          sectorInput.value = data.industry;
        }
        
        displayStockInfo(data, stockCode);
        showNotification('success', 'éŠ˜æŸ„æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ');
      } else {
        throw new Error(data.error || 'éŠ˜æŸ„æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      
    } catch (error) {
      console.error('Stock info fetch error:', error);
      showNotification('error', error.message);
      stockInfoCard.classList.add('d-none');
    } finally {
      fetchStockInfoBtn.disabled = false;
      fetchStockInfoBtn.innerHTML = '<i class="bi bi-search"></i> æ¤œç´¢';
      symbolSpinnerContainer.classList.add('d-none');
    }
  });
}

function displayStockInfo(data, stockCode) {
  document.getElementById('stockInfoTitle').textContent = data.company_name || 'éŠ˜æŸ„æƒ…å ±';
  document.getElementById('stockInfoCode').textContent = stockCode;
  
  if (data.price !== null && data.price !== undefined) {
    document.getElementById('stockInfoPrice').textContent = 
      `${parseFloat(data.price).toLocaleString('ja-JP', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      })}å††`;
  } else {
    document.getElementById('stockInfoPrice').textContent = 'å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
  }
  
  if (data.change_percent !== null && data.change_percent !== undefined) {
    const changeElement = document.getElementById('stockInfoChange');
    const changePercent = parseFloat(data.change_percent);
    const changeClass = changePercent > 0 ? 'text-success' : 
                       (changePercent < 0 ? 'text-danger' : 'text-muted');
    const changeSign = changePercent > 0 ? '+' : '';
    
    changeElement.textContent = `${changeSign}${changePercent.toFixed(2)}%`;
    changeElement.className = `info-value ${changeClass}`;
  } else {
    document.getElementById('stockInfoChange').textContent = '--';
  }
  
  document.getElementById('stockInfoMarket').textContent = data.market || 'ä¸æ˜';
  document.getElementById('stockInfoIndustry').textContent = data.industry || 'ä¸æ˜';
  
  stockInfoCard.classList.remove('d-none');
}

function showNotification(type, message) {
  const existingNotification = document.querySelector('.custom-notification');
  if (existingNotification) {
    existingNotification.remove();
  }
  
  const notification = document.createElement('div');
  notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show custom-notification`;
  notification.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
  notification.innerHTML = `
    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

// ============================================
// æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
// ============================================
const reasonTextarea = document.getElementById('{{ form.reason.id_for_label }}');
const memoTextarea = document.getElementById('{{ form.memo.id_for_label }}');
const reasonCharCount = document.getElementById('reasonCharCount');
const memoCharCount = document.getElementById('memoCharCount');

function updateCharCount(textarea, countElement, maxLength) {
  const count = textarea.value.length;
  countElement.textContent = `${count} / ${maxLength}æ–‡å­—`;
  
  countElement.classList.remove('warning', 'danger');
  if (count > maxLength * 0.9) {
    countElement.classList.add('danger');
  } else if (count > maxLength * 0.7) {
    countElement.classList.add('warning');
  }
}

if (reasonTextarea && reasonCharCount) {
  updateCharCount(reasonTextarea, reasonCharCount, 3000);
  reasonTextarea.addEventListener('input', function() {
    updateCharCount(this, reasonCharCount, 3000);
  });
}

if (memoTextarea && memoCharCount) {
  updateCharCount(memoTextarea, memoCharCount, 1000);
  memoTextarea.addEventListener('input', function() {
    updateCharCount(this, memoCharCount, 1000);
  });
}

// ============================================
// åˆå›è³¼å…¥æƒ…å ±ã®è¡¨ç¤º/éè¡¨ç¤º
// ============================================
const addInitialPurchaseCheckbox = document.getElementById('id_add_initial_purchase');
const initialPurchaseSection = document.getElementById('initialPurchaseSection');

if (addInitialPurchaseCheckbox && initialPurchaseSection) {
  addInitialPurchaseCheckbox.addEventListener('change', function() {
    if (this.checked) {
      initialPurchaseSection.style.display = 'block';
      initialPurchaseSection.classList.add('active');
      updateRequiredFields(true);
    } else {
      initialPurchaseSection.style.display = 'none';
      initialPurchaseSection.classList.remove('active');
      updateRequiredFields(false);
    }
  });
}

function updateRequiredFields(required) {
  const tradeTypeField = document.getElementById('id_initial_trade_type');
  const dateField = document.getElementById('id_initial_purchase_date');
  const priceField = document.getElementById('id_initial_purchase_price');
  const quantityField = document.getElementById('id_initial_purchase_quantity');
  
  [tradeTypeField, dateField, priceField, quantityField].forEach(field => {
    if (field) {
      if (required) {
        field.setAttribute('required', 'required');
      } else {
        field.removeAttribute('required');
        if (field.id !== 'id_initial_trade_type') {
          field.value = '';
        }
      }
    }
  });
  
  if (!required) {
    const preview = document.getElementById('initial-purchase-preview');
    if (preview) {
      preview.style.display = 'none';
    }
  }
}

// ============================================
// åˆè¨ˆé‡‘é¡ã®è¨ˆç®—
// ============================================
function updateInitialPurchasePreview() {
  const priceField = document.getElementById('id_initial_purchase_price');
  const quantityField = document.getElementById('id_initial_purchase_quantity');
  const checkbox = document.getElementById('id_add_initial_purchase');
  const preview = document.getElementById('initial-purchase-preview');
  const amountElement = document.getElementById('initial-purchase-amount');
  
  if (!priceField || !quantityField || !checkbox || !preview || !amountElement) return;
  
  const price = parseFloat(priceField.value) || 0;
  const quantity = parseFloat(quantityField.value) || 0;
  
  if (price > 0 && quantity > 0 && checkbox.checked) {
    const amount = price * quantity;
    amountElement.textContent = amount.toLocaleString('ja-JP', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });
    preview.style.display = 'block';
  } else {
    preview.style.display = 'none';
  }
}

const priceField = document.getElementById('id_initial_purchase_price');
const quantityField = document.getElementById('id_initial_purchase_quantity');

if (priceField) {
  priceField.addEventListener('input', updateInitialPurchasePreview);
}

if (quantityField) {
  quantityField.addEventListener('input', updateInitialPurchasePreview);
}

// ============================================
// ç¾åœ¨æ ªä¾¡å–å¾—
// ============================================
const fetchCurrentPriceBtn = document.getElementById('fetch-current-price');
if (fetchCurrentPriceBtn) {
  fetchCurrentPriceBtn.addEventListener('click', async function() {
    const stockCode = stockSymbolInput.value.trim();
    const priceInput = document.getElementById('id_initial_purchase_price');
    
    if (!stockCode) {
      alert('éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      stockSymbolInput.focus();
      return;
    }
    
    fetchCurrentPriceBtn.disabled = true;
    fetchCurrentPriceBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    try {
      const response = await fetch(`/stockdiary/api/stock/price/${stockCode}/`);
      
      if (!response.ok) {
        throw new Error('æ ªä¾¡ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      
      const data = await response.json();
      
      if (data.success && data.price) {
        priceInput.value = parseFloat(data.price).toFixed(2);
        updateInitialPurchasePreview();
        showNotification('success', 'ç¾åœ¨æ ªä¾¡ã‚’å–å¾—ã—ã¾ã—ãŸ');
      } else {
        throw new Error('æ ªä¾¡æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      }
      
    } catch (error) {
      console.error('Price fetch error:', error);
      showNotification('error', error.message);
    } finally {
      fetchCurrentPriceBtn.disabled = false;
      fetchCurrentPriceBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i>';
    }
  });
}

// ============================================
// ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
// ============================================
const imageInput = document.getElementById('id_image');
const imagePreviewContainer = document.getElementById('image-preview-container');
const imagePreview = document.getElementById('image-preview');
const removeImageBtn = document.getElementById('remove-image');

if (imageInput) {
  imageInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    
    if (file) {
      if (file.size > 10 * 1024 * 1024) {
        alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
        imageInput.value = '';
        return;
      }
      
      const validFormats = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
      if (!validFormats.includes(file.type)) {
        alert('JPEGã€PNGã€GIFã€WebPå½¢å¼ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™');
        imageInput.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        imagePreviewContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  });
}

if (removeImageBtn) {
  removeImageBtn.addEventListener('click', function() {
    imageInput.value = '';
    imagePreviewContainer.style.display = 'none';
    imagePreview.src = '';
  });
}

// ============================================
// åˆ†æãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå±•é–‹
// ============================================
const analysisTemplateSelect = document.getElementById('id_analysis_template');
const expandAnalysisBtn = document.getElementById('expandAnalysisBtn');
const analysisItemsContainer = document.getElementById('analysisItemsContainer');
const analysisItemsContent = document.getElementById('analysisItemsContent');

if (expandAnalysisBtn) {
  expandAnalysisBtn.addEventListener('click', function() {
    const templateId = analysisTemplateSelect.value;
    
    if (!templateId) {
      alert('åˆ†æãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
      analysisTemplateSelect.focus();
      return;
    }
    
    analysisItemsContainer.classList.remove('d-none');
    loadAnalysisItems(templateId);
  });
}

if (analysisTemplateSelect) {
  analysisTemplateSelect.addEventListener('change', function() {
    if (this.value && !analysisItemsContainer.classList.contains('d-none')) {
      loadAnalysisItems(this.value);
    }
  });
}

async function loadAnalysisItems(templateId) {
  analysisItemsContent.innerHTML = `
    <div class="text-center py-3">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
      </div>
      <div class="mt-2">åˆ†æé …ç›®ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
    </div>
  `;
  
  try {
    const diaryId = '{{ form.instance.pk|default:"" }}';
    
    let url = `/analysis_template/api/items/?template_id=${templateId}`;
    
    if (diaryId) {
      url += `&diary_id=${diaryId}`;
    }
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error('åˆ†æé …ç›®ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.error || 'åˆ†æé …ç›®ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
    renderAnalysisItems(data.items, data.values || {});
    
  } catch (error) {
    console.error('Analysis items fetch error:', error);
    analysisItemsContent.innerHTML = `
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        åˆ†æé …ç›®ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}
        <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="loadAnalysisItems(${templateId})">
          <i class="bi bi-arrow-clockwise"></i> å†è©¦è¡Œ
        </button>
      </div>
    `;
  }
}


function renderAnalysisItems(items, values = {}) {
  if (!items || items.length === 0) {
    analysisItemsContent.innerHTML = `
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã¯åˆ†æé …ç›®ãŒã‚ã‚Šã¾ã›ã‚“
      </div>
    `;
    return;
  }
  
  let html = '';
  
  items.forEach((item, index) => {
    const existingValue = values[item.id];
    
    let icon = 'bi-circle';
    if (item.item_type === 'boolean') icon = 'bi-check-circle';
    else if (item.item_type === 'boolean_with_value') icon = 'bi-check-square';
    else if (item.item_type === 'number') icon = 'bi-123';
    else if (item.item_type === 'select') icon = 'bi-list-ul';
    else if (item.item_type === 'text') icon = 'bi-text-left';
    
    html += `<div class="analysis-item">`;
    
    if (item.item_type === 'boolean') {
      const checked = existingValue === true ? 'checked' : '';
      
      html += `
        <div class="analysis-item-header">
          <div class="analysis-item-label-wrapper">
            <i class="bi ${icon} text-primary"></i>
            <div>
              <label class="analysis-item-label" for="analysis_item_${item.id}">
                ${escapeHtml(item.name)}
              </label>
              ${item.description ? `<div class="analysis-item-desc">${escapeHtml(item.description)}</div>` : ''}
            </div>
          </div>
          <div class="analysis-item-checkbox">
            <div class="form-check">
              <input type="checkbox" 
                     class="form-check-input" 
                     name="analysis_item_${item.id}" 
                     id="analysis_item_${item.id}"
                     ${checked}>
            </div>
          </div>
        </div>
      `;
      
    } else if (item.item_type === 'boolean_with_value') {
      const boolChecked = existingValue?.boolean_value === true ? 'checked' : '';
      const numberValue = existingValue?.number_value ?? '';
      const valueLabel = item.value_label || 'å€¤';
      
      html += `
        <div class="analysis-item-header">
          <div class="analysis-item-label-wrapper">
            <i class="bi ${icon} text-primary"></i>
            <div>
              <label class="analysis-item-label">
                ${escapeHtml(item.name)}
              </label>
              ${item.description ? `<div class="analysis-item-desc">${escapeHtml(item.description)}</div>` : ''}
            </div>
          </div>
        </div>
        
        <div class="compound-input-wrapper">
          <div class="compound-checkbox-row">
            <input type="checkbox" 
                   class="form-check-input" 
                   name="analysis_item_${item.id}_boolean" 
                   id="analysis_item_${item.id}_boolean"
                   ${boolChecked}>
            <label class="form-check-label" for="analysis_item_${item.id}_boolean">
              è©²å½“ã™ã‚‹
            </label>
          </div>
          <div>
            <label class="form-label">${escapeHtml(valueLabel)}</label>
            <input type="number" 
                   class="form-control" 
                   name="analysis_item_${item.id}_value" 
                   id="analysis_item_${item.id}_value"
                   step="0.01"
                   placeholder="æ•°å€¤ã‚’å…¥åŠ›"
                   value="${numberValue}">
          </div>
        </div>
      `;
      
    } else if (item.item_type === 'number') {
      const value = existingValue ?? '';
      
      html += `
        <div class="analysis-item-header">
          <div class="analysis-item-label-wrapper">
            <i class="bi ${icon} text-primary"></i>
            <div>
              <label class="analysis-item-label" for="analysis_item_${item.id}">
                ${escapeHtml(item.name)}
              </label>
              ${item.description ? `<div class="analysis-item-desc">${escapeHtml(item.description)}</div>` : ''}
            </div>
          </div>
        </div>
        <div class="analysis-item-input-section">
          <input type="number" 
                 class="form-control" 
                 name="analysis_item_${item.id}" 
                 id="analysis_item_${item.id}"
                 step="0.01"
                 placeholder="æ•°å€¤ã‚’å…¥åŠ›"
                 value="${value}">
        </div>
      `;
      
    } else if (item.item_type === 'select') {
      html += `
        <div class="analysis-item-header">
          <div class="analysis-item-label-wrapper">
            <i class="bi ${icon} text-primary"></i>
            <div>
              <label class="analysis-item-label" for="analysis_item_${item.id}">
                ${escapeHtml(item.name)}
              </label>
              ${item.description ? `<div class="analysis-item-desc">${escapeHtml(item.description)}</div>` : ''}
            </div>
          </div>
        </div>
        <div class="analysis-item-input-section">
          <select class="form-select" 
                  name="analysis_item_${item.id}" 
                  id="analysis_item_${item.id}">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      `;
      
      let choicesList = [];
      if (item.choices) {
        if (Array.isArray(item.choices)) {
          choicesList = item.choices;
        } else if (typeof item.choices === 'string') {
          choicesList = item.choices.split(',').map(c => c.trim()).filter(c => c);
        }
      }
      
      choicesList.forEach(choice => {
        const selected = existingValue === choice ? 'selected' : '';
        html += `<option value="${escapeHtml(choice)}" ${selected}>${escapeHtml(choice)}</option>`;
      });
      
      html += `</select></div>`;
      
    } else {
      const value = existingValue ?? '';
      html += `
        <div class="analysis-item-header">
          <div class="analysis-item-label-wrapper">
            <i class="bi ${icon} text-primary"></i>
            <div>
              <label class="analysis-item-label" for="analysis_item_${item.id}">
                ${escapeHtml(item.name)}
              </label>
              ${item.description ? `<div class="analysis-item-desc">${escapeHtml(item.description)}</div>` : ''}
            </div>
          </div>
        </div>
        <div class="analysis-item-input-section">
          <input type="text" 
                 class="form-control" 
                 name="analysis_item_${item.id}" 
                 id="analysis_item_${item.id}"
                 placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›"
                 value="${escapeHtml(value)}">
        </div>
      `;
    }
    
    html += `</div>`;
  });
  
  analysisItemsContent.innerHTML = html;
}


// ============================================
// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
// ============================================
const form = document.getElementById('diaryForm');
if (form) {
  form.addEventListener('submit', function(e) {
    const checkbox = document.getElementById('id_add_initial_purchase');
    
    if (checkbox && checkbox.checked) {
      const errors = validateInitialPurchase();
      
      if (errors.length > 0) {
        e.preventDefault();
        alert('å…¥åŠ›ã‚¨ãƒ©ãƒ¼:\n' + errors.join('\n'));
        return false;
      }
    }
    
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>ä¿å­˜ä¸­...';
    }
  });
}

function validateInitialPurchase() {
  const errors = [];
  const tradeTypeField = document.getElementById('id_initial_trade_type');
  const dateField = document.getElementById('id_initial_purchase_date');
  const priceField = document.getElementById('id_initial_purchase_price');
  const quantityField = document.getElementById('id_initial_purchase_quantity');
  
  if (!tradeTypeField.value) {
    errors.push('å–å¼•åŒºåˆ†ã‚’é¸æŠã—ã¦ãã ã•ã„');
  }
  
  if (!dateField.value) {
    errors.push('è³¼å…¥æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  }
  
  const price = parseFloat(priceField.value);
  if (!price || price <= 0) {
    errors.push('è³¼å…¥å˜ä¾¡ã¯æ­£ã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  }
  
  const quantity = parseFloat(quantityField.value);
  if (!quantity || quantity <= 0) {
    errors.push('è³¼å…¥æ•°é‡ã¯æ­£ã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  }
  
  return errors;
}

// ============================================
// åˆæœŸåŒ–å‡¦ç†
// ============================================
if (addInitialPurchaseCheckbox && addInitialPurchaseCheckbox.checked) {
  updateInitialPurchasePreview();
}

const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl);
});
});

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

</script>
{% endblock %}