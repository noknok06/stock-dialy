{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}日記の編集{% else %}新規日記作成{% endif %} | カブログ{% endblock %}

{% block head %}
{{ block.super }}
<!-- コンポーネントCSS -->
<link rel="stylesheet" href="{% static 'css/3-components/components.css' %}">
<link rel="stylesheet" href="{% static 'css/3-components/dark-mode-components.css' %}">

<style>
  /* ========== ページ固有スタイル ========== */
  
  /* 日記らしいテキストエリア */
  .diary-textarea {
    font-family: 'Hiragino Kaku Gothic Pro', 'メイリオ', sans-serif;
    line-height: 1.8;
    padding: 1rem;
    border-radius: var(--radius-md);
    background-color: #fefefe;
    background-image: linear-gradient(transparent 1.7rem, #e5e7eb 1.7rem, #e5e7eb 1.8rem, transparent 1.8rem);
    background-size: 100% 1.8rem;
    min-height: 200px;
  }

  .dark-mode .diary-textarea,
  [data-theme="dark"] .diary-textarea {
    background-color: var(--dm-card);
    background-image: linear-gradient(transparent 1.7rem, #52626d 1.7rem, #0e2147 1.8rem, transparent 1.8rem);
  }

  .diary-memo-textarea {
    font-family: 'Hiragino Kaku Gothic Pro', 'メイリオ', sans-serif;
    line-height: 1.8;
    padding: 1rem;
    border-radius: var(--radius-md);
    background-color: #fffef5;
    border: 2px solid var(--warning-color);
    min-height: 150px;
  }

  .dark-mode .diary-memo-textarea,
  [data-theme="dark"] .diary-memo-textarea {
    background-color: rgba(251, 191, 36, 0.1);
  }

  /* 初回購入セクション */
  .initial-purchase-section {
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-top: 1rem;
  }

  .initial-purchase-section.active {
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* 文字数カウンター */
  .character-count {
    font-size: 0.875rem;
    color: var(--text-muted);
    text-align: right;
    margin-top: 0.25rem;
  }

  .character-count.warning {
    color: var(--warning-color);
  }

  .character-count.danger {
    color: var(--danger-color);
  }

  /* ========== 分析項目のレイアウト ========== */
  .analysis-item {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s ease;
  }

  .analysis-item:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-sm);
  }

  .analysis-item-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
  }

  .analysis-item-label-wrapper {
    display: flex;
    align-items: flex-start;
    flex: 1;
    min-width: 0;
  }

  .analysis-item-label-wrapper i {
    flex-shrink: 0;
    margin-right: 0.5rem;
    margin-top: 0.25rem;
    color: var(--primary-color);
  }

  .analysis-item-label {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--text-primary);
    margin: 0;
    cursor: pointer;
    line-height: 1.4;
  }

  .analysis-item-desc {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
    line-height: 1.4;
  }

  .analysis-item-checkbox .form-check-input {
    width: 1.5rem;
    height: 1.5rem;
    margin: 0;
    cursor: pointer;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
  }

  .analysis-item-checkbox .form-check-input:checked {
    background-color: var(--success-color);
    border-color: var(--success-color);
  }

  .analysis-item-input-section {
    margin-top: 0.75rem;
  }

  /* デスクトップでの横幅制限 */
  @media (min-width: 768px) {
    .analysis-item .form-control[type="number"] {
      max-width: 200px;
    }
    
    .analysis-item .form-control[type="text"] {
      max-width: 400px;
    }
    
    .analysis-item .form-select {
      max-width: 300px;
    }
  }

  /* ダークモード */
  .dark-mode .analysis-item,
  [data-theme="dark"] .analysis-item {
    background: var(--dm-card);
    border-color: var(--dm-border);
  }

  .dark-mode .analysis-item:hover,
  [data-theme="dark"] .analysis-item:hover {
    border-color: var(--dm-primary);
  }

  .dark-mode .analysis-item-label,
  [data-theme="dark"] .analysis-item-label {
    color: var(--dm-foreground);
  }

  .dark-mode .analysis-item-desc,
  [data-theme="dark"] .analysis-item-desc {
    color: var(--dm-muted-foreground);
  }

  .dark-mode .input-group-text,
  [data-theme="dark"] .input-group-text {
    background-color: var(--dm-card);
    color: var(--dm-foreground);
    border-color: var(--dm-border);
  }

  .dark-mode .form-control[type="file"],
  [data-theme="dark"] .form-control[type="file"] {
    background-color: var(--dm-card);
    color: var(--dm-foreground);
    border-color: var(--dm-border);
  }

  .dark-mode .form-control[type="file"]::file-selector-button,
  [data-theme="dark"] .form-control[type="file"]::file-selector-button {
    background-color: var(--dm-muted);
    color: var(--dm-foreground);
    border: 1px solid var(--dm-border);
  }

  .dark-mode .tooltip-inner,
  [data-theme="dark"] .tooltip-inner {
    background-color: var(--dm-card);
    color: var(--dm-foreground);
  }

  /* タッチデバイス対応 */
  @media (hover: none) and (pointer: coarse) {
    .analysis-item-checkbox .form-check-input {
      width: 1.75rem;
      height: 1.75rem;
    }
    
    .analysis-item-label {
      padding: 0.5rem 0;
      min-height: 44px;
      display: flex;
      align-items: center;
    }

    .analysis-item .form-control,
    .analysis-item .form-select {
      min-height: 44px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="title_header">
    <h1 class="page-title">
      <i class="bi bi-journal-text"></i> {% if form.instance.pk %}日記の編集{% else %}新規日記作成{% endif %}
    </h1>
  </div>

  <!-- 情報ボックス（コンポーネント使用） -->
  {% if not form.instance.pk %}
  {% include "stockdiary/components/_alert.html" with type="info" icon="bi-info-circle" message="<strong>投資日記について:</strong> 投資判断の理由や気づいたことを自由に記録できます。後から「取引履歴」タブで実際の売買を記録することもできます。" %}
  {% endif %}

  <!-- フォームカード -->
  <div class="diary-form">
    <div class="form-body">
      <form method="post" enctype="multipart/form-data" id="diaryForm">
        {% csrf_token %}

        <!-- 株式情報セクション -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="bi bi-graph-up"></i> 銘柄情報
          </h4>

          <!-- 株価情報カード（銘柄検索後に表示） -->
          <div class="info-block d-none" id="stockInfoCard">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0" id="stockInfoTitle">会社情報</h5>
              <span id="stockInfoCode"></span>
            </div>
            <div class="info-row">
              <div class="info-item">
                <div class="info-icon"><i class="bi bi-currency-yen"></i></div>
                <div class="info-content">
                  <span class="info-label">現在株価</span>
                  <span class="info-value" id="stockInfoPrice">--</span>
                </div>
              </div>
              <div class="info-item">
                <div class="info-icon"><i class="bi bi-graph-up-arrow"></i></div>
                <div class="info-content">
                  <span class="info-label">前日比</span>
                  <span class="info-value" id="stockInfoChange">--</span>
                </div>
              </div>
              <div class="info-item">
                <div class="info-icon"><i class="bi bi-building"></i></div>
                <div class="info-content">
                  <span class="info-label">市場</span>
                  <span class="info-value" id="stockInfoMarket">--</span>
                </div>
              </div>
              <div class="info-item">
                <div class="info-icon"><i class="bi bi-diagram-3"></i></div>
                <div class="info-content">
                  <span class="info-label">業種</span>
                  <span class="info-value" id="stockInfoIndustry">--</span>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.stock_symbol.id_for_label }}" class="form-label">
                <i class="bi bi-hash me-1"></i>{{ form.stock_symbol.label }}
              </label>
              <div class="input-group">
                {{ form.stock_symbol }}
                <button type="button" class="btn btn-primary" id="fetchStockInfo">
                  <i class="bi bi-search"></i> 検索
                </button>
              </div>
              <!-- ローディング（コンポーネント使用） -->
              <div class="d-none" id="symbolSpinnerContainer">
                {% include "stockdiary/components/_loading.html" with text="会社情報を取得中..." inline=True size="sm" %}
              </div>
              <small class="form-text text-muted">{{ form.stock_symbol.help_text }}</small>
              {% if form.stock_symbol.errors %}
              <div class="text-danger">{{ form.stock_symbol.errors }}</div>
              {% endif %}
            </div>

            <div class="col-md-6 mb-3">
              <label for="{{ form.stock_name.id_for_label }}" class="form-label">
                <i class="bi bi-building me-1"></i>銘柄名/メモタイトル<span class="text-danger">*</span>
              </label>
              {{ form.stock_name }}
              <small class="form-text text-muted">株式の場合は銘柄名、メモの場合はタイトルを入力</small>
              {% if form.stock_name.errors %}
              <div class="text-danger">{{ form.stock_name.errors }}</div>
              {% endif %}
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.sector.id_for_label }}" class="form-label">
                <i class="bi bi-diagram-3 me-1"></i>業種
              </label>
              <div class="input-group">
                {{ form.sector }}
                <span class="input-group-text">
                  <i class="bi bi-info-circle" data-bs-toggle="tooltip" 
                     title="銘柄コードを検索すると自動設定されます"></i>
                </span>
              </div>
              <small class="form-text text-muted">業種情報は銘柄検索時に自動設定されます</small>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.tags.id_for_label }}" class="form-label">
                <i class="bi bi-tags me-1"></i>タグ
              </label>
              {{ form.tags }}
              <small class="form-text text-muted">複数選択可能です</small>
            </div>
          </div>
        </div>

        <!-- 投資理由セクション -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="bi bi-journal-text"></i> 投資理由・分析内容
          </h4>
          <textarea class="form-control diary-textarea" 
                    name="reason" 
                    id="{{ form.reason.id_for_label }}"
                    rows="10"
                    placeholder="なぜこの銘柄に注目したのか、どのような分析をしたのか、将来の見通しなどを自由に記録してください...

例:
・決算が好調で増益傾向にある
・新製品の発売が控えており期待できる
・PERが同業他社と比べて割安
・配当利回りが高い
・技術的に強いサポートラインがある"
                    maxlength="3000">{{ form.reason.value|default:'' }}</textarea>
          <div class="character-count" id="reasonCharCount">0 / 3000文字</div>
          {% if form.reason.errors %}
          <div class="text-danger small mt-1">{{ form.reason.errors }}</div>
          {% endif %}
        </div>

        <!-- メモセクション -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="bi bi-sticky"></i> メモ・気づいたこと
            {% include "stockdiary/components/_badge.html" with type="warning" text="メモ" icon="bi-sticky" extra_class="ms-2" %}
          </h4>
          <textarea class="form-control diary-memo-textarea" 
                    name="memo" 
                    id="{{ form.memo.id_for_label }}"
                    rows="6"
                    placeholder="その他の気づき、注意点、感想などを自由に記入してください...

例:
・経営陣の発言が気になった
・競合他社の動向もチェック必要
・次の決算発表は○月○日
・この価格帯で買い増しを検討"
                    maxlength="1000">{{ form.memo.value|default:'' }}</textarea>
          <div class="character-count" id="memoCharCount">0 / 1000文字</div>
          {% if form.memo.errors %}
          <div class="text-danger small mt-1">{{ form.memo.errors }}</div>
          {% endif %}
        </div>

        <!-- 初回購入情報セクション（新規作成時のみ） -->
        {% if not form.instance.pk %}
        <div class="form-section">
          <div class="form-check mb-3">
            <input type="checkbox" class="form-check-input" 
                   id="id_add_initial_purchase" 
                   name="add_initial_purchase"
                   {% if form.add_initial_purchase.value %}checked{% endif %}>
            <label class="form-check-label" for="id_add_initial_purchase">
              <strong>{{ form.add_initial_purchase.label }}</strong>
              <small class="d-block text-muted">
                チェックすると、日記作成と同時に最初の購入取引を記録できます
              </small>
            </label>
          </div>
        
          <div class="initial-purchase-section" id="initialPurchaseSection" 
               {% if not form.add_initial_purchase.value %}style="display: none;"{% endif %}>
            
            <!-- 情報アラート（コンポーネント使用） -->
            {% include "stockdiary/components/_alert.html" with type="info" icon="bi-info-circle" message="<strong>初回購入について:</strong><ul class='mb-0 mt-2 small'><li>日記作成後、「取引履歴」タブから追加購入・売却を記録できます</li><li>まだ購入していない場合は、チェックを外してください</li><li>後から「取引履歴」タブで追加できます</li></ul>" %}
        
            <h6 class="mb-3">
              <i class="bi bi-cart-plus"></i> 初回購入情報
            </h6>
        
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="id_initial_purchase_date" class="form-label">
                  <i class="bi bi-calendar-date me-1"></i>購入日<span class="text-danger">*</span>
                </label>
                <input type="date" 
                       class="form-control" 
                       id="id_initial_purchase_date"
                       name="initial_purchase_date"
                       value="{{ form.initial_purchase_date.value|default:'' }}">
                {% if form.initial_purchase_date.errors %}
                <div class="text-danger small">{{ form.initial_purchase_date.errors }}</div>
                {% endif %}
              </div>
        
              <div class="col-md-4 mb-3">
                <label for="id_initial_purchase_price" class="form-label">
                  <i class="bi bi-currency-yen me-1"></i>購入単価（円）<span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <input type="number" 
                         class="form-control" 
                         id="id_initial_purchase_price"
                         name="initial_purchase_price"
                         step="0.01" 
                         min="0.01"
                         placeholder="例: 1000.00"
                         value="{{ form.initial_purchase_price.value|default:'' }}">
                  <button type="button" class="btn btn-outline-primary" 
                          id="fetch-current-price" title="現在株価を取得">
                    <i class="bi bi-arrow-repeat"></i> 現在株価
                  </button>
                </div>
                <small class="form-text text-muted">1株あたりの単価</small>
                {% if form.initial_purchase_price.errors %}
                <div class="text-danger small">{{ form.initial_purchase_price.errors }}</div>
                {% endif %}
              </div>
        
              <div class="col-md-4 mb-3">
                <label for="id_initial_purchase_quantity" class="form-label">
                  <i class="bi bi-stack me-1"></i>購入数量（株）<span class="text-danger">*</span>
                </label>
                <input type="number" 
                       class="form-control"
                       id="id_initial_purchase_quantity"
                       name="initial_purchase_quantity"
                       step="1" 
                       min="1"
                       placeholder="例: 100"
                       value="{{ form.initial_purchase_quantity.value|default:'' }}">
                <small class="form-text text-muted">取引株数</small>
                {% if form.initial_purchase_quantity.errors %}
                <div class="text-danger small">{{ form.initial_purchase_quantity.errors }}</div>
                {% endif %}
              </div>
            </div>
        
            <!-- 合計金額の表示（コンポーネント使用） -->
            <div id="initial-purchase-preview" style="display: none;">
              {% include "stockdiary/components/_alert.html" with type="success" icon="bi-calculator" %}
              <div class="alert alert-success d-flex justify-content-between align-items-center">
                <strong><i class="bi bi-calculator me-2"></i>初回購入金額:</strong>
                <span id="initial-purchase-amount" class="fs-5 fw-bold">0</span>円
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- 画像セクション -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="bi bi-image"></i> 画像添付（任意）
          </h4>

          <div class="mb-3">
            <label for="id_image" class="form-label">
              <i class="bi bi-cloud-upload me-1"></i>画像ファイル
            </label>
            {{ form.image }}
            <small class="form-text text-muted">
              チャート、スクリーンショット等（最大10MB、JPEG/PNG/GIF/WebP形式）
            </small>

            <!-- 画像プレビュー -->
            <div id="image-preview-container" class="mt-3" style="display: none;">
              <div class="card" style="max-width: 300px;">
                <img id="image-preview" class="card-img-top" 
                     style="max-height: 200px; object-fit: cover;" alt="プレビュー">
                <div class="card-body p-2">
                  <small class="text-muted">プレビュー</small>
                  <button type="button" id="remove-image" class="btn btn-sm btn-outline-danger float-end">
                    <i class="bi bi-x"></i> 削除
                  </button>
                </div>
              </div>
            </div>

            <!-- 既存画像（編集時） -->
            {% if form.instance.image_url %}
            <div class="mt-3">
              <div class="card" style="max-width: 300px;">
                <img src="{{ form.instance.image_url }}" class="card-img-top"
                     style="max-height: 200px; object-fit: cover;" alt="現在の画像">
                <div class="card-body p-2">
                  <small class="text-muted">現在の画像</small>
                  <div class="form-check mt-1">
                    <input type="checkbox" id="clear-image" name="clear_image" class="form-check-input">
                    <label for="clear-image" class="form-check-label small">
                      この画像を削除する
                    </label>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- フッター -->
        <div class="form-footer">
          <a href="{% if form.instance.pk %}{% url 'stockdiary:detail' form.instance.pk %}{% else %}{% url 'stockdiary:home' %}{% endif %}"
             class="btn btn-diary btn-diary-outline">
            <i class="bi bi-arrow-left me-1"></i> キャンセル
          </a>
          <button type="submit" class="btn btn-diary btn-diary-primary" id="submitBtn">
            <i class="bi bi-save me-1"></i> 保存
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% include 'speed_dial.html' with actions=form_actions %}
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>

document.addEventListener('DOMContentLoaded', function() {

// ============================================
// オートコンプリート機能
// ============================================
const stockSymbolInput = document.getElementById('id_stock_symbol');
let autocompleteTimeout;
let autocompleteResults = [];
let selectedIndex = -1;

if (stockSymbolInput) {
  // オートコンプリート用の結果表示エリアを作成
  const autocompleteContainer = document.createElement('div');
  autocompleteContainer.id = 'autocomplete-results';
  autocompleteContainer.className = 'autocomplete-results';
  autocompleteContainer.style.cssText = `
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 300px;
    overflow-y: auto;
    background: var(--card-bg, white);
    border: 1px solid var(--border-color, #d1d5db);
    border-radius: var(--radius-md, 0.375rem);
    box-shadow: var(--shadow-lg, 0 4px 6px rgba(0, 0, 0, 0.1));
    z-index: 1000;
    display: none;
  `;
  
  // 入力グループの親要素に追加
  const inputGroup = stockSymbolInput.closest('.input-group');
  if (inputGroup) {
    inputGroup.style.position = 'relative';
    inputGroup.appendChild(autocompleteContainer);
  }
  
  // 入力時のオートコンプリート
  stockSymbolInput.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    clearTimeout(autocompleteTimeout);
    
    if (query.length < 2) {
      autocompleteContainer.style.display = 'none';
      return;
    }
    
    // 300ms後に検索実行
    autocompleteTimeout = setTimeout(async () => {
      try {
        const response = await fetch(`/stockdiary/api/stock/search/?query=${encodeURIComponent(query)}&limit=10`);
        const data = await response.json();
        
        if (data.success && data.companies.length > 0) {
          autocompleteResults = data.companies;
          displayAutocompleteResults(data.companies);
        } else {
          autocompleteContainer.style.display = 'none';
        }
      } catch (error) {
        console.error('Autocomplete error:', error);
        autocompleteContainer.style.display = 'none';
      }
    }, 300);
  });
  
  // 結果を表示
  function displayAutocompleteResults(companies) {
    let html = '<div class="list-group list-group-flush">';
    
    companies.forEach((company, index) => {
      html += `
        <button type="button" 
                class="list-group-item list-group-item-action autocomplete-item" 
                data-index="${index}"
                style="border: none; padding: 0.75rem 1rem; cursor: pointer; text-align: left;">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong class="text-primary">${escapeHtml(company.code)}</strong>
              <span class="ms-2">${escapeHtml(company.name)}</span>
            </div>
            <div style="text-align: right;">
              <small class="text-muted d-block">${escapeHtml(company.market)}</small>
              <small class="text-muted d-block">${escapeHtml(company.industry)}</small>
            </div>
          </div>
        </button>
      `;
    });
    
    html += '</div>';
    autocompleteContainer.innerHTML = html;
    autocompleteContainer.style.display = 'block';
    
    // クリックイベント設定
    const items = autocompleteContainer.querySelectorAll('.autocomplete-item');
    items.forEach(item => {
      item.addEventListener('click', function() {
        const index = parseInt(this.dataset.index);
        selectCompany(autocompleteResults[index]);
      });
      
      item.addEventListener('mouseenter', function() {
        this.style.backgroundColor = 'var(--bg-hover, #f3f4f6)';
      });
      item.addEventListener('mouseleave', function() {
        this.style.backgroundColor = 'var(--card-bg, white)';
      });
    });
  }
  
  // 企業選択
  function selectCompany(company) {
    stockSymbolInput.value = company.code;
    
    const stockNameInput = document.getElementById('id_stock_name');
    const sectorInput = document.getElementById('id_sector');
    
    if (stockNameInput && !stockNameInput.value) {
      stockNameInput.value = company.name;
    }
    
    if (sectorInput && !sectorInput.value) {
      sectorInput.value = company.industry;
    }
    
    autocompleteContainer.style.display = 'none';
    selectedIndex = -1;
    
    // 株価情報を自動取得
    const fetchStockInfoBtn = document.getElementById('fetchStockInfo');
    if (fetchStockInfoBtn) {
      fetchStockInfoBtn.click();
    }
  }
  
  // キーボード操作
  stockSymbolInput.addEventListener('keydown', function(e) {
    const items = autocompleteContainer.querySelectorAll('.autocomplete-item');
    
    if (items.length === 0) return;
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
      updateSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, -1);
      updateSelection(items);
    } else if (e.key === 'Enter' && selectedIndex >= 0) {
      e.preventDefault();
      const index = parseInt(items[selectedIndex].dataset.index);
      selectCompany(autocompleteResults[index]);
    } else if (e.key === 'Escape') {
      autocompleteContainer.style.display = 'none';
      selectedIndex = -1;
    }
  });
  
  function updateSelection(items) {
    items.forEach((item, index) => {
      if (index === selectedIndex) {
        item.style.backgroundColor = 'var(--primary-light, #dbeafe)';
        item.scrollIntoView({ block: 'nearest' });
      } else {
        item.style.backgroundColor = 'var(--card-bg, white)';
      }
    });
  }
  
  // 外側クリックで閉じる
  document.addEventListener('click', function(e) {
    if (!stockSymbolInput.contains(e.target) && !autocompleteContainer.contains(e.target)) {
      autocompleteContainer.style.display = 'none';
      selectedIndex = -1;
    }
  });
}

const fetchStockInfoBtn = document.getElementById('fetchStockInfo');
const stockNameInput = document.getElementById('id_stock_name');
const sectorInput = document.getElementById('id_sector');
const stockInfoCard = document.getElementById('stockInfoCard');
const symbolSpinnerContainer = document.getElementById('symbolSpinnerContainer');

if (fetchStockInfoBtn) {
  fetchStockInfoBtn.addEventListener('click', async function() {
    const stockCode = stockSymbolInput.value.trim();
    
    if (!stockCode) {
      alert('銘柄コードを入力してください');
      stockSymbolInput.focus();
      return;
    }
    
    fetchStockInfoBtn.disabled = true;
    fetchStockInfoBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    symbolSpinnerContainer.classList.remove('d-none');
    stockInfoCard.classList.add('d-none');
    
    try {
      const response = await fetch(`/stockdiary/api/stock/info/${stockCode}/`);
      
      if (!response.ok) {
        throw new Error('株式情報の取得に失敗しました');
      }
      
      const data = await response.json();
      
      if (data.success) {
        if (data.company_name) {
          stockNameInput.value = data.company_name;
        }
        
        if (data.industry && data.industry !== '不明') {
          sectorInput.value = data.industry;
        }
        
        displayStockInfo(data, stockCode);
        showNotification('success', '銘柄情報を取得しました');
      } else {
        throw new Error(data.error || '銘柄情報の取得に失敗しました');
      }
      
    } catch (error) {
      console.error('Stock info fetch error:', error);
      showNotification('error', error.message);
      stockInfoCard.classList.add('d-none');
    } finally {
      fetchStockInfoBtn.disabled = false;
      fetchStockInfoBtn.innerHTML = '<i class="bi bi-search"></i> 検索';
      symbolSpinnerContainer.classList.add('d-none');
    }
  });
}

// 株式情報表示
function displayStockInfo(data, stockCode) {
  document.getElementById('stockInfoTitle').textContent = data.company_name || '銘柄情報';
  document.getElementById('stockInfoCode').textContent = stockCode;
  document.getElementById('stockInfoCode').className = 'badge badge-primary';
  
  if (data.price !== null && data.price !== undefined) {
    document.getElementById('stockInfoPrice').textContent = 
      `${parseFloat(data.price).toLocaleString('ja-JP', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      })}円`;
  } else {
    document.getElementById('stockInfoPrice').textContent = '取得できませんでした';
  }
  
  if (data.change_percent !== null && data.change_percent !== undefined) {
    const changeElement = document.getElementById('stockInfoChange');
    const changePercent = parseFloat(data.change_percent);
    const changeClass = changePercent > 0 ? 'profit-positive' : 
                       (changePercent < 0 ? 'profit-negative' : 'text-muted');
    const changeSign = changePercent > 0 ? '+' : '';
    
    changeElement.textContent = `${changeSign}${changePercent.toFixed(2)}%`;
    changeElement.className = `info-value ${changeClass}`;
  } else {
    document.getElementById('stockInfoChange').textContent = '--';
  }
  
  document.getElementById('stockInfoMarket').textContent = data.market || '不明';
  document.getElementById('stockInfoIndustry').textContent = data.industry || '不明';
  
  stockInfoCard.classList.remove('d-none');
}

// 通知表示
function showNotification(type, message) {
  const existingNotification = document.querySelector('.custom-notification');
  if (existingNotification) {
    existingNotification.remove();
  }
  
  const notification = document.createElement('div');
  const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
  const iconClass = type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle';
  
  notification.className = `alert ${alertClass} alert-dismissible fade show custom-notification`;
  notification.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
  notification.innerHTML = `
    <i class="bi ${iconClass} me-2"></i>
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

// ============================================
// 文字数カウンター
// ============================================
const reasonTextarea = document.getElementById('{{ form.reason.id_for_label }}');
const memoTextarea = document.getElementById('{{ form.memo.id_for_label }}');
const reasonCharCount = document.getElementById('reasonCharCount');
const memoCharCount = document.getElementById('memoCharCount');

function updateCharCount(textarea, countElement, maxLength) {
  const count = textarea.value.length;
  countElement.textContent = `${count} / ${maxLength}文字`;
  
  countElement.classList.remove('warning', 'danger');
  if (count > maxLength * 0.9) {
    countElement.classList.add('danger');
  } else if (count > maxLength * 0.7) {
    countElement.classList.add('warning');
  }
}

if (reasonTextarea && reasonCharCount) {
  updateCharCount(reasonTextarea, reasonCharCount, 3000);
  reasonTextarea.addEventListener('input', function() {
    updateCharCount(this, reasonCharCount, 3000);
  });
}

if (memoTextarea && memoCharCount) {
  updateCharCount(memoTextarea, memoCharCount, 1000);
  memoTextarea.addEventListener('input', function() {
    updateCharCount(this, memoCharCount, 1000);
  });
}

// ============================================
// 初回購入情報の表示/非表示
// ============================================
const addInitialPurchaseCheckbox = document.getElementById('id_add_initial_purchase');
const initialPurchaseSection = document.getElementById('initialPurchaseSection');

if (addInitialPurchaseCheckbox && initialPurchaseSection) {
  addInitialPurchaseCheckbox.addEventListener('change', function() {
    if (this.checked) {
      initialPurchaseSection.style.display = 'block';
      initialPurchaseSection.classList.add('active');
      updateRequiredFields(true);
    } else {
      initialPurchaseSection.style.display = 'none';
      initialPurchaseSection.classList.remove('active');
      updateRequiredFields(false);
    }
  });
}

function updateRequiredFields(required) {
  const dateField = document.getElementById('id_initial_purchase_date');
  const priceField = document.getElementById('id_initial_purchase_price');
  const quantityField = document.getElementById('id_initial_purchase_quantity');
  
  [dateField, priceField, quantityField].forEach(field => {
    if (field) {
      if (required) {
        field.setAttribute('required', 'required');
      } else {
        field.removeAttribute('required');
        field.value = '';
      }
    }
  });
  
  if (!required) {
    const preview = document.getElementById('initial-purchase-preview');
    if (preview) {
      preview.style.display = 'none';
    }
  }
}

// ============================================
// 合計金額の計算
// ============================================
function updateInitialPurchasePreview() {
  const priceField = document.getElementById('id_initial_purchase_price');
  const quantityField = document.getElementById('id_initial_purchase_quantity');
  const checkbox = document.getElementById('id_add_initial_purchase');
  const preview = document.getElementById('initial-purchase-preview');
  const amountElement = document.getElementById('initial-purchase-amount');
  
  if (!priceField || !quantityField || !checkbox || !preview || !amountElement) return;
  
  const price = parseFloat(priceField.value) || 0;
  const quantity = parseFloat(quantityField.value) || 0;
  
  if (price > 0 && quantity > 0 && checkbox.checked) {
    const amount = price * quantity;
    amountElement.textContent = amount.toLocaleString('ja-JP', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });
    preview.style.display = 'block';
  } else {
    preview.style.display = 'none';
  }
}

const priceField = document.getElementById('id_initial_purchase_price');
const quantityField = document.getElementById('id_initial_purchase_quantity');

if (priceField) {
  priceField.addEventListener('input', updateInitialPurchasePreview);
}

if (quantityField) {
  quantityField.addEventListener('input', updateInitialPurchasePreview);
}

// ============================================
// 現在株価取得
// ============================================
const fetchCurrentPriceBtn = document.getElementById('fetch-current-price');
if (fetchCurrentPriceBtn) {
  fetchCurrentPriceBtn.addEventListener('click', async function() {
    const stockCode = stockSymbolInput.value.trim();
    const priceInput = document.getElementById('id_initial_purchase_price');
    
    if (!stockCode) {
      alert('銘柄コードを入力してください');
      stockSymbolInput.focus();
      return;
    }
    
    fetchCurrentPriceBtn.disabled = true;
    fetchCurrentPriceBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    try {
      const response = await fetch(`/stockdiary/api/stock/price/${stockCode}/`);
      
      if (!response.ok) {
        throw new Error('株価の取得に失敗しました');
      }
      
      const data = await response.json();
      
      if (data.success && data.price) {
        priceInput.value = parseFloat(data.price).toFixed(2);
        updateInitialPurchasePreview();
        showNotification('success', '現在株価を取得しました');
      } else {
        throw new Error('株価情報が見つかりませんでした');
      }
      
    } catch (error) {
      console.error('Price fetch error:', error);
      showNotification('error', error.message);
    } finally {
      fetchCurrentPriceBtn.disabled = false;
      fetchCurrentPriceBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> 現在株価';
    }
  });
}

// ============================================
// 画像プレビュー
// ============================================
const imageInput = document.getElementById('id_image');
const imagePreviewContainer = document.getElementById('image-preview-container');
const imagePreview = document.getElementById('image-preview');
const removeImageBtn = document.getElementById('remove-image');

if (imageInput) {
  imageInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    
    if (file) {
      if (file.size > 10 * 1024 * 1024) {
        alert('画像ファイルのサイズは10MB以下にしてください');
        imageInput.value = '';
        return;
      }
      
      const validFormats = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
      if (!validFormats.includes(file.type)) {
        alert('JPEG、PNG、GIF、WebP形式の画像ファイルのみアップロード可能です');
        imageInput.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        imagePreviewContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  });
}

if (removeImageBtn) {
  removeImageBtn.addEventListener('click', function() {
    imageInput.value = '';
    imagePreviewContainer.style.display = 'none';
    imagePreview.src = '';
  });
}

// ============================================
// 分析テンプレート展開
// ============================================
const analysisTemplateSelect = document.getElementById('id_analysis_template');
const expandAnalysisBtn = document.getElementById('expandAnalysisBtn');
const analysisItemsContainer = document.getElementById('analysisItemsContainer');
const analysisItemsContent = document.getElementById('analysisItemsContent');

if (expandAnalysisBtn) {
  expandAnalysisBtn.addEventListener('click', function() {
    const templateId = analysisTemplateSelect.value;
    
    if (!templateId) {
      alert('分析テンプレートを選択してください');
      analysisTemplateSelect.focus();
      return;
    }
    
    analysisItemsContainer.classList.remove('d-none');
    loadAnalysisItems(templateId);
  });
}

if (analysisTemplateSelect) {
  analysisTemplateSelect.addEventListener('change', function() {
    if (this.value && !analysisItemsContainer.classList.contains('d-none')) {
      loadAnalysisItems(this.value);
    }
  });
}

async function loadAnalysisItems(templateId) {
  analysisItemsContent.innerHTML = `
    <div class="text-center py-3">
      <div class="loading-spinner"></div>
      <div class="loading-text mt-2">分析項目を読み込んでいます...</div>
    </div>
  `;
  
  try {
    const diaryId = '{{ form.instance.pk|default:"" }}';
    let url = `/analysis_template/api/items/?template_id=${templateId}`;
    
    if (diaryId) {
      url += `&diary_id=${diaryId}`;
    }
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error('分析項目の取得に失敗しました');
    }
    
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.error || '分析項目の取得に失敗しました');
    }
    
    renderAnalysisItems(data.items, data.values || {});
    
  } catch (error) {
    console.error('Analysis items fetch error:', error);
    analysisItemsContent.innerHTML = `
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        分析項目の読み込みに失敗しました: ${error.message}
        <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="loadAnalysisItems(${templateId})">
          <i class="bi bi-arrow-clockwise"></i> 再試行
        </button>
      </div>
    `;
  }
}


function renderAnalysisItems(items, values = {}) {
  if (!items || items.length === 0) {
    analysisItemsContent.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon"><i class="bi bi-info-circle"></i></div>
        <h4>分析項目がありません</h4>
        <p>このテンプレートには分析項目が設定されていません</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  
  items.forEach((item, index) => {
    const existingValue = values[item.id];
    
    let icon = 'bi-circle';
    if (item.item_type === 'boolean') icon = 'bi-check-circle';
    else if (item.item_type === 'boolean_with_value') icon = 'bi-check-square';
    else if (item.item_type === 'number') icon = 'bi-123';
    else if (item.item_type === 'select') icon = 'bi-list-ul';
    else if (item.item_type === 'text') icon = 'bi-text-left';
    
    html += `<div class="analysis-item">`;
    
    if (item.item_type === 'boolean') {
      const checked = existingValue === true ? 'checked' : '';
      
      html += `
        <div class="analysis-item-header">
          <div class="analysis-item-label-wrapper">
            <i class="bi ${icon}"></i>
            <div>
              <label class="analysis-item-label" for="analysis_item_${item.id}">
                ${escapeHtml(item.name)}
              </label>
              ${item.description ? `<div class="analysis-item-desc">${escapeHtml(item.description)}</div>` : ''}
            </div>
          </div>
          <div class="analysis-item-checkbox">
            <div class="form-check">
              <input type="checkbox" 
                     class="form-check-input" 
                     name="analysis_item_${item.id}" 
                     id="analysis_item_${item.id}"
                     ${checked}>
            </div>
          </div>
        </div>
      `;
      
    } else if (item.item_type === 'boolean_with_value') {
      const boolChecked = existingValue?.boolean_value === true ? 'checked' : '';
      const numberValue = existingValue?.number_value ?? '';
      const valueLabel = item.value_label || '値';
      
      html += `
        <div class="analysis-item-header">
          <div class="analysis-item-label-wrapper">
            <i class="bi ${icon}"></i>
            <div>
              <label class="analysis-item-label">
                ${escapeHtml(item.name)}
              </label>
              ${item.description ? `<div class="analysis-item-desc">${escapeHtml(item.description)}</div>` : ''}
            </div>
          </div>
        </div>
        
        <div class="compound-input-wrapper">
          <div class="compound-checkbox-row">
            <input type="checkbox" 
                   class="form-check-input" 
                   name="analysis_item_${item.id}_boolean" 
                   id="analysis_item_${item.id}_boolean"
                   ${boolChecked}>
            <label class="form-check-label" for="analysis_item_${item.id}_boolean">
              該当する
            </label>
          </div>
          <div>
            <label class="form-label">${escapeHtml(valueLabel)}</label>
            <input type="number" 
                   class="form-control" 
                   name="analysis_item_${item.id}_value" 
                   id="analysis_item_${item.id}_value"
                   step="0.01"
                   placeholder="数値を入力"
                   value="${numberValue}">
          </div>
        </div>
      `;
      
    } else if (item.item_type === 'number') {
      const value = existingValue ?? '';
      
      html += `
        <div class="analysis-item-header">
          <div class="analysis-item-label-wrapper">
            <i class="bi ${icon}"></i>
            <div>
              <label class="analysis-item-label" for="analysis_item_${item.id}">
                ${escapeHtml(item.name)}
              </label>
              ${item.description ? `<div class="analysis-item-desc">${escapeHtml(item.description)}</div>` : ''}
            </div>
          </div>
        </div>
        <div class="analysis-item-input-section">
          <input type="number" 
                 class="form-control" 
                 name="analysis_item_${item.id}" 
                 id="analysis_item_${item.id}"
                 step="0.01"
                 placeholder="数値を入力"
                 value="${value}">
        </div>
      `;
      
    } else if (item.item_type === 'select') {
      html += `
        <div class="analysis-item-header">
          <div class="analysis-item-label-wrapper">
            <i class="bi ${icon}"></i>
            <div>
              <label class="analysis-item-label" for="analysis_item_${item.id}">
                ${escapeHtml(item.name)}
              </label>
              ${item.description ? `<div class="analysis-item-desc">${escapeHtml(item.description)}</div>` : ''}
            </div>
          </div>
        </div>
        <div class="analysis-item-input-section">
          <select class="form-select" 
                  name="analysis_item_${item.id}" 
                  id="analysis_item_${item.id}">
            <option value="">選択してください</option>
      `;
      
      let choicesList = [];
      if (item.choices) {
        if (Array.isArray(item.choices)) {
          choicesList = item.choices;
        } else if (typeof item.choices === 'string') {
          choicesList = item.choices.split(',').map(c => c.trim()).filter(c => c);
        }
      }
      
      choicesList.forEach(choice => {
        const selected = existingValue === choice ? 'selected' : '';
        html += `<option value="${escapeHtml(choice)}" ${selected}>${escapeHtml(choice)}</option>`;
      });
      
      html += `</select></div>`;
      
    } else {
      const value = existingValue ?? '';
      html += `
        <div class="analysis-item-header">
          <div class="analysis-item-label-wrapper">
            <i class="bi ${icon}"></i>
            <div>
              <label class="analysis-item-label" for="analysis_item_${item.id}">
                ${escapeHtml(item.name)}
              </label>
              ${item.description ? `<div class="analysis-item-desc">${escapeHtml(item.description)}</div>` : ''}
            </div>
          </div>
        </div>
        <div class="analysis-item-input-section">
          <input type="text" 
                 class="form-control" 
                 name="analysis_item_${item.id}" 
                 id="analysis_item_${item.id}"
                 placeholder="テキストを入力"
                 value="${escapeHtml(value)}">
        </div>
      `;
    }
    
    html += `</div>`;
  });
  
  analysisItemsContent.innerHTML = html;
}


// ============================================
// フォーム送信時のバリデーション
// ============================================
const form = document.getElementById('diaryForm');
if (form) {
  form.addEventListener('submit', function(e) {
    const checkbox = document.getElementById('id_add_initial_purchase');
    
    if (checkbox && checkbox.checked) {
      const errors = validateInitialPurchase();
      
      if (errors.length > 0) {
        e.preventDefault();
        alert('入力エラー:\n' + errors.join('\n'));
        return false;
      }
    }
    
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>保存中...';
    }
  });
}

function validateInitialPurchase() {
  const errors = [];
  const dateField = document.getElementById('id_initial_purchase_date');
  const priceField = document.getElementById('id_initial_purchase_price');
  const quantityField = document.getElementById('id_initial_purchase_quantity');
  
  if (!dateField.value) {
    errors.push('購入日を入力してください');
  }
  
  const price = parseFloat(priceField.value);
  if (!price || price <= 0) {
    errors.push('購入単価は正の数を入力してください');
  }
  
  const quantity = parseFloat(quantityField.value);
  if (!quantity || quantity <= 0) {
    errors.push('購入数量は正の数を入力してください');
  }
  
  return errors;
}

// ============================================
// 初期化処理
// ============================================
if (addInitialPurchaseCheckbox && addInitialPurchaseCheckbox.checked) {
  updateInitialPurchasePreview();
}

// ツールチップの初期化
const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl);
});
});

// HTMLエスケープ関数
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

</script>
{% endblock %}