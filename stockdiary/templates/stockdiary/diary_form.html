{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}æ—¥è¨˜ã®ç·¨é›†{% else %}æ–°è¦æ—¥è¨˜ä½œæˆ{% endif %} | ã‚«ãƒ–ãƒ­ã‚°{% endblock %}

{% block head %}
{{ block.super }}
<!-- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆCSS -->
<link rel="stylesheet" href="{% static 'css/3-components/components.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'css/3-components/dark-mode-components.css' %}?v={{ STATIC_VERSION }}">
<!-- EasyMDE Markdown Editor -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">

<style>
  /* ========== ãƒšãƒ¼ã‚¸å›ºæœ‰ã‚¹ã‚¿ã‚¤ãƒ« ========== */
  
  /* æ—¥è¨˜ã‚‰ã—ã„ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
  .diary-textarea {
    font-family: 'Hiragino Kaku Gothic Pro', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
    line-height: 1.8;
    padding: 1rem;
    border-radius: var(--radius-md);
    background-color: #fefefe;
    background-image: linear-gradient(transparent 1.7rem, #e5e7eb 1.7rem, #e5e7eb 1.8rem, transparent 1.8rem);
    background-size: 100% 1.8rem;
    min-height: 200px;
  }

  .dark-mode .diary-textarea,
  [data-theme="dark"] .diary-textarea {
    background-color: var(--dm-card);
    background-image: linear-gradient(transparent 1.7rem, #52626d 1.7rem, #0e2147 1.8rem, transparent 1.8rem);
  }

  .diary-memo-textarea {
    font-family: 'Hiragino Kaku Gothic Pro', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
    line-height: 1.8;
    padding: 1rem;
    border-radius: var(--radius-md);
    background-color: #fffef5;
    border: 2px solid var(--warning-color);
    min-height: 150px;
  }

  .dark-mode .diary-memo-textarea,
  [data-theme="dark"] .diary-memo-textarea {
    background-color: rgba(251, 191, 36, 0.1);
  }

  /* åˆå›è³¼å…¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .initial-purchase-section {
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-top: 1rem;
  }

  .initial-purchase-section.active {
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ */
  .character-count {
    font-size: 0.875rem;
    color: var(--text-muted);
    text-align: right;
    margin-top: 0.25rem;
  }

  .character-count.warning {
    color: var(--warning-color);
  }

  .character-count.danger {
    color: var(--danger-color);
  }

  /* ========== ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ ========== */
  .autocomplete-results {
    background: var(--card-bg, white);
    border: 1px solid var(--border-color, #d1d5db);
    box-shadow: var(--shadow-lg, 0 4px 6px rgba(0, 0, 0, 0.1));
  }

  .autocomplete-hover {
    background-color: var(--bg-hover, #f3f4f6) !important;
  }

  .autocomplete-selected {
    background-color: var(--primary-light, #dbeafe) !important;
  }

  /* ========== åˆ†æé …ç›®ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ========== */
  .analysis-item {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s ease;
  }

  .analysis-item:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-sm);
  }

  .analysis-item-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
  }

  .analysis-item-label-wrapper {
    display: flex;
    align-items: flex-start;
    flex: 1;
    min-width: 0;
  }

  .analysis-item-label-wrapper i {
    flex-shrink: 0;
    margin-right: 0.5rem;
    margin-top: 0.25rem;
    color: var(--primary-color);
  }

  .analysis-item-label {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--text-primary);
    margin: 0;
    cursor: pointer;
    line-height: 1.4;
  }

  .analysis-item-desc {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
    line-height: 1.4;
  }

  .analysis-item-checkbox .form-check-input {
    width: 1.5rem;
    height: 1.5rem;
    margin: 0;
    cursor: pointer;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
  }

  .analysis-item-checkbox .form-check-input:checked {
    background-color: var(--success-color);
    border-color: var(--success-color);
  }

  .analysis-item-input-section {
    margin-top: 0.75rem;
  }

  /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã®æ¨ªå¹…åˆ¶é™ */
  @media (min-width: 768px) {
    .analysis-item .form-control[type="number"] {
      max-width: 200px;
    }
    
    .analysis-item .form-control[type="text"] {
      max-width: 400px;
    }
    
    .analysis-item .form-select {
      max-width: 300px;
    }
  }

  /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
  .dark-mode .analysis-item,
  [data-theme="dark"] .analysis-item {
    background: var(--dm-card);
    border-color: var(--dm-border);
  }

  .dark-mode .analysis-item:hover,
  [data-theme="dark"] .analysis-item:hover {
    border-color: var(--dm-primary);
  }

  .dark-mode .analysis-item-label,
  [data-theme="dark"] .analysis-item-label {
    color: var(--dm-foreground);
  }

  .dark-mode .analysis-item-desc,
  [data-theme="dark"] .analysis-item-desc {
    color: var(--dm-muted-foreground);
  }

  .dark-mode .input-group-text,
  [data-theme="dark"] .input-group-text {
    background-color: var(--dm-card);
    color: var(--dm-foreground);
    border-color: var(--dm-border);
  }

  .dark-mode .form-control[type="file"],
  [data-theme="dark"] .form-control[type="file"] {
    background-color: var(--dm-card);
    color: var(--dm-foreground);
    border-color: var(--dm-border);
  }

  .dark-mode .form-control[type="file"]::file-selector-button,
  [data-theme="dark"] .form-control[type="file"]::file-selector-button {
    background-color: var(--dm-muted);
    color: var(--dm-foreground);
    border: 1px solid var(--dm-border);
  }

  .dark-mode .tooltip-inner,
  [data-theme="dark"] .tooltip-inner {
    background-color: var(--dm-card);
    color: var(--dm-foreground);
  }

  /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: ãƒ•ã‚©ãƒ¼ãƒ å…¨èˆ¬ ========== */

  /* ãƒ•ã‚©ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .dark-mode .form-section,
  [data-theme="dark"] .form-section {
    border-color: var(--dm-border) !important;
  }

  .dark-mode .form-section-title,
  [data-theme="dark"] .form-section-title {
    color: var(--dm-text-100) !important;
  }

  .dark-mode .form-section-title i,
  [data-theme="dark"] .form-section-title i {
    color: var(--dm-primary-200) !important;
  }

  /* ãƒ•ã‚©ãƒ¼ãƒ ãƒ©ãƒ™ãƒ« */
  .dark-mode .form-label,
  [data-theme="dark"] .form-label {
    color: var(--dm-text-100) !important;
  }

  .dark-mode .form-label i,
  [data-theme="dark"] .form-label i {
    color: var(--dm-primary-200) !important;
  }

  /* ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
  .dark-mode .form-control,
  [data-theme="dark"] .form-control {
    background-color: rgba(71, 85, 105, 0.3) !important;
    color: var(--dm-text-100) !important;
    border-color: var(--dm-border) !important;
  }

  .dark-mode .form-control:focus,
  [data-theme="dark"] .form-control:focus {
    background-color: rgba(71, 85, 105, 0.4) !important;
    border-color: var(--dm-primary-200) !important;
    box-shadow: 0 0 0 0.2rem rgba(89, 142, 243, 0.15) !important;
  }

  .dark-mode .form-control::placeholder,
  [data-theme="dark"] .form-control::placeholder {
    color: var(--dm-text-200) !important;
    opacity: 0.6;
  }

  /* ãƒ•ã‚©ãƒ¼ãƒ ã‚»ãƒ¬ã‚¯ãƒˆ */
  .dark-mode .form-select,
  [data-theme="dark"] .form-select {
    background-color: rgba(71, 85, 105, 0.3) !important;
    color: var(--dm-text-100) !important;
    border-color: var(--dm-border) !important;
  }

  .dark-mode .form-select:focus,
  [data-theme="dark"] .form-select:focus {
    background-color: rgba(71, 85, 105, 0.4) !important;
    border-color: var(--dm-primary-200) !important;
    box-shadow: 0 0 0 0.2rem rgba(89, 142, 243, 0.15) !important;
  }

  /* ãƒ•ã‚©ãƒ¼ãƒ ãƒ†ã‚­ã‚¹ãƒˆãƒ»ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ */
  .dark-mode .form-text,
  [data-theme="dark"] .form-text {
    color: var(--dm-text-200) !important;
  }

  .dark-mode .text-muted,
  [data-theme="dark"] .text-muted {
    color: var(--dm-text-200) !important;
  }

  .dark-mode .text-danger,
  [data-theme="dark"] .text-danger {
    color: #fca5a5 !important;
  }

  /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
  .dark-mode .form-check-input,
  [data-theme="dark"] .form-check-input {
    background-color: rgba(71, 85, 105, 0.3) !important;
    border-color: var(--dm-border) !important;
  }

  .dark-mode .form-check-input:checked,
  [data-theme="dark"] .form-check-input:checked {
    background-color: var(--dm-primary-100) !important;
    border-color: var(--dm-primary-100) !important;
  }

  .dark-mode .form-check-label,
  [data-theme="dark"] .form-check-label {
    color: var(--dm-text-100) !important;
  }

  .dark-mode .form-check-label small,
  [data-theme="dark"] .form-check-label small {
    color: var(--dm-text-200) !important;
  }

  /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: æ ªå¼æƒ…å ±ã‚«ãƒ¼ãƒ‰ ========== */
  .dark-mode .info-block,
  [data-theme="dark"] .info-block {
    background-color: rgba(37, 99, 235, 0.08) !important;
    border-color: rgba(89, 142, 243, 0.2) !important;
  }

  .dark-mode .info-block h5,
  [data-theme="dark"] .info-block h5 {
    color: var(--dm-text-100) !important;
  }

  .dark-mode .info-icon,
  [data-theme="dark"] .info-icon {
    background: linear-gradient(135deg, rgba(89, 142, 243, 0.15), rgba(89, 142, 243, 0.25)) !important;
    color: var(--dm-primary-200) !important;
  }

  /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ ========== */
  .dark-mode .character-count,
  [data-theme="dark"] .character-count {
    color: var(--dm-text-200) !important;
  }

  /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: åˆå›è³¼å…¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ========== */
  .dark-mode .initial-purchase-section,
  [data-theme="dark"] .initial-purchase-section {
    border-color: var(--dm-border) !important;
    background-color: rgba(71, 85, 105, 0.1);
  }

  .dark-mode .initial-purchase-section h6,
  [data-theme="dark"] .initial-purchase-section h6 {
    color: var(--dm-text-100) !important;
  }

  /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ ========== */
  .dark-mode .card,
  [data-theme="dark"] .card {
    background-color: var(--dm-card) !important;
    border-color: var(--dm-border) !important;
  }

  .dark-mode .card-body,
  [data-theme="dark"] .card-body {
    background-color: var(--dm-card) !important;
    color: var(--dm-text-100) !important;
  }

  /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: ã‚¢ãƒ©ãƒ¼ãƒˆ ========== */
  .dark-mode .alert-success,
  [data-theme="dark"] .alert-success {
    background-color: rgba(16, 185, 129, 0.15) !important;
    border-color: rgba(16, 185, 129, 0.3) !important;
    color: #6ee7b7 !important;
  }

  .dark-mode .alert-info,
  [data-theme="dark"] .alert-info {
    background-color: rgba(59, 130, 246, 0.15) !important;
    border-color: rgba(59, 130, 246, 0.3) !important;
    color: #93c5fd !important;
  }

  .dark-mode .alert-warning,
  [data-theme="dark"] .alert-warning {
    background-color: rgba(251, 191, 36, 0.15) !important;
    border-color: rgba(251, 191, 36, 0.3) !important;
    color: #fcd34d !important;
  }

  .dark-mode .alert-danger,
  [data-theme="dark"] .alert-danger {
    background-color: rgba(239, 68, 68, 0.15) !important;
    border-color: rgba(239, 68, 68, 0.3) !important;
    color: #fca5a5 !important;
  }

  .dark-mode .alert .btn-close,
  [data-theme="dark"] .alert .btn-close {
    filter: invert(1) grayscale(100%) brightness(200%);
  }

  /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ãƒƒã‚¿ãƒ¼ ========== */
  .dark-mode .form-footer,
  [data-theme="dark"] .form-footer {
    border-color: var(--dm-border) !important;
  }

  /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« ========== */
  .dark-mode .page-title,
  [data-theme="dark"] .page-title {
    color: var(--dm-text-100) !important;
  }

  .dark-mode .page-title i,
  [data-theme="dark"] .page-title i {
    color: var(--dm-primary-200) !important;
  }

  /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: ãƒœã‚¿ãƒ³ ========== */
  .dark-mode .btn-primary,
  [data-theme="dark"] .btn-primary {
    background-color: var(--dm-primary-100) !important;
    border-color: var(--dm-primary-100) !important;
  }

  .dark-mode .btn-primary:hover,
  [data-theme="dark"] .btn-primary:hover {
    background-color: var(--dm-primary-200) !important;
    border-color: var(--dm-primary-200) !important;
  }

  .dark-mode .btn-outline-primary,
  [data-theme="dark"] .btn-outline-primary {
    color: var(--dm-primary-200) !important;
    border-color: var(--dm-primary-200) !important;
  }

  .dark-mode .btn-outline-primary:hover,
  [data-theme="dark"] .btn-outline-primary:hover {
    background-color: rgba(89, 142, 243, 0.1) !important;
    color: var(--dm-primary-300) !important;
  }

  .dark-mode .btn-outline-danger,
  [data-theme="dark"] .btn-outline-danger {
    color: #fca5a5 !important;
    border-color: rgba(239, 68, 68, 0.5) !important;
  }

  .dark-mode .btn-outline-danger:hover,
  [data-theme="dark"] .btn-outline-danger:hover {
    background-color: rgba(239, 68, 68, 0.15) !important;
    color: #fca5a5 !important;
  }

  /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ ========== */
  .dark-mode .autocomplete-results,
  [data-theme="dark"] .autocomplete-results {
    background: var(--dm-card) !important;
    border-color: var(--dm-border) !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4) !important;
  }

  .dark-mode .autocomplete-item,
  .dark-mode .list-group-item,
  [data-theme="dark"] .autocomplete-item,
  [data-theme="dark"] .list-group-item {
    background-color: var(--dm-card) !important;
    color: var(--dm-text-100) !important;
    border-color: var(--dm-border) !important;
  }

  .dark-mode .autocomplete-item:hover,
  .dark-mode .list-group-item-action:hover,
  [data-theme="dark"] .autocomplete-item:hover,
  [data-theme="dark"] .list-group-item-action:hover {
    background-color: rgba(89, 142, 243, 0.1) !important;
  }

  .dark-mode .autocomplete-item .text-primary,
  [data-theme="dark"] .autocomplete-item .text-primary {
    color: var(--dm-primary-200) !important;
  }

  .dark-mode .autocomplete-hover,
  [data-theme="dark"] .autocomplete-hover {
    background-color: rgba(89, 142, 243, 0.1) !important;
  }

  .dark-mode .autocomplete-selected,
  [data-theme="dark"] .autocomplete-selected {
    background-color: rgba(89, 142, 243, 0.15) !important;
  }

  /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: åˆ†æãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ©ãƒ™ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ ========== */
  .dark-mode .analysis-item-label-wrapper i,
  [data-theme="dark"] .analysis-item-label-wrapper i {
    color: var(--dm-primary-200) !important;
  }

  .dark-mode .analysis-item-checkbox .form-check-input,
  [data-theme="dark"] .analysis-item-checkbox .form-check-input {
    border-color: var(--dm-border) !important;
  }

  /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: é€šçŸ¥ ========== */
  .dark-mode .custom-notification.alert-success,
  [data-theme="dark"] .custom-notification.alert-success {
    background-color: rgba(16, 185, 129, 0.9) !important;
    color: white !important;
  }

  .dark-mode .custom-notification.alert-danger,
  [data-theme="dark"] .custom-notification.alert-danger {
    background-color: rgba(239, 68, 68, 0.9) !important;
    color: white !important;
  }

  /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: diary-formå…¨ä½“ ========== */
  .dark-mode .diary-form,
  [data-theme="dark"] .diary-form {
    color: var(--dm-text-100);
  }

  .dark-mode .form-body,
  [data-theme="dark"] .form-body {
    color: var(--dm-text-100);
  }

  /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: empty-state ========== */
  .dark-mode .empty-state h4,
  [data-theme="dark"] .empty-state h4 {
    color: var(--dm-text-100) !important;
  }

  .dark-mode .empty-state p,
  [data-theme="dark"] .empty-state p {
    color: var(--dm-text-200) !important;
  }

  /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰: loading ========== */
  .dark-mode .loading-text,
  [data-theme="dark"] .loading-text {
    color: var(--dm-text-200) !important;
  }

  /* ========== EasyMDE Markdown Editor ========== */
  .EasyMDEContainer {
    margin-bottom: 0.25rem;
  }

  .EasyMDEContainer .editor-toolbar {
    display: flex;
    flex-wrap: wrap;  /* ğŸ”§ nowrap â†’ wrap ã«å¤‰æ›´ */
    overflow-x: visible;  /* ğŸ”§ auto â†’ visible ã«å¤‰æ›´ */
    gap: 0.25rem;  /* ğŸ”§ 0 â†’ 0.25rem ã«å¤‰æ›´ï¼ˆãƒœã‚¿ãƒ³é–“ã®ä½™ç™½ï¼‰ */
    padding: 0.5rem;
    align-items: center;  /* ğŸ†• è¿½åŠ : ãƒœã‚¿ãƒ³ã‚’ä¸­å¤®æƒãˆ */
  }

  .EasyMDEContainer .editor-toolbar button {
    flex-shrink: 0;
    min-width: 28px;  /* ğŸ†• è¿½åŠ : æœ€å°å¹…ã‚’è¨­å®š */
    height: 28px;  /* ğŸ†• è¿½åŠ : é«˜ã•ã‚’çµ±ä¸€ */
    padding: 0.25rem;  /* ğŸ†• è¿½åŠ : ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
  }

  /* ğŸ†• è¿½åŠ : ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã®èª¿æ•´ */
  .EasyMDEContainer .editor-toolbar i.separator {
    margin: 0 0.25rem;
    height: 20px;
  }

  .EasyMDEContainer .CodeMirror-focused {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(0, 102, 140, 0.15);
  }

  .EasyMDEContainer .editor-toolbar {
    border-color: var(--border-color, #d1d5db);
    border-radius: var(--radius-md) var(--radius-md) 0 0;
  }

  .EasyMDEContainer .editor-toolbar button {
    color: var(--text-secondary, #6b7280) !important;
  }

  .EasyMDEContainer .editor-toolbar button:hover,
  .EasyMDEContainer .editor-toolbar button.active {
    background: var(--primary-light, #d4eaf7) !important;
    border-color: var(--primary-color) !important;
    color: var(--primary-color) !important;
  }

  .EasyMDEContainer .editor-statusbar {
    border-color: var(--border-color, #d1d5db);
    color: var(--text-secondary, #6b7280);
    padding: 0.5rem 0.75rem;
  }

  .EasyMDEContainer .editor-preview,
  .EasyMDEContainer .editor-preview-side {
    font-family: 'Hiragino Kaku Gothic Pro', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
    line-height: 1.8;
    padding: 1rem;
  }

  /* ğŸ†• è¿½åŠ : ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
  @media (max-width: 768px) {
    .EasyMDEContainer .editor-toolbar {
      padding: 0.375rem;
    }

    .EasyMDEContainer .editor-toolbar button {
      min-width: 32px;  /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã„ã‚ˆã†ã«å¤§ãã‚ã« */
      height: 32px;
      font-size: 0.875rem;
    }

    .EasyMDEContainer .editor-toolbar i.separator {
      display: none;  /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã‚’éè¡¨ç¤º */
    }
  }

  /* ğŸ†• è¿½åŠ : å°ã•ã„ç”»é¢ã§ã¯ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’ã•ã‚‰ã«ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
  @media (max-width: 480px) {
    .EasyMDEContainer .editor-toolbar {
      gap: 0.125rem;
    }

    .EasyMDEContainer .editor-toolbar button {
      min-width: 30px;
      height: 30px;
      padding: 0.125rem;
    }
  }
  /* EasyMDE ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
  .dark-mode .EasyMDEContainer .CodeMirror,
  [data-theme="dark"] .EasyMDEContainer .CodeMirror {
    background-color: rgba(71, 85, 105, 0.3) !important;
    color: var(--dm-text-100) !important;
    border-color: var(--dm-border) !important;
  }

  .dark-mode .EasyMDEContainer .CodeMirror-focused,
  [data-theme="dark"] .EasyMDEContainer .CodeMirror-focused {
    border-color: var(--dm-primary-200) !important;
    box-shadow: 0 0 0 0.2rem rgba(89, 142, 243, 0.15) !important;
  }

  .dark-mode .EasyMDEContainer .CodeMirror-cursor,
  [data-theme="dark"] .EasyMDEContainer .CodeMirror-cursor {
    border-left-color: var(--dm-text-100) !important;
  }

  .dark-mode .EasyMDEContainer .CodeMirror-selected,
  [data-theme="dark"] .EasyMDEContainer .CodeMirror-selected {
    background: rgba(89, 142, 243, 0.3) !important;
  }

  .dark-mode .EasyMDEContainer .editor-toolbar,
  [data-theme="dark"] .EasyMDEContainer .editor-toolbar {
    background-color: var(--dm-card) !important;
    border-color: var(--dm-border) !important;
  }

  .dark-mode .EasyMDEContainer .editor-toolbar button,
  [data-theme="dark"] .EasyMDEContainer .editor-toolbar button {
    color: var(--dm-text-200) !important;
  }

  .dark-mode .EasyMDEContainer .editor-toolbar button:hover,
  .dark-mode .EasyMDEContainer .editor-toolbar button.active,
  [data-theme="dark"] .EasyMDEContainer .editor-toolbar button:hover,
  [data-theme="dark"] .EasyMDEContainer .editor-toolbar button.active {
    background: rgba(89, 142, 243, 0.15) !important;
    border-color: var(--dm-primary-200) !important;
    color: var(--dm-primary-200) !important;
  }

  .dark-mode .EasyMDEContainer .editor-toolbar i.separator,
  [data-theme="dark"] .EasyMDEContainer .editor-toolbar i.separator {
    border-left-color: var(--dm-border) !important;
    border-right-color: var(--dm-border) !important;
  }

  .dark-mode .EasyMDEContainer .editor-statusbar,
  [data-theme="dark"] .EasyMDEContainer .editor-statusbar {
    border-color: var(--dm-border) !important;
    color: var(--dm-text-200) !important;
  }

  .dark-mode .EasyMDEContainer .editor-preview,
  .dark-mode .EasyMDEContainer .editor-preview-side,
  [data-theme="dark"] .EasyMDEContainer .editor-preview,
  [data-theme="dark"] .EasyMDEContainer .editor-preview-side {
    background: var(--dm-card) !important;
    color: var(--dm-text-100) !important;
  }

  .dark-mode .EasyMDEContainer .editor-preview pre,
  [data-theme="dark"] .EasyMDEContainer .editor-preview pre {
    background: rgba(71, 85, 105, 0.5) !important;
    color: var(--dm-text-100) !important;
  }

  .dark-mode .EasyMDEContainer .editor-preview blockquote,
  [data-theme="dark"] .EasyMDEContainer .editor-preview blockquote {
    border-left-color: var(--dm-primary-200) !important;
    color: var(--dm-text-200) !important;
  }

  .dark-mode .EasyMDEContainer .cm-header,
  [data-theme="dark"] .EasyMDEContainer .cm-header {
    color: var(--dm-primary-200) !important;
  }

  .dark-mode .EasyMDEContainer .cm-strong,
  .dark-mode .EasyMDEContainer .cm-em,
  [data-theme="dark"] .EasyMDEContainer .cm-strong,
  [data-theme="dark"] .EasyMDEContainer .cm-em {
    color: var(--dm-text-100) !important;
  }

  .dark-mode .EasyMDEContainer .cm-link,
  .dark-mode .EasyMDEContainer .cm-url,
  [data-theme="dark"] .EasyMDEContainer .cm-link,
  [data-theme="dark"] .EasyMDEContainer .cm-url {
    color: var(--dm-primary-200) !important;
  }

  .dark-mode .EasyMDEContainer .cm-comment,
  [data-theme="dark"] .EasyMDEContainer .cm-comment {
    color: var(--dm-text-200) !important;
  }

  /* EasyMDE ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
  .dark-mode .EasyMDEContainer .CodeMirror-fullscreen,
  [data-theme="dark"] .EasyMDEContainer .CodeMirror-fullscreen {
    background-color: var(--dm-bg-100, #1e293b) !important;
  }

  .dark-mode .EasyMDEContainer .editor-toolbar.fullscreen,
  [data-theme="dark"] .EasyMDEContainer .editor-toolbar.fullscreen {
    background-color: var(--dm-card) !important;
  }

  .dark-mode .EasyMDEContainer .editor-preview-side,
  [data-theme="dark"] .EasyMDEContainer .editor-preview-side {
    border-left-color: var(--dm-border) !important;
  }

  /* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ */
  @media (hover: none) and (pointer: coarse) {
    .analysis-item-checkbox .form-check-input {
      width: 1.75rem;
      height: 1.75rem;
    }
    
    .analysis-item-label {
      padding: 0.5rem 0;
      min-height: 44px;
      display: flex;
      align-items: center;
    }

    .analysis-item .form-control,
    .analysis-item .form-select {
      min-height: 44px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="title_header">
    <h1 class="page-title">
      <i class="bi bi-journal-text"></i> {% if form.instance.pk %}æ—¥è¨˜ã®ç·¨é›†{% else %}æ–°è¦æ—¥è¨˜ä½œæˆ{% endif %}
    </h1>
  </div>

  <!-- æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½¿ç”¨ï¼‰ -->
  {% if not form.instance.pk %}
  {% include "stockdiary/components/_alert.html" with type="info" icon="bi-info-circle" message="<strong>æŠ•è³‡æ—¥è¨˜ã«ã¤ã„ã¦:</strong> æŠ•è³‡åˆ¤æ–­ã®ç†ç”±ã‚„æ°—ã¥ã„ãŸã“ã¨ã‚’è‡ªç”±ã«è¨˜éŒ²ã§ãã¾ã™ã€‚å¾Œã‹ã‚‰ã€Œå–å¼•å±¥æ­´ã€ã‚¿ãƒ–ã§å®Ÿéš›ã®å£²è²·ã‚’è¨˜éŒ²ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚" %}
  {% endif %}

  <!-- ãƒ•ã‚©ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ -->
  <div class="diary-form">
    <div class="form-body">
      <form method="post" enctype="multipart/form-data" id="diaryForm">
        {% csrf_token %}

        <!-- æ ªå¼æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="bi bi-graph-up"></i> éŠ˜æŸ„æƒ…å ±
          </h4>

          <!-- æ ªä¾¡æƒ…å ±ã‚«ãƒ¼ãƒ‰ï¼ˆéŠ˜æŸ„æ¤œç´¢å¾Œã«è¡¨ç¤ºï¼‰ -->
          <div class="info-block d-none" id="stockInfoCard">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0" id="stockInfoTitle">ä¼šç¤¾æƒ…å ±</h5>
              <span id="stockInfoCode"></span>
            </div>
            <div class="info-row">
              <div class="info-item">
                <div class="info-icon"><i class="bi bi-currency-yen"></i></div>
                <div class="info-content">
                  <span class="info-label">ç¾åœ¨æ ªä¾¡</span>
                  <span class="info-value" id="stockInfoPrice">--</span>
                </div>
              </div>
              <div class="info-item">
                <div class="info-icon"><i class="bi bi-graph-up-arrow"></i></div>
                <div class="info-content">
                  <span class="info-label">å‰æ—¥æ¯”</span>
                  <span class="info-value" id="stockInfoChange">--</span>
                </div>
              </div>
              <div class="info-item">
                <div class="info-icon"><i class="bi bi-building"></i></div>
                <div class="info-content">
                  <span class="info-label">å¸‚å ´</span>
                  <span class="info-value" id="stockInfoMarket">--</span>
                </div>
              </div>
              <div class="info-item">
                <div class="info-icon"><i class="bi bi-diagram-3"></i></div>
                <div class="info-content">
                  <span class="info-label">æ¥­ç¨®</span>
                  <span class="info-value" id="stockInfoIndustry">--</span>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.stock_symbol.id_for_label }}" class="form-label">
                <i class="bi bi-hash me-1"></i>{{ form.stock_symbol.label }}
              </label>
              <div class="input-group">
                {{ form.stock_symbol }}
                <button type="button" class="btn btn-primary" id="fetchStockInfo">
                  <i class="bi bi-search"></i> æ¤œç´¢
                </button>
              </div>
              <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½¿ç”¨ï¼‰ -->
              <div class="d-none" id="symbolSpinnerContainer">
                {% include "stockdiary/components/_loading.html" with text="ä¼šç¤¾æƒ…å ±ã‚’å–å¾—ä¸­..." inline=True size="sm" %}
              </div>
              <small class="form-text text-muted">{{ form.stock_symbol.help_text }}</small>
              {% if form.stock_symbol.errors %}
              <div class="text-danger">{{ form.stock_symbol.errors }}</div>
              {% endif %}
            </div>

            <div class="col-md-6 mb-3">
              <label for="{{ form.stock_name.id_for_label }}" class="form-label">
                <i class="bi bi-building me-1"></i>éŠ˜æŸ„å/ãƒ¡ãƒ¢ã‚¿ã‚¤ãƒˆãƒ«<span class="text-danger">*</span>
              </label>
              {{ form.stock_name }}
              <small class="form-text text-muted">æ ªå¼ã®å ´åˆã¯éŠ˜æŸ„åã€ãƒ¡ãƒ¢ã®å ´åˆã¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›</small>
              {% if form.stock_name.errors %}
              <div class="text-danger">{{ form.stock_name.errors }}</div>
              {% endif %}
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.sector.id_for_label }}" class="form-label">
                <i class="bi bi-diagram-3 me-1"></i>æ¥­ç¨®
              </label>
              <div class="input-group">
                {{ form.sector }}
                <span class="input-group-text">
                  <i class="bi bi-info-circle" data-bs-toggle="tooltip" 
                     title="éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢ã™ã‚‹ã¨è‡ªå‹•è¨­å®šã•ã‚Œã¾ã™"></i>
                </span>
              </div>
              <small class="form-text text-muted">æ¥­ç¨®æƒ…å ±ã¯éŠ˜æŸ„æ¤œç´¢æ™‚ã«è‡ªå‹•è¨­å®šã•ã‚Œã¾ã™</small>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.tags.id_for_label }}" class="form-label">
                <i class="bi bi-tags me-1"></i>ã‚¿ã‚°
              </label>
              {{ form.tags }}
              <small class="form-text text-muted">è¤‡æ•°é¸æŠå¯èƒ½ã§ã™</small>
            </div>
          </div>
        </div>

        <!-- æŠ•è³‡ç†ç”±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆMarkdownã‚¨ãƒ‡ã‚£ã‚¿ï¼‰ -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="bi bi-journal-text"></i> æŠ•è³‡ç†ç”±ãƒ»åˆ†æå†…å®¹
            <small class="text-muted ms-2" style="font-size: 0.75rem; font-weight: 400;">
              <i class="bi bi-markdown me-1"></i>Markdownå¯¾å¿œ
            </small>
          </h4>
          <textarea class="form-control"
                    name="reason"
                    id="id_reason"
                    rows="10"
                    maxlength="5000">{{ form.reason.value|default:'' }}</textarea>
          <div class="character-count" id="reasonCharCount">0 / 5000æ–‡å­—</div>
          {% if form.reason.errors %}
          <div class="text-danger small mt-1">{{ form.reason.errors }}</div>
          {% endif %}
        </div>

        <!-- ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="bi bi-sticky"></i> ãƒ¡ãƒ¢ãƒ»æ°—ã¥ã„ãŸã“ã¨
            {% include "stockdiary/components/_badge.html" with type="warning" text="ãƒ¡ãƒ¢" icon="bi-sticky" extra_class="ms-2" %}
          </h4>
          <textarea class="form-control diary-memo-textarea" 
                    name="memo" 
                    id="{{ form.memo.id_for_label }}"
                    rows="6"
                    placeholder="ãã®ä»–ã®æ°—ã¥ãã€æ³¨æ„ç‚¹ã€æ„Ÿæƒ³ãªã©ã‚’è‡ªç”±ã«è¨˜å…¥ã—ã¦ãã ã•ã„...

ä¾‹:
ãƒ»çµŒå–¶é™£ã®ç™ºè¨€ãŒæ°—ã«ãªã£ãŸ
ãƒ»ç«¶åˆä»–ç¤¾ã®å‹•å‘ã‚‚ãƒã‚§ãƒƒã‚¯å¿…è¦
ãƒ»æ¬¡ã®æ±ºç®—ç™ºè¡¨ã¯â—‹æœˆâ—‹æ—¥
ãƒ»ã“ã®ä¾¡æ ¼å¸¯ã§è²·ã„å¢—ã—ã‚’æ¤œè¨"
                    maxlength="1000">{{ form.memo.value|default:'' }}</textarea>
          <div class="character-count" id="memoCharCount">0 / 1000æ–‡å­—</div>
          {% if form.memo.errors %}
          <div class="text-danger small mt-1">{{ form.memo.errors }}</div>
          {% endif %}
        </div>

        <!-- åˆå›è³¼å…¥æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ–°è¦ä½œæˆæ™‚ã®ã¿ï¼‰ -->
        {% if not form.instance.pk %}
        <div class="form-section">
          <div class="form-check mb-3">
            <input type="checkbox" class="form-check-input" 
                   id="id_add_initial_purchase" 
                   name="add_initial_purchase"
                   {% if form.add_initial_purchase.value %}checked{% endif %}>
            <label class="form-check-label" for="id_add_initial_purchase">
              <strong>{{ form.add_initial_purchase.label }}</strong>
              <small class="d-block text-muted">
                ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã€æ—¥è¨˜ä½œæˆã¨åŒæ™‚ã«æœ€åˆã®è³¼å…¥å–å¼•ã‚’è¨˜éŒ²ã§ãã¾ã™
              </small>
            </label>
          </div>
        
          <div class="initial-purchase-section" id="initialPurchaseSection" 
               {% if not form.add_initial_purchase.value %}style="display: none;"{% endif %}>
            
            <!-- æƒ…å ±ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½¿ç”¨ï¼‰ -->
            {% include "stockdiary/components/_alert.html" with type="info" icon="bi-info-circle" message="<strong>åˆå›è³¼å…¥ã«ã¤ã„ã¦:</strong><ul class='mb-0 mt-2 small'><li>æ—¥è¨˜ä½œæˆå¾Œã€ã€Œå–å¼•å±¥æ­´ã€ã‚¿ãƒ–ã‹ã‚‰è¿½åŠ è³¼å…¥ãƒ»å£²å´ã‚’è¨˜éŒ²ã§ãã¾ã™</li><li>ã¾ã è³¼å…¥ã—ã¦ã„ãªã„å ´åˆã¯ã€ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦ãã ã•ã„</li><li>å¾Œã‹ã‚‰ã€Œå–å¼•å±¥æ­´ã€ã‚¿ãƒ–ã§è¿½åŠ ã§ãã¾ã™</li></ul>" %}
        
            <h6 class="mb-3">
              <i class="bi bi-cart-plus"></i> åˆå›è³¼å…¥æƒ…å ±
            </h6>
        
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="id_initial_purchase_date" class="form-label">
                  <i class="bi bi-calendar-date me-1"></i>è³¼å…¥æ—¥<span class="text-danger">*</span>
                </label>
                <input type="date" 
                       class="form-control" 
                       id="id_initial_purchase_date"
                       name="initial_purchase_date"
                       value="{{ form.initial_purchase_date.value|default:'' }}">
                {% if form.initial_purchase_date.errors %}
                <div class="text-danger small">{{ form.initial_purchase_date.errors }}</div>
                {% endif %}
              </div>
        
              <div class="col-md-4 mb-3">
                <label for="id_initial_purchase_price" class="form-label">
                  <i class="bi bi-currency-yen me-1"></i>è³¼å…¥å˜ä¾¡ï¼ˆå††ï¼‰<span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <input type="number" 
                         class="form-control" 
                         id="id_initial_purchase_price"
                         name="initial_purchase_price"
                         step="0.01" 
                         min="0.01"
                         placeholder="ä¾‹: 1000.00"
                         value="{{ form.initial_purchase_price.value|default:'' }}">
                  <button type="button" class="btn btn-outline-primary" 
                          id="fetch-current-price" title="ç¾åœ¨æ ªä¾¡ã‚’å–å¾—">
                    <i class="bi bi-arrow-repeat"></i> ç¾åœ¨æ ªä¾¡
                  </button>
                </div>
                <small class="form-text text-muted">1æ ªã‚ãŸã‚Šã®å˜ä¾¡</small>
                {% if form.initial_purchase_price.errors %}
                <div class="text-danger small">{{ form.initial_purchase_price.errors }}</div>
                {% endif %}
              </div>
        
              <div class="col-md-4 mb-3">
                <label for="id_initial_purchase_quantity" class="form-label">
                  <i class="bi bi-stack me-1"></i>è³¼å…¥æ•°é‡ï¼ˆæ ªï¼‰<span class="text-danger">*</span>
                </label>
                <input type="number" 
                       class="form-control"
                       id="id_initial_purchase_quantity"
                       name="initial_purchase_quantity"
                       step="1" 
                       min="1"
                       placeholder="ä¾‹: 100"
                       value="{{ form.initial_purchase_quantity.value|default:'' }}">
                <small class="form-text text-muted">å–å¼•æ ªæ•°</small>
                {% if form.initial_purchase_quantity.errors %}
                <div class="text-danger small">{{ form.initial_purchase_quantity.errors }}</div>
                {% endif %}
              </div>
            </div>
        
            <!-- åˆè¨ˆé‡‘é¡ã®è¡¨ç¤ºï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½¿ç”¨ï¼‰ -->
            <div id="initial-purchase-preview" style="display: none;">
              {% include "stockdiary/components/_alert.html" with type="success" icon="bi-calculator" %}
              <div class="alert alert-success d-flex justify-content-between align-items-center">
                <strong><i class="bi bi-calculator me-2"></i>åˆå›è³¼å…¥é‡‘é¡:</strong>
                <span id="initial-purchase-amount" class="fs-5 fw-bold">0</span>å††
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- ç”»åƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="bi bi-image"></i> ç”»åƒæ·»ä»˜ï¼ˆä»»æ„ï¼‰
          </h4>

          <div class="mb-3">
            <label for="id_image" class="form-label">
              <i class="bi bi-cloud-upload me-1"></i>ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«
            </label>
            {{ form.image }}
            <small class="form-text text-muted">
              ãƒãƒ£ãƒ¼ãƒˆã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç­‰ï¼ˆæœ€å¤§10MBã€JPEG/PNG/GIF/WebPå½¢å¼ï¼‰
            </small>

            <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div id="image-preview-container" class="mt-3" style="display: none;">
              <div class="card" style="max-width: 300px;">
                <img id="image-preview" class="card-img-top" 
                     style="max-height: 200px; object-fit: cover;" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                <div class="card-body p-2">
                  <small class="text-muted">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</small>
                  <button type="button" id="remove-image" class="btn btn-sm btn-outline-danger float-end">
                    <i class="bi bi-x"></i> å‰Šé™¤
                  </button>
                </div>
              </div>
            </div>

            <!-- æ—¢å­˜ç”»åƒï¼ˆç·¨é›†æ™‚ï¼‰ -->
            {% if form.instance.image_url %}
            <div class="mt-3">
              <div class="card" style="max-width: 300px;">
                <img src="{{ form.instance.image_url }}" class="card-img-top"
                     style="max-height: 200px; object-fit: cover;" alt="ç¾åœ¨ã®ç”»åƒ">
                <div class="card-body p-2">
                  <small class="text-muted">ç¾åœ¨ã®ç”»åƒ</small>
                  <div class="form-check mt-1">
                    <input type="checkbox" id="clear-image" name="clear_image" class="form-check-input">
                    <label for="clear-image" class="form-check-label small">
                      ã“ã®ç”»åƒã‚’å‰Šé™¤ã™ã‚‹
                    </label>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <div class="form-footer">
          <a href="{% if form.instance.pk %}{% url 'stockdiary:detail' form.instance.pk %}{% else %}{% url 'stockdiary:home' %}{% endif %}"
             class="btn btn-diary btn-diary-outline">
            <i class="bi bi-arrow-left me-1"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </a>
          <button type="submit" class="btn btn-diary btn-diary-primary" id="submitBtn">
            <i class="bi bi-save me-1"></i> ä¿å­˜
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% include 'speed_dial.html' with actions=form_actions %}
{% endblock %}

{% block scripts %}
{{ block.super }}
<!-- EasyMDE Markdown Editor -->
<script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>
<script>

document.addEventListener('DOMContentLoaded', function() {

// ============================================
// ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆæ©Ÿèƒ½
// ============================================
const stockSymbolInput = document.getElementById('id_stock_symbol');
let autocompleteTimeout;
let autocompleteResults = [];
let selectedIndex = -1;

if (stockSymbolInput) {
  // ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç”¨ã®çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ä½œæˆ
  const autocompleteContainer = document.createElement('div');
  autocompleteContainer.id = 'autocomplete-results';
  autocompleteContainer.className = 'autocomplete-results';
  autocompleteContainer.style.cssText = `
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 300px;
    overflow-y: auto;
    border-radius: var(--radius-md, 0.375rem);
    z-index: 1000;
    display: none;
  `;
  
  // å…¥åŠ›ã‚°ãƒ«ãƒ¼ãƒ—ã®è¦ªè¦ç´ ã«è¿½åŠ 
  const inputGroup = stockSymbolInput.closest('.input-group');
  if (inputGroup) {
    inputGroup.style.position = 'relative';
    inputGroup.appendChild(autocompleteContainer);
  }
  
  // å…¥åŠ›æ™‚ã®ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ
  stockSymbolInput.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    clearTimeout(autocompleteTimeout);
    
    if (query.length < 2) {
      autocompleteContainer.style.display = 'none';
      return;
    }
    
    // 300mså¾Œã«æ¤œç´¢å®Ÿè¡Œ
    autocompleteTimeout = setTimeout(async () => {
      try {
        const response = await fetch(`/stockdiary/api/stock/search/?query=${encodeURIComponent(query)}&limit=10`);
        const data = await response.json();
        
        if (data.success && data.companies.length > 0) {
          autocompleteResults = data.companies;
          displayAutocompleteResults(data.companies);
        } else {
          autocompleteContainer.style.display = 'none';
        }
      } catch (error) {
        console.error('Autocomplete error:', error);
        autocompleteContainer.style.display = 'none';
      }
    }, 300);
  });
  
  // çµæœã‚’è¡¨ç¤º
  function displayAutocompleteResults(companies) {
    let html = '<div class="list-group list-group-flush">';
    
    companies.forEach((company, index) => {
      html += `
        <button type="button" 
                class="list-group-item list-group-item-action autocomplete-item" 
                data-index="${index}"
                style="border: none; padding: 0.75rem 1rem; cursor: pointer; text-align: left;">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong class="text-primary">${escapeHtml(company.code)}</strong>
              <span class="ms-2">${escapeHtml(company.name)}</span>
            </div>
            <div style="text-align: right;">
              <small class="text-muted d-block">${escapeHtml(company.market)}</small>
              <small class="text-muted d-block">${escapeHtml(company.industry)}</small>
            </div>
          </div>
        </button>
      `;
    });
    
    html += '</div>';
    autocompleteContainer.innerHTML = html;
    autocompleteContainer.style.display = 'block';
    
    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    const items = autocompleteContainer.querySelectorAll('.autocomplete-item');
    items.forEach(item => {
      item.addEventListener('click', function() {
        const index = parseInt(this.dataset.index);
        selectCompany(autocompleteResults[index]);
      });
      
      item.addEventListener('mouseenter', function() {
        this.style.backgroundColor = '';
        this.classList.add('autocomplete-hover');
      });
      item.addEventListener('mouseleave', function() {
        this.style.backgroundColor = '';
        this.classList.remove('autocomplete-hover');
      });
    });
  }
  
  // ä¼æ¥­é¸æŠ
  function selectCompany(company) {
    stockSymbolInput.value = company.code;
    
    const stockNameInput = document.getElementById('id_stock_name');
    const sectorInput = document.getElementById('id_sector');
    
    if (stockNameInput && !stockNameInput.value) {
      stockNameInput.value = company.name;
    }
    
    if (sectorInput && !sectorInput.value) {
      sectorInput.value = company.industry;
    }
    
    autocompleteContainer.style.display = 'none';
    selectedIndex = -1;
    
    // æ ªä¾¡æƒ…å ±ã‚’è‡ªå‹•å–å¾—
    const fetchStockInfoBtn = document.getElementById('fetchStockInfo');
    if (fetchStockInfoBtn) {
      fetchStockInfoBtn.click();
    }
  }
  
  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
  stockSymbolInput.addEventListener('keydown', function(e) {
    const items = autocompleteContainer.querySelectorAll('.autocomplete-item');
    
    if (items.length === 0) return;
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
      updateSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, -1);
      updateSelection(items);
    } else if (e.key === 'Enter' && selectedIndex >= 0) {
      e.preventDefault();
      const index = parseInt(items[selectedIndex].dataset.index);
      selectCompany(autocompleteResults[index]);
    } else if (e.key === 'Escape') {
      autocompleteContainer.style.display = 'none';
      selectedIndex = -1;
    }
  });
  
  function updateSelection(items) {
    items.forEach((item, index) => {
      item.classList.remove('autocomplete-selected');
      if (index === selectedIndex) {
        item.classList.add('autocomplete-selected');
        item.scrollIntoView({ block: 'nearest' });
      }
    });
  }
  
  // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  document.addEventListener('click', function(e) {
    if (!stockSymbolInput.contains(e.target) && !autocompleteContainer.contains(e.target)) {
      autocompleteContainer.style.display = 'none';
      selectedIndex = -1;
    }
  });
}

const fetchStockInfoBtn = document.getElementById('fetchStockInfo');
const stockNameInput = document.getElementById('id_stock_name');
const sectorInput = document.getElementById('id_sector');
const stockInfoCard = document.getElementById('stockInfoCard');
const symbolSpinnerContainer = document.getElementById('symbolSpinnerContainer');

if (fetchStockInfoBtn) {
  fetchStockInfoBtn.addEventListener('click', async function() {
    const stockCode = stockSymbolInput.value.trim();
    
    if (!stockCode) {
      alert('éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      stockSymbolInput.focus();
      return;
    }
    
    fetchStockInfoBtn.disabled = true;
    fetchStockInfoBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    symbolSpinnerContainer.classList.remove('d-none');
    stockInfoCard.classList.add('d-none');
    
    try {
      const response = await fetch(`/stockdiary/api/stock/info/${stockCode}/`);
      
      if (!response.ok) {
        throw new Error('æ ªå¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      
      const data = await response.json();
      
      if (data.success) {
        if (data.company_name) {
          stockNameInput.value = data.company_name;
        }
        
        if (data.industry && data.industry !== 'ä¸æ˜') {
          sectorInput.value = data.industry;
        }
        
        displayStockInfo(data, stockCode);
        showNotification('success', 'éŠ˜æŸ„æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ');
      } else {
        throw new Error(data.error || 'éŠ˜æŸ„æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      
    } catch (error) {
      console.error('Stock info fetch error:', error);
      showNotification('error', error.message);
      stockInfoCard.classList.add('d-none');
    } finally {
      fetchStockInfoBtn.disabled = false;
      fetchStockInfoBtn.innerHTML = '<i class="bi bi-search"></i> æ¤œç´¢';
      symbolSpinnerContainer.classList.add('d-none');
    }
  });
}

// æ ªå¼æƒ…å ±è¡¨ç¤º
function displayStockInfo(data, stockCode) {
  document.getElementById('stockInfoTitle').textContent = data.company_name || 'éŠ˜æŸ„æƒ…å ±';
  document.getElementById('stockInfoCode').textContent = stockCode;
  document.getElementById('stockInfoCode').className = 'badge badge-primary';
  
  if (data.price !== null && data.price !== undefined) {
    document.getElementById('stockInfoPrice').textContent = 
      `${parseFloat(data.price).toLocaleString('ja-JP', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      })}å††`;
  } else {
    document.getElementById('stockInfoPrice').textContent = 'å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
  }
  
  if (data.change_percent !== null && data.change_percent !== undefined) {
    const changeElement = document.getElementById('stockInfoChange');
    const changePercent = parseFloat(data.change_percent);
    const changeClass = changePercent > 0 ? 'profit-positive' : 
                       (changePercent < 0 ? 'profit-negative' : 'text-muted');
    const changeSign = changePercent > 0 ? '+' : '';
    
    changeElement.textContent = `${changeSign}${changePercent.toFixed(2)}%`;
    changeElement.className = `info-value ${changeClass}`;
  } else {
    document.getElementById('stockInfoChange').textContent = '--';
  }
  
  document.getElementById('stockInfoMarket').textContent = data.market || 'ä¸æ˜';
  document.getElementById('stockInfoIndustry').textContent = data.industry || 'ä¸æ˜';
  
  stockInfoCard.classList.remove('d-none');
}

// é€šçŸ¥è¡¨ç¤º
function showNotification(type, message) {
  const existingNotification = document.querySelector('.custom-notification');
  if (existingNotification) {
    existingNotification.remove();
  }
  
  const notification = document.createElement('div');
  const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
  const iconClass = type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle';
  
  notification.className = `alert ${alertClass} alert-dismissible fade show custom-notification`;
  notification.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
  notification.innerHTML = `
    <i class="bi ${iconClass} me-2"></i>
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

// ============================================
// EasyMDE Markdown Editor åˆæœŸåŒ–
// ============================================
const reasonTextareaEl = document.getElementById('id_reason');
const reasonCharCount = document.getElementById('reasonCharCount');
const MAX_REASON_LENGTH = 5000;

if (reasonTextareaEl) {
  const easyMDE = new EasyMDE({
    element: reasonTextareaEl,
    spellChecker: false,
    autosave: {
      enabled: false,
    },
    placeholder: 'ãªãœã“ã®éŠ˜æŸ„ã«æ³¨ç›®ã—ãŸã®ã‹ã€ã©ã®ã‚ˆã†ãªåˆ†æã‚’ã—ãŸã®ã‹ã€å°†æ¥ã®è¦‹é€šã—ãªã©ã‚’è‡ªç”±ã«è¨˜éŒ²ã—ã¦ãã ã•ã„...\n\n**å¤ªå­—**ã€*æ–œä½“*ã€- ãƒªã‚¹ãƒˆã€## è¦‹å‡ºã— ãªã©ã®Markdownè¨˜æ³•ãŒä½¿ãˆã¾ã™',
    maxHeight: '400px',
    // toolbar: [
    //   'bold', 'italic', 'heading', '|',
    //   'unordered-list', 'ordered-list', '|',
    //   'link', 'quote', 'code', 'table', '|',
    //   'preview', 'side-by-side', 'fullscreen', 'guide'
    // ],
    toolbar: [
      'bold', 'italic', 'heading', '|',
      'unordered-list', 'ordered-list', '|',
      'link', 'quote', '|',
      'preview', 'fullscreen', 'side-by-side'
    ],  
    status: false,
    renderingConfig: {
      singleLineBreaks: true,
      codeSyntaxHighlighting: false,
    },
    uploadImage: false,
  });

  // EasyMDEç”¨ã®æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
  function updateEasyMDECharCount() {
    const count = easyMDE.value().length;
    reasonCharCount.textContent = `${count} / ${MAX_REASON_LENGTH}æ–‡å­—`;

    reasonCharCount.classList.remove('warning', 'danger');
    if (count > MAX_REASON_LENGTH * 0.9) {
      reasonCharCount.classList.add('danger');
    } else if (count > MAX_REASON_LENGTH * 0.7) {
      reasonCharCount.classList.add('warning');
    }
  }

  easyMDE.codemirror.on('change', updateEasyMDECharCount);
  updateEasyMDECharCount();

  // é€ä¿¡å‰ã®æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯
  const diaryForm = document.getElementById('diaryForm');
  if (diaryForm) {
    diaryForm.addEventListener('submit', function(e) {
      if (easyMDE.value().length > MAX_REASON_LENGTH) {
        e.preventDefault();
        alert(`æŠ•è³‡ç†ç”±ã¯${MAX_REASON_LENGTH}æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ç¾åœ¨: ${easyMDE.value().length}æ–‡å­—`);
        return false;
      }
    });
  }
}

// ============================================
// ãƒ¡ãƒ¢æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
// ============================================
const memoTextarea = document.getElementById('{{ form.memo.id_for_label }}');
const memoCharCount = document.getElementById('memoCharCount');

function updateCharCount(textarea, countElement, maxLength) {
  const count = textarea.value.length;
  countElement.textContent = `${count} / ${maxLength}æ–‡å­—`;

  countElement.classList.remove('warning', 'danger');
  if (count > maxLength * 0.9) {
    countElement.classList.add('danger');
  } else if (count > maxLength * 0.7) {
    countElement.classList.add('warning');
  }
}

if (memoTextarea && memoCharCount) {
  updateCharCount(memoTextarea, memoCharCount, 1000);
  memoTextarea.addEventListener('input', function() {
    updateCharCount(this, memoCharCount, 1000);
  });
}

// ============================================
// åˆå›è³¼å…¥æƒ…å ±ã®è¡¨ç¤º/éè¡¨ç¤º
// ============================================
const addInitialPurchaseCheckbox = document.getElementById('id_add_initial_purchase');
const initialPurchaseSection = document.getElementById('initialPurchaseSection');

if (addInitialPurchaseCheckbox && initialPurchaseSection) {
  addInitialPurchaseCheckbox.addEventListener('change', function() {
    if (this.checked) {
      initialPurchaseSection.style.display = 'block';
      initialPurchaseSection.classList.add('active');
      updateRequiredFields(true);
    } else {
      initialPurchaseSection.style.display = 'none';
      initialPurchaseSection.classList.remove('active');
      updateRequiredFields(false);
    }
  });
}

function updateRequiredFields(required) {
  const dateField = document.getElementById('id_initial_purchase_date');
  const priceField = document.getElementById('id_initial_purchase_price');
  const quantityField = document.getElementById('id_initial_purchase_quantity');
  
  [dateField, priceField, quantityField].forEach(field => {
    if (field) {
      if (required) {
        field.setAttribute('required', 'required');
      } else {
        field.removeAttribute('required');
        field.value = '';
      }
    }
  });
  
  if (!required) {
    const preview = document.getElementById('initial-purchase-preview');
    if (preview) {
      preview.style.display = 'none';
    }
  }
}

// ============================================
// åˆè¨ˆé‡‘é¡ã®è¨ˆç®—
// ============================================
function updateInitialPurchasePreview() {
  const priceField = document.getElementById('id_initial_purchase_price');
  const quantityField = document.getElementById('id_initial_purchase_quantity');
  const checkbox = document.getElementById('id_add_initial_purchase');
  const preview = document.getElementById('initial-purchase-preview');
  const amountElement = document.getElementById('initial-purchase-amount');
  
  if (!priceField || !quantityField || !checkbox || !preview || !amountElement) return;
  
  const price = parseFloat(priceField.value) || 0;
  const quantity = parseFloat(quantityField.value) || 0;
  
  if (price > 0 && quantity > 0 && checkbox.checked) {
    const amount = price * quantity;
    amountElement.textContent = amount.toLocaleString('ja-JP', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });
    preview.style.display = 'block';
  } else {
    preview.style.display = 'none';
  }
}

const priceField = document.getElementById('id_initial_purchase_price');
const quantityField = document.getElementById('id_initial_purchase_quantity');

if (priceField) {
  priceField.addEventListener('input', updateInitialPurchasePreview);
}

if (quantityField) {
  quantityField.addEventListener('input', updateInitialPurchasePreview);
}

// ============================================
// ç¾åœ¨æ ªä¾¡å–å¾—
// ============================================
const fetchCurrentPriceBtn = document.getElementById('fetch-current-price');
if (fetchCurrentPriceBtn) {
  fetchCurrentPriceBtn.addEventListener('click', async function() {
    const stockCode = stockSymbolInput.value.trim();
    const priceInput = document.getElementById('id_initial_purchase_price');
    
    if (!stockCode) {
      alert('éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      stockSymbolInput.focus();
      return;
    }
    
    fetchCurrentPriceBtn.disabled = true;
    fetchCurrentPriceBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    try {
      const response = await fetch(`/stockdiary/api/stock/price/${stockCode}/`);
      
      if (!response.ok) {
        throw new Error('æ ªä¾¡ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      
      const data = await response.json();
      
      if (data.success && data.price) {
        priceInput.value = parseFloat(data.price).toFixed(2);
        updateInitialPurchasePreview();
        showNotification('success', 'ç¾åœ¨æ ªä¾¡ã‚’å–å¾—ã—ã¾ã—ãŸ');
      } else {
        throw new Error('æ ªä¾¡æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      }
      
    } catch (error) {
      console.error('Price fetch error:', error);
      showNotification('error', error.message);
    } finally {
      fetchCurrentPriceBtn.disabled = false;
      fetchCurrentPriceBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> ç¾åœ¨æ ªä¾¡';
    }
  });
}

// ============================================
// ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
// ============================================
const imageInput = document.getElementById('id_image');
const imagePreviewContainer = document.getElementById('image-preview-container');
const imagePreview = document.getElementById('image-preview');
const removeImageBtn = document.getElementById('remove-image');

if (imageInput) {
  imageInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    
    if (file) {
      if (file.size > 10 * 1024 * 1024) {
        alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
        imageInput.value = '';
        return;
      }
      
      const validFormats = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
      if (!validFormats.includes(file.type)) {
        alert('JPEGã€PNGã€GIFã€WebPå½¢å¼ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™');
        imageInput.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        imagePreviewContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  });
}

if (removeImageBtn) {
  removeImageBtn.addEventListener('click', function() {
    imageInput.value = '';
    imagePreviewContainer.style.display = 'none';
    imagePreview.src = '';
  });
}

// ============================================
// åˆ†æãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå±•é–‹
// ============================================
const analysisTemplateSelect = document.getElementById('id_analysis_template');
const expandAnalysisBtn = document.getElementById('expandAnalysisBtn');
const analysisItemsContainer = document.getElementById('analysisItemsContainer');
const analysisItemsContent = document.getElementById('analysisItemsContent');

if (expandAnalysisBtn) {
  expandAnalysisBtn.addEventListener('click', function() {
    const templateId = analysisTemplateSelect.value;
    
    if (!templateId) {
      alert('åˆ†æãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
      analysisTemplateSelect.focus();
      return;
    }
    
    analysisItemsContainer.classList.remove('d-none');
    loadAnalysisItems(templateId);
  });
}

if (analysisTemplateSelect) {
  analysisTemplateSelect.addEventListener('change', function() {
    if (this.value && !analysisItemsContainer.classList.contains('d-none')) {
      loadAnalysisItems(this.value);
    }
  });
}

async function loadAnalysisItems(templateId) {
  analysisItemsContent.innerHTML = `
    <div class="text-center py-3">
      <div class="loading-spinner"></div>
      <div class="loading-text mt-2">åˆ†æé …ç›®ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
    </div>
  `;
  
  try {
    const diaryId = '{{ form.instance.pk|default:"" }}';
    let url = `/analysis_template/api/items/?template_id=${templateId}`;
    
    if (diaryId) {
      url += `&diary_id=${diaryId}`;
    }
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error('åˆ†æé …ç›®ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.error || 'åˆ†æé …ç›®ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
    renderAnalysisItems(data.items, data.values || {});
    
  } catch (error) {
    console.error('Analysis items fetch error:', error);
    analysisItemsContent.innerHTML = `
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        åˆ†æé …ç›®ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}
        <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="loadAnalysisItems(${templateId})">
          <i class="bi bi-arrow-clockwise"></i> å†è©¦è¡Œ
        </button>
      </div>
    `;
  }
}


function renderAnalysisItems(items, values = {}) {
  if (!items || items.length === 0) {
    analysisItemsContent.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon"><i class="bi bi-info-circle"></i></div>
        <h4>åˆ†æé …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</h4>
        <p>ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã¯åˆ†æé …ç›®ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  
  items.forEach((item, index) => {
    const existingValue = values[item.id];
    
    let icon = 'bi-circle';
    if (item.item_type === 'boolean') icon = 'bi-check-circle';
    else if (item.item_type === 'boolean_with_value') icon = 'bi-check-square';
    else if (item.item_type === 'number') icon = 'bi-123';
    else if (item.item_type === 'select') icon = 'bi-list-ul';
    else if (item.item_type === 'text') icon = 'bi-text-left';
    
    html += `<div class="analysis-item">`;
    
    if (item.item_type === 'boolean') {
      const checked = existingValue === true ? 'checked' : '';
      
      html += `
        <div class="analysis-item-header">
          <div class="analysis-item-label-wrapper">
            <i class="bi ${icon}"></i>
            <div>
              <label class="analysis-item-label" for="analysis_item_${item.id}">
                ${escapeHtml(item.name)}
              </label>
              ${item.description ? `<div class="analysis-item-desc">${escapeHtml(item.description)}</div>` : ''}
            </div>
          </div>
          <div class="analysis-item-checkbox">
            <div class="form-check">
              <input type="checkbox" 
                     class="form-check-input" 
                     name="analysis_item_${item.id}" 
                     id="analysis_item_${item.id}"
                     ${checked}>
            </div>
          </div>
        </div>
      `;
      
    } else if (item.item_type === 'boolean_with_value') {
      const boolChecked = existingValue?.boolean_value === true ? 'checked' : '';
      const numberValue = existingValue?.number_value ?? '';
      const valueLabel = item.value_label || 'å€¤';
      
      html += `
        <div class="analysis-item-header">
          <div class="analysis-item-label-wrapper">
            <i class="bi ${icon}"></i>
            <div>
              <label class="analysis-item-label">
                ${escapeHtml(item.name)}
              </label>
              ${item.description ? `<div class="analysis-item-desc">${escapeHtml(item.description)}</div>` : ''}
            </div>
          </div>
        </div>
        
        <div class="compound-input-wrapper">
          <div class="compound-checkbox-row">
            <input type="checkbox" 
                   class="form-check-input" 
                   name="analysis_item_${item.id}_boolean" 
                   id="analysis_item_${item.id}_boolean"
                   ${boolChecked}>
            <label class="form-check-label" for="analysis_item_${item.id}_boolean">
              è©²å½“ã™ã‚‹
            </label>
          </div>
          <div>
            <label class="form-label">${escapeHtml(valueLabel)}</label>
            <input type="number" 
                   class="form-control" 
                   name="analysis_item_${item.id}_value" 
                   id="analysis_item_${item.id}_value"
                   step="0.01"
                   placeholder="æ•°å€¤ã‚’å…¥åŠ›"
                   value="${numberValue}">
          </div>
        </div>
      `;
      
    } else if (item.item_type === 'number') {
      const value = existingValue ?? '';
      
      html += `
        <div class="analysis-item-header">
          <div class="analysis-item-label-wrapper">
            <i class="bi ${icon}"></i>
            <div>
              <label class="analysis-item-label" for="analysis_item_${item.id}">
                ${escapeHtml(item.name)}
              </label>
              ${item.description ? `<div class="analysis-item-desc">${escapeHtml(item.description)}</div>` : ''}
            </div>
          </div>
        </div>
        <div class="analysis-item-input-section">
          <input type="number" 
                 class="form-control" 
                 name="analysis_item_${item.id}" 
                 id="analysis_item_${item.id}"
                 step="0.01"
                 placeholder="æ•°å€¤ã‚’å…¥åŠ›"
                 value="${value}">
        </div>
      `;
      
    } else if (item.item_type === 'select') {
      html += `
        <div class="analysis-item-header">
          <div class="analysis-item-label-wrapper">
            <i class="bi ${icon}"></i>
            <div>
              <label class="analysis-item-label" for="analysis_item_${item.id}">
                ${escapeHtml(item.name)}
              </label>
              ${item.description ? `<div class="analysis-item-desc">${escapeHtml(item.description)}</div>` : ''}
            </div>
          </div>
        </div>
        <div class="analysis-item-input-section">
          <select class="form-select" 
                  name="analysis_item_${item.id}" 
                  id="analysis_item_${item.id}">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      `;
      
      let choicesList = [];
      if (item.choices) {
        if (Array.isArray(item.choices)) {
          choicesList = item.choices;
        } else if (typeof item.choices === 'string') {
          choicesList = item.choices.split(',').map(c => c.trim()).filter(c => c);
        }
      }
      
      choicesList.forEach(choice => {
        const selected = existingValue === choice ? 'selected' : '';
        html += `<option value="${escapeHtml(choice)}" ${selected}>${escapeHtml(choice)}</option>`;
      });
      
      html += `</select></div>`;
      
    } else {
      const value = existingValue ?? '';
      html += `
        <div class="analysis-item-header">
          <div class="analysis-item-label-wrapper">
            <i class="bi ${icon}"></i>
            <div>
              <label class="analysis-item-label" for="analysis_item_${item.id}">
                ${escapeHtml(item.name)}
              </label>
              ${item.description ? `<div class="analysis-item-desc">${escapeHtml(item.description)}</div>` : ''}
            </div>
          </div>
        </div>
        <div class="analysis-item-input-section">
          <input type="text" 
                 class="form-control" 
                 name="analysis_item_${item.id}" 
                 id="analysis_item_${item.id}"
                 placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›"
                 value="${escapeHtml(value)}">
        </div>
      `;
    }
    
    html += `</div>`;
  });
  
  analysisItemsContent.innerHTML = html;
}


// ============================================
// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
// ============================================
const form = document.getElementById('diaryForm');
if (form) {
  form.addEventListener('submit', function(e) {
    const checkbox = document.getElementById('id_add_initial_purchase');
    
    if (checkbox && checkbox.checked) {
      const errors = validateInitialPurchase();
      
      if (errors.length > 0) {
        e.preventDefault();
        alert('å…¥åŠ›ã‚¨ãƒ©ãƒ¼:\n' + errors.join('\n'));
        return false;
      }
    }
    
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>ä¿å­˜ä¸­...';
    }
  });
}

function validateInitialPurchase() {
  const errors = [];
  const dateField = document.getElementById('id_initial_purchase_date');
  const priceField = document.getElementById('id_initial_purchase_price');
  const quantityField = document.getElementById('id_initial_purchase_quantity');
  
  if (!dateField.value) {
    errors.push('è³¼å…¥æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  }
  
  const price = parseFloat(priceField.value);
  if (!price || price <= 0) {
    errors.push('è³¼å…¥å˜ä¾¡ã¯æ­£ã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  }
  
  const quantity = parseFloat(quantityField.value);
  if (!quantity || quantity <= 0) {
    errors.push('è³¼å…¥æ•°é‡ã¯æ­£ã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  }
  
  return errors;
}

// ============================================
// åˆæœŸåŒ–å‡¦ç†
// ============================================
if (addInitialPurchaseCheckbox && addInitialPurchaseCheckbox.checked) {
  updateInitialPurchasePreview();
}

// ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®åˆæœŸåŒ–
const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl);
});
});

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

</script>
{% endblock %}