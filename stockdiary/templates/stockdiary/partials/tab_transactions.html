{% load stockdiary_filters %}
{% load humanize %}

<div class="px-2 py-3">
  <!-- 取引サマリー -->
  <div class="transaction-summary mb-4">
    <div class="row g-3">
      <div class="col-md-3 col-6">
        <div class="summary-card">
          <div class="summary-label">現在保有数</div>
          <div class="summary-value">
            {{ diary.current_quantity|floatformat:0 }}<span class="unit">株</span>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="summary-card">
          <div class="summary-label">平均取得単価</div>
          <div class="summary-value">
            {% if diary.average_purchase_price %}
              {{ diary.average_purchase_price|floatformat:2|intcomma }}<span class="unit">円</span>
            {% else %}
              <span class="text-muted">--</span>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="summary-card">
          <div class="summary-label">総取得原価</div>
          <div class="summary-value">
            {{ diary.total_cost|floatformat:0|intcomma }}<span class="unit">円</span>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="summary-card {% if diary.realized_profit > 0 %}profit{% elif diary.realized_profit < 0 %}loss{% endif %}">
          <div class="summary-label">実現損益</div>
          <div class="summary-value">
            {% if diary.realized_profit > 0 %}+{% endif %}{{ diary.realized_profit|floatformat:0|intcomma }}<span class="unit">円</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- アクションボタン -->
  <div class="d-flex gap-2 mb-3">
    <button type="button" class="btn btn-primary btn-sm" onclick="toggleAddForm()">
      <i class="bi bi-cart-plus me-1"></i>取引を追加
    </button>
    <button type="button" class="btn btn-info btn-sm" onclick="toggleSplitForm()">
      <i class="bi bi-scissors me-1"></i>株式分割を追加
    </button>
  </div>

  <!-- 取引追加フォーム（折りたたみ） -->
  <div id="addTransactionForm" class="card mb-3" style="display: none;">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <span><i class="bi bi-plus-circle me-2"></i>取引を追加</span>
      <button type="button" class="btn-close btn-close-white" onclick="closeAddForm()"></button>
    </div>
    <div class="card-body">
      <form method="post" action="{% url 'stockdiary:add_transaction' diary.id %}" id="addForm">
        {% csrf_token %}
        
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">取引種別<span class="text-danger">*</span></label>
            <select class="form-select" name="transaction_type" required>
              <option value="buy">購入</option>
              <option value="sell">売却</option>
            </select>
          </div>
          
          <div class="col-md-6">
            <label class="form-label">取引日<span class="text-danger">*</span></label>
            <input type="date" class="form-control" name="transaction_date" 
                   value="{% now 'Y-m-d' %}" required>
          </div>
          
          <div class="col-md-6">
            <label class="form-label">単価（円）<span class="text-danger">*</span></label>
            <input type="number" class="form-control" name="price" 
                   step="0.01" min="0.01" placeholder="例: 1000.00" required>
          </div>
          
          <div class="col-md-6">
            <label class="form-label">数量（株）<span class="text-danger">*</span></label>
            <input type="number" class="form-control" name="quantity" 
                   step="1" min="1" placeholder="例: 100" required>
          </div>
          
          <div class="col-12">
            <label class="form-label">メモ（任意）</label>
            <textarea class="form-control" name="memo" rows="2" maxlength="500"></textarea>
          </div>
        </div>
        
        <div class="mt-3">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save me-1"></i>保存
          </button>
          <button type="button" class="btn btn-secondary" onclick="closeAddForm()">
            キャンセル
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 株式分割追加フォーム（折りたたみ） -->
  <div id="addSplitForm" class="card mb-3" style="display: none;">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
      <span><i class="bi bi-scissors me-2"></i>株式分割を追加</span>
      <button type="button" class="btn-close btn-close-white" onclick="closeSplitForm()"></button>
    </div>
    <div class="card-body">
      <form method="post" action="{% url 'stockdiary:add_stock_split' diary.id %}">
        {% csrf_token %}
        
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          株式分割の情報を登録します。「適用」すると分割日以前の取引が自動調整されます。
        </div>
        
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">分割実行日<span class="text-danger">*</span></label>
            <input type="date" class="form-control" name="split_date" 
                   value="{% now 'Y-m-d' %}" required>
          </div>
          
          <div class="col-md-6">
            <label class="form-label">分割比率<span class="text-danger">*</span></label>
            <input type="number" class="form-control" name="split_ratio" 
                   step="0.0001" min="0.0001" placeholder="例: 2.0" required>
            <small class="form-text text-muted">1株が何株になるか（例: 1→2株なら「2.0」）</small>
          </div>
          
          <div class="col-12">
            <label class="form-label">メモ（任意）</label>
            <textarea class="form-control" name="memo" rows="2" maxlength="500"></textarea>
          </div>
        </div>
        
        <div class="mt-3">
          <button type="submit" class="btn btn-info">
            <i class="bi bi-scissors me-1"></i>追加
          </button>
          <button type="button" class="btn btn-secondary" onclick="closeSplitForm()">
            キャンセル
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 取引履歴 -->
  {% if transactions or stock_splits %}
  <div class="transaction-list">
    <h6 class="mb-3">
      <i class="bi bi-clock-history me-1"></i>取引履歴（全{{ transactions|length }}件）
    </h6>

    {% for item in combined_history %}
      {% if item.type == 'transaction' %}
        {% with transaction=item.data %}
        
        <!-- 通常表示 -->
        <div class="transaction-item mb-3" id="transaction-{{ transaction.id }}">
          <div class="transaction-header">
            <div class="transaction-date">
              <i class="bi bi-calendar-date"></i>
              {{ transaction.transaction_date|date:"Y年m月d日" }}
            </div>
            <div class="transaction-badges">
              <span class="badge {% if transaction.transaction_type == 'buy' %}bg-primary{% else %}bg-danger{% endif %}">
                {{ transaction.get_transaction_type_display }}
              </span>
              <button class="btn btn-sm btn-outline-secondary" 
                      onclick="showEditForm({{ transaction.id }})">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" 
                      onclick="deleteTransaction({{ transaction.id }}, '{{ transaction.transaction_date|date:"Y年m月d日" }}')">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>

          <div class="transaction-body">
            <div class="transaction-details">
              <div class="detail-row">
                <span class="detail-label">単価:</span>
                <span class="detail-value">{{ transaction.price|floatformat:2|intcomma }}円</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">数量:</span>
                <span class="detail-value">{{ transaction.quantity|floatformat:0 }}株</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">金額:</span>
                <span class="detail-value strong">{{ transaction.amount|floatformat:0|intcomma }}円</span>
              </div>
            </div>

            {% if transaction.memo %}
            <div class="transaction-memo">
              <i class="bi bi-chat-left-text text-muted me-1"></i>
              <small>{{ transaction.memo }}</small>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- 編集フォーム（初期は非表示） -->
        <div class="card mb-3" id="edit-form-{{ transaction.id }}" style="display: none;">
          <div class="card-header bg-warning d-flex justify-content-between align-items-center">
            <span><i class="bi bi-pencil me-2"></i>取引を編集</span>
            <button type="button" class="btn-close" onclick="hideEditForm({{ transaction.id }})"></button>
          </div>
          <div class="card-body">
            <form method="post" action="{% url 'stockdiary:update_transaction' transaction.id %}">
              {% csrf_token %}
              
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">取引種別</label>
                  <select class="form-select" name="transaction_type" required>
                    <option value="buy" {% if transaction.transaction_type == 'buy' %}selected{% endif %}>購入</option>
                    <option value="sell" {% if transaction.transaction_type == 'sell' %}selected{% endif %}>売却</option>
                  </select>
                </div>
                
                <div class="col-md-6">
                  <label class="form-label">取引日</label>
                  <input type="date" class="form-control" name="transaction_date" 
                         value="{{ transaction.transaction_date|date:'Y-m-d' }}" required>
                </div>
                
                <div class="col-md-6">
                  <label class="form-label">単価（円）</label>
                  <input type="number" class="form-control" name="price" 
                         value="{{ transaction.price }}" step="0.01" min="0.01" required>
                </div>
                
                <div class="col-md-6">
                  <label class="form-label">数量（株）</label>
                  <input type="number" class="form-control" name="quantity" 
                         value="{{ transaction.quantity }}" step="1" min="1" required>
                </div>
                
                <div class="col-12">
                  <label class="form-label">メモ</label>
                  <textarea class="form-control" name="memo" rows="2" maxlength="500">{{ transaction.memo }}</textarea>
                </div>
              </div>
              
              <div class="mt-3">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-save me-1"></i>更新
                </button>
                <button type="button" class="btn btn-secondary" onclick="hideEditForm({{ transaction.id }})">
                  キャンセル
                </button>
              </div>
            </form>
          </div>
        </div>
        
        {% endwith %}

      {% elif item.type == 'split' %}
        {% with split=item.data %}
        <div class="split-item mb-3">
          <div class="split-header">
            <div class="split-date">
              <i class="bi bi-scissors"></i>
              {{ split.split_date|date:"Y年m月d日" }}
            </div>
            <div class="split-badges">
              <span class="badge bg-info">株式分割</span>
              {% if split.is_applied %}
                <span class="badge bg-success">適用済み</span>
              {% else %}
                <button class="btn btn-sm btn-warning" 
                        onclick="applySplit({{ split.id }})">
                  <i class="bi bi-check-circle me-1"></i>適用
                </button>
                <button class="btn btn-sm btn-outline-danger" 
                        onclick="deleteSplit({{ split.id }})">
                  <i class="bi bi-trash"></i>
                </button>
              {% endif %}
            </div>
          </div>

          <div class="split-body">
            <div class="split-details">
              <div class="detail-row">
                <span class="detail-label">分割比率:</span>
                <span class="detail-value">1株 → {{ split.split_ratio|floatformat:2 }}株</span>
              </div>
            </div>

            {% if split.memo %}
            <div class="split-memo">
              <i class="bi bi-chat-left-text text-muted me-1"></i>
              <small>{{ split.memo }}</small>
            </div>
            {% endif %}

            {% if not split.is_applied %}
            <div class="alert alert-warning mt-2 mb-0 small">
              <i class="bi bi-exclamation-triangle me-1"></i>
              この分割を適用すると、分割日以前の取引が自動調整されます
            </div>
            {% endif %}
          </div>
        </div>
        {% endwith %}
      {% endif %}
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <div class="empty-icon">
      <i class="bi bi-cart-x"></i>
    </div>
    <h6>取引記録はまだありません</h6>
    <p class="text-muted mb-0">「取引を追加」ボタンから最初の取引を記録しましょう</p>
  </div>
  {% endif %}
</div>

<style>
.transaction-summary {
  background-color: #f8f9fa;
  border-radius: 0.5rem;
  padding: 1rem;
}

.summary-card {
  background-color: white;
  border-radius: 0.375rem;
  padding: 1rem;
  text-align: center;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.summary-card.profit {
  border-left: 4px solid #22c55e;
}

.summary-card.loss {
  border-left: 4px solid #ef4444;
}

.summary-label {
  font-size: 0.875rem;
  color: #6b7280;
  margin-bottom: 0.25rem;
}

.summary-value {
  font-size: 1.25rem;
  font-weight: 600;
  color: #1f2937;
}

.summary-value .unit {
  font-size: 0.875rem;
  font-weight: 400;
  color: #6b7280;
  margin-left: 0.25rem;
}

.transaction-item, .split-item {
  background-color: white;
  border: 1px solid #e5e7eb;
  border-radius: 0.5rem;
  padding: 1rem;
}

.transaction-header, .split-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid #f3f4f6;
}

.transaction-date, .split-date {
  font-weight: 500;
  color: #374151;
}

.transaction-badges, .split-badges {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.transaction-body, .split-body {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.transaction-details, .split-details {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 0.5rem;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  padding: 0.25rem 0;
}

.detail-label {
  color: #6b7280;
  font-size: 0.875rem;
}

.detail-value {
  font-weight: 500;
  color: #1f2937;
}

.detail-value.strong {
  font-weight: 600;
  font-size: 1.125rem;
}

.transaction-status, .transaction-memo, .split-memo {
  margin-top: 0.5rem;
  padding-top: 0.5rem;
  border-top: 1px solid #f3f4f6;
}

.empty-state {
  text-align: center;
  padding: 3rem 1rem;
  color: #6b7280;
}

.empty-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

@media (max-width: 768px) {
  .summary-value {
    font-size: 1rem;
  }

  .transaction-details, .split-details {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
const DIARY_ID = {{ diary.id }};

// 追加フォーム表示/非表示
function toggleAddForm() {
  const form = document.getElementById('addTransactionForm');
  const splitForm = document.getElementById('addSplitForm');
  
  // 株式分割フォームが開いていたら閉じる
  splitForm.style.display = 'none';
  
  // すべての編集フォームを閉じる
  document.querySelectorAll('[id^="edit-form-"]').forEach(f => f.style.display = 'none');
  document.querySelectorAll('[id^="transaction-"]').forEach(f => f.style.display = 'block');
  
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
  
  if (form.style.display === 'block') {
    form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

function closeAddForm() {
  document.getElementById('addTransactionForm').style.display = 'none';
  document.getElementById('addForm').reset();
}

// 株式分割フォーム表示/非表示
function toggleSplitForm() {
  const form = document.getElementById('addSplitForm');
  const addForm = document.getElementById('addTransactionForm');
  
  // 取引追加フォームが開いていたら閉じる
  addForm.style.display = 'none';
  
  // すべての編集フォームを閉じる
  document.querySelectorAll('[id^="edit-form-"]').forEach(f => f.style.display = 'none');
  document.querySelectorAll('[id^="transaction-"]').forEach(f => f.style.display = 'block');
  
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
  
  if (form.style.display === 'block') {
    form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

function closeSplitForm() {
  document.getElementById('addSplitForm').style.display = 'none';
}

// 編集フォーム表示
function showEditForm(transactionId) {
  // 他のすべての編集フォームを閉じる
  document.querySelectorAll('[id^="edit-form-"]').forEach(form => {
    form.style.display = 'none';
  });
  document.querySelectorAll('[id^="transaction-"]').forEach(item => {
    item.style.display = 'block';
  });
  
  // 追加フォームを閉じる
  document.getElementById('addTransactionForm').style.display = 'none';
  document.getElementById('addSplitForm').style.display = 'none';
  
  // 該当の取引表示を非表示
  document.getElementById('transaction-' + transactionId).style.display = 'none';
  
  // 該当の編集フォームを表示
  const editForm = document.getElementById('edit-form-' + transactionId);
  editForm.style.display = 'block';
  editForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// 編集フォーム非表示
function hideEditForm(transactionId) {
  document.getElementById('edit-form-' + transactionId).style.display = 'none';
  document.getElementById('transaction-' + transactionId).style.display = 'block';
}

// 取引削除
function deleteTransaction(transactionId, date) {
  if (!confirm(`${date}の取引を削除しますか？\n\n※ この操作は元に戻せません。削除後、平均取得単価が再計算されます。`)) {
    return;
  }
  
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  fetch(`/stockdiary/transaction/${transactionId}/delete/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => {
    if (response.ok) {
      location.reload();
    } else {
      throw new Error('削除に失敗しました');
    }
  })
  .catch(error => {
    alert('削除中にエラーが発生しました: ' + error.message);
  });
}

// 株式分割関連
function applySplit(splitId) {
  if (!confirm('株式分割を適用しますか？\n\n※ 分割日以前の全取引が自動調整されます。\n※ 適用後は編集・削除できなくなります。')) {
    return;
  }
  
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  fetch(`/stockdiary/stock-split/${splitId}/apply/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => {
    if (response.ok) {
      location.reload();
    } else {
      throw new Error('適用に失敗しました');
    }
  })
  .catch(error => {
    alert('適用中にエラーが発生しました: ' + error.message);
  });
}

function deleteSplit(splitId) {
  if (!confirm('この株式分割情報を削除しますか？')) {
    return;
  }
  
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  fetch(`/stockdiary/stock-split/${splitId}/delete/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => {
    if (response.ok) {
      location.reload();
    } else {
      throw new Error('削除に失敗しました');
    }
  })
  .catch(error => {
    alert('削除中にエラーが発生しました: ' + error.message);
  });
}
</script>