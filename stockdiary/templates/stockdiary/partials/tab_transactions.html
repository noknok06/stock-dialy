{% load stockdiary_filters %}
{% load humanize %}

<div class="px-2 py-3">
  <!-- 取引サマリー -->
  <div class="transaction-summary-section mb-4">
    <div class="row g-3">
      <div class="col-md-3 col-6">
        <div class="summary-card-improved">
          <div class="summary-label">現在保有数</div>
          <div class="summary-value">
            {{ diary.current_quantity|floatformat:0 }}<span class="unit">株</span>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="summary-card-improved">
          <div class="summary-label">平均取得単価</div>
          <div class="summary-value">
            {% if diary.average_purchase_price %}
              {{ diary.average_purchase_price|floatformat:2|intcomma }}<span class="unit">円</span>
            {% else %}
              <span class="text-muted">--</span>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="summary-card-improved">
          <div class="summary-label">総取得原価</div>
          <div class="summary-value">
            {{ diary.total_cost|floatformat:0|intcomma }}<span class="unit">円</span>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="summary-card-improved {% if diary.realized_profit > 0 %}profit{% elif diary.realized_profit < 0 %}loss{% endif %}">
          <div class="summary-label">実現損益</div>
          <div class="summary-value">
            {% if diary.realized_profit > 0 %}+{% endif %}{{ diary.realized_profit|floatformat:0|intcomma }}<span class="unit">円</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- アクションボタン -->
  <div class="d-flex gap-2 mb-3">
    <button type="button" class="btn btn-primary" onclick="toggleAddForm()">
      <i class="bi bi-cart-plus me-1"></i>取引を追加
    </button>
    <button type="button" class="btn btn-info" onclick="toggleSplitForm()">
      <i class="bi bi-scissors me-1"></i>株式分割を追加
    </button>
  </div>

  <!-- 取引追加フォーム（折りたたみ） -->
  <div id="addTransactionForm" class="form-card-improved mb-3" style="display: none;">
    <div class="form-header-improved bg-primary">
      <span><i class="bi bi-plus-circle me-2"></i>取引を追加</span>
      <button type="button" class="btn-icon btn-info-icon" onclick="closeAddForm()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="form-body-improved">
      <form method="post" action="{% url 'stockdiary:add_transaction' diary.id %}" id="addForm">
        {% csrf_token %}
        
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label-improved">取引種別<span class="text-danger ms-1">*</span></label>
            <select class="form-input-improved" name="transaction_type" required>
              <option value="buy">購入</option>
              <option value="sell">売却</option>
            </select>
          </div>
          
          <div class="col-md-6">
            <label class="form-label-improved">取引日<span class="text-danger ms-1">*</span></label>
            <input type="date" class="form-input-improved" name="transaction_date" 
                   value="{% now 'Y-m-d' %}" required>
          </div>
          
          <div class="col-md-6">
            <label class="form-label-improved">単価（円）<span class="text-danger ms-1">*</span></label>
            <input type="number" class="form-input-improved" name="price" 
                   step="0.01" min="0.01" placeholder="例: 1000.00" required>
          </div>
          
          <div class="col-md-6">
            <label class="form-label-improved">数量（株）<span class="text-danger ms-1">*</span></label>
            <input type="number" class="form-input-improved" name="quantity" 
                   step="1" min="1" placeholder="例: 100" required>
          </div>
          
          <div class="col-12">
            <label class="form-label-improved">メモ（任意）</label>
            <textarea class="form-input-improved" name="memo" rows="2" maxlength="500"></textarea>
          </div>
        </div>
        
        <div class="form-actions-improved">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save me-1"></i>保存
          </button>
          <button type="button" class="btn btn-secondary" onclick="closeAddForm()">
            キャンセル
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 株式分割追加フォーム（折りたたみ） -->
  <div id="addSplitForm" class="form-card-improved mb-3" style="display: none;">
    <div class="form-header-improved bg-primary">
      <span><i class="bi bi-scissors me-2"></i>株式分割を追加</span>
      <button type="button" class="btn-icon btn-info-icon" onclick="closeSplitForm()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="form-body-improved">
      <form method="post" action="{% url 'stockdiary:add_stock_split' diary.id %}">
        {% csrf_token %}
        
        <div class="alert-info-improved mb-3">
          <i class="bi bi-info-circle me-2"></i>
          株式分割の情報を登録します。「適用」すると分割日以前の取引が自動調整されます。
        </div>
        
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label-improved">分割実行日<span class="text-danger ms-1">*</span></label>
            <input type="date" class="form-input-improved" name="split_date" 
                   value="{% now 'Y-m-d' %}" required>
          </div>
          
          <div class="col-md-6">
            <label class="form-label-improved">分割比率<span class="text-danger ms-1">*</span></label>
            <input type="number" class="form-input-improved" name="split_ratio" 
                   step="0.0001" min="0.0001" placeholder="例: 2.0" required>
            <small class="form-text-improved">1株が何株になるか（例: 1→2株なら「2.0」）</small>
          </div>
          
          <div class="col-12">
            <label class="form-label-improved">メモ（任意）</label>
            <textarea class="form-input-improved" name="memo" rows="2" maxlength="500"></textarea>
          </div>
        </div>
        
        <div class="form-actions-improved">
          <button type="submit" class="btn-icon btn-info-icon">
            <i class="bi bi-scissors me-1"></i>追加
          </button>
          <button type="button" class="btn btn-secondary" onclick="closeSplitForm()">
            キャンセル
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 取引履歴 -->
  {% if transactions or stock_splits %}
  <div class="transaction-list-improved">
    <h6 class="list-header-improved mb-3">
      <i class="bi bi-clock-history me-2"></i>取引履歴（全{{ transactions|length }}件）
    </h6>

    {% for item in combined_history %}
      {% if item.type == 'transaction' %}
        {% with transaction=item.data %}
        
        <!-- 通常表示 -->
        <div class="transaction-item-improved mb-3" id="transaction-{{ transaction.id }}">
          <div class="transaction-header-improved">
            <div class="transaction-date-improved">
              <i class="bi bi-calendar-date me-1"></i>
              {{ transaction.transaction_date|date:"Y年m月d日" }}
            </div>
            <div class="transaction-actions-improved">
              <span class="badge {% if transaction.transaction_type == 'buy' %}badge-primary{% else %}badge-danger{% endif %}">
                {{ transaction.get_transaction_type_display }}
              </span>
              <button class="btn-icon" onclick="showEditForm({{ transaction.id }})">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn-icon btn-danger-icon" onclick="deleteTransaction({{ transaction.id }}, '{{ transaction.transaction_date|date:"Y年m月d日" }}')">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>

          <div class="transaction-body-improved">
            <div class="transaction-details-improved">
              <div class="detail-item-improved">
                <span class="detail-label-improved">単価</span>
                <span class="detail-value-improved">{{ transaction.price|floatformat:2|intcomma }}円</span>
              </div>
              <div class="detail-item-improved">
                <span class="detail-label-improved">数量</span>
                <span class="detail-value-improved">{{ transaction.quantity|floatformat:0 }}株</span>
              </div>
              <div class="detail-item-improved highlight">
                <span class="detail-label-improved">金額</span>
                <span class="detail-value-improved strong">{{ transaction.amount|floatformat:0|intcomma }}円</span>
              </div>
            </div>

            {% if transaction.memo %}
            <div class="transaction-memo-improved">
              <i class="bi bi-chat-left-text me-1"></i>
              {{ transaction.memo }}
            </div>
            {% endif %}
          </div>
        </div>

        <!-- 編集フォーム（初期は非表示） -->
        <div class="form-card-improved mb-3" id="edit-form-{{ transaction.id }}" style="display: none;">
          <div class="form-header-improved bg-primary">
            <span><i class="bi bi-pencil me-2"></i>取引を編集</span>
            <button type="button" class="btn-icon btn-info-icon" onclick="hideEditForm({{ transaction.id }})">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          <div class="form-body-improved">
            <form method="post" action="{% url 'stockdiary:update_transaction' transaction.id %}">
              {% csrf_token %}
              
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label-improved">取引種別</label>
                  <select class="form-input-improved" name="transaction_type" required>
                    <option value="buy" {% if transaction.transaction_type == 'buy' %}selected{% endif %}>購入</option>
                    <option value="sell" {% if transaction.transaction_type == 'sell' %}selected{% endif %}>売却</option>
                  </select>
                </div>
                
                <div class="col-md-6">
                  <label class="form-label-improved">取引日</label>
                  <input type="date" class="form-input-improved" name="transaction_date" 
                         value="{{ transaction.transaction_date|date:'Y-m-d' }}" required>
                </div>
                
                <div class="col-md-6">
                  <label class="form-label-improved">単価（円）</label>
                  <input type="number" class="form-input-improved" name="price" 
                         value="{{ transaction.price }}" step="0.01" min="0.01" required>
                </div>
                
                <div class="col-md-6">
                  <label class="form-label-improved">数量（株）</label>
                  <input type="number" class="form-input-improved" name="quantity" 
                         value="{{ transaction.quantity }}" step="1" min="1" required>
                </div>
                
                <div class="col-12">
                  <label class="form-label-improved">メモ</label>
                  <textarea class="form-input-improved" name="memo" rows="2" maxlength="500">{{ transaction.memo }}</textarea>
                </div>
              </div>
              
              <div class="form-actions-improved">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-save me-1"></i>更新
                </button>
                <button type="button" class="btn btn-secondary" onclick="hideEditForm({{ transaction.id }})">
                  キャンセル
                </button>
              </div>
            </form>
          </div>
        </div>
        
        {% endwith %}

      {% elif item.type == 'split' %}
        {% with split=item.data %}
        <div class="split-item-improved mb-3">
          <div class="split-header-improved">
            <div class="split-date-improved">
              <i class="bi bi-scissors me-1"></i>
              {{ split.split_date|date:"Y年m月d日" }}
            </div>
            <div class="split-actions-improved">
              <span class="badge badge-info">株式分割</span>
              {% if split.is_applied %}
                <span class="badge badge-success">適用済み</span>
              {% else %}
                <button class="btn btn-warning btn--sm" onclick="applySplit({{ split.id }})">
                  <i class="bi bi-check-circle me-1"></i>適用
                </button>
                <button class="btn-icon btn-danger-icon" onclick="deleteSplit({{ split.id }})">
                  <i class="bi bi-trash"></i>
                </button>
              {% endif %}
            </div>
          </div>

          <div class="split-body-improved">
            <div class="split-details-improved">
              <div class="detail-item-improved">
                <span class="detail-label-improved">分割比率</span>
                <span class="detail-value-improved">1株 → {{ split.split_ratio|floatformat:2 }}株</span>
              </div>
            </div>

            {% if split.memo %}
            <div class="split-memo-improved">
              <i class="bi bi-chat-left-text me-1"></i>
              {{ split.memo }}
            </div>
            {% endif %}

            {% if not split.is_applied %}
            <div class="alert-warning-improved mt-2">
              <i class="bi bi-exclamation-triangle me-1"></i>
              この分割を適用すると、分割日以前の取引が自動調整されます
            </div>
            {% endif %}
          </div>
        </div>
        {% endwith %}
      {% endif %}
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state-improved">
    <div class="empty-icon-improved">
      <i class="bi bi-cart-x"></i>
    </div>
    <h6 class="empty-title-improved">取引記録はまだありません</h6>
    <p class="empty-text-improved">「取引を追加」ボタンから最初の取引を記録しましょう</p>
  </div>
  {% endif %}
</div>

<style>
/* Added improved transaction tab styling */

/* Transaction Summary Section */
.transaction-summary-section {
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
  padding: 1rem;
}

.summary-card-improved {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  padding: 1rem;
  text-align: center;
  transition: all 0.2s ease;
}

.summary-card-improved:hover {
  box-shadow: var(--shadow-sm);
  transform: translateY(-1px);
}

.summary-card-improved.profit {
  border-left: 3px solid #22c55e;
}

.summary-card-improved.loss {
  border-left: 3px solid #ef4444;
}

.summary-label {
  font-size: 0.875rem;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.summary-value {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--text-primary);
}

.summary-value .unit {
  font-size: 0.875rem;
  font-weight: 400;
  color: var(--text-secondary);
  margin-left: 0.25rem;
}

/* Form Cards */
.form-card-improved {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  overflow: hidden;
}

.form-header-improved {
  padding: 1rem 1.25rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  color: white;
}

.form-body-improved {
  padding: 1.5rem;
}

.form-label-improved {
  display: block;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
  font-size: 0.9375rem;
}

.form-input-improved {
  width: 100%;
  padding: 0.625rem 0.875rem;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  background: var(--bg-primary);
  color: var(--text-primary);
  font-size: 0.9375rem;
  transition: all 0.2s ease;
}

.form-input-improved:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-text-improved {
  display: block;
  margin-top: 0.25rem;
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.form-actions-improved {
  display: flex;
  gap: 0.75rem;
  margin-top: 1.5rem;
}

.alert-info-improved {
  background: #dbeafe;
  color: #1e40af;
  padding: 0.875rem 1rem;
  border-radius: var(--radius-sm);
  font-size: 0.9375rem;
  display: flex;
  align-items: center;
}

.alert-warning-improved {
  background: #fef3c7;
  color: #92400e;
  padding: 0.875rem 1rem;
  border-radius: var(--radius-sm);
  font-size: 0.875rem;
  display: flex;
  align-items: center;
}

/* Transaction List */
.transaction-list-improved {
  margin-top: 1.5rem;
}

.list-header-improved {
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
}

.transaction-item-improved,
.split-item-improved {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  padding: 1rem;
  transition: all 0.2s ease;
}

.transaction-item-improved:hover,
.split-item-improved:hover {
  box-shadow: var(--shadow-sm);
}

.transaction-header-improved,
.split-header-improved {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 0.875rem;
  margin-bottom: 0.875rem;
  border-bottom: 1px solid var(--border-color);
}

.transaction-date-improved,
.split-date-improved {
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
}

.transaction-actions-improved,
.split-actions-improved {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.transaction-body-improved,
.split-body-improved {
  display: flex;
  flex-direction: column;
  gap: 0.875rem;
}

.transaction-details-improved,
.split-details-improved {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.detail-item-improved {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  flex: 1;
  min-width: 120px;
}

.detail-item-improved.highlight {
  background: var(--bg-secondary);
  padding: 0.75rem;
  border-radius: var(--radius-sm);
}

.detail-label-improved {
  font-size: 0.8125rem;
  color: var(--text-secondary);
  font-weight: 500;
}

.detail-value-improved {
  font-size: 0.9375rem;
  font-weight: 500;
  color: var(--text-primary);
}

.detail-value-improved.strong {
  font-size: 1.125rem;
  font-weight: 600;
}

.transaction-memo-improved,
.split-memo-improved {
  padding: 0.75rem;
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
  font-size: 0.9375rem;
  color: var(--text-secondary);
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
}

/* Empty State */
.empty-state-improved {
  text-align: center;
  padding: 3rem 1rem;
}

.empty-icon-improved {
  font-size: 3rem;
  color: var(--text-tertiary);
  margin-bottom: 1rem;
  opacity: 0.5;
}

.empty-title-improved {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
}

.empty-text-improved {
  color: var(--text-secondary);
  margin: 0;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .summary-value {
    font-size: 1.25rem;
  }

  .transaction-details-improved,
  .split-details-improved {
    flex-direction: column;
    gap: 0.5rem;
  }

  .detail-item-improved {
    min-width: 100%;
  }

  .form-actions-improved {
    flex-direction: column;
  }
}

/* 取引アイテムの最小高さを統一 */
.transaction-item-improved {
  min-height: 160px;
  display: flex;
  flex-direction: column;
}

.split-item-improved {
  min-height: 140px;
  display: flex;
  flex-direction: column;
}

/* ヘッダー部分の改善 */
.transaction-header-improved,
.split-header-improved {
  padding-bottom: 1rem;
  margin-bottom: 1rem;
  flex-shrink: 0; /* ヘッダーを固定 */
}

.transaction-date-improved,
.split-date-improved {
  font-size: 0.9375rem;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  min-height: 32px; /* 高さを統一 */
}

.transaction-date-improved i,
.split-date-improved i {
  font-size: 1.125rem;
  color: var(--primary-color);
}

/* アクション部分の余白改善 */
.transaction-actions-improved,
.split-actions-improved {
  display: flex;
  gap: 0.625rem;
  align-items: center;
  flex-wrap: wrap;
}

/* ボディ部分を柔軟に */
.transaction-body-improved,
.split-body-improved {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  flex: 1;
}

/* 詳細情報グリッドの改善 */
.transaction-details-improved,
.split-details-improved {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.875rem;
}

.detail-item-improved {
  display: flex;
  flex-direction: column;
  gap: 0.375rem;
  padding: 0.75rem;
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
  min-height: 70px;
}

.detail-item-improved.highlight {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.05));
  border: 1px solid rgba(59, 130, 246, 0.15);
}

.detail-label-improved {
  font-size: 0.75rem;
  color: var(--text-secondary);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.detail-value-improved {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
  line-height: 1.2;
}

.detail-value-improved.strong {
  font-size: 1.125rem;
  font-weight: 700;
  color: var(--primary-color);
}

/* メモ部分の改善 */
.transaction-memo-improved,
.split-memo-improved {
  padding: 0.875rem 1rem;
  background: var(--bg-secondary);
  border-left: 3px solid var(--primary-color);
  border-radius: var(--radius-sm);
  font-size: 0.9375rem;
  color: var(--text-primary);
  display: flex;
  align-items: flex-start;
  gap: 0.625rem;
  line-height: 1.5;
}

.transaction-memo-improved i,
.split-memo-improved i {
  color: var(--primary-color);
  flex-shrink: 0;
  margin-top: 0.125rem;
}

/* ========== フォーム部分の改善 ========== */

.form-actions-improved {
  display: flex;
  gap: 0.75rem;
  margin-top: 1.5rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-light);
}

.form-actions-improved .btn {
  flex: 1;
  min-height: 48px;
  justify-content: center;
}

/* ========== サマリーカードの改善 ========== */

.transaction-summary-section {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(59, 130, 246, 0.02));
  border: 1px solid rgba(59, 130, 246, 0.1);
  border-radius: var(--radius-md);
  padding: 1.25rem;
  margin-bottom: 1.5rem;
}

.summary-card-improved {
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  padding: 1.25rem;
  text-align: center;
  transition: all 0.2s ease;
  min-height: 100px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.summary-label {
  font-size: 0.8125rem;
  color: var(--text-secondary);
  margin-bottom: 0.625rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.summary-value {
  font-size: 1.625rem;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1.2;
}

/* ========== タブレット対応 (768px〜1024px) ========== */
@media (min-width: 768px) and (max-width: 1024px) {
  .transaction-details-improved,
  .split-details-improved {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .detail-item-improved:last-child {
    grid-column: span 2;
  }
}

/* ========== モバイル対応 (576px〜768px) ========== */
@media (max-width: 768px) {
  .transaction-item-improved {
    min-height: 180px;
    padding: 1rem;
  }
  
  .split-item-improved {
    min-height: 160px;
    padding: 1rem;
  }
  
  .transaction-header-improved,
  .split-header-improved {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
    padding-bottom: 0.875rem;
    margin-bottom: 0.875rem;
  }
  
  .transaction-actions-improved,
  .split-actions-improved {
    width: 100%;
    justify-content: space-between;
  }
  
  .transaction-details-improved,
  .split-details-improved {
    grid-template-columns: 1fr;
    gap: 0.625rem;
  }
  
  .detail-item-improved {
    min-height: 60px;
    padding: 0.625rem;
  }
  
  .detail-label-improved {
    font-size: 0.7rem;
  }
  
  .detail-value-improved {
    font-size: 0.9375rem;
  }
  
  .detail-value-improved.strong {
    font-size: 1rem;
  }
  
  .form-actions-improved {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .form-actions-improved .btn {
    width: 100%;
  }
  
  .summary-card-improved {
    min-height: 90px;
    padding: 1rem;
  }
  
  .summary-value {
    font-size: 1.375rem;
  }
}

/* ========== 超小型デバイス (480px以下) ========== */
@media (max-width: 480px) {
  .transaction-item-improved {
    min-height: 200px;
    padding: 0.875rem;
  }
  
  .transaction-date-improved,
  .split-date-improved {
    font-size: 0.875rem;
  }
  
  .transaction-memo-improved,
  .split-memo-improved {
    padding: 0.75rem 0.875rem;
    font-size: 0.875rem;
  }
  
  .summary-card-improved {
    min-height: 85px;
    padding: 0.875rem;
  }
  
  .summary-label {
    font-size: 0.75rem;
    margin-bottom: 0.5rem;
  }
  
  .summary-value {
    font-size: 1.25rem;
  }
  
  .summary-value .unit {
    font-size: 0.75rem;
  }
}

/* ========== アクセシビリティ改善 ========== */

/* タッチデバイス用のアクティブ状態 */
@media (hover: none) {
  .transaction-item-improved:active,
  .split-item-improved:active {
    background: var(--bg-secondary);
  }
}

/* ハイコントラストモード対応 */
@media (prefers-contrast: high) {
  .transaction-item-improved,
  .split-item-improved,
  .summary-card-improved,
  .form-card-improved {
    border-width: 2px;
  }
}

/* ========== アニメーション ========== */

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.transaction-item-improved,
.split-item-improved {
  animation: fadeInUp 0.3s ease-out;
}

/* ========== リスト間隔の調整 ========== */

.transaction-list-improved > .transaction-item-improved:not(:last-child),
.transaction-list-improved > .split-item-improved:not(:last-child),
.transaction-list-improved > .form-card-improved:not(:last-child) {
  margin-bottom: 1rem;
}

/* 編集フォームが表示されているときの調整 */
.form-card-improved[id^="edit-form-"] {
  margin-top: 1rem;
}

/* ========== ボタングループの調整 ========== */

.d-flex.gap-2 {
  gap: 0.625rem !important;
  flex-wrap: wrap;
}

.d-flex.gap-2 .btn {
  min-height: 48px;
  padding: 0.75rem 1.5rem;
}

@media (max-width: 576px) {
  .d-flex.gap-2 {
    flex-direction: column;
    gap: 0.5rem !important;
  }
  
  .d-flex.gap-2 .btn {
    width: 100%;
  }
}
</style>

<script>
const DIARY_ID = {{ diary.id }};

// 追加フォーム表示/非表示
function toggleAddForm() {
  const form = document.getElementById('addTransactionForm');
  const splitForm = document.getElementById('addSplitForm');
  
  splitForm.style.display = 'none';
  document.querySelectorAll('[id^="edit-form-"]').forEach(f => f.style.display = 'none');
  document.querySelectorAll('[id^="transaction-"]').forEach(f => f.style.display = 'block');
  
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
  
  if (form.style.display === 'block') {
    form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

function closeAddForm() {
  document.getElementById('addTransactionForm').style.display = 'none';
  document.getElementById('addForm').reset();
}

// 株式分割フォーム表示/非表示
function toggleSplitForm() {
  const form = document.getElementById('addSplitForm');
  const addForm = document.getElementById('addTransactionForm');
  
  addForm.style.display = 'none';
  document.querySelectorAll('[id^="edit-form-"]').forEach(f => f.style.display = 'none');
  document.querySelectorAll('[id^="transaction-"]').forEach(f => f.style.display = 'block');
  
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
  
  if (form.style.display === 'block') {
    form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

function closeSplitForm() {
  document.getElementById('addSplitForm').style.display = 'none';
}

// 編集フォーム表示
function showEditForm(transactionId) {
  document.querySelectorAll('[id^="edit-form-"]').forEach(form => {
    form.style.display = 'none';
  });
  document.querySelectorAll('[id^="transaction-"]').forEach(item => {
    item.style.display = 'block';
  });
  
  document.getElementById('addTransactionForm').style.display = 'none';
  document.getElementById('addSplitForm').style.display = 'none';
  
  document.getElementById('transaction-' + transactionId).style.display = 'none';
  
  const editForm = document.getElementById('edit-form-' + transactionId);
  editForm.style.display = 'block';
  editForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// 編集フォーム非表示
function hideEditForm(transactionId) {
  document.getElementById('edit-form-' + transactionId).style.display = 'none';
  document.getElementById('transaction-' + transactionId).style.display = 'block';
}

// 取引削除
function deleteTransaction(transactionId, date) {
  if (!confirm(`${date}の取引を削除しますか?\n\n※ この操作は元に戻せません。削除後、平均取得単価が再計算されます。`)) {
    return;
  }
  
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  fetch(`/stockdiary/transaction/${transactionId}/delete/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => {
    if (response.ok) {
      location.reload();
    } else {
      throw new Error('削除に失敗しました');
    }
  })
  .catch(error => {
    alert('削除中にエラーが発生しました: ' + error.message);
  });
}

// 株式分割関連
function applySplit(splitId) {
  if (!confirm('株式分割を適用しますか?\n\n※ 分割日以前の全取引が自動調整されます。\n※ 適用後は編集・削除できなくなります。')) {
    return;
  }
  
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  fetch(`/stockdiary/stock-split/${splitId}/apply/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => {
    if (response.ok) {
      location.reload();
    } else {
      throw new Error('適用に失敗しました');
    }
  })
  .catch(error => {
    alert('適用中にエラーが発生しました: ' + error.message);
  });
}

function deleteSplit(splitId) {
  if (!confirm('この株式分割情報を削除しますか?')) {
    return;
  }
  
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  fetch(`/stockdiary/stock-split/${splitId}/delete/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => {
    if (response.ok) {
      location.reload();
    } else {
      throw new Error('削除に失敗しました');
    }
  })
  .catch(error => {
    alert('削除中にエラーが発生しました: ' + error.message);
  });
}
</script>
