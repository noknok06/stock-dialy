{% load stockdiary_filters %}
{% load humanize %}

<div class="diary-card {% if diary.is_memo or diary.purchase_price is None or diary.purchase_quantity is None %}memo-card{% elif diary.sell_date %}sold-card{% endif %}"
  data-diary-id="{{ diary.id }}"
  data-diary-type="{% if diary.is_memo or diary.purchase_price is None or diary.purchase_quantity is None %}memo{% elif diary.sell_date %}sold{% else %}active{% endif %}">

  <!-- マスキングテープの装飾（ランダムな配置） -->
  {% if forloop.counter|divisibleby:3 %}
  <div class="masking-tape yellow"></div>
  {% elif forloop.counter|divisibleby:5 %}
  <div class="masking-tape green"></div>
  {% elif forloop.counter|divisibleby:2 %}
  <div class="masking-tape"></div>
  {% endif %}

  <!-- カードヘッダー -->
  <div class="diary-card-header">
    <div class="diary-meta">
      <i class="bi bi-clock"></i>
      <span>{{ diary.purchase_date|date:"Y年m月d日" }}</span>

      <!-- メモバッジを追加 -->
      {% if diary.is_memo or diary.purchase_price is None or diary.purchase_quantity is None %}
      <span class="badge bg-info">メモ</span>
      {% endif %}

      <!-- 売却済みバッジ -->
      {% if diary.sell_date %}
      <span class="badge bg-danger">売却済み</span>
      {% endif %}
    </div>
    <button class="btn btn-sm btn-link p-0 text-decoration-none" type="button" data-bs-toggle="collapse"
      data-bs-target="#collapse-{{ diary.id }}" aria-expanded="true">
      <i class="bi bi-chevron-down"></i>
    </button>
  </div>

  <!-- コンテンツ部分 -->
  <div class="collapse show" id="collapse-{{ diary.id }}">
    <div class="diary-card-body">
      <!-- 日記のアイコン表示 -->
      {% if diary.is_memo or diary.purchase_price is None or diary.purchase_quantity is None %}
      <i class="bi bi-sticky memo-icon"></i>
      {% endif %}

      <!-- 銘柄名とタグを上下に並べる -->
      <h3 class="diary-title">
        <i class="bi bi-building text-muted"></i>
        <a href="{% url 'stockdiary:detail' diary.id %}" class="view-btn" title="詳細"
          style="color:var(--primary-color);text-decoration: none">
          {{ diary.stock_name }}
        </a>
        <small class="text-muted">({{ diary.stock_symbol }})</small>
      </h3>

      <!-- タグ表示 - 銘柄名の下に配置 -->
      {% if diary.tags.all %}
      <div class="diary-tags px-2">
        {% for tag in diary.tags.all %}
        <span class="diary-tag"><i class="bi bi-tag"></i> {{ tag.name }}</span>
        {% endfor %}
      </div>
      {% endif %}

      <!-- カード切り替えタブ -->
      <div class="diary-card-tabs mt-3 mb-3">
        <div class="nav nav-tabs card-tabs" role="tablist">
          <button class="nav-link active" id="reason-tab-{{ diary.id }}" data-bs-toggle="tab" 
                  data-bs-target="#reason-content-{{ diary.id }}" type="button" role="tab" aria-selected="true"
                  data-tab-type="reason">
            <i class="bi bi-journal-text"></i> 購入理由
          </button>
          <!-- 継続記録タブの追加 -->
          {% if diary.notes.exists %}
          <button class="nav-link" id="notes-tab-{{ diary.id }}" data-bs-toggle="tab" 
                  data-bs-target="#notes-content-{{ diary.id }}" type="button" role="tab" aria-selected="false"
                  data-tab-type="notes">
            <i class="bi bi-journal-richtext"></i> 継続記録
          </button>
          {% endif %}
          {% if diary.analysis_values.exists %}
          <button class="nav-link" id="analysis-tab-{{ diary.id }}" data-bs-toggle="tab" 
                  data-bs-target="#analysis-content-{{ diary.id }}" type="button" role="tab" aria-selected="false"
                  data-tab-type="analysis">
            <i class="bi bi-clipboard-data"></i> 分析
          </button>
          {% endif %}
          <button class="nav-link" id="details-tab-{{ diary.id }}" data-bs-toggle="tab" 
                  data-bs-target="#details-content-{{ diary.id }}" type="button" role="tab" aria-selected="false"
                  data-tab-type="details">
            <i class="bi bi-graph-up"></i> 売買記録
          </button>
        </div>
      </div>

      <!-- タブコンテンツ -->
      <div class="tab-content">
        <!-- 購入理由タブ - 常に最初から表示 -->
        <div class="tab-pane fade show active" id="reason-content-{{ diary.id }}" role="tabpanel" data-loaded="true">
          <div class="px-1 py-2">
            <h6 class="mb-2">
              <i class="bi bi-journal-text"></i>
              {% if diary.is_memo or diary.purchase_price is None or diary.purchase_quantity is None %}
              メモ内容:
              {% else %}
              購入理由:
              {% endif %}
            </h6>
            <div class="mx-2 reason-content">
              {% if request.GET.query and request.GET.query != '' %}
                {{ diary.reason|safe|linebreaks|highlight:request.GET.query|truncatewords_html:50 }}
              {% else %}
                {{ diary.reason|safe|linebreaks|truncatewords_html:50 }}
              {% endif %}
            </div>
            
            <!-- 続きを読む -->
            {% if diary.reason|wordcount > 50 %}
            <div class="text-end mt-2">
              <a href="{% url 'stockdiary:detail' diary.id %}" class="text-primary text-decoration-none small">
                続きを読む <i class="bi bi-arrow-right"></i>
              </a>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- 継続記録タブ - 遅延ロード用プレースホルダー -->
        {% if diary.notes.exists %}
        <div class="tab-pane fade" id="notes-content-{{ diary.id }}" role="tabpanel">
          <div class="d-flex justify-content-center p-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">読み込み中...</span>
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- 分析テンプレートタブ - 遅延ロード用プレースホルダー -->
        {% if diary.analysis_values.exists %}
        <div class="tab-pane fade" id="analysis-content-{{ diary.id }}" role="tabpanel">
          <div class="d-flex justify-content-center p-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">読み込み中...</span>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- 詳細情報タブ - 遅延ロード用プレースホルダー -->
        <div class="tab-pane fade" id="details-content-{{ diary.id }}" role="tabpanel">
          <div class="d-flex justify-content-center p-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">読み込み中...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="diary-card-footer">
      <small class="text-muted">更新: {{ diary.updated_at|date:"Y/m/d" }}</small>
      <div class="action-buttons">
        <a href="{% url 'stockdiary:detail' diary.id %}" class="action-icon-btn view-btn" title="詳細">
          <i class="bi bi-eye"></i>
        </a>
        <a href="{% url 'stockdiary:update' diary.id %}" class="action-icon-btn edit-btn" title="編集">
          <i class="bi bi-pencil"></i>
        </a>
        {% if not diary.sell_date and not diary.is_memo and diary.purchase_price is not None and diary.purchase_quantity is not None %}
        <a href="{% url 'stockdiary:sell_specific' diary.id %}" class="action-icon-btn" title="売却" style="color:var(--success-color)">
          <i class="bi bi-cash-coin"></i>
        </a>
        {% endif %}
        <a href="{% url 'stockdiary:delete' diary.id %}" class="action-icon-btn delete-btn" title="削除">
          <i class="bi bi-trash"></i>
        </a>
      </div>
    </div>
  </div>
</div>
<script>
// モーダルを安全に表示する関数
function showAnalysisModalSafely(modalId, event) {
  // イベントがある場合は伝播を停止
  if (event) {
    event.preventDefault();
    event.stopPropagation();
  } else if (window.event) {
    window.event.preventDefault();
    window.event.stopPropagation();
  }
  
  // 処理中フラグをチェック（重複実行防止）
  if (window.isShowingModal) return false;
  window.isShowingModal = true;
  
  // 少し遅延させてモーダルを表示（競合防止）
  setTimeout(() => {
    try {
      const modalElement = document.getElementById(modalId);
      if (modalElement) {
        // モーダルをdocument.bodyに移動（重要：位置競合を解消）
        document.body.appendChild(modalElement);
        
        // モーダルの表示
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        
        // モーダルが閉じられた時の処理を追加
        modalElement.addEventListener('hidden.bs.modal', function onHidden() {
          // フラグをリセット
          window.isShowingModal = false;
          // 一度だけ実行のため、リスナーを削除
          modalElement.removeEventListener('hidden.bs.modal', onHidden);
        }, { once: true });
      }
    } catch (err) {
      console.error('モーダル表示エラー:', err);
      window.isShowingModal = false;
    }
  }, 50);
  
  return false;
}
</script>