{% load stockdiary_filters %}
{% load humanize %}

<article class="diary-article" data-diary-id="{{ diary.id }}">
  
  <!-- ========== ヘッダー部分 ========== -->
  <header class="diary-header">
    <div class="diary-title-row">
      <h3 class="diary-name">
        <a href="{% url 'stockdiary:detail' diary.id %}">
          {{ diary.stock_name }}
        </a>        
        {% if diary.stock_symbol %}
          <span class="diary-code">{{ diary.stock_symbol }}</span>
        {% endif %}
      </h3>
      
      {% if diary.realized_profit != 0 %}
        <div class="diary-profit-pill">
          {% include "stockdiary/components/_profit_display.html" with profit=diary.realized_profit style="badge" size="sm" show_icon=False decimals=0 %}
        </div>
      {% endif %}
    </div>
    
    <div class="diary-meta-row">
      {% include "stockdiary/components/_date_display.html" with date=diary.created_at format="short" show_icon=True %}
      {% include "stockdiary/components/_status_badge.html" with diary=diary style="improved" size="sm" %}
    </div>
    
    <!-- タグ行 - 独立 -->
    {% if diary.tags.all %}
    <div class="diary-tags-row">
      {% for tag in diary.tags.all %}
        <span class="tag-pill diary-tag" data-tag-id="{{ tag.id }}">
          <i class="bi bi-tag-fill"></i>
          {{ tag.name }}
        </span>
      {% endfor %}
    </div>
    {% endif %}
  </header>

  <!-- ========== 画像（あれば） ========== -->
  {% if diary.image_url %}
  <figure class="diary-figure">
    <img src="{{ diary.image_url }}" 
         alt="{{ diary.stock_name }}"
         loading="lazy"
         onclick="event.stopPropagation(); showImageModal('{{ diary.image_url }}', '{{ diary.stock_name|escapejs }}')">
  </figure>
  {% endif %}

  <!-- ========== タブナビゲーション ========== -->
  <nav class="diary-tabs" role="tablist">
    <button class="tab-btn active" 
            data-tab="reason-{{ diary.id }}"
            role="tab"
            aria-selected="true"
            aria-controls="reason-{{ diary.id }}">
      <i class="bi bi-journal-text"></i>
      <span class="tab-label">{% if diary.is_memo %}メモ{% else %}理由{% endif %}</span>
    </button>
    
    {% if diary.notes.exists %}
    <button class="tab-btn" 
            data-tab="notes-{{ diary.id }}"
            data-diary-id="{{ diary.id }}"
            data-loaded="false"
            role="tab"
            aria-selected="false"
            aria-controls="notes-{{ diary.id }}">
      <i class="bi bi-journals"></i>
      <span class="tab-label">継続</span>
      <span class="tab-badge">{{ diary.notes.count }}</span>
    </button>
    {% endif %}
    
    {% if diary.transaction_count > 0 %}
    <button class="tab-btn" 
            data-tab="transactions-{{ diary.id }}"
            data-diary-id="{{ diary.id }}"
            data-loaded="false"
            role="tab"
            aria-selected="false"
            aria-controls="transactions-{{ diary.id }}">
      <i class="bi bi-cash-coin"></i>
      <span class="tab-label">取引</span>
      <span class="tab-badge">{{ diary.transaction_count }}</span>
    </button>
    {% endif %}
  </nav>

  <!-- ========== タブコンテンツ ========== -->
  <div class="diary-tab-content">
    
    <!-- 理由タブ -->
    <div class="tab-panel active" 
         id="reason-{{ diary.id }}" 
         role="tabpanel">
      <div class="panel-text">
        {% if request.GET.query %}
          {{ diary.reason|safe|linebreaks|highlight:request.GET.query|truncatewords_html:50 }}
        {% else %}
          {{ diary.reason|safe|linebreaks|truncatewords_html:50 }}
        {% endif %}
      </div>
      {% if diary.reason|wordcount > 50 %}
        <a href="{% url 'stockdiary:detail' diary.id %}" class="read-more">
          続きを読む →
        </a>
      {% endif %}
    </div>

    <!-- 継続記録タブ -->
    {% if diary.notes.exists %}
    <div class="tab-panel" 
         id="notes-{{ diary.id }}" 
         role="tabpanel"
         style="display: none;">
      <div class="panel-loading">
        <div class="spinner-border spinner-border-sm text-primary"></div>
        <span>読み込み中...</span>
      </div>
    </div>
    {% endif %}

    <!-- 取引タブ -->
    {% if diary.transaction_count > 0 %}
    <div class="tab-panel" 
         id="transactions-{{ diary.id }}" 
         role="tabpanel"
         style="display: none;">
      <div class="panel-loading">
        <div class="spinner-border spinner-border-sm text-primary"></div>
        <span>読み込み中...</span>
      </div>
    </div>
    {% endif %}

  </div>

  <!-- ========== フッター ========== -->
  <footer class="diary-footer">
    <a href="{% url 'stockdiary:detail' diary.id %}" class="view-detail">
      <i class="bi bi-box-arrow-up-right"></i>
      詳細を見る
    </a>
  </footer>

</article>