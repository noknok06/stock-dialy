{% load stockdiary_filters %}
{% load humanize %}

<style>
/* 即座に適用したい調整 */
@media (max-width: 576px) {
  .card-tabs .nav-link span.d-none.d-sm-inline {
    display: none !important;
  }
  
  .diary-card-header {
    min-height: auto;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .diary-title {
    word-break: break-word;
    hyphens: auto;
    font-size: 1rem;
  }
  
  .diary-price-info {
    width: 100%;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
  }
  
  .card-tabs .nav-link {
    min-width: 75px;
    padding: 0.6rem 0.5rem;
    font-size: 0.8rem;
  }
}

/* タブレット向け調整 */
@media (min-width: 577px) and (max-width: 991px) {
  .card-tabs .nav-link {
    min-width: 85px;
    padding: 0.7rem 0.75rem;
    font-size: 0.85rem;
  }
  
  .diary-title {
    font-size: 1.1rem;
  }
}

/* グリッドシステムの微調整 */
.home-diary-grid {
  container-type: inline-size;
}

@container (min-width: 768px) {
  .home-diary-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 1.75rem;
  }
}
</style>

<div class="diary-card {% if diary.is_memo or diary.purchase_price is None or diary.purchase_quantity is None %}memo-card{% elif diary.sell_date %}sold-card{% endif %} swipeable"
  data-diary-id="{{ diary.id }}"
  data-diary-type="{% if diary.is_memo or diary.purchase_price is None or diary.purchase_quantity is None %}memo{% elif diary.sell_date %}sold{% else %}active{% endif %}">

  <!-- カードヘッダー - レスポンシブ対応強化 -->
  <div class="diary-card-header">
    <div class="diary-header-content">
      <!-- 銘柄名とシンボル -->
      <h3 class="diary-title">
        <span class="d-inline-block">{{ diary.stock_name }}</span>
        {% if diary.stock_symbol %}
          <small class="text-muted d-inline-block">({{ diary.stock_symbol }})</small>
        {% endif %}
      </h3>
      
      <!-- 日付と状態バッジ -->
      <div class="diary-meta">
        <span class="diary-date">{{ diary.purchase_date|date:"Y年m月d日" }}</span>
        
        {% if diary.is_memo or diary.purchase_price is None or diary.purchase_quantity is None %}
          <span class="status-badge memo-badge">メモ</span>
        {% elif diary.sell_date %}
          <span class="status-badge sold-badge">売却済み</span>
        {% else %}
          <span class="status-badge purchase-badge">保有中</span>
        {% endif %}
      </div>
    </div>
    
    <!-- 価格情報 - レスポンシブ対応 -->
    <div class="diary-price-info">
      {% if not diary.is_memo and diary.purchase_price is not None %}
        <div class="price-value">{{ diary.purchase_price|floatformat:2|intcomma }}円</div>
        {% if diary.purchase_quantity is not None %}
          <div class="quantity-value">{{ diary.purchase_quantity }}株</div>
        {% endif %}
        
        {% if diary.sell_date and diary.sell_price %}
          {% with profit_rate=diary.sell_price|sub:diary.purchase_price|div:diary.purchase_price|mul:100 %}
            <div class="profit-rate {% if profit_rate > 0 %}profit{% elif profit_rate < 0 %}loss{% endif %}">
              {{ profit_rate|floatformat:2 }}%
            </div>
          {% endwith %}
        {% endif %}
      {% endif %}
    </div>
  </div>

  <!-- コンテンツ部分 -->
  <div class="diary-card-body">
    <!-- 画像表示 -->
    {% if diary.image_url %}
    <div class="diary-image mb-3">
      <img src="{{ diary.image_url }}" 
          class="img-fluid rounded diary-attached-image" 
          alt="日記画像"
          style="max-height: 200px; object-fit: cover; width: 100%; cursor: pointer;"
          onclick="event.stopPropagation(); showImageModal('{{ diary.image_url }}', '{{ diary.stock_name|escapejs }}')">

    </div>
    {% endif %}    
    <!-- タグ表示 - 改善されたレイアウト -->
    {% if diary.tags.all %}
    <div class="diary-tags">
      {% for tag in diary.tags.all|slice:":3" %}
      <span class="diary-tag">
        <i class="bi bi-tag" style="font-size: 0.7rem;"></i> 
        <span>{{ tag.name }}</span>
      </span>
      {% endfor %}
      {% if diary.tags.all.count > 3 %}
      <span class="diary-tag more-tags">+{{ diary.tags.all.count|add:"-3" }}</span>
      {% endif %}
    </div>
    {% endif %}

    <!-- カード切り替えタブ - 改善されたレスポンシブ対応 -->
    <div class="diary-card-tabs">
      <div class="nav nav-tabs card-tabs" role="tablist">
        <!-- 理由/メモタブ -->
        <button class="nav-link active tab-btn" id="reason-tab-{{ diary.id }}" 
                data-bs-toggle="tab" 
                data-bs-target="#reason-content-{{ diary.id }}"
                type="button" role="tab">
          <i class="bi bi-journal-text"></i> 
          <span class="d-none d-sm-inline">
            {% if diary.is_memo or diary.purchase_price is None or diary.purchase_quantity is None %}
            メモ
            {% else %}
            理由
            {% endif %}
          </span>
        </button>
        
        <!-- 継続記録タブ -->
        {% if diary.notes.exists %}
        <button class="nav-link tab-btn" id="notes-tab-{{ diary.id }}" 
                data-bs-toggle="tab" 
                data-bs-target="#notes-content-{{ diary.id }}"
                hx-get="{% url 'stockdiary:tab_content' diary.id 'notes' %}"
                hx-target="#notes-content-{{ diary.id }}"
                hx-trigger="click once"
                hx-swap="innerHTML"
                hx-indicator="#tab-loading-indicator-{{ diary.id }}"
                type="button" role="tab">
          <i class="bi bi-journals"></i> 
          <span class="d-none d-sm-inline">継続</span>
        </button>
        {% endif %}
        
        <!-- 分析タブ -->
        {% if diary.analysis_values.exists %}
        <button class="nav-link tab-btn" id="analysis-tab-{{ diary.id }}"
                data-bs-toggle="tab" 
                data-bs-target="#analysis-content-{{ diary.id }}"
                hx-get="{% url 'stockdiary:tab_content' diary.id 'analysis' %}"
                hx-target="#analysis-content-{{ diary.id }}"
                hx-trigger="click once"
                hx-swap="innerHTML"
                hx-indicator="#tab-loading-indicator-{{ diary.id }}"
                type="button" role="tab">
          <i class="bi bi-clipboard-data"></i> 
          <span class="d-none d-sm-inline">分析</span>
        </button>
        {% endif %}
        
        <!-- 詳細タブ -->
        <button class="nav-link tab-btn" id="details-tab-{{ diary.id }}"
                data-bs-toggle="tab" 
                data-bs-target="#details-content-{{ diary.id }}"
                hx-get="{% url 'stockdiary:tab_content' diary.id 'details' %}"
                hx-target="#details-content-{{ diary.id }}"
                hx-trigger="click once"
                hx-swap="innerHTML"
                hx-indicator="#tab-loading-indicator-{{ diary.id }}"
                type="button" role="tab">
          <i class="bi bi-cash-coin"></i> 
          <span class="d-none d-sm-inline">売買</span>
        </button>
      </div>
    </div>

    <!-- 共通ローディングインジケータ -->
    <div id="tab-loading-indicator-{{ diary.id }}" class="htmx-indicator" style="display: none; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 10;">
      <div class="spinner-border text-primary spinner-border-sm" role="status">
        <span class="visually-hidden">読み込み中...</span>
      </div>
    </div>

    <!-- タブコンテンツ -->
    <div class="tab-content">
      <!-- 購入理由タブ - 常に最初から表示 -->
      <div class="tab-pane fade show active" id="reason-content-{{ diary.id }}" role="tabpanel">
        <div class="px-1 py-2">
          <div class="reason-content">
            {% if request.GET.query and request.GET.query != '' %}
              {{ diary.reason|safe|linebreaks|highlight:request.GET.query|truncatewords_html:50 }}
            {% else %}
              {{ diary.reason|safe|linebreaks|truncatewords_html:50 }}
            {% endif %}
          </div>
          
          <!-- 続きを読む -->
          {% if diary.reason|wordcount > 50 %}
          <div class="text-end mt-2">
            <a href="{% url 'stockdiary:detail' diary.id %}" class="text-primary text-decoration-none small">
              続きを読む <i class="bi bi-arrow-right"></i>
            </a>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- 継続記録タブ -->
      {% if diary.notes.exists %}
      <div class="tab-pane fade" id="notes-content-{{ diary.id }}" role="tabpanel">
        <!-- 空のまま - HTMXで内容を挿入 -->
      </div>
      {% endif %}
      
      <!-- 分析テンプレートタブ -->
      {% if diary.analysis_values.exists %}
      <div class="tab-pane fade" id="analysis-content-{{ diary.id }}" role="tabpanel">
        <!-- 空のまま - HTMXで内容を挿入 -->
      </div>
      {% endif %}

      <!-- 詳細情報タブ -->
      <div class="tab-pane fade" id="details-content-{{ diary.id }}" role="tabpanel">
        <!-- 空のまま - HTMXで内容を挿入 -->
      </div>
    </div>
  </div>
</div>