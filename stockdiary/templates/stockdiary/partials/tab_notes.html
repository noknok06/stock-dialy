{% load humanize %}
{% load stockdiary_filters %}

<div class="px-1 py-2">
  <div class="notes-timeline">
    {% for note in notes %}
    <div class="note-item mb-3" data-note-type="{{ note.note_type }}" data-importance="{{ note.importance }}" style="border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); overflow: hidden;">
      <div class="note-header" style="padding: 0.75rem; display: flex; justify-content: space-between; align-items: center; background-color: rgba(246, 248, 250, 0.7); border-bottom: 1px solid #e5e9f0;">
        <div class="note-meta">
          <span class="note-date text-muted me-2">
            <i class="bi bi-calendar-date"></i>
            {{ note.date|date:"Y年m月d日" }}
          </span>
          <span class="badge {% if note.note_type == 'analysis' %}bg-primary
                  {% elif note.note_type == 'news' %}bg-info
                  {% elif note.note_type == 'earnings' %}bg-success
                  {% elif note.note_type == 'insight' %}bg-warning
                  {% elif note.note_type == 'risk' %}bg-danger
                  {% else %}bg-secondary{% endif %} small">
            {% if note.note_type == 'analysis' %}分析更新
            {% elif note.note_type == 'news' %}ニュース
            {% elif note.note_type == 'earnings' %}決算情報
            {% elif note.note_type == 'insight' %}新たな気づき
            {% elif note.note_type == 'risk' %}リスク要因
            {% else %}その他{% endif %}
          </span>
        </div>

        <div class="note-actions" style="display: flex; gap: 0.5rem; align-items: center;">
          <div class="note-importance">
            {% if note.importance == 'high' %}
            <i class="bi bi-exclamation-triangle text-danger" title="高重要度"></i>
            {% elif note.importance == 'medium' %}
            <i class="bi bi-info-circle text-warning" title="中重要度"></i>
            {% else %}
            <i class="bi bi-info-circle text-muted" title="低重要度"></i>
            {% endif %}
          </div>
          
          <!-- 削除ボタン - 常に表示 -->
          <button class="note-delete-btn" 
                  onclick="confirmDeleteNote({{ note.id }}, '{{ note.date|date:"Y年m月d日" }}', '{% if note.note_type == 'analysis' %}分析更新{% elif note.note_type == 'news' %}ニュース{% elif note.note_type == 'earnings' %}決算情報{% elif note.note_type == 'insight' %}新たな気づき{% elif note.note_type == 'risk' %}リスク要因{% else %}その他{% endif %}', {{ diary.id }})" 
                  title="この記録を削除"
                  style="background: none; border: none; color: #dc3545; font-size: 0.9rem; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; transition: all 0.2s ease; opacity: 0.7;">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>

      {% if note.current_price %}
      <div class="note-content" style="padding: 1rem; background-color: white;">
        {% if note.image %}
        <div class="note-image mb-2">
          <img src="{{ note.image.url }}" 
               class="img-fluid rounded note-attached-image" 
               alt="継続記録画像"
               style="max-height: 150px; object-fit: cover; width: 100%; cursor: pointer;"
               onclick="showImageModal('{{ note.image.url }}', '{{ note.date|date:"Y年m月d日" }}の記録')">
        </div>
        {% endif %}
        <div class="note-price-info small mb-2 d-flex justify-content-between align-items-center">
          <span class="text-muted">
            <i class="bi bi-cash-coin me-1"></i>
            記録時価格:
            <strong>{{ note.current_price|floatformat:2|intcomma }}円</strong>
          </span>

          {% with price_change=note.get_price_change %}
          {% if price_change %}
          <span class="{% if price_change > 0 %}text-success{% elif price_change < 0 %}text-danger{% endif %}">
            ({{ price_change|floatformat:2 }}%)
          </span>
          {% endif %}
          {% endwith %}
        </div>
        
        <div class="note-text bg-light rounded p-3">
          {{ note.content|safe|linebreaks|truncatewords_html:50 }}
        </div>

        {% if note.content|wordcount > 50 %}
        <div class="text-end mt-2">
          <a href="{% url 'stockdiary:detail' diary.id %}" class="text-primary text-decoration-none small">
            続きを読む <i class="bi bi-arrow-right"></i>
          </a>
        </div>
        {% endif %}
      </div>
      {% else %}
      <div class="note-content" style="padding: 1rem; background-color: white;">
        {% if note.image %}
        <div class="note-image mb-2">
          <img src="{{ note.image.url }}" 
               class="img-fluid rounded note-attached-image" 
               alt="継続記録画像"
               style="max-height: 150px; object-fit: cover; width: 100%; cursor: pointer;"
               onclick="showImageModal('{{ note.image.url }}', '{{ note.date|date:"Y年m月d日" }}の記録')">
        </div>
        {% endif %}
        <div class="note-text bg-light rounded p-3">
          {{ note.content|safe|linebreaks|truncatewords_html:50 }}
        </div>

        {% if note.content|wordcount > 50 %}
        <div class="text-end mt-2">
          <a href="{% url 'stockdiary:detail' diary.id %}" class="text-primary text-decoration-none small">
            続きを読む <i class="bi bi-arrow-right"></i>
          </a>
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>
    {% empty %}
    <div class="text-center text-muted py-4">
      <i class="bi bi-journal-text me-2"></i>
      継続記録はまだありません
    </div>
    {% endfor %}

    {% if diary.notes.count > 3 %}
    <div class="text-end mt-3">
      <a href="{% url 'stockdiary:detail' diary.id %}" class="btn btn-sm btn-outline-primary">
        <i class="bi bi-journal-richtext me-1"></i>
        すべての記録を見る ({{ diary.notes.count }}件)
      </a>
    </div>
    {% endif %}
  </div>
</div>

<style>
  .note-delete-btn:hover {
    opacity: 1 !important;
    background-color: rgba(220, 53, 69, 0.1) !important;
    transform: scale(1.05);
  }

  .note-delete-btn:active {
    transform: scale(0.95);
  }
</style>

<script>
// グローバル削除関数（home画面とdetail画面共通）
if (typeof window.confirmDeleteNote === 'undefined') {
  window.confirmDeleteNote = function(noteId, noteDate, noteType, diaryId) {
    if (confirm(`${noteDate}の${noteType}を削除しますか？\n\nこの操作は元に戻せません。`)) {
      window.executeDeleteNote(noteId, diaryId);
    }
  };
}

// グローバル削除実行関数
if (typeof window.executeDeleteNote === 'undefined') {
  window.executeDeleteNote = function(noteId, diaryId) {
    // CSRFトークンを取得
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
    
    if (!csrfToken) {
      alert('CSRFトークンが見つかりません。ページを再読み込みしてください。');
      return;
    }

    // 削除実行
    fetch(`/stockdiary/${diaryId}/note/${noteId}/delete/`, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': csrfToken
      }
    })
    .then(response => {
      if (response.ok) {
        // home画面の場合はHTMXでタブコンテンツを再読み込み
        if (window.location.pathname === '/stockdiary/') {
          // HTMXを使ってタブコンテンツを再読み込み
          const notesTab = document.querySelector(`#notes-tab-${diaryId}`);
          const notesContent = document.querySelector(`#notes-content-${diaryId}`);
          
          if (notesTab && notesContent && typeof htmx !== 'undefined') {
            // HTMXでコンテンツを再読み込み
            htmx.ajax('GET', `/stockdiary/tab-content/${diaryId}/notes/`, {
              target: `#notes-content-${diaryId}`,
              swap: 'innerHTML'
            });
          } else {
            // HTMXが利用できない場合はページ全体を再読み込み
            window.location.reload();
          }
        } else {
          // detail画面の場合はページ全体を再読み込み
          window.location.reload();
        }
      } else {
        throw new Error('削除に失敗しました');
      }
    })
    .catch(error => {
      console.error('Delete error:', error);
      alert('削除に失敗しました。もう一度お試しください。');
    });
  };
}
</script>