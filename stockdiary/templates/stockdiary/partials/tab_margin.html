{% load humanize %}
{% load stockdiary_filters %}

<div class="margin-tab-container">
  {% if margin_data %}
    <!-- タブナビゲーション（スマホ最適化） -->
    <div class="margin-tabs-nav mb-3">
      <div class="nav nav-pills nav-fill" id="marginTabsNav" role="tablist">
        <button class="nav-link active" id="chart-tab" data-bs-toggle="pill" 
                data-bs-target="#chart-content" type="button" role="tab" aria-controls="chart-content" aria-selected="true">
          <i class="bi bi-graph-up"></i>
          <span class="nav-text">チャート</span>
        </button>
        <button class="nav-link" id="compare-tab" data-bs-toggle="pill" 
                data-bs-target="#compare-content" type="button" role="tab" aria-controls="compare-content" aria-selected="false">
          <i class="bi bi-bar-chart"></i>
          <span class="nav-text">比較</span>
        </button>
        <button class="nav-link" id="data-tab" data-bs-toggle="pill" 
                data-bs-target="#data-content" type="button" role="tab" aria-controls="data-content" aria-selected="false">
          <i class="bi bi-table"></i>
          <span class="nav-text">データ</span>
        </button>
      </div>
    </div>

    <!-- タブコンテンツ -->
    <div class="margin-tab-content tab-content">
      
      <!-- チャートタブ -->
      <div class="tab-pane fade show active" id="chart-content" role="tabpanel" aria-labelledby="chart-tab">
        
        <!-- 現在値サマリー（スマホ最適化） -->
        <div class="summary-cards mb-3">
          <!-- メイン指標（上段：重要度の高い情報） -->
          <div class="row g-3 mb-3">
            <div class="col-8">
              <div class="summary-card ratio-card main-metric">
                <div class="card-label">信用倍率（買残÷売残）</div>
                {% if latest_margin_data.outstanding_sales > 0 %}
                  {% with ratio=latest_margin_data.outstanding_purchases|div:latest_margin_data.outstanding_sales %}
                    <div class="card-value-large {{ ratio|margin_level_class }}">{{ ratio|floatformat:2 }}</div>
                    <div class="card-suffix-large">倍</div>
                    <div class="card-status-badge {{ ratio|margin_level_class }}">{{ ratio|margin_level_text }}</div>
                  {% endwith %}
                {% else %}
                  <div class="card-value-large text-muted">-</div>
                  <div class="card-suffix-large">倍</div>
                  <div class="card-status-badge text-muted">データなし</div>
                {% endif %}
              </div>
            </div>
            <div class="col-4">
              <div class="summary-card date-card">
                <div class="card-label">更新</div>
                <div class="card-value">{{ latest_margin_data.date|date:"m/d" }}</div>
                <div class="card-suffix">{{ latest_margin_data.date|date:"y" }}</div>
                <div class="card-status">JPX</div>
              </div>
            </div>
          </div>
          
          <!-- サブ指標（下段：詳細データ） -->
          <div class="row g-2">
            <div class="col-6">
              <div class="summary-card sell-card compact">
                <div class="card-header-inline">
                  <i class="bi bi-arrow-down-circle text-danger"></i>
                  <span class="card-label">売残</span>
                </div>
                <div class="card-value text-danger">{{ latest_margin_data.outstanding_sales|format_stock_amount }}</div>
                {% if latest_margin_data.outstanding_sales_change %}
                <div class="card-change {{ latest_margin_data.outstanding_sales_change|change_direction_class }}">
                  {{ latest_margin_data.outstanding_sales_change|format_change }}
                </div>
                {% endif %}
              </div>
            </div>
            <div class="col-6">
              <div class="summary-card buy-card compact">
                <div class="card-header-inline">
                  <i class="bi bi-arrow-up-circle text-success"></i>
                  <span class="card-label">買残</span>
                </div>
                <div class="card-value text-success">{{ latest_margin_data.outstanding_purchases|format_stock_amount }}</div>
                {% if latest_margin_data.outstanding_purchases_change %}
                <div class="card-change {{ latest_margin_data.outstanding_purchases_change|change_direction_class }}">
                  {{ latest_margin_data.outstanding_purchases_change|format_change }}
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        
        <!-- チャート表示エリア -->
        <div class="chart-container mb-3">
          <div class="chart-card">
            <div class="chart-header">
              <h6 class="chart-title">信用倍率推移</h6>
              <div class="period-selector">
                <div class="btn-group btn-group-sm" role="group">
                  <input type="radio" class="btn-check" name="chartPeriod" id="period3m" value="3" checked>
                  <label class="btn btn-outline-primary" for="period3m">3M</label>
                  <input type="radio" class="btn-check" name="chartPeriod" id="period6m" value="6">
                  <label class="btn btn-outline-primary" for="period6m">6M</label>
                  <input type="radio" class="btn-check" name="chartPeriod" id="periodAll" value="all">
                  <label class="btn btn-outline-primary" for="periodAll">全期間</label>
                </div>
              </div>
            </div>
            <div class="chart-body">
              <canvas id="marginChart" aria-label="信用倍率推移チャート"></canvas>
              <div id="chartLoading" class="chart-loading d-none">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- アラート表示 -->
        <div id="marginAlerts" role="alert" aria-live="polite"></div>
        
        <!-- 統計情報（簡潔に） -->
        <div class="stats-row">
          <div class="stat-item">
            <span class="stat-label">平均</span>
            <span class="stat-value" id="avgRatio">-</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">変動</span>
            <span class="stat-value" id="volatility">-</span>
          </div>
        </div>
      </div>

      <!-- 比較タブ -->
      <div class="tab-pane fade" id="compare-content" role="tabpanel" aria-labelledby="compare-tab">
        
        <!-- 銘柄選択（スマホ最適化） -->
        <div class="compare-input mb-3">
          <div class="input-group">
            <input type="text" class="form-control" 
                   id="compareSymbolInput" 
                   placeholder="証券コード" 
                   maxlength="6">
            <button type="button" class="btn btn-primary" 
                    id="addCompareBtn">
              <i class="bi bi-plus-lg"></i>
            </button>
          </div>
        </div>
        
        <!-- 選択済み銘柄 -->
        <div class="selected-symbols mb-3" id="selectedSymbols">
          <p class="text-muted small mb-0">
            現在の銘柄が自動追加されます
          </p>
        </div>
        
        <!-- 推奨銘柄（コンパクト表示） -->
        <div class="suggestions mb-3">
          <div class="suggestions-header">
            <small class="text-muted">同業種推奨</small>
            <div class="spinner-border spinner-border-sm text-primary d-none" id="suggestionsLoading"></div>
          </div>
          <div id="suggestedSymbols" class="suggestions-body">
            <!-- 動的に生成 -->
          </div>
        </div>
        
        <!-- 比較チャート -->
        <div class="compare-chart mb-3" id="compareChartContainer" style="display: none;">
          <div class="chart-card">
            <div class="chart-header">
              <h6 class="chart-title">銘柄比較</h6>
              <button type="button" class="btn btn-outline-secondary btn-sm" 
                      id="resetCompareBtn">
                <i class="bi bi-arrow-counterclockwise"></i>
              </button>
            </div>
            <div class="chart-body">
              <canvas id="compareChart" aria-label="銘柄比較チャート"></canvas>
              <div id="compareChartLoading" class="chart-loading d-none">
                <div class="spinner-border text-primary"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 比較統計 -->
        <div id="compareStats" class="compare-stats">
          <!-- 動的に生成 -->
        </div>
      </div>

      <!-- データタブ -->
      <div class="tab-pane fade" id="data-content" role="tabpanel" aria-labelledby="data-tab">
        <div class="data-container">
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>日付</th>
                  <th>倍率</th>
                  <th>売残</th>
                  <th>買残</th>
                </tr>
              </thead>
              <tbody>
                {% for data in margin_data|slice:":12" %}
                <tr>
                  <td>{{ data.date|date:"m/d" }}</td>
                  <td>
                    {% if data.outstanding_sales > 0 %}
                      {% with ratio=data.outstanding_purchases|div:data.outstanding_sales %}
                        <span class="ratio-value {{ ratio|margin_level_class }}">{{ ratio|floatformat:2 }}</span>
                      {% endwith %}
                    {% else %}
                      <span class="ratio-value text-muted">-</span>
                    {% endif %}
                  </td>
                  <td class="text-danger">{{ data.outstanding_sales|floatformat:0 }}</td>
                  <td class="text-success">{{ data.outstanding_purchases|floatformat:0 }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <!-- データソース -->
          <div class="data-source">
            <a href="https://www.jpx.co.jp/markets/statistics-equities/margin/" 
               target="_blank" class="source-link">
              <i class="bi bi-box-arrow-up-right"></i>
              JPX公式データ
            </a>
          </div>
        </div>
      </div>

    </div> <!-- /.tab-content -->

    <!-- 信用倍率ガイド（コンパクト表示） -->
    <div class="guide-section">
      <div class="guide-card">
        <div class="guide-header">
          <i class="bi bi-info-circle text-primary"></i>
          <span class="guide-title">信用倍率の見方</span>
        </div>
        <div class="guide-indicators">
          <div class="guide-item">
            <span class="guide-dot bg-danger"></span>
            <span class="guide-text">1.0未満：売り優勢</span>
          </div>
          <div class="guide-item">
            <span class="guide-dot bg-primary"></span>
            <span class="guide-text">1.0〜2.0：均衡</span>
          </div>
          <div class="guide-item">
            <span class="guide-dot bg-success"></span>
            <span class="guide-text">2.0超：買い優勢</span>
          </div>
        </div>
      </div>
    </div>

  {% else %}
    <!-- データなしの場合 -->
    <div class="empty-state">
      <i class="bi bi-exclamation-triangle empty-icon"></i>
      <h5 class="empty-title">信用取引データなし</h5>
      <p class="empty-description">この銘柄の信用取引データが見つかりません</p>
      {% if diary.stock_symbol %}
      <p class="empty-code">証券コード: {{ diary.stock_symbol }}</p>
      {% endif %}
      <a href="https://www.jpx.co.jp/markets/statistics-equities/margin/" 
         target="_blank" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-box-arrow-up-right"></i>
        JPX公式で確認
      </a>
    </div>
  {% endif %}
</div>

<style>
/* ===== 基本設定 ===== */
.margin-tab-container {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  width: 100%;
  max-width: 100%;
  overflow-x: hidden;
}

/* ===== タブナビゲーション ===== */
.margin-tabs-nav .nav-pills {
  background-color: rgba(248, 249, 250, 0.8);
  border-radius: 12px;
  padding: 4px;
  margin: 0 -8px;
}

.margin-tabs-nav .nav-link {
  border-radius: 8px;
  font-weight: 500;
  transition: all 0.2s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 12px 8px;
  min-height: 60px;
  color: #6c757d;
}

.margin-tabs-nav .nav-link i {
  font-size: 18px;
}

.margin-tabs-nav .nav-text {
  font-size: 12px;
  font-weight: 600;
}

.margin-tabs-nav .nav-link.active {
  background-color: #0d6efd;
  color: white;
  box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
}

.margin-tabs-nav .nav-link:hover:not(.active) {
  background-color: rgba(13, 110, 253, 0.1);
  color: #0d6efd;
}

/* ===== サマリーカード ===== */
.summary-cards {
  margin: 0 -4px;
}

.summary-card {
  background: white;
  border-radius: 12px;
  padding: 16px 12px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  border: 1px solid rgba(0, 0, 0, 0.06);
  position: relative;
  overflow: hidden;
}

.ratio-card {
  background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
}

.date-card {
  background: linear-gradient(135deg, #fff8f0 0%, #fff 100%);
}

.sell-card {
  background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
}

.buy-card {
  background: linear-gradient(135deg, #f0fff4 0%, #fff 100%);
}

.card-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  color: #6c757d;
  margin-bottom: 4px;
}

.card-value {
  font-size: 24px;
  font-weight: 700;
  line-height: 1;
  margin-bottom: 2px;
}

.card-suffix {
  font-size: 12px;
  font-weight: 500;
  color: #6c757d;
  margin-bottom: 4px;
}

.card-status {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  color: #6c757d;
}

/* ===== チャートエリア ===== */
.chart-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  overflow: hidden;
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border-bottom: 1px solid #f1f3f5;
  background: #fafbfc;
}

.chart-title {
  font-size: 14px;
  font-weight: 600;
  margin: 0;
  color: #343a40;
}

.period-selector .btn {
  font-size: 11px;
  font-weight: 600;
  padding: 6px 12px;
  border-radius: 6px;
}

.chart-body {
  padding: 16px;
  position: relative;
  height: 220px;
}

.chart-body canvas {
  height: 188px !important;
  max-height: 188px !important;
  width: 100% !important;
}

.chart-loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10;
}

/* ===== 統計情報 ===== */
.stats-row {
  display: flex;
  justify-content: center;
  gap: 32px;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 8px;
}

.stat-item {
  text-align: center;
}

.stat-label {
  font-size: 11px;
  font-weight: 600;
  color: #6c757d;
  text-transform: uppercase;
  display: block;
  margin-bottom: 4px;
}

.stat-value {
  font-size: 16px;
  font-weight: 700;
  color: #0d6efd;
}

/* ===== 比較タブ ===== */
.compare-input .form-control {
  height: 48px;
  font-size: 16px;
  border-radius: 8px 0 0 8px;
  border-right: none;
}

.compare-input .btn {
  height: 48px;
  padding: 0 16px;
  border-radius: 0 8px 8px 0;
}

.selected-symbols {
  min-height: 24px;
}

.suggestions {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 12px;
}

.suggestions-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.suggestions-body .btn {
  font-size: 12px;
  padding: 6px 12px;
  margin: 2px;
  border-radius: 6px;
}

.compare-stats .row .col-6 {
  margin-bottom: 8px;
}

.compare-stats .card {
  border: none;
  background: #f8f9fa;
  border-radius: 8px;
}

.compare-stats .card-body {
  padding: 12px;
  text-align: center;
}

/* ===== データテーブル ===== */
.data-container {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.data-table {
  width: 100%;
  margin: 0;
  font-size: 14px;
}

.data-table th {
  background: #f8f9fa;
  font-weight: 600;
  font-size: 12px;
  padding: 12px 8px;
  text-align: center;
  border: none;
  color: #495057;
}

.data-table td {
  padding: 12px 8px;
  text-align: center;
  border: none;
  border-bottom: 1px solid #f1f3f5;
  font-size: 13px;
}

.data-table tr:last-child td {
  border-bottom: none;
}

.ratio-value {
  font-weight: 600;
}

.data-source {
  padding: 16px;
  text-align: center;
  background: #fafbfc;
  border-top: 1px solid #f1f3f5;
}

.source-link {
  font-size: 12px;
  color: #0d6efd;
  text-decoration: none;
  font-weight: 500;
}

/* ===== ガイドセクション ===== */
.guide-section {
  margin-top: 16px;
}

.guide-card {
  background: white;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.guide-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.guide-title {
  font-size: 13px;
  font-weight: 600;
  color: #343a40;
}

.guide-indicators {
  display: flex;
  justify-content: space-between;
  gap: 8px;
}

.guide-item {
  display: flex;
  align-items: center;
  gap: 6px;
  flex: 1;
}

.guide-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.guide-text {
  font-size: 11px;
  font-weight: 500;
  color: #6c757d;
}

/* ===== 空状態 ===== */
.empty-state {
  text-align: center;
  padding: 48px 16px;
}

.empty-icon {
  font-size: 48px;
  color: #dee2e6;
  margin-bottom: 16px;
}

.empty-title {
  font-size: 18px;
  font-weight: 600;
  color: #495057;
  margin-bottom: 8px;
}

.empty-description {
  font-size: 14px;
  color: #6c757d;
  margin-bottom: 12px;
}

.empty-code {
  font-size: 13px;
  color: #6c757d;
  margin-bottom: 16px;
  font-family: monospace;
}

/* ===== アラート ===== */
.alert {
  border-radius: 8px;
  border: none;
  font-size: 14px;
  margin-bottom: 16px;
}

/* ===== レスポンシブ調整 ===== */
@media (max-width: 576px) {
  .margin-tabs-nav .nav-pills {
    margin: 0 -12px;
  }
  
  .period-selector .btn {
    font-size: 10px;
    padding: 4px 8px;
  }
  
  .chart-body {
    padding: 12px;
    height: 200px;
  }
  
  .chart-body canvas {
    height: 168px !important;
    max-height: 168px !important;
  }
  
  .guide-indicators {
    flex-direction: column;
    gap: 12px;
  }
  
  .guide-item {
    justify-content: flex-start;
  }
  
  .stats-row {
    gap: 24px;
    padding: 12px;
  }
}

@media (max-width: 480px) {
  .summary-card {
    padding: 12px 8px;
  }
  
  .card-value {
    font-size: 20px;
  }
  
  .chart-body {
    height: 180px;
    padding: 8px;
  }
  
  .chart-body canvas {
    height: 148px !important;
    max-height: 148px !important;
  }
}

/* ===== アニメーション ===== */
.tab-pane.show {
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.summary-card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.summary-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
}

/* ===== アクセシビリティ ===== */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}

.margin-tab-container .btn:focus,
.margin-tab-container .nav-link:focus,
.margin-tab-container .form-control:focus {
  box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
  outline: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  {% if latest_margin_data %}
    if (typeof MarginTabManager !== 'undefined') {
      const currentSymbol = '{{ diary.stock_symbol|escapejs }}';
      window.MarginTabController = new MarginTabManager(
        {{ diary.id }}, 
        {{ latest_margin_data.issue.id }},
        currentSymbol || null
      );
      console.log('✅ Optimized MarginTabController initialized');
    } else {
      console.warn('⚠️ MarginTabManager not loaded');
    }
  {% endif %}
});
</script>