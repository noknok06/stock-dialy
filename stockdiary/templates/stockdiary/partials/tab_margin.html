<!-- stockdiary/templates/stockdiary/partials/tab_margin.html -->
{% load stockdiary_filters %}
{% load humanize %}

<div class="px-1 py-2">
  <div class="margin-trading-container">
    {% if margin_data.has_data %}
      <!-- データ更新情報 -->
      <div class="margin-header mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="text-primary mb-0">
            <i class="bi bi-graph-up me-1"></i>
            信用取引情報
          </h6>
          <small class="text-muted">
            <i class="bi bi-clock me-1"></i>
            {{ margin_data.latest_date|date:"Y年m月d日" }}
          </small>
        </div>
      </div>

      <!-- 信用倍率ハイライト -->
      <div class="margin-ratio-highlight mb-3">
        <div class="card border-0" style="background: linear-gradient(135deg, rgba(90, 126, 197, 0.05), rgba(90, 126, 197, 0.02));">
          <div class="card-body p-3 text-center">
            {% if margin_data.margin_ratio %}
              {% if margin_data.margin_ratio > 1 %}
                <div class="ratio-icon text-danger mb-2">
                  <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                </div>
                <div class="ratio-value text-danger fw-bold" style="font-size: 1.8rem;">
                  {{ margin_data.margin_ratio|floatformat:2 }}倍
                </div>
                <div class="ratio-status">
                  <span class="badge bg-danger bg-opacity-15 text-danger">売り優勢</span>
                </div>
              {% elif margin_data.margin_ratio > 0.5 %}
                <div class="ratio-icon text-warning mb-2">
                  <i class="bi bi-info-circle" style="font-size: 2rem;"></i>
                </div>
                <div class="ratio-value text-warning fw-bold" style="font-size: 1.8rem;">
                  {{ margin_data.margin_ratio|floatformat:2 }}倍
                </div>
                <div class="ratio-status">
                  <span class="badge bg-warning bg-opacity-15 text-warning">やや売り優勢</span>
                </div>
              {% else %}
                <div class="ratio-icon text-success mb-2">
                  <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                </div>
                <div class="ratio-value text-success fw-bold" style="font-size: 1.8rem;">
                  {{ margin_data.margin_ratio|floatformat:2 }}倍
                </div>
                <div class="ratio-status">
                  <span class="badge bg-success bg-opacity-15 text-success">買い優勢</span>
                </div>
              {% endif %}
            {% else %}
              <div class="ratio-icon text-muted mb-2">
                <i class="bi bi-dash-circle" style="font-size: 2rem;"></i>
              </div>
              <div class="ratio-value text-muted fw-bold" style="font-size: 1.8rem;">
                算出不可
              </div>
            {% endif %}
            <div class="small text-muted mt-1">信用倍率</div>
          </div>
        </div>
      </div>

      <!-- 残高情報 -->
      <div class="margin-balances mb-3">
        <div class="row g-2">
          <!-- 売残高 -->
          <div class="col-6">
            <div class="card h-100">
              <div class="card-body p-2">
                <div class="d-flex align-items-center">
                  <div class="balance-icon bg-danger bg-opacity-10 rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                    <i class="bi bi-arrow-down text-danger"></i>
                  </div>
                  <div class="flex-grow-1 min-w-0">
                    <div class="balance-label small text-muted">売残高</div>
                    <div class="balance-value fw-bold text-truncate">
                      {{ margin_data.latest.outstanding_sales|intcomma }}
                    </div>
                    {% if margin_data.latest.outstanding_sales_change != 0 %}
                      <div class="balance-change small">
                        {% if margin_data.latest.outstanding_sales_change > 0 %}
                          <span class="text-danger">
                            <i class="bi bi-arrow-up"></i>
                            +{{ margin_data.latest.outstanding_sales_change|intcomma }}
                          </span>
                        {% elif margin_data.latest.outstanding_sales_change < 0 %}
                          <span class="text-success">
                            <i class="bi bi-arrow-down"></i>
                            {{ margin_data.latest.outstanding_sales_change|intcomma }}
                          </span>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 買残高 -->
          <div class="col-6">
            <div class="card h-100">
              <div class="card-body p-2">
                <div class="d-flex align-items-center">
                  <div class="balance-icon bg-success bg-opacity-10 rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                    <i class="bi bi-arrow-up text-success"></i>
                  </div>
                  <div class="flex-grow-1 min-w-0">
                    <div class="balance-label small text-muted">買残高</div>
                    <div class="balance-value fw-bold text-truncate">
                      {{ margin_data.latest.outstanding_purchases|intcomma }}
                    </div>
                    {% if margin_data.latest.outstanding_purchases_change != 0 %}
                      <div class="balance-change small">
                        {% if margin_data.latest.outstanding_purchases_change > 0 %}
                          <span class="text-success">
                            <i class="bi bi-arrow-up"></i>
                            +{{ margin_data.latest.outstanding_purchases_change|intcomma }}
                          </span>
                        {% elif margin_data.latest.outstanding_purchases_change < 0 %}
                          <span class="text-danger">
                            <i class="bi bi-arrow-down"></i>
                            {{ margin_data.latest.outstanding_purchases_change|intcomma }}
                          </span>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 信用区分別内訳 -->
      {% if margin_data.latest.negotiable_credit or margin_data.latest.standardized_credit %}
      <div class="margin-breakdown mb-3">
        <h6 class="small text-muted mb-2">
          <i class="bi bi-pie-chart me-1"></i>
          信用区分別内訳
        </h6>
        <div class="row g-2">
          {% if margin_data.latest.negotiable_credit %}
          <div class="col-6">
            <div class="breakdown-item p-2 border rounded">
              <div class="small text-muted">一般信用</div>
              <div class="fw-semibold">{{ margin_data.latest.negotiable_credit|intcomma }}</div>
              {% if margin_data.latest.negotiable_credit_change != 0 %}
                <div class="small">
                  {% if margin_data.latest.negotiable_credit_change > 0 %}
                    <span class="text-success">+{{ margin_data.latest.negotiable_credit_change|intcomma }}</span>
                  {% else %}
                    <span class="text-danger">{{ margin_data.latest.negotiable_credit_change|intcomma }}</span>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
          
          {% if margin_data.latest.standardized_credit %}
          <div class="col-6">
            <div class="breakdown-item p-2 border rounded">
              <div class="small text-muted">制度信用</div>
              <div class="fw-semibold">{{ margin_data.latest.standardized_credit|intcomma }}</div>
              {% if margin_data.latest.standardized_credit_change != 0 %}
                <div class="small">
                  {% if margin_data.latest.standardized_credit_change > 0 %}
                    <span class="text-success">+{{ margin_data.latest.standardized_credit_change|intcomma }}</span>
                  {% else %}
                    <span class="text-danger">{{ margin_data.latest.standardized_credit_change|intcomma }}</span>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- 推移データがある場合の簡易チャート -->
      {% if margin_data.trend_data and margin_data.data_count > 1 %}
      <div class="margin-trend mb-3">
        <h6 class="small text-muted mb-2">
          <i class="bi bi-graph-up-arrow me-1"></i>
          直近の推移（{{ margin_data.data_count }}日分）
        </h6>
        <div class="trend-chart-container">
          <canvas id="margin-trend-chart-{{ diary.id }}" width="100" height="60" style="max-height: 120px;"></canvas>
        </div>
      </div>

      <!-- チャート描画用のJavaScript -->
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const canvas = document.getElementById('margin-trend-chart-{{ diary.id }}');
          if (canvas && typeof Chart !== 'undefined') {
            const ctx = canvas.getContext('2d');
            
            const trendData = {{ margin_data.trend_data|safe }};
            const dates = trendData.map(d => d.date);
            const ratios = trendData.map(d => d.ratio || 0);
            
            new Chart(ctx, {
              type: 'line',
              data: {
                labels: dates.map(date => {
                  const d = new Date(date);
                  return `${d.getMonth() + 1}/${d.getDate()}`;
                }),
                datasets: [{
                  label: '信用倍率',
                  data: ratios,
                  borderColor: '#5a7ec5',
                  backgroundColor: 'rgba(90, 126, 197, 0.1)',
                  borderWidth: 2,
                  fill: true,
                  tension: 0.1,
                  pointRadius: 2,
                  pointHoverRadius: 4
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  }
                },
                scales: {
                  x: {
                    display: true,
                    grid: {
                      display: false
                    },
                    ticks: {
                      font: {
                        size: 10
                      },
                      maxTicksLimit: 5
                    }
                  },
                  y: {
                    display: true,
                    grid: {
                      color: 'rgba(0,0,0,0.1)'
                    },
                    ticks: {
                      font: {
                        size: 10
                      }
                    }
                  }
                },
                elements: {
                  point: {
                    radius: 1
                  }
                }
              }
            });
          }
        });
      </script>
      {% endif %}

      <!-- 信用情報の解説 -->
      <div class="margin-info-explanation">
        <div class="card bg-light">
          <div class="card-body p-2">
            <div class="small text-muted">
              <i class="bi bi-info-circle me-1"></i>
              <strong>信用倍率について:</strong> 売残高 ÷ 買残高で算出。1倍を超えると売り優勢、1倍未満では買い優勢を示します。
            </div>
          </div>
        </div>
      </div>

      <!-- 詳細ページへのリンク -->
      <div class="margin-detail-link text-center mt-3">
        <a href="{% url 'stockdiary:detail' diary.id %}" class="text-primary text-decoration-none small">
          詳細な信用情報を見る <i class="bi bi-arrow-right"></i>
        </a>
      </div>

    {% else %}
      <!-- データがない場合 -->
      <div class="margin-no-data text-center py-4">
        <div class="mb-3">
          <i class="bi bi-exclamation-circle text-muted" style="font-size: 3rem;"></i>
        </div>
        <h6 class="text-muted">信用取引データなし</h6>
        <p class="text-muted small mb-0">{{ margin_data.message }}</p>
      </div>
    {% endif %}
  </div>
</div>

<style>
/* 信用取引タブ専用スタイル */
.margin-trading-container {
  font-size: 0.9rem;
}

.balance-icon {
  flex-shrink: 0;
}

.balance-value {
  font-size: 0.95rem;
  line-height: 1.2;
}

.balance-change {
  line-height: 1;
  margin-top: 0.125rem;
}

.breakdown-item {
  background: rgba(248, 249, 250, 0.8);
  transition: background-color 0.2s ease;
}

.breakdown-item:hover {
  background: rgba(248, 249, 250, 1);
}

.trend-chart-container {
  position: relative;
  height: 120px;
  background: white;
  border-radius: 8px;
  padding: 0.5rem;
  border: 1px solid rgba(0, 0, 0, 0.05);
}

.margin-info-explanation .card {
  border: 1px solid rgba(90, 126, 197, 0.1);
}

@media (max-width: 576px) {
  .margin-trading-container {
    font-size: 0.85rem;
  }
  
  .ratio-value {
    font-size: 1.5rem !important;
  }
  
  .balance-value {
    font-size: 0.9rem;
  }
  
  .trend-chart-container {
    height: 100px;
    padding: 0.25rem;
  }
}
</style>