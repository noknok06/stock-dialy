<!-- 最適化された分析テンプレート情報 - スマホ向け -->
{% if analysis_templates_info %}
<div class="analysis-templates-header mobile-optimized">
  <div class="templates-title">
    <i class="bi bi-clipboard-data text-primary"></i>
    <span class="templates-title-text">分析テンプレート</span>
    <span class="templates-count-badge">{{ analysis_templates_info|length }}</span>
  </div>
</div>

<div class="analysis-templates-container mobile-optimized">
  {% for template_info in analysis_templates_info %}
  <div class="analysis-template-card mobile-optimized mb-3" id="template-card-{{ template_info.template.id }}">
    
    <!-- テンプレートヘッダー -->
    <div class="template-header mobile-optimized">
      <div class="template-main-info">
        <div class="template-name-section">
          <h6 class="template-name mobile-optimized">
            <i class="bi bi-clipboard-check template-icon"></i>
            {{ template_info.template.name }}
          </h6>
          <div class="template-completion-inline mobile-optimized">
            <span class="completion-fraction">{{ template_info.completed_items }}/{{ template_info.total_items }}</span>
            <span class="completion-percentage">{{ template_info.completion_rate }}%</span>
          </div>
        </div>
        
        <!-- インラインプログレスバー -->
        <div class="template-progress-inline mobile-optimized">
          <div class="progress-track">
            <div class="progress-fill" style="width: {{ template_info.completion_rate }}%"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- テンプレート説明（存在する場合のみ） -->
    {% if template_info.template.description %}
    <div class="template-description mobile-optimized">
      <p class="description-text">{{ template_info.template.description|truncatechars:80 }}</p>
    </div>
    {% endif %}
    
    <!-- モバイル最適化アクション -->
    <div class="template-actions-mobile">
      <div class="actions-row mobile-optimized">
        <button class="action-btn secondary mobile-optimized" 
                type="button" 
                data-bs-toggle="collapse" 
                data-bs-target="#template-details-{{ template_info.template.id }}" 
                aria-expanded="false">
          <i class="bi bi-chevron-down action-icon"></i>
          <span class="action-text">詳細を見る</span>
        </button>
        
        <a href="{% url 'analysis_template:detail' template_info.template.id %}" 
            class="action-btn primary mobile-optimized">
          <i class="bi bi-box-arrow-up-right action-icon"></i>
          <span class="action-text">テンプレート</span>
        </a>
      </div>
    </div>
    
    <!-- 折りたたみ可能な詳細セクション -->
    <div class="collapse template-details-collapse" id="template-details-{{ template_info.template.id }}">
      <div class="template-details-content mobile-optimized">
        <div class="details-header mobile-optimized">
          <i class="bi bi-list-check details-icon"></i>
          <h6 class="details-title">分析項目と回答</h6>
        </div>
        
        <div class="analysis-items-mobile">
          {% for item_data in template_info.items_with_values %}
          <div class="analysis-item-mobile mb-2" data-completed="{% if item_data.is_completed %}true{% else %}false{% endif %}">
            
            <!-- 項目ヘッダー -->
            <div class="item-header mobile-optimized">
              <div class="item-order-badge">{{ item_data.item.order }}</div>
              <div class="item-info">
                <div class="item-name-row">
                  <span class="item-name">{{ item_data.item.name }}</span>
                  {% if not item_data.is_completed %}
                  <span class="item-status incomplete">未回答</span>
                  {% endif %}
                </div>
                {% if item_data.item.description %}
                <div class="item-description-mobile">
                  <small class="description-text">{{ item_data.item.description|truncatechars:60 }}</small>
                </div>
                {% endif %}
              </div>
            </div>
            
            <!-- 回答表示 -->
            <div class="item-answer mobile-optimized">
              {% if item_data.item.item_type == 'boolean' %}
                <div class="answer-display boolean-answer {% if item_data.value.boolean_value %}positive{% else %}negative{% endif %}">
                  <i class="bi {% if item_data.value.boolean_value %}bi-check-circle-fill{% else %}bi-x-circle-fill{% endif %} answer-icon"></i>
                  <span class="answer-text">{{ item_data.display_value }}</span>
                </div>
                
              {% elif item_data.item.item_type == 'boolean_with_value' %}
                <div class="answer-display complex-answer {% if item_data.value.boolean_value %}positive{% else %}negative{% endif %}">
                  <div class="complex-answer-primary">
                    <i class="bi {% if item_data.value.boolean_value %}bi-check-circle-fill{% else %}bi-x-circle-fill{% endif %} answer-icon"></i>
                    <span class="answer-text">{{ item_data.display_value }}</span>
                  </div>
                </div>
                
              {% elif item_data.item.item_type == 'number' %}
                <div class="answer-display number-answer">
                  <i class="bi bi-123 answer-icon"></i>
                  <span class="answer-text">{{ item_data.display_value }}</span>
                </div>
                
              {% elif item_data.item.item_type == 'select' %}
                <div class="answer-display select-answer">
                  <i class="bi bi-check2-square answer-icon"></i>
                  <span class="answer-text">{{ item_data.display_value }}</span>
                </div>
                
              {% else %}
                <div class="answer-display text-answer">
                  <i class="bi bi-text-paragraph answer-icon"></i>
                  <div class="text-answer-content">
                    {% if item_data.value.text_value|length > 50 %}
                      <div class="text-preview">{{ item_data.value.text_value|truncatechars:50 }}</div>
                      <button class="btn-expand-text mobile-optimized" 
                              type="button" 
                              data-bs-toggle="collapse" 
                              data-bs-target="#full-answer-{{ template_info.template.id }}-{{ item_data.item.id }}"
                              aria-expanded="false">
                        <i class="bi bi-chevron-down"></i>
                        <span class="expand-text">続きを読む</span>
                      </button>
                      <div class="collapse answer-full-collapse" id="full-answer-{{ template_info.template.id }}-{{ item_data.item.id }}">
                        <div class="answer-full-content">{{ item_data.value.text_value|linebreaks }}</div>
                      </div>
                    {% else %}
                      <span class="answer-text">{{ item_data.display_value }}</span>
                    {% endif %}
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  
  {% if not forloop.last %}
  <div class="template-separator mobile-optimized"></div>
  {% endif %}
  
  {% endfor %}
    </div>
{% endif %}

<style>
/* === スマホ最適化された分析テンプレート表示スタイル === */

.analysis-templates-mobile {
  background: linear-gradient(135deg, rgba(90, 126, 197, 0.02), rgba(90, 126, 197, 0.05));
  border: 1px solid rgba(90, 126, 197, 0.1);
  border-radius: 12px;
  overflow: hidden;
}

.analysis-templates-header.mobile-optimized {
  background: linear-gradient(135deg, rgba(90, 126, 197, 0.08), rgba(90, 126, 197, 0.05));
  padding: 1rem;
  border-bottom: 1px solid rgba(90, 126, 197, 0.1);
}

.templates-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--primary-color);
}

.templates-title-text {
  flex: 1;
}

.templates-count-badge {
  background: rgba(90, 126, 197, 0.15);
  color: var(--primary-color);
  padding: 0.2rem 0.6rem;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 600;
}

.analysis-templates-container.mobile-optimized {
  padding: 0.75rem;
  background: transparent;
}

/* === テンプレートカード === */
.analysis-template-card.mobile-optimized {
  background: white;
  border: 1px solid rgba(90, 126, 197, 0.1);
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  overflow: hidden;
  transition: all 0.3s ease;
}

.analysis-template-card.mobile-optimized:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
  border-color: rgba(90, 126, 197, 0.2);
}

/* === テンプレートヘッダー === */
.template-header.mobile-optimized {
  padding: 1rem;
  background: linear-gradient(135deg, rgba(248, 250, 252, 0.8), rgba(255, 255, 255, 0.9));
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.template-main-info {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.template-name-section {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 0.5rem;
}

.template-name.mobile-optimized {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
  color: var(--primary-color);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex: 1;
  line-height: 1.3;
}

.template-icon {
  color: var(--primary-color);
  font-size: 1.1rem;
  flex-shrink: 0;
}

.template-completion-inline.mobile-optimized {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 0.15rem;
  flex-shrink: 0;
}

.completion-fraction {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--primary-color);
  background: rgba(90, 126, 197, 0.1);
  padding: 0.2rem 0.5rem;
  border-radius: 8px;
}

.completion-percentage {
  font-size: 0.75rem;
  color: var(--text-light);
  font-weight: 500;
}

/* === インラインプログレスバー === */
.template-progress-inline.mobile-optimized {
  width: 100%;
}

.progress-track {
  height: 6px;
  background: rgba(90, 126, 197, 0.1);
  border-radius: 3px;
  overflow: hidden;
  position: relative;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-color), rgba(90, 126, 197, 0.8));
  border-radius: 3px;
  transition: width 0.5s ease;
  position: relative;
}

.progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  animation: progress-shine 2s infinite;
}

@keyframes progress-shine {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* === テンプレート説明 === */
.template-description.mobile-optimized {
  padding: 0 1rem 1rem;
  background: white;
}

.description-text {
  margin: 0;
  font-size: 0.9rem;
  color: var(--text-light);
  line-height: 1.4;
}

/* === モバイル最適化アクション === */
.template-actions-mobile {
  padding: 1rem;
  background: white;
  border-top: 1px solid rgba(0, 0, 0, 0.05);
}

.actions-row.mobile-optimized {
  display: flex;
  gap: 0.5rem;
  width: 100%;
}

.action-btn.mobile-optimized {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.4rem;
  padding: 0.75rem 1rem;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 500;
  text-decoration: none;
  transition: all 0.2s ease;
  border: 1px solid;
  min-height: 44px; /* タップしやすい最小サイズ */
  cursor: pointer;
}

.action-btn.secondary.mobile-optimized {
  background: white;
  color: var(--text-color);
  border-color: rgba(0, 0, 0, 0.15);
}

.action-btn.secondary.mobile-optimized:hover {
  background: rgba(248, 249, 250, 1);
  border-color: rgba(90, 126, 197, 0.3);
  color: var(--primary-color);
  transform: translateY(-1px);
}

.action-btn.primary.mobile-optimized {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

.action-btn.primary.mobile-optimized:hover {
  background: #4a6eaf;
  border-color: #4a6eaf;
  color: white;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(90, 126, 197, 0.3);
}

.action-icon {
  font-size: 0.9rem;
  flex-shrink: 0;
}

.action-text {
  font-weight: 500;
}

/* === 折りたたみ詳細セクション === */
.template-details-collapse {
  border-top: 1px solid rgba(0, 0, 0, 0.05);
}

.template-details-content.mobile-optimized {
  padding: 1rem;
  background: rgba(248, 250, 252, 0.5);
}

.details-header.mobile-optimized {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid rgba(90, 126, 197, 0.15);
}

.details-icon {
  color: var(--primary-color);
  font-size: 1.1rem;
}

.details-title {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
  color: var(--primary-color);
}

/* === 分析項目（モバイル最適化） === */
.analysis-items-mobile {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.analysis-item-mobile {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.08);
  border-radius: 8px;
  overflow: hidden;
  transition: all 0.2s ease;
}

.analysis-item-mobile:hover {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border-color: rgba(90, 126, 197, 0.2);
}

.analysis-item-mobile[data-completed="false"] {
  border-color: rgba(251, 191, 36, 0.3);
  background: rgba(254, 252, 232, 0.5);
}

/* === 項目ヘッダー === */
.item-header.mobile-optimized {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  padding: 0.875rem;
  background: linear-gradient(135deg, rgba(248, 250, 252, 0.8), rgba(255, 255, 255, 0.9));
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.item-order-badge {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  background: rgba(90, 126, 197, 0.15);
  color: var(--primary-color);
  border-radius: 50%;
  font-size: 0.8rem;
  font-weight: 600;
  flex-shrink: 0;
}

.item-info {
  flex: 1;
  min-width: 0;
}

.item-name-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
  margin-bottom: 0.25rem;
}

.item-name {
  font-weight: 600;
  color: var(--text-color);
  font-size: 0.9rem;
  line-height: 1.3;
  flex: 1;
}

.item-status.incomplete {
  background: rgba(251, 191, 36, 0.2);
  color: #d97706;
  padding: 0.15rem 0.5rem;
  border-radius: 12px;
  font-size: 0.7rem;
  font-weight: 600;
  flex-shrink: 0;
}

.item-description-mobile {
  margin-top: 0.25rem;
}

.item-description-mobile .description-text {
  color: var(--text-light);
  font-size: 0.8rem;
  line-height: 1.3;
}

/* === 回答表示 === */
.item-answer.mobile-optimized {
  padding: 0.875rem;
  background: white;
}

.answer-display {
  display: flex;
  align-items: flex-start;
  gap: 0.6rem;
}

.answer-icon {
  font-size: 1.1rem;
  margin-top: 0.1rem;
  flex-shrink: 0;
}

.answer-text {
  font-weight: 500;
  font-size: 0.9rem;
  line-height: 1.4;
  flex: 1;
}

/* === 回答タイプ別スタイル === */
.boolean-answer.positive .answer-icon {
  color: var(--success-color);
}

.boolean-answer.negative .answer-icon {
  color: var(--danger-color);
}

.complex-answer .complex-answer-primary {
  display: flex;
  align-items: center;
  gap: 0.6rem;
}

.complex-answer.positive .answer-icon {
  color: var(--success-color);
}

.complex-answer.negative .answer-icon {
  color: var(--danger-color);
}

.number-answer {
  align-items: center; /* 数値回答は中央揃え */
}

.number-answer .answer-icon {
  color: var(--primary-color);
  margin-top: 0; /* 数値アイコンは margin-top をリセット */
  align-self: center; /* アイコン自体も中央揃え */
  line-height: 1; /* ラインハイトを1に設定 */
}

.select-answer .answer-icon {
  color: var(--info-color);
}

.text-answer .answer-icon {
  color: var(--text-light);
  margin-top: 0.2rem;
}

.text-answer-content {
  flex: 1;
}

.text-preview {
  margin-bottom: 0.5rem;
  line-height: 1.4;
}

.btn-expand-text.mobile-optimized {
  background: none;
  border: none;
  color: var(--primary-color);
  font-size: 0.8rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 0.3rem;
  padding: 0.4rem 0.6rem;
  border-radius: 6px;
  transition: all 0.2s ease;
  margin-top: 0.5rem;
}

.btn-expand-text.mobile-optimized:hover {
  background: rgba(90, 126, 197, 0.1);
}

.answer-full-collapse {
  margin-top: 0.75rem;
}

.answer-full-content {
  background: rgba(248, 250, 252, 0.8);
  padding: 0.75rem;
  border-radius: 6px;
  border-left: 3px solid var(--primary-color);
  line-height: 1.5;
  font-size: 0.85rem;
}

/* === セパレーター === */
.template-separator.mobile-optimized {
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(90, 126, 197, 0.2), transparent);
  margin: 1rem 0;
}

/* === レスポンシブ調整 === */
@media (max-width: 576px) {
  .analysis-templates-header.mobile-optimized {
    padding: 0.75rem;
  }
  
  .templates-title {
    font-size: 1rem;
  }
  
  .analysis-templates-container.mobile-optimized {
    padding: 0.5rem;
  }
  
  .template-header.mobile-optimized {
    padding: 0.75rem;
  }
  
  .template-name.mobile-optimized {
    font-size: 0.9rem;
  }
  
  .completion-fraction {
    font-size: 0.8rem;
    padding: 0.15rem 0.4rem;
  }
  
  .actions-row.mobile-optimized {
    flex-direction: column;
    gap: 0.4rem;
  }
  
  .action-btn.mobile-optimized {
    min-height: 42px;
    font-size: 0.8rem;
    padding: 0.6rem 0.8rem;
  }
  
  .template-details-content.mobile-optimized {
    padding: 0.75rem;
  }
  
  .item-header.mobile-optimized {
    padding: 0.75rem;
    gap: 0.6rem;
  }
  
  .item-order-badge {
    width: 26px;
    height: 26px;
    font-size: 0.75rem;
  }
  
  .item-name {
    font-size: 0.85rem;
  }
  
  .item-answer.mobile-optimized {
    padding: 0.75rem;
  }
  
  .answer-display {
    gap: 0.5rem;
  }
  
  .answer-text {
    font-size: 0.85rem;
  }
}

/* === アクセシビリティ === */
@media (hover: none) {
  .action-btn.mobile-optimized:active {
    transform: scale(0.98);
  }
  
  .analysis-template-card.mobile-optimized:active {
    transform: scale(0.99);
  }
}

/* === 折りたたみアニメーション === */
.template-details-collapse.collapsing,
.answer-full-collapse.collapsing {
  transition: height 0.3s ease;
}

/* === 展開ボタンのアイコンアニメーション === */
.action-btn.secondary[aria-expanded="true"] .action-icon {
  transform: rotate(180deg);
  transition: transform 0.3s ease;
}

.btn-expand-text[aria-expanded="true"] i {
  transform: rotate(180deg);
  transition: transform 0.3s ease;
}
</style>

<script>
// スマホ最適化されたアニメーション効果
document.addEventListener('DOMContentLoaded', function() {
  // 詳細展開ボタンのテキスト切り替え
  const detailToggleBtns = document.querySelectorAll('[data-bs-toggle="collapse"][data-bs-target*="template-details-"]');
  
  detailToggleBtns.forEach(btn => {
    const textSpan = btn.querySelector('.action-text');
    const originalText = textSpan.textContent;
    
    btn.addEventListener('click', function() {
      setTimeout(() => {
        const isExpanded = btn.getAttribute('aria-expanded') === 'true';
        textSpan.textContent = isExpanded ? '詳細を閉じる' : originalText;
      }, 50);
    });
  });
  
  // 続きを読むボタンのテキスト切り替え
  const expandTextBtns = document.querySelectorAll('.btn-expand-text');
  
  expandTextBtns.forEach(btn => {
    const textSpan = btn.querySelector('.expand-text');
    
    btn.addEventListener('click', function() {
      setTimeout(() => {
        const isExpanded = btn.getAttribute('aria-expanded') === 'true';
        textSpan.textContent = isExpanded ? '閉じる' : '続きを読む';
      }, 50);
    });
  });
  
  // スムーズなスクロール効果（テンプレートカードが展開された時）
  const collapseElements = document.querySelectorAll('.template-details-collapse');
  
  collapseElements.forEach(collapse => {
    collapse.addEventListener('shown.bs.collapse', function() {
      // 展開後にカードの位置を調整してスクロール
      const card = this.closest('.analysis-template-card');
      if (card) {
        setTimeout(() => {
          const headerHeight = 60; // ヘッダーの高さ
          const cardRect = card.getBoundingClientRect();
          const scrollTop = window.pageYOffset + cardRect.top - headerHeight;
          
          window.scrollTo({
            top: scrollTop,
            behavior: 'smooth'
          });
        }, 100);
      }
    });
  });
});
</script>