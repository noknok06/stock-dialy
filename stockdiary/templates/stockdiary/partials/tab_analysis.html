{% load stockdiary_filters %}
<div class="analysis-templates-container px-1 py-2">
  {% if template_groups %}
    {% for group in template_groups %}
      <div class="analysis-template-card" data-template-id="{{ group.template.id }}">
        <div class="analysis-template-header">
          <h6>
            <i class="bi bi-clipboard-check"></i> 
            {{ group.template.name }}
          </h6>
          {% with items_count=group.template.items.count filled_count=group.values|length %}
            {% if items_count > 0 %}
              <span class="badge bg-primary bg-opacity-10 text-primary">
                全{{ items_count }}項目（選択中のみ表示）
              </span>
            {% endif %}
          {% endwith %}
        </div>
        
        <div class="analysis-template-progress">
          {% with items_count=group.template.items.count %}
            {% if items_count > 0 %}
              {% with filled_count=group.values|length progress_percentage=filled_count|multiply:100|divideby:items_count %}
                <div class="analysis-template-progress-bar" style="width: {{ progress_percentage|floatformat:0 }}%"></div>
              {% endwith %}
            {% else %}
              <div class="analysis-template-progress-bar" style="width: 0%"></div>
            {% endif %}
          {% endwith %}
        </div>
        
        <div class="analysis-items-container">
          {% for value in group.values %}
            <div class="analysis-item">
              <div class="analysis-item-name">
                {{ value.analysis_item.name }}
              </div>
              <div class="analysis-item-value">
                {% if value.analysis_item.item_type == 'boolean' %}
                  <span class="{% if value.boolean_value %}analysis-value-boolean-true{% else %}analysis-value-boolean-false{% endif %}">
                    {% if value.boolean_value %}
                      <span class="badge bg-success bg-opacity-10 text-success">
                        <i class="bi bi-check-lg me-1"></i>はい
                      </span>
                    {% else %}
                      <span class="badge bg-danger bg-opacity-10 text-danger">
                        <i class="bi bi-x-lg me-1"></i>いいえ
                      </span>
                    {% endif %}
                  </span>
                {% elif value.analysis_item.item_type == 'boolean_with_value' %}
                  <div class="d-flex align-items-center">
                    <span class="{% if value.boolean_value %}analysis-value-boolean-true{% else %}analysis-value-boolean-false{% endif %} me-2">
                      {% if value.boolean_value %}
                        <i class="bi bi-check-circle text-success"></i>
                      {% else %}
                        <i class="bi bi-x-circle text-danger"></i>
                      {% endif %}
                    </span>
                    {% if value.number_value is not None %}
                      <span>{{ value.number_value|floatformat:2 }}</span>
                    {% elif value.text_value %}
                      <span>{{ value.text_value }}</span>
                    {% endif %}
                  </div>
                {% elif value.number_value is not None %}
                  <span class="text-primary">{{ value.number_value|floatformat:2 }}</span>
                {% elif value.analysis_item.item_type == 'select' %}
                  <span class="badge bg-info bg-opacity-10 text-info">{{ value.text_value }}</span>
                {% elif value.text_value %}
                  <span class="badge bg-secondary bg-opacity-10 text-secondary">{{ value.text_value }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </div>
            </div>
          {% endfor %}
          
          <a href="{% url 'stockdiary:detail' diary.id %}" class="analysis-more-link">
            すべての分析を表示 <i class="bi bi-arrow-right"></i>
          </a>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted text-center py-3">分析データはありません</p>
  {% endif %}
</div>
