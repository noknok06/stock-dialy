{% extends 'base.html' %}
{% load stockdiary_filters %}
{% load static %}
{% load humanize %}

{% block title %}{{ diary.stock_name }} | カブログ{% endblock %}

{% block head %}
<!-- 基本CSSの読み込み -->
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<!-- 日記テーマCSSの読み込み -->
<link rel="stylesheet" href="{% static 'css/diary-theme.css' %}">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="{% static 'css/speed-dial.css' %}">

<!-- タブ関連のCSS -->
<style>
/* タブコンテナのスタイル */
.diary-tabs-container {
  background-color: var(--card-bg-color, #ffffff);
  border-radius: var(--border-radius, 8px);
  box-shadow: var(--card-shadow, 0 2px 10px rgba(0, 0, 0, 0.05));
  overflow: hidden;
  margin-bottom: 2rem;
  background-color: transparent;
}

/* タブナビゲーションのスタイル */
.diary-tabs-container .nav-tabs {
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  background-color: rgba(248, 249, 250, 0.7);
}

.diary-tabs-container .nav-link {
  padding: 1rem;
  color: var(--text-color, #3a4a5a);
  border: none;
  border-radius: 0;
  position: relative;
  transition: all 0.2s ease;
  font-weight: 500;
  text-align: center;
}

.diary-tabs-container .nav-link::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 100%;
  height: 2px;
  background-color: transparent;
  transition: background-color 0.2s;
}

.diary-tabs-container .nav-link.active {
  color: var(--primary-color, #5a7ec5);
  background-color: transparent;
  font-weight: 600;
}

.diary-tabs-container .nav-link.active::after {
  background-color: var(--primary-color, #5a7ec5);
}

.diary-tabs-container .nav-link:hover:not(.active) {
  background-color: rgba(90, 126, 197, 0.05);
}

/* タブコンテンツのスタイル */
.diary-tab-content {
  padding: 1.5rem;
  background-color: var(--card-bg-color, #ffffff);
  background-color: transparent;
}

/* スワイプヒントのスタイル */
.swipe-hint {
  font-size: 0.8rem;
  padding: 0.5rem;
  border-radius: 12px;
  background-color: rgba(var(--primary-color-rgb, 90, 126, 197), 0.05);
  animation: pulse-hint 2s infinite;
}

@keyframes pulse-hint {
  0% { opacity: 0.7; }
  50% { opacity: 0.4; }
  100% { opacity: 0.7; }
}

/* スワイプ中の視覚的フィードバック */
.tab-highlight {
  background-color: rgba(var(--primary-color-rgb, 90, 126, 197), 0.1);
}

/* タッチデバイス用の最適化 */
@media (hover: none) {
  .diary-tabs-container .nav-link {
    padding: 1rem 0.75rem;
  }
  
  .diary-tabs-container .nav-tabs {
    display: flex;
  }
  
  .diary-tabs-container .nav-tabs .nav-item {
    flex: 1;
    text-align: center;
  }
  
  .diary-tabs-container .nav-tabs .nav-link {
    width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
}

/* モバイル向け最適化 */
@media (max-width: 767.98px) {
  .diary-tabs-container .nav-link {
    padding: 0.85rem 0.5rem;
    font-size: 0.9rem;
  }
  
  .diary-tab-content {
    padding: 1.25rem 1rem;
  }
  
  /* タブコンテンツの高さを最適化 */
  .diary-tab-content .tab-pane {
    min-height: 300px;
  }
  
  /* スクロール位置の調整 */
  .diary-tabs-container:target {
    scroll-margin-top: 1rem;
  }
}

/* 小型モバイルデバイス向け最適化 */
@media (max-width: 375px) {
  .diary-tabs-container .nav-link {
    padding: 0.75rem 0.4rem;
    font-size: 0.85rem;
  }
  
  .diary-tabs-container .nav-link i {
    display: none; /* アイコンを非表示に */
  }
  
  .diary-tab-content {
    padding: 1rem 0.75rem;
  }
}

.section-title{
  font-size: 1.25rem;
}
.investment-timeline {
  padding: 20px 0;
  margin-bottom: 2rem;
}

/* タイムラインリスト */
.timeline-list {
  position: relative;
  list-style: none;
  padding-left: 40px;
  margin: 0;
}

/* 縦線 */
.timeline-list::before {
  content: '';
  position: absolute;
  top: 0;
  left: 18px;
  height: 100%;
  width: 2px;
  background-color: var(--notebook-line);
}

/* リストアイテム */
.timeline-list-item {
  position: relative;
  margin-bottom: 25px;
  padding-right: 15px;
}

.timeline-list-item:last-child {
  margin-bottom: 0;
}

/* マーカーの代わりにリストアイテムの::before疑似要素を使用 */
.timeline-list-item::before {
  content: '';
  position: absolute;
  top: 15px;
  left: -30px;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background-color: var(--primary-color);
  border: 2px solid white;
  box-shadow: 0 0 0 2px rgba(74, 109, 167, 0.3);
  z-index: 2;
}
/* 継続記録の操作ボタン用スタイル */
.timeline-item .timeline-content {
  position: relative;
}

.timeline-item .badge-and-actions {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.timeline-item .btn-outline-danger {
  border-color: rgba(220, 53, 69, 0.5);
  color: #dc3545;
  padding: 0.25rem 0.5rem;
  line-height: 1;
}

.timeline-item {
  background-color: #dc3545;
  color: white;
}

/* モバイル向け調整 */
@media (max-width: 768px) {
  .timeline-item .d-flex.justify-content-between {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .timeline-item .timeline-date {
    margin-bottom: 0.5rem;
  }
  
  .timeline-item .badge-and-actions {
    width: 100%;
    justify-content: space-between;
  }
}

/* 削除ボタンのホバーエフェクト */
.timeline-item .btn-outline-danger {
  transition: all 0.2s;
}

.timeline-item {
  transform: translateY(-2px);
  box-shadow: 0 2px 5px rgba(220, 53, 69, 0.3);
}

/* 削除確認ページのスタイル調整 */
.card-header.bg-danger {
  background-color: var(--danger-color) !important;
}

.alert-light {
  background-color: #f8f9fa;
  border-color: #eaecf0;
}

.alert-light strong {
  color: var(--primary-color);
}
/* タイプ別のマーカーカラー */
.item-active::before {
  background-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(74, 109, 167, 0.3);
}

.item-sold::before {
  background-color: var(--success-color);
  box-shadow: 0 0 0 2px rgba(90, 154, 120, 0.3);
}

.item-memo::before {
  background-color: var(--info-color);
  box-shadow: 0 0 0 2px rgba(124, 155, 210, 0.3);
}

/* 現在表示中の項目 */
.timeline-current::before {
  width: 18px;
  height: 18px;
  left: -32px;
  top: 14px;
  background-color: var(--secondary-color);
  box-shadow: 0 0 0 3px rgba(232, 168, 124, 0.4);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(232, 168, 124, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(232, 168, 124, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(232, 168, 124, 0);
  }
}

/* 日付表示 */
.timeline-date {
  font-family: 'Courier New', monospace;
  color: var(--text-light);
  margin-bottom: 8px;
  font-weight: 500;
  display: flex;
  align-items: center;
}

.current-badge {
  display: inline-block;
  padding: 2px 8px;
  margin-left: 8px;
  border-radius: 12px;
  background-color: var(--secondary-color);
  color: white;
  font-size: 0.75rem;
}

/* カードリンク - 単純化したバージョン */
.timeline-card-link {
  display: block;
  color: inherit;
  text-decoration: none;
  transition: transform 0.2s;
}

.timeline-card-link:hover {
  transform: translateY(-3px);
  color: inherit;
  text-decoration: none;
}

/* シンプルカード */
.simple-card {
  background-color: white;
  border-radius: var(--border-radius);
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  padding: 15px;
  position: relative;
  border-left: 3px solid var(--primary-color);
  transition: box-shadow 0.2s;
}

.timeline-card-link:hover .simple-card {
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

/* カード種類による色分け */
.item-sold .simple-card {
  border-left-color: var(--success-color);
}

.item-memo .simple-card {
  border-left-color: var(--info-color);
}

/* 現在表示中のカード */
.current-card {
  border: 2px solid var(--secondary-color);
  border-left-width: 5px;
  box-shadow: 0 3px 10px rgba(232, 168, 124, 0.2);
}

/* カード内の要素 */
.card-badge {
  margin-bottom: 10px;
}

.card-title {
  margin-bottom: 10px;
  font-size: 1rem;
  color: var(--primary-color);
}

.card-price {
  margin-bottom: 10px;
  font-size: 0.9rem;
}

.card-content {
  font-size: 0.9rem;
  line-height: 1.5;
  color: var(--text-color);
  margin-bottom: 10px;
}

.card-tag {
  display: inline-block;
  padding: 3px 8px;
  margin-top: 5px;
  margin-right: 5px;
  font-size: 0.75rem;
  border-radius: 12px;
  background-color: rgba(74, 109, 167, 0.1);
  color: var(--primary-color);
}

/* レスポンシブ対応 */
@media (max-width: 767.98px) {
  .timeline-list {
    padding-left: 30px;
  }
  
  .timeline-list::before {
    left: 12px;
  }
  
  .timeline-list-item::before {
    left: -25px;
    width: 12px;
    height: 12px;
  }
  
  .timeline-current::before {
    width: 16px;
    height: 16px;
    left: -27px;
  }
  
  .simple-card {
    padding: 12px;
  }
  
  .card-title {
    font-size: 0.95rem;
  }
  
  .card-content, .card-price {
    font-size: 0.85rem;
  }
}

/* モバイル最適化 */
@media (max-width: 575.98px) {
  .timeline-list {
    padding-left: 25px;
  }
  
  .timeline-list::before {
    left: 10px;
  }
  
  .timeline-list-item::before {
    left: -20px;
    width: 10px;
    height: 10px;
    top: 16px;
  }
  
  .timeline-current::before {
    width: 14px;
    height: 14px;
    left: -22px;
    top: 14px;
  }
  
  .timeline-date {
    font-size: 0.8rem;
  }
  
  .current-badge {
    font-size: 0.7rem;
    padding: 1px 6px;
  }
  
  .simple-card {
    padding: 10px;
  }
}

/* 継続記録のUI改善用スタイル */
.quick-note-form {
  border-radius: var(--border-radius);
  background-color: rgba(255, 255, 255, 0.8);
  padding: 1.25rem;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  margin-bottom: 1.5rem;
}

.quick-note-form .form-floating {
  margin-bottom: 1rem;
}

.quick-note-form .form-floating > label {
  padding-left: 1rem;
  color: var(--text-light);
}

.quick-note-form .form-control {
  border-radius: 8px;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.quick-note-form .note-type-select {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-bottom: 1rem;
}

.quick-note-form .note-type-option {
  flex: 1;
  min-width: 100px;
  padding: 0.5rem;
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.2s;
}

.quick-note-form .note-type-option:hover {
  background-color: rgba(var(--primary-color-rgb, 90, 126, 197), 0.05);
}

.quick-note-form .note-type-option.active {
  background-color: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

.quick-note-form .importance-select {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.quick-note-form .importance-option {
  padding: 0.5rem 1rem;
  border-radius: 30px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s;
}

.quick-note-form .importance-option:hover {
  transform: translateY(-2px);
}

.quick-note-form .importance-option.low {
  background-color: rgba(var(--text-light-rgb, 107, 114, 128), 0.1);
  border: 1px solid rgba(var(--text-light-rgb, 107, 114, 128), 0.2);
}

.quick-note-form .importance-option.low.active {
  background-color: var(--text-light, #6b7280);
  color: white;
}

.quick-note-form .importance-option.medium {
  background-color: rgba(var(--primary-color-rgb, 90, 126, 197), 0.1);
  border: 1px solid rgba(var(--primary-color-rgb, 90, 126, 197), 0.2);
}

.quick-note-form .importance-option.medium.active {
  background-color: var(--primary-color, #5a7ec5);
  color: white;
}

.quick-note-form .importance-option.high {
  background-color: rgba(var(--danger-color-rgb, 225, 90, 90), 0.1);
  border: 1px solid rgba(var(--danger-color-rgb, 225, 90, 90), 0.2);
}

.quick-note-form .importance-option.high.active {
  background-color: var(--danger-color, #e15a5a);
  color: white;
}

/* モバイル最適化 */
@media (max-width: 767px) {
  .quick-note-form {
    padding: 1rem;
  }
  
  .quick-note-form .note-type-select {
    flex-wrap: wrap;
  }
  
  .quick-note-form .note-type-option {
    flex: 1 1 calc(33% - 0.5rem);
    padding: 0.5rem 0.25rem;
    font-size: 0.8rem;
  }
  
  .quick-note-form .importance-option {
    padding: 0.4rem 0.75rem;
    font-size: 0.8rem;
  }
}

/* 削除確認モーダル */
.delete-confirm-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1050;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}

.delete-confirm-modal.active {
  opacity: 1;
  visibility: visible;
}

.delete-confirm-content {
  background-color: white;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  padding: 1.5rem;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  transform: translateY(20px);
  opacity: 0;
  transition: transform 0.3s, opacity 0.3s;
}

.delete-confirm-modal.active .delete-confirm-content {
  transform: translateY(0);
  opacity: 1;
}

.delete-confirm-header {
  display: flex;
  align-items: center;
  margin-bottom: 1rem;
}

.delete-confirm-header .icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: rgba(var(--danger-color-rgb, 225, 90, 90), 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--danger-color, #e15a5a);
  margin-right: 1rem;
}

.delete-confirm-header .title {
  font-weight: 600;
  color: var(--danger-color, #e15a5a);
  margin: 0;
}

.delete-confirm-body {
  margin-bottom: 1.5rem;
}

.delete-confirm-footer {
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
}

/* 継続記録のアイテムスタイル改善 */
.note-item {
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 1.5rem;
  background-color: white;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  border: 1px solid rgba(0, 0, 0, 0.05);
}

.note-header {
  padding: 0.75rem 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.note-header-left {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.note-date {
  font-weight: 500;
  color: var(--text-color);
}

.note-actions {
  display: flex;
  gap: 0.5rem;
}

.note-body {
  padding: 1rem;
}

.note-price-info {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 0.75rem;
  padding: 0.5rem;
  background-color: rgba(0, 0, 0, 0.02);
  border-radius: 8px;
}

.note-price-item {
  display: flex;
  flex-direction: column;
}

.note-price-label {
  font-size: 0.8rem;
  color: var(--text-light);
}

.note-price-value {
  font-weight: 500;
}

.note-content {
  line-height: 1.6;
}

.note-item.high {
  border-left: 3px solid var(--danger-color);
}

.note-item.medium {
  border-left: 3px solid var(--primary-color);
}

.note-item.low {
  border-left: 3px solid var(--text-light);
}

/* モバイル最適化のための追加スタイル */
@media (max-width: 767px) {
  /* コンテナのパディング削減 */
  .container {
    padding-left: 10px;
    padding-right: 10px;
  }
  
  /* 日記カードの余白削減 */
  .diary-card {
    padding: 12px 8px;
    margin-bottom: 15px;
  }
  
  /* マスキングテープをモバイルでは小さく */
  .masking-tape {
    height: 15px;
    width: 70px;
  }
  
  /* ヘッダーの簡略化 */
  .diary-card-header {
    margin-bottom: 10px;
  }
  
  /* 日記タイトルのフォントサイズ調整 */
  .diary-title {
    font-size: 1.25rem;
  }
  
  /* サブセクションタイトルの調整 */
  .section-title {
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
  }
  
  /* 情報ブロックの調整 */
  .info-block {
    padding: 10px;
  }
  
  .info-item {
    padding: 8px 4px;
  }
  
  /* タブナビゲーションの最適化 */
  .diary-tabs-container .nav-tabs {
    flex-wrap: nowrap;
    overflow-x: auto;
    scrollbar-width: none; /* Firefox */
  }
  
  .diary-tabs-container .nav-tabs::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
  }
  
  .diary-tabs-container .nav-link {
    padding: 0.5rem 0.75rem;
    white-space: nowrap;
  }
  
  /* フローティングアクションボタン */
  .floating-expand-button {
    position: fixed;
    bottom: 20px;
    left: 20px; /* 右から左に変更 */
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--primary-color, #5a7ec5);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    z-index: 1030;
    transition: all 0.3s ease;
    border: none;
  }

  /* ホバーとアクティブ状態 */
  .floating-expand-button:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }

  .floating-expand-button:active {
    transform: scale(0.95);
  }

  .floating-expand-button i {
    font-size: 1.5rem;
  }

  /* iPhoneの左下のホームインジケーターと重ならないように調整 */
  @media (max-width: 767.98px) {
    .floating-expand-button {
      bottom: 24px;
    }
  }

  /* スピードダイヤルとの間隔を広げる */
  @media (min-width: 768px) {
    .floating-expand-button {
      bottom: 30px;
      left: 30px;
    }
  }

  /* 拡張表示モード */
  .fullscreen-tab-mode .diary-card {
    position: fixed;
    top: 10px;
    left: 10px; /* 右から左に変更 */
    right: 0;
    bottom: 0;
    z-index: 1040;
    margin: 0;
    border-radius: 0;
    overflow-y: auto;
    background-color: white;
  }
  
  .fullscreen-tab-mode .diary-tabs-container {
    margin: -12px -8px 0;
    border-radius: 0;
    box-shadow: none;
  }
  
  .fullscreen-tab-mode .nav-tabs {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
  }
  
  .fullscreen-tab-mode .diary-card-header,
  .fullscreen-tab-mode .action-buttons,
  .fullscreen-tab-mode .diary-date,
  .fullscreen-tab-mode .masking-tape {
    display: none;
  }
  
  .fullscreen-tab-mode .diary-tab-content {
    padding-bottom: 80px;
  }
  
  .fullscreen-tab-mode .back-to-normal {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 1050;
    background: white;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    border: none;
  }
  
  /* 継続記録フォームの最適化 */
  .quick-note-form {
    padding: 0.75rem;
    margin-bottom: 1rem;
  }
  
  /* タブフォーカスモード */
  .mobile-tab-focus .diary-tab-content {
    min-height: 85vh;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- 戻るリンク -->
  <div class="mb-3">
    <a href="{% url 'stockdiary:home' %}" class="btn btn-diary btn-diary-outline">
      <i class="bi bi-arrow-left"></i> 日記一覧に戻る
    </a>
  </div>

  <!-- 日記詳細カード -->
  <div class="diary-card {% if diary.is_memo or diary.purchase_price is None or diary.purchase_quantity is None %}memo-card{% elif diary.sell_date %}sold-card{% endif %}">
    <!-- マスキングテープ装飾 - ランダムな色で -->
    <div class="masking-tape {% if diary.id|divisibleby:3 %}yellow{% elif diary.id|divisibleby:2 %}green{% endif %}"></div>
    
    <!-- 日記ヘッダー -->
    <div class="mx-3 diary-card-header d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <h2 class="mb-0 me-2 diary-title">{{ diary.stock_name }}</h2>
        <span class="badge bg-secondary">{{ diary.stock_symbol }}</span>
        
        <!-- メモバッジ -->
        {% if diary.is_memo or diary.purchase_price is None or diary.purchase_quantity is None %}
        <span class="badge bg-info ms-2">メモ</span>
        {% endif %}
        
        <!-- 売却済みバッジ -->
        {% if diary.sell_date %}
        <span class="badge bg-danger ms-2">売却済み</span>
        {% endif %}
      </div>
      
      <!-- PC用の操作ボタン群 -->
      <div class="action-buttons d-none d-md-flex">
        {% if not diary.sell_date and not diary.is_memo and diary.purchase_price is not None and diary.purchase_quantity is not None %}
        <a href="{% url 'stockdiary:sell_specific' diary.id %}" class="btn btn-diary btn-diary-success">
          <i class="bi bi-cash-coin me-1"></i> 売却
        </a>
        {% endif %}
        
        {% if diary.sell_date %}
        <a href="{% url 'stockdiary:cancel_sell' diary.id %}" class="btn btn-diary btn-diary-success">
          <i class="bi bi-arrow-counterclockwise me-1"></i> 売却取消
        </a>
        {% endif %}
        
        <a href="{% url 'stockdiary:update' diary.id %}" class="btn btn-diary btn-diary-warning ms-2">
          <i class="bi bi-pencil me-1"></i> 編集
        </a>
        
        <a href="{% url 'stockdiary:delete' diary.id %}" class="btn btn-diary btn-diary-danger ms-2">
          <i class="bi bi-trash me-1"></i> 削除
        </a>
      </div>
    </div>
    
    <!-- 日記本文部分 -->
    <div class="diary-card-body">
      <!-- メモアイコン -->
      {% if diary.is_memo or diary.purchase_price is None or diary.purchase_quantity is None %}
      <i class="bi bi-sticky memo-icon"></i>
      {% endif %}
      
      <!-- 日付表示 -->
      <p class="diary-date">
        <i class="bi bi-calendar-check"></i> {{ diary.purchase_date|date:"Y年m月d日" }}
      </p>
      
      <!-- タブナビゲーション -->
      <div class="diary-tabs-container mt-4">
        <!-- スワイプヒント（モバイルのみ表示） -->
        <div class="swipe-hint text-center text-muted mb-2 d-md-none">
          <i class="bi bi-arrow-left-right me-1"></i> 左右にスワイプでタブを切り替え
        </div>
        
        <ul class="nav nav-tabs" id="diaryDetailTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic-content" 
                    type="button" role="tab" aria-controls="basic-content" aria-selected="true">
              <i class="bi bi-info-circle me-1"></i> 基本情報
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes-content" 
                    type="button" role="tab" aria-controls="notes-content" aria-selected="false">
              <i class="bi bi-journal-richtext me-1"></i> 継続記録
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline-content" 
                    type="button" role="tab" aria-controls="timeline-content" aria-selected="false">
              <i class="bi bi-link-45deg me-1"></i> タイムライン
            </button>
          </li>
        </ul>
        
        <!-- タブコンテンツ -->
        <div class="tab-content diary-tab-content" id="diaryDetailTabContent">
          <!-- 基本情報タブ -->
          <div class="tab-pane fade show active" id="basic-content" role="tabpanel" aria-labelledby="basic-tab">
            <div class="row">
              <!-- 購入理由セクション -->
              <div class="col-lg-6 mb-4">
                <h3 class="section-title mb-3">
                  <i class="bi bi-journal-text"></i> 
                  {% if diary.is_memo or diary.purchase_price is None or diary.purchase_quantity is None %}
                  メモ内容
                  {% else %}
                  購入理由
                  {% endif %}
                </h3>
                
                <div class="mx-3">
                  {{ diary.reason|safe|linebreaksbr }}
                </div>
              </div>
              
              <!-- 基本情報セクション -->
              <div class="col-lg-6 mb-4">
                <h3 class="section-title mb-3">
                  <i class="bi bi-info-circle"></i> 売買情報
                </h3>
                
                <div class="info-block">
                  <div class="info-row">
                    <div class="info-item">
                      <div class="info-icon">
                        <i class="bi bi-calendar-date"></i>
                      </div>
                      <div class="info-content">
                        <span class="info-label">購入/メモ日</span>
                        <span class="info-value">{{ diary.purchase_date|date:"Y年m月d日" }}</span>
                      </div>
                    </div>
                    
                    {% if not diary.is_memo and diary.purchase_price is not None %}
                    <div class="info-item">
                      <div class="info-icon">
                        <i class="bi bi-currency-yen"></i>
                      </div>
                      <div class="info-content">
                        <span class="info-label">購入価格</span>
                        <span class="info-value">{{ diary.purchase_price|floatformat:2|intcomma }}円</span>
                      </div>
                    </div>
                    {% endif %}
                    
                    {% if not diary.is_memo and diary.purchase_quantity is not None %}
                    <div class="info-item">
                      <div class="info-icon">
                        <i class="bi bi-graph-up"></i>
                      </div>
                      <div class="info-content">
                        <span class="info-label">購入数量</span>
                        <span class="info-value">{{ diary.purchase_quantity }}株</span>
                      </div>
                    </div>
                    {% endif %}
                    
                    {% if not diary.is_memo and diary.purchase_price is not None and diary.purchase_quantity is not None %}
                    <div class="info-item">
                      <div class="info-icon">
                        <i class="bi bi-cash-stack"></i>
                      </div>
                      <div class="info-content">
                        <span class="info-label">総購入額</span>
                        <span class="info-value">{{ diary.purchase_price|mul:diary.purchase_quantity|floatformat:2|intcomma }}円</span>
                      </div>
                    </div>
                    {% endif %}
                  </div>
                  
                  <!-- 売却情報 -->
                  {% if diary.sell_date %}
                  <hr class="my-3" style="border-style: dashed;">
                  
                  <div class="info-row">
                    <div class="info-item">
                      <div class="info-icon">
                        <i class="bi bi-calendar-check"></i>
                      </div>
                      <div class="info-content">
                        <span class="info-label">売却日</span>
                        <span class="info-value">{{ diary.sell_date|date:"Y年m月d日" }}</span>
                      </div>
                    </div>
                    
                    <div class="info-item">
                      <div class="info-icon">
                        <i class="bi bi-currency-yen"></i>
                      </div>
                      <div class="info-content">
                        <span class="info-label">売却価格</span>
                        <span class="info-value">{{ diary.sell_price|floatformat:2|intcomma }}円</span>
                      </div>
                    </div>
                    
                    <div class="info-item">
                      <div class="info-icon">
                        <i class="bi bi-graph-up-arrow"></i>
                      </div>
                      <div class="info-content">
                        <span class="info-label">損益</span>
                        {% with profit=diary.sell_price|sub:diary.purchase_price|mul:diary.purchase_quantity %}
                        {% if profit > 0 %}
                        <span class="profit">+{{ profit|floatformat:2|intcomma }}円</span>
                        {% elif profit < 0 %} 
                        <span class="loss">{{ profit|floatformat:2|intcomma }}円</span>
                        {% else %}
                        <span class="text-muted">{{ profit|floatformat:2|intcomma }}円</span>
                        {% endif %}
                        {% endwith %}
                      </div>
                    </div>
                    
                    <div class="info-item">
                      <div class="info-icon">
                        <i class="bi bi-percent"></i>
                      </div>
                      <div class="info-content">
                        <span class="info-label">損益率</span>
                        {% with rate=diary.sell_price|sub:diary.purchase_price|div:diary.purchase_price|mul:100 %}
                        {% if rate > 0 %}
                        <span class="profit">+{{ rate|floatformat:2 }}%</span>
                        {% elif rate < 0 %} 
                        <span class="loss">{{ rate|floatformat:2 }}%</span>
                        {% else %}
                        <span class="text-muted">{{ rate|floatformat:2 }}%</span>
                        {% endif %}
                        {% endwith %}
                      </div>
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <!-- 分析データセクション -->
            {% if diary.analysis_values.exists %}
            <div class="col-lg-12 mb-4">
              <h3 class="section-title mb-3">
                <i class="bi bi-clipboard-data"></i> 分析データ
              </h3>

              {% regroup diary.analysis_values.all|dictsort:"analysis_item.template.id" by analysis_item.template as template_groups %}

              {% for template_group in template_groups %}
              <div class="info-block mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h4 class="mb-0" style="color: var(--primary-color);">{{ template_group.grouper.name }}</h4>
                  <a href="{% url 'analysis_template:report' template_group.grouper.id %}" class="btn btn-diary btn-diary-outline">
                    <i class="bi bi-clipboard-data"></i> レポート
                  </a>
                </div>
                
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th style="width: 50%;">項目</th>
                        <th>値</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for value in template_group.list|dictsort:"analysis_item.order" %}
                      <tr>
                        <td>
                          <strong>{{ value.analysis_item.name }}</strong>
                          {% if value.analysis_item.description %}
                          <div class="small text-muted">{{ value.analysis_item.description|linebreaksbr }}</div>
                          {% endif %}
                        </td>
                        <td>
                          {% if value.analysis_item.item_type == 'boolean_with_value' %}
                          <div class="d-flex align-items-center gap-2">
                            <!-- チェックボックス状態の表示 -->
                            <div class="status-indicator">
                              {% if value.boolean_value %}
                                <span class="badge bg-success" data-bs-toggle="tooltip" title="条件を満たしています">
                                  <i class="bi bi-check-lg"></i>
                                </span>
                              {% else %}
                                <span class="badge bg-secondary" data-bs-toggle="tooltip" title="条件を満たしていません">
                                  <i class="bi bi-x-lg"></i>
                                </span>
                              {% endif %}
                            </div>
                            
                            <!-- 値の表示 -->
                            <div class="value-display">
                              {% if value.number_value != None %}
                                <span class="fw-medium">{{ value.number_value|floatformat:"-2" }}</span>
                              {% elif value.text_value %}
                                <span class="text-value">{{ value.text_value }}</span>
                              {% else %}
                                <span class="text-muted small">-</span>
                              {% endif %}
                            </div>
                          </div>
                          {% elif value.analysis_item.item_type == 'number' %}
                          <span class="fw-bold">{{ value.number_value|floatformat:"-2" }}</span>
                          {% elif value.analysis_item.item_type == 'boolean' %}
                          {% if value.boolean_value %}
                            <span class="badge bg-success">
                              <i class="bi bi-check-lg"></i> はい
                            </span>
                          {% else %}
                            <span class="badge bg-secondary">
                              <i class="bi bi-x-lg"></i> いいえ
                            </span>
                          {% endif %}
                          {% elif value.analysis_item.item_type == 'select' %}
                          <span class="badge bg-info">{{ value.text_value }}</span>
                          {% else %}
                          {{ value.text_value|default:"-" }}
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              {% endfor %}
            </div>
            {% endif %}

            <div class="row">
              <!-- タグセクション -->
              <div class="col-lg-6 mb-4">
                <h3 class="section-title mb-1">
                  <i class="bi bi-tags"></i> タグ
                </h3>
                
                <div style="background-color:rgba(255,255,255,0.5); padding:15px; border-radius:8px;">
                  {% for tag in diary.tags.all %}
                  <span class="diary-tag my-1">{{ tag.name }}</span>
                  {% empty %}
                  <p class="text-muted mb-0">タグはありません</p>
                  {% endfor %}
                </div>
              </div>

              <!-- メモセクション -->
              <div class="col-lg-6 mb-4">
                <h3 class="section-title mb-3">
                  <i class="bi bi-sticky"></i> メモ
                </h3>
                
                <div style="background-color:rgba(255,255,255,0.5); padding:15px; border-radius:8px; min-height:100px;">
                  {% if diary.memo %}
                  <div class="rich-content">{{ diary.memo|linebreaks }}</div>
                  {% else %}
                  <p class="text-muted mb-0">メモはありません</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          
          <!-- 継続記録タブ -->
          <div class="tab-pane fade" id="notes-content" role="tabpanel" aria-labelledby="notes-tab">
            
            <!-- 継続記録の表示 -->
            <div class="notes-container">
              {% for note in notes %}
              <div class="note-item {{ note.importance }}" id="note-{{ note.id }}">
                <div class="note-header">
                  <div class="note-header-left">
                    <span class="note-date">
                      <i class="bi bi-calendar-date"></i> {{ note.date|date:"Y年m月d日" }}
                    </span>
                    <span class="badge {% if note.note_type == 'analysis' %}bg-primary
                          {% elif note.note_type == 'news' %}bg-info
                          {% elif note.note_type == 'earnings' %}bg-success
                          {% elif note.note_type == 'insight' %}bg-warning
                          {% elif note.note_type == 'risk' %}bg-danger
                          {% else %}bg-secondary{% endif %}">
                      {% if note.note_type == 'analysis' %}分析更新
                      {% elif note.note_type == 'news' %}ニュース
                      {% elif note.note_type == 'earnings' %}決算情報
                      {% elif note.note_type == 'insight' %}新たな気づき
                      {% elif note.note_type == 'risk' %}リスク要因
                      {% else %}その他{% endif %}
                    </span>
                  </div>
                  <div class="note-actions">
                    <button type="button" class="btn btn-sm btn-outline-danger delete-note-btn" 
                            data-note-id="{{ note.id }}" title="削除">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
                
                <div class="note-body">
                  {% if note.current_price %}
                  <div class="note-price-info">
                    <div class="note-price-item">
                      <span class="note-price-label">記録時価格</span>
                      <span class="note-price-value">{{ note.current_price|floatformat:2|intcomma }}円</span>
                    </div>
                    
                    {% with price_change=note.get_price_change %}
                    {% if price_change %}
                    <div class="note-price-item">
                      <span class="note-price-label">購入時からの変動</span>
                      <span class="note-price-value {% if price_change > 0 %}text-success{% elif price_change < 0 %}text-danger{% endif %}">
                        {{ price_change|floatformat:2 }}%
                      </span>
                    </div>
                    {% endif %}
                    {% endwith %}
                  </div>
                  {% endif %}
                  
                  <div class="note-content">
                    {{ note.content|safe|linebreaks }}
                  </div>
                </div>
              </div>
              {% empty %}
              <div class="text-center py-4">
                <i class="bi bi-journal-text text-muted" style="font-size: 2rem;"></i>
                <p class="text-muted mt-2">継続的な記録はまだありません。</p>
                <p class="text-muted">上のフォームから銘柄の状況変化や新たな分析を追加できます。</p>
              </div>
              {% endfor %}
            </div>
            <!-- 改善された継続記録入力フォーム -->
            <div class="quick-note-form">
              <form id="quickNoteForm" method="post" action="{% url 'stockdiary:add_note' diary.id %}">
                {% csrf_token %}
                
                <!-- 日付入力 -->
                <div class="form-floating mb-3">
                  <input type="date" class="form-control" id="note_date" name="date" 
                      value="{{ note_form.date.value|date:'Y-m-d' }}" style="text-align: center;" required>
                  <label for="note_date">日付</label>
                </div>
                
                <!-- 記録タイプの選択（ラジオボタン的なUI） -->
                <div class="note-type-select">
                  <div class="note-type-option active" data-value="analysis">
                    <i class="bi bi-graph-up"></i> 分析更新
                  </div>
                  <div class="note-type-option" data-value="news">
                    <i class="bi bi-newspaper"></i> ニュース
                  </div>
                  <div class="note-type-option" data-value="earnings">
                    <i class="bi bi-bar-chart"></i> 決算情報
                  </div>
                  <div class="note-type-option" data-value="insight">
                    <i class="bi bi-lightbulb"></i> 気づき
                  </div>
                  <div class="note-type-option" data-value="risk">
                    <i class="bi bi-exclamation-triangle"></i> リスク
                  </div>
                  <input type="hidden" id="note_type" name="note_type" value="analysis">
                </div>
                
                <!-- 重要度の選択 -->
                <div class="importance-select">
                  <div class="importance-option low" data-value="low">
                    <i class="bi bi-arrow-down-circle"></i> 低
                  </div>
                  <div class="importance-option medium active" data-value="medium">
                    <i class="bi bi-dash-circle"></i> 中
                  </div>
                  <div class="importance-option high" data-value="high">
                    <i class="bi bi-arrow-up-circle"></i> 高
                  </div>
                  <input type="hidden" id="note_importance" name="importance" value="medium">
                </div>
                
                <!-- 内容入力 -->
                <div class="form-floating mb-3">
                  <textarea class="form-control" id="note_content" name="content" 
                            style="height: 120px" placeholder="記録内容を入力" required></textarea>
                  <label for="note_content">記録内容</label>
                </div>
                
                <!-- 現在価格入力 -->
                <div class="input-group mb-3">
                  <span class="input-group-text">現在価格</span>
                  <input type="number" class="form-control" id="note_current_price" 
                         name="current_price" placeholder="円" step="0.01">
                  <button type="button" class="btn btn-outline-primary" id="fetch-note-price">
                    <i class="bi bi-arrow-repeat"></i> 現在株価取得
                  </button>
                </div>
                
                <div class="d-flex justify-content-end">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-journal-plus me-1"></i> 記録を追加
                  </button>
                </div>
              </form>
            </div>
          </div>
          
          <!-- タイムラインタブ -->
          <div class="tab-pane fade" id="timeline-content" role="tabpanel" aria-labelledby="timeline-tab">
            {% if related_diaries %}
            <div class="investment-timeline">
              <!-- タイムラインリスト - すべての日記を日付順に表示 -->
              <ol class="timeline-list">
                {% for timeline_diary in timeline_diaries %}
                  <li class="timeline-list-item {% if timeline_diary.sell_date %}item-sold{% elif timeline_diary.is_memo or timeline_diary.purchase_price is None or timeline_diary.purchase_quantity is None %}item-memo{% else %}item-active{% endif %} {% if timeline_diary.id == diary.id %}timeline-current{% endif %}">
                    <div class="timeline-date">
                      {{ timeline_diary.purchase_date|date:"Y年m月d日" }}
                      {% if timeline_diary.id == diary.id %}
                        <span class="current-badge">現在表示中</span>
                      {% endif %}
                    </div>
                    
                    {% if timeline_diary.id == diary.id %}
                      <!-- 現在表示中の日記 -->
                      <div class="simple-card current-card">
                        <div class="card-badge">
                          {% if timeline_diary.sell_date %}
                            <span class="badge bg-danger">売却済み</span>
                          {% elif timeline_diary.is_memo or timeline_diary.purchase_price is None or timeline_diary.purchase_quantity is None %}
                            <span class="badge bg-info">メモ</span>
                          {% else %}
                            <span class="badge bg-success">保有中</span>
                          {% endif %}
                        </div>
                        
                        <h6 class="card-title">{{ timeline_diary.stock_name }}</h6>
                        
                        {% if not timeline_diary.is_memo and timeline_diary.purchase_price is not None and timeline_diary.purchase_quantity is not None %}
                        <div class="card-price">
                          {{ timeline_diary.purchase_price|floatformat:2|intcomma }}円 × {{ timeline_diary.purchase_quantity }}株
                          {% if timeline_diary.sell_date %}
                            {% with profit=timeline_diary.sell_price|sub:timeline_diary.purchase_price|div:timeline_diary.purchase_price|mul:100 %}
                            <span class="{% if profit > 0 %}text-success{% elif profit < 0 %}text-danger{% endif %}">
                              ({{ profit|floatformat:2 }}%)
                            </span>
                            {% endwith %}
                          {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="card-content">
                          {{ timeline_diary.reason|safe|truncatewords_html:20 }}
                        </div>
                      </div>
                    {% else %}
                      <!-- その他の関連日記 -->
                      <a href="{% url 'stockdiary:detail' timeline_diary.id %}" class="timeline-card-link">
                        <div class="simple-card">
                          <div class="card-badge">
                            {% if timeline_diary.sell_date %}
                              <span class="badge bg-danger">売却済み</span>
                            {% elif timeline_diary.is_memo or timeline_diary.purchase_price is None or timeline_diary.purchase_quantity is None %}
                              <span class="badge bg-info">メモ</span>
                            {% else %}
                              <span class="badge bg-success">保有中</span>
                            {% endif %}
                          </div>
                          
                          <h6 class="card-title">{{ timeline_diary.stock_name }}</h6>
                          
                          {% if not timeline_diary.is_memo and timeline_diary.purchase_price is not None and timeline_diary.purchase_quantity is not None %}
                          <div class="card-price">
                            {{ timeline_diary.purchase_price|floatformat:2|intcomma }}円 × {{ timeline_diary.purchase_quantity }}株
                            {% if timeline_diary.sell_date %}
                              {% with profit=timeline_diary.sell_price|sub:timeline_diary.purchase_price|div:timeline_diary.purchase_price|mul:100 %}
                              <span class="{% if profit > 0 %}text-success{% elif profit < 0 %}text-danger{% endif %}">
                                ({{ profit|floatformat:2 }}%)
                              </span>
                              {% endwith %}
                            {% endif %}
                          </div>
                          {% endif %}
                          
                          <div class="card-content">
                            {{ timeline_diary.reason|safe|truncatewords_html:20 }}
                          </div>
                          
                          {% if timeline_diary.tags.exists %}
                          <div class="card-tags">
                            {% for tag in timeline_diary.tags.all|slice:":3" %}
                            <span class="card-tag">{{ tag.name }}</span>
                            {% endfor %}
                          </div>
                          {% endif %}
                        </div>
                      </a>
                    {% endif %}
                  </li>
                {% endfor %}
              </ol>
              
              {% if related_diaries_count > 10 %}
              <div class="text-center mt-4">
                <a href="{% url 'stockdiary:home' %}?query={{ diary.stock_symbol }}" class="btn btn-outline-primary btn-sm">
                  すべての記録を表示 (全{{ total_related_count }}件)
                </a>
              </div>
              {% endif %}
              
              <!-- 位置情報（オプション） -->
              {% if current_diary_index is not None %}
              <div class="text-center text-muted mt-3 small">
                <span>{{ current_diary_index|add:1 }}</span> / <span>{{ total_related_count }}</span> 件目
              </div>
              {% endif %}
            </div>
            {% else %}
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              この銘柄の他の日記記録はありません。
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- カード内フッター部分 -->
      <div class="diary-card-footer mx-2">
        <!-- モバイル向けレイアウト(小さい画面) -->
        <div class="d-md-none">
          <div class="d-flex flex-column">
            <!-- メタ情報を上部に -->
            <div class="meta-info mb-2 text-center small">
              <span class="d-block mb-1">
                <i class="bi bi-calendar-check me-1"></i> 作成: {{ diary.created_at|date:"Y/m/d H:i" }}
              </span>
              <span class="d-block">
                <i class="bi bi-clock-history me-1"></i> 更新: {{ diary.updated_at|date:"Y/m/d H:i" }}
              </span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- デスクトップ向けレイアウト(中・大画面) -->
      <div class="d-none d-md-flex justify-content-between align-items-center">
        <div class="meta-info">
          <i class="bi bi-calendar-check me-1"></i> 作成: {{ diary.created_at|date:"Y年m月d日 H:i" }}
          <span class="mx-2">|</span>
          <i class="bi bi-clock-history me-1"></i> 更新: {{ diary.updated_at|date:"Y年m月d日 H:i" }}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 継続記録削除確認モーダル -->
<div class="delete-confirm-modal" id="deleteNoteModal">
  <div class="delete-confirm-content">
    <div class="delete-confirm-header">
      <div class="icon">
        <i class="bi bi-exclamation-triangle"></i>
      </div>
      <h5 class="title">継続記録を削除しますか？</h5>
    </div>
    <div class="delete-confirm-body">
      <p>このアクションは取り消せません。本当に削除しますか？</p>
    </div>
    <div class="delete-confirm-footer">
      <button type="button" class="btn btn-outline-secondary" id="cancelDeleteBtn">
        キャンセル
      </button>
      <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
        <i class="bi bi-trash me-1"></i> 削除する
      </button>
    </div>
  </div>
</div>

<!-- スピードダイアルコンポーネント -->
{% include 'speed_dial.html' with actions=diary_actions %}
{% endblock %}

{% block scripts %}
{{ block.super }}

<!-- タブスワイプ機能スクリプト -->
<script>
/**
 * diary-detail-tabs.js - 日記詳細ページのタブスワイプ機能
 * 継続記録とタイムラインタブ間のスワイプ操作を実装
 */
document.addEventListener('DOMContentLoaded', function() {
  // タブ要素を取得
  const tabContent = document.getElementById('diaryDetailTabContent');
  const basicTab = document.getElementById('basic-tab');
  const notesTab = document.getElementById('notes-tab');
  const timelineTab = document.getElementById('timeline-tab');
  
  // タブ要素が存在しない場合は何もしない
  if (!tabContent || !basicTab || !notesTab || !timelineTab) return;
  
  // Bootstrap Tab インスタンスを取得
  const basicTabInstance = new bootstrap.Tab(basicTab);
  const notesTabInstance = new bootstrap.Tab(notesTab);
  const timelineTabInstance = new bootstrap.Tab(timelineTab);
  
  // スワイプ関連の変数
  let touchStartX = 0;
  let touchEndX = 0;
  let touchMoveX = 0;
  let startTime = 0;
  let moveDistance = 0;
  let currentTabIndex = 0;
  let isDragging = false;
  let isAnimating = false;
  
  // 定数
  const TRANSITION_DURATION = 300; // ミリ秒
  const DRAG_THRESHOLD = 80; // スワイプと判定する最小距離（px）
  const VELOCITY_THRESHOLD = 0.5; // スワイプと判定する最小速度（px/ms）
  
  // 現在のタブインデックスを設定
  function initTabIndex() {
    if (basicTab.classList.contains('active')) {
      currentTabIndex = 0;
    } else if (notesTab.classList.contains('active')) {
      currentTabIndex = 1;
    } else if (timelineTab.classList.contains('active')) {
      currentTabIndex = 2;
    } else {
      currentTabIndex = 0;
    }
  }
  
  // スワイプ状態のリセット
  function resetSwipeState() {
    touchStartX = 0;
    touchEndX = 0;
    touchMoveX = 0;
    moveDistance = 0;
    isDragging = false;
    isAnimating = false;
    tabContent.classList.remove('swiping');
  }
  
  // スワイプ方向のインジケーターを更新
  function updateDirectionIndicators() {
    // スワイプの方向によって、視覚的なフィードバックを提供する
    if (moveDistance > 0) {
      // 右スワイプ - 前のタブが存在する場合はハイライト
      if (currentTabIndex > 0) {
        const prevTab = currentTabIndex === 1 ? basicTab : notesTab;
        const currentTab = currentTabIndex === 1 ? notesTab : timelineTab;
        currentTab.classList.remove('tab-highlight');
        prevTab.classList.add('tab-highlight');
      }
    } else if (moveDistance < 0) {
      // 左スワイプ - 次のタブが存在する場合はハイライト
      if (currentTabIndex < 2) {
        const nextTab = currentTabIndex === 0 ? notesTab : timelineTab;
        const currentTab = currentTabIndex === 0 ? basicTab : notesTab;
        currentTab.classList.remove('tab-highlight');
        nextTab.classList.add('tab-highlight');
      }
    } else {
      // ハイライトをリセット
      basicTab.classList.remove('tab-highlight');
      notesTab.classList.remove('tab-highlight');
      timelineTab.classList.remove('tab-highlight');
    }
  }
  
  // タッチ開始イベント
  function handleTouchStart(e) {
    if (isAnimating) return;
    
    touchStartX = e.touches[0].clientX;
    startTime = Date.now();
    isDragging = true;
    moveDistance = 0;
    
    // トランジションを無効化してスワイプ中であることを示す
    tabContent.classList.add('swiping');
    
    // タップ振動フィードバック（対応ブラウザのみ）
    if (navigator.vibrate) {
      navigator.vibrate(5);
    }
  }
  
  // タッチ移動イベント
  function handleTouchMove(e) {
    if (!isDragging || isAnimating) return;
    
    touchMoveX = e.touches[0].clientX;
    moveDistance = touchMoveX - touchStartX;
    
    // スワイプ方向の視覚的フィードバックを更新
    updateDirectionIndicators();
  }
  
  // タッチ終了イベント
  function handleTouchEnd(e) {
    if (!isDragging || isAnimating) return;
    
    isDragging = false;
    touchEndX = e.changedTouches[0].clientX;
    
    // スワイプの終了時間と速度を計算
    const endTime = Date.now();
    const duration = endTime - startTime;
    const velocity = Math.abs(moveDistance) / duration; // 速度（px/ms）
    
    // トランジションを有効化
    tabContent.classList.remove('swiping');
    
    // スワイプ距離
    const swipeDistance = touchEndX - touchStartX;
    
    // 素早いスワイプまたは十分な距離があればタブ切り替え
    if (Math.abs(swipeDistance) > DRAG_THRESHOLD || velocity > VELOCITY_THRESHOLD) {
      // 左スワイプ（次のタブへ）
      if (swipeDistance < 0 && currentTabIndex < 2) {
        switchToTab(currentTabIndex + 1);
      } 
      // 右スワイプ（前のタブへ）
      else if (swipeDistance > 0 && currentTabIndex > 0) {
        switchToTab(currentTabIndex - 1);
      } else {
        resetSwipeState();
      }
    } else {
      resetSwipeState();
    }
    
    // 完了時のフィードバック振動
    if (navigator.vibrate) {
      navigator.vibrate(10);
    }
  }
  
  // タッチキャンセルイベント
  function handleTouchCancel() {
    if (isDragging) {
      isDragging = false;
      tabContent.classList.remove('swiping');
      resetSwipeState();
    }
  }
  
  // 指定したインデックスのタブに切り替え
  function switchToTab(index) {
    if (index < 0 || index > 2) return;
    
    // アニメーション中フラグをセット
    isAnimating = true;
    
    // タブの切り替え
    setTimeout(() => {
      if (index === 0) {
        basicTabInstance.show();
      } else if (index === 1) {
        notesTabInstance.show();
      } else {
        timelineTabInstance.show();
      }
      
      // 現在のタブインデックスを更新
      currentTabIndex = index;
      
      // アニメーション完了後に状態をリセット
      setTimeout(() => {
        isAnimating = false;
        resetSwipeState();
      }, TRANSITION_DURATION);
    }, 50);
  }
  
  // イベントリスナーの設定
  function setupEventListeners() {
    // タブコンテンツにタッチイベントリスナーを追加
    tabContent.addEventListener('touchstart', handleTouchStart, { passive: true });
    tabContent.addEventListener('touchmove', handleTouchMove, { passive: true });
    tabContent.addEventListener('touchend', handleTouchEnd, { passive: true });
    tabContent.addEventListener('touchcancel', handleTouchCancel, { passive: true });
    
    // タブ切り替えイベントリスナー
    basicTab.addEventListener('shown.bs.tab', function() {
      currentTabIndex = 0;
      setTimeout(resetSwipeState, 50);
    });
    
    notesTab.addEventListener('shown.bs.tab', function() {
      currentTabIndex = 1;
      setTimeout(resetSwipeState, 50);
    });
    
    timelineTab.addEventListener('shown.bs.tab', function() {
      currentTabIndex = 2;
      setTimeout(resetSwipeState, 50);
    });
  }
  
  // スタイルの初期化
  function initStyles() {
    // スワイプ用のスタイルを追加
    const styleEl = document.createElement('style');
    styleEl.textContent = `
      #diaryDetailTabContent {
        position: relative;
        touch-action: pan-y;
        overflow: hidden;
      }
      
      #diaryDetailTabContent.swiping {
        transition: none;
      }
      
      .tab-pane {
        transition: opacity ${TRANSITION_DURATION}ms ease;
      }
      
      .tab-highlight {
        animation: tab-glow 0.3s ease-out;
      }
      
      @keyframes tab-glow {
        0% { background-color: transparent; }
        50% { background-color: rgba(var(--primary-color-rgb, 90, 126, 197), 0.1); }
        100% { background-color: transparent; }
      }
      
      .swipe-hint {
        opacity: 1;
        transition: opacity 0.5s ease;
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
      }
    `;
    document.head.appendChild(styleEl);
  }
  
  // スワイプヒントの表示/非表示を管理
  function handleSwipeHint() {
    const swipeHint = document.querySelector('.swipe-hint');
    if (!swipeHint) return;
    
    // モバイルデバイスかどうかをチェック
    const isMobile = window.innerWidth < 768 || navigator.maxTouchPoints > 1;
    
    if (isMobile) {
      // モバイルデバイスではスワイプヒントを表示
      swipeHint.style.display = 'block';
      swipeHint.style.opacity = '1';
      
      // 5秒後に非表示
      setTimeout(() => {
        swipeHint.style.opacity = '0';
        setTimeout(() => {
          swipeHint.style.display = 'none';
        }, 500);
      }, 5000);
    } else {
      // デスクトップでは非表示
      swipeHint.style.display = 'none';
    }
  }
  
  // 初期化関数
  function init() {
    initStyles();
    initTabIndex();
    setupEventListeners();
    handleSwipeHint();
    resetSwipeState();
  }
  
  // 初期化を実行
  init();

  // 継続記録フォーム関連の処理
  const noteTypeOptions = document.querySelectorAll('.note-type-option');
  const noteTypeInput = document.getElementById('note_type');
  
  noteTypeOptions.forEach(option => {
    option.addEventListener('click', function() {
      // 選択状態をリセット
      noteTypeOptions.forEach(opt => opt.classList.remove('active'));
      
      // クリックされた要素をアクティブに
      this.classList.add('active');
      
      // 隠しフィールドに値を設定
      noteTypeInput.value = this.getAttribute('data-value');
    });
  });
  
  // 重要度オプションの処理
  const importanceOptions = document.querySelectorAll('.importance-option');
  const importanceInput = document.getElementById('note_importance');
  
  importanceOptions.forEach(option => {
    option.addEventListener('click', function() {
      // 選択状態をリセット
      importanceOptions.forEach(opt => opt.classList.remove('active'));
      
      // クリックされた要素をアクティブに
      this.classList.add('active');
      
      // 隠しフィールドに値を設定
      importanceInput.value = this.getAttribute('data-value');
    });
  });

  // 継続記録削除関連の処理
  const deleteModal = document.getElementById('deleteNoteModal');
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
  const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
  let currentNoteId = null;
  
  // 削除ボタンのクリックイベント
  document.querySelectorAll('.delete-note-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      // 削除対象のノートIDを保存
      currentNoteId = this.getAttribute('data-note-id');
      
      // モーダルを表示
      deleteModal.classList.add('active');
    });
  });
  
  // キャンセルボタンのクリックイベント
  cancelDeleteBtn.addEventListener('click', function() {
    deleteModal.classList.remove('active');
    currentNoteId = null;
  });
  
  // 削除確認ボタンのクリックイベント
  confirmDeleteBtn.addEventListener('click', function() {
    if (!currentNoteId) return;
    
    // CSRFトークンを取得
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Ajax経由で削除リクエストを送信
    fetch(`/stockdiary/{{ diary.id }}/note/${currentNoteId}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('削除処理に失敗しました');
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // 成功時には該当の要素を削除
        const noteElement = document.getElementById(`note-${currentNoteId}`);
        if (noteElement) {
          noteElement.style.opacity = '0';
          noteElement.style.transform = 'translateY(-20px)';
          noteElement.style.transition = 'opacity 0.3s, transform 0.3s';
          
          setTimeout(() => {
            noteElement.remove();
            
            // 記録がなくなった場合のメッセージを表示
            const notesContainer = document.querySelector('.notes-container');
            if (notesContainer && notesContainer.children.length === 0) {
              notesContainer.innerHTML = `
                <div class="text-center py-4">
                  <i class="bi bi-journal-text text-muted" style="font-size: 2rem;"></i>
                  <p class="text-muted mt-2">継続的な記録はまだありません。</p>
                  <p class="text-muted">上のフォームから銘柄の状況変化や新たな分析を追加できます。</p>
                </div>
              `;
            }
          }, 300);
        }
        
        // 成功メッセージをトーストで表示
        const toast = createToast('継続記録が削除されました', 'success');
        document.body.appendChild(toast);
        new bootstrap.Toast(toast).show();
      } else {
        throw new Error(data.message || '削除処理に失敗しました');
      }
    })
    .catch(error => {
      // エラーメッセージをトーストで表示
      const toast = createToast(error.message, 'danger');
      document.body.appendChild(toast);
      new bootstrap.Toast(toast).show();
    })
    .finally(() => {
      // モーダルを閉じる
      deleteModal.classList.remove('active');
      currentNoteId = null;
    });
  });
  
  // モーダル外クリックで閉じる
  deleteModal.addEventListener('click', function(e) {
    if (e.target === deleteModal) {
      deleteModal.classList.remove('active');
      currentNoteId = null;
    }
  });
});
</script>

<script>
// モバイル向け拡大縮小ボタン（左下配置）のJavaScript実装
document.addEventListener('DOMContentLoaded', function() {
  // モバイル判定
  const isMobile = window.innerWidth < 768;
  
  if (isMobile) {
    // フローティング展開ボタンを追加（左下に配置）
    const expandButton = document.createElement('button');
    expandButton.className = 'floating-expand-button';
    expandButton.innerHTML = '<i class="bi bi-arrows-fullscreen"></i>';
    expandButton.setAttribute('aria-label', '全画面表示');
    document.body.appendChild(expandButton);
    
    // 全画面表示モード切り替え機能
    expandButton.addEventListener('click', function() {
      toggleFullscreenMode();
    });
    
    // タブ切り替え時の最適化
    const tabLinks = document.querySelectorAll('.nav-link');
    tabLinks.forEach(tab => {
      tab.addEventListener('click', function() {
        // タブ切り替え時にスクロール位置をリセット
        window.scrollTo(0, 0);
        
        // クリックしたタブがアクティブになるまで少し待つ
        setTimeout(() => {
          // タブに応じた最適化
          const tabId = this.getAttribute('data-bs-target');
          optimizeForTab(tabId);
        }, 50);
      });
    });
    
    // 全画面表示モード切り替え
    function toggleFullscreenMode() {
      document.body.classList.toggle('fullscreen-tab-mode');
      
      if (document.body.classList.contains('fullscreen-tab-mode')) {
        // フルスクリーンモード有効化
        
        // 戻るボタンを追加（左上に配置）
        if (!document.querySelector('.back-to-normal')) {
          const backButton = document.createElement('button');
          backButton.className = 'back-to-normal';
          backButton.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
          backButton.setAttribute('aria-label', '全画面表示終了');
          backButton.addEventListener('click', function(e) {
            toggleFullscreenMode();
            e.stopPropagation();
          });
          document.body.appendChild(backButton);
        }
        
        // フローティングボタンを非表示
        expandButton.style.display = 'none';
      } else {
        // フルスクリーンモード解除
        
        // 戻るボタンを削除
        const backButton = document.querySelector('.back-to-normal');
        if (backButton) {
          backButton.remove();
        }
        
        // フローティングボタンを表示
        expandButton.style.display = 'flex';
      }
    }
    
    // タブに合わせた最適化
    function optimizeForTab(tabId) {
      // タブフォーカスモードを有効化
      document.body.classList.add('mobile-tab-focus');
      
      // タブコンテンツ要素
      const tabContent = document.querySelector(tabId);
      
      if (tabId === '#basic-content') {
        // 基本情報タブの最適化
        // 特に何もしない
      } else if (tabId === '#notes-content') {
        // 継続記録タブの最適化
        // フォームをより見やすく
        const noteForm = tabContent.querySelector('.quick-note-form');
        if (noteForm) {
          noteForm.style.marginTop = '10px';
          noteForm.style.marginBottom = '20px';
        }
      } else if (tabId === '#timeline-content') {
        // タイムラインタブの最適化
        // 特に何もしない
      }
    }
    
    // スワイプダウンでフルスクリーンモード解除
    let startY = 0;
    let isScrolling = false;
    
    document.addEventListener('touchstart', function(e) {
      if (document.body.classList.contains('fullscreen-tab-mode')) {
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        
        // 画面上部でのみスワイプダウン検出を有効にする
        if (scrollTop <= 10) {
          startY = e.touches[0].clientY;
          isScrolling = true;
        }
      }
    });
    
    document.addEventListener('touchmove', function(e) {
      if (!isScrolling || !document.body.classList.contains('fullscreen-tab-mode')) return;
      
      const currentY = e.touches[0].clientY;
      const diffY = currentY - startY;
      
      // 下にスワイプしたときにフルスクリーンモードを解除
      if (diffY > 80) {
        toggleFullscreenMode();
        isScrolling = false;
        e.preventDefault();
      }
    });
    
    document.addEventListener('touchend', function() {
      isScrolling = false;
    });
  }
});
</script>
{% endblock %}