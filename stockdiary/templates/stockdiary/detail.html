{% extends 'base.html' %}
{% load stockdiary_filters %}
{% load static %}
{% load humanize %}

{% block title %}{{ diary.stock_name }} | カブログ{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/common.css' %}">
<link rel="stylesheet" href="{% static 'css/diary-theme.css' %}">
<link rel="stylesheet" href="{% static 'css/diary-detail.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
{% endblock %}

{% block content %}
<div class="px-1 py-1 diary-detail-container">
  <!-- 操作バー -->
  <div class="action-bar px-2">
    <a href="{% url 'stockdiary:home' %}" class="back-link">
      <i class="bi bi-arrow-left"></i>
      <span class="d-none d-sm-inline">日記一覧に戻る</span>
      <span class="d-sm-none">戻る</span>
    </a>
    
    <div class="desktop-actions">
      <a href="{% url 'stockdiary:update' diary.id %}" class="btn btn-warning btn-sm">
        <i class="bi bi-pencil"></i>
        <span class="d-none d-lg-inline ms-1">編集</span>
      </a>
      <a href="{% url 'stockdiary:delete' diary.id %}" class="btn btn-danger btn-sm">
        <i class="bi bi-trash"></i>
        <span class="d-none d-lg-inline ms-1">削除</span>
      </a>
    </div>
  </div>

  <!-- メインカード -->
  <div class="card border-0 shadow-sm mx-0">
    <!-- ヘッダー -->
    <div class="diary-header-improved mobile-optimized" data-stock-symbol="{{ diary.stock_symbol }}">
      <div class="header-main-info">
        <div class="stock-identity">
          <div class="stock-name-row">
            <h1 class="stock-title">{{ diary.stock_name }}</h1>
            {% if diary.stock_symbol %}
            <span class="stock-symbol-badge">{{ diary.stock_symbol }}</span>
            {% endif %}
          </div>
          
          <div class="header-meta-info">
            <div class="purchase-date">
              <i class="bi bi-calendar-check"></i>
              <span>
                {% if diary.first_purchase_date %}
                  {{ diary.first_purchase_date|date:"Y年m月d日" }}
                {% else %}
                  {{ diary.created_at|date:"Y年m月d日" }}（作成日）
                {% endif %}
              </span>
            </div>
            
            <div class="status-badges">
              {% if diary.is_memo %}
              <span class="status-badge-improved status-badge-memo">
                <i class="bi bi-sticky"></i>
                記録のみ
              </span>
              {% elif diary.is_sold_out %}
              <span class="status-badge-improved status-badge-sold">
                <i class="bi bi-check-circle"></i>
                売却済み
              </span>
              {% elif diary.is_holding %}
              <span class="status-badge-improved status-badge-active">
                <i class="bi bi-graph-up"></i>
                保有中
              </span>
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- 価格サマリー -->
        {% if not diary.is_memo and diary.average_purchase_price %}
        <div class="price-summary">
          <div class="main-price">{{ diary.average_purchase_price|floatformat:2|intcomma }}円</div>
          <div class="sub-info">平均取得単価</div>
          
          {% if diary.current_quantity > 0 %}
          <div class="sub-info mt-2">
            保有: {{ diary.current_quantity|floatformat:0 }}株
          </div>
          {% endif %}
          
          {% if diary.realized_profit != 0 %}
          <div class="profit-indicator {% if diary.realized_profit > 0 %}profit-positive{% elif diary.realized_profit < 0 %}profit-negative{% endif %}">
            {% if diary.realized_profit > 0 %}+{% endif %}{{ diary.realized_profit|floatformat:0|intcomma }}円
          </div>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>

    <!-- タブナビゲーション -->
    <div class="tabs-section mobile-optimized">
      <ul class="improved-tabs mobile-optimized" id="diaryDetailTabs" role="tablist">
        <li class="improved-tab-item" role="presentation">
          <button class="improved-tab-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic-content"
            type="button" role="tab" aria-controls="basic-content" aria-selected="true">
            <div class="tab-icon"><i class="bi bi-info-circle"></i></div>
            <div class="tab-label">基本情報</div>
          </button>
        </li>

        <li class="improved-tab-item" role="presentation">
          <button class="improved-tab-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions-content" 
            type="button" role="tab" aria-controls="transactions-content" aria-selected="false">
            <div class="tab-icon"><i class="bi bi-receipt"></i></div>
            <div class="tab-label">
              取引履歴
              {% if diary.transaction_count > 0 %}
              <span class="badge bg-primary bg-opacity-25 text-primary notes-count-badge">{{ diary.transaction_count }}</span>
              {% endif %}
            </div>
          </button>
        </li>

        <li class="improved-tab-item" role="presentation">
          <button class="improved-tab-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes-content" 
            type="button" role="tab" aria-controls="notes-content" aria-selected="false">
            <div class="tab-icon"><i class="bi bi-journal-richtext"></i></div>
            <div class="tab-label">
              継続記録
              {% if notes.count > 0 %}
              <span class="badge bg-primary bg-opacity-25 text-primary notes-count-badge">{{ notes.count }}</span>
              {% endif %}
            </div>
          </button>
        </li>

        <li class="improved-tab-item" role="presentation">
          <button class="improved-tab-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline-content"
            type="button" role="tab" aria-controls="timeline-content" aria-selected="false">
            <div class="tab-icon"><i class="bi bi-link-45deg"></i></div>
            <div class="tab-label">
              タイムライン
              {% if related_diaries %}
                <span class="badge bg-primary bg-opacity-25 text-primary notes-count-badge">{{ related_diaries.count }}</span>
              {% endif %}
            </div>
          </button>
        </li>
      </ul>

      <!-- タブコンテンツ -->
      <div class="tab-content tab-content-improved mobile-optimized" id="diaryDetailTabContent">
        <!-- 基本情報タブ -->
        <div class="tab-pane fade show active" id="basic-content" role="tabpanel" aria-labelledby="basic-tab">
          {% if diary.image_url %}
          <div class="diary-image-section mb-3">
            <div class="card border-0">
              <div class="card-body p-1">
                <div class="text-center">
                  <img src="{{ diary.image_url }}" 
                       class="img-fluid rounded diary-main-image" 
                       alt="{{ diary.stock_name }}の画像"
                       style="max-height: 300px; object-fit: contain; cursor: pointer; width: 100%;"
                       onclick="showImageModal('{{ diary.image_url }}', '{{ diary.stock_name }} - {{ diary.first_purchase_date|date:"Y年m月d日" }}')">
                  <div class="mt-2">
                    <small class="text-muted">
                      <i class="bi bi-image me-1"></i>
                      クリックで拡大表示
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          <div class="info-grid mobile-optimized">
            <!-- 投資理由/メモ -->
            <div class="info-card mobile-optimized">
              <div class="info-card-title">
                <i class="bi bi-journal-text"></i>
                {% if diary.is_memo %}
                メモ内容
                {% else %}
                投資理由
                {% endif %}
              </div>
              <div class="reason-content mobile-optimized">
                {{ diary.reason|safe|linebreaks }}
              </div>
            </div>

            <!-- 取引サマリー -->
            {% if not diary.is_memo %}
            <div class="info-card mobile-optimized">
              <div class="info-card-title">
                <i class="bi bi-graph-up"></i>
                取引サマリー
              </div>
              <div class="info-items mobile-optimized">
                <div class="info-item-improved mobile-optimized">
                  <div class="info-icon-improved">
                    <i class="bi bi-calendar-date"></i>
                  </div>
                  <div class="info-content-improved">
                    <div class="info-label-improved">最初の購入日</div>
                    <div class="info-value-improved">{{ diary.first_purchase_date|date:"Y年m月d日" }}</div>
                  </div>
                </div>

                <div class="info-item-improved mobile-optimized">
                  <div class="info-icon-improved">
                    <i class="bi bi-currency-yen"></i>
                  </div>
                  <div class="info-content-improved">
                    <div class="info-label-improved">平均取得単価</div>
                    <div class="info-value-improved">{{ diary.average_purchase_price|floatformat:2|intcomma }}円</div>
                  </div>
                </div>

                <div class="info-item-improved mobile-optimized">
                  <div class="info-icon-improved">
                    <i class="bi bi-graph-up"></i>
                  </div>
                  <div class="info-content-improved">
                    <div class="info-label-improved">現在保有数</div>
                    <div class="info-value-improved">{{ diary.current_quantity|floatformat:0 }}株</div>
                  </div>
                </div>

                <div class="info-item-improved mobile-optimized">
                  <div class="info-icon-improved">
                    <i class="bi bi-cash-stack"></i>
                  </div>
                  <div class="info-content-improved">
                    <div class="info-label-improved">総取得原価</div>
                    <div class="info-value-improved">{{ diary.total_cost|floatformat:0|intcomma }}円</div>
                  </div>
                </div>

                {% if diary.realized_profit != 0 %}
                <div class="info-item-improved mobile-optimized">
                  <div class="info-icon-improved">
                    <i class="bi bi-piggy-bank"></i>
                  </div>
                  <div class="info-content-improved">
                    <div class="info-label-improved">実現損益</div>
                    <div class="info-value-improved {% if diary.realized_profit > 0 %}text-success{% else %}text-danger{% endif %}">
                      {% if diary.realized_profit > 0 %}+{% endif %}{{ diary.realized_profit|floatformat:0|intcomma }}円
                    </div>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}
          </div>

          <!-- 分析テンプレート情報 -->
          {% include 'stockdiary/partials/analysis_template_info.html' %}

          <!-- タグとメモ -->
          <div class="info-grid mobile-optimized">
            <div class="info-card mobile-optimized">
              <div class="info-card-title">
                <i class="bi bi-tags"></i>
                タグ
              </div>
              {% for tag in diary.tags.all %}
              <span class="badge bg-primary bg-opacity-10 text-primary me-1 mb-1">{{ tag.name }}</span>
              {% empty %}
              <p class="text-muted mb-0">タグはありません</p>
              {% endfor %}
            </div>

            <div class="info-card mobile-optimized">
              <div class="info-card-title">
                <i class="bi bi-sticky"></i>
                メモ
              </div>
              {% if diary.memo %}
              <div class="memo-content">{{ diary.memo|linebreaks }}</div>
              {% else %}
              <p class="text-muted mb-0">メモはありません</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- 取引履歴タブ -->
        <div class="tab-pane fade" id="transactions-content" role="tabpanel" aria-labelledby="transactions-tab">
          {% include 'stockdiary/partials/tab_transactions.html' %}
        </div>

        <!-- 継続記録タブ -->
        <div class="tab-pane fade" id="notes-content" role="tabpanel" aria-labelledby="notes-tab">
          <!-- 継続記録フォームと一覧（既存コード） -->
          {% include 'stockdiary/partials/tab_notes.html' %}
        </div>

        <!-- タイムラインタブ -->
        <div class="tab-pane fade" id="timeline-content" role="tabpanel" aria-labelledby="timeline-tab">
          {% if related_diaries %}
          <div class="timeline-section mobile-optimized">
            <h3 class="section-title mb-3">
              <i class="bi bi-clock-history"></i>
              {{ diary.stock_symbol }} の投資履歴
            </h3>
            
            <ol class="timeline-list mobile-optimized">
              {% for timeline_diary in timeline_diaries %}
              <li class="timeline-item mobile-optimized 
                {% if timeline_diary.sell_date %}sold
                {% elif timeline_diary.is_memo or timeline_diary.purchase_price is None or timeline_diary.purchase_quantity is None %}memo
                {% else %}active{% endif %}
                {% if timeline_diary.id == diary.id %}current{% endif %}">
                
                <div class="timeline-date mb-2">
                  {{ timeline_diary.purchase_date|date:"Y年m月d日" }}
                  {% if timeline_diary.id == diary.id %}
                  <span class="badge bg-warning ms-2">現在表示中</span>
                  {% endif %}
                </div>

                {% if timeline_diary.id == diary.id %}
                <!-- 現在表示中の日記 -->
                <div class="timeline-card current mobile-optimized">
                  <div class="timeline-card-header">
                    <div class="timeline-stock-info">
                      <h6>{{ timeline_diary.stock_name }}</h6>
                    </div>
                    <div class="timeline-badges">
                      {% if timeline_diary.sell_date %}
                      <span class="badge bg-danger">売却済み</span>
                      {% elif timeline_diary.is_memo or timeline_diary.purchase_price is None or timeline_diary.purchase_quantity is None %}
                      <span class="badge bg-info">メモ</span>
                      {% else %}
                      <span class="badge bg-success">保有中</span>
                      {% endif %}
                    </div>
                  </div>

                  {% if not timeline_diary.is_memo and timeline_diary.purchase_price is not None and timeline_diary.purchase_quantity is not None %}
                  <div class="timeline-price-info">
                    {{ timeline_diary.purchase_price|floatformat:2|intcomma }}円 × {{ timeline_diary.purchase_quantity }}株
                    {% if timeline_diary.sell_date %}
                    {% with profit=timeline_diary.sell_price|sub:timeline_diary.purchase_price|div:timeline_diary.purchase_price|mul:100 %}
                    <span class="{% if profit > 0 %}text-success{% elif profit < 0 %}text-danger{% endif %}">
                      ({% if profit > 0 %}+{% endif %}{{ profit|floatformat:2 }}%)
                    </span>
                    {% endwith %}
                    {% endif %}
                  </div>
                  {% endif %}

                  <div class="timeline-content">
                    {{ timeline_diary.reason|linebreaks|safe|truncatewords_html:30 }}
                  </div>
                </div>
                {% else %}
                <!-- その他の関連日記 -->
                <a href="{% url 'stockdiary:detail' timeline_diary.id %}" class="timeline-card mobile-optimized">
                  <div class="timeline-card-header">
                    <div class="timeline-stock-info">
                      <h6>{{ timeline_diary.stock_name }}</h6>
                    </div>
                    <div class="timeline-badges">
                      {% if timeline_diary.sell_date %}
                      <span class="badge bg-danger">売却済み</span>
                      {% elif timeline_diary.is_memo or timeline_diary.purchase_price is None or timeline_diary.purchase_quantity is None %}
                      <span class="badge bg-info">メモ</span>
                      {% else %}
                      <span class="badge bg-success">保有中</span>
                      {% endif %}
                    </div>
                  </div>

                  {% if not timeline_diary.is_memo and timeline_diary.purchase_price is not None and timeline_diary.purchase_quantity is not None %}
                  <div class="timeline-price-info">
                    {{ timeline_diary.purchase_price|floatformat:2|intcomma }}円 × {{ timeline_diary.purchase_quantity }}株
                    {% if timeline_diary.sell_date %}
                    {% with profit=timeline_diary.sell_price|sub:timeline_diary.purchase_price|div:timeline_diary.purchase_price|mul:100 %}
                    <span class="{% if profit > 0 %}text-success{% elif profit < 0 %}text-danger{% endif %}">
                      ({% if profit > 0 %}+{% endif %}{{ profit|floatformat:2 }}%)
                    </span>
                    {% endwith %}
                    {% endif %}
                  </div>
                  {% endif %}

                  <div class="timeline-content">
                    {{ timeline_diary.reason|linebreaks|safe|truncatewords_html:20 }}
                  </div>

                  {% if timeline_diary.tags.exists %}
                  <div class="timeline-tags mt-2">
                    {% for tag in timeline_diary.tags.all|slice:":3" %}
                    <span class="badge bg-light text-dark me-1">{{ tag.name }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </a>
                {% endif %}
              </li>
              {% endfor %}
            </ol>

            {% if related_diaries_count > 10 %}
            <div class="text-center mt-3">
              <a href="{% url 'stockdiary:home' %}?query={{ diary.stock_symbol }}"
                class="btn btn-outline-primary">
                すべての記録を表示 (全{{ total_related_count }}件)
              </a>
            </div>
            {% endif %}

            {% if current_diary_index is not None %}
            <div class="text-center text-muted mt-3 small">
              <span>{{ current_diary_index|add:1 }}</span> / <span>{{ total_related_count }}</span> 件目
            </div>
            {% endif %}
          </div> <!-- ここに追加: timeline-section の終了タグ -->
          {% else %}
          <div class="empty-state">
            <div class="empty-icon">
              <i class="bi bi-link-45deg"></i>
            </div>
            <h4>関連する投資記録はありません</h4>
            <p>この銘柄の他の投資記録が作成されると、ここに表示されます。</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{% include 'speed_dial.html' with actions=diary_actions %}
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="{% static 'js/diary-detail.js' %}"></script>
<script src="{% static 'js/diary-detail-tabs.js' %}"></script>
{% endblock %}