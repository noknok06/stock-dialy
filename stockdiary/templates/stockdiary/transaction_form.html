{% extends 'base.html' %}
{% load static %}

{% block title %}{% if is_edit %}取引の編集{% else %}取引を追加{% endif %} | カブログ{% endblock %}

{% block head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/diary-theme.css' %}">
<style>
  .current-position {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  }
  
  .position-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }
  
  .stat-item {
    text-align: center;
  }
  
  .stat-label {
    font-size: 0.875rem;
    opacity: 0.9;
    margin-bottom: 0.25rem;
  }
  
  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
  }
  
  .transaction-type-selector {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .type-option {
    flex: 1;
    padding: 1rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s ease;
  }
  
  .type-option:hover {
    border-color: #667eea;
    background-color: #f8f9ff;
  }
  
  .type-option.selected {
    border-color: #667eea;
    background-color: #667eea;
    color: white;
  }
  
  .type-option input[type="radio"] {
    display: none;
  }
  
  .type-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="title_header">
    <h1 class="page-title">
      <i class="bi bi-cash-coin"></i> 
      {% if is_edit %}取引の編集{% else %}取引を追加{% endif %}
    </h1>
  </div>

  <!-- 現在のポジションサマリー -->
  <div class="current-position">
    <h5 class="mb-0">
      {{ diary.stock_name }} 
      {% if diary.stock_symbol %}
        <span class="badge bg-light text-dark ms-2">{{ diary.stock_symbol }}</span>
      {% endif %}
    </h5>
    
    <div class="position-stats">
      <div class="stat-item">
        <div class="stat-label">現在保有</div>
        <div class="stat-value">{{ summary.current_quantity }}株</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">平均単価</div>
        <div class="stat-value">{{ summary.average_purchase_price|floatformat:0 }}円</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">取引回数</div>
        <div class="stat-value">{{ summary.transaction_count }}回</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">実現損益</div>
        <div class="stat-value {% if summary.realized_profit > 0 %}text-success{% elif summary.realized_profit < 0 %}text-danger{% endif %}">
          {% if summary.realized_profit > 0 %}+{% endif %}
          {{ summary.realized_profit|floatformat:0 }}円
        </div>
      </div>
    </div>
  </div>

  <!-- フォーム -->
  <div class="card border-0 shadow-sm">
    <div class="card-body p-4">
      <form method="post">
        {% csrf_token %}

        <!-- 取引種別選択 -->
        <div class="transaction-type-selector">
          <label class="type-option {% if not is_edit or form.transaction_type.value == 'buy' %}selected{% endif %}" id="type-buy">
            <input type="radio" name="transaction_type" value="buy" 
                   {% if not is_edit or form.transaction_type.value == 'buy' %}checked{% endif %}>
            <div class="type-icon">
              <i class="bi bi-arrow-down-circle"></i>
            </div>
            <div>購入</div>
          </label>
          
          <label class="type-option {% if is_edit and form.transaction_type.value == 'sell' %}selected{% endif %}" id="type-sell">
            <input type="radio" name="transaction_type" value="sell"
                   {% if is_edit and form.transaction_type.value == 'sell' %}checked{% endif %}>
            <div class="type-icon">
              <i class="bi bi-arrow-up-circle"></i>
            </div>
            <div>売却</div>
          </label>
        </div>

        {% if form.transaction_type.errors %}
        <div class="alert alert-danger">{{ form.transaction_type.errors }}</div>
        {% endif %}

        <!-- 取引日 -->
        <div class="mb-3">
          <label for="{{ form.date.id_for_label }}" class="form-label">
            取引日 <span class="text-danger">*</span>
          </label>
          {{ form.date }}
          {% if form.date.errors %}
          <div class="text-danger">{{ form.date.errors }}</div>
          {% endif %}
        </div>

        <!-- 単価 -->
        <div class="mb-3">
          <label for="{{ form.price.id_for_label }}" class="form-label">
            単価（円） <span class="text-danger">*</span>
          </label>
          <div class="input-group">
            {{ form.price }}
            <button type="button" class="btn btn-outline-primary" id="fetch-current-price">
              <i class="bi bi-arrow-repeat"></i> 現在株価
            </button>
          </div>
          {% if form.price.errors %}
          <div class="text-danger">{{ form.price.errors }}</div>
          {% endif %}
        </div>

        <!-- 数量 -->
        <div class="mb-3">
          <label for="{{ form.quantity.id_for_label }}" class="form-label">
            数量（株） <span class="text-danger">*</span>
          </label>
          {{ form.quantity }}
          <small class="form-text text-muted" id="quantity-help">
            購入の場合: 追加購入する株数を入力
          </small>
          {% if form.quantity.errors %}
          <div class="text-danger">{{ form.quantity.errors }}</div>
          {% endif %}
        </div>

        <!-- メモ -->
        <div class="mb-3">
          <label for="{{ form.note.id_for_label }}" class="form-label">
            メモ
          </label>
          {{ form.note }}
          {% if form.note.errors %}
          <div class="text-danger">{{ form.note.errors }}</div>
          {% endif %}
        </div>

        <!-- フォームエラー -->
        {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {{ form.non_field_errors }}
        </div>
        {% endif %}

        <!-- ボタン -->
        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-primary flex-fill">
            <i class="bi bi-check-lg"></i> 
            {% if is_edit %}更新する{% else %}記録する{% endif %}
          </button>
          <a href="{% url 'stockdiary:detail' diary.id %}" class="btn btn-secondary">
            <i class="bi bi-x-lg"></i> キャンセル
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const diary = {{ diary.id }};
  const stockSymbol = '{{ diary.stock_symbol }}';
  const currentQuantity = {{ summary.current_quantity }};
  
  // 取引種別選択
  const typeOptions = document.querySelectorAll('.type-option');
  const quantityHelp = document.getElementById('quantity-help');
  
  typeOptions.forEach(option => {
    option.addEventListener('click', function() {
      typeOptions.forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');
      
      const selectedType = this.querySelector('input').value;
      if (selectedType === 'sell') {
        quantityHelp.textContent = `売却の場合: 現在保有している${currentQuantity}株まで売却可能`;
      } else {
        quantityHelp.textContent = '購入の場合: 追加購入する株数を入力';
      }
    });
  });
  
  // 現在株価取得
  const fetchPriceBtn = document.getElementById('fetch-current-price');
  const priceInput = document.getElementById('{{ form.price.id_for_label }}');
  
  if (fetchPriceBtn && stockSymbol) {
    fetchPriceBtn.addEventListener('click', function() {
      this.disabled = true;
      this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 取得中...';
      
      fetch(`/stockdiary/api/stock/price/${stockSymbol}/`)
        .then(response => response.json())
        .then(data => {
          priceInput.value = data.price;
          alert('現在株価を取得しました');
        })
        .catch(error => {
          console.error('Error:', error);
          alert('株価の取得に失敗しました');
        })
        .finally(() => {
          this.disabled = false;
          this.innerHTML = '<i class="bi bi-arrow-repeat"></i> 現在株価';
        });
    });
  }
});
</script>
{% endblock %}