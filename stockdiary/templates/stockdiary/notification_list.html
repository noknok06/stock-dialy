{% extends 'base.html' %}
{% load static %}

{% block title %}é€šçŸ¥ç®¡ç† | ã‚«ãƒ–ãƒ­ã‚°{% endblock %}

{% block content %}
<div class="container py-4">

    <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="page-header">
        <h1 class="page-title">
            <i class="bi bi-bell"></i>
            <span>é€šçŸ¥ç®¡ç†</span>
        </h1>
    </div>

    <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <a href="{% url 'stockdiary:home' %}" class="btn btn-outline-secondary mb-4">
        <i class="bi bi-arrow-left me-1"></i>
        æˆ»ã‚‹
    </a>

    <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
    <div class="row mb-4">
        <div class="col-md-6 col-12 mb-3">
            <div class="card text-center">
            <div class="card-body">
                <h3 class="mb-0" id="total-count">-</h3>
                <small class="text-muted">ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</small>
            </div>
            </div>
        </div>
        <div class="col-md-6 col-12 mb-3">
            <div class="card text-center">
            <div class="card-body">
                <h3 class="mb-0 text-success" id="active-count">-</h3>
                <small class="text-muted">æœ‰åŠ¹</small>
            </div>
            </div>
        </div>
        </div>
    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                    <select class="form-select" id="filter-status">
                        <option value="active">æœ‰åŠ¹</option>
                        <option value="all">ã™ã¹ã¦</option>
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="applyFilters()">
                        <i class="bi bi-funnel me-1"></i>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥ä¸€è¦§ -->
    <div class="card">
        <div class="card-body">
            <div id="notifications-container">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadAllNotifications();
    });

    async function loadAllNotifications() {
        try {
            const response = await fetch('/stockdiary/api/notifications/all/');
            const data = await response.json();

            if (data.notifications) {
                renderAllNotifications(data.notifications);
                updateStats(data.notifications);
            }
        } catch (error) {
            console.error('é€šçŸ¥èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('notifications-container').innerHTML = `
                <div class="alert alert-danger">
                    é€šçŸ¥ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ
                </div>`;
        }
    }

    function updateStats(notifications) {
        document.getElementById('total-count').textContent = notifications.length;
        document.getElementById('active-count').textContent = 
            notifications.filter(n => n.is_active).length;
    }


    function renderAllNotifications(notifications) {
        const container = document.getElementById('notifications-container');

        if (notifications.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-bell-slash" style="font-size: 3rem;"></i>
                    <p class="mt-3">é€šçŸ¥è¨­å®šã¯ã‚ã‚Šã¾ã›ã‚“</p>
                </div>`;
            return;
        }

        const grouped = notifications.reduce((acc, notification) => {
            const diaryKey = notification.diary_id;
            if (!acc[diaryKey]) {
                acc[diaryKey] = {
                    diary_name: notification.diary_name,
                    diary_id: notification.diary_id,
                    notifications: []
                };
            }
            acc[diaryKey].notifications.push(notification);
            return acc;
        }, {});

        container.innerHTML = Object.values(grouped).map(group => `
            <div class="notification-group mb-4">
                <h5 class="border-bottom pb-2">
                    <a href="/stockdiary/${group.diary_id}/" class="text-decoration-none">
                        ${group.diary_name}
                    </a>
                    <span class="badge bg-secondary ms-2">${group.notifications.length}ä»¶</span>
                </h5>
                ${group.notifications.map(n => renderNotificationItem(n)).join('')}
            </div>
        `).join('');
    }

    function renderNotificationItem(notification) {
        const typeInfo = getNotificationTypeInfo(notification.type);

        return `
            <div class="card mb-2" data-notification-id="${notification.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <span class="badge ${typeInfo.badgeClass} me-2">
                                <i class="${typeInfo.icon} me-1"></i>${typeInfo.label}
                            </span>
                            ${getNotificationDetails(notification)}
                        </div>
                        <button class="btn-icon btn-danger-icon" 
                                onclick="deleteNotificationFromList('${notification.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>`;
    }

    function getNotificationTypeInfo(type) {
        return {
            label: 'ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼',
            icon: 'bi-alarm',
            badgeClass: 'bg-info'
        };
    }

    function getNotificationDetails(notification) {
        if (notification.type === 'reminder') {
            return `<div class="mt-1">ğŸ“… ${new Date(notification.remind_at).toLocaleString('ja-JP')}</div>`;
        } else if (notification.type === 'price_alert') {
            return `<div class="mt-1">ğŸ’° ${notification.target_price}å††${notification.alert_above ? 'ä»¥ä¸Š' : 'ä»¥ä¸‹'}</div>`;
        } else if (notification.type === 'periodic') {
            const freq = { 'daily': 'æ¯æ—¥', 'weekly': 'æ¯é€±', 'monthly': 'æ¯æœˆ' }[notification.frequency];
            return `<div class="mt-1">ğŸ”„ ${freq}</div>`;
        }
        return '';
    }

    async function deleteNotificationFromList(notificationId) {
        if (!confirm('ã“ã®é€šçŸ¥è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

        try {
            const csrfToken = getCookie('csrftoken');
            if (!csrfToken) {
                showToastOrAlert('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'danger');
                return;
            }

            const response = await fetch(`/stockdiary/api/notifications/${notificationId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            });

            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const responseText = await response.text();
                console.error('âŒ JSONã§ã¯ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', responseText.substring(0, 200));

                if (response.status === 403) {
                    showToastOrAlert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'danger');
                } else if (response.status === 404) {
                    showToastOrAlert('é€šçŸ¥ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'warning');
                    loadAllNotifications();
                } else {
                    showToastOrAlert('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'danger');
                }
                return;
            }

            const data = await response.json();
            if (response.ok && data.success) {
                showToastOrAlert('é€šçŸ¥è¨­å®šã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                loadAllNotifications();
            } else {
                showToastOrAlert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'danger');
            }
        } catch (error) {
            console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
            showToastOrAlert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
        }
    }

    function showToastOrAlert(message, type) {
        if (typeof showToast === 'function') {
            showToast(message, type);
        } else {
            alert(message);
        }
    }

    // ä»–ã®å‰Šé™¤é–¢æ•°ã‚„ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚‚çœç•¥ã›ãšç¶­æŒ
    window.deleteNotificationFromList = deleteNotificationFromList;
    window.loadAllNotifications = loadAllNotifications;
</script>
{% endblock %}
