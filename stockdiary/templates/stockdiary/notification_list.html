{% extends 'base.html' %}
{% load static %}

{% block title %}通知管理 | カブログ{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
      <i class="bi bi-bell"></i>
      通知管理
    </h2>
    <a href="{% url 'stockdiary:home' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>
      戻る
    </a>
  </div>

  <!-- 統計サマリー -->
  <div class="row mb-4">
    <div class="col-md-3 col-6 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="mb-0" id="total-count">-</h3>
          <small class="text-muted">全通知</small>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="mb-0 text-info" id="reminder-count">-</h3>
          <small class="text-muted">リマインダー</small>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="mb-0 text-warning" id="price-alert-count">-</h3>
          <small class="text-muted">価格アラート</small>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="mb-0 text-success" id="periodic-count">-</h3>
          <small class="text-muted">定期通知</small>
        </div>
      </div>
    </div>
  </div>

  <!-- フィルター -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">通知タイプ</label>
          <select class="form-select" id="filter-type">
            <option value="">すべて</option>
            <option value="reminder">リマインダー</option>
            <option value="price_alert">価格アラート</option>
            <option value="periodic">定期通知</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">ステータス</label>
          <select class="form-select" id="filter-status">
            <option value="active">有効</option>
            <option value="all">すべて</option>
          </select>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button class="btn btn-primary w-100" onclick="applyFilters()">
            <i class="bi bi-funnel me-1"></i>
            フィルター適用
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 通知一覧 -->
  <div class="card">
    <div class="card-body">
      <div id="notifications-container">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">読み込み中...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'js/cookie.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadAllNotifications();
});

async function loadAllNotifications() {
    try {
        // すべての日記の通知を取得
        const response = await fetch('/stockdiary/api/notifications/all/');
        const data = await response.json();
        
        if (data.notifications) {
            renderAllNotifications(data.notifications);
            updateStats(data.notifications);
        }
    } catch (error) {
        console.error('通知読み込みエラー:', error);
        document.getElementById('notifications-container').innerHTML = `
            <div class="alert alert-danger">
                通知の読み込みに失敗しました
            </div>
        `;
    }
}

function updateStats(notifications) {
    document.getElementById('total-count').textContent = notifications.length;
    document.getElementById('reminder-count').textContent = 
        notifications.filter(n => n.type === 'reminder').length;
    document.getElementById('price-alert-count').textContent = 
        notifications.filter(n => n.type === 'price_alert').length;
    document.getElementById('periodic-count').textContent = 
        notifications.filter(n => n.type === 'periodic').length;
}

function renderAllNotifications(notifications) {
    const container = document.getElementById('notifications-container');
    
    if (notifications.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="bi bi-bell-slash" style="font-size: 3rem;"></i>
                <p class="mt-3">通知設定はありません</p>
            </div>
        `;
        return;
    }
    
    // 銘柄ごとにグループ化
    const grouped = notifications.reduce((acc, notification) => {
        const diaryKey = notification.diary_id;
        if (!acc[diaryKey]) {
            acc[diaryKey] = {
                diary_name: notification.diary_name,
                diary_id: notification.diary_id,
                notifications: []
            };
        }
        acc[diaryKey].notifications.push(notification);
        return acc;
    }, {});
    
    container.innerHTML = Object.values(grouped).map(group => `
        <div class="notification-group mb-4">
            <h5 class="border-bottom pb-2">
                <a href="/stockdiary/${group.diary_id}/" class="text-decoration-none">
                    ${group.diary_name}
                </a>
                <span class="badge bg-secondary ms-2">${group.notifications.length}件</span>
            </h5>
            ${group.notifications.map(n => renderNotificationItem(n)).join('')}
        </div>
    `).join('');
}

function renderNotificationItem(notification) {
    const typeInfo = getNotificationTypeInfo(notification.type);
    
    return `
        <div class="card mb-2" data-notification-id="${notification.id}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <span class="badge ${typeInfo.badgeClass} me-2">
                            <i class="${typeInfo.icon} me-1"></i>
                            ${typeInfo.label}
                        </span>
                        ${getNotificationDetails(notification)}
                    </div>
                    <button class="btn btn-sm btn-outline-danger" 
                            onclick="deleteNotificationFromList('${notification.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

function getNotificationTypeInfo(type) {
    const types = {
        'reminder': { label: 'リマインダー', icon: 'bi-alarm', badgeClass: 'bg-info' },
        'price_alert': { label: '価格アラート', icon: 'bi-graph-up-arrow', badgeClass: 'bg-warning' },
        'periodic': { label: '定期通知', icon: 'bi-arrow-repeat', badgeClass: 'bg-success' }
    };
    return types[type] || types['reminder'];
}

function getNotificationDetails(notification) {
    if (notification.type === 'reminder') {
        return `<div class="mt-1">📅 ${new Date(notification.remind_at).toLocaleString('ja-JP')}</div>`;
    } else if (notification.type === 'price_alert') {
        return `<div class="mt-1">💰 ${notification.target_price}円${notification.alert_above ? '以上' : '以下'}</div>`;
    } else if (notification.type === 'periodic') {
        const freq = { 'daily': '毎日', 'weekly': '毎週', 'monthly': '毎月' }[notification.frequency];
        return `<div class="mt-1">🔄 ${freq}</div>`;
    }
    return '';
}

async function deleteNotificationFromList(notificationId) {
    if (!confirm('この通知設定を削除しますか？')) return;
    
    try {
        const response = await fetch(`/stockdiary/api/notifications/${notificationId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (response.ok) {
            showToast('通知を削除しました', 'success');
            loadAllNotifications();
        }
    } catch (error) {
        showToast('削除に失敗しました', 'danger');
    }
}

</script>
{% endblock %}