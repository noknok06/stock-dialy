{% extends 'base.html' %}
{% load static %}

{% block title %}通知管理 | カブログ{% endblock %}

{% block content %}
<div class="container py-4">

    <!-- ページヘッダー -->
    <div class="page-header">
        <h1 class="page-title">
            <i class="bi bi-bell"></i>
            <span>通知管理</span>
        </h1>
    </div>

    <!-- 戻るボタン -->
    <a href="{% url 'stockdiary:home' %}" class="btn btn-outline-secondary mb-4">
        <i class="bi bi-arrow-left me-1"></i>
        戻る
    </a>

    <!-- 統計サマリー（横並び - スマホでも維持） -->
    <div class="row mb-4 g-2">
        <div class="col-4">
            <div class="card text-center">
                <div class="card-body py-2 px-1">
                    <h4 class="mb-0 fs-5" id="total-count">-</h4>
                    <small class="text-muted d-block" style="font-size: 0.75rem;">全体</small>
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="card text-center border-warning">
                <div class="card-body py-2 px-1">
                    <h4 class="mb-0 text-warning fs-5" id="pending-count">-</h4>
                    <small class="text-muted d-block" style="font-size: 0.75rem;">未送信</small>
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="card text-center border-success">
                <div class="card-body py-2 px-1">
                    <h4 class="mb-0 text-success fs-5" id="sent-count">-</h4>
                    <small class="text-muted d-block" style="font-size: 0.75rem;">送信済み</small>
                </div>
            </div>
        </div>
    </div>

    <!-- フィルター -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">
                        <i class="bi bi-funnel me-1"></i>
                        ステータス
                    </label>
                    <select class="form-select" id="filter-status">
                        <option value="pending">未送信</option>
                        <option value="sent">送信済み</option>
                        <option value="all">すべて</option>
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="applyFilters()">
                        <i class="bi bi-funnel me-1"></i>フィルター適用
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知一覧 -->
    <div class="card">
        <div class="card-body">
            <div id="notifications-container">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">読み込み中...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

{% include 'speed_dial.html' with actions=page_actions %}
<!-- JavaScript -->
<script>
    let allNotifications = [];
    
    document.addEventListener('DOMContentLoaded', function () {
        loadAllNotifications();
    });

    async function loadAllNotifications() {
        try {
            const response = await fetch('/stockdiary/api/notifications/all/');
            const data = await response.json();

            if (data.notifications) {
                allNotifications = data.notifications;
                applyFilters();
            }
        } catch (error) {
            console.error('通知読み込みエラー:', error);
            document.getElementById('notifications-container').innerHTML = `
                <div class="alert alert-danger">
                    通知の読み込みに失敗しました
                </div>`;
        }
    }

    function applyFilters() {
        const statusFilter = document.getElementById('filter-status').value;
        const now = new Date();
        
        // フィルタリング
        let filteredNotifications = allNotifications.filter(notification => {
            const remindAt = new Date(notification.remind_at);
            const isPending = remindAt > now;
            const isSent = notification.last_sent || remindAt <= now;
            
            if (statusFilter === 'pending') {
                return isPending && notification.is_active;
            } else if (statusFilter === 'sent') {
                return isSent;
            } else {
                return true; // すべて
            }
        });
        
        updateStats(allNotifications);
        renderAllNotifications(filteredNotifications);
    }

    function updateStats(notifications) {
        const now = new Date();
        
        const totalCount = notifications.length;
        
        // 未送信: 送信予定日時が未来 かつ 有効
        const pendingCount = notifications.filter(n => {
            const remindAt = new Date(n.remind_at);
            return remindAt > now && n.is_active;
        }).length;
        
        // 送信済み: last_sentがある または 送信予定日時が過去
        const sentCount = notifications.filter(n => {
            const remindAt = new Date(n.remind_at);
            return n.last_sent || remindAt <= now;
        }).length;
        
        document.getElementById('total-count').textContent = totalCount;
        document.getElementById('pending-count').textContent = pendingCount;
        document.getElementById('sent-count').textContent = sentCount;
    }

    function renderAllNotifications(notifications) {
        const container = document.getElementById('notifications-container');

        if (notifications.length === 0) {
            const statusFilter = document.getElementById('filter-status').value;
            let message = '通知設定はありません';
            if (statusFilter === 'pending') {
                message = '未送信の通知はありません';
            } else if (statusFilter === 'sent') {
                message = '送信済みの通知はありません';
            }
            
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-bell-slash" style="font-size: 3rem;"></i>
                    <p class="mt-3">${message}</p>
                </div>`;
            return;
        }

        const grouped = notifications.reduce((acc, notification) => {
            const diaryKey = notification.diary_id;
            if (!acc[diaryKey]) {
                acc[diaryKey] = {
                    diary_name: notification.diary_name,
                    diary_id: notification.diary_id,
                    notifications: []
                };
            }
            acc[diaryKey].notifications.push(notification);
            return acc;
        }, {});

        container.innerHTML = Object.values(grouped).map(group => `
            <div class="notification-group mb-4">
                <h5 class="border-bottom pb-2">
                    <a href="/stockdiary/${group.diary_id}/" class="text-decoration-none">
                        ${group.diary_name}
                    </a>
                    <span class="badge bg-secondary ms-2">${group.notifications.length}件</span>
                </h5>
                ${group.notifications.map(n => renderNotificationItem(n)).join('')}
            </div>
        `).join('');
    }

    function renderNotificationItem(notification) {
        const typeInfo = getNotificationTypeInfo(notification.type);
        const now = new Date();
        const remindAt = new Date(notification.remind_at);
        const isPending = remindAt > now && notification.is_active;
        const statusBadge = isPending 
            ? '<span class="badge bg-warning text-dark ms-2"><i class="bi bi-clock me-1"></i>未送信</span>'
            : '<span class="badge bg-success ms-2"><i class="bi bi-check-circle me-1"></i>送信済み</span>';

        return `
            <div class="card mb-2" data-notification-id="${notification.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="mb-2">
                                <span class="badge ${typeInfo.badgeClass} me-2">
                                    <i class="${typeInfo.icon} me-1"></i>${typeInfo.label}
                                </span>
                                ${statusBadge}
                            </div>
                            ${getNotificationDetails(notification)}
                            ${notification.message ? `<div class="mt-2 text-muted small"><i class="bi bi-chat-quote me-1"></i>${notification.message}</div>` : ''}
                        </div>
                        <button class="btn-icon btn-danger-icon" 
                                onclick="deleteNotificationFromList('${notification.id}')"
                                title="削除">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>`;
    }

    function getNotificationTypeInfo(type) {
        return {
            label: 'リマインダー',
            icon: 'bi-alarm',
            badgeClass: 'bg-info'
        };
    }

    function getNotificationDetails(notification) {
        const remindAt = new Date(notification.remind_at);
        const dateStr = remindAt.toLocaleString('ja-JP', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        let details = `<div class="mt-1"><i class="bi bi-calendar-event me-1"></i>${dateStr}</div>`;
        
        if (notification.last_sent) {
            const lastSent = new Date(notification.last_sent);
            const lastSentStr = lastSent.toLocaleString('ja-JP', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            details += `<div class="mt-1 text-success small"><i class="bi bi-send-check me-1"></i>送信: ${lastSentStr}</div>`;
        }
        
        return details;
    }

    async function deleteNotificationFromList(notificationId) {
        if (!confirm('この通知設定を削除しますか？')) return;

        try {
            const csrfToken = getCookie('csrftoken');
            if (!csrfToken) {
                showToastOrAlert('セキュリティトークンの取得に失敗しました。ページを再読み込みしてください。', 'danger');
                return;
            }

            const response = await fetch(`/stockdiary/api/notifications/${notificationId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            });

            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const responseText = await response.text();
                console.error('❌ JSONではないレスポンス:', responseText.substring(0, 200));

                if (response.status === 403) {
                    showToastOrAlert('セッションが無効です。ページを再読み込みしてください。', 'danger');
                } else if (response.status === 404) {
                    showToastOrAlert('通知が見つかりませんでした。', 'warning');
                    loadAllNotifications();
                } else {
                    showToastOrAlert('サーバーエラーが発生しました。', 'danger');
                }
                return;
            }

            const data = await response.json();
            if (response.ok && data.success) {
                showToastOrAlert('通知設定を削除しました', 'success');
                loadAllNotifications();
            } else {
                showToastOrAlert('削除に失敗しました: ' + (data.error || '不明なエラー'), 'danger');
            }
        } catch (error) {
            console.error('削除エラー:', error);
            showToastOrAlert('削除中にエラーが発生しました', 'danger');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showToastOrAlert(message, type) {
        if (typeof showToast === 'function') {
            showToast(message, type);
        } else {
            alert(message);
        }
    }

    // グローバルスコープに公開
    window.deleteNotificationFromList = deleteNotificationFromList;
    window.loadAllNotifications = loadAllNotifications;
    window.applyFilters = applyFilters;
</script>
{% endblock %}