{% extends 'base.html' %}
{% load static %}

{% block title %}é€šçŸ¥ç®¡ç† | ã‚«ãƒ–ãƒ­ã‚°{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
      <i class="bi bi-bell"></i>
      é€šçŸ¥ç®¡ç†
    </h2>
    <a href="{% url 'stockdiary:home' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>
      æˆ»ã‚‹
    </a>
  </div>

  <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
  <div class="row mb-4">
    <div class="col-md-3 col-6 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="mb-0" id="total-count">-</h3>
          <small class="text-muted">å…¨é€šçŸ¥</small>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="mb-0 text-info" id="reminder-count">-</h3>
          <small class="text-muted">ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</small>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="mb-0 text-warning" id="price-alert-count">-</h3>
          <small class="text-muted">ä¾¡æ ¼ã‚¢ãƒ©ãƒ¼ãƒˆ</small>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="mb-0 text-success" id="periodic-count">-</h3>
          <small class="text-muted">å®šæœŸé€šçŸ¥</small>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">é€šçŸ¥ã‚¿ã‚¤ãƒ—</label>
          <select class="form-select" id="filter-type">
            <option value="">ã™ã¹ã¦</option>
            <option value="reminder">ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</option>
            <option value="price_alert">ä¾¡æ ¼ã‚¢ãƒ©ãƒ¼ãƒˆ</option>
            <option value="periodic">å®šæœŸé€šçŸ¥</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
          <select class="form-select" id="filter-status">
            <option value="active">æœ‰åŠ¹</option>
            <option value="all">ã™ã¹ã¦</option>
          </select>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button class="btn btn-primary w-100" onclick="applyFilters()">
            <i class="bi bi-funnel me-1"></i>
            ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- é€šçŸ¥ä¸€è¦§ -->
  <div class="card">
    <div class="card-body">
      <div id="notifications-container">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'js/cookie.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadAllNotifications();
});

async function loadAllNotifications() {
    try {
        // ã™ã¹ã¦ã®æ—¥è¨˜ã®é€šçŸ¥ã‚’å–å¾—
        const response = await fetch('/stockdiary/api/notifications/all/');
        const data = await response.json();
        
        if (data.notifications) {
            renderAllNotifications(data.notifications);
            updateStats(data.notifications);
        }
    } catch (error) {
        console.error('é€šçŸ¥èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('notifications-container').innerHTML = `
            <div class="alert alert-danger">
                é€šçŸ¥ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ
            </div>
        `;
    }
}

function updateStats(notifications) {
    document.getElementById('total-count').textContent = notifications.length;
    document.getElementById('reminder-count').textContent = 
        notifications.filter(n => n.type === 'reminder').length;
    document.getElementById('price-alert-count').textContent = 
        notifications.filter(n => n.type === 'price_alert').length;
    document.getElementById('periodic-count').textContent = 
        notifications.filter(n => n.type === 'periodic').length;
}

function renderAllNotifications(notifications) {
    const container = document.getElementById('notifications-container');
    
    if (notifications.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="bi bi-bell-slash" style="font-size: 3rem;"></i>
                <p class="mt-3">é€šçŸ¥è¨­å®šã¯ã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        `;
        return;
    }
    
    // éŠ˜æŸ„ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const grouped = notifications.reduce((acc, notification) => {
        const diaryKey = notification.diary_id;
        if (!acc[diaryKey]) {
            acc[diaryKey] = {
                diary_name: notification.diary_name,
                diary_id: notification.diary_id,
                notifications: []
            };
        }
        acc[diaryKey].notifications.push(notification);
        return acc;
    }, {});
    
    container.innerHTML = Object.values(grouped).map(group => `
        <div class="notification-group mb-4">
            <h5 class="border-bottom pb-2">
                <a href="/stockdiary/${group.diary_id}/" class="text-decoration-none">
                    ${group.diary_name}
                </a>
                <span class="badge bg-secondary ms-2">${group.notifications.length}ä»¶</span>
            </h5>
            ${group.notifications.map(n => renderNotificationItem(n)).join('')}
        </div>
    `).join('');
}

function renderNotificationItem(notification) {
    const typeInfo = getNotificationTypeInfo(notification.type);
    
    return `
        <div class="card mb-2" data-notification-id="${notification.id}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <span class="badge ${typeInfo.badgeClass} me-2">
                            <i class="${typeInfo.icon} me-1"></i>
                            ${typeInfo.label}
                        </span>
                        ${getNotificationDetails(notification)}
                    </div>
                    <button class="btn btn-sm btn-outline-danger" 
                            onclick="deleteNotificationFromList('${notification.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

function getNotificationTypeInfo(type) {
    const types = {
        'reminder': { label: 'ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼', icon: 'bi-alarm', badgeClass: 'bg-info' },
        'price_alert': { label: 'ä¾¡æ ¼ã‚¢ãƒ©ãƒ¼ãƒˆ', icon: 'bi-graph-up-arrow', badgeClass: 'bg-warning' },
        'periodic': { label: 'å®šæœŸé€šçŸ¥', icon: 'bi-arrow-repeat', badgeClass: 'bg-success' }
    };
    return types[type] || types['reminder'];
}

function getNotificationDetails(notification) {
    if (notification.type === 'reminder') {
        return `<div class="mt-1">ğŸ“… ${new Date(notification.remind_at).toLocaleString('ja-JP')}</div>`;
    } else if (notification.type === 'price_alert') {
        return `<div class="mt-1">ğŸ’° ${notification.target_price}å††${notification.alert_above ? 'ä»¥ä¸Š' : 'ä»¥ä¸‹'}</div>`;
    } else if (notification.type === 'periodic') {
        const freq = { 'daily': 'æ¯æ—¥', 'weekly': 'æ¯é€±', 'monthly': 'æ¯æœˆ' }[notification.frequency];
        return `<div class="mt-1">ğŸ”„ ${freq}</div>`;
    }
    return '';
}

// ğŸ”§ é€šçŸ¥å‰Šé™¤é–¢æ•°ï¼ˆçµ±ä¸€ã•ã‚ŒãŸé–¢æ•°åï¼‰
async function deleteNotificationFromList(notificationId) {
    if (!confirm('ã“ã®é€šçŸ¥è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
    }
    
    try {
        const csrfToken = getCookie('csrftoken');
        
        if (!csrfToken) {
            console.error('âŒ CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã¾ã›ã‚“');
            if (typeof showToast === 'function') {
                showToast('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'danger');
            } else {
                alert('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
            }
            return;
        }
        
        console.log('å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡:', notificationId);
        
        const response = await fetch(`/stockdiary/api/notifications/${notificationId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        console.log('å‰Šé™¤ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
        
        // HTMLãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å ´åˆã®å‡¦ç†
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const responseText = await response.text();
            console.error('âŒ JSONã§ã¯ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', responseText.substring(0, 200));
            
            if (response.status === 403) {
                showToastOrAlert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'danger');
            } else if (response.status === 404) {
                showToastOrAlert('é€šçŸ¥ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã™ã§ã«å‰Šé™¤ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', 'warning');
                loadAllNotifications(); // ä¸€è¦§ã‚’æ›´æ–°
            } else {
                showToastOrAlert('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'danger');
            }
            return;
        }
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showToastOrAlert('é€šçŸ¥è¨­å®šã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            loadAllNotifications(); // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
        } else {
            showToastOrAlert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'danger');
        }
    } catch (error) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        showToastOrAlert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
    }
}

// ğŸ”§ ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function showToastOrAlert(message, type) {
    if (typeof showToast === 'function') {
        showToast(message, type);
    } else {
        alert(message);
    }
}

// ğŸ”§ æ—¥è¨˜è©³ç´°ãƒšãƒ¼ã‚¸ç”¨ã®å‰Šé™¤é–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
async function deleteDiaryNotification(diaryId, notificationId) {
    if (!confirm('ã“ã®é€šçŸ¥è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch(`/stockdiary/api/notifications/${notificationId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showToastOrAlert('é€šçŸ¥ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            
            // æ—¥è¨˜è©³ç´°ãƒšãƒ¼ã‚¸ã®é€šçŸ¥ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
            if (typeof loadDiaryNotifications === 'function') {
                loadDiaryNotifications(diaryId);
            } else if (typeof loadNotifications === 'function') {
                loadNotifications();
            } else {
                const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
                if (notificationElement) {
                    notificationElement.remove();
                }
            }
        } else {
            showToastOrAlert(data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
        }
    } catch (error) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        showToastOrAlert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
    }
}

// ğŸ”§ è¤‡æ•°å‰Šé™¤æ©Ÿèƒ½
async function deleteMultipleNotifications(notificationIds) {
    if (!notificationIds || notificationIds.length === 0) {
        showToastOrAlert('å‰Šé™¤ã™ã‚‹é€šçŸ¥ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
        return;
    }
    
    if (!confirm(`${notificationIds.length}ä»¶ã®é€šçŸ¥è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
    }
    
    let successCount = 0;
    let failCount = 0;
    
    for (const notificationId of notificationIds) {
        try {
            const response = await fetch(`/stockdiary/api/notifications/${notificationId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                successCount++;
            } else {
                failCount++;
            }
        } catch (error) {
            console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
            failCount++;
        }
    }
    
    // çµæœã‚’è¡¨ç¤º
    if (successCount > 0 && failCount === 0) {
        showToastOrAlert(`${successCount}ä»¶ã®é€šçŸ¥ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
    } else if (successCount > 0 && failCount > 0) {
        showToastOrAlert(`${successCount}ä»¶å‰Šé™¤ã€${failCount}ä»¶å¤±æ•—ã—ã¾ã—ãŸ`, 'warning');
    } else {
        showToastOrAlert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
    }
    
    // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
    loadAllNotifications();
}

// ğŸ”§ å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function addDeleteButton(notificationId, containerElement) {
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'btn btn-sm btn-outline-danger';
    deleteBtn.innerHTML = '<i class="bi bi-trash"></i> å‰Šé™¤';
    deleteBtn.onclick = () => deleteNotificationFromList(notificationId);
    
    containerElement.appendChild(deleteBtn);
}

// ğŸ”§ é€šçŸ¥ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹é–¢æ•°
function createNotificationCard(notification) {
    const card = document.createElement('div');
    card.className = 'card mb-3';
    card.setAttribute('data-notification-id', notification.id);
    
    card.innerHTML = `
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="card-title">${notification.type_display}</h5>
                    <p class="card-text">${notification.message || 'é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—'}</p>
                    <small class="text-muted">
                        ${notification.diary_name || ''}
                        ${notification.target_price ? ` - ç›®æ¨™ä¾¡æ ¼: ${notification.target_price}å††` : ''}
                        ${notification.frequency ? ` - ${notification.frequency}` : ''}
                    </small>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteNotificationFromList('${notification.id}')">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    return card;
}

// ğŸ”§ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹
window.deleteNotificationFromList = deleteNotificationFromList;
window.deleteDiaryNotification = deleteDiaryNotification;
window.deleteMultipleNotifications = deleteMultipleNotifications;
window.addDeleteButton = addDeleteButton;
window.createNotificationCard = createNotificationCard;
window.loadAllNotifications = loadAllNotifications;
</script>
{% endblock %}