{% extends 'base.html' %}

{% block title %}
  {% if form.instance.pk %}分析テンプレート編集{% else %}分析テンプレート作成{% endif %} | 株ノート
{% endblock %}

{% block head %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<style>
  :root {
    --primary-color: #4f46e5;
    --success-color: #10b981;
    --danger-color: #ef4444;
    --warning-color: #f59e0b;
    --light-bg: #f9fafb;
    --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --analysis-color: #10b981;  /* 分析テンプレート専用の色 */
  }

  body {
    background-color: var(--light-bg);
  }

  /* フォームスタイル */
  .form-card {
    border: none;
    border-radius: 0.5rem;
    box-shadow: var(--card-shadow);
    overflow: hidden;
  }

  .form-card-header {
    background-color: var(--analysis-color);
    color: white;
    padding: 1.25rem;
    border-bottom: none;
  }

  .form-card-header h3 {
    margin: 0;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .form-card-body {
    padding: 1.5rem;
  }

  .form-section {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .form-section:last-child {
    border-bottom: none;
  }

  .form-section-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: #111827;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .form-section-title i {
    color: var(--analysis-color);
  }

  .form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #374151;
  }

  .form-control {
    border-radius: 0.375rem;
    padding: 0.625rem 0.75rem;
    border: 1px solid #d1d5db;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }

  .form-control:focus {
    border-color: #a5b4fc;
    box-shadow: 0 0 0 0.25rem rgba(79, 70, 229, 0.25);
  }

  .form-group {
    margin-bottom: 1rem;
  }

  /* グループとフィールドのフォームスタイル */
  .group-form, .field-form {
    background-color: #f9fafb;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
    border: 1px solid #e5e7eb;
    position: relative;
  }

  .group-form:hover, .field-form:hover {
    border-color: #d1d5db;
  }

  .group-header, .field-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .group-title, .field-title {
    font-weight: 600;
    font-size: 1.1rem;
    margin: 0;
  }

  .remove-button {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    z-index: 10;
  }

  /* フィールドタイプによる表示切り替え */
  .field-type-options {
    display: none;
  }

  .field-type-options.show {
    display: block;
  }

  /* ボタンスタイル */
  .btn-analysis {
    background-color: var(--analysis-color);
    border-color: var(--analysis-color);
    color: white;
  }

  .btn-analysis:hover {
    background-color: #0e9f6e;
    border-color: #0e9f6e;
    color: white;
  }

  .btn-outline-analysis {
    color: var(--analysis-color);
    border-color: var(--analysis-color);
  }

  .btn-outline-analysis:hover {
    background-color: var(--analysis-color);
    color: white;
  }

  /* レスポンシブ調整 */
  @media (max-width: 768px) {
    .form-card-body {
      padding: 1rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="form-card">
        <div class="form-card-header">
          <h3>
            <i class="bi bi-graph-up"></i>
            {% if form.instance.pk %}分析テンプレート編集{% else %}分析テンプレート作成{% endif %}
          </h3>
        </div>
        
        <div class="form-card-body">
          <form method="post" novalidate>
            {% csrf_token %}
            
            <!-- 基本情報セクション -->
            <div class="form-section">
              <h4 class="form-section-title">
                <i class="bi bi-info-circle"></i> 基本情報
              </h4>
              
              <div class="form-group">
                <label for="{{ form.name.id_for_label }}" class="form-label">テンプレート名</label>
                {{ form.name }}
                {% if form.name.errors %}
                  <div class="text-danger">{{ form.name.errors }}</div>
                {% endif %}
              </div>
              
              <div class="form-group">
                <label for="{{ form.description.id_for_label }}" class="form-label">説明</label>
                {{ form.description }}
                {% if form.description.errors %}
                  <div class="text-danger">{{ form.description.errors }}</div>
                {% endif %}
                <div class="form-text">このテンプレートの用途や特徴を簡潔に説明してください</div>
              </div>
            </div>
            
            <!-- グループセクション -->
            <div class="form-section">
              <h4 class="form-section-title">
                <i class="bi bi-folder"></i> グループ設定
              </h4>
              <p class="text-muted mb-3">分析項目をグループ化して整理できます（例：財務指標、テクニカル指標など）</p>
              
              {{ groups_formset.management_form }}
              
              <div id="groups-container">
                {% for group_form in groups_formset %}
                  <div class="group-form">
                    {{ group_form.id }}
                    
                    <button type="button" class="btn btn-sm btn-outline-danger remove-button">
                      <i class="bi bi-x-lg"></i>
                    </button>
                    
                    <div class="group-header">
                      <h5 class="group-title">グループ #{{ forloop.counter }}</h5>
                    </div>
                    
                    <div class="row">
                      <div class="col-md-9">
                        <div class="form-group">
                          <label for="{{ group_form.name.id_for_label }}" class="form-label">グループ名</label>
                          {{ group_form.name }}
                          {% if group_form.name.errors %}
                            <div class="text-danger">{{ group_form.name.errors }}</div>
                          {% endif %}
                        </div>
                      </div>
                      
                      <div class="col-md-3">
                        <div class="form-group">
                          <label for="{{ group_form.order.id_for_label }}" class="form-label">表示順</label>
                          {{ group_form.order }}
                          {% if group_form.order.errors %}
                            <div class="text-danger">{{ group_form.order.errors }}</div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    
                    <!-- DELETEフィールド（非表示） -->
                    <div style="display: none;">
                      {{ group_form.DELETE }}
                    </div>
                  </div>
                {% endfor %}
              </div>
              
              <div class="text-center mt-3">
                <button type="button" id="add-group" class="btn btn-outline-analysis">
                  <i class="bi bi-folder-plus me-1"></i> グループを追加
                </button>
              </div>
            </div>
            
            <!-- フィールドセクション -->
            <div class="form-section">
              <h4 class="form-section-title">
                <i class="bi bi-input-cursor-text"></i> 分析フィールド
              </h4>
              <p class="text-muted mb-3">銘柄ごとに入力・比較する項目を設定します（例：PER、ROE、配当利回りなど）</p>
              
              {{ fields_formset.management_form }}
              
              <div id="fields-container">
                {% for field_form in fields_formset %}
                  <div class="field-form">
                    {{ field_form.id }}
                    
                    <button type="button" class="btn btn-sm btn-outline-danger remove-button">
                      <i class="bi bi-x-lg"></i>
                    </button>
                    
                    <div class="field-header">
                      <h5 class="field-title">フィールド #{{ forloop.counter }}</h5>
                    </div>
                    
                    <div class="row mb-3">
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ field_form.label.id_for_label }}" class="form-label">ラベル名</label>
                          {{ field_form.label }}
                          {% if field_form.label.errors %}
                            <div class="text-danger">{{ field_form.label.errors }}</div>
                          {% endif %}
                          <div class="form-text">表示される項目名（例：PER、配当利回り）</div>
                        </div>
                      </div>
                      
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ field_form.key.id_for_label }}" class="form-label">キー</label>
                          {{ field_form.key }}
                          {% if field_form.key.errors %}
                            <div class="text-danger">{{ field_form.key.errors }}</div>
                          {% endif %}
                          <div class="form-text">システム内部で使用される識別子</div>
                        </div>
                      </div>
                      
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ field_form.field_type.id_for_label }}" class="form-label">フィールドタイプ</label>
                          {{ field_form.field_type }}
                          {% if field_form.field_type.errors %}
                            <div class="text-danger">{{ field_form.field_type.errors }}</div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    
                    <div class="row mb-3">
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ field_form.group.id_for_label }}" class="form-label">所属グループ</label>
                          {{ field_form.group }}
                          {% if field_form.group.errors %}
                            <div class="text-danger">{{ field_form.group.errors }}</div>
                          {% endif %}
                        </div>
                      </div>
                      
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ field_form.description.id_for_label }}" class="form-label">説明</label>
                          {{ field_form.description }}
                          {% if field_form.description.errors %}
                            <div class="text-danger">{{ field_form.description.errors }}</div>
                          {% endif %}
                        </div>
                      </div>
                      
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ field_form.order.id_for_label }}" class="form-label">表示順</label>
                          {{ field_form.order }}
                          {% if field_form.order.errors %}
                            <div class="text-danger">{{ field_form.order.errors }}</div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    
                    <!-- 数値タイプのオプション -->
                    <div class="field-type-options" data-field-type="number,percentage">
                      <div class="row mb-3">
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="{{ field_form.unit.id_for_label }}" class="form-label">単位</label>
                            {{ field_form.unit }}
                            {% if field_form.unit.errors %}
                              <div class="text-danger">{{ field_form.unit.errors }}</div>
                            {% endif %}
                            <div class="form-text">表示する単位（円、倍、%など）</div>
                          </div>
                        </div>
                        
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="{{ field_form.min_value.id_for_label }}" class="form-label">最小値</label>
                            {{ field_form.min_value }}
                            {% if field_form.min_value.errors %}
                              <div class="text-danger">{{ field_form.min_value.errors }}</div>
                            {% endif %}
                          </div>
                        </div>
                        
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="{{ field_form.max_value.id_for_label }}" class="form-label">最大値</label>
                            {{ field_form.max_value }}
                            {% if field_form.max_value.errors %}
                              <div class="text-danger">{{ field_form.max_value.errors }}</div>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      
                      <div class="row mb-3">
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="{{ field_form.benchmark_value.id_for_label }}" class="form-label">基準値</label>
                            {{ field_form.benchmark_value }}
                            {% if field_form.benchmark_value.errors %}
                              <div class="text-danger">{{ field_form.benchmark_value.errors }}</div>
                            {% endif %}
                            <div class="form-text">業界平均値などの比較基準</div>
                          </div>
                        </div>
                        
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="{{ field_form.default_value.id_for_label }}" class="form-label">デフォルト値</label>
                            {{ field_form.default_value }}
                            {% if field_form.default_value.errors %}
                              <div class="text-danger">{{ field_form.default_value.errors }}</div>
                            {% endif %}
                          </div>
                        </div>
                        
                        <div class="col-md-4 d-flex align-items-end">
                          <div class="form-check">
                            {{ field_form.is_required }}
                            <label class="form-check-label" for="{{ field_form.is_required.id_for_label }}">
                              必須項目
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- テキストタイプのオプション -->
                    <div class="field-type-options" data-field-type="text">
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="{{ field_form.default_value.id_for_label }}" class="form-label">デフォルト値</label>
                            {{ field_form.default_value }}
                            {% if field_form.default_value.errors %}
                              <div class="text-danger">{{ field_form.default_value.errors }}</div>
                            {% endif %}
                          </div>
                        </div>
                        
                        <div class="col-md-6 d-flex align-items-end">
                          <div class="form-check">
                            {{ field_form.is_required }}
                            <label class="form-check-label" for="{{ field_form.is_required.id_for_label }}">
                              必須項目
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- その他のタイプのオプション -->
                    <div class="field-type-options" data-field-type="date,boolean,rating">
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="{{ field_form.default_value.id_for_label }}" class="form-label">デフォルト値</label>
                            {{ field_form.default_value }}
                            {% if field_form.default_value.errors %}
                              <div class="text-danger">{{ field_form.default_value.errors }}</div>
                            {% endif %}
                          </div>
                        </div>
                        
                        <div class="col-md-6 d-flex align-items-end">
                          <div class="form-check">
                            {{ field_form.is_required }}
                            <label class="form-check-label" for="{{ field_form.is_required.id_for_label }}">
                              必須項目
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- DELETEフィールド（非表示） -->
                    <div style="display: none;">
                      {{ field_form.DELETE }}
                    </div>
                  </div>
                {% endfor %}
              </div>
              
              <div class="text-center mt-3">
                <button type="button" id="add-field" class="btn btn-outline-analysis">
                  <i class="bi bi-plus-lg me-1"></i> フィールドを追加
                </button>
              </div>
            </div>
            
            <div class="d-flex justify-content-between">
              <a href="{% url 'analysis_templates:list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-1"></i> キャンセル
              </a>
              <button type="submit" class="btn btn-analysis">
                <i class="bi bi-save me-1"></i> 保存
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // グループ管理
    const groupsContainer = document.getElementById('groups-container');
    const addGroupBtn = document.getElementById('add-group');
    const totalGroupForms = document.getElementById('id_groups-TOTAL_FORMS');
    
    // フィールド管理
    const fieldsContainer = document.getElementById('fields-container');
    const addFieldBtn = document.getElementById('add-field');
    const totalFieldForms = document.getElementById('id_fields-TOTAL_FORMS');
    
    // グループの削除ボタン
    function setupGroupRemoveButtons() {
      groupsContainer.querySelectorAll('.remove-button').forEach(button => {
        button.addEventListener('click', function() {
          const groupForm = this.closest('.group-form');
          
          // 最後の1つは削除せずに中身をクリアする
          if (groupsContainer.querySelectorAll('.group-form').length <= 1) {
            groupForm.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
              input.value = '';
            });
            return;
          }
          
          // 既存のグループなら、DELETEにチェックを入れる
          const deleteCheckbox = groupForm.querySelector('input[name$="-DELETE"]');
          if (deleteCheckbox) {
            deleteCheckbox.checked = true;
            groupForm.style.display = 'none';
          } else {
            // 新規追加したグループなら、DOMから削除
            groupForm.remove();
            
            // フォームの総数を更新
            const forms = groupsContainer.querySelectorAll('.group-form');
            totalGroupForms.value = forms.length;
            
            // フォームのインデックスを振り直す
            forms.forEach((form, index) => {
              updateFormIndex(form, 'groups', index);
            });
          }
        });
      });
    }
    
    // フィールドの削除ボタン
    function setupFieldRemoveButtons() {
      fieldsContainer.querySelectorAll('.remove-button').forEach(button => {
        button.addEventListener('click', function() {
          const fieldForm = this.closest('.field-form');
          
          // 最後の1つは削除せずに中身をクリアする
          if (fieldsContainer.querySelectorAll('.field-form').length <= 1) {
            fieldForm.querySelectorAll('input[type="text"], input[type="number"], select').forEach(input => {
              input.value = '';
            });
            fieldForm.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
              checkbox.checked = false;
            });
            return;
          }
          
          // 既存のフィールドなら、DELETEにチェックを入れる
          const deleteCheckbox = fieldForm.querySelector('input[name$="-DELETE"]');
          if (deleteCheckbox) {
            deleteCheckbox.checked = true;
            fieldForm.style.display = 'none';
          } else {
            // 新規追加したフィールドなら、DOMから削除
            fieldForm.remove();
            
            // フォームの総数を更新
            const forms = fieldsContainer.querySelectorAll('.field-form');
            totalFieldForms.value = forms.length;
            
            // フォームのインデックスを振り直す
            forms.forEach((form, index) => {
              updateFormIndex(form, 'fields', index);
            });
          }
        });
      });
    }
    
    // フォームのインデックスを更新する関数
    function updateFormIndex(form, prefix, index) {
      form.querySelectorAll('input, select, textarea, label').forEach(element => {
        if (element.name) {
          element.name = element.name.replace(
            new RegExp(`${prefix}-\\d+-`), 
            `${prefix}-${index}-`
          );
        }
        if (element.id) {
          element.id = element.id.replace(
            new RegExp(`id_${prefix}-\\d+-`),
            `id_${prefix}-${index}-`
          );
        }
        if (element.htmlFor) {
          element.htmlFor = element.htmlFor.replace(
            new RegExp(`id_${prefix}-\\d+-`),
            `id_${prefix}-${index}-`
          );
        }
      });
    }
    
    // フィールドタイプに応じてオプションの表示/非表示を切り替える関数
    function setupFieldTypeListeners() {
      fieldsContainer.querySelectorAll('select[id$="-field_type"]').forEach(select => {
        const fieldForm = select.closest('.field-form');
        const fieldType = select.value;
        
        // 初期状態で該当するオプションを表示
        updateFieldTypeOptions(fieldForm, fieldType);
        
        // フィールドタイプ変更時のリスナー
        select.addEventListener('change', function() {
          updateFieldTypeOptions(fieldForm, this.value);
        });
      });
    }
    
    // フィールドタイプに応じたオプションの表示/非表示
    function updateFieldTypeOptions(fieldForm, fieldType) {
      // 全てのオプション領域を非表示
      fieldForm.querySelectorAll('.field-type-options').forEach(options => {
        options.classList.remove('show');
      });
      
      // 該当するフィールドタイプのオプション領域を表示
      fieldForm.querySelectorAll('.field-type-options').forEach(options => {
        const supportedTypes = options.dataset.fieldType.split(',');
        if (supportedTypes.includes(fieldType)) {
          options.classList.add('show');
        }
      });
    }
    
    // 新しいグループを追加する
    addGroupBtn.addEventListener('click', function() {
      const formCount = parseInt(totalGroupForms.value);
      
      // 最後のグループフォームを複製
      const lastForm = groupsContainer.querySelector('.group-form:last-child');
      const newForm = lastForm.cloneNode(true);
      
      // フォームのインデックスを更新
      updateFormIndex(newForm, 'groups', formCount);
      
      // フォームの内容をクリア
      newForm.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
        input.value = '';
      });
      
      // DELETEチェックボックスを未チェックにする
      const deleteCheckbox = newForm.querySelector('input[name$="-DELETE"]');
      if (deleteCheckbox) {
        deleteCheckbox.checked = false;
      }
      
      // 表示を元に戻す
      newForm.style.display = '';
      
      // フォームをコンテナに追加
      groupsContainer.appendChild(newForm);
      
      // 総数を更新
      totalGroupForms.value = formCount + 1;
      
      // 削除ボタンのイベントリスナーを設定
      setupGroupRemoveButtons();
      
      // タイトルを更新
      newForm.querySelector('.group-title').textContent = `グループ #${formCount + 1}`;
      
      // 順序を設定
      const orderInput = newForm.querySelector('input[name$="-order"]');
      if (orderInput) {
        // 最後の値 + 1 を設定
        const lastOrder = parseInt(lastForm.querySelector('input[name$="-order"]').value) || 0;
        orderInput.value = lastOrder + 1;
      }
    });
    
    // 新しいフィールドを追加する
    addFieldBtn.addEventListener('click', function() {
      const formCount = parseInt(totalFieldForms.value);
      
      // 最後のフィールドフォームを複製
      const lastForm = fieldsContainer.querySelector('.field-form:last-child');
      const newForm = lastForm.cloneNode(true);
      
      // フォームのインデックスを更新
      updateFormIndex(newForm, 'fields', formCount);
      
      // フォームの内容をクリア
      newForm.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
        input.value = '';
      });
      
      // セレクトボックスはデフォルト値を保持
      newForm.querySelectorAll('select').forEach(select => {
        const firstOption = select.querySelector('option');
        if (firstOption) {
          select.value = firstOption.value;
        }
      });
      // チェックボックスを未チェックにする
      newForm.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // DELETEチェックボックスを未チェックにする
      const deleteCheckbox = newForm.querySelector('input[name$="-DELETE"]');
      if (deleteCheckbox) {
        deleteCheckbox.checked = false;
      }
      
      // 表示を元に戻す
      newForm.style.display = '';
      
      // フォームをコンテナに追加
      fieldsContainer.appendChild(newForm);
      
      // 総数を更新
      totalFieldForms.value = formCount + 1;
      
      // 削除ボタンのイベントリスナーを設定
      setupFieldRemoveButtons();
      
      // タイトルを更新
      newForm.querySelector('.field-title').textContent = `フィールド #${formCount + 1}`;
      
      // 順序を設定
      const orderInput = newForm.querySelector('input[name$="-order"]');
      if (orderInput) {
        // 最後の値 + 1 を設定
        const lastOrder = parseInt(lastForm.querySelector('input[name$="-order"]').value) || 0;
        orderInput.value = lastOrder + 1;
      }
      
      // フィールドタイプリスナーを設定
      setupFieldTypeListeners();
    });
    
    // 初期化
    setupGroupRemoveButtons();
    setupFieldRemoveButtons();
    setupFieldTypeListeners();
    
    // キー名の自動生成（ラベルからキーを生成）
    fieldsContainer.querySelectorAll('input[id$="-label"]').forEach(input => {
      input.addEventListener('blur', function() {
        const fieldForm = this.closest('.field-form');
        const keyInput = fieldForm.querySelector('input[id$="-key"]');
        
        // キーが空の場合のみ自動生成
        if (keyInput.value === '' && this.value !== '') {
          // スラグ形式に変換（スペースをアンダースコアに、小文字に）
          const sluggedValue = this.value
            .toLowerCase()
            .replace(/\s+/g, '_')
            .replace(/[^\w]/g, '');
          
          keyInput.value = sluggedValue;
        }
      });
    });
  });
</script>
{% endblock %}